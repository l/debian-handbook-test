<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">Глава 15. Создание пакета Debian</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-9-ru-RU-1.0-1" /><meta
        name="keywords"
        content="Бэкпортирование, Пересборка, Пакет исходных кодов, Архив, Метапакет, Разработчик Debian, Сопровождающий" /><link
        rel="home"
        href="index.html"
        title="Настольная книга администратора Debian" /><link
        rel="up"
        href="index.html"
        title="Настольная книга администратора Debian" /><link
        rel="prev"
        href="sect.dealing-with-compromised-machine.html"
        title="14.7. Dealing with a Compromised Machine" /><link
        rel="next"
        href="sect.building-first-package.html"
        title="15.2. Сборка вашего первого пакета" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/ru-RU/stable/debian-packaging.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.dealing-with-compromised-machine.html"><strong>Пред.</strong></a></li><li
          class="home">Настольная книга администратора Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.building-first-package.html"><strong>След.</strong></a></li></ul><div
        xml:lang="ru-RU"
        class="chapter"
        lang="ru-RU"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  xmlns=""
                  id="debian-packaging"></a>Глава 15. Создание пакета Debian</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="debian-packaging.html#sect.rebuilding-package">15.1. Пересборка пакета из его исходного кода</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="debian-packaging.html#id-1.18.4.3">15.1.1. Получение исходного кода</a></span></dt><dt><span
                    class="section"><a
                      href="debian-packaging.html#id-1.18.4.4">15.1.2. Внесение изменений</a></span></dt><dt><span
                    class="section"><a
                      href="debian-packaging.html#id-1.18.4.5">15.1.3. Запуск пересборки</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.building-first-package.html">15.2. Сборка вашего первого пакета</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.building-first-package.html#id-1.18.5.2">15.2.1. Метапакеты или пакеты-пустышки</a></span></dt><dt><span
                    class="section"><a
                      href="sect.building-first-package.html#id-1.18.5.3">15.2.2. Простое файловое хранилище</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.setup-apt-package-repository.html">15.3. Создание репозитория пакетов для APT</a></span></dt><dt><span
                class="section"><a
                  href="sect.becoming-package-maintainer.html">15.4. Как стать сопровождающим пакета</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.becoming-package-maintainer.html#id-1.18.7.2">15.4.1. Учимся создавать пакеты</a></span></dt><dt><span
                    class="section"><a
                      href="sect.becoming-package-maintainer.html#id-1.18.7.3">15.4.2. Процесс принятия</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		Нередко администратор, постоянно имеющий дело с пакетами Debian, со временем чувствует необходимость в создании своих собственных пакетов или изменении существующего пакета. Цель этой главы состоит в том, чтобы ответить на наиболее распространенные вопросы в этой области, а также предоставить необходимые базовые знания для использования инфраструктуры Debian наилучшим образом. Если повезет, после попытки приложить руку к созданию локальных пакетов вы даже можете почувствовать потребность в том, чтобы пойти дальше и присоединиться к самому Проекту Debian!
	</div></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    xmlns=""
                    id="sect.rebuilding-package"></a>15.1. Пересборка пакета из его исходного кода</h2></div></div></div><div
            class="para">
			Пересборка двоичного пакета требуется при ряде обстоятельств. В некоторых случаях администратору нужна функциональность программы, для активации которой необходима компиляция из исходного кода с определенной опцией; в других программное обеспечение, упакованное в установленной версии Debian, недостаточно актуально. В последнем случае администратору обычно нужно собрать более свежий пакет, взятый из более новой версии Debian — например <span
              class="distribution distribution">Testing</span> или даже <span
              class="distribution distribution">Unstable</span> — чтобы новый пакет заработал в дистрибутиве <span
              class="distribution distribution">Stable</span>; эта операция называется «бэкпортирование». Как обычно, прежде чем приступать к такой задаче, следует проверить, не был ли такой пакет уже создан, — для этого достаточно беглого взгляда на страницу данного пакета в Системе отслеживания пакетов Debian. <div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="https://tracker.debian.org/">https://tracker.debian.org/</a></div> <a
              id="id-1.18.4.2.5"
              class="indexterm"></a>
		</div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="id-1.18.4.3"></a>15.1.1. Получение исходного кода</h3></div></div></div><div
              class="para">
				Пересборка пакета Debian начинается с получения его исходного кода. Простейший способ состоит в использовании команды <code
                class="command">apt-get source <em
                  class="replaceable">название-пакета-исходного-кода</em></code>. Данная команда требует наличия строки <code
                class="literal">deb-src</code> в файле <code
                class="filename">/etc/apt/sources.list</code> и обновлённых файлов индекса (после выполнения <code
                class="command">apt-get update</code>). Эти условия должны быть уже выполнены, если вы следовали инструкциям из главы, посвященной конфигурации APT (см. <a
                class="xref"
                href="apt.html#sect.apt-sources.list">Раздел 6.1, «Содержимое файла <code
                  class="filename">sources.list</code>»</a>). Однако заметьте, что вы будете загружать пакеты исходного кода из версии Debian, упомянутой в строке <code
                class="literal">deb-src</code>. Если необходима другая версия, вам может понадобиться загрузить её вручную с зеркала Debian или с веб-сайта. Для этого требуется получить два или три файла (с расширениями <code
                class="filename">*.dsc</code> — от <span
                class="foreignphrase"><em
                  class="foreignphrase">Debian Source Control</em></span> — <code
                class="filename">*.tar.<em
                  class="replaceable">comp</em></code>, и иногда <code
                class="filename">*.diff.gz</code> или <code
                class="filename">*.debian.tar.<em
                  class="replaceable">comp</em></code> — <em
                class="replaceable">comp</em> может принимать одно из значений: <code
                class="literal">gz</code>, <code
                class="literal">bz2</code> или <code
                class="literal">xz</code> в зависимости от используемого инструмента сжатия), затем запустить команду <code
                class="command">dpkg-source -x <em
                  class="replaceable">file.dsc</em></code>. Если файл <code
                class="filename">*.dsc</code> доступен напрямую по известному URL, то есть еще более простой способ получить это всё — с помощью команды <code
                class="command">dget <em
                  class="replaceable">URL</em></code>. Эта команда (которую можно найти в пакете <span
                class="pkg pkg">devscripts</span>) загружает файл <code
                class="filename">*.dsc</code> по переданному ей адресу, затем анализирует его содержимое и автоматически загружает файл или файлы, перечисленные в нём. После того, как всё загружено, она распаковывает пакет исходных кодов (если только не используется опция <code
                class="literal">-d</code> или <code
                class="literal">--download-only</code>).
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="id-1.18.4.4"></a>15.1.2. Внесение изменений</h3></div></div></div><div
              class="para">
				Исходный код пакета теперь доступен в каталоге, имя которого составлено из имени пакета исходного кода и его версии (например <span
                class="emphasis"><em>samba-4.1.17+dfsg</em></span>); здесь мы будем работать над нашими локальными изменениями.
			</div><div
              class="para">
				Первое, что необходимо сделать, это изменить версию пакета, чтобы пересобранные пакеты можно было отличить от оригинальных, предоставляемых Debian. Если предположить, что текущая версия — <code
                class="literal">2:4.1.17+dfsg-2</code>, мы можем создать версию <code
                class="literal">2:4.1.17+dfsg-2falcot1</code>, что явно указывает на происхождение пакета. Номер версии версии становится выше, чем у пакета, предоставленного Debian, таким образом, пакет можно будет легко установить как обновление оригинального пакета. Такое изменение лучше всего осуществляется с помощью команды <code
                class="command">dch</code> (<span
                class="emphasis"><em>Debian CHangelog</em></span>) из пакета <span
                class="pkg pkg">devscripts</span>, запустив её с параметрами <code
                class="command">dch --local falcot</code>. Это действие вызовет текстовый редактор (<code
                class="command">sensible-editor</code> — это должен быть ваш любимый редактор, если он указан в переменной окружения <code
                class="varname">VISUAL</code> или <code
                class="varname">EDITOR</code>, а в противном случае редактор по умолчанию) для того, чтобы документировать изменения, внесенные данной пересборкой. Этот редактор показывает нам, что <code
                class="command">dch</code> действительно изменила файл <code
                class="filename">debian/changelog</code>.
			</div><div
              class="para">
				В случае, если требуются изменения в опциях сборки, они вносятся в файл <code
                class="filename">debian/rules</code>, который управляет шагами процесса сборки пакета. В простейших случаях строки, относящиеся к начальной конфигурации (<code
                class="literal">./configure …</code>) или к собственно сборке (<code
                class="literal">$(MAKE) …</code> или <code
                class="literal">make …</code>) легко обнаружить. Если эти команды не не вызываются явно, они, вероятно, являются побочным эффектом другой явной команды; в этом случае обратитесь к их документации, чтобы выяснить, как изменить поведение по умолчанию. В случае пакетов, использующих <code
                class="command">dh</code>, может понадобиться переопределить команду <code
                class="command">dh_auto_configure</code> или <code
                class="command">dh_auto_build</code> (подробности см. на соответствующих страницах руководства).
			</div><div
              class="para">
				В зависимости от локальных изменений в пакетах может потребоваться также обновление файла <code
                class="filename">debian/control</code>, который содержит описание создаваемых пакетов. В частности, этот файл содержит строки <code
                class="literal">Build-Depends</code>, контролирующие список зависимостей, которые должны быть удовлетворены на этапе сборки пакета. Они часто ссылаются на версии пакетов, содержащиеся в дистрибутиве, откуда взят исходный код, но которые могут быть недоступны в дистрибутиве, используемом для пересборки. Не существует автоматизированного способа определить, является ли зависимость реальной, или же она указана только с целью гарантировать выполнение сборки исключительно с последней версией библиотеки, — это единственный доступный способ заставить <span
                class="emphasis"><em>autobuilder</em></span> использовать данную версию пакета во время сборки, из-за чего сопровождающие Debian часто используют строго версионированые сборочные зависимости.
			</div><div
              class="para">
				Если вы точно знаете, что эти сборочные зависимости слишком строги, не стесняйтесь ослабить их локально. Чтение файлов, документирующих стандартный способ сборки программного обеспечения — эти файлы часто называют <code
                class="filename">INSTALL</code> — поможет выяснить соответствующие зависимости. В идеале все зависимости должны быть удовлетворены из дистрибутива, используемого для пересборки; в противном случае начинается рекурсивный процесс, в результате которого пакеты, упомянутые в поле <code
                class="literal">Build-Depends</code>, должны быть бэкпортированы раньше целевого пакета. Некоторые пакеты могут не требовать бэкпортирования, и их можно установить как есть в процессе сборки (ярким примером является <span
                class="pkg pkg">debhelper</span>). Обратите внимание, что процесс бэкпортирования может стать лавинообразным, если вы не будете осторожны. Поэтому бэкпорты должны быть сведены к абсолютному минимуму, насколько это возможно.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>СОВЕТ</em></span> Установка <code
                          class="literal">Build-Depends</code></strong></p></div></div></div><a
                id="id-1.18.4.4.7.2"
                class="indexterm"></a><div
                class="para">
				<code
                  class="command">apt-get</code> позволяет установить все пакеты, упомянутые в поле <code
                  class="literal">Build-Depends</code> исходного пакета, которые доступны в дистрибутиве, указанном в строке <code
                  class="literal">deb-src</code> файла <code
                  class="filename">/etc/apt/sources.list</code>. Для этого достаточно запустить команду <code
                  class="command">apt-get build-dep <em
                    class="replaceable">пакет-исходного-кода</em></code>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="id-1.18.4.5"></a>15.1.3. Запуск пересборки</h3></div></div></div><div
              class="para">
				Когда все необходимые изменения внесены в исходный код, мы можем запустить создание собственно двоичного пакета (файл <code
                class="filename">.deb</code>). Весь процесс управляется командой <code
                class="command">dpkg-buildpackage</code>.
			</div><div
              class="example"><a
                xmlns=""
                id="id-1.18.4.5.3"></a><p
                class="title"><strong>Пример 15.1. Пересборка пакета</strong></p><div
                class="example-contents"><pre
                  class="screen"><code
                    class="computeroutput">$ </code><strong
                    class="userinput"><code>dpkg-buildpackage -us -uc
</code></strong><code
                    class="computeroutput">[...]
</code></pre></div></div><div
              class="sidebar"><a
                xmlns=""
                id="sidebar.fakeroot"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ИНСТРУМЕНТ</em></span> <code
                          class="command">fakeroot</code></strong></p></div></div></div><div
                class="para">
				В сущности процесс создания пакета является простым сбором в архив набора существующих (или скомпилированных) файлов; большинство файлов архива будут иметь в конечном итоге владельца <span
                  class="emphasis"><em>root</em></span>. Тем не менее, сборка всего пакета от имени этого пользователя подразумевала бы повышенный риск; к счастью, этого можно избежать с помощью команды <code
                  class="command">fakeroot</code>. Этот инструмент может быть использован для запуска программы и создания у неё впечатления, что она запущена от имени <span
                  class="emphasis"><em>root</em></span> и создает файлы с произвольным владельцем и правами. Когда программа создает архив, который станет пакетом Debian, она хитрым образом внедряется в процесс создания архива, содержащего файлы, помеченные как принадлежащие произвольным владельцам, в том числе <span
                  class="emphasis"><em>root</em></span>. Это поведение настолько удобно, что <code
                  class="command">dpkg-buildpackage</code> использует <code
                  class="command">fakeroot</code> по умолчанию при сборке пакетов.
			</div><div
                class="para">
				Заметьте, что программу только заставляют «поверить» в то, что она работает под привилегированной учетной записью, но процесс на самом деле выполняется от имени пользователя, запустившего <code
                  class="command">fakeroot <em
                    class="replaceable">программа</em></code> (и права на создаваемые файлы в действительности принадлежат этому пользователю). Фактически программа ни в какой момент времени не получает привилегий суперпользователя, которыми могла бы злоупотреблять.
			</div></div><div
              class="para">
				Предыдущая команда может завершиться ошибкой, если поле <code
                class="literal">Build-Depends</code> не было обновлено или соответствующие пакеты не установлены. В таком случае можно исключить эту проверку, передав параметр <code
                class="literal">-d</code> команде <code
                class="command">dpkg-buildpackage</code>. Тем не менее, явное игнорирование зависимостей влечёт риск ошибки сборки на более позднем этапе. Хуже того, пакет может казаться собранным корректно, но не запуститься надлежащим образом: некоторые программы автоматически отключают часть своего функционала, если требующаяся библиотека была недоступна во время сборки.
			</div><div
              class="para">
				В большинстве случаев разработчики Debian используют программу более высокого уровня, такую как <code
                class="command">debuild</code>; она запускает <code
                class="command">dpkg-buildpackage</code> как обычно, но также добавляет вызов программы, выполняющей множество проверок пакета на соответствие политике Debian. Этот сценарий также очищает окружение, так что локальные переменные окружения не «загрязняют» сборку пакета. Команда <code
                class="command">debuild</code> — один из инструментов набора <span
                class="emphasis"><em>devscripts</em></span>, который берёт на себя часть работы по обеспечению постоянства и настройке, чтобы сделать задачу сопровождающего более легкой.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>КРАТКИЙ ОБЗОР</em></span> <code
                          class="command">pbuilder</code></strong></p></div></div></div><a
                id="id-1.18.4.5.7.2"
                class="indexterm"></a><div
                class="para">
				Программа <code
                  class="command">pbuilder</code> (в пакете с таким же названием) позволяет собирать пакет Debian в <span
                  class="emphasis"><em>изолированном</em></span> окружении. Она сперва создает временный каталог, содержащий минимальную систему, требующуюся для сборки пакета (включая пакеты, упомянутые в поле <span
                  class="emphasis"><em>Build-Depends</em></span>). Этот каталог в дальнейшем используется в качестве корневого каталога (<code
                  class="filename">/</code>) командой <code
                  class="command">chroot</code> для сборки пакета.
			</div><div
                class="para">
				Этот инструмент позволяет выполнять процесс сборки в окружении, не затрагиваемом пользовательскими манипуляциями. Он также позволяет быстро обнаружить недостающие сборочные зависимости (так как сборка завершится неудачно, если соответствующие зависимости не документированы). И наконец, он позволяет собрать пакет для версии Debian, отличной от установленной на данной машине: для обычной работы может использоваться <span
                  class="distribution distribution">Stable</span>, а в <code
                  class="command">pbuilder</code>, запущенном на том же оборудовании, для сборки пакетов может использоваться <span
                  class="distribution distribution">Unstable</span>.
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.dealing-with-compromised-machine.html"><strong>Пред.</strong>14.7. Dealing with a Compromised Machine</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Наверх</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Начало</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.building-first-package.html"><strong>След.</strong>15.2. Сборка вашего первого пакета</a></li></ul></body></html>
