<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">15.3. APT 用のパッケージリポジトリの作成</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-9-ja-JP-1.0-1" /><meta
        name="keywords"
        content="バックポート, 再ビルド, ソースパッケージ, アーカイブ, メタパッケージ, Debian 開発者, メンテナ" /><link
        rel="home"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="up"
        href="debian-packaging.html"
        title="第 15 章 Debian パッケージの作成" /><link
        rel="prev"
        href="sect.building-first-package.html"
        title="15.2. 最初のパッケージのビルド" /><link
        rel="next"
        href="sect.becoming-package-maintainer.html"
        title="15.4. パッケージメンテナになる" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/ja-JP/stable/sect.setup-apt-package-repository.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.building-first-package.html"><strong>戻る</strong></a></li><li
          class="home">Debian 管理者ハンドブック</li><li
          class="next"><a
            accesskey="n"
            href="sect.becoming-package-maintainer.html"><strong>次へ</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.setup-apt-package-repository"></a>15.3. APT 用のパッケージリポジトリの作成</h2></div></div></div><a
          id="id-1.18.6.2"
          class="indexterm"></a><a
          id="id-1.18.6.3"
          class="indexterm"></a><div
          class="para">
			Falcot Corp のメンテナンスする Debian パッケージの数は次第に増えました。この中には既存のパッケージから手元で修正したパッケージや、内部データとプログラムを配布するために最初から作成したパッケージなどがあります。
		</div><div
          class="para">
			パッケージの配備を簡単にするために、管理者はこれらのパッケージを APT から直接使うことが可能なパッケージアーカイブに組み込みたいと思っています。明らかなメンテナンス上の理由により、管理者は内部パッケージと手元で再ビルドしたパッケージを別にしたいと思っています。すなわち、最終的に <code
            class="filename">/etc/apt/sources.list.d/falcot.list</code> ファイル内のエントリを以下のようにしたいと思っています。
		</div><pre
          class="programlisting">
deb http://packages.falcot.com/ updates/
deb http://packages.falcot.com/ internal/</pre><a
          id="id-1.18.6.7"
          class="indexterm"></a><div
          class="para">
			このため、管理者は内部 HTTP サーバ上に仮想ホストを設定して、APT リポジトリのルートとして <code
            class="filename">/srv/vhosts/packages/</code> を割り当てます。パッケージアーカイブ自体の管理は <code
            class="command">mini-dinstall</code> コマンド (同名のパッケージに含まれます) に委託されます。<code
            class="command">mini-dinstall</code> ツールは <code
            class="filename">incoming/</code> ディレクトリ (今回の場合、<code
            class="filename">/srv/vhosts/packages/mini-dinstall/incoming/</code>) を監視して、新しいパッケージがこのディレクトリにアップロードされることを待ちます。そしてパッケージがアップロードされたら、<code
            class="command">mini-dinstall</code> は <code
            class="filename">/srv/vhosts/packages/</code> のパッケージアーカイブにパッケージをインストールします。<code
            class="command">mini-dinstall</code> コマンドは Debian パッケージが生成された時に作成される <code
            class="filename">*.changes</code> ファイルを読みます。<code
            class="filename">*.changes</code> ファイルには、パッケージのバージョンに対応するその他のファイル (<code
            class="filename">*.deb</code>、<code
            class="filename">*.dsc</code>、<code
            class="filename">*.diff.gz</code>/<code
            class="filename">*.debian.tar.gz</code>、<code
            class="filename">*.orig.tar.gz</code>、その他の圧縮ツールを使った場合の同等ファイル) のリストが書かれており、<code
            class="command">mini-dinstall</code> はこのリストに従ってインストールするファイルを把握します。さらに <code
            class="filename">*.changes</code> ファイルの <code
            class="literal">Distribution</code> ヘッダフィールドには、<code
            class="filename">debian/changelog</code> ファイル内の最新エントリに書かれた対象ディストリビューションの名前 (通常 <code
            class="literal">unstable</code>) が書かれており、<code
            class="command">mini-dinstall</code> はこの名前に従ってパッケージのインストール先を決めます。このため、管理者は対象パッケージをビルドする前に <code
            class="filename">debian/changelog</code> ファイル内の最新エントリに書かれた対象ディストリビューションの名前を必ず変更し、対象パッケージのインストール先に従ってその名前を <code
            class="literal">internal</code> または <code
            class="literal">updates</code> に設定しなければいけません。この後、<code
            class="command">mini-dinstall</code> は APT が必要とする <code
            class="filename">Packages.gz</code> などのファイルを生成します。
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>ALTERNATIVE</em></span> <code
                      class="command">apt-ftparchive</code></strong></p></div></div></div><a
            id="id-1.18.6.9.2"
            class="indexterm"></a><div
            class="para">
			必要なパッケージアーカイブが <code
              class="command">mini-dinstall</code> を使うほど複雑なパッケージアーカイブではない場合、<code
              class="command">apt-ftparchive</code> コマンドを使うことも可能です。<code
              class="command">apt-ftparchive</code> ツールは指定したディレクトリの内容を調査して、その内容に対応する <code
              class="filename">Packages</code> ファイルを (標準出力に) 表示します。<code
              class="command">apt-ftparchive</code> を使う場合、Falcot Corp の管理者はパッケージを直接 <code
              class="filename">/srv/vhosts/packages/updates/</code> や <code
              class="filename">/srv/vhosts/packages/internal/</code> にアップロードすることが可能です。その後以下のコマンドを実行して <code
              class="filename">Packages.gz</code> ファイルを作成します。
		</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cd /srv/vhosts/packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>apt-ftparchive packages updates &gt;updates/Packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>gzip updates/Packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>apt-ftparchive packages internal &gt;internal/Packages</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>gzip internal/Packages</code></strong></pre><div
            class="para">
			<code
              class="command">apt-ftparchive sources</code> コマンドを使えば、同様の方法で <code
              class="filename">Sources.gz</code> ファイルを作成することが可能です。
		</div></div><div
          class="para">
			<code
            class="command">mini-dinstall</code> を設定するには、<code
            class="filename">~/.mini-dinstall.conf</code> ファイルをセットアップする必要があります。Falcot Corp では以下の通り設定しました。
		</div><pre
          class="programlisting">
[DEFAULT]
archive_style = flat
archivedir = /srv/vhosts/packages

verify_sigs = 0
mail_to = admin@falcot.com

generate_release = 1
release_origin = Falcot Corp
release_codename = stable

[updates]
release_label = Recompiled Debian Packages

[internal]
release_label = Internal Packages</pre><div
          class="para">
			各パッケージアーカイブに対して <code
            class="filename">Release</code> ファイルを作成することに決めた点は注目に値します。これは <code
            class="filename">/etc/apt/preferences</code> 設定ファイルを使ってパッケージインストール優先度を管理する場合に役立ちます (詳細は<a
            class="xref"
            href="sect.apt-get.html#sect.apt.priorities">第 6.2.5 節「パッケージ優先度の管理」</a>を参照してください)。
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>SECURITY</em></span> <code
                      class="command">mini-dinstall</code> とパーミッション</strong></p></div></div></div><div
            class="para">
			<code
              class="command">mini-dinstall</code> は標準的なユーザとして実行されるように設計されています。root で実行される必要はありません。最も簡単な方法は Debian パッケージ作成担当の管理者グループに所属するユーザアカウントを使ってすべてを設定することです。<code
              class="filename">incoming/</code> ディレクトリへファイルを追加するために必要な権限を与えられているのは Debian パッケージ作成担当の管理者だけなので、パッケージを追加する前に各パッケージの出自の確認は済んでいると考えられますし、<code
              class="command">mini-dinstall</code> を使ってもう一度パッケージの出自を確認する必要もなくなります。この理由により、パラメータ <code
              class="literal">verify_sigs = 0</code> が設定されています (これは <code
              class="command">mini-dinstall</code> が署名を確認する必要がないことを意味します)。しかしながら、パッケージの内容が機密に関わるものであれば、この設定を逆にして、パッケージ作成担当者の公開鍵を含む鍵束 (<code
              class="literal">extra_keyrings</code> パラメータを使って設定されます) を使ってパッケージの出自を確認するように設定することが可能です。そしてこのように設定した場合、<code
              class="command">mini-dinstall</code> は <code
              class="filename">*.changes</code> ファイルに統合された署名を解析することによってアップロードされた各パッケージの出自を確認します。
		</div></div><div
          class="para">
			<code
            class="command">mini-dinstall</code> を実行すると、バックグラウンドでデーモンが開始されます。<code
            class="command">mini-dinstall</code> デーモンが実行されている限り、デーモンは 30 分ごとに <code
            class="filename">incoming/</code> ディレクトリにアップロードされた新しいパッケージを確認します。そして新しいパッケージがアップロードされると、パッケージはパッケージアーカイブに移動され、適切な <code
            class="filename">Packages.gz</code> と <code
            class="filename">Sources.gz</code> ファイルが再生成されます。デーモンの実行に問題がある場合、<code
            class="filename">incoming/</code> ディレクトリにパッケージをアップロードしたら毎回、手作業で <code
            class="command">mini-dinstall</code> をバッチモードで実行します (<code
            class="literal">-b</code> オプションを付けます)。<code
            class="command">mini-dinstall</code> 他の使い方は <span
            class="citerefentry"><span
              class="refentrytitle">mini-dinstall</span>(1)</span> マニュアルページで説明されています。
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>EXTRA</em></span> 署名済みパッケージアーカイブの生成</strong></p></div></div></div><div
            class="para">
			APT スイートは対象のパッケージをインストールする前にそのパッケージに含まれる一連の暗号署名を確認し、そのパッケージの信頼性を確かめます (<a
              class="xref"
              href="sect.package-authentication.html">第 6.5 節「パッケージ信頼性の確認」</a>を参照してください)。この挙動はプライベートパッケージアーカイブにとって問題です。なぜなら、プライベートパッケージアーカイブを使うマシンでは署名されていないパッケージに関する警告が表示され続けるからです。プライベートパッケージアーカイブを安全な APT メカニズムに適合させるのが真面目な管理者の仕事と言えます。
		</div><div
            class="para">
			パッケージアーカイブの署名作業を助けるために、<code
              class="command">mini-dinstall</code> には <code
              class="filename">Release</code> に対する署名の生成に使うスクリプトを指定する <code
              class="literal">release_signscript</code> 設定オプションが含まれます。ここでは <span
              class="pkg pkg">mini-dinstall</span> パッケージによって提供された <code
              class="filename">/usr/share/doc/mini-dinstall/examples/</code> 内に含まれる <code
              class="filename">sign-release.sh</code> スクリプトが良い足掛かりとなるでしょう。しかし、このスクリプトを使うには手元で修正が必要になるかもしれません。
		</div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.building-first-package.html"><strong>戻る</strong>15.2. 最初のパッケージのビルド</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上に戻る</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>ホーム</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.becoming-package-maintainer.html"><strong>次へ</strong>15.4. パッケージメンテナになる</a></li></ul></body></html>
