<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">11.2. ウェブサーバ (HTTP)</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-ja-JP-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP, SIP" /><link
        rel="home"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="up"
        href="network-services.html"
        title="第 11 章 ネットワークサービス、Postfix、Apache、NFS、Samba、Squid、LDAP、SIP、XMPP、TURN" /><link
        rel="prev"
        href="network-services.html"
        title="第 11 章 ネットワークサービス、Postfix、Apache、NFS、Samba、Squid、LDAP、SIP、XMPP、TURN" /><link
        rel="next"
        href="sect.ftp-file-server.html"
        title="11.3. FTP ファイルサーバ" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/ja-JP/stable/sect.http-web-server.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="network-services.html"><strong>戻る</strong></a></li><li
          class="home">Debian 管理者ハンドブック</li><li
          class="next"><a
            accesskey="n"
            href="sect.ftp-file-server.html"><strong>次へ</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.http-web-server"></a>11.2. ウェブサーバ (HTTP)</h2></div></div></div><div
          class="para">
			Falcot Corp の管理者は Debian <span
            class="distribution distribution">Jessie</span> に含まれるバージョン 2.4.10 の Apache HTTP サーバを使うことに決めました。
		</div><a
          id="id-1.14.5.3"
          class="indexterm"></a><a
          id="id-1.14.5.4"
          class="indexterm"></a><a
          id="id-1.14.5.5"
          class="indexterm"></a><a
          id="id-1.14.5.6"
          class="indexterm"></a><a
          id="id-1.14.5.7"
          class="indexterm"></a><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>ALTERNATIVE</em></span> 他のウェブサーバ</strong></p></div></div></div><div
            class="para">
			Apache は最も広く知られている (最も広く使われている) ウェブサーバですが、他にもウェブサーバは存在します。これらのサーバはわずかな負荷で高い性能を発揮しますが、利用できる機能やモジュールが少ないという欠点も持っています。しかしながら、静的ファイルを提供する用途やプロキシ用途にウェブサーバを使う場合、<span
              class="pkg pkg">nginx</span> や <span
              class="pkg pkg">lighttpd</span> などの代替品は調査する価値があります。
		</div><a
            id="id-1.14.5.8.3"
            class="indexterm"></a><a
            id="id-1.14.5.8.4"
            class="indexterm"></a></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.14.5.9"></a>11.2.1. Apache のインストール</h3></div></div></div><div
            class="para">
				<span
              class="pkg pkg">apache2</span> パッケージをインストールするだけで、Apache に必要な物はすべてインストールされます。パッケージには <span
              class="emphasis"><em>Multi-Processing Modules</em></span> (MPMs) も含まれており、MPM は Apache が多くの要求の並列処理を取り扱う方法に影響をおよぼします (以前の MPM はそれぞれ対応する <span
              class="pkg pkg">apache2-mpm-*</span> パッケージから提供されていました)。<span
              class="pkg pkg">apache2</span> パッケージは <span
              class="pkg pkg">apache2-utils</span> パッケージに依存しており、<span
              class="pkg pkg">apache2-utils</span> パッケージには後に使うコマンドラインユーティリティが含まれます。
			</div><div
            class="para">
				MPM は Apache が同時要求を処理する方法に大きな影響をおよぼします。<span
              class="emphasis"><em>worker</em></span> MPM を選んだ場合、<span
              class="emphasis"><em>スレッド</em></span> (軽量プロセス) で同時要求を処理します。これに対して <span
              class="emphasis"><em>prefork</em></span> MPM を選んだ場合、あらかじめ生成したプロセスプールで同時要求を処理します。<span
              class="emphasis"><em>event</em></span> MPM を選んだ場合、スレッドで同時要求を処理しますが、非アクティブ接続 (特に HTTP <span
              class="emphasis"><em>keep-alive</em></span> 機能を使ってオープン状態を維持された接続) に対しては専用の管理スレッドで処理します。
			</div><div
            class="para">
				Falcot の管理者はさらに Apache の PHP サポートを有効化するために <span
              class="pkg pkg">libapache2-mod-php5</span> をインストールしています。<span
              class="pkg pkg">libapache2-mod-php5</span> をインストールすると、デフォルトの <span
              class="emphasis"><em>event</em></span> MPM は無効化され、代わりに <span
              class="emphasis"><em>prefork</em></span> MPM を使うようになります。なぜなら、PHP は <span
              class="emphasis"><em>prefork</em></span> MPM の下でしか動かないからです。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SECURITY</em></span> <code
                        class="literal">www-data</code> ユーザ下の実行</strong></p></div></div></div><a
              id="id-1.14.5.9.5.2"
              class="indexterm"></a><a
              id="id-1.14.5.9.5.3"
              class="indexterm"></a><div
              class="para">
				デフォルトで、Apache は入って来るリクエストを <code
                class="literal">www-data</code> ユーザからのリクエストとして取り扱います。これは Apache が実行する CGI スクリプト (動的ページ) の持つセキュリティ脆弱性によってシステム全体が被害を受けることを避け、特定のユーザが所有するファイルだけに被害を留めることが可能であることを意味しています。
			</div><div
              class="para">
				<span
                class="emphasis"><em>suexec</em></span> モジュールを使うことで、このルールを迂回することが可能です。こうすることで、一部の CGI スクリプトを別のユーザの権限で実行することが可能です。設定を行うには、Apache 設定ファイルの <code
                class="literal">SuexecUserGroup <em
                  class="replaceable">user</em><em
                  class="replaceable">group</em></code> 指示文を使います。
			</div><a
              id="id-1.14.5.9.5.6"
              class="indexterm"></a><div
              class="para">
				もう一つの可能性はたとえば <span
                class="pkg pkg">libapache2-mpm-itk</span> の提供する MPM などの専用 MPM を使うことです。<span
                class="pkg pkg">libapache2-mpm-itk</span> の挙動は普通の MPM と少し異なります。すなわち、この MPM は仮想ホスト (実質的にはページ群) を「隔離」して各仮想ホストを異なるユーザの権限で実行するための MPM です。このため、あるウェブサイトの持つ脆弱性によって他のウェブサイトの所有者の持つファイルが危険にさらされることがなくなります。
			</div></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>QUICK LOOK</em></span> モジュールのリスト</strong></p></div></div></div><div
              class="para">
				Apache の標準的なモジュールをオンラインで見ることが可能です。<div
                xmlns=""
                class="url">→ <a
                  xmlns="http://www.w3.org/1999/xhtml"
                  href="http://httpd.apache.org/docs/2.4/mod/index.html">http://httpd.apache.org/docs/2.4/mod/index.html</a></div>
			</div></div><div
            class="para">
				Apache はモジュール式サーバで、多くの機能が外部モジュールによって実装されており、主プログラムは初期化の際に外部モジュールを読み込みます。デフォルト設定では、最も一般的なモジュールだけが有効化されていますが、新しいモジュールの有効化は <code
              class="command">a2enmod <em
                class="replaceable">module</em></code> を実行するだけで簡単に行うことが可能です。これに対して、モジュールを無効化するコマンドは <code
              class="command">a2dismod <em
                class="replaceable">module</em></code> です。実際のところ、これらのプログラムは <code
              class="filename">/etc/apache2/mods-enabled/</code> 内に実際のファイル (<code
              class="filename">/etc/apache2/mods-available/</code> 内に保存されています) を指すシンボリックリンクを作成 (または削除) しているだけです。
			</div><div
            class="para">
				Apache のデフォルト設定では、ウェブサーバはポート 80 番をリッスンし (<code
              class="filename">/etc/apache2/ports.conf</code> の中で設定されています)、<code
              class="filename">/var/www/html/</code> ディレクトリに含まれるページを公開します (<code
              class="filename">/etc/apache2/sites-enabled/000-default.conf</code> の中で設定されています)。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>GOING FURTHER</em></span> SSL サポートの追加</strong></p></div></div></div><a
              id="id-1.14.5.9.9.2"
              class="indexterm"></a><a
              id="id-1.14.5.9.9.3"
              class="indexterm"></a><div
              class="para">
				Apache 2.4 には、すぐに使える安全な HTTP (HTTPS) に必要な SSL モジュールが含まれます。SSL モジュールを有効化するには、<code
                class="command">a2enmod ssl</code> を使い、さらに必要な指示文を設定ファイルに追加しなければいけません。設定例は <code
                class="filename">/etc/apache2/sites-available/default-ssl.conf</code> で提供されています。<div
                xmlns=""
                class="url">→ <a
                  xmlns="http://www.w3.org/1999/xhtml"
                  href="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html">http://httpd.apache.org/docs/2.4/mod/mod_ssl.html</a></div>
			</div><div
              class="para">
				<span
                class="emphasis"><em>Perfect Forward Secrecy</em></span> を使った SSL 接続を優先したい場合、いくつかの特別な注意が必要です (これらの接続は一過性のセッション鍵を使います。こうすることでサーバの秘密鍵が漏洩した場合でも、ネットワークのスニッフィングを行うことで保存された過去に暗号化されたトラフィックの内容が漏洩することがなくなります)。以下のページには特に Mozilla の推奨する設定例が載せられています。<div
                xmlns=""
                class="url">→ <a
                  xmlns="http://www.w3.org/1999/xhtml"
                  href="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache">https://wiki.mozilla.org/Security/Server_Side_TLS#Apache</a></div>
			</div><a
              id="id-1.14.5.9.9.6"
              class="indexterm"></a></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.14.5.10"></a>11.2.2. 仮想ホストの設定</h3></div></div></div><div
            class="para">
				仮想ホスト機能を使うことで、単独のウェブサーバで複数のサイトを運用することが可能です。
			</div><a
            id="id-1.14.5.10.3"
            class="indexterm"></a><div
            class="para">
				Apache は異なる 2 種類の仮想ホストを取り扱うことが可能です。具体的に言えば、IP アドレス (またはポート番号) とウェブサーバのドメイン名に基づいて仮想ホスト機能が実装されています。IP アドレスに基づく仮想ホスト機能を使う場合、各サイトに異なる IP アドレス (またはポート番号) を割り当てることが必要です。これに対して、ドメイン名に基づく仮想ホスト機能を使う場合、単一の IP アドレス (またはポート番号) で複数のサイトを運用することが可能で、HTTP クライアントの送信するホスト名によってサイトを識別します (こちらの方法は HTTP プロトコルのバージョン 1.1 で動作します。幸いなことに、HTTP バージョン 1.1 はすべてのクライアントが対応していると考えて良い程度に古いプロトコルです)。
			</div><div
            class="para">
				IPv4 アドレスの枯渇は (ますます) 進んでいるため、通常は単一の IP アドレスで複数のサイトを運用する方法が好まれます。しかしながら仮想ホストで HTTPS を提供する必要がある場合、ドメイン名に基づく仮想ホスト機能を使うには複雑な設定が必要になります。なぜなら、SSL プロトコルはドメイン名に基づく仮想ホストを必ず考慮するとは限らないからです。SNI 拡張 (<span
              class="emphasis"><em>Server Name Indication</em></span>) を使うことで仮想ホスト上でも SSL プロトコルを使うことが可能になりますが、SNI 拡張はすべてのブラウザで正しく使えるとは限りません。1 つのサーバで複数の HTTPS サイトを運用する必要がある場合、HTTPS サイトは通常異なるポートを使うか異なる IP アドレスを使う (IPv6 が役立ちます) ことで識別されます。
			</div><div
            class="para">
				Apache 2 のデフォルト設定では、ドメイン名に基づく仮想ホスト機能が有効にされています。加えて、<code
              class="literal">/etc/apache2/sites-enabled/000-default.conf</code> ファイルの中でデフォルトの仮想ホストが定義されています。この仮想ホストはクライアントによって送信された要求に一致するホストが見つからない場合に使われます。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CAUTION</em></span> 最初に定義された仮想ホスト</strong></p></div></div></div><div
              class="para">
				不明な仮想ホストに関する要求は最初に定義された仮想ホストへの要求として処理されます。このため管理者は <code
                class="literal">www.falcot.com</code> を最初に定義しています。
			</div></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>QUICK LOOK</em></span> Apache の SNI サポート</strong></p></div></div></div><a
              id="id-1.14.5.10.8.2"
              class="indexterm"></a><div
              class="para">
				Apache サーバは <span
                class="emphasis"><em>Server Name Indication</em></span> (SNI) と呼ばれる SSL プロトコル拡張をサポートします。SNI 拡張を使うことで、ブラウザは SSL 接続を確立する間の HTTP 要求よりもずっと前にウェブサーバのホスト名を送信することが可能になり、同じサーバ (同じ IP アドレスとポート番号を使うサーバ) で運用されている複数の仮想ホストから要求された仮想ホストを識別します。SNI 拡張を使うことで、Apache は以降のトランザクションで最も適切な SSL 証明書を選びます。
			</div><div
              class="para">
				Apache とクライアントの間で通信対象の仮想ホストが決定される前は、Apache は常にデフォルトの仮想ホストの定める証明書を使うでしょう。デフォルトの仮想ホスト以外の仮想ホストへのアクセスを試行するクライアントは警告を表示するかもしれません。なぜなら、クライアントが受け取った証明書はアクセスしようとしているウェブサイトと一致しないからです。幸いなことに、多くのブラウザは SNI を取り扱うことが可能です。具体的に言えば、Microsoft Internet Explorer バージョン 7.0 以降 (かつ Vista 以降)、Mozilla Firefox バージョン 2.0 以降、Apple Safari バージョン 3.2.1 以降、Google Chrome のすべてのバージョンは SNI を取り扱うことが可能です。
			</div><div
              class="para">
				Debian の提供する Apache パッケージは SNI サポートを有効化した状態でビルドされています。このため、特別な設定は不要です。
			</div><div
              class="para">
				最初に定義された仮想ホスト (デフォルトの仮想ホスト) に対する設定で TLSv1 を有効化することを忘れないでください。なぜなら、Apache は安全な接続を確立するために最初に定義された仮想ホストのパラメータを使うため、最初に定義された仮想ホストのパラメータで安全な接続を有効化しなければいけません!
			</div></div><div
            class="para">
				仮想ホストを追加するには、<code
              class="filename">/etc/apache2/sites-available/</code> にファイルを追加します。<code
              class="literal">falcot.org</code> ドメインで運用されるウェブサイトをセットアップするには、以下のファイルを作成し、<code
              class="command">a2ensite www.falcot.org</code> を使って仮想ホストを有効化するだけで簡単に可能です。
			</div><div
            class="example"><a
              xmlns=""
              id="id-1.14.5.10.10"></a><p
              class="title"><strong>例 11.16 <code
                  class="filename">/etc/apache2/sites-available/www.falcot.org.conf</code> ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting">
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</pre></div></div><div
            class="para">
				ここまでの設定に従うと、Apache サーバはすべての仮想ホストに対して同じログファイルを使います (仮想ホストの定義に <code
              class="literal">CustomLog</code> 指示文を追加すればこの挙動を変えることが可能です)。そのため、ログファイルのフォーマットをカスタマイズして、仮想ホストの名前を含むようにすることが道理に適っています。これを行うには、<code
              class="filename">/etc/apache2/conf-available/customlog.conf</code> ファイルを作成してすべてのログファイルに対する新しいフォーマットを定義し (<code
              class="literal">LogFormat</code> 指示文を使います)、さらに <code
              class="command">a2enconf customlog</code> を有効化します。また、<code
              class="filename">/etc/apache2/sites-available/000-default.conf</code> ファイルから <code
              class="literal">CustomLog</code> 指示文を削除 (またはコメントアウト) しなければいけません。
			</div><div
            class="example"><a
              xmlns=""
              id="id-1.14.5.10.12"></a><p
              class="title"><strong>例 11.17 <code
                  class="filename">/etc/apache2/conf.d/customlog.conf</code> ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting scale">
# (仮想) ホスト名を含む新しいログフォーマット
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# 上で定義した "vhost" フォーマットを使用します
CustomLog /var/log/apache2/access.log vhost</pre></div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.14.5.11"></a>11.2.3. よく使われる指示文</h3></div></div></div><div
            class="para">
				この節では、いくつかのよく使われる Apache 設定指示文を簡単に見直します。
			</div><a
            id="id-1.14.5.11.3"
            class="indexterm"></a><a
            id="id-1.14.5.11.4"
            class="indexterm"></a><div
            class="para">
				主要設定ファイルにはいくつかの <code
              class="literal">Directory</code> ブロックが含まれます。<code
              class="literal">Directory</code> ブロックを使うことで、提供されるファイルの位置に従って、サーバの挙動を変えることが可能です。<code
              class="literal">Directory</code> ブロックには通常 <code
              class="literal">Options</code> と <code
              class="literal">AllowOverride</code> 指示文が含まれます。
			</div><a
            id="id-1.14.5.11.6"
            class="indexterm"></a><a
            id="id-1.14.5.11.7"
            class="indexterm"></a><div
            class="example"><a
              xmlns=""
              id="id-1.14.5.11.8"></a><p
              class="title"><strong>例 11.18 Directory ブロック</strong></p><div
              class="example-contents"><pre
                class="programlisting">
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;</pre></div></div><div
            class="para">
				<code
              class="literal">DirectoryIndex</code> 指示文には、クライアントからディレクトリを要求された場合に応答として送信するファイルのリストを指定します。リスト内の最初に見つかったファイルが応答として使われます。
			</div><a
            id="id-1.14.5.11.10"
            class="indexterm"></a><div
            class="para">
				<code
              class="literal">Options</code> 指示文には、有効化するオプションを指定します。<code
              class="literal">None</code> を指定するとすべてのオプションが無効化されます。それに対して <code
              class="literal">All</code> を指定すると <code
              class="literal">MultiViews</code> を除いたすべてのオプションが有効化されます。以下に利用できるオプションを挙げます。
			</div><div
            xmlns:d="http://docbook.org/ns/docbook"
            class="itemizedlist"><ul><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">ExecCGI</code>。サーバは CGI スクリプトの実行を許可されます。<a
                    id="id-1.14.5.11.12.1.1.2"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">FollowSymlinks</code>。サーバはシンボリックリンクをたどってリンク先の内容を応答として返すことを許可されます。<a
                    id="id-1.14.5.11.12.2.1.2"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">SymlinksIfOwnerMatch</code>。サーバはシンボリックリンクとリンク先が同じ所有者の場合に限りシンボリックリンクをたどることを許可されます。<a
                    id="id-1.14.5.11.12.3.1.2"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">Includes</code>。サーバは <span
                    class="emphasis"><em>Server Side Includes</em></span> (略して <span
                    class="emphasis"><em>SSI</em></span>) を使うことを許可されます。SSI とは HTML ページの中に埋め込まれた要求ごとにその場で処理される指示です。<a
                    id="id-1.14.5.11.12.4.1.4"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">Indexes</code>。サーバはクライアントの送信した HTTP 要求が index ファイルの含まれないディレクトリを指している場合 (たとえば <code
                    class="literal">DirectoryIndex</code> 指示文でリストされているファイルがこのディレクトリ内に存在しない場合) にディレクトリの内容をリストすることを許可されます。<a
                    id="id-1.14.5.11.12.5.1.3"
                    class="indexterm"></a>
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">MultiViews</code>。サーバはコンテンツネゴシエーションを使うことを許可されます。コンテンツネゴシエーションを使うことで、サーバはブラウザで設定した優先言語に一致するウェブページを返します。<a
                    id="id-1.14.5.11.12.6.1.2"
                    class="indexterm"></a>
					</div></li></ul></div><div
            class="para">
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>BACK TO BASICS</em></span> <code
                        class="filename">.htaccess</code> ファイル</strong></p></div></div></div><div
              class="para">
				<code
                class="filename">.htaccess</code> ファイルには、Apache 設定指示文が含まれます。<code
                class="filename">.htaccess</code> ファイル内の設定は <code
                class="filename">.htaccess</code> ファイルが保存されているディレクトリに含まれる要素が要求された時に強制されます。指示文の有効範囲は <code
                class="filename">.htaccess</code> が保存されているディレクトリ以下すべてのサブディレクトリです。
			</div><a
              id="id-1.14.5.11.14.3"
              class="indexterm"></a><div
              class="para">
				<code
                class="literal">Directory</code> ブロック内に書かれたほとんどの指示文は <code
                class="filename">.htaccess</code> ファイル内でも使うことが可能です。
			</div></div><div
            class="para">
				<code
              class="literal">AllowOverride</code> 指示文には、<code
              class="filename">.htaccess</code> ファイルを使って有効化または無効化することを許可するすべてのオプションをリストします。<code
              class="literal">AllowOverride</code> 指示文は一般に <code
              class="literal">ExecCGI</code> を制限するために使われることが多いです。こうすることで、管理者はウェブサーバ (<code
              class="literal">www-data</code> ユーザ) の権限でプログラムを実行することを許可するユーザを選択します。
			</div><a
            id="id-1.14.5.11.16"
            class="indexterm"></a><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.14.5.11.17"></a>11.2.3.1. 認証要求</h4></div></div></div><a
              id="id-1.14.5.11.17.2"
              class="indexterm"></a><div
              class="para">
					ウェブサイトのある部分へのアクセスを制限し、ユーザ名とパスワードに基づく正当なユーザだけが内容にアクセスできるように設定する必要があるかもしれません。
				</div><div
              class="example"><a
                xmlns=""
                id="id-1.14.5.11.17.4"></a><p
                class="title"><strong>例 11.19 認証要求を行う <code
                    class="filename">.htaccess</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> 無意味なセキュリティ</strong></p></div></div></div><div
                class="para">
					上の例で使われている <code
                  class="literal">Basic</code> 認証システムは最低限のセキュリティを提供します。パスワードは平文で送信されます (パスワードは暗号化よりも単純な符号化である <span
                  class="emphasis"><em>base64</em></span> で符号化されるだけです)。<code
                  class="literal">Basic</code> 認証システムで「保護」されている文書はネットワークを平文で送信される点も注意するべきです。セキュリティが重要な場合、HTTP 接続全体を SSL で暗号化するべきです。
				</div></div><div
              class="para">
					<code
                class="filename">/etc/apache2/authfiles/htpasswd-private</code> ファイルには、ユーザとパスワードのリストが含まれます。このファイルを操作するには通常 <code
                class="command">htpasswd</code> コマンドを使います。たとえば、以下のコマンドを使うことで、ユーザを追加するかユーザのパスワードを変更します。<a
                id="id-1.14.5.11.17.6.3"
                class="indexterm"></a>
				</div><pre
              class="screen">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>htpasswd /etc/apache2/authfiles/htpasswd-private <em
                    class="replaceable">user</em>
</code></strong><code
                class="computeroutput">New password:
Re-type new password:
Adding password for user <em
                  class="replaceable">user</em>
</code></pre></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.14.5.11.18"></a>11.2.3.2. アクセス制限</h4></div></div></div><a
              id="id-1.14.5.11.18.2"
              class="indexterm"></a><div
              class="para">
					<code
                class="literal">Require</code> 指示文を使うことで、あるディレクトリへのアクセスを制御 (とサブディレクトリへのアクセスを再帰的に制御) します。
				</div><a
              id="id-1.14.5.11.18.4"
              class="indexterm"></a><a
              id="id-1.14.5.11.18.5"
              class="indexterm"></a><a
              id="id-1.14.5.11.18.6"
              class="indexterm"></a><div
              class="para">
					<code
                class="literal">Require</code> 指示文は多くの基準を基にアクセスを制限するために使われます。ここではクライアントの IP アドレスに基づいてアクセス制限の基準を定義するのではなく、特にいくつかの <code
                class="literal">Require</code> 指示文を <code
                class="literal">RequireAll</code> ブロックと組み合わせることでより強力なアクセス制限の基準を表現します。
				</div><div
              class="example"><a
                xmlns=""
                id="id-1.14.5.11.18.8"></a><p
                class="title"><strong>例 11.20 ローカルネットワークからのアクセスだけを許可する例</strong></p><div
                class="example-contents"><pre
                  class="programlisting">Require ip 192.168.0.0/16</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>ALTERNATIVE</em></span> 古い構文</strong></p></div></div></div><div
                class="para">
					<code
                  class="literal">Require</code> 指示文を使って IP アドレスに基づく制限を行う機能は Apache 2.4 (<span
                  class="distribution distribution">Jessie</span> で提供されるバージョン) でのみ利用できます。<span
                  class="distribution distribution">Wheezy</span> のユーザ向けの説明になりますが、Apache 2.2 で IP アドレスに基づく制限を行うには別の構文を使います。ここでは主に参照用として Apache 2.2 の構文を説明しますが、この構文は <code
                  class="literal">mod_access_compat</code> モジュールを使えば Apache 2.4 でも利用できます。
				</div><div
                class="para">
					<code
                  class="literal">Allow from</code> と <code
                  class="literal">Deny from</code> 指示文を使うことで、あるディレクトリへのアクセスを制御 (とサブディレクトリへのアクセスを再帰的に制御) します。
				</div><a
                id="id-1.14.5.11.18.9.4"
                class="indexterm"></a><a
                id="id-1.14.5.11.18.9.5"
                class="indexterm"></a><a
                id="id-1.14.5.11.18.9.6"
                class="indexterm"></a><div
                class="para">
					<code
                  class="literal">Order</code> 指示文を使うことで、<code
                  class="literal">Allow from</code> と <code
                  class="literal">Deny from</code> 指示文を評価する順番をサーバに伝えます。ここでは最後に一致したものが優先されます。具体的に言えば、<code
                  class="literal">Order deny,allow</code> を使うと、<code
                  class="literal">Deny from</code> に一致しないホストまたは <code
                  class="literal">Allow from</code> に一致するホストからのアクセスを許可します。反対に、<code
                  class="literal">Order allow,deny</code> を使うと、<code
                  class="literal">Allow from</code> に一致しないホストまたは <code
                  class="literal">Deny from</code> に一致するホストからのアクセスを拒否します。
				</div><div
                class="para">
					<code
                  class="literal">Allow from</code> と <code
                  class="literal">Deny from</code> 指示文には、IP アドレス、ネットワーク (たとえば <code
                  class="literal">192.168.0.0/255.255.255.0</code>、<code
                  class="literal">192.168.0.0/24</code>、<code
                  class="literal">192.168.0</code> など)、ホスト名、ドメイン名、全員を意味する <code
                  class="literal">all</code> キーワードを使うことが可能です。
				</div><div
                class="para">
					たとえば、デフォルトですべてのアクセスを拒否してローカルネットワークからのアクセスだけを許可するには以下の通り設定します。
				</div><pre
                class="programlisting">
Order deny,allow
Allow from 192.168.0.0/16
Deny from all</pre></div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.14.5.12"></a>11.2.4. ログ解析ソフトウェア</h3></div></div></div><div
            class="para">
				ウェブサーバには、通常ログ解析ソフトウェアがインストールされます。なぜなら、ログ解析ソフトウェアを使うことで管理者はウェブサーバの使用形態に関する正確な知見を得ることが可能だからです。
			</div><div
            class="para">
				Falcot Corp の管理者は <span
              class="emphasis"><em>AWStats</em></span> (<span
              class="emphasis"><em>Advanced Web Statistics</em></span>) を使って Apache ログファイルを解析することに決めました。
			</div><a
            id="id-1.14.5.12.4"
            class="indexterm"></a><a
            id="id-1.14.5.12.5"
            class="indexterm"></a><a
            id="id-1.14.5.12.6"
            class="indexterm"></a><a
            id="id-1.14.5.12.7"
            class="indexterm"></a><div
            class="para">
				最初に <code
              class="filename">/etc/awstats/awstats.conf</code> ファイルをカスタマイズして設定を行います。Falcot の管理者は以下のパラメータだけを修正し、他はそのままの状態にしています。
			</div><pre
            class="programlisting">
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</pre><div
            class="para">
				これらのパラメータに関する説明はテンプレートファイルにコメントとして書かれています。特に、<code
              class="varname">LogFile</code> と <code
              class="varname">LogFormat</code> パラメータを使って、ログファイルの場所とログファイルに含まれる情報の書式を指定します。さらに <code
              class="varname">SiteDomain</code> と <code
              class="varname">HostAliases</code> は主要ウェブサイトに割り当てている複数の名前をリストします。
			</div><div
            class="para">
				トラフックの多いサイトでは通常 <code
              class="varname">DNSLookup</code> を <code
              class="literal">1</code> に設定するべきではありません。トラフィックの少ないサイトでは Falcot の設定と同様に <code
              class="varname">DNSLookup</code> を設定することで、解析結果に生 IP アドレスではなく完全なマシン名が含まれるようになり、解析結果を読みやすくなります。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SECURITY</em></span> 統計へのアクセス</strong></p></div></div></div><div
              class="para">
				AWStats は統計をウェブサイト上で利用できるようにしており、デフォルトでは統計へのアクセスは制限されていません。しかし、ごく少数の (おそらく内部の) IP アドレスだけが統計にアクセスできるように制限をかけることも可能です。アクセスを許可する IP アドレスのリストは <code
                class="varname">AllowAccessFromWebToFollowingIPAddresses</code> パラメータで定義する必要があります。
			</div></div><div
            class="para">
				他の仮想ホストに対して AWStats を有効化することも可能です。その場合、各仮想ホストに対して <code
              class="filename">/etc/awstats/awstats.www.falcot.org.conf</code> などの設定ファイルを作ってください。
			</div><div
            class="example"><a
              xmlns=""
              id="id-1.14.5.12.14"></a><p
              class="title"><strong>例 11.21 仮想ホスト用の AWStats 設定ファイル</strong></p><div
              class="example-contents"><pre
                class="programlisting">
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"</pre></div></div><div
            class="para">
				AWStats は <code
              class="filename">/usr/share/awstats/icon/</code> ディレクトリに保存されている多くのアイコンを使います。ウェブサイトでこれらのアイコンを使えるようにするためには、以下の指示文を Apache の設定に追加する必要があります。
			</div><pre
            class="programlisting">
Alias /awstats-icon/ /usr/share/awstats/icon/</pre><div
            class="para">
				数分後 (スクリプトを複数回実行した後)、結果をオンラインで見ることが可能になります。<div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://www.falcot.com/cgi-bin/awstats.pl">http://www.falcot.com/cgi-bin/awstats.pl</a></div><div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://www.falcot.org/cgi-bin/awstats.pl">http://www.falcot.org/cgi-bin/awstats.pl</a></div>
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CAUTION</em></span> ログファイルの循環</strong></p></div></div></div><div
              class="para">
				統計はすべてのログに対して取られるため、Apache ログファイルが循環される直前に <span
                class="emphasis"><em>AWStats</em></span> を実行する必要があります。<code
                class="filename">/etc/logrotate.d/apache2</code> ファイルの <code
                class="literal">prerotate</code> 指示文から判断すると、これを解決するには、<code
                class="filename">/usr/share/awstats/tools/update.sh</code> へのシンボリックリンクを <code
                class="filename">/etc/logrotate.d/httpd-prerotate</code> に作成します。
			</div><pre
              class="screen"><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>cat /etc/logrotate.d/apache2
</code></strong><code
                class="computeroutput">/var/log/apache2/*.log {
  daily
  missingok
  rotate 14
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    if /etc/init.d/apache2 status &gt; /dev/null ; then \
      /etc/init.d/apache2 reload &gt; /dev/null; \
    fi;
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ </code><strong
                class="userinput"><code>sudo mkdir -p /etc/logrotate.d/httpd-prerotate
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats
</code></strong></pre><div
              class="para">
				<code
                class="command">logrotate</code> によって作成されたログファイルは誰でも (特に AWStats から) 読み取り可能にしておく必要があります。上の例では、(デフォルトの <code
                class="literal">640</code> パーミッションの代わりに) <code
                class="literal">create 644 root adm</code> 行を追加することでこれを実現しています。
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="network-services.html"><strong>戻る</strong>第 11 章 ネットワークサービス、Postfix、Apache、NFS、Samba、Squid、...</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上に戻る</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>ホーム</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.ftp-file-server.html"><strong>次へ</strong>11.3. FTP ファイルサーバ</a></li></ul></body></html>
