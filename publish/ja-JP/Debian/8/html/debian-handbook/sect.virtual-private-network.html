<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">10.2. 仮想プライベートネットワーク</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-ja-JP-1.0-1" /><meta
        name="keywords"
        content="ネットワーク, ゲートウェイ, TCP/IP, IPv6, DNS, Bind, DHCP, QoS" /><link
        rel="home"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="up"
        href="network-infrastructure.html"
        title="第 10 章 ネットワークインフラ" /><link
        rel="prev"
        href="network-infrastructure.html"
        title="第 10 章 ネットワークインフラ" /><link
        rel="next"
        href="sect.quality-of-service.html"
        title="10.3. Quality of Service" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/ja-JP/stable/sect.virtual-private-network.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>戻る</strong></a></li><li
          class="home">Debian 管理者ハンドブック</li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>次へ</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.virtual-private-network"></a>10.2. 仮想プライベートネットワーク</h2></div></div></div><div
          class="para">
			<span
            class="emphasis"><em>仮想プライベートネットワーク</em></span> (略して VPN) は 2 つの異なるローカルネットワークをインターネットに作ったトンネルを経由してつなげる方法です。さらに、トンネルは通常機密を守るために暗号化されます。VPN はリモートマシンを会社のローカルネットワークの中に参加させるために使われることが多いです。
		</div><a
          id="id-1.13.5.3"
          class="indexterm"></a><a
          id="id-1.13.5.4"
          class="indexterm"></a><a
          id="id-1.13.5.5"
          class="indexterm"></a><div
          class="para">
			VPN 機能を提供するツールにはさまざまなものがあります。OpenVPN は効果的な解決策で、設置とメンテナンスが簡単で、SSL/TLS に基づいています。別の可能性は IPsec を使って 2 台のマシン間の IP トラフィックを暗号化することです。IPsec の暗号化は透過的で、ホスト上で実行されているアプリケーションは VPN の存在を気にする必要がありません。SSH は伝統的な機能に加えて、VPN を提供するために使われる場合もあります。最後に、Microsoft の PPTP プロトコルを使って VPN を作ることも可能です。他にも解決策は存在しますが、本書では解説しません。
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.openvpn"></a>10.2.1. OpenVPN</h3></div></div></div><a
            id="id-1.13.5.7.2"
            class="indexterm"></a><div
            class="para">
				OpenVPN は仮想プライベートネットワーク作成専用ソフトウェアの一種です。OpenVPN をセットアップするには VPN サーバ上とクライアント上に仮想ネットワークインターフェースの作成が必要です。さらに、OpenVPN は <code
              class="literal">tun</code> (IP レベルトンネル用) と <code
              class="literal">tap</code> (イーサネットレベルトンネル用) インターフェースをサポートします。実際には、VPN クライアントをイーサネットブリッジ経由でサーバのローカルネットワークに参加させる場合を除いて、<code
              class="literal">tun</code> インターフェースが最もよく使われます。
			</div><div
            class="para">
				OpenVPN は SSL/TLS 暗号化と関連する機能 (機密性、認証、整合性、否認防止) を使うために OpenSSL に依存しています。OpenVPN は共有秘密鍵または公開鍵基盤に基づく X.509 証明書を使うように設定できます。公開鍵基盤に基づく X.509 証明書を使うよう設定することをお勧めします。なぜなら、公開鍵基盤に従えば VPN にアクセスするローミングユーザの数が増えた場合も大きな自由度を保つことが可能だからです。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CULTURE</em></span> SSL と TLS</strong></p></div></div></div><a
              id="id-1.13.5.7.5.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.5.3"
              class="indexterm"></a><div
              class="para">
				SSL (<span
                class="emphasis"><em>Secure Socket Layer</em></span>) プロトコルはウェブサーバとの安全な接続を確立する目的で Netscape によって考案されました。SSL は後に TLS (<span
                class="emphasis"><em>Transport Layer Security</em></span>) の下で IETF によって標準化されました。その後 TLS は進化を続けました。対して SSL は構造的欠陥を見つけられたため SSL を使うことは推奨されません。
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.easy-rsa"></a>10.2.1.1. 公開鍵基盤、<span
                      class="emphasis"><em>easy-rsa</em></span></h4></div></div></div><a
              id="id-1.13.5.7.6.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.3"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.4"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.5"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.6"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.7"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.8"
              class="indexterm"></a><div
              class="para">
					公開鍵暗号では RSA アルゴリズムが広く使われています。公開鍵暗号は秘密鍵と公開鍵からなる「鍵ペア」を使います。2 種類の鍵は互いに密接な関係を持っており、公開鍵で暗号化されたメッセージは秘密鍵を知っている人だけが復号化できるという数学的特徴によって機密性が保証されます。逆に、秘密鍵を使って暗号化されたメッセージは公開鍵を持っている人なら誰でも復号化できます。この特徴を使うことで、メッセージの出自が本物であることを確認することが可能です。なぜなら、秘密鍵を持つものだけがその暗号化メッセージを生成できるからです。デジタルハッシュ関数 (MD5、SHA1、最近の亜種など) を組み合わせることで、これはいかなるメッセージにも適用できる署名メカニズムになります。
				</div><div
              class="para">
					しかしながら、鍵ペアを作り、鍵ペアに任意の識別情報を保存し、自由に識別情報を偽ることは誰でも可能です。これに対する 1 つの解決策が X.509 標準によって体系化された<span
                class="emphasis"><em>認証局</em></span> (CA) の概念です。<span
                class="emphasis"><em>認証局</em></span>という用語には、<span
                class="emphasis"><em>ルート証明書</em></span>として知られる信頼された鍵ペアに保存された識別情報の実体の意味も含まれています。<span
                class="emphasis"><em>ルート証明書</em></span>は他の証明書 (鍵ペア) を署名するためにのみ使われ、署名したい鍵ペアに保存される識別情報を確認するために適切な手順を経た後に署名が行われます。こうすることで X.509 を使うアプリケーションは自分に提示された証明書の識別情報を確認し、提示された証明書が信頼されたルート証明書によって署名されたかを判断できます。
				</div><div
              class="para">
					OpenVPN はこの識別情報確認ルールに従います。パブリック認証局は (高額な) 料金と引き換えに証明書を発行しているに過ぎません。OpenVPN を使えば会社内のプライベート認証局を作成することが可能です。<span
                class="pkg pkg">easy-rsa</span> パッケージは X.509 証明書基盤としての機能を果たすツールを提供し、このツールは <code
                class="command">openssl</code> コマンドを使うスクリプト群として実装されています。
				</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTE</em></span> <span
                          class="distribution distribution">Jessie</span> 以前の <span
                          class="emphasis"><em>easy-rsa</em></span></strong></p></div></div></div><div
                class="para">
					<span
                  class="distribution distribution">Wheezy</span> までの Debian のバージョンでは、<span
                  class="emphasis"><em>easy-rsa</em></span> は <span
                  class="pkg pkg">openvpn</span> パッケージの一部として配布されており、<span
                  class="emphasis"><em>easy-rsa</em></span> のスクリプトは <code
                  class="filename">/usr/share/doc/openvpn/examples/easy-rsa/2.0/</code> 以下に含まれていました。認証局を設定するには、ここで説明されているように <code
                  class="command">make-cadir</code> コマンドを使うのではなく、このディレクトリをコピーする必要がありました。
				</div></div><div
              class="para">
					Falcot Corp の管理者は <span
                class="emphasis"><em>easy-rsa</em></span> ツールを使い、サーバおよびクライアントに必要な証明書を作ります。<span
                class="emphasis"><em>easy-rsa</em></span> ツールを使うことで、すべてのクライアントの設定を同様にすることが可能です。クライアントは Falcot のプライベート認証局から発行された証明書を信頼するようにセットアップしなければいけません。最初に Falcot のプライベート認証局用の証明書を発行します。この目的を達成するために、管理者は認証局に必要なファイルを含むディレクトリを適切な場所にセットアップします。セットアップする場所は、認証局の秘密鍵が盗まれる危険性を和らげるために、ネットワークに接続されていないマシンが好ましいです。
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>make-cadir pki-falcot
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>cd pki-falcot</code></strong></pre><div
              class="para">
					<span
                class="emphasis"><em>easy-rsa</em></span> ツールは必要なパラメータを <code
                class="filename">vars</code> ファイルに保存します。パラメータには特に <code
                class="literal">KEY_</code> 接頭辞が付けられています。これらの変数は環境変数に組み込まれます。
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>vim vars
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>grep KEY_ vars
</code></strong><code
                class="computeroutput">export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
export KEY_DIR="$EASY_RSA/keys"
echo NOTE: If you run ./clean-all, I will be doing a rm -rf on $KEY_DIR
export KEY_SIZE=2048
export KEY_EXPIRE=3650
export KEY_COUNTRY="FR"
export KEY_PROVINCE="Loire"
export KEY_CITY="Saint-Étienne"
export KEY_ORG="Falcot Corp"
export KEY_EMAIL="admin@falcot.com"
export KEY_OU="Certificate authority"
export KEY_NAME="Certificate authority for Falcot Corp"
# If you'd like to sign all keys with the same Common Name, uncomment the KEY_CN export below
# export KEY_CN="CommonName"
$ </code><strong
                class="userinput"><code>. ./vars
</code></strong><code
                class="computeroutput">NOTE: If you run ./clean-all, I will be doing a rm -rf on /home/roland/pki-falcot/keys
$ </code><strong
                class="userinput"><code>./clean-all
</code></strong></pre><div
              class="para">
					次にプライベート認証局の鍵ペアを作成します (この最中に、鍵ペアの 2 つの部分が <code
                class="filename">keys/ca.crt</code> と <code
                class="filename">keys/ca.key</code> に保存されます)。
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-ca</code></strong>
<code
                class="computeroutput">Generating a 2048 bit RSA private key
...................................................................+++
...+++
writing new private key to 'ca.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [Falcot Corp CA]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:
</code></pre><div
              class="para">
					これで VPN サーバの証明書および SSL/TLS 接続のサーバ側に必要な Diffie-Hellman パラメータを作ることが可能になりました。VPN サーバは DNS 名 <code
                class="literal">vpn.falcot.com</code> で識別されます。ここで指定した DNS 名は作成される鍵ファイルの名前としても使われます (<code
                class="filename">keys/vpn.falcot.com.crt</code> は公開鍵証明書、<code
                class="filename">keys/vpn.falcot.com.key</code> は秘密鍵です)。
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key-server vpn.falcot.com
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
.....................................................................................................................+++
...........+++
writing new private key to 'vpn.falcot.com.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [vpn.falcot.com]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Using configuration from /home/roland/pki-falcot/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'FR'
stateOrProvinceName   :PRINTABLE:'Loire'
localityName          :T61STRING:'Saint-\0xFFFFFFC3\0xFFFFFF89tienne'
organizationName      :PRINTABLE:'Falcot Corp'
organizationalUnitName:PRINTABLE:'Certificate authority'
commonName            :PRINTABLE:'vpn.falcot.com'
name                  :PRINTABLE:'Certificate authority for Falcot Corp'
emailAddress          :IA5STRING:'admin@falcot.com'
Certificate is to be certified until Mar  6 14:54:56 2025 GMT (3650 days)
Sign the certificate? [y/n]:</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">

1 out of 1 certificate requests certified, commit? [y/n]</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">Write out database with 1 new entries
Data Base Updated
$ </code><strong
                class="userinput"><code>./build-dh
</code></strong><code
                class="computeroutput">Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
[…]
</code></pre><div
              class="para">
					以下では、VPN クライアント用の証明書を作成します。VPN を利用するコンピュータ 1 台ごとおよび人間 1 人ずつに 1 つの証明書が必要です。
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key JoeSmith
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
................................+++
..............................................+++
writing new private key to 'JoeSmith.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:</code><strong
                class="userinput"><code>Development unit
</code></strong><code
                class="computeroutput">Common Name (eg, your name or your server's hostname) [JoeSmith]:</code><strong
                class="userinput"><code>Joe Smith
</code></strong><code
                class="computeroutput">[…]</code></pre><div
              class="para">
					すべての証明書を作ったら、証明書を適切な場所にコピーする必要があります。すなわち、ルート証明書の公開鍵 (<code
                class="filename">keys/ca.crt</code>) はすべてのマシン (サーバもクライアントも) に <code
                class="filename">/etc/ssl/certs/Falcot_CA.crt</code> という名前で保存されます。サーバの証明書はサーバにだけインストールされます (<code
                class="filename">keys/vpn.falcot.com.crt</code> は <code
                class="filename">/etc/ssl/vpn.falcot.com.crt</code> へ、<code
                class="filename">keys/vpn.falcot.com.key</code> は管理者だけが読めるようなパーミッション制限を掛けるために <code
                class="filename">/etc/ssl/private/vpn.falcot.com.key</code> へインストールされます)。同時に、対応する Diffie-Hellman パラメータ (<code
                class="filename">keys/dh2048.pem</code>) は <code
                class="filename">/etc/openvpn/dh2048.pem</code> へインストールされます。クライアント証明書は対応する VPN クライアントに同様の方法でインストールされます。
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.13.5.7.7"></a>10.2.1.2. OpenVPN サーバの設定</h4></div></div></div><div
              class="para">
					デフォルトで、OpenVPN 初期化スクリプトは <code
                class="filename">/etc/openvpn/*.conf</code> で定義されたすべての仮想プライベートネットワークを開始します。このため、VPN サーバをセットアップする場合、このディレクトリ内に対応する設定ファイルを配置することになります。設定ファイルの良い足掛かりとして <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz</code> が用意されています。これはどちらかと言えば標準的なサーバを作るためのものです。もちろん、一部のパラメータを適切に設定しなければいけません。具体的に言えば、<code
                class="literal">ca</code>、<code
                class="literal">cert</code>、<code
                class="literal">key</code>、<code
                class="literal">dh</code> パラメータを対応するファイルが設置されている場所に設定する必要があります (それぞれ、<code
                class="literal">/etc/ssl/certs/Falcot_CA.crt</code>、<code
                class="literal">/etc/ssl/vpn.falcot.com.crt</code>、<code
                class="literal">/etc/ssl/private/vpn.falcot.com.key</code>、<code
                class="literal">/etc/openvpn/dh2048.pem</code> に設定します)。<code
                class="literal">server 10.8.0.0 255.255.255.0</code> 指示文は VPN によって使われるサブネットを定義します。サーバにはこの範囲に含まれる最初の IP アドレス (<code
                class="literal">10.8.0.1</code>) が割り当てられ、クライアントには残りの IP アドレスが割り当てられます。
				</div><div
              class="para">
					この設定で OpenVPN を開始すると、通常 <code
                class="literal">tun0</code> という名前の仮想ネットワークインターフェースが作成されます。しかしながら、ファイアウォールは OpenVPN の開始前に実ネットワークインターフェースと同時に設定される場合が多いです。このため、永続的な仮想ネットワークインターフェースを作成し、OpenVPN が事前に作成された仮想インターフェースを使うように設定することを推奨します。この追加的設定により、インターフェースの名前を選ぶことが可能になります。この目的を達成するには、<code
                class="command">openvpn --mktun --dev vpn --dev-type tun</code> を使って <code
                class="literal">tun</code> 型の <code
                class="literal">vpn</code> と名付けられた仮想ネットワークインターフェースを作成します。さらに、このコマンドをファイアウォール設定スクリプトの中で使えば、簡単に設定を統合できます。つまり <code
                class="filename">/etc/network/interfaces</code> ファイルの <code
                class="literal">up</code> 指示文を使います。OpenVPN 設定ファイルをファイアウォール設定に対応させるためには <code
                class="literal">dev vpn</code> と <code
                class="literal">dev-type tun</code> 指示文を使います。
				</div><div
              class="para">
					これ以上の設定を追加しなければ、VPN クライアントは <code
                class="literal">10.8.0.1</code> アドレスの VPN サーバにアクセスできるだけです。クライアントをローカルネットワーク (192.168.0.0/24) へアクセスできる状態にするには、<code
                class="literal">push route 192.168.0.0 255.255.255.0</code> 指示文を OpenVPN 設定に追加します。こうすることで、VPN クライアントは自動的にネットワーク経路を取得し、VPN 経由でローカルネットワークに到達できるようになります。さらに、ローカルネットワークにいるマシンに対して VPN サーバに通じる VPN への経路を知らせる必要もあります (VPN サーバがゲートウェイにインストールされている場合、これは自動的に動きます)。別の方法として、VPN サーバが IP マスカレードを動かすように設定する方法があります。そうすれば、VPN クライアントからの接続はあたかもクライアントが VPN サーバからアクセスしたかのように見えます (<a
                class="xref"
                href="network-infrastructure.html#sect.gateway">第 10.1 節「ゲートウェイ」</a>を参照してください)。
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.13.5.7.8"></a>10.2.1.3. OpenVPN クライアントの設定</h4></div></div></div><div
              class="para">
					OpenVPN クライアントを設定する場合にも、<code
                class="filename">/etc/openvpn/</code> に設定ファイルを置きます。標準的な設定の良い足掛かりとして <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/client.conf</code> が用意されています。<code
                class="literal">remote vpn.falcot.com 1194</code> 指示文は OpenVPN サーバのアドレスとポート番号を表します。さらに <code
                class="literal">ca</code>、<code
                class="literal">cert</code>、<code
                class="literal">key</code> も鍵ファイルの場所に合わせて設定が必要です。
				</div><div
              class="para">
					起動時に VPN を自動的に開始したくない場合、<code
                class="filename">/etc/default/openvpn</code> ファイルの <code
                class="literal">AUTOSTART</code> 指示文に <code
                class="literal">none</code> を設定してください。VPN 接続の開始と停止は <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> start</code> と <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> stop</code> コマンドを使えばいつでも可能です (ここで、接続名 <em
                class="replaceable">name</em> は <code
                class="filename">/etc/openvpn/<em
                  class="replaceable">name</em>.conf</code> で定義したものにマッチします)。
				</div><div
              class="para">
					<span
                class="pkg pkg">network-manager-openvpn-gnome</span> パッケージには、NetworkManager (<a
                class="xref"
                href="sect.network-config.html#sect.roaming-network-config">第 8.2.4 節「ローミングユーザ向けの自動ネットワーク設定」</a>を参照してください) の拡張が含まれ、これを使うことで OpenVPN 仮想プライベートネットワークを管理することが可能です。誰もがグラフィカルに OpenVPN 接続を設定し、ネットワーク管理アイコンからこれを制御することが可能です。<a
                id="id-1.13.5.7.8.4.3"
                class="indexterm"></a>
				</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.ssh-vpn"></a>10.2.2. SSH を使った仮想プライベートネットワーク</h3></div></div></div><a
            id="id-1.13.5.8.2"
            class="indexterm"></a><a
            id="id-1.13.5.8.3"
            class="indexterm"></a><div
            class="para">
				SSH を使った仮想プライベートネットワークの作成法には、2 種類の方法があります。歴史的に見て重要な方法が SSH リンクの上で PPP レイヤを確立する方法です。この方法は HOWTO 文書で説明されています。<div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://www.tldp.org/HOWTO/ppp-ssh/">http://www.tldp.org/HOWTO/ppp-ssh/</a></div>
			</div><div
            class="para">
				2 番目の方法はより最近の方法で、OpenSSH 4.3 で導入されました。その結果今や、OpenSSH は SSH 接続のサーバおよびクライアント側に仮想ネットワークインターフェース (<code
              class="literal">tun*</code>) を作り、仮想インターフェースをあたかも物理インターフェースのように設定することが可能です。このトンネルシステムを有効化するにはまず、SSH サーバの設定ファイル (<code
              class="filename">/etc/ssh/sshd_config</code>) の中で <code
              class="literal">PermitTunnel</code> を「yes」に設定しなければいけません。SSH 接続を確立する際には、<code
              class="literal">-w any:any</code> オプションを使って明示的にトンネルの作成を要求しなければいけません (ここで <code
              class="literal">any</code> は必要な <code
              class="literal">tun</code> デバイス番号で置き替えます)。トンネルを作成するには、サーバおよびクライアント側でそのユーザが管理者権限を持っていることが必要です。そうすればネットワークデバイスを作成することが可能です (言い換えれば、接続は root で確立されなければいけません)。
			</div><div
            class="para">
				SSH を使って仮想プライベートネットワークを作成する方法は、どちらもかなり直接的なものです。しかしながら、SSH の提供する VPN は最も効率のよい方法ではありません。特に、高レベルのトラフィックをうまく取り扱うことができません。
			</div><div
            class="para">
				つまり、TCP/IP スタックが TCP/IP 接続 (SSH) の中にカプセル化される場合、TCP プロトコルは 2 回使われるという点です。1 回は SSH 接続で、もう 1 回がトンネル内です。TCP はタイムアウト遅延を変更することでネットワークの状態に接続状態を適合させる機能があるため、これは特に問題になります。以下のサイトがこの問題についてより詳しく説明しています。<div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://sites.inka.de/sites/bigred/devel/tcp-tcp.html">http://sites.inka.de/sites/bigred/devel/tcp-tcp.html</a></div>このため、VPN over SSH はパフォーマンスに制約のない単発のトンネルに留めるべきです。
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.ipsec"></a>10.2.3. IPsec</h3></div></div></div><a
            id="id-1.13.5.9.2"
            class="indexterm"></a><a
            id="id-1.13.5.9.3"
            class="indexterm"></a><a
            id="id-1.13.5.9.4"
            class="indexterm"></a><div
            class="para">
				IPsec は IP VPN の標準的ツールになりつつあるにも関わらず、IPsec の実装は複雑です。IPsec エンジンそれ自身は Linux カーネルに統合されています。ユーザ空間部分で必要となる制御と設定ツールは <span
              class="pkg pkg">ipsec-tools</span> パッケージに含まれています。具体的には、それぞれのホストの <code
              class="filename">/etc/ipsec-tools.conf</code> にはホストが接続する <span
              class="emphasis"><em>IPsec トンネル</em></span> (IPsec 用語で <span
              class="emphasis"><em>Security Association</em></span>) のパラメータが含まれます。<code
              class="command">/etc/init.d/setkey</code> スクリプトを使うことで、トンネルを開始したり停止することが可能です (それぞれのトンネルは仮想ネットワークに接続された他のホストと安全なリンクを確立しています)。このファイルは <span
              class="citerefentry"><span
                class="refentrytitle">setkey</span>(8)</span> マニュアルページに含まれる文書を使って手作業で作ることも可能です。しかしながら、多数のマシン群にすべてのホスト用のパラメータを明示的に書くことはすぐに難しい作業になります。なぜなら、トンネルの数はすぐに増えるからです。たとえば <span
              class="pkg pkg">racoon</span> や <span
              class="pkg pkg">strongswan</span> などの IKE (<span
              class="emphasis"><em>IPsec Key Exchange</em></span> の略語) デーモンをインストールすることで、一元管理による作業の簡素化と鍵の定期的な切り替えによる作業の安全化が可能になります。
			</div><a
            id="id-1.13.5.9.6"
            class="indexterm"></a><a
            id="id-1.13.5.9.7"
            class="indexterm"></a><a
            id="id-1.13.5.9.8"
            class="indexterm"></a><a
            id="id-1.13.5.9.9"
            class="indexterm"></a><div
            class="para">
				IPsec は標準規格という地位があるにも関わらず、その設定が複雑なことが原因で実際にはあまり使われていません。必要なトンネルが少なくて静的な場合は、OpenVPN に基づく解決策が通常好まれます。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CAUTION</em></span> IPsec と NAT</strong></p></div></div></div><div
              class="para">
				ファイアウォールの NAT は IPsec とうまく共存しません。なぜなら、IPsec はパケットを署名しますが、ファイアウォールがパケットを書き換えることで IPsec による署名は無効化され、無効な署名のパケットは受け取り側で拒否されるからです。今やさまざまな IPsec 実装が <span
                class="emphasis"><em>NAT-T</em></span> (<span
                class="emphasis"><em>NAT Traversal</em></span> の略語) 技術をサポートしています。これは基本的に IPsec パケットを標準的な UDP パケットにカプセル化するものです。
			</div><a
              id="id-1.13.5.9.11.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.11.4"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SECURITY</em></span> IPsec とファイアウォール</strong></p></div></div></div><div
              class="para">
				IPsec の動作の標準的モードは鍵交換に UDP ポート 500 番 (NAT-T を使用する場合 UDP ポート 4500 番) を使います。さらに、IPsec パケットは 2 種類の専用 IP プロトコルを使います。ファイアウォールはこのプロトコルを通過させなければいけません。さらに、これらのパケットの受け入れ可否はプロトコル番号 (ESP は 50 番、AH は 51 番) に基づきます。
			</div><a
              id="id-1.13.5.9.12.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.4"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.5"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.6"
              class="indexterm"></a></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.pptp"></a>10.2.4. PPTP</h3></div></div></div><div
            class="para">
				PPTP (<span
              class="emphasis"><em>Point-to-Point Tunneling Protocol</em></span> の略語) は 2 種類の通信チャンネルを使います。1 つは制御データ用で、もう 1 つがペイロードデータ用です。ペイロードデータ用チャンネルは GRE プロトコル (<span
              class="emphasis"><em>Generic Routing Encapsulation</em></span>) を使います。標準的な PPP リンクはペイロードデータ交換用チャンネル上に確立されます。
			</div><a
            id="id-1.13.5.10.3"
            class="indexterm"></a><a
            id="id-1.13.5.10.4"
            class="indexterm"></a><a
            id="id-1.13.5.10.5"
            class="indexterm"></a><a
            id="id-1.13.5.10.6"
            class="indexterm"></a><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.pptp-config-client"></a>10.2.4.1. クライアントの設定</h4></div></div></div><div
              class="para">
					<span
                class="pkg pkg">pptp-linux</span> パッケージには Linux 用に簡単に設定できる PPTP クライアントが含まれています。以下の説明は公式文書からヒントを得て作ったものです。<div
                xmlns=""
                class="url">→ <a
                  xmlns="http://www.w3.org/1999/xhtml"
                  href="http://pptpclient.sourceforge.net/howto-debian.phtml">http://pptpclient.sourceforge.net/howto-debian.phtml</a></div>
				</div><a
              id="id-1.13.5.10.7.3"
              class="indexterm"></a><div
              class="para">
					Falcot の管理者はいくつかのファイルを作成しました。すなわち <code
                class="filename">/etc/ppp/options.pptp</code>、<code
                class="filename">/etc/ppp/peers/falcot</code>、<code
                class="filename">/etc/ppp/ip-up.d/falcot</code>、<code
                class="filename">/etc/ppp/ip-down.d/falcot</code> を作成しました。
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-options.pptp"></a><p
                class="title"><strong>例 10.2 <code
                    class="filename">/etc/ppp/options.pptp</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# PPTP 接続時に利用する PPP オプション
lock
noauth
nobsdcomp
nodeflate</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-peers-falcot"></a><p
                class="title"><strong>例 10.3 <code
                    class="filename">/etc/ppp/peers/falcot</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# vpn.falcot.com は PPTP サーバです
pty "pptp vpn.falcot.com --nolaunchpppd"
# "vpn" ユーザで本人確認して接続します
user vpn
remotename pptp
# 暗号化を有効にします
require-mppe-128
file /etc/ppp/options.pptp
ipparam falcot</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-ip-up.d-falcot"></a><p
                class="title"><strong>例 10.4 <code
                    class="filename">/etc/ppp/ip-up.d/falcot</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Falcot ネットワークへの経路を作成します
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route add -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-ip-down.d-falcot"></a><p
                class="title"><strong>例 10.5 <code
                    class="filename">/etc/ppp/ip-down.d/falcot</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Falcot ネットワークへの経路を削除します
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route del -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> MPPE</strong></p></div></div></div><div
                class="para">
					PPTP を安全なものにするには MPPE 機能 (<span
                  class="emphasis"><em>Microsoft Point-to-Point Encryption</em></span>) を使います。MPPE はモジュールとして公式の Debian カーネルで利用できます。
				</div><a
                id="id-1.13.5.10.7.9.3"
                class="indexterm"></a><a
                id="id-1.13.5.10.7.9.4"
                class="indexterm"></a></div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.pptp-config-serveur"></a>10.2.4.2. サーバの設定</h4></div></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CAUTION</em></span> PPTP とファイアウォール</strong></p></div></div></div><div
                class="para">
					中間ファイアウォールはプロトコル 47 番 (GRE) を使っている IP パケットを通過させるように設定されなければいけません。さらに、通信チャンネルを開くために PPTP サーバのポート 1723 番を開けることが必要です。
				</div></div><div
              class="para">
					<code
                class="command">pptpd</code> は Linux 用の PPTP サーバです。主設定ファイル <code
                class="filename">/etc/pptpd.conf</code> にはいくつかの変更が必要です。すなわち <span
                class="emphasis"><em>localip</em></span> (ローカル IP アドレス) と <span
                class="emphasis"><em>remoteip</em></span> (リモート IP アドレス) を変更する必要があります。以下の例では、PPTP サーバは常に <code
                class="literal">192.168.0.199</code> アドレスを使い、PPTP クライアントは <code
                class="literal">192.168.0.200</code> から <code
                class="literal">192.168.0.250</code> までの IP アドレスを受け取ります。
				</div><div
              class="example"><a
                xmlns=""
                id="example.pptpd.conf"></a><p
                class="title"><strong>例 10.6 <code
                    class="filename">/etc/pptpd.conf</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# TAG: speed
#
#       PPTP デーモンの通信速度を指定します。
#
speed 115200

# TAG: option
#
#       PPP オプションファイルの場所を指定します。
#       PPP はデフォルトで '/etc/ppp/options' を使います
#
option /etc/ppp/pptpd-options

# TAG: debug
#
#       syslog に詳細なデバッグ情報を出力します
#
# debug

# TAG: localip
# TAG: remoteip
#
#       ローカルとリモートの IP アドレス範囲を指定します。
#
#       コンマで区切ることで、単独の IP アドレスおよび
#       IP アドレス範囲を指定できます。以下は利用例です。
#
#               192.168.0.234,192.168.0.245-249,192.168.0.254
#
#       以下の重要な制約事項に注意してください。
#
#       1. コンマ間およびアドレス内部で空白文字を使わないでください。
#
#       2. MAX_CONNECTIONS よりも多くの IP アドレス を指定した場合、
#          使われる IP アドレスはリストの先頭から MAX_CONNECTIONS
#          個までの IP アドレスです。それ以外は使われません。
#
#       3. アドレス範囲を略記しないでください! たとえば 234 から 238 の範囲を指定するために
#          234-8 と記述するのは間違いです。その代わり 234-238 と記述してください。
#
#       4. ローカル IP は 1 つだけでも構いません。この場合、すべてのローカル IP は
#          指定したものになります。しかしながら、同時接続中のクライアントには
#          必ず異なるリモート IP を割り振らなければいけません。
#
#localip 192.168.0.234-238,192.168.0.245
#remoteip 192.168.1.234-238,192.168.1.245
#localip 10.0.1.1
#remoteip 10.0.1.2-100
localip 192.168.0.199
remoteip 192.168.0.200-250</pre></div></div><div
              class="para">
					さらに <code
                class="filename">/etc/ppp/pptpd-options</code> を編集して、PPTP サーバの使う PPP 設定を変更します。重要なパラメータはサーバ名 (<code
                class="literal">pptp</code>)、ドメイン名 (<code
                class="literal">falcot.com</code>)、DNS と WINS サーバの IP アドレスです。
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-pptpd-options"></a><p
                class="title"><strong>例 10.7 <code
                    class="filename">/etc/ppp/pptpd-options</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
## pppd の syslog デバッグを有効化します
#debug

## 「サーバ名」を chap-secrets 内の自分のサーバ名として指定したものに変更します
name pptp
## ドメイン名をローカルドメインに変更します
domain falcot.com

## 以下は WinXXXX クライアントに対して
## 適当とされるデフォルトセキュリティ関連設定です
# Debian の pppd パッケージは MSCHAP と MPPE の両方をサポートしています。そのため
# ここでは両方を有効化しています。カーネルの MPPE サポートが必須という点にも注意してください!
auth
require-chap
require-mschap
require-mschap-v2
require-mppe-128

## サービスに対応するアドレスを指定してください
ms-dns 192.168.0.1
ms-wins 192.168.0.1

## ネットマスクを指定してください
netmask 255.255.255.0

## 一部のデフォルト設定
nodefaultroute
proxyarp
lock</pre></div></div><div
              class="para">
					最後に、<code
                class="literal">vpn</code> ユーザ (と対応するパスワード) を <code
                class="filename">/etc/ppp/chap-secrets</code> ファイルに登録します。サーバ名だけは、アスタリスク (<code
                class="literal">*</code>) を使える他のインスタンスと異なり、明示的に指定しなければいけません。さらに、Windows PPTP クライアントはユーザ名ではなく <code
                class="literal"><em
                  class="replaceable">DOMAIN</em>\\<em
                  class="replaceable">USER</em></code> という形を認証を行います。このため、<code
                class="filename">/etc/ppp/chap-secrets</code> ファイルに <code
                class="literal">FALCOT\\vpn</code> ユーザが追加されています。ユーザに割り当てる IP アドレスを明記することも可能です。IP アドレスフィールドのアスタリスクは動的にアドレスを割り当てることを意味します。
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-chap-secrets"></a><p
                class="title"><strong>例 10.8 <code
                    class="filename">/etc/ppp/chap-secrets</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# CHAP 認証用のログイン情報
# クライアント  サーバ  秘密情報    IP アドレス
vpn             pptp    f@Lc3au     *
FALCOT\\vpn     pptp    f@Lc3au     *</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> PPTP 脆弱性</strong></p></div></div></div><div
                class="para">
					Microsoft の最初の PPTP 実装は多くのセキュリティ脆弱性を残していたためにさまざまな非難を浴びました。しかし、最近のバージョンではその多くが修正されています。この節で説明されている設定は PPTP プロトコルの最新のバージョンを使っています。いくつかのオプション (<code
                  class="literal">require-mppe-128</code> や <code
                  class="literal">require-mschap-v2</code> など) を無効化すると、サービスに脆弱性が生まれるという点に注意してください。
				</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>戻る</strong>第 10 章 ネットワークインフラ</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上に戻る</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>ホーム</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>次へ</strong>10.3. Quality of Service</a></li></ul></body></html>
