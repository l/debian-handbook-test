<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">11.7. LDAP ディレクトリ</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-ja-JP-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP, SIP" /><link
        rel="home"
        href="index.html"
        title="Debian 管理者ハンドブック" /><link
        rel="up"
        href="network-services.html"
        title="第 11 章 ネットワークサービス、Postfix、Apache、NFS、Samba、Squid、LDAP、SIP、XMPP、TURN" /><link
        rel="prev"
        href="sect.http-ftp-proxy.html"
        title="11.6. HTTP/FTP プロキシ" /><link
        rel="next"
        href="sect.rtc-services.html"
        title="11.8. リアルタイムコミュニケーションサービス" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/ja-JP/stable/sect.ldap-directory.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.http-ftp-proxy.html"><strong>戻る</strong></a></li><li
          class="home">Debian 管理者ハンドブック</li><li
          class="next"><a
            accesskey="n"
            href="sect.rtc-services.html"><strong>次へ</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.ldap-directory"></a>11.7. LDAP ディレクトリ</h2></div></div></div><a
          id="id-1.14.10.2"
          class="indexterm"></a><a
          id="id-1.14.10.3"
          class="indexterm"></a><a
          id="id-1.14.10.4"
          class="indexterm"></a><div
          class="para">
			OpenLDAP は LDAP プロトコルの実装です。言い換えれば、OpenLDAP はディレクトリを保存するために設計された特製データベースです。OpenLDAP が最もよく使われる用途は、LDAP サーバを使ってユーザアカウントと関連するパーミッションの中央管理を行う場合です。さらに、LDAP データベースは簡単に複製できるので、複数の同期された LDAP サーバをセットアップすることが可能になります。ネットワークとユーザの数が急速に多くなった場合でも、複数のサーバ間で負荷のバランスをとることが可能です。
		</div><div
          class="para">
			LDAP データは階層的に構造化されています。LDAP データの構造は「スキーマ」によって定義され、スキーマはデータベースに保存できるオブジェクトの種類をその属性リストと一緒に説明するものです。データベース内の特定のオブジェクトを参照するために使われる構文はデータ構造に依存し、構文の複雑さはデータ構造の複雑さに対応します。
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.14.10.7"></a>11.7.1. インストール</h3></div></div></div><div
            class="para">
				OpenLDAP サーバは <span
              class="pkg pkg">slapd</span> パッケージに含まれます。LDAP サーバと情報をやり取りするためのコマンドラインツールは <span
              class="pkg pkg">ldap-utils</span> パッケージに含まれます。
			</div><a
            id="id-1.14.10.7.3"
            class="indexterm"></a><div
            class="para">
				通常 <span
              class="pkg pkg">slapd</span> のインストール時に質問される事項の数は少ないので、作られたデータベースは要求を満足するものにはならないでしょう。幸いなことに <code
              class="command">dpkg-reconfigure slapd</code> を使えば簡単に LDAP データベースをより詳細に再設定することが可能です。
			</div><div
            xmlns:d="http://docbook.org/ns/docbook"
            class="itemizedlist"><ul><li
                class="listitem"><div
                  class="para">
						OpenLDAP サーバの設定を省略しますか? LDAP サービスを設定するので当然「いいえ」を選びます。
					</div></li><li
                class="listitem"><div
                  class="para">
						DNS ドメイン名。「<code
                    class="literal">falcot.com</code>」と入力します。
					</div></li><li
                class="listitem"><div
                  class="para">
						組織名。「Falcot Corp」と入力します。
					</div></li><li
                class="listitem"><div
                  class="para">
						管理者のパスワードを入力します。
					</div></li><li
                class="listitem"><div
                  class="para">
						利用するデータベースバックエンド。「MDB」を選びます。
					</div></li><li
                class="listitem"><div
                  class="para">
						<span
                    class="pkg pkg">slapd</span> をパージした時にデータベースを削除しますか? 間違ってデータベースを失う危険性を増やすのは得策ではありませんから「いいえ」を選びます。
					</div></li><li
                class="listitem"><div
                  class="para">
						古いデータベースを移動しますか? この質問はデータベースが既に存在するにも関わらず設定を行おうとした場合に表示されます。たとえば最初のインストールの直後に <code
                    class="command">dpkg-reconfigure slapd</code> を実行する場合など、空っぽのデータベースから設定を再開したい場合、「はい」を選びます。
					</div></li><li
                class="listitem"><div
                  class="para">
						LDAPv2 プロトコルを許可しますか? 許可する意味がないので「いいえ」を選びます。本書で使うツールはすべて LDAPv3 プロトコルを理解します。
					</div></li></ul></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>BACK TO BASICS</em></span> LDIF フォーマット</strong></p></div></div></div><div
              class="para">
				LDIF ファイル (<span
                class="emphasis"><em>LDAP Data Interchange Format</em></span>) は移植可能なテキストファイルで、LDAP データベース (またはデータベースの一部) の内容を説明しています。LDIF ファイルを使って、他の LDAP サーバにデータを投入することが可能です。
			</div><a
              id="id-1.14.10.7.6.3"
              class="indexterm"></a></div><div
            class="para">
				以下の問い合わせによって実例を示す通り、最低限のデータベースが設定されています。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>ldapsearch -x -b dc=falcot,dc=com</code></strong>
<code
              class="computeroutput"># extended LDIF
#
# LDAPv3
# base &lt;dc=falcot,dc=com&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# falcot.com
dn: dc=falcot,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Falcot Corp
dc: falcot

# admin, falcot.com
dn: cn=admin,dc=falcot,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2
</code></pre><div
            class="para">
				この問い合わせの結果 2 種類のオブジェクトが返されました。具体的に言えば、組織自身と管理ユーザが返されました。
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.14.10.8"></a>11.7.2. ディレクトリへの書き込み</h3></div></div></div><div
            class="para">
				空っぽのデータベースは全く役に立たないので、すべての存在するディレクトリをデータベースに投入することにします。ここで存在するディレクトリとはユーザ、グループ、サービス、ホスト名データベースなどを指します。
			</div><div
            class="para">
				<span
              class="pkg pkg">migrationtools</span> パッケージには、標準的な Unix ディレクトリ (<code
              class="filename">/etc/passwd</code>、<code
              class="filename">/etc/group</code>、<code
              class="filename">/etc/services</code>、<code
              class="filename">/etc/hosts</code> など) からのデータを展開するための一連のスクリプトが含まれます。スクリプトを使ってデータを変換し、LDAP データベースに投入します。
			</div><a
            id="id-1.14.10.8.4"
            class="indexterm"></a><div
            class="para">
				<span
              class="pkg pkg">migrationtools</span> パッケージをインストールしたら、必ず <code
              class="filename">/etc/migrationtools/migrate_common.ph</code> を編集してください。つまり、<code
              class="varname">IGNORE_UID_BELOW</code> と <code
              class="varname">IGNORE_GID_BELOW</code> オプションを編集して (コメント解除するだけで十分です)、<code
              class="varname">DEFAULT_MAIL_DOMAIN</code> と <code
              class="varname">DEFAULT_BASE</code> を更新する必要があります。
			</div><div
            class="para">
				実際の移行操作は以下の通り <code
              class="command">migrate_all_online.sh</code> コマンドを使って行います。
			</div><pre
            class="screen">
<code
              class="computeroutput"># </code><strong
              class="userinput"><code>cd /usr/share/migrationtools</code></strong>
<code
              class="computeroutput"># </code><strong
              class="userinput"><code>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</code></strong></pre><div
            class="para">
				<code
              class="command">migrate_all_online.sh</code> から LDAP データベースに移行するデータの種類に関する数個の質問を尋ねられます。<a
              class="xref"
              href="sect.ldap-directory.html#tab-migrate-all">表 11.1</a> には Falcot の使用例で使った回答がまとめられています。
			</div><div
            class="table"><a
              xmlns=""
              id="tab-migrate-all"></a><p
              class="title"><strong>表 11.1 <code
                  class="command">migrate_all_online.sh</code> スクリプトからの質問に対する回答</strong></p><div
              class="table-contents"><table
                xmlns:d="http://docbook.org/ns/docbook"
                class="lt-4-cols lt-7-rows"
                summary="migrate_all_online.sh スクリプトからの質問に対する回答"><colgroup><col
                    align="justify" /><col
                    align="justify" /></colgroup><thead><tr><th
                      align="justify">質問</th><th
                      align="justify">回答</th></tr></thead><tbody><tr><td
                      align="justify">X.500 命名コンテキスト</td><td
                      align="justify"><code
                        class="literal">dc=falcot,dc=com</code></td></tr><tr><td
                      align="justify">LDAP サーバのホスト名</td><td
                      align="justify"><code
                        class="literal">localhost</code></td></tr><tr><td
                      align="justify">管理者の識別名</td><td
                      align="justify"><code
                        class="literal">cn=admin,dc=falcot,dc=com</code></td></tr><tr><td
                      align="justify">認証情報の紐付け</td><td
                      align="justify">LDAP データベース管理用パスワード</td></tr><tr><td
                      align="justify">DUAConfigProfile を作成</td><td
                      align="justify">no</td></tr></tbody></table></div></div><div
            class="para">
				上の例では <code
              class="literal">ETC_ALIASES=/dev/null</code> を指定することで意図的に <code
              class="filename">/etc/aliases</code> ファイルの移行を行いませんでした。なぜなら、Debian の提供する標準的なスキーマには、このスクリプトが電子メールアドレスを表現するために使う構造が含まれないからです。このデータをディレクトリに統合したい場合、標準的なスキーマに <code
              class="filename">/etc/ldap/schema/misc.schema</code> ファイルを追加するべきです。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>TOOL</em></span> LDAP ディレクトリの閲覧</strong></p></div></div></div><div
              class="para">
				<code
                class="command">jxplorer</code> コマンド (同名のパッケージに含まれます) は LDAP データベースを閲覧および編集することが可能なグラフィカルツールです。<code
                class="command">jxplorer</code> コマンドは興味深いツールで、このツールを使うことで管理者は LDAP データの階層構造をわかりやすく概観することが可能です。
			</div><a
              id="id-1.14.10.8.11.3"
              class="indexterm"></a></div><div
            class="para">
				<code
              class="command">ldapadd</code> コマンドの <code
              class="literal">-c</code> オプションの利用について触れておきます。このオプションはエラーが起きた場合に処理を停止しないように要求するものです。このオプションを使うことが必要です。なぜなら、<code
              class="filename">/etc/services</code> を変換する際に、無視しても問題ない数個のエラーが起きることが多いからです。
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.14.10.9"></a>11.7.3. LDAP を用いたアカウントの管理</h3></div></div></div><div
            class="para">
				これで LDAP データベースにいくつかの実用的な情報が含まれるようになりましたので、このデータを使うように設定します。この節では、さまざまなシステムディレクトリが LDAP データベースを使うように Linux システムを設定する方法に注目します。
			</div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.config-nss"></a>11.7.3.1. NSS の設定</h4></div></div></div><div
              class="para">
					NSS システム (Name Service Switch、補注<a
                class="xref"
                href="sect.user-group-databases.html#sidebar.intro-nss">「<span
                  class="emphasis"><em>GOING FURTHER</em></span> NSS とシステムデータベース」</a>を参照してください) はシステムディレクトリの情報を定義したり取得したりするために設計されたモジュール式システムです。NSS 用のデータ参照元として LDAP を使うには、<span
                class="pkg pkg">libnss-ldap</span> パッケージをインストールする必要があります。<span
                class="pkg pkg">libnss-ldap</span> パッケージのインストール中に数個の質問が行われます。ここで使った回答は<a
                class="xref"
                href="sect.ldap-directory.html#tab-libnss-ldap">表 11.2</a> にまとめられています。
				</div><a
              id="id-1.14.10.9.3.3"
              class="indexterm"></a><div
              class="table"><a
                xmlns=""
                id="tab-libnss-ldap"></a><p
                class="title"><strong>表 11.2 <span
                    class="pkg pkg">libnss-ldap</span> パッケージの設定</strong></p><div
                class="table-contents"><table
                  xmlns:d="http://docbook.org/ns/docbook"
                  class="lt-4-cols gt-7-rows"
                  summary="libnss-ldap パッケージの設定"><colgroup><col
                      align="justify" /><col
                      align="justify" /></colgroup><thead><tr><th
                        align="justify">質問</th><th
                        align="justify">回答</th></tr></thead><tbody><tr><td
                        align="justify">LDAP サーバの Uniform Resource Identifier</td><td
                        align="justify"><code
                          class="literal">ldap://ldap.falcot.com</code></td></tr><tr><td
                        align="justify">検索ベースの識別名</td><td
                        align="justify"><code
                          class="literal">dc=falcot,dc=com</code></td></tr><tr><td
                        align="justify">使用する LDAP バージョン</td><td
                        align="justify"><code
                          class="literal">3</code></td></tr><tr><td
                        align="justify">LDAP データベースはログインを必要としますか?</td><td
                        align="justify">no</td></tr><tr><td
                        align="justify">root への特別な LDAP 権限</td><td
                        align="justify">はい</td></tr><tr><td
                        align="justify">オーナのみ設定ファイルの読み書きができるようにしますか</td><td
                        align="justify">no</td></tr><tr><td
                        align="justify">LDAP 管理用アカウント</td><td
                        align="justify"><code
                          class="literal">cn=admin,dc=falcot,dc=com</code></td></tr><tr><td
                        align="justify">LDAP 管理用パスワード</td><td
                        align="justify">LDAP データベース管理用パスワード</td></tr></tbody></table></div></div><div
              class="para">
					そして、<code
                class="filename">/etc/nsswitch.conf</code> ファイルを変更し、最近インストールした <code
                class="command">ldap</code> モジュールを使うように NSS を設定する必要があります。
				</div><div
              class="example"><a
                xmlns=""
                id="id-1.14.10.9.3.6"></a><p
                class="title"><strong>例 11.26 <code
                    class="filename">/etc/nsswitch.conf</code> ファイル</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# /etc/nsswitch.conf
#
# 以下は GNU Name Service Switch 機能の設定例です。
# `glibc-doc' と `info' パッケージをインストール済みならば、
# `info libc "Name Service Switch"' で詳細情報を参照できます。

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files</pre></div></div><div
              class="para">
					通常 <code
                class="command">ldap</code> モジュールは他のモジュールよりも前に書き込みます。こうすることで、問い合わせの際に <code
                class="command">ldap</code> モジュールが優先して使われます。注目すべき除外例が <code
                class="literal">hosts</code> サービスです。なぜなら、LDAP サーバに接続するには (<code
                class="literal">ldap.falcot.com</code> の名前解決を行うためには) 先に DNS を調べる必要があるからです。<code
                class="literal">hosts</code> サービスで最初 <code
                class="command">ldap</code> モジュールを使うようにすると、LDAP サーバにホスト名を問い合わせることになります。しかし、名前解決を担当している LDAP サーバに接続するには LDAP サーバの名前解決が必要なので、無限ループすることになります。
				</div><div
              class="para">
					LDAP サーバからの応答を正式な回答として取り扱う場合 (そして特殊な状況が起きない限り <code
                class="command">files</code> モジュールの使うローカルファイルからの応答を無視する場合)、以下の構文を使ってサービスを設定します。
				</div><div
              class="para">
					<code
                class="literal"><em
                  class="replaceable">service</em>: ldap [NOTFOUND=return] files</code>.
				</div><div
              class="para">
					LDAP サービスを利用して問い合わせたエントリが LDAP データベースに存在しない場合、問い合わせに対する応答は「not existing」になるでしょう。これは問い合わせたエントリがローカルファイルに存在するか否かに依存しません。しかし LDAP サービスが利用できない場合に限り、ローカルファイルにエントリを問い合わせます。
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.config-pam"></a>11.7.3.2. PAM の設定</h4></div></div></div><div
              class="para">
					この節では、PAM 設定 (補注<a
                class="xref"
                href="basic-configuration.html#sidebar.intro-pam">「<span
                  class="emphasis"><em>BEHIND THE SCENES</em></span> <code
                  class="filename">/etc/environment</code> と <code
                  class="filename">/etc/default/locale</code>」</a>を参照してください) を説明します。ここで説明した PAM 設定を使うことで、アプリケーションは LDAP データベースに向けて認証を要求することが可能になります。
				</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CAUTION</em></span> 破壊された認証</strong></p></div></div></div><div
                class="para">
					さまざまなプログラムが使う標準的な PAM 設定の変更は慎重に行うべきです。1 つの間違いが認証を破壊し、ログインを不可能にする場合があります。このため root シェルを開いた状態を保ちながら作業を行うことが良い予防策です。こうしておけば、設定エラーが起きた場合、設定を修正して最小限の努力でサービスを再起動することが可能です。
				</div></div><div
              class="para">
					PAM 用の LDAP モジュールは <span
                class="pkg pkg">libpam-ldap</span> パッケージに含まれます。<span
                class="pkg pkg">libpam-ldap</span> パッケージをインストールする際に、<span
                class="pkg pkg">libnss-ldap</span> をインストールした際にされた質問と良く似た数個の質問を尋ねられます。いくつかの設定パラメータ (LDAP サーバの URI など) は <span
                class="pkg pkg">libnss-ldap</span> パッケージと共有されます。ここで使った回答は<a
                class="xref"
                href="sect.ldap-directory.html#tab-libpam-ldap">表 11.3</a> にまとめられています。
				</div><a
              id="id-1.14.10.9.4.5"
              class="indexterm"></a><div
              class="table"><a
                xmlns=""
                id="tab-libpam-ldap"></a><p
                class="title"><strong>表 11.3 <span
                    class="emphasis"><em>libpam-ldap</em></span> の設定</strong></p><div
                class="table-contents"><table
                  xmlns:d="http://docbook.org/ns/docbook"
                  class="lt-4-cols lt-7-rows"
                  summary="libpam-ldap の設定"><colgroup><col
                      align="justify" /><col
                      align="justify" /></colgroup><thead><tr><th
                        align="justify">質問</th><th
                        align="justify">回答</th></tr></thead><tbody><tr><td
                        align="justify">LDAP 管理アカウントがローカルの root のように振る舞うことを許しますか?</td><td
                        align="justify">はい。こうすることで、通常の <code
                          class="command">passwd</code> コマンドから LDAP データベースに保存されているパスワードを変更することが可能になります。</td></tr><tr><td
                        align="justify">LDAP データベースはログインを必要としますか?</td><td
                        align="justify">no</td></tr><tr><td
                        align="justify">LDAP 管理用アカウント</td><td
                        align="justify"><code
                          class="literal">cn=admin,dc=falcot,dc=com</code></td></tr><tr><td
                        align="justify">LDAP 管理用パスワード</td><td
                        align="justify">LDAP 管理用パスワード</td></tr><tr><td
                        align="justify">パスワードに使うローカル暗号化アルゴリズム</td><td
                        align="justify">crypt</td></tr></tbody></table></div></div><div
              class="para">
					<span
                class="pkg pkg">libpam-ldap</span> をインストールすると自動的に <code
                class="filename">/etc/pam.d/common-auth</code>、<code
                class="filename">/etc/pam.d/common-password</code>、<code
                class="filename">/etc/pam.d/common-account</code> ファイルで定義されたデフォルトの PAM 設定が適用されます。このメカニズムは専用の <code
                class="command">pam-auth-update</code> ツール (<span
                class="pkg pkg">libpam-runtime</span> パッケージから提供される) を使います。<code
                class="command">pam-auth-update</code> ツールは PAM モジュールを有効化または無効化したい管理者によって実行される場合もあります。
				</div><a
              id="id-1.14.10.9.4.8"
              class="indexterm"></a><a
              id="id-1.14.10.9.4.9"
              class="indexterm"></a><a
              id="id-1.14.10.9.4.10"
              class="indexterm"></a><a
              id="id-1.14.10.9.4.11"
              class="indexterm"></a><a
              id="id-1.14.10.9.4.12"
              class="indexterm"></a><a
              id="id-1.14.10.9.4.13"
              class="indexterm"></a></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.14.10.9.5"></a>11.7.3.3. 安全な LDAP データ交換</h4></div></div></div><a
              id="id-1.14.10.9.5.2"
              class="indexterm"></a><div
              class="para">
					デフォルトで、LDAP プロトコルはネットワークを平文で通信します。従って、(暗号化された) パスワードがネットワーク上をそのまま流れます。暗号化されたパスワードをネットワークから抽出することが可能ですから、パスワードは辞書型攻撃に弱いということになります。暗号化層を追加することで、このような危険性を避けることが可能です。この節のテーマは暗号化層を有効化することです。
				</div><div
              class="section"><div
                class="titlepage"><div><div><h5
                      class="title"><a
                        xmlns=""
                        id="id-1.14.10.9.5.4"></a>11.7.3.3.1. サーバの設定</h5></div></div></div><a
                id="id-1.14.10.9.5.4.2"
                class="indexterm"></a><a
                id="id-1.14.10.9.5.4.3"
                class="indexterm"></a><div
                class="para">
						最初に LDAP サーバ用の (公開鍵と秘密鍵から成る) 鍵ペアを作成します。Falcot の管理者は鍵ペアを生成するために <span
                  class="emphasis"><em>easy-rsa</em></span> を再利用します (<a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">第 10.2.1.1 節「公開鍵基盤、<span
                    class="emphasis"><em>easy-rsa</em></span>」</a>を参照してください)。<code
                  class="command">./build-key-server ldap.falcot.com</code> を実行すると、数個の一般的な (場所、組織名などに関する) 質問を尋ねられます。「Common Name」に対する回答は<span
                  class="emphasis"><em>必ず</em></span> LDAP サーバの完全修飾ホスト名にしてください。今回の場合 <code
                  class="literal">ldap.falcot.com</code> にしてください。
					</div><div
                class="para">
						<code
                  class="command">./build-key-server ldap.falcot.com</code> は証明書を作成し、<code
                  class="filename">keys/ldap.falcot.com.crt</code> ファイルに保存します。さらに対応する秘密鍵は <code
                  class="filename">keys/ldap.falcot.com.key</code> に保存されます。
					</div><div
                class="para">
						さらに、これらの鍵を標準的な場所にインストールし、<code
                  class="literal">openldap</code> ユーザ権限で実行されている LDAP サーバが秘密鍵を読み込み可能であることを保証しなければいけません。これを行うために以下の通り実行します。
					</div><pre
                class="screen"><code
                  class="computeroutput"># </code><strong
                  class="userinput"><code>adduser openldap ssl-cert
</code></strong><code
                  class="computeroutput">ユーザ `openldap' をグループ `ssl-cert' に追加しています...
ユーザ openldap をグループ ssl-cert に追加
完了。
# </code><strong
                  class="userinput"><code>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
</code></strong><code
                  class="computeroutput"># </code><strong
                  class="userinput"><code>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key
</code></strong><code
                  class="computeroutput"># </code><strong
                  class="userinput"><code>chmod 0640 /etc/ssl/private/ldap.falcot.com.key
</code></strong><code
                  class="computeroutput"># </code><strong
                  class="userinput"><code>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem
</code></strong></pre><div
                class="para">
						<code
                  class="command">slapd</code> デーモンにこれらの鍵を暗号化に使うように伝えることも必要です。LDAP サーバの設定は動的に管理されます。つまり、設定は <code
                  class="literal">cn=config</code> オブジェクト階層に対する通常の LDAP 操作によって更新され、サーバは設定を永続的なものにするために <code
                  class="filename">/etc/ldap/slapd.d</code> をリアルタイムで更新します。このため、設定を更新するには <code
                  class="command">ldapmodify</code> ツールを使ってください。
					</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.10.9.5.4.9"></a><p
                  class="title"><strong>例 11.27 暗号化用の <code
                      class="command">slapd</code> の設定</strong></p><div
                  class="example-contents"><pre
                    class="screen"><code
                      class="computeroutput"># </code><strong
                      class="userinput"><code>cat &gt;ssl.ldif &lt;&lt;END
dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key
-
END
</code></strong><code
                      class="computeroutput"># </code><strong
                      class="userinput"><code>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif
</code></strong><code
                      class="computeroutput">SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
</code></pre></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>TOOL</em></span> <code
                            class="command">ldapvi</code> で LDAP ディレクトリを編集する</strong></p></div></div></div><a
                  id="id-1.14.10.9.5.4.10.2"
                  class="indexterm"></a><div
                  class="para">
						<code
                    class="command">ldapvi</code> を使うことで、LDAP ディレクトリの任意の部分に対する LDIF 出力を表示したり、テキストエディタでそれを変更したり、対応する LDAP 操作を実行したりすることが可能です。
					</div><div
                  class="para">
						このため、LDAP サーバの設定を更新するには <code
                    class="command">ldapvi</code> を使って <code
                    class="literal">cn=config</code> 階層を編集する方法が便利です。
					</div><pre
                  class="screen"><code
                    class="computeroutput"># </code><strong
                    class="userinput"><code>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config
</code></strong></pre></div><div
                class="para">
						暗号化を有効化するための最後の作業が <code
                  class="filename">/etc/default/slapd</code> ファイル内の <code
                  class="varname">SLAPD_SERVICES</code> 変数を変更することです。ここでは慎重を期して、安全対策されていない LDAP を無効化しています。
					</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.10.9.5.4.12"></a><p
                  class="title"><strong>例 11.28 <code
                      class="filename">/etc/default/slapd</code> ファイル</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# slapd.conf ファイルまたは slapd.d cn=config ディレクトリの
# デフォルト位置を指定してください。空の場合、コンパイル時のデフォルト値
# (/etc/ldap/slapd.d およびその代替の /etc/ldap/slapd.conf) が使われます。
SLAPD_CONF=

# slapd サーバを実行するシステムアカウントを指定してください。
# 空の場合、root 権限で実行します。
SLAPD_USER="openldap"

# slapd サーバを実行するシステムグループを指定してください。
# 空の場合、SLAPD_USER のメイングループ権限で実行します。
SLAPD_GROUP="openldap"

# slapd サーバの pid ファイルのパスを指定してください。未指定の場合、
# init.d スクリプトは $SLAPD_CONF (デフォルト値は /etc/ldap/slapd.conf
# です) を評価してパスを指定しようとします。
SLAPD_PIDFILE=

# 通常 slapd は TCP ポート 389 番だけにサービスを提供します。
# さらに slapd は TCP ポート 636 番 (ldaps) および unix ソケット
# にもサービスを提供できます。
# 以下はその使用例です。
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# SLAPD_NO_START を設定した場合、init スクリプトは
# slapd を開始および再開しません (停止だけは実行されます)。
# 別の手段で slapd を実行している場合や、通常はマシンの起動時に
# slapd を開始したくない場合、以下の行を有効化してください。
#SLAPD_NO_START=1

# SLAPD_SENTINEL_FILE がファイルへのパスに設定され、設定されたファイル
# が存在する場合、init スクリプトは slapd を開始および再開しません
# (停止だけは実行されます)。設定ファイルを編集したくない場合
# (たとえば、メンテナンス中または設定管理システムの使用中などの場合)、
# ここで指定したファイルを使って一時的に slapd の開始を無効化します。
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# slapd は (SASL を介した) Kerberos 認証の際にデフォルトでシステムの
# keytab ファイル (/etc/krb5.keytab) を使います。別の keytab ファイルを
# 使うには、以下の行でそのファイルを指定し、以下の行を有効化してください。
#export KRB5_KTNAME=/etc/krb5.keytab

# 以下では slapd に渡す追加の引数を指定します。
SLAPD_OPTIONS=""</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h5
                      class="title"><a
                        xmlns=""
                        id="id-1.14.10.9.5.5"></a>11.7.3.3.2. クライアントの設定</h5></div></div></div><div
                class="para">
						クライアント側では <span
                  class="emphasis"><em>libpam-ldap</em></span> と <span
                  class="emphasis"><em>libnss-ldap</em></span> モジュールの設定を修正し、<code
                  class="literal">ldaps://</code> URI を使うように設定する作業が必要です。
					</div><div
                class="para">
						LDAP クライアントはサーバから認証を受ける必要があります。X.509 公開鍵基盤において、公開証明書は認証局 (CA) の鍵で署名されます。<span
                  class="emphasis"><em>easy-rsa</em></span> を使うことで、Falcot の管理者は自分自身の CA を作成しました。さらに管理者は Falcot の CA の署名を信頼するようにシステムを設定する必要があります。これを行うには、CA 証明書を <code
                  class="filename">/usr/local/share/ca-certificates</code> に配置して <code
                  class="command">update-ca-certificates</code> を実行します。
					</div><pre
                class="screen"><code
                  class="computeroutput"># </code><strong
                  class="userinput"><code>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt
</code></strong><code
                  class="computeroutput"># </code><strong
                  class="userinput"><code>update-ca-certificates
</code></strong><code
                  class="computeroutput">Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
Adding debian:falcot.pem
done.
done.
</code></pre><div
                class="para">
						最後に重要なことですが、さまざまなコマンドラインツールで使われるデフォルトの LDAP URI とデフォルトのベース識別名は <code
                  class="filename">/etc/ldap/ldap.conf</code> を編集すれば変更することが可能です。こうすることで、入力する量を激減させることが可能です。
					</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.10.9.5.5.6"></a><p
                  class="title"><strong>例 11.29 <code
                      class="filename">/etc/ldap/ldap.conf</code> ファイル</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">#
# LDAP のデフォルト設定
#

# 詳細は ldap.conf(5) を参照してください。全ユーザに対して
# このファイルの読み込みを許可し、書き込みを禁止してください。

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# TLS 証明書 (これは GnuTLS を使う場合に必要です)
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt</pre></div></div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.http-ftp-proxy.html"><strong>戻る</strong>11.6. HTTP/FTP プロキシ</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上に戻る</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>ホーム</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.rtc-services.html"><strong>次へ</strong>11.8. リアルタイムコミュニケーションサービス</a></li></ul></body></html>
