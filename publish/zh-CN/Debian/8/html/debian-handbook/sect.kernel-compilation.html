<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">8.10. 编译核心</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-zh-CN-1.0-1" /><meta
        name="keywords"
        content="配置, 本地化, 地区设置, 网络, 名称解析, 用户, 用户组, 账户, 命令行解释器, Shell, 打印, Bootloader, 内核编译" /><link
        rel="home"
        href="index.html"
        title="Debian 管理员手册" /><link
        rel="up"
        href="basic-configuration.html"
        title="第 8 章 基础配置：网络，账户，打印……" /><link
        rel="prev"
        href="sect.config-misc.html"
        title="8.9. 其他配置：时间同步、记录、共享近用…" /><link
        rel="next"
        href="sect.kernel-installation.html"
        title="8.11. 安装内核" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/zh-CN/stable/sect.kernel-compilation.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.config-misc.html"><strong>上一页</strong></a></li><li
          class="home">Debian 管理员手册</li><li
          class="next"><a
            accesskey="n"
            href="sect.kernel-installation.html"><strong>下一页</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.kernel-compilation"></a>8.10. 编译核心</h2></div></div></div><a
          id="id-1.11.14.2"
          class="indexterm"></a><a
          id="id-1.11.14.3"
          class="indexterm"></a><div
          class="para">
			Debian 的核心尽量纳入所有的功能，以及最多的驱动程序，以便涵盖现在的硬件配置。所以，有些用户宁愿自行编译祗包括所需的核心。这么做有两个理由。第一，内存用量较小，核心代码，即使未用到，也占有内存的空间 (而且永远不 “离开” 置换内存，因为它用到实际的 RAM)，降低系统的整体性能。在地自行编译的核心也限制了安全问题的范围，因为祗编译与运行部份核心码。
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>说明</em></span> 安全更新</strong></p></div></div></div><div
            class="para">
			决定编译自己的核心后，必须接受一个事实：Debian 不能确认客制化核心的安全更新。使用 Debian 的核心，可以使用 Debian 计划提供的更新。
		</div></div><div
          class="para">
			使用祗在补丁内的功能 (不在标准的核心内) 时，就必须重新编译核心。
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>进一步</em></span> The Debian Kernel Handbook</strong></p></div></div></div><a
            id="id-1.11.14.7.2"
            class="indexterm"></a><div
            class="para">
			Debian 核心团队维护的 “Debian Kernel Handbook” (全文见 <span
              class="pkg pkg">debian-kernel-handbook</span> 套件) 详述核心相关的工作与 Debian 核心套件的处理方式。欲知可节所述事宜的详情，请参见此网址。<div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://kernel-handbook.alioth.debian.org">http://kernel-handbook.alioth.debian.org</a></div>
		</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-compilation-prerequisites"></a>8.10.1. 简介和先决条件</h3></div></div></div><div
            class="para">
				Debian 以套件方式管理核心，与传统的编译安装不同调。核心还是在套件系统的控制下，可以被完整移除，或布建在多个机器上。与该等套件有关的脚本自动与启动程序和 initrd 产生器交互。
			</div><div
            class="para">
				上游的 Linux 源代码包括建置 Debian 核心套件所需的一切。但是仍可再安装 <span
              class="pkg pkg">build-essential</span> 以确保拥有创建 Debian 套件所需的所有工具。而且，配置核心时需要 <span
              class="pkg pkg">libncurses5-dev</span> 套件。最后，<span
              class="pkg pkg">fakeroot</span> 套件将在不使用管理者权限的前提下，启用添加 Debian 套件。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>文化</em></span> <span
                        class="pkg pkg">kernel-package</span> 的美好岁月</strong></p></div></div></div><a
              id="id-1.11.14.8.4.2"
              class="indexterm"></a><div
              class="para">
				以 Linux 布建系统能够创建适当的 Debian 套件前，使用 <code
                class="command">make-kpkg</code>，来自 <span
                class="pkg pkg">kernel-package</span> 套件。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-sources"></a>8.10.2. 获取源代码</h3></div></div></div><a
            id="id-1.11.14.9.2"
            class="indexterm"></a><a
            id="id-1.11.14.9.3"
            class="indexterm"></a><a
            id="id-1.11.14.9.4"
            class="indexterm"></a><div
            class="para">
				就像 Debian 系统内其他有用的东西，Linux 核心源代码也位在套件内。祗要安装 <span
              class="pkg pkg">linux-source-<em
                class="replaceable">version</em></span> 套件，就能取得全部的源代码。<code
              class="command">apt-cache search ^linux-source</code> 命令行出 Debian 内各种版本的核心套件。最新的版本在 <span
              class="distribution distribution">Unstable</span> 发行版内：可以毫不费力的取得 (尤其是把 APT 根据 <a
              class="xref"
              href="sect.apt-get.html#sect.apt-mix-distros">第 6.2.6 节 “在多个发行版工作”</a> 的指示配置后)。这些套件内的源代码并未完全吻合 Linus Torvalds 与其他核心发展者发布的内容；如同其他的发行版，Debian 以一系列的补丁搭配，这些补丁可能 (或不可能) 以自己的方法纳入 Linux 上游的版本。包括从较新核心版本的 fixes/features/drivers 反向移殖，功能较新但尚未 (全部) 合并入上游的Linux 树，甚至 Debian 特别的改变。
			</div><div
            class="para">
				本节其他内容以 Linux 核心 3.16 版为准，范例则不以此为限，可以调整为特定的核心版本。
			</div><div
            class="para">
				假设 <span
              class="pkg pkg">linux-source-3.16</span> 套件已安装好了。包括 <code
              class="filename">/usr/src/linux-source-3.16.tar.xz</code>，核心源代码的压缩档。在另个文件夹解缩 (不能直接在 <code
              class="filename">/usr/src/</code> 之下，因为不需特别的授权就可以重新编译 Linux 核心)：<code
              class="filename">~/kernel/</code> 是个不错的选择。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>mkdir ~/kernel; cd ~/kernel</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>tar -xaf /usr/src/linux-source-3.16.tar.xz</code></strong></pre><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>文化</em></span> 核心源代码的位置</strong></p></div></div></div><div
              class="para">
				传统上，Linux 核心源代码置于 <code
                class="filename">/usr/src/linux/</code>，需要根权限才能编译。然而，管理者的权限就够了。<code
                class="literal">src</code> 群组的成员也可以使用该文件夹，但是应避免使用 <code
                class="filename">/usr/src/</code>。把核心源代码置于个人文件夹时，应把安全置于第一位：在 <code
                class="filename">/usr/</code> 内的文件都应明确其在套件系统内的作用，试图聚集使用核心的信息时，不能在读取 <code
                class="filename">/usr/src/linux</code> 时误导程序。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.config-kernel"></a>8.10.3. 配置核心</h3></div></div></div><a
            id="id-1.11.14.10.2"
            class="indexterm"></a><a
            id="id-1.11.14.10.3"
            class="indexterm"></a><a
            id="id-1.11.14.10.4"
            class="indexterm"></a><div
            class="para">
				下个步骤是根据需要配置核心。确切的进程视需要而订。
			</div><div
            class="para">
				重新编译较新版本的核心 (可能连同其补丁) 时，应尽量采用 Debian 建议的配置。在此情况下，与其从最基本开始重新编译，不妨复制 <code
              class="filename">/boot/config-<em
                class="replaceable">version</em></code> 文件 (核心正在使用的版本，可以 <code
              class="command">uname -r</code> 命令查看) 进入核心原始所在文件夹内的 <code
              class="filename">.config</code> 文件。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cp /boot/config-3.16.0-4-amd64 ~/kernel/linux-source-3.16/.config</code></strong></pre><div
            class="para">
				需要改变配置的话，就跳至 <a
              class="xref"
              href="sect.kernel-compilation.html#sect.kernel-build">第 8.10.4 节 “编译与创建套件”</a>。或者从基本开始重新配置，就需花时间配置核心。在核心源代码的文件夹内有很多专属接口，供调用 <code
              class="command">make <em
                class="replaceable">target</em></code> 命令，让 <em
              class="replaceable">target</em> 是下列的其中一个值。
			</div><div
            class="para">
				<code
              class="command">make menuconfig</code> 编译并运行文本模式接口 (即 <span
              class="pkg pkg">libncurses5-dev</span> 套件必备) 以阶层结构浏览可用的选项。按 <span
              class="keycap"><strong>空格</strong></span> 键改变选定的值，并按屏幕下方的 <span
              class="keycap"><strong>Enter</strong></span> 钮；<span
              class="guibutton"><strong>Select</strong></span> 送回选定的次菜单；<span
              class="guibutton"><strong>Exit</strong></span> 关闭当前的屏幕并回到上个阶层；<span
              class="guibutton"><strong>Help</strong></span> 显示选项的详细信息。箭头键在选项及按钮清单内动。按主菜单的 <span
              class="guibutton"><strong>Exit</strong></span> 钮，就可离开配置程序。此程序可保存改变的配置；接受改变后的配置。
			</div><div
            class="para">
				其他的接口也有类似的功能，但在现代化的图形接口运作；诸如 <code
              class="command">make xconfig</code> 使用 Qt 图形接口，而 <code
              class="command">make gconfig</code> 使手 GTK+。前者用到 <span
              class="pkg pkg">libqt4-dev</span>，后者依赖 <span
              class="pkg pkg">libglade2-dev</span> 与 <span
              class="pkg pkg">libgtk2.0-dev</span>。
			</div><div
            class="para">
				使用这些配置接口时，建议从合理的缺省配置开始。提供该等配置的核心在 <code
              class="filename">arch/<em
                class="replaceable">arch</em>/configs/*_defconfig</code>，然后可将选定的配置置于像 <code
              class="command">make x86_64_defconfig</code> (64 位电脑) 或 <code
              class="command">make i386_defconfig</code> (32 位电脑) 这样的命令。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>秘诀</em></span> 处理过时的 <code
                        class="filename">.config</code> 文件</strong></p></div></div></div><div
              class="para">
				使用其他 (通常是较旧的) 核心版本的 <code
                class="filename">.config</code> 文件时，需要先更新它。可以使用 <code
                class="command">make oldconfig</code> 命令，以交互方式询问对新配置的选择。可以用 <code
                class="command">make olddefconfig</code> 命令使用问题缺省的答案。以 <code
                class="command">make oldnoconfig</code> 命令，可以对问题提供缺省的负面答案。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-build"></a>8.10.4. 编译与创建套件</h3></div></div></div><a
            id="id-1.11.14.11.2"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>说明</em></span> 创建前先清除</strong></p></div></div></div><div
              class="para">
				若已在文件夹内编译过，希望从基础重新创建 (或许更换核心配置)，需运行 <code
                class="command">make clean</code> 命令移除已编译的文件。<code
                class="command">make distclean</code> 命令可移除更多的文件，包括客制的 <code
                class="filename">.config</code> 文件，别忘了先备份。
			</div></div><div
            class="para">
				核心配置完成后，<code
              class="command">make deb-pkg</code> 命令可产生至多 5 个 Debian 套件：<span
              class="pkg pkg">linux-image-<em
                class="replaceable">version</em></span> 包括核心映像与相关的模块，<span
              class="pkg pkg">linux-headers-<em
                class="replaceable">version</em></span> 包括创建外部模块所需的头文件，<span
              class="pkg pkg">linux-firmware-image-<em
                class="replaceable">version</em></span> 包括某些驱动程序所需的固件 (由 Debian 提供的核心源文件创建时，可能没有该套件)，<span
              class="pkg pkg">linux-image-<em
                class="replaceable">version</em>-dbg</span> 包括供套件映像及其模块的调试符号，以及<span
              class="pkg pkg">linux-libc-dev</span> 包括 GNU glibc 之类与用户程序库相关的标头。
			</div><div
            class="para">
				<em
              class="replaceable">version</em> 由并列的上游版本决定 (如同变量 <code
              class="literal">VERSION</code>、<code
              class="literal">PATCHLEVEL</code>、<code
              class="literal">SUBLEVEL</code> 与 <code
              class="literal">EXTRAVERSION</code> 在 <code
              class="filename">Makefile</code> 内所定)、并列的 <code
              class="literal">LOCALVERSION</code> 配置参数、以及并列的 <code
              class="literal">LOCALVERSION</code> 环境变量。套件版本使用同版本字符串以及添加的附加版本 (并保存在 <code
              class="filename">.version</code>)，除非以 <code
              class="literal">KDEB_PKGVERSION</code> 环境变量覆写它们。
			</div><pre
            class="screen"><code
              class="computeroutput">$ </code><strong
              class="userinput"><code>make deb-pkg LOCALVERSION=-falcot KDEB_PKGVERSION=$(make kernelversion)-1
</code></strong><code
              class="computeroutput">[...]
$ </code><strong
              class="userinput"><code>ls ../*.deb
</code></strong><code
              class="computeroutput">../linux-headers-3.16.7-ckt4-falcot_3.16.7-1_amd64.deb
../linux-image-3.16.7-ckt4-falcot_3.16.7-1_amd64.deb
../linux-image-3.16.7-ckt4-falcot-dbg_3.16.7-1_amd64.deb
../linux-libc-dev_3.16.7-1_amd64.deb
</code></pre></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.modules-build"></a>8.10.5. 编译外部模块</h3></div></div></div><a
            id="id-1.11.14.12.2"
            class="indexterm"></a><a
            id="id-1.11.14.12.3"
            class="indexterm"></a><a
            id="id-1.11.14.12.4"
            class="indexterm"></a><div
            class="para">
				部份模块由 Linux 官方核心之外维护。使用时，必须与匹配的核心一起编译。若干常见的第三方模块由 Debian 指定套件提供，诸如 <span
              class="pkg pkg">xtables-addons-source</span> (iptables 的外部模块) 或 <span
              class="pkg pkg">oss4-source</span> (Open Sound System，某些额外的音效驱动程序)。
			</div><div
            class="para">
				这些外部套件极多且杂，在此无法全部枚举；<code
              class="command">apt-cache search source$</code> 命令可缩小搜索的范围。然而，完整的清单没什么用处，只有明确知道需要时，才会编译特定的外部模块。在这个情况下，设备的文档会详述 Linux 环境所需的模块。
			</div><div
            class="para">
				以 <span
              class="pkg pkg">xtables-addons-source</span> 套件为例：安装之后，模块源文件 <code
              class="filename">.tar.bz2</code> 保存在 <code
              class="filename">/usr/src/</code>。可以手动解开该压缩档并创建模块，也可用 DKMS 自动做它。大部份模块提供必要的 DKMS 以 <code
              class="literal">-dkms</code> 后置文本集成入套件。在本例中，安装 <span
              class="pkg pkg">xtables-addons-dkms</span> 就是为当前核心编译核心模块，前提是有匹配已安装核心的 <span
              class="pkg pkg">linux-headers-*</span> 套件。例如，使用 <span
              class="pkg pkg">linux-image-amd64</span>，则应同时安装 <span
              class="pkg pkg">linux-headers-amd64</span>。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>sudo apt install xtables-addons-dkms</code></strong>
<code
              class="computeroutput">
[...]
Setting up xtables-addons-dkms (2.6-1) ...
Loading new xtables-addons-2.6 DKMS files...
First Installation: checking all kernels...
Building only for 3.16.0-4-amd64
Building initial module for 3.16.0-4-amd64
Done.

xt_ACCOUNT:
Running module version sanity check.
 - Original module
   - No original module exists within this kernel
 - Installation
   - Installing to /lib/modules/3.16.0-4-amd64/updates/dkms/
[...]
DKMS: install completed.
$ </code><strong
              class="userinput"><code>sudo dkms status</code></strong>
<code
              class="computeroutput">xtables-addons, 2.6, 3.16.0-4-amd64, x86_64: installed
$ </code><strong
              class="userinput"><code>sudo modinfo xt_ACCOUNT</code></strong>
<code
              class="computeroutput">filename:       /lib/modules/3.16.0-4-amd64/updates/dkms/xt_ACCOUNT.ko
license:        GPL
alias:          ipt_ACCOUNT
author:         Intra2net AG &lt;opensource@intra2net.com&gt;
description:    Xtables: per-IP accounting for large prefixes
[...]
</code></pre><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>其他</em></span> module-assistant</strong></p></div></div></div><a
              id="id-1.11.14.12.9.2"
              class="indexterm"></a><div
              class="para">
				DKMS 出现以前，<span
                class="pkg pkg">module-assistant</span> 是创建与布署核心模块的最简单解决方案。目前还能用，特别是缺少 DKMS 集成的情况：以 <code
                class="command">module-assistant auto-install xtables-addons</code> (或较短的 <code
                class="command">m-a a-i xtables-addons</code>) 命令，就能编译出给当前核心使用的模𦈡，置于新的 Debian 套件，让该套件可以即时安装。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-patch"></a>8.10.6. 选择内核补丁</h3></div></div></div><a
            id="id-1.11.14.13.2"
            class="indexterm"></a><a
            id="id-1.11.14.13.3"
            class="indexterm"></a><div
            class="para">
				因为不够成熟或核心维护者意见不一致，很多功能未列入标准的核心。这种功能就以补丁的型式发行，任何人都可以自由地把它维入核心源代码。
			</div><div
            class="para">
				Debian 以 <span
              class="pkg pkg">linux-patch-*</span> 或 <span
              class="pkg pkg">kernel-patch-*</span> 方式散布这些套件 (例如，<span
              class="pkg pkg">linux-patch-grsecurity2</span>，可以紧缩核心的安全政策)。这些套件安装的文件在 <code
              class="filename">/usr/src/kernel-patches/</code> 文件夹内。
			</div><div
            class="para">
				在源文件文件夹内，以 <code
              class="command">patch</code> 命令编译核心，就能够纳入前述安装的补丁。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cd ~/kernel/linux-source-3.16</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>make clean</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>zcat /usr/src/kernel-patches/diffs/grsecurity2/grsecurity-3.0-3.17.1-201410250027.patch.gz | patch -p1</code></strong></pre><div
            class="para">
				有些补丁不见得适用于每个核心版本；以 <code
              class="command">patch</code> 可能无法应用于核心源代码。将出现错误消息且提示错误的原因；在此情况下，参照 Debian 补丁套件的文档 (位于 <code
              class="filename">/usr/share/doc/linux-patch-*/</code> 文件夹)。大部份的情况下，维护者会指出其补丁适用的核心版本。
			</div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.config-misc.html"><strong>上一页</strong>8.9. 其他配置：时间同步、记录、共享近用…</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一级</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始页</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.kernel-installation.html"><strong>下一页</strong>8.11. 安装内核</a></li></ul></body></html>
