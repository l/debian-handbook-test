<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">9.11. 熱插拔：hotplug</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-zh-TW-1.0-1" /><meta
        name="keywords"
        content="系統啟動, 初始化腳本, SSH, Telnet, 權力, 權限, 監督, Inetd, Cron, 備份, 熱插拔, PCMCIA, APM, ACPI" /><link
        rel="home"
        href="index.html"
        title="The Debian Administrator's Handbook" /><link
        rel="up"
        href="unix-services.html"
        title="章 9. Unix 服務" /><link
        rel="prev"
        href="sect.backup.html"
        title="9.10. 備份" /><link
        rel="next"
        href="sect.power-management.html"
        title="9.12. 電源管理：進階組態與電源介面 (ACPI)" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/zh-TW/stable/sect.hotplug.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.backup.html"><strong>前一頁</strong></a></li><li
          class="home">The Debian Administrator's Handbook</li><li
          class="next"><a
            accesskey="n"
            href="sect.power-management.html"><strong>下一頁</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.hotplug"></a>9.11. 熱插拔：<span
                  class="emphasis"><em>hotplug</em></span></h2></div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.14.2"></a>9.11.1. 介绍</h3></div></div></div><div
            class="para">
				<span
              class="emphasis"><em>hotplug</em></span> 次系統核心，以動態方式載入適當的驅動程且 (在 <code
              class="command">udevd</code> 的協助下)新增對應的設備檔案，處理加入與移除設備的作業。當代的硬體與虛擬化，幾乎每個物件都是熱插拔：從常見的 USB/PCMCIA/IEEE 1394 週邊到 SATA 硬碟，以及 CPU 與記憶體。
			</div><div
            class="para">
				核心內的資料庫有每個設備的 ID 及其驅動程式。在啟動階段載入此資料庫，偵測各接口的週邊設備，並在運行中偵測熱插入的設備。接收到插入的設備後，送出訊息給 <code
              class="command">udevd</code>，讓其新增對應的條目於 <code
              class="filename">/dev/</code> 內。
			</div><a
            id="id-1.12.14.2.4"
            class="indexterm"></a><a
            id="id-1.12.14.2.5"
            class="indexterm"></a><a
            id="id-1.12.14.2.6"
            class="indexterm"></a><a
            id="id-1.12.14.2.7"
            class="indexterm"></a><a
            id="id-1.12.14.2.8"
            class="indexterm"></a><a
            id="id-1.12.14.2.9"
            class="indexterm"></a></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.14.3"></a>9.11.2. 命名問題</h3></div></div></div><div
            class="para">
				熱插拔技術出現前，很容易為設備指定名稱。根據設備所在的位置命名即可。就是設備所在的接口。但每個接口都能連結設備後，這件事就有點麻煩。以數位相機與 USB 碟為例，對電腦而言，它們都是磁碟機。數位相機可能是 <code
              class="filename">/dev/sdb</code> 而 USB 碟可能是 <code
              class="filename">/dev/sdc</code> (<code
              class="filename">/dev/sda</code> 代表電腦本身的硬式磁碟)。設備名稱不固定；依其連結的順序而命名。
			</div><div
            class="para">
				此外，愈來愈多的驅動程式，以動態值指定設備的主要/次要編號，不可能再把固定款目指定給固定的設備，因為重新開機後，一切都變了。
			</div><div
            class="para">
				<span
              class="emphasis"><em>udev</em></span> 用以解決此問題。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>實踐</em></span> 網路卡管理</strong></p></div></div></div><div
              class="para">
				當代的電腦有多張網路卡 (兩張網路卡加一個 wifi 介面)，以及在多個接口支援 <span
                class="emphasis"><em>熱插拔</em></span>，Linux 核心不保證給這些網路介面固定的名稱。不過，使用者卻需要在組態 <code
                class="filename">/etc/network/interfaces</code> 時，需用到固定的名稱！
			</div><div
              class="para">
				很難要求每個使用者建立自己的 <span
                class="emphasis"><em>udev</em></span> 規則處理此問題。所以讓 <span
                class="emphasis"><em>udev</em></span> 以古怪的態度組態以面對它；第一次啟動時 (以及，出現新的網卡時)，以網路介面的名稱及 MAC 位址新增一個規則，在後續啟動時再指定同樣的名稱。此規則儲存在 <code
                class="filename">/etc/udev/rules.d/70-persistent-net.rules</code>。
			</div><div
              class="para">
				此機制有個副作用值得注意。祗有一個 PCI 網卡的電腦。自然把網路介面命名為 <code
                class="literal">eth0</code>。然後，網卡壞了，換個新的；新網卡的 MAC 位址當然不同。舊網卡已有名稱，<code
                class="literal">eth0</code>，新網卡被命名為 <code
                class="literal">eth1</code>，實際上，<code
                class="literal">eth0</code> 網卡已經不會再回來了 (且網路不會運作如常，因為 <code
                class="filename">/etc/network/interfaces</code> 組態一個 <code
                class="literal">eth0</code> 介面)。在此情況下，重新開機前先刪除 <code
                class="filename">/etc/udev/rules.d/70-persistent-net.rules</code> 檔案。新的網卡就會取得 <code
                class="literal">eth0</code> 名稱。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.14.4"></a>9.11.3. <span
                    class="emphasis"><em>udev</em></span> 的運作</h3></div></div></div><div
            class="para">
				當 <span
              class="emphasis"><em>udev</em></span> 被核心告知有個新的設備，它參考 <code
              class="filename">/sys/</code> 裡對應的款目，搜集該設備的資訊，尤其是那些足辨別的獨特資訊 (網卡的 MAC 位址、某些 USB 設備的序號)。
			</div><div
            class="para">
				有了這些資訊後，<span
              class="emphasis"><em>udev</em></span> 會查閱 <code
              class="filename">/etc/udev/rules.d/</code> 和 <code
              class="filename">/lib/udev/rules.d/</code> 中所有的規則。在此過程中，決定如何為設備命名、使用的連結符號 (給個其他名稱)，以及執行的命令。查詢所有檔案後，依序評估該等規則 (除了使用 “GOTO”指令的文件)。如此一來，一個事件就可能對應多個規則。
			</div><div
            class="para">
				規則檔案的語法很簡單；每列有選擇規矩與指定變數。前者用於選擇回應的事件，後者設定採取的行動。都以逗點區隔，以運算元區隔選定的範圍 (使用比較運算元，如 <code
              class="literal">==</code> 或 <code
              class="literal">!=</code>) 或指定變數 (使用 <code
              class="literal">=</code>、<code
              class="literal">+=</code> 或 <code
              class="literal">:=</code> 運算元)。
			</div><div
            class="para">
				依下列變數使用比較運算元：
			</div><div
            xmlns:d="http://docbook.org/ns/docbook"
            class="itemizedlist"><ul><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">KERNEL</code>：核心指定給設備的名稱；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">ACTION</code>：對應於事件的行動 (“add” 新增設備時，“remove” 移除設備時)；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">DEVPATH</code>：設備在 <code
                    class="filename">/sys/</code> 裡的路徑；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">SUBSYSTEM</code>：產生請求的核心次系統 (很多這類次系統，包括“usb”、“ide”、“net”、“firmware”等)；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">ATTR{<em
                      class="replaceable">屬性</em>}</code>：<em
                    class="replaceable">屬性</em> 檔案的內容在設備的 <code
                    class="filename">/sys/<em
                      class="replaceable">$devpath</em>/</code> 資料夾內。可在此找到 MAC 位址及其他辨識用的匯流排；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">KERNELS</code>、<code
                    class="literal">SUBSYSTEMS</code> 與 <code
                    class="literal">ATTRS{<em
                      class="replaceable">屬性</em>}</code> 係用於比較當前設備的選項變數；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">PROGRAM</code>：被測試的程式 (若為真，則送回 0)。程式的內容儲存在標準輸出以便被 <code
                    class="literal">RESULT</code> 測試使用；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">RESULT</code>：對最後一次呼叫的 <code
                    class="literal">PROGRAM</code> 產生的標準輸入進行測試。
					</div></li></ul></div><div
            class="para">
				右方的運算元可供模式表達同時匹配的多個值。例如，<code
              class="literal">*</code> 表示匹配所有的字元 (包括空字元)；<code
              class="literal">?</code> 表示匹配一個字元，而 <code
              class="literal">[]</code> 表示匹配一組在方括號內的字元 (或若首字元為驚嘆號則做反義的表巧，以 <code
              class="literal">a-z</code> 表示連續的字元)。
			</div><div
            class="para">
				對於指定的運算元，<code
              class="literal">=</code> 指定一個值 (並取代現在的值)；用在清單時，清空原來的值祗剩指定的值。<code
              class="literal">:=</code> 功能相同，且不允許再更改原變數。至於 <code
              class="literal">+=</code>，新增一個項目在清單內。可以更改以下的變數：
			</div><div
            xmlns:d="http://docbook.org/ns/docbook"
            class="itemizedlist"><ul><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">NAME</code>：在 <code
                    class="filename">/dev/</code> 新增設備名稱。祗計算第一次的名稱；忽略其他的；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">SYMLINK</code>：指向同一設備的符號清單；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">OWNER</code>、<code
                    class="literal">GROUP</code> 和 <code
                    class="literal">MODE</code> 擁有設備的使用者及群組，及其他權限；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">RUN</code>：回應此事件的執行程式清單。
					</div></li></ul></div><div
            class="para">
				指定給這些變數的值可以使用以下的替代品：
			</div><div
            xmlns:d="http://docbook.org/ns/docbook"
            class="itemizedlist"><ul><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">$kernel</code> 或 <code
                    class="literal">%k</code>：相當於 <code
                    class="literal">KERNEL</code>；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">$number</code> 或 <code
                    class="literal">%n</code>：設備的序號，例如，<code
                    class="literal">sda3</code>，就是 “3”；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">$devpath</code> 或 <code
                    class="literal">%p</code>：相當於 <code
                    class="literal">DEVPATH</code>；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">$attr{<em
                      class="replaceable">屬性</em>}</code> 或 <code
                    class="literal">%s{<em
                      class="replaceable">屬性</em>}</code>：相當於 <code
                    class="literal">ATTRS{<em
                      class="replaceable">屬性</em>}</code>；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">$major</code> 或 <code
                    class="literal">%M</code>：設備的核心主要編號；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">$minor</code> 或 <code
                    class="literal">%m</code>：設備核心的次要編號；
					</div></li><li
                class="listitem"><div
                  class="para">
						<code
                    class="literal">$result</code> 或 <code
                    class="literal">%c</code>：以 <code
                    class="literal">PROGRAM</code> 最後執行程式的輸出字串；
					</div></li><li
                class="listitem"><div
                  class="para">
						最後，<code
                    class="literal">%%</code> 和 <code
                    class="literal">$$</code> 分別是百分號及錢號。
					</div></li></ul></div><div
            class="para">
				以上的清單仍不完備 (祗包括最重要的參數)，詳細的資料在 <span
              class="citerefentry"><span
                class="refentrytitle">udev</span>(7)</span> 手冊頁面。
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.14.5"></a>9.11.4. 具體的例子</h3></div></div></div><div
            class="para">
				考慮給予 USB 隨身碟一個固定名稱的情況。首先，必須找到能夠識別的元素。因此，插入它並執行 <code
              class="command">udevadm info -a -n /dev/sdc</code> (以指定給該隨身碟的實際名稱取代 <em
              class="replaceable">/dev/sdc</em>)。
			</div><pre
            class="screen"><code
              class="computeroutput"># </code><strong
              class="userinput"><code>udevadm info -a -n /dev/sdc</code></strong>
<code
              class="computeroutput">[...]
  looking at device '/devices/pci0000:00/0000:00:10.3/usb1/1-2/1-2.2/1-2.2:1.0/host9/target9:0:0/9:0:0:0/block/sdc':
    KERNEL=="sdc"
    SUBSYSTEM=="block"
    DRIVER==""
    ATTR{range}=="16"
    ATTR{ext_range}=="256"
    ATTR{removable}=="1"
    ATTR{ro}=="0"
    ATTR{size}=="126976"
    ATTR{alignment_offset}=="0"
    ATTR{capability}=="53"
    ATTR{stat}=="      51      100     1208      256        0        0        0        0        0      192      25        6"
    ATTR{inflight}=="       0        0"
[...]
  looking at parent device '/devices/pci0000:00/0000:00:10.3/usb1/1-2/1-2.2/1-2.2:1.0/host9/target9:0:0/9:0:0:0':
    KERNELS=="9:0:0:0"
    SUBSYSTEMS=="scsi"
    DRIVERS=="sd"
    ATTRS{device_blocked}=="0"
    ATTRS{type}=="0"
    ATTRS{scsi_level}=="3"
    ATTRS{vendor}=="I0MEGA  "
    ATTRS{model}=="UMni64MB*IOM2C4 "
    ATTRS{rev}=="    "
    ATTRS{state}=="running"
[...]
    ATTRS{max_sectors}=="240"
[...]
  looking at parent device '/devices/pci0000:00/0000:00:10.3/usb1/1-2/1-2.2':
    KERNELS=="9:0:0:0"
    SUBSYSTEMS=="usb"
    DRIVERS=="usb"
    ATTRS{configuration}=="iCfg"
    ATTRS{bNumInterfaces}==" 1"
    ATTRS{bConfigurationValue}=="1"
    ATTRS{bmAttributes}=="80"
    ATTRS{bMaxPower}=="100mA"
    ATTRS{urbnum}=="398"
    ATTRS{idVendor}=="4146"
    ATTRS{idProduct}=="4146"
    ATTRS{bcdDevice}=="0100"
[...]
    ATTRS{manufacturer}=="USB Disk"
    ATTRS{product}=="USB Mass Storage Device"
    ATTRS{serial}=="M004021000001"
[...]
</code></pre><div
            class="para">
				依照檢測設備變數，以及父設備的變數，新增規則。以上的例子可以新增兩個規則：
			</div><pre
            class="programlisting">KERNEL=="sd?", SUBSYSTEM=="block", ATTRS{serial}=="M004021000001", SYMLINK+="usb_key/disk"
KERNEL=="sd?[0-9]", SUBSYSTEM=="block", ATTRS{serial}=="M004021000001", SYMLINK+="usb_key/part%n"</pre><div
            class="para">
				在文件中設定這些規則後，例如把它命名為 <code
              class="filename">/etc/udev/rules.d/010_local.rules</code>，就可以移除和再連結 USB 隨身碟。可看到 <code
              class="filename">/dev/usb_key/disk</code> 代表與 USB 隨身碟連結的磁碟，<code
              class="filename">/dev/usb_key/part1</code> 是其第一個分區。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>進階</em></span> 除錯 <span
                        class="emphasis"><em>udev</em></span> 的組態</strong></p></div></div></div><div
              class="para">
				如同其他的後台進程，<code
                class="command">udevd</code> 把日誌儲存在 <code
                class="filename">/var/log/daemon.log</code>。但是預設是不囉唆的，且不足以瞭解發生的事。<code
                class="command">udevadm control --log-priority=info</code> 命令增加其詳細的內容並可解決此問題。<code
                class="command">udevadm control --log-priority=err</code> 則回到預設的層次。
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.backup.html"><strong>前一頁</strong>9.10. 備份</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一層</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始頁</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.power-management.html"><strong>下一頁</strong>9.12. 電源管理：進階組態與電源介面 (ACPI)</a></li></ul></body></html>
