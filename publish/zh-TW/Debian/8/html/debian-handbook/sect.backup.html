<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">9.10. 備份</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-zh-TW-1.0-1" /><meta
        name="keywords"
        content="系統啟動, 初始化腳本, SSH, Telnet, 權力, 權限, 監督, Inetd, Cron, 備份, 熱插拔, PCMCIA, APM, ACPI" /><link
        rel="home"
        href="index.html"
        title="The Debian Administrator's Handbook" /><link
        rel="up"
        href="unix-services.html"
        title="章 9. Unix 服務" /><link
        rel="prev"
        href="sect.quotas.html"
        title="9.9. 配額" /><link
        rel="next"
        href="sect.hotplug.html"
        title="9.11. Hot Plugging: hotplug" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/zh-TW/stable/sect.backup.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>前一頁</strong></a></li><li
          class="home">The Debian Administrator's Handbook</li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>下一頁</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.backup"></a>9.10. 備份</h2></div></div></div><div
          class="para">
			備份是管理員的主要責任之一，它是個複雜的主題，涉及難以掌握的強大工具。
		</div><a
          id="id-1.12.13.3"
          class="indexterm"></a><a
          id="id-1.12.13.4"
          class="indexterm"></a><div
          class="para">
			很多程式係供備份之用，如 <code
            class="command">amanda</code>、<code
            class="command">bacula</code>、<code
            class="command">BackupPC</code>。主從架構程式有很多選項，其組態相當困難。部份有親和力強的網頁介面減輕其負擔。但 Debian 還有十多種備份軟體可用，以 <code
            class="command">apt-cache search backup</code> 命令可搜尋它們。
		</div><a
          id="id-1.12.13.6"
          class="indexterm"></a><a
          id="id-1.12.13.7"
          class="indexterm"></a><a
          id="id-1.12.13.8"
          class="indexterm"></a><div
          class="para">
			與其逐一介紹它們，本章將經由 Falcot 公司管理者的角度，設定備份的策略。
		</div><div
          class="para">
			Falcot 公司的備份有兩個目標：無誤地復原被刪除的檔案，以及快速地復原硬碟毀損的電腦 (伺服器或桌面)。
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.11"></a>9.10.1. 使用 <code
                    class="command">rsync</code> 備份</h3></div></div></div><div
            class="para">
				以磁帶備份太慢且太貴，現在採用備份在專屬伺服器的硬碟策略，以 RAID (見 <a
              class="xref"
              href="advanced-administration.html#sect.raid-soft">節 12.1.1, “軟 RAID”</a>) 軟體保護資料在硬碟毀損時不致遺失。桌面電腦沒有個別備份的策略，使用者應在部份的檔案伺服器備份其資料。<code
              class="command">rsync</code> 命令 (取自同名的套件) 用於逐日備份這些伺服器。
			</div><a
            id="id-1.12.13.11.3"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>回到基礎</em></span> 硬連結，檔案的第二個名稱</strong></p></div></div></div><a
              id="id-1.12.13.11.4.2"
              class="indexterm"></a><a
              id="id-1.12.13.11.4.3"
              class="indexterm"></a><div
              class="para">
				相對於符號連結，硬連結不能自外於被連結檔案。新增的硬連結等於給檔案另個名稱。刪除硬連結等於刪除該檔案的另個名稱。祗要還有另個名稱指定給檔案，則資料仍在檔案系統內。不同於複製，硬連結並未在硬碟裡複製另個空間。
			</div><div
              class="para">
				以 <code
                class="command">ln <em
                  class="replaceable">target</em> <em
                  class="replaceable">link</em></code> 命令新增硬連結。<em
                class="replaceable">link</em> 檔案是 <em
                class="replaceable">target</em> 檔案的新名稱。硬連結祗能應用於同個檔案系統，符號連結則不受此限。
			</div></div><div
            class="para">
				受限於可用的硬碟空間，無法執行完整的逐日備份。所以，<code
              class="command">rsync</code> 命令優先於以硬連結複製內容，避免使用太多的硬碟空間。<code
              class="command">rsync</code> 祗處理上次備份後，再被修改的檔案。以這個機制可使用較小的空間備份。因為所有的備份已經立即可得與可用 (例如，在同個網路的不同資料夾共享)，可快速地比對兩個指定日期。
			</div><a
            id="id-1.12.13.11.6"
            class="indexterm"></a><a
            id="id-1.12.13.11.7"
            class="indexterm"></a><a
            id="id-1.12.13.11.8"
            class="indexterm"></a><div
            class="para">
				這種備份機制可以輕易地經由 <code
              class="command">dirvish</code> 程式執行。使用備份的儲存空間 (“空” 的)，放置含時間戳記的備份檔案 (在 dirvish 文件中，這些檔案被稱為 “vaults”)。
			</div><div
            class="para">
				主要的組態在 <code
              class="filename">/etc/dirvish/master.conf</code> 檔案內。設定備份儲存空間的位置，管理 “vaults” 清單，以及備份到期的預設值。其他的組態位在 <code
              class="filename"><em
                class="replaceable">bank</em>/<em
                class="replaceable">vault</em>/dirvish/default.conf</code> 檔案內，包括對應檔案集的特殊組態。
			</div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-master"></a><p
              class="title"><strong>範例 9.3. <code
                  class="filename">/etc/dirvish/master.conf</code> 檔案</strong></p><div
              class="example-contents"><pre
                class="programlisting">bank:
    /backup
exclude:
    lost+found/
    core
    *~
Runall:
    root    22:00
expire-default: +15 days
expire-rule:
#   MIN HR    DOM MON       DOW  STRFTIME_FMT
    *   *     *   *         1    +3 months
    *   *     1-7 *         1    +1 year
    *   *     1-7 1,4,7,10  1</pre></div></div><div
            class="para">
				The <code
              class="literal">bank</code> setting indicates the directory in which the backups are stored. The <code
              class="literal">exclude</code> setting allows you to indicate files (or file types) to exclude from the backup. The <code
              class="literal">Runall</code> is a list of file sets to backup with a time-stamp for each set, which allows you to assign the correct date to the copy, in case the backup is not triggered at precisely the assigned time. You have to indicate a time just before the actual execution time (which is, by default, 10:04 pm in Debian, according to <code
              class="filename">/etc/cron.d/dirvish</code>). Finally, the <code
              class="literal">expire-default</code> and <code
              class="literal">expire-rule</code> settings define the expiration policy for backups. The above example keeps forever backups that are generated on the first Sunday of each quarter, deletes after one year those from the first Sunday of each month, and after 3 months those from other Sundays. Other daily backups are kept for 15 days. The order of the rules does matter, Dirvish uses the last matching rule, or the <code
              class="literal">expire-default</code> one if no other <code
              class="literal">expire-rule</code> matches.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>IN PRACTICE</em></span> Scheduled expiration</strong></p></div></div></div><div
              class="para">
				The expiration rules are not used by <code
                class="command">dirvish-expire</code> to do its job. In reality, the expiration rules are applied when creating a new backup copy to define the expiration date associated with that copy. <code
                class="command">dirvish-expire</code> simply peruses the stored copies and deletes those for which the expiration date has passed.
			</div></div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-vault"></a><p
              class="title"><strong>範例 9.4. The <code
                  class="filename">/backup/root/dirvish/default.conf</code> file</strong></p><div
              class="example-contents"><pre
                class="programlisting">client: rivendell.falcot.com
tree: /
xdev: 1
index: gzip
image-default: %Y%m%d
exclude:
    /var/cache/apt/archives/*.deb
    /var/cache/man/**
    /tmp/**
    /var/tmp/**
    *.bak
</pre></div></div><div
            class="para">
				The above example specifies the set of files to back up: these are files on the machine <span
              class="emphasis"><em>rivendell.falcot.com</em></span> (for local data backup, simply specify the name of the local machine as indicated by <code
              class="command">hostname</code>), especially those in the root tree (<code
              class="literal">tree: /</code>), except those listed in <code
              class="literal">exclude</code>. The backup will be limited to the contents of one filesystem (<code
              class="literal">xdev: 1</code>). It will not include files from other mount points. An index of saved files will be generated (<code
              class="literal">index: gzip</code>), and the image will be named according to the current date (<code
              class="literal">image-default: %Y%m%d</code>).
			</div><div
            class="para">
				There are many options available, all documented in the <span
              class="citerefentry"><span
                class="refentrytitle">dirvish.conf</span>(5)</span> manual page. Once these configuration files are setup, you have to initialize each file set with the <code
              class="command">dirvish --vault <em
                class="replaceable">vault</em> --init</code> command. From there on the daily invocation of <code
              class="command">dirvish-runall</code> will automatically create a new backup copy just after having deleted those that expired.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>IN PRACTICE</em></span> Remote backup over SSH</strong></p></div></div></div><div
              class="para">
				When dirvish needs to save data to a remote machine, it will use <code
                class="command">ssh</code> to connect to it, and will start <code
                class="command">rsync</code> as a server. This requires the root user to be able to automatically connect to it. The use of an SSH authentication key allows precisely that (see <a
                class="xref"
                href="sect.remote-login.html#sect.ssh-key-based-auth">節 9.2.1.1, “金鑰認證”</a>).
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.12"></a>9.10.2. Restoring Machines without Backups</h3></div></div></div><div
            class="para">
				Desktop computers, which are not backed up, will be easy to reinstall from custom DVD-ROMs prepared with <span
              class="emphasis"><em>Simple-CDD</em></span> (see <a
              class="xref"
              href="sect.automated-installation.html#sect.simple-cdd">節 12.3.3, “Simple-CDD: The All-In-One Solution”</a>). Since this performs an installation from scratch, it loses any customization that can have been made after the initial installation. This is fine since the systems are all hooked to a central LDAP directory for accounts and most desktop applications are preconfigured thanks to dconf (see <a
              class="xref"
              href="sect.graphical-desktops.html#sect.gnome-desktop">節 13.3.1, “GNOME”</a> for more information about this).
			</div><div
            class="para">
				The Falcot Corp administrators are aware of the limits in their backup policy. Since they can't protect the backup server as well as a tape in a fireproof safe, they have installed it in a separate room so that a disaster such as a fire in the server room won't destroy backups along with everything else. Furthermore, they do an incremental backup on DVD-ROM once per week — only files that have been modified since the last backup are included.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>GOING FURTHER</em></span> Backing up SQL and LDAP services</strong></p></div></div></div><div
              class="para">
				Many services (such as SQL or LDAP databases) cannot be backed up by simply copying their files (unless they are properly interrupted during creation of the backups, which is frequently problematic, since they are intended to be available at all times). As such, it is necessary to use an “export” mechanism to create a “data dump” that can be safely backed up. These are often quite large, but they compress well. To reduce the storage space required, you will only store a complete text file per week, and a <code
                class="command">diff</code> each day, which is created with a command of the type <code
                class="command">diff <em
                  class="replaceable">file_from_yesterday</em> <em
                  class="replaceable">file_from_today</em></code>. The <code
                class="command">xdelta</code> program produces incremental differences from binary dumps.
			</div><a
              id="id-1.12.13.12.4.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.4"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.5"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CULTURE</em></span> <span
                        class="emphasis"><em>TAR</em></span>, the standard for tape backups</strong></p></div></div></div><a
              id="id-1.12.13.12.5.2"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.4"
              class="indexterm"></a><div
              class="para">
				Historically, the simplest means of making a backup on Unix was to store a <span
                class="emphasis"><em>TAR</em></span> archive on a tape. The <code
                class="command">tar</code> command even got its name from “Tape ARchive”.
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>前一頁</strong>9.9. 配額</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一層</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始頁</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>下一頁</strong>9.11. Hot Plugging: hotplug</a></li></ul></body></html>
