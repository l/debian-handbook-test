<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">8.10. 編譯核心</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-9-zh-TW-1.0-1" /><meta
        name="keywords"
        content="組態, 在地化, 地區設定, 網路, 名稱解析, 使用者, 群組, 帳號, 命令列解析器, Shell, 列印, 啟動程式, 編譯核心" /><link
        rel="home"
        href="index.html"
        title="Debian管理者手冊" /><link
        rel="up"
        href="basic-configuration.html"
        title="章 8. 基本組態：網路、帳號、列印..." /><link
        rel="prev"
        href="sect.config-misc.html"
        title="8.9. 其他組態：時間同步、記錄、共享近用…" /><link
        rel="next"
        href="sect.kernel-installation.html"
        title="8.11. 安裝核心" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/zh-TW/stable/sect.kernel-compilation.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.config-misc.html"><strong>前一頁</strong></a></li><li
          class="home">Debian管理者手冊</li><li
          class="next"><a
            accesskey="n"
            href="sect.kernel-installation.html"><strong>下一頁</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.kernel-compilation"></a>8.10. 編譯核心</h2></div></div></div><a
          id="id-1.11.14.2"
          class="indexterm"></a><a
          id="id-1.11.14.3"
          class="indexterm"></a><div
          class="para">
			Debian 的核心儘量納入所有的功能，以及最多的驅動程式，以便涵蓋現在的硬體組態。所以，有些使用者寧願自行編譯祗包括所需的核心。這麼做有兩個理由。第一，記憶體用量較小，核心程式碼，即使未用到，也佔有記憶體的空間 (而且永遠不 “離開” 置換記憶體，因為它用到實際的 RAM)，降低系統的整體效能。在地自行編譯的核心也限制了安全問題的範圍，因為祗編譯與執行部份核心碼。
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>說明</em></span> 安全更新</strong></p></div></div></div><div
            class="para">
			決定編譯自己的核心後，必須接受一個事實：Debian 不能確認客製化核心的安全更新。使用 Debian 的核心，可以使用 Debian 計畫提供的更新。
		</div></div><div
          class="para">
			使用祗在補丁內的功能 (不在標準的核心內) 時，就必須重新編譯核心。
		</div><div
          class="sidebar"><div
            class="titlepage"><div><div><p
                  class="title"><strong><span
                      class="emphasis"><em>進一步</em></span> The Debian Kernel Handbook</strong></p></div></div></div><a
            id="id-1.11.14.7.2"
            class="indexterm"></a><div
            class="para">
			Debian 核心團隊維護的 “Debian Kernel Handbook” (全文見 <span
              class="pkg pkg">debian-kernel-handbook</span> 套件) 詳述核心相關的工作與 Debian 核心套件的處理方式。欲知可節所述事宜的詳情，請參見此網址。<div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://kernel-handbook.alioth.debian.org">http://kernel-handbook.alioth.debian.org</a></div>
		</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-compilation-prerequisites"></a>8.10.1. 簡介和先決條件</h3></div></div></div><div
            class="para">
				Debian 以套件方式管理核心，與傳統的編譯安裝不同調。核心還是在套件系統的控制下，可以被完整移除，或布建在多個機器上。與該等套件有關的腳本自動與啟動程式和 initrd 產生器互動。
			</div><div
            class="para">
				上游的 Linux 原始碼包括建置 Debian 核心套件所需的一切。但是仍可再安裝 <span
              class="pkg pkg">build-essential</span> 以確保擁有建立 Debian 套件所需的所有工具。而且，組態核心時需要 <span
              class="pkg pkg">libncurses5-dev</span> 套件。最後，<span
              class="pkg pkg">fakeroot</span> 套件將在不使用管理者權限的前提下，啟用新增 Debian 套件。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>文化</em></span> <span
                        class="pkg pkg">kernel-package</span> 的美好歲月</strong></p></div></div></div><a
              id="id-1.11.14.8.4.2"
              class="indexterm"></a><div
              class="para">
				以 Linux 布建系統能夠建立適當的 Debian 套件前，使用 <code
                class="command">make-kpkg</code>，來自 <span
                class="pkg pkg">kernel-package</span> 套件。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-sources"></a>8.10.2. 取得原始碼</h3></div></div></div><a
            id="id-1.11.14.9.2"
            class="indexterm"></a><a
            id="id-1.11.14.9.3"
            class="indexterm"></a><a
            id="id-1.11.14.9.4"
            class="indexterm"></a><div
            class="para">
				Like anything that can be useful on a Debian system, the Linux kernel sources are available in a package. To retrieve them, just install the <span
              class="pkg pkg">linux-source-<em
                class="replaceable">version</em></span> package. The <code
              class="command">apt search ^linux-source</code> command lists the various kernel versions packaged by Debian. The latest version is available in the <span
              class="distribution distribution">Unstable</span> distribution: you can retrieve them without much risk (especially if your APT is configured according to the instructions of <a
              class="xref"
              href="sect.apt-get.html#sect.apt-mix-distros">節 6.2.6, “在多個發行版工作”</a>). Note that the source code contained in these packages does not correspond precisely with that published by Linus Torvalds and the kernel developers; like all distributions, Debian applies a number of patches, which might (or might not) find their way into the upstream version of Linux. These modifications include backports of fixes/features/drivers from newer kernel versions, new features not yet (entirely) merged in the upstream Linux tree, and sometimes even Debian specific changes.
			</div><div
            class="para">
				The remainder of this section focuses on the 4.9 version of the Linux kernel, but the examples can, of course, be adapted to the particular version of the kernel that you want.
			</div><div
            class="para">
				We assume the <span
              class="pkg pkg">linux-source-4.9</span> package has been installed. It contains <code
              class="filename">/usr/src/linux-source-4.9.tar.xz</code>, a compressed archive of the kernel sources. You must extract these files in a new directory (not directly under <code
              class="filename">/usr/src/</code>, since there is no need for special permissions to compile a Linux kernel): <code
              class="filename">~/kernel/</code> is appropriate.
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>mkdir ~/kernel; cd ~/kernel</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>tar -xaf /usr/src/linux-source-4.9.tar.xz</code></strong></pre><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>文化</em></span> 核心原始碼的位置</strong></p></div></div></div><div
              class="para">
				傳統上，Linux 核心原始碼置於 <code
                class="filename">/usr/src/linux/</code>，需要根權限才能編譯。然而，管理者的權限就夠了。<code
                class="literal">src</code> 群組的成員也可以使用該資料夾，但是應避免使用 <code
                class="filename">/usr/src/</code>。把核心原始碼置於個人資料夾時，應把安全置於第一位：在 <code
                class="filename">/usr/</code> 內的檔案都應明確其在套件系統內的作用，試圖聚集使用核心的資訊時，不能在讀取 <code
                class="filename">/usr/src/linux</code> 時誤導程式。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.config-kernel"></a>8.10.3. 組態核心</h3></div></div></div><a
            id="id-1.11.14.10.2"
            class="indexterm"></a><a
            id="id-1.11.14.10.3"
            class="indexterm"></a><a
            id="id-1.11.14.10.4"
            class="indexterm"></a><div
            class="para">
				下個步驟是根據需要組態核心。確切的程序視需要而訂。
			</div><div
            class="para">
				重新編譯較新版本的核心 (可能連同其補丁) 時，應儘量採用 Debian 建議的組態。在此情況下，與其從最基本開始重新編譯，不妨複製 <code
              class="filename">/boot/config-<em
                class="replaceable">version</em></code> 檔案 (核心正在使用的版本，可以 <code
              class="command">uname -r</code> 命令查看) 進入核心原始所在資料夾內的 <code
              class="filename">.config</code> 檔案。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cp /boot/config-4.9.0-3-amd64 ~/kernel/linux-source-4.9/.config</code></strong></pre><div
            class="para">
				需要改變組態的話，就跳至 <a
              class="xref"
              href="sect.kernel-compilation.html#sect.kernel-build">節 8.10.4, “編譯與建立套件”</a>。或者從基本開始重新組態，就需花時間組態核心。在核心原始碼的資料夾內有很多專屬介面，供呼叫 <code
              class="command">make <em
                class="replaceable">target</em></code> 命令，讓 <em
              class="replaceable">target</em> 是下列的其中一個值。
			</div><div
            class="para">
				<code
              class="command">make menuconfig</code> 編譯並執行文字模式介面 (即 <span
              class="pkg pkg">libncurses5-dev</span> 套件必備) 以階層結構瀏覽可用的選項。按 <span
              class="keycap"><strong>空格</strong></span> 鍵改變選定的值，並按螢幕下方的 <span
              class="keycap"><strong>Enter</strong></span> 鈕；<span
              class="guibutton"><strong>Select</strong></span> 送回選定的次選單；<span
              class="guibutton"><strong>Exit</strong></span> 關閉當前的螢幕並回到上個階層；<span
              class="guibutton"><strong>Help</strong></span> 顯示選項的詳細資訊。箭頭鍵在選項及按鈕清單內動。按主選單的 <span
              class="guibutton"><strong>Exit</strong></span> 鈕，就可離開組態程式。此程式可儲存改變的組態；接受改變後的組態。
			</div><div
            class="para">
				其他的介面也有類似的功能，但在現代化的圖形介面運作；諸如 <code
              class="command">make xconfig</code> 使用 Qt 圖形介面，而 <code
              class="command">make gconfig</code> 使手 GTK+。前者用到 <span
              class="pkg pkg">libqt4-dev</span>，後者依賴 <span
              class="pkg pkg">libglade2-dev</span> 與 <span
              class="pkg pkg">libgtk2.0-dev</span>。
			</div><div
            class="para">
				使用這些組態介面時，建議從合理的預設組態開始。提供該等組態的核心在 <code
              class="filename">arch/<em
                class="replaceable">arch</em>/configs/*_defconfig</code>，然後可將選定的組態置於像 <code
              class="command">make x86_64_defconfig</code> (64 位元電腦) 或 <code
              class="command">make i386_defconfig</code> (32 位元電腦) 這樣的命令。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>秘訣</em></span> 處理過時的 <code
                        class="filename">.config</code> 檔案</strong></p></div></div></div><div
              class="para">
				使用其他 (通常是較舊的) 核心版本的 <code
                class="filename">.config</code> 檔案時，需要先更新它。可以使用 <code
                class="command">make oldconfig</code> 命令，以互動方式詢問對新組態的選擇。可以用 <code
                class="command">make olddefconfig</code> 命令使用問題預設的答案。以 <code
                class="command">make oldnoconfig</code> 命令，可以對問題提供預設的負面答案。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-build"></a>8.10.4. 編譯與建立套件</h3></div></div></div><a
            id="id-1.11.14.11.2"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>說明</em></span> 建立前先清除</strong></p></div></div></div><div
              class="para">
				若已在資料夾內編譯過，希望從基礎重新建立 (或許更換核心組態)，需執行 <code
                class="command">make clean</code> 命令移除已編譯的檔案。<code
                class="command">make distclean</code> 命令可移除更多的檔案，包括客製的 <code
                class="filename">.config</code> 檔案，別忘了先備份。
			</div></div><div
            class="para">
				核心組態完成後，<code
              class="command">make deb-pkg</code> 命令可產生至多 5 個 Debian 套件：<span
              class="pkg pkg">linux-image-<em
                class="replaceable">version</em></span> 包括核心映像與相關的模組，<span
              class="pkg pkg">linux-headers-<em
                class="replaceable">version</em></span> 包括建立外部模組所需的標頭檔案，<span
              class="pkg pkg">linux-firmware-image-<em
                class="replaceable">version</em></span> 包括某些驅動程式所需的韌體 (由 Debian 提供的核心原始檔建立時，可能沒有該套件)，<span
              class="pkg pkg">linux-image-<em
                class="replaceable">version</em>-dbg</span> 包括供套件映像及其模組的除錯符號，以及<span
              class="pkg pkg">linux-libc-dev</span> 包括 GNU glibc 之類與使用者程式庫相關的標頭。
			</div><div
            class="para">
				<em
              class="replaceable">version</em> 由並列的上游版本決定 (如同變數 <code
              class="literal">VERSION</code>、<code
              class="literal">PATCHLEVEL</code>、<code
              class="literal">SUBLEVEL</code> 與 <code
              class="literal">EXTRAVERSION</code> 在 <code
              class="filename">Makefile</code> 內所定)、並列的 <code
              class="literal">LOCALVERSION</code> 組態參數、以及並列的 <code
              class="literal">LOCALVERSION</code> 環境變數。套件版本使用同版本字串以及新增的附加版本 (並儲存在 <code
              class="filename">.version</code>)，除非以 <code
              class="literal">KDEB_PKGVERSION</code> 環境變數覆寫它們。
			</div><pre
            class="screen"><code
              class="computeroutput">$ </code><strong
              class="userinput"><code>make deb-pkg LOCALVERSION=-falcot KDEB_PKGVERSION=$(make kernelversion)-1
</code></strong><code
              class="computeroutput">[...]
$ </code><strong
              class="userinput"><code>ls ../*.deb
</code></strong><code
              class="computeroutput">../linux-headers-4.9.30-ckt4-falcot_4.9.30-1_amd64.deb
../linux-image-4.9.30-ckt4-falcot_4.9.30-1_amd64.deb
../linux-image-4.9.30-ckt4-falcot-dbg_4.9.30-1_amd64.deb
../linux-libc-dev_4.9.30-1_amd64.deb
</code></pre></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.modules-build"></a>8.10.5. 編譯外部模組</h3></div></div></div><a
            id="id-1.11.14.12.2"
            class="indexterm"></a><a
            id="id-1.11.14.12.3"
            class="indexterm"></a><a
            id="id-1.11.14.12.4"
            class="indexterm"></a><div
            class="para">
				部份模組由 Linux 官方核心之外維護。使用時，必須與匹配的核心一起編譯。若干常見的第三方模組由 Debian 指定套件提供，諸如 <span
              class="pkg pkg">xtables-addons-source</span> (iptables 的外部模組) 或 <span
              class="pkg pkg">oss4-source</span> (Open Sound System，某些額外的音效驅動程式)。
			</div><div
            class="para">
				這些外部套件極多且雜，在此無法全部列舉；<code
              class="command">apt-cache search source$</code> 命令可縮小搜尋的範圍。然而，完整的清單沒什麼用處，祗有明確知道需要時，才會編譯特定的外部模組。在這個情況下，設備的文件會詳述 Linux 環境所需的模組。
			</div><div
            class="para">
				以 <span
              class="pkg pkg">xtables-addons-source</span> 套件為例：安裝之後，模組原始檔 <code
              class="filename">.tar.bz2</code> 儲存在 <code
              class="filename">/usr/src/</code>。可以手動解開該壓縮檔並建立模組，也可用 DKMS 自動做它。大部份模組提供必要的 DKMS 以 <code
              class="literal">-dkms</code> 後置文字整合入套件。在本例中，安裝 <span
              class="pkg pkg">xtables-addons-dkms</span> 就是為當前核心編譯核心模組，前提是有匹配已安裝核心的 <span
              class="pkg pkg">linux-headers-*</span> 套件。例如，使用 <span
              class="pkg pkg">linux-image-amd64</span>，則應同時安裝 <span
              class="pkg pkg">linux-headers-amd64</span>。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>sudo apt install xtables-addons-dkms</code></strong>
<code
              class="computeroutput">
[...]
Setting up xtables-addons-dkms (2.12-0.1) ...
Loading new xtables-addons-2.12 DKMS files...
Building for 4.9.0-3-amd64
Building initial module for 4.9.0-3-amd64
Done.

xt_ACCOUNT:
Running module version sanity check.
 - Original module
   - No original module exists within this kernel
 - Installation
   - Installing to /lib/modules/4.9.0-3-amd64/updates/dkms/
[...]
DKMS: install completed.
$ </code><strong
              class="userinput"><code>sudo dkms status</code></strong>
<code
              class="computeroutput">xtables-addons, 2.12, 4.9.0-3-amd64, x86_64: installed
$ </code><strong
              class="userinput"><code>sudo modinfo xt_ACCOUNT</code></strong>
<code
              class="computeroutput">filename:       /lib/modules/4.9.0-3-amd64/updates/dkms/xt_ACCOUNT.ko
license:        GPL
alias:          ipt_ACCOUNT
author:         Intra2net AG &lt;opensource@intra2net.com&gt;
description:    Xtables: per-IP accounting for large prefixes
[...]
</code></pre><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>其他</em></span> module-assistant</strong></p></div></div></div><a
              id="id-1.11.14.12.9.2"
              class="indexterm"></a><div
              class="para">
				DKMS 出現以前，<span
                class="pkg pkg">module-assistant</span> 是建立與布署核心模組的最簡單解決方案。目前還能用，特別是缺少 DKMS 整合的情況：以 <code
                class="command">module-assistant auto-install xtables-addons</code> (或較短的 <code
                class="command">m-a a-i xtables-addons</code>) 命令，就能編譯出給當前核心使用的模繻，置於新的 Debian 套件，讓該套件可以即時安裝。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.kernel-patch"></a>8.10.6. 使用核心補丁</h3></div></div></div><a
            id="id-1.11.14.13.2"
            class="indexterm"></a><a
            id="id-1.11.14.13.3"
            class="indexterm"></a><div
            class="para">
				因為不夠成熟或核心維護者意見不一致，很多功能未列入標準的核心。這種功能就以補丁的型式發行，任何人都可以自由地把它維入核心原始碼。
			</div><div
            class="para">
				Debian sometimes provides some of these patches in <span
              class="pkg pkg">linux-patch-*</span> packages but they often don't make it into stable releases (sometimes for the very same reasons that they are not merged into the official upstream kernel). These packages install files in the <code
              class="filename">/usr/src/kernel-patches/</code> directory.
			</div><div
            class="para">
				在原始檔資料夾內，以 <code
              class="command">patch</code> 命令編譯核心，就能夠納入前述安裝的補丁。
			</div><pre
            class="screen">
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>cd ~/kernel/linux-source-4.9</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>make clean</code></strong>
<code
              class="computeroutput">$ </code><strong
              class="userinput"><code>zcat /usr/src/kernel-patches/diffs/grsecurity2/grsecurity-3.1-4.9.11-201702181444.patch.gz | patch -p1</code></strong></pre><div
            class="para">
				有些補丁不見得適用於每個核心版本；以 <code
              class="command">patch</code> 可能無法應用於核心原始碼。將出現錯誤訊息且提示錯誤的原因；在此情況下，參照 Debian 補丁套件的文件 (位於 <code
              class="filename">/usr/share/doc/linux-patch-*/</code> 資料夾)。大部份的情況下，維護者會指出其補丁適用的核心版本。
			</div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.config-misc.html"><strong>前一頁</strong>8.9. 其他組態：時間同步、記錄、共享近用…</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一層</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始頁</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.kernel-installation.html"><strong>下一頁</strong>8.11. 安裝核心</a></li></ul></body></html>
