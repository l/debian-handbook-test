<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">10.2. Virtuelt Privat Nettverk</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-nb-NO-1.0-1" /><meta
        name="keywords"
        content="Nettverk, Innfallsport (gateway), TCP/IP, IPv6, DNS, Bind, DHCP, QoS" /><link
        rel="home"
        href="index.html"
        title="Debian-administratorens håndbok" /><link
        rel="up"
        href="network-infrastructure.html"
        title="Kapittel 10. Nettverksinfrastruktur" /><link
        rel="prev"
        href="network-infrastructure.html"
        title="Kapittel 10. Nettverksinfrastruktur" /><link
        rel="next"
        href="sect.quality-of-service.html"
        title="10.3. Quality of Service" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/nb-NO/stable/sect.virtual-private-network.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>Forrige</strong></a></li><li
          class="home">Debian-administratorens håndbok</li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>Neste</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.virtual-private-network"></a>10.2. Virtuelt Privat Nettverk</h2></div></div></div><div
          class="para">
			Et <span
            class="emphasis"><em>Virtual Private Network</em></span> (VPN for kort) er en måte å koble to forskjellige lokale nettverk via Internett ved hjelp av en tunnel; tunnelen er vanligvis kryptert for konfidensialitet. VPN brukes ofte for å integrere en ekstern maskin i et selskaps lokale nettverk.
		</div><a
          id="id-1.13.5.3"
          class="indexterm"></a><a
          id="id-1.13.5.4"
          class="indexterm"></a><a
          id="id-1.13.5.5"
          class="indexterm"></a><div
          class="para">
			Flere verktøy har dette. OpenVPN er en effektiv løsning, enkel å implementere og vedlikeholde, basert på SSL/TLS. En annen mulighet er å bruke IPsec for å kryptere IP-trafikk mellom to maskiner; denne krypteringen er gjennomsiktig, hvilket betyr at applikasjoner som kjører på disse vertene ikke behøver modifiseres for å ta hensyn til VPN. SSH kan også brukes for å tilveiebringe en VPN, i tillegg til mer konvensjonelle egenskaper. Endelig kan en VPN etableres ved hjelp av Microsofts PPTP-protokollen. Andre løsninger finnes, men er utenfor siktemålet med denne boken.
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.openvpn"></a>10.2.1. OpenVPN</h3></div></div></div><a
            id="id-1.13.5.7.2"
            class="indexterm"></a><div
            class="para">
				OpenVPN er et stykke programvare med formål å lage virtuelle private nettverk. Oppsettet innebærer å skape virtuelle nettverksgrensesnitt på VPN-tjeneren og på klienten(e); både <code
              class="literal">tun</code> (for IP-nivå tunneller) og <code
              class="literal">tap</code> (for Ethernet-nivå tunneller) grensesnitt er støttet. I praksis, skal <code
              class="literal">tun</code>-grensesnitt oftest brukes unntatt når VPN-klienter er ment til å bli integrert i tjenerens lokale nettverk ved hjelp av en Ethernet-bro.
			</div><div
            class="para">
				OpenVPN avhenger av OpenSSL for all SSL/TLS kryptografi og tilhørende funksjoner (konfidensialitet, autentisering, integritet, ikke-fornekting). Den kan konfigureres enten med en felles privat nøkkel eller ved hjelp av X.509-sertifikater basert på en infrastruktur med fellesnøkler. Sistnevnte konfigurasjonen er sterkt foretrukket fordi den gir større fleksibilitet når den står overfor et økende antall brukere som bruker VPN utenfra.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CULTURE</em></span> SSL og TLS</strong></p></div></div></div><a
              id="id-1.13.5.7.5.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.5.3"
              class="indexterm"></a><div
              class="para">
				SSL-protokollen (<span
                class="emphasis"><em>Secure Socket Layer</em></span>) ble oppfunnet av Netscape for å sikre tilkoblinger til netttjenere. Det ble senere standardisert av IETF under forkortelsen TLS (<span
                class="emphasis"><em>Transport Layer Security</em></span>) Siden da har TLS fortsatte utviklingen, og i dag er SSL foreldet fordi det er oppdaget en rekke designfeil.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.easy-rsa"></a>10.2.1.1. Offentlig nøkke-infrastruktur: <span
                      class="emphasis"><em>easy-rsa</em></span></h4></div></div></div><a
              id="id-1.13.5.7.6.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.3"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.4"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.5"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.6"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.7"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.8"
              class="indexterm"></a><div
              class="para">
					RSA-algoritmen er mye brukt i offentlig-nøkkel kryptografi. Det innebærer en "nøkkel par", som består av en privat og en offentlig nøkkel. De to nøklene er nært knyttet til hverandre, og deres matematiske egenskaper er slik at en melding som er kryptert med den offentlige nøkkelen kun kan dekrypteres av en person som kjenner den private nøkkelen, noe som sørger for konfidensialitet. I motsatt retning, kan en melding kryptert med den private nøkkelen dekrypteres ved at noen kjenner den offentlige nøkkelen, noe som gjør det mulig å autentisere opprinnelsen til en melding siden bare noen med tilgang til den private nøkkelen kan generere den. Når den er knyttet til en digital nøkkel-funksjon (MD5, SHA1, eller en nyere variant), fører dette til en signaturmekanisme som kan brukes til en hvilken som helst melding.
				</div><div
              class="para">
					Imidlertid kan hvem som helst lage et nøkkelpar, lagre en hvilken som helst identitet på den, og foregir at at detter er den valgte identiteten. En løsning innebærer konseptet med en <span
                class="emphasis"><em>Certification Authority</em></span> (CA), formalisert av X.509-standarden. Dette konseptet omfatter en enhet som har et pålitelig nøkkelpar kjent som et <span
                class="emphasis"><em>root certificate</em></span>. Dette sertifikatet er kun brukt til å signere andre sertifikater (nøkkelpar) etter at riktige skritt er blitt tatt for å sjekke identiteten som er lagret i nøkkelparet. Applikasjoner som bruker X.509 kan da sjekke sertifikatene som blir presentert for dem, hvis de kjenner til de klarerte ette sertifikatet er kun brukt til å signere andre sertifikater (nøkkelpar), etter at riktige tiltak har blitt gjennomført for å sjekke identiteten lagret på nøkkelpar. Applikasjoner ved hjelp av X.509 kan da sjekke sertifikatene presentert for dem, hvis de vet om de klarerte rotsertifikater..
				</div><div
              class="para">
					OpenVPN følger denne regelen. Siden offentlige CAer kun utsteder sertifikater i bytte for en (heftig) avgift, er det også mulig å opprette en privat sertifiseringsinstans i selskapet. <span
                class="pkg pkg">easy-rsa</span>-pakken inneholder verktøy for å tjene som en X.509 infrastruktur for sertifisering, implementert som et skriptsett som bruker <code
                class="command">openssl</code>-kommandoen.
				</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTE</em></span> <span
                          class="emphasis"><em>easy-rsa</em></span> before <span
                          class="distribution distribution">Jessie</span></strong></p></div></div></div><div
                class="para">
					I versjoner av Debian opp til <span
                  class="distribution distribution">Wheezy</span>, var <span
                  class="emphasis"><em>easy-rsa</em></span> distribuert som en dek av <span
                  class="pkg pkg">openvpn</span>-pakken, med skriptene under <code
                  class="filename">/usr/share/doc/openvpn/examples/easy-rsa/2.0/</code>. Å sette opp en CA omfattet å kopiere den katalogen, i stedet for å bruke <code
                  class="command">make-cadir</code>-kommandoen som dokumentert her.
				</div></div><div
              class="para">
					Falcot Corp-administratorene bruker dette verktøyet for å lage de nødvendige sertifikater, både for serveren og klientene. Dette tillater at konfigurasjonen av alle klienter er lik siden de bare må settes opp til å stole på sertifikater fra Falcots lokale CA. Dette CAet er det første som må lages; til dette formålet, setter administratorene opp en katalog med filene som kreves for CAet på et passende sted, fortrinnsvis på en maskin som ikke er koblet til nettverket for å redusere risikoen for at CAs private nøkkel blir stjålet.
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>make-cadir pki-falcot
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>cd pki-falcot</code></strong></pre><div
              class="para">
					De lagrer deretter de nødvendige parameterene i <code
                class="filename">vars</code>-filen, spesielt de som er navnet med et <code
                class="literal">KEY_</code>-prefiks; Disse variablene blir så integrert i miljøet:
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>vim vars
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>grep KEY_ vars
</code></strong><code
                class="computeroutput">export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
export KEY_DIR="$EASY_RSA/keys"
echo NOTE: If you run ./clean-all, I will be doing a rm -rf on $KEY_DIR
export KEY_SIZE=2048
export KEY_EXPIRE=3650
export KEY_COUNTRY="FR"
export KEY_PROVINCE="Loire"
export KEY_CITY="Saint-Étienne"
export KEY_ORG="Falcot Corp"
export KEY_EMAIL="admin@falcot.com"
export KEY_OU="Certificate authority"
export KEY_NAME="Certificate authority for Falcot Corp"
# If you'd like to sign all keys with the same Common Name, uncomment the KEY_CN export below
# export KEY_CN="CommonName"
$ </code><strong
                class="userinput"><code>. ./vars
</code></strong><code
                class="computeroutput">NOTE: If you run ./clean-all, I will be doing a rm -rf on /home/roland/pki-falcot/keys
$ </code><strong
                class="userinput"><code>./clean-all
</code></strong></pre><div
              class="para">
					Det neste trinnet er etableringen av selve CAs nøkkelpar (de to delene av nøkkelparet vil i dette trinnet bli lagret under <code
                class="filename">keys/ca.crt</code> og <code
                class="filename">keys/ca.key</code>):
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-ca</code></strong>
<code
                class="computeroutput">Generating a 2048 bit RSA private key
...................................................................+++
...+++
writing new private key to 'ca.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [Falcot Corp CA]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:
</code></pre><div
              class="para">
					Sertifikatet for VPN-serveren kan nå bli opprettet, så vel som Diffie-Hellman-parameterene som kreves for tjenersiden av en SSL/TLS-tilkobling. VPN-tjeneren er identifisert av sitt DNS-navn <code
                class="literal">vpn.falcot.com</code>; dette navnet gjenbrukes for de genererte nøkkelfilerene, (<code
                class="filename">keys/vpn.falcot.com.crt</code> for det offentlige sertifikatet, <code
                class="filename">keys/vpn.falcot.com.key</code> for den private nøkkelen):
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key-server vpn.falcot.com
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
.....................................................................................................................+++
...........+++
writing new private key to 'vpn.falcot.com.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:
Common Name (eg, your name or your server's hostname) [vpn.falcot.com]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
Using configuration from /home/roland/pki-falcot/openssl-1.0.0.cnf
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'FR'
stateOrProvinceName   :PRINTABLE:'Loire'
localityName          :T61STRING:'Saint-\0xFFFFFFC3\0xFFFFFF89tienne'
organizationName      :PRINTABLE:'Falcot Corp'
organizationalUnitName:PRINTABLE:'Certificate authority'
commonName            :PRINTABLE:'vpn.falcot.com'
name                  :PRINTABLE:'Certificate authority for Falcot Corp'
emailAddress          :IA5STRING:'admin@falcot.com'
Certificate is to be certified until Mar  6 14:54:56 2025 GMT (3650 days)
Sign the certificate? [y/n]:</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">

1 out of 1 certificate requests certified, commit? [y/n]</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">Write out database with 1 new entries
Data Base Updated
$ </code><strong
                class="userinput"><code>./build-dh
</code></strong><code
                class="computeroutput">Generating DH parameters, 2048 bit long safe prime, generator 2
This is going to take a long time
[…]
</code></pre><div
              class="para">
					Det neste trinnet oppretter sertifikater for VPN-klienter; ett sertifikat kreves for hver datamaskin eller person som får lov å bruke VPNen:
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key JoeSmith
</code></strong><code
                class="computeroutput">Generating a 2048 bit RSA private key
................................+++
..............................................+++
writing new private key to 'JoeSmith.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [FR]:
State or Province Name (full name) [Loire]:
Locality Name (eg, city) [Saint-Étienne]:
Organization Name (eg, company) [Falcot Corp]:
Organizational Unit Name (eg, section) [Certificate authority]:</code><strong
                class="userinput"><code>Development unit
</code></strong><code
                class="computeroutput">Common Name (eg, your name or your server's hostname) [JoeSmith]:</code><strong
                class="userinput"><code>Joe Smith
</code></strong><code
                class="computeroutput">[…]</code></pre><div
              class="para">
					Nå er alle sertifikater blitt opprettet, of de trenger å bli kopiert når det må til: rotsertifikatets offentlige nøkke(<code
                class="filename">keys/ca.crt</code>) vil bli lagret på alle maskiner (både server og klienter) som <code
                class="filename">/etc/ssl/certs/Falcot_CA.crt</code>. Tjenerens sertifikat er bare installert på tjeneren (<code
                class="filename">keys/vpn.falcot.com.crt</code> går til <code
                class="filename">/etc/ssl/vpn.falcot.com.crt</code>, og <code
                class="filename">keys/vpn.falcot.com.key</code> går til <code
                class="filename">/etc/ssl/private/vpn.falcot.com.key</code> med begrensede tillatelser slik at bare administratoren kan lese den), med tilhørende Diffie-Hellman-parametre (<code
                class="filename">keys/dh2048.pem</code>) installert til <code
                class="filename">/etc/openvpn/dh2048.pem</code>. Klientsertifikater blir installert på den tilsvarende VPN-klienten på en lignende måte.
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.13.5.7.7"></a>10.2.1.2. Å konfigurere OpenVPN-tjeneren</h4></div></div></div><div
              class="para">
					Som standard, forsøker OpenVPN-initialiseringskript å starte alle virtuelle private nettverk som er definert i <code
                class="filename">/etc/openvpn/*.conf</code>. Å sette opp en VPN-tjener er derfor et spørsmål om å lagre en tilsvarende konfigurasjonsfil i denne katalogen. Et godt utgangspunkt er <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz</code>, som leder til en temmelig standard tjener. Selvfølgelig, må noen parametere tilpasses: <code
                class="literal">ca</code>, <code
                class="literal">cert</code>, <code
                class="literal">key</code> og <code
                class="literal">dh</code> må beskrive de valgte stedene (henholdsvis <code
                class="literal">/etc/ssl/certs/Falcot_CA.crt</code>, <code
                class="literal">/etc/ssl/vpn.falcot.com.crt</code>, <code
                class="literal">/etc/ssl/private/vpn.falcot.com.key</code> and <code
                class="literal">/etc/openvpn/dh2048.pem</code>). <code
                class="literal">server 10.8.0.0 255.255.255.0</code>-direktivet definerer subnettet som skal brukes av VPN; tjeneren bruker den første IP-adressen i dette området (<code
                class="literal">10.8.0.1</code>) og resten av adressene er reservert for klienter.
				</div><div
              class="para">
					Med denne konfigurasjonen, lager oppstarten av OpenVPN det virtuelle nettverksgrensesnittet, vanligvis med <code
                class="literal">tun0</code>-navnet. Imidlertid er brannmurer ofte konfigurert på samme tid som det virkelige nettverksgrensesnittet, og skjer før OpenVPN starter. En god praksis er derfor å lage et varig virtuelt nettverksgrensesnitt, og konfigurere OpenVPN til å bruke dette varige grensesnittet. Dette tillater videre å velge navnet til dette grensesnittet. For dette formål lager <code
                class="command">openvpn --mktun --dev vpn --dev-type tun</code> et virtuelt nettverkbrukergrensesnitt med navnet <code
                class="literal">vpn</code> med type <code
                class="literal">tun</code>; denne kommandoen kan enkelt legges inn i brannmur-konfigurasjonens skript eller i et <code
                class="literal">up</code>-direktiv i <code
                class="filename">/etc/network/interfaces</code>-filen. OpenVPN-konfigurasjonsfilen må også oppdateres tilsvarende, med <code
                class="literal">dev vpn</code> og <code
                class="literal">dev-type tun</code>-direktiver.
				</div><div
              class="para">
					For å sperre ytterligere virksomhet, kan VPN-klienter kun få tilgang til selve VPN-tjeneren ved hjelp av <code
                class="literal">10.8.0.1</code>adressen. Å gi klientene tilgang til det lokale nettverket (192.168.0.0/24), krever at en legger til et <code
                class="literal">push route 192.168.0.0 255.255.255.0</code>-direktiv til OpenVPN konfigurasjonen slik at VPN-klienter automatisk får en nettverkrute som forteller dem at dette nettverket kan nås ved hjelp av VPN. Videre, maskiner på det lokale nettverket må også informeres om at ruten til VPN går gjennom VPN-tjeneren (dette fungerer automatisk når VPN-serveren er installert i porten). Alternativt kan VPN-serveren konfigureres til å utføre IP-maskering, slik at tilkoblinger fra VPN-klienter ser ut som om de kommer fra VPN-tjeneren i stedet (se <a
                class="xref"
                href="network-infrastructure.html#sect.gateway">Seksjon 10.1, «Innfallsport (gateway)»</a>).
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.13.5.7.8"></a>10.2.1.3. Å konfigurere OpenVPN-klienten</h4></div></div></div><div
              class="para">
					Å sette opp en OpenVPN klient krever også at en lager en konfigurasjonsfil <code
                class="filename">/etc/openvpn/</code>. En standardkonfigurasjon kan fås ved å bruke <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/client.conf</code> som et startpunkt. <code
                class="literal">remote vpn.falcot.com 1194</code>-direktivet beskriver adressen og porten til OpenVPN-tjeneren; <code
                class="literal">ca</code>, <code
                class="literal">cert</code> og <code
                class="literal">key</code> må også tilpasses til å beskrive plasseringen av de viktigste filene.
				</div><div
              class="para">
					Hvis VPN ikke skal startes automatisk ved oppstart, sett <code
                class="literal">AUTOSTART</code>-direktivet til <code
                class="literal">none</code> i <code
                class="filename">/etc/default/openvpn</code>-filen. Å sstarte eller stoppe en gitt VPN-forbindelse er alltid mulig med kommandoene <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> start</code> og <code
                class="command">service openvpn@<em
                  class="replaceable">name</em> stop</code> (der forbindelsen <em
                class="replaceable">name</em> sammenfaller med en som er definert i <code
                class="filename">/etc/openvpn/<em
                  class="replaceable">name</em>.conf</code>).
				</div><div
              class="para">
					<span
                class="pkg pkg">network-manager-openvpn-gnome</span>-pakken inneholder en forlengelse til Network Manager (se <a
                class="xref"
                href="sect.network-config.html#sect.roaming-network-config">Seksjon 8.2.4, «Automatisk nettverksoppsett for roaming-brukere»</a>) som tillater håndtering av OpenVPN virtueller private nettverk. Det tillater hver bruker å sette opp OpenVPN-tilkoblinger grafisk og styre dem fra nettverksadministrasjons-ikonet. <a
                id="id-1.13.5.7.8.4.3"
                class="indexterm"></a>
				</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.ssh-vpn"></a>10.2.2. Virtuelt privat nettverk med SSH</h3></div></div></div><a
            id="id-1.13.5.8.2"
            class="indexterm"></a><a
            id="id-1.13.5.8.3"
            class="indexterm"></a><div
            class="para">
				Det er faktisk to måter å lage et virtuelt privat nettverk ved hjelp av SSH. Den historiske innebærer å etablere et PPP-lag over SSH-linken. Denne metoden er beskrevet i et HOWTO-dokument: <div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://www.tldp.org/HOWTO/ppp-ssh/">http://www.tldp.org/HOWTO/ppp-ssh/</a></div>
			</div><div
            class="para">
				The second method is more recent, and was introduced with OpenSSH 4.3; it is now possible for OpenSSH to create virtual network interfaces (<code
              class="literal">tun*</code>) on both sides of an SSH connection, and these virtual interfaces can be configured exactly as if they were physical interfaces. The tunneling system must first be enabled by setting <code
              class="literal">PermitTunnel</code> to “yes” in the SSH server configuration file (<code
              class="filename">/etc/ssh/sshd_config</code>). When establishing the SSH connection, the creation of a tunnel must be explicitly requested with the <code
              class="literal">-w any:any</code> option (<code
              class="literal">any</code> can be replaced with the desired <code
              class="literal">tun</code> device number). This requires the user to have administrator privilege on both sides, so as to be able to create the network device (in other words, the connection must be established as root).
			</div><div
            class="para">
				Both methods for creating a virtual private network over SSH are quite straightforward. However, the VPN they provide is not the most efficient available; in particular, it does not handle high levels of traffic very well.
			</div><div
            class="para">
				The explanation is that when a TCP/IP stack is encapsulated within a TCP/IP connection (for SSH), the TCP protocol is used twice, once for the SSH connection and once within the tunnel. This leads to problems, especially due to the way TCP adapts to network conditions by altering timeout delays. The following site describes the problem in more detail: <div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://sites.inka.de/sites/bigred/devel/tcp-tcp.html">http://sites.inka.de/sites/bigred/devel/tcp-tcp.html</a></div> VPNs over SSH should therefore be restricted to one-off tunnels with no performance constraints.
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.ipsec"></a>10.2.3. IPsec</h3></div></div></div><a
            id="id-1.13.5.9.2"
            class="indexterm"></a><a
            id="id-1.13.5.9.3"
            class="indexterm"></a><a
            id="id-1.13.5.9.4"
            class="indexterm"></a><div
            class="para">
				IPsec, despite being the standard in IP VPNs, is rather more involved in its implementation. The IPsec engine itself is integrated in the Linux kernel; the required user-space parts, the control and configuration tools, are provided by the <span
              class="pkg pkg">ipsec-tools</span> package. In concrete terms, each host's <code
              class="filename">/etc/ipsec-tools.conf</code> contains the parameters for <span
              class="emphasis"><em>IPsec tunnels</em></span> (or <span
              class="emphasis"><em>Security Associations</em></span>, in the IPsec terminology) that the host is concerned with; the <code
              class="command">/etc/init.d/setkey</code> script provides a way to start and stop a tunnel (each tunnel is a secure link to another host connected to the virtual private network). This file can be built by hand from the documentation provided by the <span
              class="citerefentry"><span
                class="refentrytitle">setkey</span>(8)</span> manual page. However, explicitly writing the parameters for all hosts in a non-trivial set of machines quickly becomes an arduous task, since the number of tunnels grows fast. Installing an IKE daemon (for <span
              class="emphasis"><em>IPsec Key Exchange</em></span>) such as <span
              class="pkg pkg">racoon</span> or <span
              class="pkg pkg">strongswan</span> makes the process much simpler by bringing administration together at a central point, and more secure by rotating the keys periodically.
			</div><a
            id="id-1.13.5.9.6"
            class="indexterm"></a><a
            id="id-1.13.5.9.7"
            class="indexterm"></a><a
            id="id-1.13.5.9.8"
            class="indexterm"></a><a
            id="id-1.13.5.9.9"
            class="indexterm"></a><div
            class="para">
				In spite of its status as the reference, the complexity of setting up IPsec restricts its usage in practice. OpenVPN-based solutions will generally be preferred when the required tunnels are neither too many nor too dynamic.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CAUTION</em></span> IPsec and NAT</strong></p></div></div></div><div
              class="para">
				NATing firewalls and IPsec do not work well together: since IPsec signs the packets, any change on these packets that the firewall might perform will void the signature, and the packets will be rejected at their destination. Various IPsec implementations now include the <span
                class="emphasis"><em>NAT-T</em></span> technique (for <span
                class="emphasis"><em>NAT Traversal</em></span>), which basically encapsulates the IPsec packet within a standard UDP packet.
			</div><a
              id="id-1.13.5.9.11.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.11.4"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SECURITY</em></span> IPsec and firewalls</strong></p></div></div></div><div
              class="para">
				The standard mode of operation of IPsec involves data exchanges on UDP port 500 for key exchanges (also on UDP port 4500 in the case that NAT-T is in use). Moreover, IPsec packets use two dedicated IP protocols that the firewall must let through; reception of these packets is based on their protocol numbers, 50 (ESP) and 51 (AH).
			</div><a
              id="id-1.13.5.9.12.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.4"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.5"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.6"
              class="indexterm"></a></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.pptp"></a>10.2.4. PPTP</h3></div></div></div><div
            class="para">
				PPTP (for <span
              class="emphasis"><em>Point-to-Point Tunneling Protocol</em></span>) uses two communication channels, one for control data and one for payload data; the latter uses the GRE protocol (<span
              class="emphasis"><em>Generic Routing Encapsulation</em></span>). A standard PPP link is then set up over the data exchange channel.
			</div><a
            id="id-1.13.5.10.3"
            class="indexterm"></a><a
            id="id-1.13.5.10.4"
            class="indexterm"></a><a
            id="id-1.13.5.10.5"
            class="indexterm"></a><a
            id="id-1.13.5.10.6"
            class="indexterm"></a><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.pptp-config-client"></a>10.2.4.1. Configuring the Client</h4></div></div></div><div
              class="para">
					The <span
                class="pkg pkg">pptp-linux</span> package contains an easily-configured PPTP client for Linux. The following instructions take their inspiration from the official documentation: <div
                xmlns=""
                class="url">→ <a
                  xmlns="http://www.w3.org/1999/xhtml"
                  href="http://pptpclient.sourceforge.net/howto-debian.phtml">http://pptpclient.sourceforge.net/howto-debian.phtml</a></div>
				</div><a
              id="id-1.13.5.10.7.3"
              class="indexterm"></a><div
              class="para">
					The Falcot administrators created several files: <code
                class="filename">/etc/ppp/options.pptp</code>, <code
                class="filename">/etc/ppp/peers/falcot</code>, <code
                class="filename">/etc/ppp/ip-up.d/falcot</code>, and <code
                class="filename">/etc/ppp/ip-down.d/falcot</code>.
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-options.pptp"></a><p
                class="title"><strong>Eksempel 10.2. The <code
                    class="filename">/etc/ppp/options.pptp</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# PPP options used for a PPTP connection
lock
noauth
nobsdcomp
nodeflate
</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-peers-falcot"></a><p
                class="title"><strong>Eksempel 10.3. The <code
                    class="filename">/etc/ppp/peers/falcot</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# vpn.falcot.com is the PPTP server
pty "pptp vpn.falcot.com --nolaunchpppd"
# the connection will identify as the "vpn" user
user vpn
remotename pptp
# encryption is needed
require-mppe-128
file /etc/ppp/options.pptp
ipparam falcot
</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-ip-up.d-falcot"></a><p
                class="title"><strong>Eksempel 10.4. The <code
                    class="filename">/etc/ppp/ip-up.d/falcot</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Create the route to the Falcot network
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route add -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi
</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-ip-down.d-falcot"></a><p
                class="title"><strong>Eksempel 10.5. The <code
                    class="filename">/etc/ppp/ip-down.d/falcot</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Delete the route to the Falcot network
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 is the (remote) Falcot network
  route del -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> MPPE</strong></p></div></div></div><div
                class="para">
					Securing PPTP involves using the MPPE feature (<span
                  class="emphasis"><em>Microsoft Point-to-Point Encryption</em></span>), which is available in official Debian kernels as a module.
				</div><a
                id="id-1.13.5.10.7.9.3"
                class="indexterm"></a><a
                id="id-1.13.5.10.7.9.4"
                class="indexterm"></a></div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.pptp-config-serveur"></a>10.2.4.2. Configuring the Server</h4></div></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CAUTION</em></span> PPTP and firewalls</strong></p></div></div></div><div
                class="para">
					Intermediate firewalls need to be configured to let through IP packets using protocol 47 (GRE). Moreover, the PPTP server's port 1723 needs to be open so that the communication channel can happen.
				</div></div><div
              class="para">
					<code
                class="command">pptpd</code> is the PPTP server for Linux. Its main configuration file, <code
                class="filename">/etc/pptpd.conf</code>, requires very few changes: <span
                class="emphasis"><em>localip</em></span> (local IP address) and <span
                class="emphasis"><em>remoteip</em></span> (remote IP address). In the example below, the PPTP server always uses the <code
                class="literal">192.168.0.199</code> address, and PPTP clients receive IP addresses from <code
                class="literal">192.168.0.200</code> to <code
                class="literal">192.168.0.250</code>.
				</div><div
              class="example"><a
                xmlns=""
                id="example.pptpd.conf"></a><p
                class="title"><strong>Eksempel 10.6. The <code
                    class="filename">/etc/pptpd.conf</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# TAG: speed
#
#       Specifies the speed for the PPP daemon to talk at.
#
speed 115200

# TAG: option
#
#       Specifies the location of the PPP options file.
#       By default PPP looks in '/etc/ppp/options'
#
option /etc/ppp/pptpd-options

# TAG: debug
#
#       Turns on (more) debugging to syslog
#
# debug

# TAG: localip
# TAG: remoteip
#
#       Specifies the local and remote IP address ranges.
#
#       You can specify single IP addresses separated by commas or you can
#       specify ranges, or both. For example:
#
#               192.168.0.234,192.168.0.245-249,192.168.0.254
#
#       IMPORTANT RESTRICTIONS:
#
#       1. No spaces are permitted between commas or within addresses.
#
#       2. If you give more IP addresses than MAX_CONNECTIONS, it will
#          start at the beginning of the list and go until it gets
#          MAX_CONNECTIONS IPs. Others will be ignored.
#
#       3. No shortcuts in ranges! ie. 234-8 does not mean 234 to 238,
#          you must type 234-238 if you mean this.
#
#       4. If you give a single localIP, that's ok - all local IPs will
#          be set to the given one. You MUST still give at least one remote
#          IP for each simultaneous client.
#
#localip 192.168.0.234-238,192.168.0.245
#remoteip 192.168.1.234-238,192.168.1.245
#localip 10.0.1.1
#remoteip 10.0.1.2-100
localip 192.168.0.199
remoteip 192.168.0.200-250
</pre></div></div><div
              class="para">
					The PPP configuration used by the PPTP server also requires a few changes in <code
                class="filename">/etc/ppp/pptpd-options</code>. The important parameters are the server name (<code
                class="literal">pptp</code>), the domain name (<code
                class="literal">falcot.com</code>), and the IP addresses for DNS and WINS servers.
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-pptpd-options"></a><p
                class="title"><strong>Eksempel 10.7. The <code
                    class="filename">/etc/ppp/pptpd-options</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
## turn pppd syslog debugging on
#debug

## change 'servername' to whatever you specify as your server name in chap-secrets
name pptp
## change the domainname to your local domain
domain falcot.com

## these are reasonable defaults for WinXXXX clients
## for the security related settings
# The Debian pppd package now supports both MSCHAP and MPPE, so enable them
# here. Please note that the kernel support for MPPE must also be present!
auth
require-chap
require-mschap
require-mschap-v2
require-mppe-128

## Fill in your addresses
ms-dns 192.168.0.1
ms-wins 192.168.0.1

## Fill in your netmask
netmask 255.255.255.0

## some defaults
nodefaultroute
proxyarp
lock
</pre></div></div><div
              class="para">
					The last step involves registering the <code
                class="literal">vpn</code> user (and the associated password) in the <code
                class="filename">/etc/ppp/chap-secrets</code> file. Contrary to other instances where an asterisk (<code
                class="literal">*</code>) would work, the server name must be filled explicitly here. Furthermore, Windows PPTP clients identify themselves under the <code
                class="literal"><em
                  class="replaceable">DOMAIN</em>\\<em
                  class="replaceable">USER</em></code> form, instead of only providing a user name. This explains why the file also mentions the <code
                class="literal">FALCOT\\vpn</code> user. It is also possible to specify individual IP addresses for users; an asterisk in this field specifies that dynamic addressing should be used.
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-chap-secrets"></a><p
                class="title"><strong>Eksempel 10.8. The <code
                    class="filename">/etc/ppp/chap-secrets</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Secrets for authentication using CHAP
# client        server  secret      IP addresses
vpn             pptp    f@Lc3au     *
FALCOT\\vpn     pptp    f@Lc3au     *
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> PPTP vulnerabilities</strong></p></div></div></div><div
                class="para">
					Microsoft's first PPTP implementation drew severe criticism because it had many security vulnerabilities; most have since then been fixed in more recent versions. The configuration documented in this section uses the latest version of the protocol. Be aware though that removing some options (such as <code
                  class="literal">require-mppe-128</code> and <code
                  class="literal">require-mschap-v2</code>) would make the service vulnerable again.
				</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>Forrige</strong>Kapittel 10. Nettverksinfrastruktur</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Opp</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Hjem</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>Neste</strong>10.3. Quality of Service</a></li></ul></body></html>
