<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">Kapittel 11. Nettverkstjenester: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-nb-NO-1.0-1" /><meta
        name="keywords"
        content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP, SIP" /><link
        rel="home"
        href="index.html"
        title="Debian-administratorens håndbok" /><link
        rel="up"
        href="index.html"
        title="Debian-administratorens håndbok" /><link
        rel="prev"
        href="sect.network-diagnosis-tools.html"
        title="10.8. Diagnoseverktøy for nettverk" /><link
        rel="next"
        href="sect.http-web-server.html"
        title="11.2. Web Server (HTTP)" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/nb-NO/stable/network-services.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Forrige</strong></a></li><li
          class="home">Debian-administratorens håndbok</li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Neste</strong></a></li></ul><div
        xml:lang="nb-NO"
        class="chapter"
        lang="nb-NO"><div
          class="titlepage"><div><div><h1
                class="title"><a
                  xmlns=""
                  id="network-services"></a>Kapittel 11. Nettverkstjenester: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</h1></div></div></div><div
          class="toc"><dl
            class="toc"><dt><span
                class="section"><a
                  href="network-services.html#sect.smtp-mail-server">11.1. Posttjener</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="network-services.html#id-1.14.4.7">11.1.1. Å installere Postfix</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.configuring-virtual-domains">11.1.2. Å sette opp virtuelle domener</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.restrictions-for-receiving-and-sending">11.1.3. Restriksjoner for å motta og sende</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.setting-up-greylisting">11.1.4. Setting Up <span
                        class="foreignphrase"><em
                          class="foreignphrase">greylisting</em></span></a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#id-1.14.4.11">11.1.5. Customizing Filters Based On the Recipient</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.postfix-antivirus">11.1.6. Integrating an Antivirus</a></span></dt><dt><span
                    class="section"><a
                      href="network-services.html#sect.authenticated-smtp">11.1.7. Authenticated SMTP</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-web-server.html">11.2. Web Server (HTTP)</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#id-1.14.5.9">11.2.1. Installing Apache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#id-1.14.5.10">11.2.2. Configuring Virtual Hosts</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#id-1.14.5.11">11.2.3. Common Directives</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-web-server.html#id-1.14.5.12">11.2.4. Log Analyzers</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ftp-file-server.html">11.3. FTP File Server</a></span></dt><dt><span
                class="section"><a
                  href="sect.nfs-file-server.html">11.4. NFS File Server</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#id-1.14.7.10">11.4.1. Securing NFS</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#id-1.14.7.11">11.4.2. NFS Server</a></span></dt><dt><span
                    class="section"><a
                      href="sect.nfs-file-server.html#id-1.14.7.12">11.4.3. NFS Client</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.windows-file-server-with-samba.html">11.5. Setting Up Windows Shares with Samba</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#id-1.14.8.9">11.5.1. Samba Server</a></span></dt><dt><span
                    class="section"><a
                      href="sect.windows-file-server-with-samba.html#id-1.14.8.10">11.5.2. Samba Client</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.http-ftp-proxy.html">11.6. HTTP/FTP Proxy</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#id-1.14.9.8">11.6.1. Installing</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#id-1.14.9.9">11.6.2. Configuring a Cache</a></span></dt><dt><span
                    class="section"><a
                      href="sect.http-ftp-proxy.html#id-1.14.9.10">11.6.3. Configuring a Filter</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.ldap-directory.html">11.7. LDAP Directory</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#id-1.14.10.7">11.7.1. Installing</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#id-1.14.10.8">11.7.2. Filling in the Directory</a></span></dt><dt><span
                    class="section"><a
                      href="sect.ldap-directory.html#id-1.14.10.9">11.7.3. Managing Accounts with LDAP</a></span></dt></dl></dd><dt><span
                class="section"><a
                  href="sect.rtc-services.html">11.8. Real-Time Communication Services</a></span></dt><dd><dl><dt><span
                    class="section"><a
                      href="sect.rtc-services.html#sect.rtc-dns-settings">11.8.1. DNS settings for RTC services</a></span></dt><dt><span
                    class="section"><a
                      href="sect.rtc-services.html#sect.turn-server">11.8.2. TURN Server</a></span></dt><dt><span
                    class="section"><a
                      href="sect.rtc-services.html#sect.sip-server">11.8.3. SIP Proxy Server</a></span></dt><dt><span
                    class="section"><a
                      href="sect.rtc-services.html#sect.xmpp-server">11.8.4. XMPP Server</a></span></dt><dt><span
                    class="section"><a
                      href="sect.rtc-services.html#sect.rtc-port-443">11.8.5. Running services on port 443</a></span></dt><dt><span
                    class="section"><a
                      href="sect.rtc-services.html#sect.rtc-webrtc">11.8.6. Adding WebRTC</a></span></dt></dl></dd></dl></div><div
          class="highlights"><div
            class="para">
		Nettjenester er de programmene som brukerne direkte samhandler med i sitt daglige arbeid. De er toppen av informasjonssystemets isfjell, og dette kapittelet fokuserer på dem - de skjulte delene de er avhengige av er den infrastrukturen vi allerede har beskrevet.
	</div><div
            class="para">
		Mange moderne nettverkstjenester krever krypteringsteknologi for å fungere på en pålitelig og sikker måte, spesielt når de brukes på det offentlige Internettet. X.509 sertifikater (som også kan refereres til som SSLCertificates eller TLS-sertifikater) brukes ofte til dette formålet. Et sertifikat for et bestemt domene, kan ofte deles mellom mer enn en av tjenestene som er omtalt i dette kapittelet.
	</div><a
            id="id-1.14.3.3"
            class="indexterm"></a><a
            id="id-1.14.3.4"
            class="indexterm"></a><a
            id="id-1.14.3.5"
            class="indexterm"></a></div><div
          class="section"><div
            class="titlepage"><div><div><h2
                  class="title"><a
                    xmlns=""
                    id="sect.smtp-mail-server"></a>11.1. Posttjener</h2></div></div></div><div
            class="para">
			Falcot Corp administratorer valgte ut Postfix som elektronisk post-tjener, på grunn av påliteligheten og en enkel konfigurasjon. Faktisk, designet sikrer at hver oppgave blir gjennomført i en prosess med et minimumsett av nødvendige tillatelser, noe som gir en stor minsking i sikkerhetsproblemer.
		</div><a
            id="id-1.14.4.3"
            class="indexterm"></a><a
            id="id-1.14.4.4"
            class="indexterm"></a><a
            id="id-1.14.4.5"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>ALTERNATIVE</em></span> Exim4 tjeneren</strong></p></div></div></div><a
              id="id-1.14.4.6.2"
              class="indexterm"></a><div
              class="para">
			Debian bruker Exim4 som standard e-posttjener (som er grunnen til at den første installasjonen inkluderer Exim4). Konfigurasjonen er levert av en egen pakke, <span
                class="pkg pkg">exim4-config</span>, og tilpasses automatisk basert på svar på et sett med Debconf-spørsmål svært lik spørsmålene fra <span
                class="pkg pkg">postfix</span>-pakken.
		</div><div
              class="para">
			Konfigurasjonen kan enten være i en enkelt fil (<code
                class="filename">/etc/exim4/exim4.conf.template</code>) eller delt på tvers av en rekke konfigurasjonssnutter lagret under <code
                class="filename">/etc/exim4/conf.d/</code>. I begge tilfelle, brukes filene av <code
                class="command">update-exim4.conf</code> som maler for å generere <code
                class="filename">/var/lib/exim4/config.autogenerated</code>. Den sistnevnte er filen som brukes av Exim4. Takket være denne mekanismen, kan verdier som fås gjennom Exims debconf-konfigurasjon - som er lagret i <code
                class="filename">/etc/exim4/update-exim4.conf.conf</code> - legges inn i Exims konfigurasjonsfil, selv når administratoren eller en annen pakke har endret Exims standardoppsett.
		</div><div
              class="para">
			Exim4s konfigurasjonsfil-syntaks har sine særegenheter og sin læringskurve; Men når disse særegenheter blir forstått, er Exim4 en svært komplett og kraftig e-posttjener, noe som gjenspeiles av de titalls sidene med dokumentation. <div
                xmlns=""
                class="url">→ <a
                  xmlns="http://www.w3.org/1999/xhtml"
                  href="http://www.exim.org/docs.html">http://www.exim.org/docs.html</a></div>
		</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="id-1.14.4.7"></a>11.1.1. Å installere Postfix</h3></div></div></div><div
              class="para">
				<span
                class="pkg pkg">postfix</span>-pakken omfatter den viktigste SMTP-nissen. Andre pakker (slik som <span
                class="pkg pkg">postfix-ldap</span> og <span
                class="pkg pkg">postfix-pgsql</span>) legger til ekstra funksjonalitet til Postfix, medregnet tilgang til kartdatabaser. Du bør bare installere dem hvis du vet at du trenger dem.
			</div><div
              class="sidebar"><a
                xmlns=""
                id="sidebar.smtp"></a><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>BACK TO BASICS</em></span> SMTP</strong></p></div></div></div><a
                id="id-1.14.4.7.3.2"
                class="indexterm"></a><a
                id="id-1.14.4.7.3.3"
                class="indexterm"></a><a
                id="id-1.14.4.7.3.4"
                class="indexterm"></a><div
                class="para">
				SMTP (<span
                  class="emphasis"><em>Simple Mail Transfer Protocol</em></span>) er protokollen som brukes av e-posttjenere for å utveksle og rute e-poster.
			</div></div><div
              class="para">
				Flere Debconf-spørsmål stilles under installasjonen av pakken. Svarene tillater å generere en første versjon av <code
                class="filename">/etc/postfix/main.cf</code>-konfigureringsfil.
			</div><div
              class="para">
				Det første spørsmålet håndterer typen oppsett. Bare to av de foreslåtte svarene passer for en Internett-tilkoblet tjener, "Internet site" og "Internet with smartvert". Førstnevnte passer for en tjener som mottar innkommende e-post og sender utgående e-post direkte til sine mottakere, og er derfor godt tilpasset i Falcot Corps tilfelle. Sistnevnte passer for en tjener som å mottar innkommende e-post som normalt, men som sender utgående e-post via en mellomliggende SMTP-tjener - en "smartvert" - i stedet for direkte til mottakerens tjener. Dette er mest nyttig for personer med en dynamisk IP-adresse, siden mange e-posttjenere avviser meldinger som kommer rett fra en slik IP-adresse. I dette tilfellet vil en smartvert vanligvis være ISPs SMTP-tjener, som alltid er konfigurert til å godta e-post som kommer fra ISPs brukere og videresende den på riktig måte. Dette oppsettet (med smartvert) passer også for tjenere som ikke er permanent koblet til Internett, da det unngår å måtte håndtere en kø med ikke-leverbare meldinger som ikke kan leveres og som må prøves igjen senere.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>VOCABULARY</em></span> ISP</strong></p></div></div></div><a
                id="id-1.14.4.7.6.2"
                class="indexterm"></a><div
                class="para">
				ISP er en forkortelse for "Internet Service Provider". Den dekker en enhet, ofte et kommersielt selskap, som leverer Internett-tilkoblinger og tilhørende basistjenester (e-post, nyheter og så videre).
			</div><div
                class="para">
			</div></div><div
              class="para">
				Det andre spørsmålet omfatter det fulle navnet på maskinen, som brukes til å generere e-postadresser fra en lokal brukernavn; hele navnet på maskinen kommer opp som en del etter at-skiltet ("@"). For Falcots del, bør svaret være <code
                class="literal">mail.falcot.com</code>. Dette er det eneste spørsmålet ved oppstart, men oppsettet den fører til er ikke komplett nok for behovene til Falcot, noe som er grunnen til at administratorene kjører <code
                class="command">dpkg-reconfigure postfix</code> slik at man er i stand til å tilpasse flere parametre.
			</div><div
              class="para">
				Ett av de ekstra spørsmålene gjelder å få alle domenenavn knyttet til denne maskinen. Stanardlisten inneholder dets fulle navn, samt noen få synonymer for <code
                class="literal">localhost</code>, men hoved-domenet <code
                class="literal">falcot.com</code> må legges for hånd. Mer generelt bør dette spørsmålet vanligvis besvares med alle domene-navnene som denne maskinen skal tjene som MX-tjener for; med andre ord, alle domene-navnene for hvem DNS sier at denne maskinen vil akseptere e-post. Denne informasjonen ender opp i <code
                class="literal">mydestination</code>-variabelen i Postfixs hovedoppsettsfil - <code
                class="filename">/etc/postfix/main.cf</code>.
			</div><a
              id="id-1.14.4.7.9"
              class="indexterm"></a><a
              id="id-1.14.4.7.10"
              class="indexterm"></a><div
              class="figure"><a
                xmlns=""
                id="id-1.14.4.7.11"></a><div
                class="figure-contents"><div
                  class="mediaobject"><img
                    src="images/mail-server.png"
                    alt="Rollen til DNS MX-registering ved sending av en e-post" /></div></div><p
                class="title"><strong>Figur 11.1. Rollen til DNS <span
                    class="emphasis"><em>MX</em></span>-registering ved sending av en e-post</strong></p></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Å spørre MX-registreringene</strong></p></div></div></div><div
                class="para">
				Når DNS ikke har en MX-registrering for et domene, vil e-posttjeneren prøve å sende meldingene til verten selv ved hjelp av matchende A-posten (eller AAAA i IPv6).
			</div></div><div
              class="para">
				I noen tilfeller kan installasjonen også spørre hvilke nettverk som skal få lov til å sende e-post via maskinen. I standardkonfigurasjonen, aksepterer Postfix kun e-postmeldinger som kommer fra selve maskinen; det lokale nettverket vil vanligvis bli lagt til. Falcot Corp-administratorene la til <code
                class="literal">192.168.0.0/16</code> til standardsvaret. Hvis spørsmålet ikke er spurt, er den relevant variabel i konfigurasjonsfilen <code
                class="literal">mynetworks</code>, slik som i eksemplet nedenfor.
			</div><div
              class="para">
				Lokal e-post kan også leveres via <code
                class="command">procmail</code>. Dette verktøyet tillater brukere å sortere sin innkommende e-post etter regler som er lagret i deres <code
                class="filename">~/.procmailrc</code>-fil.
			</div><a
              id="id-1.14.4.7.15"
              class="indexterm"></a><a
              id="id-1.14.4.7.16"
              class="indexterm"></a><a
              id="id-1.14.4.7.17"
              class="indexterm"></a><div
              class="para">
				Etter dette første trinnet, får administratorene den etterfølgende konfigurasjonsfil; den vil bli brukt som et utgangspunkt for å legge til noe ekstra funksjonalitet i de neste seksjonene.
			</div><div
              class="example"><a
                xmlns=""
                id="id-1.14.4.7.19"></a><p
                class="title"><strong>Eksempel 11.1. Innledende <code
                    class="filename">/etc/postfix/main.cf</code>-fil</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SECURITY</em></span> <span
                          class="emphasis"><em>Snake oil</em></span> SSL certificates</strong></p></div></div></div><div
                class="para">
				<span
                  class="emphasis"><em>snake oil</em></span>-sertifikatene, som ble solgt som <span
                  class="emphasis"><em>snake oil</em></span>-“medisin” av skruppelløse kvakksalvere i gamle dager, har absolutt ingen verdi Du kan ikke stole på dem til å godkjenne tjeneren, for de automatisk blir generert med selvsignerte sertifikater. Men de er nyttige for å bedre personvernet ved utvekslingene.
			</div><div
                class="para">
				Generelt bør de bare brukes til testformål, og i vanlig drift må en bruke ekte sertifikater., Disse kan genereres med fremgangsmåten beskrevet i <a
                  class="xref"
                  href="sect.virtual-private-network.html#sect.easy-rsa">Seksjon 10.2.1.1, «Offentlig nøkke-infrastruktur: <span
                    class="emphasis"><em>easy-rsa</em></span>»</a>.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="sect.configuring-virtual-domains"></a>11.1.2. Å sette opp virtuelle domener</h3></div></div></div><a
              id="id-1.14.4.8.2"
              class="indexterm"></a><a
              id="id-1.14.4.8.3"
              class="indexterm"></a><div
              class="para">
				E-posttjeneren kan motta e-post adressert til andre domener i tillegg til hoveddomenet. Disse er da kjent som virtuelle domener. I de fleste tilfeller der dette skjer, blir e-postene i siste instans ikke destinert til lokale brukere. Postfix gir to interessante funksjoner for håndtering av virtuelle domener.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CAUTION</em></span> Virtuelle domener og "kanoniske" domener</strong></p></div></div></div><div
                class="para">
				Ingen av de virtuelle domener må være referert i <code
                  class="literal">mydestination</code>-variabelen. Denne variabelen inneholder kun navnene på "kanoniske" domener direkte knyttet til maskinen og dens lokale brukere.
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.8.6"></a>11.1.2.1. Vituelle alias-domener</h4></div></div></div><a
                id="id-1.14.4.8.6.2"
                class="indexterm"></a><a
                id="id-1.14.4.8.6.3"
                class="indexterm"></a><div
                class="para">
					Et virtuell alias-domene inneholder kun aliaser, dvs. adresser som bare videresender e-post til andre adresser.
				</div><div
                class="para">
					Et slikt domene aktiveres ved å legge navnet sitt til <code
                  class="literal">virtual_alias_domains</code>-variabelen, og vise til en adressekartleggingsfil i <code
                  class="literal">virtual_alias_maps</code>-variabelen.
				</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.8.6.6"></a><p
                  class="title"><strong>Eksempel 11.2. Direktiver til å legge i <code
                      class="filename">/etc/postfix/main.cf</code>-filen</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual
</pre></div></div><div
                class="para">
					<code
                  class="filename">/etc/postfix/virtual</code>-filen beskriver en kartlegging med en ganske grei syntaks: Hver linje inneholder to felt adskilt med mellomrom; Det første feltet er alias-navnet, det andre feltet er en liste over e-postadresser der det omdirigeres. Den spesielle <code
                  class="literal">@domain.com</code>-syntaksen dekker alle gjenstående aliaser i et domene.
				</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.8.6.8"></a><p
                  class="title"><strong>Eksempel 11.3. Eksempel <code
                      class="filename">/etc/postfix/virtual</code>-fil</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com
</pre></div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.8.7"></a>11.1.2.2. Virtuelle postboksdomener</h4></div></div></div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>CAUTION</em></span> Kombinert virtuelt domene?</strong></p></div></div></div><div
                  class="para">
					Postfix tillater ikke bruk av det samme domenet i både <code
                    class="literal">virtual_alias_domains</code> og <code
                    class="literal">virtual_mailbox_domains</code>. Imidlertid, alle domener hos <code
                    class="literal">virtual_mailbox_domains</code> er implisitt inkludert i <code
                    class="literal">virtual_alias_domains</code>, som gjør det mulig å blande aliaser og postkasser i et virtuelt domene.
				</div></div><a
                id="id-1.14.4.8.7.3"
                class="indexterm"></a><a
                id="id-1.14.4.8.7.4"
                class="indexterm"></a><div
                class="para">
					Meldinger adressert til et virtuell postboksdomene er lagret i postkasser som ikke er lagt til en lokal systembruker.
				</div><div
                class="para">
					Aktivering av et virtuell postboks domene krever navngiving av dette domenet i <code
                  class="literal">virtual_mailbox_domains</code>-variabelen, og refererer til en postkassekartleggingsfil i <code
                  class="literal">virtual_mailbox_maps</code>. <code
                  class="literal">virtual_mailbox_base</code>-parameteren inneholder katalogen der postkasser vil bli lagret.
				</div><div
                class="para">
					<code
                  class="literal">virtual_uid_maps</code>-parameteret (respektivt <code
                  class="literal">virtual_gid_maps</code>) refererer til filen som inneholder kartleggingen mellom e-postadressen og system-brukeren (henholdsvis -gruppen) som "eier" den tilsvarende postkassen. For å få alle postkasser som eies av samme eier/gruppe, tilordner <code
                  class="literal">static:5000</code> syntaksen en fast UID/GID (med verdien 5000 her).
				</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.8.7.8"></a><p
                  class="title"><strong>Eksempel 11.4. Direktiver til å legge i <code
                      class="filename">/etc/postfix/main.cf</code>-filen</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts
</pre></div></div><div
                class="para">
					Igjen, syntaksen til <code
                  class="filename">/etc/postfix/vmailbox</code>-filen er ganske enkel: To felt adskilt med mellomrom. Det første feltet er en e-postadresse i et av de virtuelle domene, og det andre feltet er plasseringen av den tilhørende postkasse (relativt til katalogen spesifisert i <span
                  class="emphasis"><em>virtual_mailbox_base</em></span>). Hvis postboksen ender med en skråstrek (<code
                  class="literal">/</code>), blir e-postene lagret i <span
                  class="emphasis"><em>maildir</em></span>-formatet; ellers blir det tradisjonelle <span
                  class="emphasis"><em>mbox</em></span>-formatet brukt. <span
                  class="emphasis"><em>maildir</em></span>-formatet bruker en hel katalog for å lagre en postkasse, hver enkelt melding blir lagret i en egen fil. I <span
                  class="emphasis"><em>mbox</em></span>-formatet, på den andre siden, er hele postboksen lagret i en fil, og hver linje som starter med “<code
                  class="literal">From </code>” (<code
                  class="literal">From</code> fulgt av et mellomrom) signaliserer starten på en ny e-post.
				</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.8.7.10"></a><p
                  class="title"><strong>Eksempel 11.5. <code
                      class="filename">/etc/postfix/vmailbox</code>-filen</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie
</pre></div></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="sect.restrictions-for-receiving-and-sending"></a>11.1.3. Restriksjoner for å motta og sende</h3></div></div></div><div
              class="para">
				Det økende antall uønsket e-post (<span
                class="emphasis"><em>spam</em></span>) krever større strenghet når man bestemmer hvilke e-postmeldinger en tjener bør akseptere. Denne seksjonen presenterer noen av de strategiene som inngår i Postfix.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>CULTURE</em></span> Spamproblemet</strong></p></div></div></div><a
                id="id-1.14.4.9.3.2"
                class="indexterm"></a><div
                class="para">
				"Spam" er et generelt begrep som brukes for å betegne alle uønskede kommersielle e-poster (også kjent som UCES) som oversvømmer våre elektroniske postkasser. De skruppelløse individer, som sender dem, er kjent som spammere. De bryr seg lite om de ordensforstyrrelser de forårsaker, siden det å sende en e-post koster svært lite, og bare en svært liten andel av mottakerne må være tiltrukket av tilbudene for at spamming-operasjon tjener mer penger enn det koster. Prosessen er for det meste automatisert, og en offentliggjort e-postadresse (for eksempel på et nettforum, registrert på en adresseliste, eller på en blogg, og så videre) vil bli oppdaget av spammeroboter, og utssatt for en endeløs strøm av uønskede meldinger.
			</div><div
                class="para">
				Alle systemadministratorer prøver å møte denne ordensforstyrrelser med spam-filtre, men selvfølgelig vil spammere holde seg oppdatert for å prøve å omgå disse filtrene. Noen leier til og med nettverk av maskiner kompromittert med en orm fra ulike kriminelle organisasjoner. Nyere statistikk anslår at opptil 95% av all e-post som sirkulerer på Internett er spam!
			</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.9.4"></a>11.1.3.1. IP-baserte adgangsrestriksjoner</h4></div></div></div><div
                class="para">
					<code
                  class="literal">smtpd_client_restrictions</code>-direktivet styrer hvilke maskiner som får lov til å kommunisere med e-posttjeneren.
				</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.9.4.3"></a><p
                  class="title"><strong>Eksempel 11.6. Restriksjoner basert på klientadresse</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org
</pre></div></div><div
                class="para">
					Når en variabel inneholder en liste med regler, som i eksempelet ovenfor, er disse reglene evaluert i rekkefølge fra den første til den siste. Hver regel kan akseptere meldingen, avvise den, eller overlate avgjørelsen til en følgende regel. Som en konsekvens, relkefølge betyr noe, og ganske enkelt å bytte om på to regler kan føre til et vidt forskjellig resultat.
				</div><div
                class="para">
					<code
                  class="literal">permit_mynetworks</code>-direktivet, brukt som den første regelen, godtar alle e-poster som kommer fra en maskin i det lokale nettverket (som definert av konfigureringsvariabelen <span
                  class="emphasis"><em>mynetworks</em></span>).
				</div><div
                class="para">
					Den andre direktivet vil normalt avvise e-post fra maskiner uten en helt gyldig DNS-konfigurasjon. En slik gyldig konfigurasjon betyr at IP-adressen kan løses til et navn, og at dette navnet i sin tur løser til IP-adressen. Denne begrensningen er ofte altfor streng, siden mange e-posttjenere vil ikke ha en omvendt DNS for deres IP-adresse. Dette forklarer hvorfor Falcot administratorer forvalgte <code
                  class="literal">warn_if_reject</code>modifikatoren til <code
                  class="literal">reject_unknown_client</code>-direktivet: Denne modifikatoren gjør om avvisningen til en enkel varsling registrert i loggene. Administratorene kan deretter holde et øye med antall meldinger som ville bli avvist hvis regelen ble faktisk ble håndhevet, og ta en avgjørelse senere hvis de ønsker å muliggjøre slik håndheving.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>TIP</em></span> <span
                            class="emphasis"><em>access</em></span> tabeller</strong></p></div></div></div><div
                  class="para">
					Restriksjonskriteriet omfatter administrator-modifiserbare tabeller som lister kombinasjoner av avsendere, IP-adresser, og tillatte eller forbudte vertsnavn. Disse tabellene kan opprettes fra en ukomprimert kopi av <code
                    class="filename">/usr/share/doc/postfix-doc/examples/access.gz</code>-filen. Denne modellen er selv dokumentert i sine kommentarer, noe som betyr hver tabell beskriver sin egen syntaks.
				</div><div
                  class="para">
					<code
                    class="filename">/etc/postfix/access_clientip</code>-tabellen viser IP-adresser og nettverk; <code
                    class="filename">/etc/postfix/access_helo</code> lister domenenavn; <code
                    class="filename">/etc/postfix/access_sender</code> inneholder avsender e-postadresser. Alle disse filene må bli omgjort til nøkkel-tabeller (et format som er optimalisert for rask tilgang) etter hver endring med <code
                    class="command">postmap /etc/postfix/<em
                      class="replaceable">file</em></code>-kommandoen.
				</div></div><div
                class="para">
					Den tredje direktivet lar administratoren å sette opp en svarteliste og en hviteliste med e-postservere, lagret i <code
                  class="filename">/etc/postfix/access_clientip</code>-filen. Tjenere i hvitelisten anses som klarert, og e-poster som kommer fra det derfor ikke gå gjennom følgende filtreringsregler.
				</div><div
                class="para">
					De to siste regler avviser enhver melding som kommer fra en tjener oppført i en av de angitte i svartelisten. RBL er en forkortelse for <span
                  class="emphasis"><em>Remote Black List</em></span>. Det er flere slike lister, men alle lister dårlig konfigurerte tjenere som spammere bruker for å videresende sin e-post, samt uventede post-formidlere, for eksempel maskiner infisert med ormer eller virus.
				</div><a
                id="id-1.14.4.9.4.10"
                class="indexterm"></a><a
                id="id-1.14.4.9.4.11"
                class="indexterm"></a><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>TIP</em></span> Hvitliste og RBL-er</strong></p></div></div></div><div
                  class="para">
					Svartelister omfatter noen ganger en legitim tjener som har vært offer en hendelse. I slike situasjoner vil alle e-poster som kommer fra en av disse tjenerne bli avvist dersom tjeneren er oppført i en hviteliste definert av <code
                    class="filename">/etc/postfix/access_clientip</code>.
				</div><div
                  class="para">
					Ut fra forsiktighetshensyn anbefales derfor å hviteliste alle klarerte tjenere som mange e-poster vanligvis kommer fra.
				</div></div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.9.5"></a>11.1.3.2. Sjekke validiteten til <code
                        class="literal">EHLO</code> eller <code
                        class="literal">HELO</code>-kommandoer</h4></div></div></div><div
                class="para">
					Hver SMTP-utveksling starter med en <code
                  class="literal">HELO</code> (eller <code
                  class="literal">EHLO</code>)-kommando, etterfulgt av navnet på e-posttjeneren som sender; Det kan være interessant å kontrollere gyldigheten av dette navnet.
				</div><a
                id="id-1.14.4.9.5.3"
                class="indexterm"></a><a
                id="id-1.14.4.9.5.4"
                class="indexterm"></a><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.9.5.5"></a><p
                  class="title"><strong>Eksempel 11.7. Restriksjoner på navnet som er meldt i <code
                      class="literal">EHLO</code></strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname
</pre></div></div><div
                class="para">
					Det første <code
                  class="literal">permit_mynetworks</code>-direktivet tillater at alle maskiner på det lokale nettverket fritt å legge seg til. Dette er viktig, fordi noen e-postprogrammer ikke respekterer denne delen av SMTP-protokollen godt nok, og de kan legge seg til med meningsløse navn.
				</div><div
                class="para">
					<code
                  class="literal">reject_invalid_hostname</code>-regelen avviser e-poster når <code
                  class="literal">EHLO</code>-visningen lister et vertsnavn med feilaktig syntaks. <code
                  class="literal">reject_non_fqdn_hostname</code>-regelen avviser meldinger når annonserte vertsnavn er ikke et fullt kvalifisert domenenavn (inkludert et domenenavn så vel som et vertsnavn). <code
                  class="literal">reject_unknown_hostname</code> regelen avviser meldinger hvis det annonserte navnet ikke finnes i DNS. Siden denne siste regelen dessverre fører til altfor mange avslag, snudde administratorene denne virkningen med en enkel advarsel ved hjelp av <code
                  class="literal">warn_if_reject</code>-modifikatoren som et første skritt; de kan fjerne denne modifikatoren på et senere tidspunkt, etter å ha gjennomgått resultatene av å bruke av regelen.
				</div><div
                class="para">
					Using <code
                  class="literal">permit_mynetworks</code> as the first rule has an interesting side effect: the following rules only apply to hosts outside the local network. This allows blacklisting all hosts that announce themselves as part of the <code
                  class="literal">falcot.com</code>, for instance by adding a <code
                  class="literal">falcot.com REJECT You are not in our network!</code> line to the <code
                  class="filename">/etc/postfix/access_helo</code> file.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.9.6"></a>11.1.3.3. Accepting or Refusing Based on the Announced Sender</h4></div></div></div><div
                class="para">
					Every message has a sender, announced by the <code
                  class="literal">MAIL FROM</code> command of the SMTP protocol; again, this information can be validated in several different ways.
				</div><a
                id="id-1.14.4.9.6.3"
                class="indexterm"></a><a
                id="id-1.14.4.9.6.4"
                class="indexterm"></a><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.9.6.5"></a><p
                  class="title"><strong>Eksempel 11.8. Sender checks</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender
</pre></div></div><div
                class="para">
					The <code
                  class="filename">/etc/postfix/access_sender</code> table maps some special treatment to some senders. This usually means listing some senders into a white list or a black list.
				</div><div
                class="para">
					The <code
                  class="literal">reject_unknown_sender_domain</code> rule requires a valid sender domain, since it is needed for a valid address. The <code
                  class="literal">reject_unlisted_sender</code> rule rejects local senders if the address does not exist; this prevents emails from being sent from an invalid address in the <code
                  class="literal">falcot.com</code> domain, and messages emanating from <code
                  class="literal">joe.bloggs@falcot.com</code> are only accepted if such an address really exists.
				</div><div
                class="para">
					Finally, the <code
                  class="literal">reject_non_fqdn_sender</code> rule rejects emails purporting to come from addresses without a fully-qualified domain name. In practice, this means rejecting emails coming from <code
                  class="literal">user@machine</code>: the address must be announced as either <code
                  class="literal">user@machine.example.com</code> or <code
                  class="literal">user@example.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.9.7"></a>11.1.3.4. Accepting or Refusing Based on the Recipient</h4></div></div></div><div
                class="para">
					Each email has at least one recipient, announced with the <code
                  class="literal">RCPT TO</code> command in the SMTP protocol. These addresses also warrant validation, even if that may be less relevant than the checks made on the sender address.
				</div><a
                id="id-1.14.4.9.7.3"
                class="indexterm"></a><a
                id="id-1.14.4.9.7.4"
                class="indexterm"></a><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.9.7.5"></a><p
                  class="title"><strong>Eksempel 11.9. Recipient checks</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient
</pre></div></div><div
                class="para">
					<code
                  class="literal">reject_unauth_destination</code> is the basic rule that requires outside messages to be addressed to us; messages sent to an address not served by this server are rejected. Without this rule, a server becomes an open relay that allows spammers to send unsolicited emails; this rule is therefore mandatory, and it will be best included near the beginning of the list, so that no other rules may authorize the message before its destination has been checked.
				</div><div
                class="para">
					The <code
                  class="literal">reject_unlisted_recipient</code> rule rejects messages sent to non-existing local users, which makes sense. Finally, the <code
                  class="literal">reject_non_fqdn_recipient</code> rule rejects non-fully-qualified addresses; this makes it impossible to send an email to <code
                  class="literal">jean</code> or <code
                  class="literal">jean@machine</code>, and requires using the full address instead, such as <code
                  class="literal">jean@machine.falcot.com</code> or <code
                  class="literal">jean@falcot.com</code>.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.9.8"></a>11.1.3.5. Restrictions Associated with the <code
                        class="literal">DATA</code> Command</h4></div></div></div><div
                class="para">
					The <code
                  class="literal">DATA</code> command of SMTP is emitted before the contents of the message. It doesn't provide any information per se, apart from announcing what comes next. It can still be subjected to checks.
				</div><a
                id="id-1.14.4.9.8.3"
                class="indexterm"></a><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.9.8.4"></a><p
                  class="title"><strong>Eksempel 11.10. <code
                      class="literal">DATA</code> checks</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
smtpd_data_restrictions = reject_unauth_pipelining
</pre></div></div><div
                class="para">
					The <code
                  class="literal">reject_unauth_pipelining</code> directives causes the message to be rejected if the sending party sends a command before the reply to the previous command has been sent. This guards against a common optimization used by spammer robots, since they usually don't care a fig about replies and only focus on sending as many emails as possible in as short a time as possible.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.9.9"></a>11.1.3.6. Applying Restrictions</h4></div></div></div><div
                class="para">
					Although the above commands validate information at various stages of the SMTP exchange, Postfix only sends the actual rejection as a reply to the <code
                  class="literal">RCPT TO</code> command.
				</div><div
                class="para">
					This means that even if the message is rejected due to an invalid <code
                  class="literal">EHLO</code> command, Postfix knows the sender and the recipient when announcing the rejection. It can then log a more explicit message than it could if the transaction had been interrupted from the start. In addition, a number of SMTP clients do not expect failures on the early SMTP commands, and these clients will be less disturbed by this late rejection.
				</div><div
                class="para">
					A final advantage to this choice is that the rules can accumulate information during the various stages of the SMTP exchange; this allows defining more fine-grained permissions, such as rejecting a non-local connection if it announces itself with a local sender.
				</div></div><div
              class="section"><div
                class="titlepage"><div><div><h4
                      class="title"><a
                        xmlns=""
                        id="id-1.14.4.9.10"></a>11.1.3.7. Filtering Based on the Message Contents</h4></div></div></div><div
                class="para">
					The validation and restriction system would not be complete without a way to apply checks to the message contents. Postfix differentiates the checks applying to the email headers from those applying to the email body.
				</div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.9.10.3"></a><p
                  class="title"><strong>Eksempel 11.11. Enabling content-based filters</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</pre></div></div><a
                id="id-1.14.4.9.10.4"
                class="indexterm"></a><div
                class="para">
					Both files contain a list of regular expressions (commonly known as <span
                  class="emphasis"><em>regexps</em></span> or <span
                  class="emphasis"><em>regexes</em></span>) and associated actions to be triggered when the email headers (or body) match the expression.
				</div><div
                class="sidebar"><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>QUICK LOOK</em></span> Regexp tables</strong></p></div></div></div><div
                  class="para">
					The <code
                    class="filename">/usr/share/doc/postfix-doc/examples/header_checks.gz</code> file contains many explanatory comments and can be used as a starting point for creating the <code
                    class="filename">/etc/postfix/header_checks</code> and <code
                    class="filename">/etc/postfix/body_checks</code> files.
				</div></div><div
                class="example"><a
                  xmlns=""
                  id="id-1.14.4.9.10.7"></a><p
                  class="title"><strong>Eksempel 11.12. Example <code
                      class="filename">/etc/postfix/header_checks</code> file</strong></p><div
                  class="example-contents"><pre
                    class="programlisting">
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</pre></div></div><div
                class="sidebar"><a
                  xmlns=""
                  id="sidebar.regexp"></a><div
                  class="titlepage"><div><div><p
                        class="title"><strong><span
                            class="emphasis"><em>BACK TO BASICS</em></span> Regular expression</strong></p></div></div></div><div
                  class="para">
					The <span
                    class="emphasis"><em>regular expression</em></span> term (shortened to <span
                    class="emphasis"><em>regexp</em></span> or <span
                    class="emphasis"><em>regex</em></span>) references a generic notation for expressing a description of the contents and/or structure of a string of characters. Certain special characters allow defining alternatives (for instance, <code
                    class="literal">foo|bar</code> matches either “foo” or “bar”), sets of allowed characters (for instance, <code
                    class="literal">[0-9]</code> means any digit, and <code
                    class="literal">.</code> — a dot — means any character), quantifications (<code
                    class="literal">s?</code> matches either <code
                    class="literal">s</code> or the empty string, in other words 0 or 1 occurrence of <code
                    class="literal">s</code>; <code
                    class="literal">s+</code> matches one or more consecutive <code
                    class="literal">s</code> characters; and so on). Parentheses allow grouping search results.
				</div><div
                  class="para">
					The precise syntax of these expressions varies across the tools using them, but the basic features are similar. <div
                    xmlns=""
                    class="url">→ <a
                      xmlns="http://www.w3.org/1999/xhtml"
                      href="http://en.wikipedia.org/wiki/Regular_expression">http://en.wikipedia.org/wiki/Regular_expression</a></div>
				</div></div><div
                class="para">
					The first one checks the header mentioning the email software; if <code
                  class="literal">GOTO Sarbacane</code> (a bulk email software) is found, the message is rejected. The second expression controls the message subject; if it mentions a virus notification, we can decide not to reject the message but to discard it immediately instead.
				</div><div
                class="para">
					Using these filters is a double-edged sword, because it is easy to make the rules too generic and to lose legitimate emails as a consequence. In these cases, not only the messages will be lost, but their senders will get unwanted (and annoying) error messages.
				</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="sect.setting-up-greylisting"></a>11.1.4. Setting Up <span
                      class="foreignphrase"><em
                        class="foreignphrase">greylisting</em></span></h3></div></div></div><a
              id="id-1.14.4.10.2"
              class="indexterm"></a><div
              class="para">
				“Greylisting” is a filtering technique according to which a message is initially rejected with a temporary error code, and only accepted on a further try after some delay. This filtering is particularly efficient against spam sent by the many machines infected by worms and viruses, since this software rarely acts as a full SMTP agent (by checking the error code and retrying failed messages later), especially since many of the harvested addresses are really invalid and retrying would only mean losing time.
			</div><div
              class="para">
				Postfix doesn't provide greylisting natively, but there is a feature by which the decision to accept or reject a given message can be delegated to an external program. The <span
                class="pkg pkg">postgrey</span> package contains just such a program, designed to interface with this access policy delegation service.
			</div><div
              class="para">
				Once <span
                class="pkg pkg">postgrey</span> is installed, it runs as a daemon and listens on port 10023. Postfix can then be configured to use it, by adding the <code
                class="literal">check_policy_service</code> parameter as an extra restriction:
			</div><pre
              class="programlisting">
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</pre><div
              class="para">
				Each time Postfix reaches this rule in the ruleset, it will connect to the <code
                class="command">postgrey</code> daemon and send it information concerning the relevant message. On its side, Postgrey considers the IP address/sender/recipient triplet and checks in its database whether that same triplet has been seen recently. If so, Postgrey replies that the message should be accepted; if not, the reply indicates that the message should be temporarily rejected, and the triplet gets recorded in the database.
			</div><div
              class="para">
				The main disadvantage of greylisting is that legitimate messages get delayed, which is not always acceptable. It also increases the burden on servers that send many legitimate emails.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRACTICE</em></span> Shortcomings of greylisting</strong></p></div></div></div><div
                class="para">
				Theoretically, greylisting should only delay the first mail from a given sender to a given recipient, and the typical delay is in the order of minutes. Reality, however, can differ slightly. Some large ISPs use clusters of SMTP servers, and when a message is initially rejected, the server that retries the transmission may not be the same as the initial one. When that happens, the second server gets a temporary error message due to greylisting too, and so on; it may take several hours until transmission is attempted by a server that has already been involved, since SMTP servers usually increase the delay between retries at each failure.
			</div><div
                class="para">
				As a consequence, the incoming IP address may vary in time even for a single sender. But it goes further: even the sender address can change. For instance, many mailing-list servers encode extra information in the sender address so as to be able to handle error messages (known as <span
                  class="emphasis"><em>bounces</em></span>). Each new message sent to a mailing-list may then need to go through greylisting, which means it has to be stored (temporarily) on the sender's server. For very large mailing-lists (with tens of thousands of subscribers), this can soon become a problem.
			</div><div
                class="para">
				To mitigate these drawbacks, Postgrey manages a whitelist of such sites, and messages emanating from them are immediately accepted without going through greylisting. This list can easily be adapted to local needs, since it is stored in the <code
                  class="filename">/etc/postgrey/whitelist_clients</code> file.
			</div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>GOING FURTHER</em></span> Selective greylisting with <span
                          class="pkg pkg">milter-greylist</span></strong></p></div></div></div><div
                class="para">
				The drawbacks of greylisting can be mitigated by only using greylisting on the subset of clients that are already considered as probable sources of spam (because they are listed in a DNS blacklist). This is not possible with <span
                  class="pkg pkg">postgrey</span> but <span
                  class="pkg pkg">milter-greylist</span> can be used in such a way.
			</div><div
                class="para">
				In that scenario, since DNS blacklists never triggers a definitive rejection, it becomes reasonable to use aggressive blacklists, including those listing all dynamic IP addresses from ISP clients (such as <code
                  class="literal">pbl.spamhaus.org</code> or <code
                  class="literal">dul.dnsbl.sorbs.net</code>).
			</div><div
                class="para">
				Since milter-greylist uses Sendmail's milter interface, the postfix side of its configuration is limited to “<code
                  class="literal">smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</code>”. The <span
                  class="citerefentry"><span
                    class="refentrytitle">greylist.conf</span>(5)</span> manual page documents <code
                  class="filename">/etc/milter-greylist/greylist.conf</code> and the numerous ways to configure milter-greylist. You will also have to edit <code
                  class="filename">/etc/default/milter-greylist</code> to actually enable the service.
			</div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="id-1.14.4.11"></a>11.1.5. Customizing Filters Based On the Recipient</h3></div></div></div><div
              class="para">
				<a
                class="xref"
                href="network-services.html#sect.restrictions-for-receiving-and-sending">Seksjon 11.1.3, «Restriksjoner for å motta og sende»</a> and <a
                class="xref"
                href="network-services.html#sect.setting-up-greylisting">Seksjon 11.1.4, «Setting Up <span
                  class="foreignphrase"><em
                    class="foreignphrase">greylisting</em></span>»</a> reviewed many of the possible restrictions. They all have their use in limiting the amount of received spam, but they also all have their drawbacks. It is therefore more and more common to customize the set of filters depending on the recipient. At Falcot Corp, greylisting is interesting for most users, but it hinders the work of some users who need low latency in their emails (such as the technical support service). Similarly, the commercial service sometimes has problems receiving emails from some Asian providers who may be listed in blacklists; this service asked for a non-filtered address so as to be able to correspond.
			</div><div
              class="para">
				Postfix provides such a customization of filters with a “restriction class” concept. The classes are declared in the <code
                class="literal">smtpd_restriction_classes</code> parameter, and defined the same way as <code
                class="literal">smtpd_recipient_restrictions</code>. The <code
                class="literal">check_recipient_access</code> directive then defines a table mapping a given recipient to the appropriate set of restrictions.
			</div><div
              class="example"><a
                xmlns=""
                id="id-1.14.4.11.4"></a><p
                class="title"><strong>Eksempel 11.13. Defining restriction classes in <code
                    class="filename">main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</pre></div></div><div
              class="example"><a
                xmlns=""
                id="id-1.14.4.11.5"></a><p
                class="title"><strong>Eksempel 11.14. The <code
                    class="filename">/etc/postfix/recipient_access</code> file</strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</pre></div></div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="sect.postfix-antivirus"></a>11.1.6. Integrating an Antivirus</h3></div></div></div><a
              id="id-1.14.4.12.2"
              class="indexterm"></a><div
              class="para">
				The many viruses circulating as attachments to emails make it important to set up an antivirus at the entry point of the company network, since despite an awareness campaign, some users will still open attachments from obviously shady messages.
			</div><div
              class="para">
				The Falcot administrators selected <code
                class="command">clamav</code> for their free antivirus. The main package is <span
                class="pkg pkg">clamav</span>, but they also installed a few extra packages such as <span
                class="pkg pkg">arj</span>, <span
                class="pkg pkg">unzoo</span>, <span
                class="pkg pkg">unrar</span> and <span
                class="pkg pkg">lha</span>, since they are required for the antivirus to analyze attachments archived in one of these formats.
			</div><a
              id="id-1.14.4.12.5"
              class="indexterm"></a><a
              id="id-1.14.4.12.6"
              class="indexterm"></a><div
              class="para">
				The task of interfacing between antivirus and the email server goes to <code
                class="command">clamav-milter</code>. A <span
                class="emphasis"><em>milter</em></span> (short for <span
                class="emphasis"><em>mail filter</em></span>) is a filtering program specially designed to interface with email servers. A milter uses a standard application programming interface (API) that provides much better performance than filters external to the email servers. Milters were initially introduced by <span
                class="emphasis"><em>Sendmail</em></span>, but <span
                class="emphasis"><em>Postfix</em></span> soon followed suit.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>QUICK LOOK</em></span> A milter for Spamassassin</strong></p></div></div></div><a
                id="id-1.14.4.12.8.2"
                class="indexterm"></a><div
                class="para">
				The <span
                  class="pkg pkg">spamass-milter</span> package provides a milter based on <span
                  class="emphasis"><em>SpamAssassin</em></span>, the famous unsolicited email detector. It can be used to flag messages as probable spams (by adding an extra header) and/or to reject the messages altogether if their “spamminess” score goes beyond a given threshold.
			</div></div><div
              class="para">
				Once the <span
                class="pkg pkg">clamav-milter</span> package is installed, the milter should be reconfigured to run on a TCP port rather than on the default named socket. This can be achieved with <code
                class="command">dpkg-reconfigure clamav-milter</code>. When prompted for the “Communication interface with Sendmail”, answer “<code
                class="literal">inet:10002@127.0.0.1</code>”.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTE</em></span> Real TCP port vs named socket</strong></p></div></div></div><div
                class="para">
				The reason why we use a real TCP port rather than the named socket is that the postfix daemons often run chrooted and do not have access to the directory hosting the named socket. You could also decide to keep using a named socket and pick a location within the chroot (<code
                  class="filename">/var/spool/postfix/</code>).
			</div></div><div
              class="para">
				The standard ClamAV configuration fits most situations, but some important parameters can still be customized with <code
                class="command">dpkg-reconfigure clamav-base</code>.
			</div><div
              class="para">
				The last step involves telling Postfix to use the recently-configured filter. This is a simple matter of adding the following directive to <code
                class="filename">/etc/postfix/main.cf</code>:
			</div><pre
              class="programlisting">
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</pre><div
              class="para">
				If the antivirus causes problems, this line can be commented out, and <code
                class="command">service postfix reload</code> should be run so that this change is taken into account.
			</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>IN PRACTICE</em></span> Testing the antivirus</strong></p></div></div></div><div
                class="para">
				Once the antivirus is set up, its correct behavior should be tested. The simplest way to do that is to send a test email with an attachment containing the <code
                  class="filename">eicar.com</code> (or <code
                  class="filename">eicar.com.zip</code>) file, which can be downloaded online: <div
                  xmlns=""
                  class="url">→ <a
                    xmlns="http://www.w3.org/1999/xhtml"
                    href="http://www.eicar.org/86-0-Intended-use.html">http://www.eicar.org/86-0-Intended-use.html</a></div>
			</div><div
                class="para">
				This file is not a true virus, but a test file that all antivirus software on the market diagnose as a virus to allow checking installations.
			</div></div><div
              class="para">
				All messages handled by Postfix now go through the antivirus filter.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h3
                    class="title"><a
                      xmlns=""
                      id="sect.authenticated-smtp"></a>11.1.7. Authenticated SMTP</h3></div></div></div><div
              class="para">
				Being able to send emails requires an SMTP server to be reachable; it also requires said SMTP server to send emails through it. For roaming users, this may need regularly changing the configuration of the SMTP client, since Falcot's SMTP server rejects messages coming from IP addresses apparently not belonging to the company. Two solutions exist: either the roaming user installs an SMTP server on their computer, or they still use the company server with some means of authenticating as an employee. The former solution is not recommended since the computer won't be permanently connected, and it won't be able to retry sending messages in case of problems; we will focus on the latter solution.
			</div><div
              class="para">
				SMTP authentication in Postfix relies on SASL (<span
                class="emphasis"><em>Simple Authentication and Security Layer</em></span>). It requires installing the <span
                class="pkg pkg">libsasl2-modules</span> and <span
                class="pkg pkg">sasl2-bin</span> packages, then registering a password in the SASL database for each user that needs authenticating on the SMTP server. This is done with the <code
                class="command">saslpasswd2</code> command, which takes several parameters. The <code
                class="literal">-u</code> option defines the authentication domain, which must match the <code
                class="literal">smtpd_sasl_local_domain</code> parameter in the Postfix configuration. The <code
                class="literal">-c</code> option allows creating a user, and <code
                class="literal">-f</code> allows specifying the file to use if the SASL database needs to be stored at a different location than the default (<code
                class="filename">/etc/sasldb2</code>).
			</div><pre
              class="screen scale">
<code
                class="computeroutput"># </code><strong
                class="userinput"><code>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</code></strong>
<code
                class="computeroutput">[... type jean's password twice ...]</code></pre><div
              class="para">
				Note that the SASL database was created in Postfix's directory. In order to ensure consistency, we also turn <code
                class="filename">/etc/sasldb2</code> into a symbolic link pointing at the database used by Postfix, with the <code
                class="command">ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</code> command.
			</div><div
              class="para">
				Now we need to configure Postfix to use SASL. First the <code
                class="literal">postfix</code> user needs to be added to the <code
                class="literal">sasl</code> group, so that it can access the SASL account database. A few new parameters are also needed to enable SASL, and the <code
                class="literal">smtpd_recipient_restrictions</code> parameter needs to be configured to allow SASL-authenticated clients to send emails freely.
			</div><div
              class="example"><a
                xmlns=""
                id="id-1.14.4.13.7"></a><p
                class="title"><strong>Eksempel 11.15. Enabling SASL in <code
                    class="filename">/etc/postfix/main.cf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>EXTRA</em></span> Authenticated SMTP client</strong></p></div></div></div><div
                class="para">
				Most email clients are able to authenticate to an SMTP server before sending outgoing messages, and using that feature is a simple matter of configuring the appropriate parameters. If the client in use does not provide that feature, the workaround is to use a local Postfix server and configure it to relay email via the remote SMTP server. In this case, the local Postfix itself will be the client that authenticates with SASL. Here are the required parameters:
			</div><pre
                class="programlisting">
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</pre><div
                class="para">
				The <code
                  class="filename">/etc/postfix/sasl_passwd</code> file needs to contain the username and password to use for authenticating on the <code
                  class="literal">mail.falcot.com</code> server. Here is an example:
			</div><pre
                class="programlisting">
[mail.falcot.com]   joe:LyinIsji
</pre><div
                class="para">
				As for all Postfix maps, this file must be turned into <code
                  class="filename">/etc/postfix/sasl_passwd.db</code> with the <code
                  class="command">postmap</code> command.
			</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.network-diagnosis-tools.html"><strong>Forrige</strong>10.8. Diagnoseverktøy for nettverk</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Opp</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Hjem</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.http-web-server.html"><strong>Neste</strong>11.2. Web Server (HTTP)</a></li></ul></body></html>
