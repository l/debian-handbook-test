<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">14.4. Introduzione a AppArmor</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-it-IT-1.0-1" /><meta
        name="keywords"
        content="Firewall, Netfilter, IDS/NIDS" /><link
        rel="home"
        href="index.html"
        title="Il Manuale dell'Amministratore Debian" /><link
        rel="up"
        href="security.html"
        title="Capitolo 14. Sicurezza" /><link
        rel="prev"
        href="sect.supervision.html"
        title="14.3. Supervisione: prevenire, rilevare, dissuadere" /><link
        rel="next"
        href="sect.selinux.html"
        title="14.5. Introduzione a SELinux" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/it-IT/stable/sect.apparmor.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.supervision.html"><strong>Indietro</strong></a></li><li
          class="home">Il Manuale dell'Amministratore Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.selinux.html"><strong>Avanti</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.apparmor"></a>14.4. Introduzione a AppArmor</h2></div></div></div><a
          id="id-1.17.7.2"
          class="indexterm"></a><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.apparmor-principles"></a>14.4.1. Princìpi</h3></div></div></div><div
            class="para">
				AppArmor è un sistema di <span
              class="emphasis"><em>Mandatory Access Control (Controllo Accesso Obbligatorio)</em></span> costruito sull'interfaccia LSM (<span
              class="emphasis"><em>Linux Security Modules</em></span>) di Linux. In pratica, il kernel interroga AppArmor prima di ogni chiamata di sistema per sapere se il processo è autorizzato ad eseguire una data operazione. Attraverso questo meccanismo, AppArmor confina programmi ad una serie limitata di risorse.
			</div><a
            id="id-1.17.7.3.3"
            class="indexterm"></a><a
            id="id-1.17.7.3.4"
            class="indexterm"></a><div
            class="para">
				AppArmor applica una serie di regole (note come "profilo") su ciascun programma. Il profilo applicato dal kernel dipende dal percorso di installazione del programma in esecuzione. Al contrario di SELinux (discusso nella <a
              class="xref"
              href="sect.selinux.html">Sezione 14.5, «Introduzione a SELinux»</a>), le norme applicate non dipendono l'utente. Tutti gli utenti devono sottostare allo stesso insieme di regole quando è in esecuzione lo stesso programma (ma le autorizzazioni utente tradizionali sono ancora valide e potrebbero causare un comportamento diverso!).
			</div><div
            class="para">
				I profili AppArmor sono memorizzati in <code
              class="filename">/etc/apparmor.d/</code> e contengono un elenco delle regole di controllo d'accesso alle risorse che ogni programma può utilizzare. I profili sono compilati e caricati nel kernel dal comando <code
              class="command">apparmor_parser</code>. Ogni profilo può essere caricato sia in esecuzione sia in complaining mode. La prima fa rispettare la policy e registra i tentativi di violazione, mentre la seconda non applica la policy ma registra sempre le chiamate di sistema che sarebbero state negate.
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.apparmor-setup"></a>14.4.2. Abilitazione di AppArmor e gestione dei profili di AppArmor</h3></div></div></div><div
            class="para">
				Supporto ad AppArmor è integrato nei kernel standard forniti da Debian. Abilitazione AppArmor è quindi solo una questione di installare alcuni pacchetti e l'aggiunta di alcuni parametri alla riga di comando del kernel:
			</div><pre
            class="screen"><code
              class="computeroutput"># </code><strong
              class="userinput"><code>apt install apparmor apparmor-profiles apparmor-utils
</code></strong><code
              class="computeroutput">[...]
# </code><strong
              class="userinput"><code>perl -pi -e 's,GRUB_CMDLINE_LINUX="(.*)"$,GRUB_CMDLINE_LINUX="$1 apparmor=1 security=apparmor",' /etc/default/grub
</code></strong><code
              class="computeroutput"># </code><strong
              class="userinput"><code>update-grub
</code></strong></pre><div
            class="para">
				Dopo un riavvio, AppArmor è funzionante e <code
              class="command">aa-status</code> lo confermerà in fretta:
			</div><pre
            class="screen">
<code
              class="computeroutput"># </code><strong
              class="userinput"><code>aa-status</code></strong>
<code
              class="computeroutput">apparmor module is loaded.
44 profiles are loaded.
9 profiles are in enforce mode.
   /usr/bin/lxc-start
   /usr/lib/chromium-browser/chromium-browser//browser_java
[...]
35 profiles are in complain mode.
   /sbin/klogd
[...]
3 processes have profiles defined.
1 processes are in enforce mode.
   /usr/sbin/libvirtd (1295) 
2 processes are in complain mode.
   /usr/sbin/avahi-daemon (941) 
   /usr/sbin/avahi-daemon (1000) 
0 processes are unconfined but have a profile defined.</code></pre><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>NOTA</em></span> Altri profili AppArmor</strong></p></div></div></div><div
              class="para">
				Il pacchetto <span
                class="pkg pkg">apparmor-profiles</span> contiene i profili gestiti a monte dalla comunità AppArmor. Per ottenere ancora più profili è possibile installare <span
                class="pkg pkg">apparmor-profiles-extra</span> che contiene i profili sviluppati da Ubuntu e Debian.
			</div></div><div
            class="para">
				Lo stato di ogni profilo può essere scambiato tra la modalità enforce e complain con le chiamate di <code
              class="command">aa-enforce</code> e <code
              class="command">aa-complain</code> passando come parametro o il percorso del file eseguibile oppure il percorso del file della policy. Inoltre un profilo può essere completamente disabilitato con <code
              class="command">aa-disable</code> o messo in modalità di controllo (per registrare anche le chiamate di sistema accettate) con <code
              class="command">aa-audit</code>.
			</div><pre
            class="screen">
<code
              class="computeroutput"># </code><strong
              class="userinput"><code>aa-enforce /usr/sbin/avahi-daemon</code></strong>
<code
              class="computeroutput">Setting /usr/sbin/avahi-daemon to enforce mode.</code>
<code
              class="computeroutput"># </code><strong
              class="userinput"><code>aa-complain /etc/apparmor.d/usr.bin.lxc-start</code></strong>
<code
              class="computeroutput">Setting /etc/apparmor.d/usr.bin.lxc-start to complain mode.</code>
</pre></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.apparmor-new-profile"></a>14.4.3. Creare un nuovo profilo</h3></div></div></div><div
            class="para">
				Anche se la creazione di un profilo di AppArmor è piuttosto facile, la maggior parte dei programmi non ne hanno uno. In questa sezione verròà mostrato come creare un nuovo profilo da zero solo utilizzando il programma di destinazione e lasciando che AppArmor monitori le chiamate che il sistema fa e le risorse a cui accede.
			</div><div
            class="para">
				I programmi più importanti che devono essere monitorati sono i programmi che si affacciano sulla rete che come tali sono i più probabili obiettivi di aggressori remoti. Per questo AppArmor fornisce il comodo comando <code
              class="command">aa-unconfined</code> per elencare i programmi che non hanno un profilo associato che sono esposti ad un socket di rete aperto. Con l'opzione <code
              class="literal">--paranoid</code> si ottengono tutti i processi non confinati che hanno una connessione di rete attiva.
			</div><pre
            class="screen">
<code
              class="computeroutput"># </code><strong
              class="userinput"><code>aa-unconfined</code></strong>
<code
              class="computeroutput">801 /sbin/dhclient not confined
890 /sbin/rpcbind not confined
899 /sbin/rpc.statd not confined
929 /usr/sbin/sshd not confined
941 /usr/sbin/avahi-daemon confined by '/usr/sbin/avahi-daemon (complain)'
988 /usr/sbin/minissdpd not confined
1276 /usr/sbin/exim4 not confined
1485 /usr/lib/erlang/erts-6.2/bin/epmd not confined
1751 /usr/lib/erlang/erts-6.2/bin/beam.smp not confined
19592 /usr/lib/dleyna-renderer/dleyna-renderer-service not confined</code>
</pre><div
            class="para">
				Nell'esempio seguente, cercheremo quindi di creare un profilo per <code
              class="command">/sbin/dhclient</code>. Per questo useremo <code
              class="command">aa-genprof dhclient</code>. Vi invitiamo ad utilizzare l'applicazione in un'altra finestra e una volta finito tornare a <code
              class="command">aa-genprof</code> per cercare eventi AppArmor nei log di sistema e convertire quei log in regole d'accesso. Per ogni evento registrato, verranno suggerite una o più regole che è possibile approvare o modificare ulteriormente in diversi modi:
			</div><pre
            class="screen">
<code
              class="computeroutput"># </code><strong
              class="userinput"><code>aa-genprof dhclient</code></strong>
<code
              class="computeroutput">Writing updated profile for /sbin/dhclient.
Setting /sbin/dhclient to complain mode.

Before you begin, you may wish to check if a
profile already exists for the application you
wish to confine. See the following wiki page for
more information:
http://wiki.apparmor.net/index.php/Profiles

Please start the application to be profiled in
another window and exercise its functionality now.

Once completed, select the "Scan" option below in 
order to scan the system logs for AppArmor events. 

For each AppArmor event, you will be given the 
opportunity to choose whether the access should be 
allowed or denied.

Profiling: /sbin/dhclient

[(S)can system log for AppArmor events] / (F)inish
Reading log entries from /var/log/audit/audit.log.

Profile:  /sbin/dhclient <span
                id="aa-genprof-execute"><img
                  class="callout"
                  src="Common_Content/images/1.png"
                  alt="1" /></span>
Execute:  /usr/lib/NetworkManager/nm-dhcp-helper
Severity: unknown

(I)nherit / (C)hild / (P)rofile / (N)amed / (U)nconfined / (X) ix On / (D)eny / Abo(r)t / (F)inish
<strong
                class="userinput"><code>P</code></strong>
Should AppArmor sanitise the environment when
switching profiles?

Sanitising environment is more secure,
but some applications depend on the presence
of LD_PRELOAD or LD_LIBRARY_PATH.

(Y)es / [(N)o]
<strong
                class="userinput"><code>Y</code></strong>
Writing updated profile for /usr/lib/NetworkManager/nm-dhcp-helper.
Complain-mode changes:
WARN: unknown capability: CAP_net_raw

Profile:    /sbin/dhclient <span
                id="aa-genprof-capability"><img
                  class="callout"
                  src="Common_Content/images/2.png"
                  alt="2" /></span>
Capability: net_raw
Severity:   unknown

[(A)llow] / (D)eny / (I)gnore / Audi(t) / Abo(r)t / (F)inish
<strong
                class="userinput"><code>A</code></strong>
Adding capability net_raw to profile.

Profile:  /sbin/dhclient <span
                id="aa-genprof-read"><img
                  class="callout"
                  src="Common_Content/images/3.png"
                  alt="3" /></span>
Path:     /etc/nsswitch.conf
Mode:     r
Severity: unknown

  1 - #include &lt;abstractions/apache2-common&gt; 
  2 - #include &lt;abstractions/libvirt-qemu&gt; 
  3 - #include &lt;abstractions/nameservice&gt; 
  4 - #include &lt;abstractions/totem&gt; 
 [5 - /etc/nsswitch.conf]
[(A)llow] / (D)eny / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Abo(r)t / (F)inish / (M)ore
<strong
                class="userinput"><code>3</code></strong>

Profile:  /sbin/dhclient
Path:     /etc/nsswitch.conf
Mode:     r
Severity: unknown

  1 - #include &lt;abstractions/apache2-common&gt; 
  2 - #include &lt;abstractions/libvirt-qemu&gt; 
 [3 - #include &lt;abstractions/nameservice&gt;]
  4 - #include &lt;abstractions/totem&gt; 
  5 - /etc/nsswitch.conf 
[(A)llow] / (D)eny / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Abo(r)t / (F)inish / (M)ore
<strong
                class="userinput"><code>A</code></strong>
Adding #include &lt;abstractions/nameservice&gt; to profile.

Profile:  /sbin/dhclient
Path:     /proc/7252/net/dev
Mode:     r
Severity: 6

  1 - /proc/7252/net/dev 
 [2 - /proc/*/net/dev]
[(A)llow] / (D)eny / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Abo(r)t / (F)inish / (M)ore
<strong
                class="userinput"><code>A</code></strong>
Adding /proc/*/net/dev r to profile

[...]
Profile:  /sbin/dhclient <span
                id="aa-genprof-write"><img
                  class="callout"
                  src="Common_Content/images/4.png"
                  alt="4" /></span>
Path:     /run/dhclient-eth0.pid
Mode:     w
Severity: unknown

 [1 - /run/dhclient-eth0.pid]
[(A)llow] / (D)eny / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Abo(r)t / (F)inish / (M)ore
<strong
                class="userinput"><code>N</code></strong>

Enter new path: /run/dhclient*.pid

Profile:  /sbin/dhclient
Path:     /run/dhclient-eth0.pid
Mode:     w
Severity: unknown

  1 - /run/dhclient-eth0.pid 
 [2 - /run/dhclient*.pid]
[(A)llow] / (D)eny / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Abo(r)t / (F)inish / (M)ore
<strong
                class="userinput"><code>A</code></strong>
Adding /run/dhclient*.pid w to profile

[...]
Profile:  /usr/lib/NetworkManager/nm-dhcp-helper <span
                id="aa-genprof-other-profile"><img
                  class="callout"
                  src="Common_Content/images/5.png"
                  alt="5" /></span>
Path:     /proc/filesystems
Mode:     r
Severity: 6

 [1 - /proc/filesystems]
[(A)llow] / (D)eny / (I)gnore / (G)lob / Glob with (E)xtension / (N)ew / Abo(r)t / (F)inish / (M)ore
<strong
                class="userinput"><code>A</code></strong>
Adding /proc/filesystems r to profile

= Changed Local Profiles =

The following local profiles were changed. Would you like to save them?

 [1 - /sbin/dhclient]
  2 - /usr/lib/NetworkManager/nm-dhcp-helper 
(S)ave Changes / Save Selec(t)ed Profile / [(V)iew Changes] / View Changes b/w (C)lean profiles / Abo(r)t
<strong
                class="userinput"><code>S</code></strong>
Writing updated profile for /sbin/dhclient.
Writing updated profile for /usr/lib/NetworkManager/nm-dhcp-helper.

Profiling: /sbin/dhclient

[(S)can system log for AppArmor events] / (F)inish
<strong
                class="userinput"><code>F</code></strong>
Setting /sbin/dhclient to enforce mode.
Setting /usr/lib/NetworkManager/nm-dhcp-helper to enforce mode.

Reloaded AppArmor profiles in enforce mode.

Please consider contributing your new profile!
See the following wiki page for more information:
http://wiki.apparmor.net/index.php/Profiles

Finished generating profile for /sbin/dhclient.</code></pre><div
            class="para">
				Notare che il programma non visualizza i caratteri di controllo indietro che si digitano ma per la chiarezza espositiva sono stati inclusi nella trascrizione precedente.
			</div><div
            class="calloutlist"><table
              border="0"
              summary="Callout list"><tr><td
                  width="5%"
                  valign="top"
                  align="left"><p><a
                      href="#aa-genprof-execute"><img
                        class="callout"
                        src="Common_Content/images/1.png"
                        alt="1" /></a> </p></td><td
                  valign="top"
                  align="left"><div
                    class="para">
						Il primo evento rilevato è l'esecuzione di un altro programma. In tal caso, si dispone di più opzioni: è possibile eseguire il programma con il profilo del processo padre (la scelta “Inherit”), è possibile eseguirlo con il proprio profilo dedicato (le scelte "Profile" e "Named", differiscono solo per la possibilità di utilizzare un nome di profilo arbitrario), è possibile eseguirlo con un sub-profilo del processo padre (la scelta "Child"), è possibile eseguirlo senza alcun profilo (la scelta "Unconfined") o si può decidere di non farlo eseguire a nessuno (la scelta "Deny").
					</div><div
                    class="para">
						Si noti che quando si sceglie di eseguire il programma sotto un profilo dedicato che non esiste ancora, lo strumento creerà il profilo mancante per voi ed allo stesso tempo proporrà delle regole per tale profilo.
					</div></td></tr><tr><td
                  width="5%"
                  valign="top"
                  align="left"><p><a
                      href="#aa-genprof-capability"><img
                        class="callout"
                        src="Common_Content/images/2.png"
                        alt="2" /></a> </p></td><td
                  valign="top"
                  align="left"><div
                    class="para">
						A livello di kernel, i poteri speciali dell'utente root vengono suddivisi in "capacità". Quando una chiamata di sistema richiede una capacità specifica, AppArmor verificherà se il profilo permette al programma di fare uso di questa capacità.
					</div></td></tr><tr><td
                  width="5%"
                  valign="top"
                  align="left"><p><a
                      href="#aa-genprof-read"><img
                        class="callout"
                        src="Common_Content/images/3.png"
                        alt="3" /></a> </p></td><td
                  valign="top"
                  align="left"><div
                    class="para">
						Qui il programma cerca le autorizzazioni di lettura per <code
                      class="filename">/etc/nsswitch.conf</code>. <code
                      class="command">aa-genprof</code> ha rilevato che questo permesso è stato concesso anche da "astrazioni" multiple e le offre come scelte alternative. Un'astrazione fornisce un insieme riutilizzabile di regole di accesso raggruppando più risorse che sono di solito utilizzate insieme. In questo caso specifico, il file è generalmente reso accessibile attraverso le funzioni NameService relative della libreria C e digitiamo "3" per selezionare prima la scelta “#include &lt;astrazioni/nomeservizio&gt;” e poi "A" per consentirla.
					</div></td></tr><tr><td
                  width="5%"
                  valign="top"
                  align="left"><p><a
                      href="#aa-genprof-write"><img
                        class="callout"
                        src="Common_Content/images/4.png"
                        alt="4" /></a> </p></td><td
                  valign="top"
                  align="left"><div
                    class="para">
						Il programma cerca di creare il file <code
                      class="filename">/run/dhclient-eth0.pid</code>. Se permettiamo la creazione di questo specifico file soltanto, il programma non funzionerà quando l'utente utilizzerà un'altra interfaccia di rete. Così selezioniamo "Nuovo" per sostituire il nome del file con il "/run/ddclient*.pid" più generico prima di registrare il dominio con "Consenti".
					</div></td></tr><tr><td
                  width="5%"
                  valign="top"
                  align="left"><p><a
                      href="#aa-genprof-other-profile"><img
                        class="callout"
                        src="Common_Content/images/5.png"
                        alt="5" /></a> </p></td><td
                  valign="top"
                  align="left"><div
                    class="para">
						Si noti che la richiesta di accesso non è parte del profilo dhclient ma del nuovo profilo che abbiamo creato quando abbiamo permesso a <code
                      class="filename">/usr/lib/NetworkManager/nm-dhcp-helper</code> di essere eseguito con il proprio profilo.
					</div><div
                    class="para">
						Dopo aver percorso tutti gli eventi registrati, il programma propone di salvare tutti i profili che sono stati creati durante l'esecuzione. In questo caso, abbiamo due profili che sono salvati in una volta con "Salva" (ma si possono salvare anche singolarmente) prima di lasciare il programma con "Fine".
					</div></td></tr></table></div><div
            class="para">
				<code
              class="command">aa-genprof</code> è in realtà solo un modulo intelligente intorno a <code
              class="command">aa-logprof</code>: esso crea un profilo vuoto, lo carica in modalità compain ed esegue <code
              class="command">aa-logprof</code> che è uno strumento per aggiornare il profilo in base alle violazioni del profilo che sono state registrate. Così in seguito si può eseguire nuovamente questo strumento per migliorare il profilo appena creato.
			</div><div
            class="para">
				Se si desidera che il profilo generato sia completo, è necessario utilizzare il programma in tutti i modi legittimamente possibili. Nel caso di dhclient, significa eseguirlo tramite Network Manager, eseguirlo tramite ifupdown, eseguirlo manualmente, ecc Alla fine, si potrebbe ottenere un <code
              class="filename">/etc/apparmor.d/sbin.dhclient</code> simile a questo:
			</div><pre
            class="programlisting">
# Last Modified: Tue Sep  8 21:40:02 2015
#include &lt;tunables/global&gt;

/sbin/dhclient {
  #include &lt;abstractions/base&gt;
  #include &lt;abstractions/nameservice&gt;

  capability net_bind_service,
  capability net_raw,

  /bin/dash r,
  /etc/dhcp/* r,
  /etc/dhcp/dhclient-enter-hooks.d/* r,
  /etc/dhcp/dhclient-exit-hooks.d/* r,
  /etc/resolv.conf.* w,
  /etc/samba/dhcp.conf.* w,
  /proc/*/net/dev r,
  /proc/filesystems r,
  /run/dhclient*.pid w,
  /sbin/dhclient mr,
  /sbin/dhclient-script rCx,
  /usr/lib/NetworkManager/nm-dhcp-helper Px,
  /var/lib/NetworkManager/* r,
  /var/lib/NetworkManager/*.lease rw,
  /var/lib/dhcp/*.leases rw,

  profile /sbin/dhclient-script flags=(complain) {
    #include &lt;abstractions/base&gt;
    #include &lt;abstractions/bash&gt;

    /bin/dash rix,
    /etc/dhcp/dhclient-enter-hooks.d/* r,
    /etc/dhcp/dhclient-exit-hooks.d/* r,
    /sbin/dhclient-script r,

  }
}
</pre></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.supervision.html"><strong>Indietro</strong>14.3. Supervisione: prevenire, rilevare, dissuade...</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Risali</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Partenza</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.selinux.html"><strong>Avanti</strong>14.5. Introduzione a SELinux</a></li></ul></body></html>
