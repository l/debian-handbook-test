<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="network-services" lang="it-IT">
	<chapterinfo>
		 <keywordset>
			<keyword>Postfix</keyword>
			 <keyword>Apache</keyword>
			 <keyword>NFS</keyword>
			 <keyword>Samba</keyword>
			 <keyword>Squid</keyword>
			 <keyword>OpenLDAP</keyword>
			 <keyword>SIP</keyword>

		</keywordset>

	</chapterinfo>
	 <title>Servizi di rete: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</title>
	 <highlights> <para>
		I servizi di rete sono i programmi con cui gli utenti interagiscono direttamente durante le loro attività quotidiane. Essi sono la punta dell'iceberg del sistema informativo ed in questo capitolo ci concentreremo su di loro; le componenti invisibili a cui si affidano sono l'infrastruttura che abbiamo descritto precedentemente.
	</para>
	 <para>
		Molti servizi di rete moderni richiedono una tecnologia di crittografia per funzionare in modo affidabile e sicuro, soprattutto se usati su Internet pubblico. I Certificati X.509 (che possono essere chiamati anche certificati SSL o certificati TLS) sono spesso utilizzati per questo scopo. Un certificato per uno specifico dominio può spesso essere condiviso tra più di uno dei servizi trattati in questo capitolo.
	</para>
	 <indexterm>
		<primary>TLS</primary>
	</indexterm>
	 <indexterm>
		<primary>X.509</primary>
	</indexterm>
	 <indexterm>
		<primary>Certificati</primary>
	</indexterm>
	 </highlights> <section id="sect.smtp-mail-server">
		<title>Server di posta</title>
		 <para>
			Gli amministratori della Falcot Corporation hanno scelto Postfix come loro server di posta elettronica per via della sua affidabilità e per la semplicità di configurazione. Allo stesso modo il suo design assicura che ogni operazione sia eseguita in un processo con l'insieme minimo di permessi richiesti, cosa che garantisce una misura ottimale contro i problemi di sicurezza.
		</para>
		 <indexterm>
			<primary>email</primary>
			<secondary>server</secondary>
		</indexterm>
		 <indexterm>
			<primary>server di posta</primary>
		</indexterm>
		 <indexterm>
			<primary>Postfix</primary>
		</indexterm>
		 <sidebar> <title><emphasis>ALTERNATIVA</emphasis> Il server Exim4</title>
		 <indexterm>
			<primary>Exim</primary>
		</indexterm>
		 <para>
			Debian utilizza Exim4 come server di posta predefinito (per questo l'installazione iniziale include Exim4). La configurazione è fornita da un pacchetto separato, <emphasis role="pkg">exim4-config</emphasis>, e viene automaticamente personalizzata in base alle risposte fornite ad un insieme di quesiti posti da Debconf in modo molto simile a come avviene con le domande poste dal pacchetto <emphasis role="pkg">postfix</emphasis>.
		</para>
		 <para>
			La configurazione può essere in un singolo file (<filename>/etc/exim4/exim4.conf.template</filename>) oppure suddivisa in parti all'interno della cartella <filename>/etc/exim4/conf.d/</filename>. In entrambi i casi, i file non sono utilizzati da <command>update-exim4.conf</command> come modelli per la generazione di <filename>/var/lib/exim4/config.autogenerated</filename>. Quest'ultimo è utilizzato da Exim4. Grazie a questo meccanismo, i valori ottenuti attraverso la configurazione debconf di Exim — che sono memorizzati in <filename>/etc/exim4/update-exim4.conf.conf</filename> — possono essere inseriti nel file di configurazione di Exim anche quando l'amministratore oppure un'altro pacchetto hanno cambiato la configurazione predefinita di Exim.
		</para>
		 <para>
			La sintassi dei file di configurazione di Exim4 ha le sue peculiarità e la sua curva di apprendimento. Una volta comprese queste peculiarità Exim4 è un server di posta veramente completo e potente come testimoniano le decine di pagine di documentazione. <ulink type="block" url="http://www.exim.org/docs.html" />
		</para>
		 </sidebar> <section>
			<title>Installare Postfix</title>
			 <para>
				Il pacchetto <emphasis role="pkg">postfix</emphasis> include il demone SMTP principale. Altri pacchetti (come <emphasis role="pkg">postfix-ldap</emphasis> e <emphasis role="pkg">postfix-pgsql</emphasis>) aggiungono funzionalità addizionali a Postfix, incluso l'accesso ai database di mappatura. Dovrebbero essere installati solo se si ritiene di averne bisogno.
			</para>
			 <sidebar id="sidebar.smtp"> <title><emphasis>FONDAMENTALI</emphasis> SMTP</title>
			 <indexterm>
				<primary>SMTP</primary>
			</indexterm>
			 <indexterm>
				<primary>Simple Mail Transfer Protocol</primary>
			</indexterm>
			 <indexterm>
				<primary>server</primary>
				<secondary>SMTP</secondary>
			</indexterm>
			 <para>
				SMTP (<emphasis>Simple Mail Transfer Protocol</emphasis>) è il protocollo utilizzato dai server di posta per scambiare ed instradare le email.
			</para>
			 </sidebar> <para>
				Saranno posti diversi quesiti Defconf durante l'installazione del pacchetto. Le risposte consentono di generare una prima versione del file di configurazione <filename>/etc/postfix/main.cf</filename>.
			</para>
			 <para>
				La prima domanda riguarda la tipologia di configurazione. Solo due delle risposte proposte sono rilevanti nel caso in cui il server sia connesso ad Internet: «Sito internet» e «Sito internet con smarthost». La prima opzione è appropriata per un server che riceve la posta in arrivo ed invia le email in uscita direttamente ai rispettivi destinatari: pertanto si adatta bene al caso della Falcot Corporation. La seconda opzione è appropriata per un server che riceve le email in arrivo normalmente ma che invia le email in uscita attraverso un server SMTP intermedio, lo «smarthost», anziché consegnarle direttamente al server del destinatario. Questo è particolarmente utile per chi ha con un indirizzo IP dinamico poiché molti server di posta rifiutano i messaggi che arrivano direttamente da questo tipo di indirizzo. In questo caso lo smarthost sarà generalmente il server SMTP dell'ISP che a sua volta è configurato per accettare ed inoltrare in modo appropriato le email provenienti dai clienti. Questo tipo di configurazione (con smarthost) è rilevante anche per i server che non sono costantemente connessi ad internet poiché evita di dover gestire una coda di messaggi non consegnabili da dover riprovare a inviare in seguito.
			</para>
			 <sidebar> <title><emphasis>VOCABOLARIO</emphasis> ISP</title>
			 <indexterm>
				<primary>ISP, Internet Service Provider</primary>
			</indexterm>
			 <para>
				ISP è l'acronimo per «Internet Service Provider». Rappresenta un'entità, spesso un'azienda, che fornisce connessioni ad Internet ed i servizi base correlati (email, news e così via).
			</para>
			 <para>
			</para>
			 </sidebar> <para>
				La seconda domanda riguarda il nome completo della macchina, utilizzato per generare gli indirizzi email a partire dal nome utente locale. Il nome completo della macchina appare dopo la chiocciola («@»). Nel caso della Falcot, la risposta dovrebbe essere <literal>mail.falcot.com</literal>. Questa è l'unica domanda posta in via predefinita tuttavia la configurazione a cui porta non è sufficientemente completa per le necessità della Falcot: per questo motivo gli amministratori eseguono <command>dpkg-reconfigure postfix</command> per poter personalizzare altri parametri.
			</para>
			 <para>
				Una delle domande addizionali chiede tutti i nomi di dominio relativi alla macchina. La lista predefinita include il suo nome completo oltre ad alcuni sinonimi per <literal>localhost</literal>, ma il dominio principale <literal>falcot.com</literal> dev'essere aggiunto manualmente. Più generalmente, bisognerebbe rispondere a questa domanda con tutti i nomi di dominio per i quali la macchina agirà come server MX; in altre parole‍, tutti i nomi a dominio per cui il DNS dice che questa macchina accetterà email. Questa informazione finisce nella variabile <literal>mydestination</literal> del file di configurazione principale di Postfix, <filename>/etc/postfix/main.cf</filename>.
			</para>
			 <indexterm>
				<primary>server</primary>
				<secondary>MX</secondary>
			</indexterm>
			 <indexterm>
				<primary>MX</primary>
				<secondary>server</secondary>
			</indexterm>
			 <figure>
				<title>Ruolo del record <emphasis>MX</emphasis> nel DNS durante l'invio di un'email</title>
				 <mediaobject>
					<imageobject>
						<imagedata fileref="images/mail-server.png" format="PNG" scalefit="1" width="60%" />
					</imageobject>

				</mediaobject>

			</figure>
			 <sidebar> <title><emphasis>EXTRA</emphasis> Interrogare i record MX</title>
			 <para>
				Quando il DNS non ha un record MX per un dominio, il server di posta tenterà di inviare i messaggi allo stesso host utilizzando il record A corrispondente (o AAAA in IPv6).
			</para>
			 </sidebar> <para>
				In alcuni casi l'installazione può anche chiedere quali reti devono essere autorizzate ad inviare email attraverso la macchina. Nella sua configurazione predefinita Postfix accetta unicamente email provenienti dalla macchina che lo ospita; la rete locale viene generalmente aggiunta. Gli amministratori della Falcot Corporation hanno aggiunto <literal>192.168.0.0/16</literal> alla risposta predefinita. Se la domanda non è posta, la relativa variabile nel file di configurazione è <literal>mynetworks</literal> come si vede nell'esempio qui sotto.
			</para>
			 <para>
				Le email locali possono anche essere consegnate con <command>procmail</command>. Questo strumento consente agli utenti di elaborare le loro email in arrivo attraverso le regole conservare nel file <filename>~/.procmailrc</filename>.
			</para>
			 <indexterm>
				<primary><command>procmail</command></primary>
			</indexterm>
			 <indexterm>
				<primary>email</primary>
				<secondary>filtrare</secondary>
			</indexterm>
			 <indexterm>
				<primary>filtrare le email</primary>
			</indexterm>
			 <para>
				Dopo questa prima fase gli amministratori dispongono del file di configurazione seguente; sarà utilizzato come punto di partenza per aggiungere alcune funzionalità addizionali nelle prossime sezioni.
			</para>
			 <example>
				<title>File <filename>/etc/postfix/main.cf</filename> iniziale</title>
				 
<programlisting>
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</programlisting>

			</example>
			 <sidebar> <title><emphasis>SICUREZZA</emphasis> Certificati SSL <emphasis>Snake oil</emphasis></title>
			 <para>
				I certificati <emphasis>snake oil</emphasis>, come le "medicine" <emphasis>snake oil</emphasis> vendute da antichi ciarlatani, non hanno alcun valore: non si può fare affidamento su di loro per autenticare il server poiché sono generati automaticamente da certificati auto-firmati. Tuttavia sono utili per migliorare la privacy degli scambi.
			</para>
			 <para>
				In generale possono essere utilizzati solo a scopo di test, ed i normali servizi devono utilizzare unicamente certificati reali; essi possono essere generati con la procedura descritta in <xref linkend="sect.easy-rsa" />.
			</para>
			 </sidebar>
		</section>
		 <section id="sect.configuring-virtual-domains">
			<title>Configurare i domini virtuali</title>
			 <indexterm>
				<primary>dominio</primary>
				<secondary>virtuale</secondary>
			</indexterm>
			 <indexterm>
				<primary>dominio virtuale</primary>
			</indexterm>
			 <para>
				Il server di posta può ricevere anche email indirizzate ad altri domini oltre a quello principale: questi domini sono indicati come «domini virtuali». In molti casi, dove questo avviene, le email non sono destinate ad utenti locali. Postfix fornisce due funzionalità interessanti per gestire i domini virtuali.
			</para>
			 <sidebar> <title><emphasis>ATTENZIONE</emphasis> Domini virtuali e domini canonici</title>
			 <para>
				Nessuno dei domini virtuali dev'essere riportato nella variabile <literal>mydestination</literal>. Questa variabile contiene unicamente i nomi dei domini «canonici» direttamente associati alla macchina ed ai suoi utenti locali.
			</para>
			 </sidebar> <section>
				<title>Domini virtuali alias</title>
				 <indexterm>
					<primary>alias</primary>
					<secondary>dominio alias virtuale</secondary>
				</indexterm>
				 <indexterm>
					<primary>alias</primary>
					<secondary>dominio alias virtuale</secondary>
				</indexterm>
				 <para>
					Un dominio virtuale alias contiene solo indirizzi alias, cioè indirizzi che si occupano di inoltrare le email ad altri indirizzi.
				</para>
				 <para>
					Questo tipo di dominio sarà abilitato aggiungendo il suo nome alla variabile <literal>virtual_alias_domains</literal> ed indicando un file di mappatura indirizzi nella variabile <literal>virtual_alias_maps</literal>.
				</para>
				 <example>
					<title>Direttive da aggiungere nel file <filename>/etc/postfix/main.cf</filename></title>
					 
<programlisting>
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual</programlisting>

				</example>
				 <para>
					Il file <filename>/etc/postfix/virtual</filename> descrive le mappature con una sintassi piuttosto lineare: ogni riga contiene due campi separati da uno spazio; il primo campo è il nome dell'alias, il secondo campo è una lista di indirizzi email a cui reindirizza. La sintassi speciale <literal>@domain.com</literal> copre tutti i restanti alias di un dominio.
				</para>
				 <example>
					<title>File <filename>/etc/postfix/virtual</filename> di esempio</title>
					 
<programlisting>
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# L'alias qui sotto è generico e copre tutti gli indirizzi all'interno 
# del dominio flacotsbrand.com che non sono altrimenti coperti in questo file.
# Questi indirizzi inoltrano le email allo stesso utente nel
# dominio falcot.com.
@falcotsbrand.com           @falcot.com</programlisting>

				</example>

			</section>
			 <section>
				<title>Caselle di posta su domini virtuali</title>
				 <sidebar> <title><emphasis>ATTENZIONE</emphasis> Domini virtuali combinati?</title>
				 <para>
					Postfix non consente di utilizzare contemporaneamente lo stesso dominio in <literal>virtual_alias_domains</literal> e <literal>virtual_mailbox_domains</literal>. Comunque ogni dominio di <literal>virtual_mailbox_domains</literal> viene implicitamente incluso in <literal>virtual_alias_domains</literal>, cosa che permette di mescolare caselle ed alias all'interno di un dominio virtuale.
				</para>
				 </sidebar> <indexterm>
					<primary>casella di posta, dominio virtuale</primary>
				</indexterm>
				 <indexterm>
					<primary>virtuale</primary>
					<secondary>dominio casella di posta virtuale</secondary>
				</indexterm>
				 <para>
					I messaggi indirizzati ad una casella su di un dominio virtuale sono conservati in caselle di posta non assegnate ad un utente locale del sistema.
				</para>
				 <para>
					Abilitare una casella di posta in un dominio virtuale richiede di inserire il dominio nella variabile <literal>virtual_mailbox_domains</literal> fornendo un file di mappatura caselle in <literal>virtual_mailbox_maps</literal>. Il parametro <literal>virtual_mailbox_base</literal> contiene la directory dove le caselle di posta saranno conservate.
				</para>
				 <para>
					I parametri <literal>virtual_uid_maps</literal> e <literal>virtual_gid_maps</literal> forniscono le mappature tra un indirizzo email e l'utente di sistema (o gruppo rispettivamente) che "possiede" la casella di posta corrispondente. Per assegnare tutte le caselle di posta allo stesso proprietario/gruppo la sintassi è <literal>static:5000</literal>.
				</para>
				 <example>
					<title>Direttive da aggiungere nel file <filename>/etc/postfix/main.cf</filename></title>
					 
<programlisting>
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts</programlisting>

				</example>
				 <para>
					Ancora una volta, la sintassi del file <filename>/etc/postfix/vmailbox</filename> è piuttosto lineare: due campi separati da uno spazio. Il primo campo è un indirizzo email all'interno di uno dei domini virtuali e il secondo campo è la posizione della casella di posta associata (relativamente alla directory specificata in <emphasis>virtual_mailbox_base</emphasis>). Se il nome della casella di posta termina con una barra (<literal>/</literal>) le email saranno conservate nel formato <emphasis>maildir</emphasis>, diversamente sarà utilizzato il formato tradizionale <emphasis>mbox</emphasis>. Il formato di <emphasis>maildir</emphasis> utilizza l'intera directory per conservare una casella di posta: ogni messaggio sarà conservato in un file separato. Diversamente, nel formato <emphasis>mbox</emphasis>, l'intera casella di posta elettronica è conservata in un file ed ogni riga che comincia con «<literal>From </literal>» (<literal>From</literal> seguito da uno spazio) segnala l'inizio di un nuovo messaggio.
				</para>
				 <example>
					<title>Il file <filename>/etc/postfix/vmailbox</filename></title>
					 
<programlisting>
# La posta di Jean è conservata come maildir, con
# un file per email in una directory dedicata
jean@falcot.org falcot.org/jean/
# La posta di Sophie è conservata in un tradizionale file «mbox»,
# dove tutte le email sono concatenate in un unico file
sophie@falcot.org falcot.org/sophie</programlisting>

				</example>

			</section>

		</section>
		 <section id="sect.restrictions-for-receiving-and-sending">
			<title>Restrizioni per ricezione ed invio</title>
			 <para>
				Il crescente numero di email massive non richieste (<emphasis>spam</emphasis>) richiede di essere sempre più rigorosi quando si stabilisce quali email devono essere accettate da un server. Questa sezione presenta alcune tra le strategie incluse in Postfix.
			</para>
			 <sidebar> <title><emphasis>CULTURA</emphasis> Il problema dello spam</title>
			 <indexterm>
				<primary>spam</primary>
			</indexterm>
			 <para>
				«Spam» è un termine generico utilizzato per indicare tutte le email commerciali non richieste che inondano le nostre caselle di posta elettronica. Gli individui senza scrupoli che le inviano sono definiti «spammer». Costoro si preoccupano poco del disturbo che causano perché inviare email costa poco e basta che una piccola percentuale di destinatari sia attratta dalle loro offerte perché l'operazione di spam produca più denaro di quanto sia costata. Il processo è quasi completamente automatizzato e qualsiasi indirizzo email reso pubblico (per esempio in un forum, negli archivi di una mail list, in un blog, ecc.) sarà individuato dai robot degli spammer e sottoposto ad un flusso senza fine di messaggi non richiesti.
			</para>
			 <para>
				Tutti gli amministratori di sistema tentano di affrontare questo disturbo con i filtri anti-spam, ma naturalmente gli spammer continuano a lavorare per aggirare questi filtri. Alcuni di loro prendono persino in affitto da varie organizzazioni criminali reti di macchine compromesse da worm. Recenti statistiche stimano che fino al 95% delle email in circolazione su Internet sono spam!
			</para>
			 </sidebar> <section>
				<title>Restrizioni d'accesso basate su IP</title>
				 <para>
					La direttiva <literal>smtpd_client_restrictions</literal> controlla quali macchine sono autorizzate a comunicare con il server di posta.
				</para>
				 <example>
					<title>Restrizioni basate sull'indirizzo del client</title>
					 
<programlisting>
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org</programlisting>

				</example>
				 <para>
					Quando una variabile contiene una lista di regole, come nell'esempio qui sopra, queste regole sono valutate in ordine, dalla prima all'ultima. Ogni regola può accettare il messaggio, rifiutarlo o lasciare la decisione ad una regola seguente. Come conseguenza l'ordine è importante ed invertire due regole può causare un comportamento ampiamente differente.
				</para>
				 <para>
					La direttiva <literal>permit_mynetworks</literal> usata come prima regola accetta tutte le email provenienti da una macchina nella rete locale (così come definita nella variabile di configurazione <emphasis>mynetworks</emphasis>).
				</para>
				 <para>
					La seconda direttiva rifiuta normalmente le email provenienti da macchine che non dispongono di una configurazione DNS completamente valida. Una configurazione è valida quando l'indirizzo IP può essere risolto con un nome e questo nome a sua volta può essere risolto all'indirizzo IP. Questa restrizione è spesso troppo rigorosa poiché molti server di posta non dispongono di un DNS inverso per il loro indirizzo IP. questo spiega perché gli amministratori della Falcot hanno inserito il modificatore <literal>warn_if_reject</literal> prima della direttiva <literal>reject_unknown_client</literal>: questo modificatore trasforma il rifiuto in un semplice avviso registrato nei log. Gli amministratori possono poi controllare il numero di messaggi che sarebbero rifiutati se la regola fosse applicata e prendere successivamente una decisione informata riguardo l'opportunità di abilitare questa restrizione.
				</para>
				 <sidebar> <title><emphasis>SUGGERIMENTO</emphasis> Tabelle di <emphasis>accesso</emphasis></title>
				 <para>
					I criteri di restrizione includono tabelle modificabili dall'amministratore che elencano combinazioni di mittenti, indirizzi IP e nomi host autorizzati oppure vietati. Queste tabelle possono essere create da una copia decompressa del file <filename>/usr/share/doc/postfix-doc/examples/access.gz</filename>. Questo modello è documentato dai propri commenti, ovvero ogni tabella descrive la propria sintassi.
				</para>
				 <para>
					La tabella <filename>/etc/postfix/access_clientip</filename> elenca gli indirizzi IP e le reti; <filename>/etc/postfix/access_helo</filename> elenca i nomi di dominio; <filename>/etc/postfix/access_sender</filename> contiene gli indirizzi email dei mittenti. Tutti questi file necessitano di essere trasformati in tabelle-hash (un formato ottimizzato per l'accesso veloce) dopo ogni modifica, con il comando <command>postmap /etc/postfix/<replaceable>file</replaceable></command>.
				</para>
				 </sidebar> <para>
					La terza direttiva consente all'amministratore di preparare una blacklist ed una whitelist di server di posta, conservate nel file <filename>/etc/postfix/access_clientip</filename>. I server nella whitelist sono considerati affidabili, e le email che provengono da loro non passano attraverso le successive regole di filtraggio.
				</para>
				 <para>
					Le ultime due regole rifiutano ogni messaggio che proviene da un server elencato in una delle blacklist indicate. RBL è l'acronimo di <emphasis>Remote Black List</emphasis>; ci sono diverse di queste liste,ma tutte elencano i server mal configurati che gli spammer utilizzano per inoltrare le loro email, così come le macchine infette da virus o worm che inoltrano email in modo assolutamente non previsto.
				</para>
				 <indexterm>
					<primary>RBL</primary>
				</indexterm>
				 <indexterm>
					<primary>Blacklist remote</primary>
				</indexterm>
				 <sidebar> <title><emphasis>SUGGERIMENTO</emphasis> Whitelist e liste RBL</title>
				 <para>
					Le blacklist includono alle volte server legittimi che sono stati vittime di problemi. In queste situazioni, tutte le email che provengono da questi server saranno respinte a meno che il server non sia incluso in una whitelist definita da <filename>/etc/postfix/access_clientip</filename>.
				</para>
				 <para>
					La prudenza raccomanda di includere nella whitelist tutti i server da cui si ricevono generalmente molte email e che sono considerati affidabili.
				</para>
				 </sidebar>
			</section>
			 <section>
				<title>Controllare la validità dei comandi <literal>EHLO</literal> o <literal>HELO</literal></title>
				 <para>
					Ogni scambio SMTP inizia con un comando <literal>HELO</literal> (o <literal>EHLO</literal>) seguito dal nome del server di posta mittente; controllare la validità di questo nome può risultare utile.
				</para>
				 <indexterm>
					<primary><literal>HELO</literal></primary>
				</indexterm>
				 <indexterm>
					<primary><literal>EHLO</literal></primary>
				</indexterm>
				 <example>
					<title>Restrizioni sul nome annunciato in <literal>EHLO</literal></title>
					 
<programlisting>
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname</programlisting>

				</example>
				 <para>
					La prima direttiva <literal>permit_mynetworks</literal> consente a tutte le macchine nella rete locale di presentarsi liberamente. Questo è importante poiché molti programmi di posta non rispettano in modo adeguato questa parte del protocollo SMTP e possono presentarsi con nomi senza senso.
				</para>
				 <para>
					La regola <literal>reject_invalid_hostname</literal> rifiuta le email quando la presentazione <literal>EHLO</literal> annuncia un nome host sintatticamente scorretto. La regola <literal>reject_non_fqdn_hostname</literal> rifiuta i messaggi quando il nome host presentato non è un nome di dominio completamente qualificato (ovvero include un nome di dominio oltre al nome host). La regola <literal>reject_unknown_hostname</literal> rifiuta i messaggi se il nome presentato non esiste nel DNS. Poiché quest'ultima regola sfortunatamente porta a troppi rifiuti gli amministratori hanno modificato i suoi effetti ad un semplice avviso con il modificatore <literal>warn_if_reject</literal> come visto inizialmente; possono anche decidere di rimuovere questo modificatore in una fase successiva dopo aver monitorato gli effetti di questa regola.
				</para>
				 <para>
					Utilizzare <literal>permit_mynetworks</literal> come prima regola ha un interessante effetto collaterale: le regole seguenti si applicano unicamente agli host fuori dalla rete locale. Questo consente di inserire in blacklist tutti gli host che si presentano come parte di <literal>falcot.com</literal>, per esempio aggiungendo la riga <literal>falcot.com REJECT You are not in our network!</literal> al file <filename>/etc/postfix/access_helo</filename>.
				</para>

			</section>
			 <section>
				<title>Accettare o rifiutare in base al mittente annunciato</title>
				 <para>
					Ogni messaggio ha un mittente annunciato dal comando <literal>MAIL FROM</literal> del protocollo SMTP. Ancora una volta questa informazione può essere verificata in diversi modi.
				</para>
				 <indexterm>
					<primary><literal>MAIL FROM</literal></primary>
				</indexterm>
				 <indexterm>
					<primary>email</primary>
					<secondary>filtrare sul mittente</secondary>
				</indexterm>
				 <example>
					<title>Controlli sul mittente</title>
					 
<programlisting>
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender</programlisting>

				</example>
				 <para>
					La tabella <filename>/etc/postfix/access_sender</filename> mappa alcuni trattamenti speciali riservati ad alcuni mittenti. Generalmente questo significa elencare alcuni mittenti in una whitelist oppure in una blacklist.
				</para>
				 <para>
					La regola <literal>reject_unknown_sender_domain</literal> richiede un dominio valido per il mittente poiché è necessario per un indirizzo valido. La regola <literal>reject_unlisted_sender</literal> rifiuta i mittenti locali se l'indirizzo non esiste: questo impedisce alle email di essere inviate da un indirizzo non valido nel dominio <literal>falcot.com</literal> ed i messaggi originati da <literal>joe.bloggs@falcot.com</literal> sono accettati esclusivamente se questo indirizzo esiste realmente.
				</para>
				 <para>
					Per concludere, la regola <literal>reject_non_fqdn_sender</literal> rifiuta le email che si presume provengano da un indirizzo senza un nome di dominio pienamente qualificato. In pratica questo significa rifiutare email provenienti da <literal>utente@macchina</literal>: l'indirizzo dev'essere annunciato come <literal>utente@macchina.example.com</literal> o <literal>utente@example.com</literal>.
				</para>

			</section>
			 <section>
				<title>Accettare o rifiutare in base al destinatario</title>
				 <para>
					Ogni email ha almeno un destinatario, annunciato con il comando <literal>RCPT TO</literal> del protocollo SMTP. Anche questi indirizzi concorrono alla validazione del messaggio, tuttavia sono meno rilevanti rispetto ai controlli effettuati sull'indirizzo del mittente.
				</para>
				 <indexterm>
					<primary>RCPT TO</primary>
				</indexterm>
				 <indexterm>
					<primary>email</primary>
					<secondary>filtrare sul destinatario</secondary>
				</indexterm>
				 <example>
					<title>Controlli sul destinatario</title>
					 
<programlisting>
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient</programlisting>

				</example>
				 <para>
					<literal>reject_unauth_destination</literal> è la regola base che richiede ai messaggi provenienti dall'esterno di essere indirizzati ai noi: messaggi inviati ad indirizzi non gestiti da questo server saranno rifiutati. Senza questa regola un server diviene un open relay che permette agli spammer di inviare posta non richiesta; questa regola è quindi caldamente raccomandata, e dovrebbe essere posizionata preferibilmente vicino all'inizio della lista, per evitare che altre regole possano autorizzare l'inoltro del messaggio prima che la sua destinazione sia stata controllata.
				</para>
				 <para>
					La regola <literal>reject_unlisted_recipient</literal> rifiuta ragionevolmente i messaggi inviati a utenti locali che non esistono. Infine <literal>reject_non_fqdn_recipient</literal> rifiuta gli indirizzi non completamente qualificati: questo rende impossibile l'invio di email a <literal>jean</literal> o <literal>jean@macchina</literal> e richiede invece l'uso dell'indirizzo completo come <literal>jean@macchina.falcot.com</literal> o <literal>jean@falcot.com</literal>.
				</para>

			</section>
			 <section>
				<title>Restrizioni associate con il comando <literal>DATA</literal></title>
				 <para>
					Il comando <literal>DATA</literal> di SMTP è emesso prima dei contenuti del messaggio. Non fornisce alcuna informazione di per sé, a parte l'annunciare quello che viene immediatamente dopo. Tuttavia può a sua volta essere soggetto a controlli.
				</para>
				 <indexterm>
					<primary><literal>DATA</literal></primary>
				</indexterm>
				 <example>
					<title>Controlli su <literal>DATA</literal></title>
					 
<programlisting>
smtpd_data_restrictions = reject_unauth_pipelining</programlisting>

				</example>
				 <para>
					La direttiva <literal>reject_unauth_pipelining</literal> fa sì che il messaggio sia rifiutato se il mittente invia un comando prima che sia inviata una risposta al comando inviato in precedenza. Questo protegge da una ottimizzazione comunemente utilizzata dagli spammer automatizzati poiché a loro non importa un fico secco delle risposte e si concentrano unicamente nell'invio del maggior numero di email nel minor tempo possibile.
				</para>

			</section>
			 <section>
				<title>Applicare restrizioni</title>
				 <para>
					Nonostante i comandi precedenti verificano informazioni a diversi livelli dello scambio SMTP, Postfix invia l'effettivo rifiuto unicamente a seguito del comando <literal>RCPT TO</literal>.
				</para>
				 <para>
					Questo significa che anche se il messaggio viene rifiutato a causa di un comando <literal>EHLO</literal> non valido, Postfix conosce il mittente ed il destinatario quando annuncia il rifiuto e pertanto potrà poi inserire nel log un messaggio più esplicito di quanto avesse potuto fare nel caso la transazione si fosse interrotta all'inizio. Inoltre un certo numero di client SMTP non si attende problemi durante i primi comandi SMTP e questi client saranno meno disturbati da questo rifiuto posticipato.
				</para>
				 <para>
					Il vantaggio finale di questa scelta è di permettere alle regole di accumulare informazioni durante i vari passaggi dello scambio di SMTP; questo consente di definire permessi più dettagliati, come rifiutare una connessione non locale se si annuncia con un mittente locale.
				</para>

			</section>
			 <section>
				<title>Filtrare in base al contenuto del messaggio</title>
				 <para>
					La validazione ed il sistema di restrizioni non sarebbero completi senza un modo per applicare controlli al contenuto dei messaggi. Postfix distingue tra i controlli applicati all'intestazione e quelli applicati al corpo del messaggio.
				</para>
				 <example>
					<title>Abilitare filtri basati sul contenuto</title>
					 
<programlisting>
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks</programlisting>

				</example>
				 <indexterm>
					<primary>email</primary>
					<secondary>filtrare sui contenuti</secondary>
				</indexterm>
				 <para>
					Entrambi i file contengono una lista di espressioni regolari (spesso chiamate <emphasis>regexp</emphasis> o <emphasis>regex</emphasis>) e relative azioni da intraprendere quando l'intestazione (o il corpo) delle email corrisponde con l'espressione.
				</para>
				 <sidebar> <title><emphasis>APPROFONDIMENTO</emphasis> Tabelle regexp</title>
				 <para>
					Il file <filename>/usr/share/doc/postfix-doc/examples/header_checks.gz</filename> contiene molti commenti esplicativi che possono essere utilizzati come punto di partenza per creare i file <filename>/etc/postfix/header_checks</filename> ed <filename>/etc/postfix/body_checks</filename>.
				</para>
				 </sidebar> <example>
					<title>File d'esempio <filename>/etc/postfix/header_checks</filename></title>
					 
<programlisting>
/^X-Mailer: GOTO Sarbacane/ REJECT Io combatto lo spam (GOTO Sarbacane)
/^Subject: *La tua email contiene dei VIRUS/ DISCARD notifica di virus</programlisting>

				</example>
				 <sidebar id="sidebar.regexp"> <title><emphasis>FONDAMENTALI</emphasis> Espressioni regolari</title>
				 <para>
					Il termine <emphasis>espressione regolare</emphasis> (spesso abbreviato in lingua inglese con <emphasis>regexp</emphasis> o <emphasis>regex</emphasis>) fa riferimento ad una notazione generica per esprimere la descrizione dei contenuti oppure la struttura di una stringa di caratteri. Certi caratteri speciali permettono di definire: alternative (per esempio <literal>pippo|pluto</literal> corrisponde sia con «pippo» che con «pluto»); insiemi di caratteri (per esempio <literal>[0-9]</literal> significa qualsiasi numero e <literal>.</literal> — un punto — significa qualsiasi carattere); quantità (<literal>s?</literal> è compatibile con <literal>s</literal> o con una stringa vuota ovvero con zero o una occorrenza di <literal>s</literal>, <literal>s+</literal> è compatibile con una o più occorrenze consecutive del carattere <literal>s</literal>, e così via). Le parentesi permettono di raggruppare i risultati della ricerca.
				</para>
				 <para>
					La precisa sintassi di queste espressioni varia tra i vari strumenti che le utilizzano ma le funzionalità base sono similari. <ulink type="block" url="http://it.wikipedia.org/wiki/Espressione_regolare" />
				</para>
				 </sidebar> <para>
					La prima controlla l'intestazione che fa riferimento al software email; se viene individuato <literal>GOTO Sarbacane</literal> (un software per l'invio massivo di email) il messaggio viene rifiutato. La seconda espressione controlla l'oggetto del messaggio: se indica la notifica di un virus possiamo decidere di non respingere il messaggio ma di limitarci a scartarlo immediatamente.
				</para>
				 <para>
					Utilizzare questi filtri è un'arma a doppio taglio poiché è facile produrre regole troppo generiche e perdere di conseguenza email legittime. In questi casi i messaggi vanno perduti ed inoltre i rispettivi mittenti ricevono messaggi d'errore non desiderati (e fastidiosi).
				</para>

			</section>

		</section>
		 <section id="sect.setting-up-greylisting">
			<title>Impostare il <foreignphrase>greylisting</foreignphrase></title>
			 <indexterm>
				<primary>greylisting</primary>
			</indexterm>
			 <para>
				Il "greylisting" è una tecnica di filtraggio per cui un messaggio viene inizialmente rifiutato con un messaggio d'errore temporaneo e viene accettato solo dopo un successivo tentativo trascorso un certo intervallo di tempo. Questo filtraggio è particolarmente efficiente contro lo spam inviato dalle tante macchine infette da virus e worm poiché questi software si comportano raramente come veri e propri agenti SMTP (i quali controllano i codici d'errore e ritentano l'invio dei messaggi successivamente), soprattutto perché molti degli indirizzi raccolti sono davvero validi e riprovare significherebbe soltanto perdere tempo.
			</para>
			 <para>
				Postfix non fornisce il greylisting nativamente ma esiste una funzionalità che permette di delegare la decisione riguardo il rifiuto o l'accettazione di un messaggio ad un programma esterno. Il pacchetto <emphasis role="pkg">postgrey</emphasis> contiene proprio un programma di questo tipo, progettato per interfacciarsi con questo servizio per la delega delle politiche di accesso.
			</para>
			 <para>
				Una volta installato, <emphasis role="pkg">postgrey</emphasis> si attiva come demone e si pone in ascolto sulla porta 10023. Postfix può quindi essere configurato per utilizzarlo, aggiungendo il parametro <literal>check_policy_service</literal> come restrizione aggiuntiva:
			</para>
			 
<programlisting>
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023</programlisting>
			 <para>
				Ogni volta che Postfix raggiunge questa regola si connette al demone <command>postgrey</command> e gli invia informazioni a proposito del messaggio in questione. Postgrey prende quindi in considerazione i tre parametri IP/mittente/destinatario e controlla il suo database per verificare se sono già apparsi recentemente. Se è così Postgrey risponde autorizzando il messaggio, altrimenti risponde indicando che il messaggio dev'essere temporaneamente respinto ed i tre parametri vengono inseriti nel database.
			</para>
			 <para>
				Il principale svantaggio del greylisting è dato dal ritardo causato ai messaggi legittimi, cosa che non è sempre accettabile. Inoltre incrementa il carico sui server che inviano molte email legittime.
			</para>
			 <sidebar> <title><emphasis>IN PRATICA</emphasis> Aspetti negativi del greylisting</title>
			 <para>
				Teoricamente il greylisting dovrebbe unicamente ritardare la ricezione della prima email da un dato mittente ad un dato destinatario e tipicamente questo ritardo si misura nell'ordine dei minuti. La realtà, purtroppo, può essere leggermente diversa. Alcuni grandi provider utilizzano cluster di server SMTP e quando un messaggio viene inizialmente rifiutato il server che riprova la trasmissione potrebbe non essere lo stesso. Quando ciò accade il secondo server ottiene un ulteriore messaggio d'errore temporaneo dovuto al greylisting e così via: in questi casi possono passare anche diverse ore prima che la trasmissione sia rieseguita da un server già coinvolto poiché normalmente i server SMTP incrementano gli intervalli tra un tentativo e l'altro dopo ogni fallimento.
			</para>
			 <para>
				Di conseguenza l'indirizzo IP di provenienza può variare nel tempo anche per un singolo mittente. Inoltre anche l'indirizzo email del mittente può cambiare. Per esempio molti server di mailing-list possono includere informazioni extra nell'indirizzo email del mittente per essere in grado di gestire i messaggi d'errore (spesso indicati anche con il termine <emphasis>bounce</emphasis>). Ad ogni nuovo messaggio inviato ad una mailing-list potrebbe essere richiesto di attraversare il greylisting cosa che richiede di essere conservato (temporaneamente) nel server del mittente. Questo può diventare presto un problema per le mailing-list molto frequentate (con decine di migliaia di iscritti).
			</para>
			 <para>
				Per mitigare questi effetti negativi, Postgrey gestisce una whitelist di siti, ed i messaggi da loro originati vengono immediatamente accettati senza passare attraverso il greylisting. Questa lista può essere facilmente adattata in base alle necessità locali, visto che è conservata nel file <filename>/etc/postgrey/whitelist_clients</filename>.
			</para>
			 </sidebar> <sidebar> <title><emphasis>APPROFONDIMENTO</emphasis> Greylisting selettivo con <emphasis role="pkg">milter-greylist</emphasis></title>
			 <para>
				Gli effetti negativi del greylisting possono essere mitigati applicando il greylisting unicamente ad un sottoinsieme di client che sono già considerati come probabile sorgente di spam (poiché sono inseriti in una blacklist DNS). Questo non è possibile con <emphasis role="pkg">postgrey</emphasis> ma <emphasis role="pkg">milter-greylist</emphasis> può essere usato in questo modo.
			</para>
			 <para>
				In tal scenario, poichè che le blacklist DNS non innescano mai un rifiuto definitivo, diventa ragionevole l'uso di blacklist aggressive, comprese quelle che includono tutti gli indirizzi IP dinamici assegnati dai Provider ai loro clienti (come <literal>pbl.spamhaus.org</literal> o <literal>dul.dnsbl.sorbs.net</literal>).
			</para>
			 <para>
				Poichè milter-greylist usa l'intrefaccia milter di Sendmail , il lato postix della sua configurazione è limitato a “<literal>smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</literal>”. La pagina del manuale <citerefentry><refentrytitle>greylist.conf</refentrytitle>
				<manvolnum>5</manvolnum></citerefentry> documenta <filename>/etc/milter-greylist/greylist.conf</filename> ed i numerosi modi di configurare milter-greylist. Inoltre sarà necessario modificare il file <filename>/etc/default/milter-greylist</filename> per consentire effettivamente il servizio.
			</para>
			 </sidebar>
		</section>
		 <section>
			<title>Personalizzare i filtri in base al destinatario</title>
			 <para>
				La <xref linkend="sect.restrictions-for-receiving-and-sending" /> e la <xref linkend="sect.setting-up-greylisting" /> riportano molte delle possibili limitazioni. Tutte hanno un loro metodo per diminuire la quantità di spam ricevuto ma tutte hanno effetti collaterali. Quindi è sempre più comune personalizzare l'insieme di filtri in base al destinatario. Alla Falcot Corporation il greylisting è utile per la maggior parte degli utenti, ma ostacola l'attività di alcuni utenti che necessitano di una bassa latenza per le proprie email (come il servizio di supporto tecnico). Allo stesso modo il servizio di supporto commerciale incontra a volte delle difficoltà nella ricezione di email da alcuni provider asiatici che sono inseriti nelle blacklist: il servizio di supporto commerciale ha quindi richiesto un indirizzo email non filtrato per poter comunicare.
			</para>
			 <para>
				Postfix fornisce la personalizzazione sui filtri tramite il concetto di «restrizione di classe». Le classi sono dichiarate nel parametro <literal>smtpd_restriction_classes</literal> e sono definite come in <literal>smtpd_recipient_restrictions</literal>. La direttiva <literal>check_recipient_access</literal> definisce quindi una tabella che associa un destinatario ad un insieme appropriato di restrizioni.
			</para>
			 <example>
				<title>Definire classi di restrizione in <filename>main.cf</filename></title>
				 
<programlisting>smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access</programlisting>

			</example>
			 <example>
				<title>Il file <filename>/etc/postfix/recipient_access</filename></title>
				 
<programlisting>
# Indirizzi non filtrati
postmaster@falcot.com  permissiva
support@falcot.com     permissiva
sales-asia@falcot.com  permissiva

# Filtraggio aggressivo per alcuni utenti privilegiati
joe@falcot.com         aggressiva

# Una regola speciale per il manager della mailing-list
sympa@falcot.com       reject_unverified_sender

# Greylisting predefinito
falcot.com             greylisting</programlisting>

			</example>

		</section>
		 <section id="sect.postfix-antivirus">
			<title>Integrare un antivirus</title>
			 <indexterm>
				<primary>antivirus</primary>
			</indexterm>
			 <para>
				I molti virus che circolano come allegato email rendono importante impostare un antivirus al punto d'ingresso nella rete aziendale dal momento che, nonostante una costante campagna di sensibilizzazione, molti utenti continuano ad aprire anche i file allegati a messaggi palesemente loschi.
			</para>
			 <para>
				Gli amministratori della Falcot hanno scelto <command>clamav</command> come loro antivirus libero. Il pacchetto principale è <emphasis role="pkg">clamav</emphasis> ma hanno installato alcuni altri pacchetti aggiuntivi come <emphasis role="pkg">arj</emphasis>, <emphasis role="pkg">unzoo</emphasis>, <emphasis role="pkg">unrar</emphasis> e <emphasis role="pkg">lha</emphasis>, poiché sono richiesti dall'antivirus per analizzare gli allegati archiviati in uno di questi formati.
			</para>
			 <indexterm>
				<primary><command>clamav</command></primary>
			</indexterm>
			 <indexterm>
				<primary><command>clamav-milter</command></primary>
			</indexterm>
			 <para>
				Il compito di interfacciare l'antivirus ed il server di posta è affidato a <command>clamav-milter</command>. Un <emphasis>milter</emphasis> (abbreviazione dell'inglese <emphasis>mail filter</emphasis>) è un programma di filtraggio realizzato appositamente per interfacciarsi con i server di posta. Un milter utilizza un'interfaccia di programmazione standard (API) che fornisce prestazioni nettamente migliori rispetto ai filtri esterni ai server di posta. I milter sono stati introdotti inizialmente da <emphasis>Sendmail</emphasis> e <emphasis>Postfix</emphasis> ha presto seguito l'esempio.
			</para>
			 <sidebar> <title><emphasis>APPROFONDIMENTO</emphasis> Un milter per Spamassassin</title>
			 <indexterm>
				<primary><emphasis role="pkg">spamass-milter</emphasis></primary>
			</indexterm>
			 <para>
				Il pacchetto <emphasis role="pkg">spamass-milter</emphasis> fornisce un milter basato su <emphasis>SpamAssassin</emphasis>, il famoso rilevatore di email non richieste. Può essere impiegato per etichettare i messaggi come probabile spam, aggiungendo un header addizionale, o per rifiutare del tutto i messaggi se il loro punteggio di probabile spam, definito «spamminess» in lingua inglese, supera un determinata soglia.
			</para>
			 </sidebar> <para>
				Una volta che il pacchetto <emphasis role="pkg">clamav-milter</emphasis> è installato, il milter deve essere riconfigurato per l'esecuzione su una porta TCP piuttosto che sul socket predefinito. Ciò può essere ottenuto con <command>dpkg-reconfigure clamav-milter</command>. Quando viene richiesta "L'interfaccia di comunicazione con Sendmail", verrà risposto “<literal>inet:10002@127.0.0.1</literal>”.
			</para>
			 <sidebar> <title><emphasis>NOTA</emphasis> Porta TCP reale contro cosiddetta socket</title>
			 <para>
				Il motivo per cui viene usata una vera e propria porta TCP piuttosto che una socket è che i demoni postfix spesso sono eseguiti sotto chroot e non hanno accesso alla directory che ospita la socket. Si potrebbe anche decidere di continuare ad usare la socket e scegliere una posizione all'interno di chroot (<filename>/var/spool/postfix/</filename>).
			</para>
			 </sidebar> <para>
				La configurazione standard di ClamAV è adeguata per molte situazioni, ma alcuni parametri importanti possono comunque essere personalizzati con <command>dpkg-reconfigure clamav-base</command>.
			</para>
			 <para>
				Come ultimo passo è necessario istruire Postfix affinché utilizzi i filtri appena configurati. Per farlo è sufficiente aggiungere la seguente direttiva a <filename>/etc/postfix/main.cf</filename>:
			</para>
			 
<programlisting>
# Controllo virus con clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002</programlisting>
			 <para>
				Se l'antivirus causa problemi, questa riga può essere commentata, e dev'essere eseguito <command>service postfix reload</command> perché la modifica sia applicata.
			</para>
			 <sidebar> <title><emphasis>IN PRATICA</emphasis> Verificare l'antivirus</title>
			 <para>
				Un volta configurato l'antivirus, è necessario verificare il suo corretto funzionamento. Il metodo più veloce per farlo è inviare un'email di prova con un allegato contenente il file <filename>eicar.com</filename> (o <filename>eicar.com.zip</filename>), che può essere scaricato online: <ulink type="block" url="http://www.eicar.org/86-0-Intended-use.html" />
			</para>
			 <para>
				Questo file non è un vero virus ma un file di test che tutti i software antivirus sul mercato riconoscono come un virus per consentire la verifica delle installazioni.
			</para>
			 </sidebar> <para>
				Tutti i messaggi gestiti da Postfix passano ora attraverso il filtro antivirus.
			</para>

		</section>
		 <section id="sect.authenticated-smtp">
			<title>SMTP autenticato</title>
			 <para>
				Per poter inviare email è necessario un server SMTP che sia raggiungibile; ed inoltre è necessario dire al server SMTP di inviare email attraverso di esso. Per gli utenti in movimento, questo potrebbe dire di dover cambiare regolarmente la configurazione dei propri client SMTP, dato che il server SMTP della Falcot rifiuta i messaggi provenienti da indirizzi IP apparentemente non correlati con l'azienda. Esistono due soluzioni a questo problema: l'utente in movimento può installare un server SMTP sul proprio computer oppure continuare ad utilizzare il server aziendale con qualche tipo di autenticazione che lo riconosca come dipendente. La prima soluzione non è raccomandata dato che il computer non sarà connesso permanentemente e non sarà quindi in grado di ritentare l'invio dei messaggi in caso di problemi: ci concentreremo quindi sulla seconda soluzione.
			</para>
			 <para>
				L'autenticazione SMTP con Postfix fa affidamento su SASL (<emphasis>Simple Authentication and Security Layer</emphasis>). Richiede l'installazione dei pacchetti <emphasis role="pkg">libsasl2-modules</emphasis> e <emphasis role="pkg">sasl2-bin</emphasis> e la registrazione di una password nel database SASL per ogni utente che necessita di autenticarsi sul server SMTP. Questo è realizzabile per mezzo del comando <command>saslpasswd2</command> che accetta diversi parametri. L'opzione <literal>-u</literal> definisce il dominio di autenticazione e deve corrispondere al parametro <literal>smtpd_sasl_local_domain</literal> nella configurazione di Postfix. L'opzione <literal>-c</literal> consente di creare un utente e <literal>-f</literal> permette di specificare il file da usare se il database SASL necessita di essere conservato in una posizione diversa da quella predefinita (<filename>/etc/sasldb2</filename>).
			</para>
			 
<screen role="scale">
<computeroutput># </computeroutput><userinput>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</userinput>
<computeroutput>[... type jean's password twice ...]</computeroutput></screen>
			 <para>
				Notare che il database di SASL viene creato nella directory di Postfix. Per assicurare la coerenza modifichiamo <filename>/etc/sasldb2</filename> in un collegamento simbolico che punta al database utilizzato da Postfix con il comando <command>ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</command>.
			</para>
			 <para>
				A questo punto è necessario configurare Postfix affinché utilizzi SASL. Prima di tutto l'utente <literal>postfix</literal> dev'essere aggiunto al gruppo <literal>sasl</literal> così che possa accedere al database degli account SASL. Alcuni nuovi parametri sono inoltre necessari per abilitare SASL e il parametro <literal>smtpd_recipient_restrictions</literal> dev'essere configurato per consentire ai client autenticati da SASL di inviare email liberamente.
			</para>
			 <example>
				<title>Abilitare SASL nel file <filename>/etc/postfix/main.cf</filename></title>
				 
<programlisting>
# Abilita l'autenticazione SASL
smtpd_sasl_auth_enable = yes
# Definisce il dominio di autenticazione SASL da utilizzare
smtpd_sasl_local_domain = $myhostname
[...]
# Aggiungere permit_sasl_authenticated prima di
# reject_unauth_destination permette l'inoltro delle email inviate
# dagli utenti autenticati con SASL
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]</programlisting>

			</example>
			 <sidebar> <title><emphasis>EXTRA</emphasis> Client SMTP autenticati</title>
			 <para>
				La maggior parte dei client email sono in grado di autenticarsi presso un server SMTP prima di inviare i messaggi in uscita e per utilizzare questa funzionalità basta semplicemente configurare i parametri appropriati. Se il client in uso non fornisce questa funzionalità è possibile utilizzare un server Postfix locale e configurarlo per inoltrare le email attraverso il server SMTP remoto. In questo caso, il Postfix locale diventerà a sua volta il client che andrà ad autenticarsi con SASL. I parametri richiesti sono i seguenti:
			</para>
			 
<programlisting>
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]</programlisting>
			 <para>
				Il file <filename>/etc/postfix/sasl_passwd</filename> deve contenere il nome utente e la password da utilizzare per autenticarsi sul server <literal>mail.falcot.com</literal>. Ecco un esempio:
			</para>
			 
<programlisting>
[mail.falcot.com]   joe:LyinIsji</programlisting>
			 <para>
				Così come per tutte le mappe Postfix questo file dev'essere trasformato in <filename>/etc/postfix/sasl_passwd.db</filename> con l'impiego del comando <command>postmap</command>.
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.http-web-server">
		<title>Server web (HTTP)</title>
		 <para>
			Gli amministratori della Falcot Corporation hanno deciso di utilizzare il server HTTP Apache, incluso nella versione 2.4.10 in Debian <emphasis role="distribution">Jessie</emphasis>.
		</para>
		 <indexterm>
			<primary><command>apache</command></primary>
		</indexterm>
		 <indexterm>
			<primary>server</primary>
			<secondary>web</secondary>
		</indexterm>
		 <indexterm>
			<primary>server web</primary>
		</indexterm>
		 <indexterm>
			<primary>server</primary>
			<secondary>HTTP</secondary>
		</indexterm>
		 <indexterm>
			<primary>HTTP</primary>
			<secondary>server</secondary>
		</indexterm>
		 <sidebar> <title><emphasis>ALTERNATIVE</emphasis> Altri server web</title>
		 <para>
			Apache è semplicemente il più noto (e largamente impiegato) tra i server web, ma ne esistono altri: possono offrire prestazioni migliori in caso di determinati carichi di lavoro, ma pagano il prezzo di un numero inferiore di funzionalità e moduli. Ad ogni modo, se la prospettiva del server web è quella di servire file statici oppure agire come proxy le alternative come <emphasis role="pkg">nginx</emphasis> e <emphasis role="pkg">lighttpd</emphasis> meritano di essere approfondite.
		</para>
		 <indexterm>
			<primary><emphasis role="pkg">nginx</emphasis></primary>
		</indexterm>
		 <indexterm>
			<primary><emphasis role="pkg">lighttpd</emphasis></primary>
		</indexterm>
		 </sidebar> <section>
			<title>Installare Apache</title>
			 <para>
				L'installazione del pacchetto <emphasis role="pkg">apache2</emphasis> è tutto ciò che è necessario. Contiene tutti i moduli, compresi <emphasis>Multi-Processing Modules</emphasis> (MPMs), che influenzano il modo in cui Apache gestisce l'elaborazione in parallelo di numerose richieste (quelle usate per fornire in pacchetti separati <emphasis role="pkg">apache2-mpm-*</emphasis>). Installerà anche <emphasis role="pkg">apache2-utils</emphasis> contenente le utility a riga di comando che scopriremo dopo.
			</para>
			 <para>
				L'MPM in uso influenza in modo significativo il modo in cui Apache gestirà richieste simultanee. Con il <emphasis>worker</emphasis> MPM, utilizza <emphasis>threads</emphasis> (processi leggeri), mentre con il <emphasis>prefork</emphasis> MPM utilizza una serie di processi creati in anticipo. Con <emphasis>event</emphasis> MPM anche utilizza i threads, ma le connessioni inattive (in particolare quelle tenute aperte dalla funzione HTTP <emphasis>keep-alive</emphasis>) vengono consegnate ad una gestione dedicata del thread.
			</para>
			 <para>
				Gli amministratori della Falcot installano anche <emphasis role="pkg">libapache2-mod-php5</emphasis> per includere il supporto PHP all'interno di Apache. Questo fa si che venga disabilitato il valore predefinito <emphasis>event</emphasis> di MPM, e che invece al suo posto venga usato <emphasis>prefork</emphasis>, poiché PHP può funzionare unicamente con quel particolare MPM.
			</para>
			 <sidebar> <title><emphasis>SICUREZZA</emphasis> Esecuzione con l'utente <literal>www-data</literal></title>
			 <indexterm>
				<primary><literal>www-data</literal></primary>
			</indexterm>
			 <indexterm>
				<primary>suexec</primary>
			</indexterm>
			 <para>
				In via predefinita Apache gestisce le richieste in arrivo come fosse l'utente <literal>www-data</literal>. Questo significa che una vulnerabilità in uno script CGI eseguito da Apache (per una pagina dinamica) non comprometterebbe l'intero sistema, ma solo i file di proprietà di questo particolare utente.
			</para>
			 <para>
				Usare i moduli <emphasis>suexec</emphasis> permette di eludere questa regola per permettere ad alcuni script CGI di essere eseguiti con l'identità di un altro utente. Questo è configurato con una direttiva <literal>SuexecUserGroup <replaceable>utente</replaceable><replaceable>gruppo</replaceable></literal> nel file di configurazione di Apache.
			</para>
			 <indexterm>
				<primary><emphasis role="pkg">libapache2-mpm-itk</emphasis></primary>
			</indexterm>
			 <para>
				Un'altra possibilità è l'utilizzo di un MPM dedicato, come quello fornito da <emphasis role="pkg">apache2-mpm-itk</emphasis>. Questo particolare MPM che ha un comportamento leggermente differente: permette di "isolare" gli host virtuali (in realtà, gruppi di pagine) in modo che possano essere eseguiti ciascuno con un utente differente. Una vulnerabilità in un sito web non potrà quindi compromettere i file appartenenti al proprietario di un altro sito.
			</para>
			 </sidebar> <sidebar> <title><emphasis>APPROFONDIMENTO</emphasis> Lista di moduli</title>
			 <para>
				L'elenco completo dei moduli standard per Apache può essere consultato online. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/index.html" />
			</para>
			 </sidebar> <para>
				Apache è un server modulare e molte funzionalità sono implementate da moduli esterni che il programma principale carica durante la fase di inizializzazione. La configurazione predefinita abilita solo i moduli più comuni ma abilitare un modulo è semplice: basta eseguire <command>a2enmod <replaceable>modulo</replaceable></command>. Per disabilitare un modulo il comando è <command>a2dismod <replaceable>modulo</replaceable></command>. Questi programmi non fanno altro che creare (o rimuovere) i collegamenti simbolici in <filename>/etc/apache2/mods-enabled/</filename> che puntano ai file (conservati in <filename>/etc/apache2/mods-available/</filename>).
			</para>
			 <para>
				Con la sua configurazione predefinita, il server web rimane in ascolto sulla porta 80 (come configurato in <filename>/etc/apache2/ports.conf</filename>), e serve le pagine dalla directory <filename>/var/www/html/</filename> (come configurato in <filename>/etc/apache2/sites-enabled/000-default.conf</filename>).
			</para>
			 <sidebar> <title><emphasis>APPROFONDIMENTI</emphasis> Aggiungere il supporto per SSL</title>
			 <indexterm>
				<primary>HTTPS</primary>
			</indexterm>
			 <indexterm>
				<primary>HTTP</primary>
				<secondary>secure</secondary>
			</indexterm>
			 <para>
				Apache 2.4 include il modulo SSL richiesto per rendere sicuro HTTP (HTTPS) senza bisogno di aggiunte. Naturalmente è richiesto che sia attivato con <command>a2enmod ssl</command>, poi che le direttive richieste siano state aggiunte ai file di configurazione. Un esempio di configurazione è fornito in <filename>/etc/apache2/sites-available/default-ssl.conf</filename>. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html" />
			</para>
			 <para>
				Qualche accortezza in più dve essere presa se si vuole permettere connessioni SSL con <emphasis>Perfect Forward Secrecy</emphasis> (queste connessioni utilizzano chiavi di sessione effimere assicurando così che la compromissione della chiave segreta del server con comporti anche la compromissione del vecchio traffico di dati criptato che avrebbe potuto essere conservato effettuando sniffing sulla rete). Dai un'occhiata alle raccamondazioni di Mozilla, in particolare: <ulink type="block" url="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache" />
			</para>
			 <indexterm>
				<primary><emphasis>Perfect Forward Secrecy</emphasis></primary>
			</indexterm>
			 </sidebar>
		</section>
		 <section>
			<title>Configurare gli host virtuali</title>
			 <para>
				Un host virtuale è una identità aggiuntiva per il server web.
			</para>
			 <indexterm>
				<primary>host virtuale</primary>
			</indexterm>
			 <para>
				Apache considera due tipologie differenti di host virtuali: quelli che sono basati sull'indirizzo IP (o sulla porta) e quelli che si affidano al nome di dominio del server web. Il primo metodo richiede di allocare indirizzi IP (o porte) differenti per ogni sito, mentre il secondo metodo può funzionare con un singolo IP (ed una sola porta) e i siti vengono differenziati dal nome host inviato dal client HTTP (cosa che funziona unicamente con la versione 1.1 del protocollo HTTP che comunque è fortunatamente abbastanza vecchia da essere attualmente utilizzata su tutti i client).
			</para>
			 <para>
				La (crescente) carenza di indirizzi IPv4 favorisce in genere il secondo metodo anche se questo è reso più complesso qualora gli host virtuali necessitino di fornire anche HTTPS poiché il protocollo SSL non è sempre disponibile in caso di host virtuali basati sul nome. L'estensione SNI (<emphasis>Server Name Indication</emphasis>) che permette questo genere di combinazione non è supportata da tutti i browser. Quando più siti HTTPS necessitano di girare sullo stesso server vengono spesso differenziati utilizzando una porta o un indirizzo IP differente (IPv6 in questo caso può essere d'aiuto).
			</para>
			 <para>
				La configurazione predefinita per Apache 2 abilita gli host virtuali basati sul nome. Inoltre, è definito un host virtuale predefinito nel file <literal>/etc/apache2/sites-enabled/000-default.conf</literal>: questo host virtuale viene utilizzato qualora non venga trovato alcun host che corrisponde alla richiesta inviata dal client.
			</para>
			 <sidebar> <title><emphasis>ATTENZIONE</emphasis> Il primo host virtuale</title>
			 <para>
				Le richieste che riguardano host virtuali sconosciuti sono sempre servite dal primo host virtuale definito: ecco perché abbiamo definito <literal>www.falcot.com</literal> per primo.
			</para>
			 </sidebar> <sidebar> <title><emphasis>APPROFONDIMENTO</emphasis> Apache supporta SNI</title>
			 <indexterm>
				<primary>Server Name Indication</primary>
			</indexterm>
			 <para>
				Il server Apache supporta un'estensione del protocollo SSL chiamata <emphasis>Server Name Indication</emphasis> (SNI). Questa estensione permette al browser di inviare il nome host del server web durante l'avvio di una connessione SSL, cioè molto prima della stessa richiesta HTTP, che veniva precedentemente utilizzata per identificare l'host virtuale richiesto tra quelli ospitati sullo stesso server (con lo stesso indirizzo IP e la stessa porta). Questo permette ad Apache di selezionare il certificato SSL più appropriato per la connessione da stabilire.
			</para>
			 <para>
				Prima di SNI, Apache avrebbe sempre utilizzato il certificato definito nell'host virtuale predefinito. I client che tentavano di accedere ad un altro host virtuale visualizzavano degli avvertimenti poiché il certificato ricevuto non corrispondeva al sito web a cui avevano tentato di accedere. Fortunatamente oggi la maggior parte dei browser supportano SNI: tra questi Microsoft Internet Explorer a partire dalla versione 7.0 (iniziando da Vista), Mozilla Firefox dalla versione 2.0, Apple Safari dalla versione 3.2.1 e Google Chrome in tutte le sue versioni.
			</para>
			 <para>
				Il pacchetto Apache fornito in Debian è costruito con il supporto per SNI; non è quindi necessaria alcuna configurazione particolare.
			</para>
			 <para>
				Dev'essere prestata attenzione per assicurare che la configurazione del primo host virtuale (quello predefinito) abiliti TLSv1. Apache utilizza i parametri di questo primo host virtuale per stabilire connessioni sicure ed è bene che tali parametri siano impostati per consentirle!
			</para>
			 </sidebar> <para>
				Ogni host virtuale aggiuntivo viene descritto da un file conservato in <filename>/etc/apache2/sites-available/</filename>. Quindi impostare un sito web per il dominio <literal>falcot.org</literal> richiede semplicemente la creazione del file seguente e l'abilitazione dell'host virtuale con <command>a2ensite www.falcot.org</command>.
			</para>
			 <example>
				<title>Il file <filename>/etc/apache2/sites-available/www.falcot.org.conf</filename></title>
				 
<programlisting>
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</programlisting>

			</example>
			 <para>
				Il server Apache, configurato come visto, utilizza gli stessi file di log per tutti gli host virtuali (anche se questo può essere modificato inserendo direttive <literal>CustomLog</literal> nelle definizioni degli host virtuali). Questo è un buon motivo per personalizzare il formato di questo file di log perché includa il nome dell'host virtuale. Questo può essere fatto creando un file <filename>/etc/apache2/conf-available/customlog.conf</filename> che definisce un nuovo formato per tutti i file di log (con la direttiva <literal>LogFormat</literal>) ed abilitandolo con <command>a2enconf customlog</command>. La riga <literal>CustomLog</literal> dev'essere quindi rimossa (o commentata) dal file <filename>/etc/apache2/sites-available/000-default.conf</filename>.
			</para>
			 <example>
				<title>Il file <filename>/etc/apache2/conf.d/customlog.conf</filename></title>
				 
<programlisting role="scale">
# Nuovo formato di log che include il nome dell'host (virtuale)
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Quindi utilizziamo questo formato "vhost" in via predefinita
CustomLog /var/log/apache2/access.log vhost</programlisting>

			</example>

		</section>
		 <section>
			<title>Direttive comuni</title>
			 <para>
				Questa sezione esamina brevemente alcune delle direttive di configurazione di uso comune di Apache.
			</para>
			 <indexterm>
				<primary>Direttive Apache</primary>
			</indexterm>
			 <indexterm>
				<primary>directory, Apache</primary>
			</indexterm>
			 <para>
				Il file di configurazione principale include generalmente diversi blocchi <literal>Directory</literal> che consentono di specificare diversi comportamenti per il server in base alla posizione del file che dev'essere servito. Un blocco generalmente include le direttive <literal>Options</literal> e <literal>AllowOverride</literal>.
			</para>
			 <indexterm>
				<primary><literal>Options</literal>, direttiva Apache</primary>
			</indexterm>
			 <indexterm>
				<primary><literal>AllowOverride</literal>, direttiva Apache</primary>
			</indexterm>
			 <example>
				<title>Blocco Directory</title>
				 
<programlisting>
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;</programlisting>

			</example>
			 <para>
				La direttiva <literal>DirectoryIndex</literal> contiene una lista di file da provare quando la richiesta del client corrisponde ad una directory. Il primo file nella lista che esiste viene inviato come risposta.
			</para>
			 <indexterm>
				<primary><literal>DirectoryIndex</literal>, direttiva Apache</primary>
			</indexterm>
			 <para>
				La direttiva <literal>Options</literal> è seguita da una lista di opzioni da abilitare. Il valore <literal>None</literal> disabilita tutte le opzioni; così come, <literal>All</literal> le abilita tutte ad eccezione di <literal>MultiViews</literal>. Le opzioni disponibili includono:
			</para>
			 <itemizedlist>
				<listitem>
					<para>
						<literal>ExecCGI</literal> indica che gli script CGI possono essere eseguiti. <indexterm><primary><literal>ExecCGI</literal>, direttiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>FollowSymlinks</literal> informa il server che i collegamenti simbolici possono essere seguiti e che la risposta deve contenere i contenuti della destinazione indicata dai collegamenti. <indexterm><primary><literal>FollowSymlinks</literal>, direttiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>SymlinksIfOwnerMatch</literal> comunica al server di seguire i collegamenti simbolici, ma solo quando il collegamento e la sua destinazione hanno lo stesso proprietario. <indexterm><primary><literal>SymlinksIfOwnerMatch</literal>, direttiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>Includes</literal> abilita le <emphasis>inclusioni lato server</emphasis> (abbreviato con <emphasis>SSI</emphasis> in lingua inglese). Queste sono direttive incorporate nelle pagine HTML ed eseguite in tempo reale ad ogni richiesta. <indexterm><primary><literal>Includes</literal>, direttiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>Indexes</literal> comunica al server di elencare i contenuti di una directory se la richiesta HTTP inviata dal client punta ad una directory senza file di indice (cioè quando in questa directory non esiste alcun file menzionato dalla direttiva <literal>DirectoryIndex</literal>). <indexterm><primary><literal>Indexes</literal>, direttiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>MultiViews</literal> abilita la negoziazione del contenuto: questa opzione può essere utilizzata dal server per fornire una pagina web che corrisponda alla lingua preferita configurata nel browser. <indexterm><primary><literal>MultiViews</literal>, direttiva Apache</primary></indexterm>
					</para>

				</listitem>

			</itemizedlist>
			 <para>
			</para>
			 <sidebar> <title><emphasis>FONDAMENTALI</emphasis> il file <filename>.htaccess</filename></title>
			 <para>
				Il file <filename>.htaccess</filename> contiene direttive di configurazione Apache da applicare ogni volta che una richiesta riguarda un elemento della directory dov'è contenuto. Il campo d'applicazione di queste direttive riguarda ricorsivamente anche tutte le sottodirectory al suo interno.
			</para>
			 <indexterm>
				<primary><filename>.htaccess</filename></primary>
			</indexterm>
			 <para>
				La maggior parte delle direttive che possono apparire in un blocco <literal>Directory</literal> sono anche permesse in un file <filename>.htaccess</filename>.
			</para>
			 </sidebar> <para>
				La direttiva <literal>AllowOverride</literal> elenca tutte le opzioni che possono essere abilitate o disabilitate attraverso un file <filename>.htaccess</filename>. Un utilizzo comune di questa opzione riguarda la limitazione di <literal>ExecCGI</literal> per permettere all'amministratore di scegliere quali utenti sono autorizzati ad eseguire programmi con l'identità del server web (l'utente <literal>www-data</literal>).
			</para>
			 <indexterm>
				<primary><literal>AllowOverride</literal>, direttiva Apache</primary>
			</indexterm>
			 <section>
				<title>Richiedere un'autenticazione</title>
				 <indexterm>
					<primary>autenticazione web</primary>
				</indexterm>
				 <para>
					In alcune circostanze l'accesso a parte dei contenuti di un sito web deve essere ristretto ai soli utenti autorizzati che forniscono un nome utente ed una password.
				</para>
				 <example>
					<title>Richiedere l'autenticazione con un file <filename>.htaccess</filename></title>
					 
<programlisting>
Require valid-user
AuthName "Directory privata"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private</programlisting>

				</example>
				 <sidebar> <title><emphasis>SICUREZZA</emphasis> Nessuna sicurezza</title>
				 <para>
					Il sistema di autenticazione utilizzato nell'esempio visto in precedenza (<literal>Basic</literal>) fornisce una sicurezza minima poiché la password è inviata in chiaro (è semplicemente codificata in <emphasis>base64</emphasis> che è una semplice codifica anziché un metodo di cifratura). Va inoltre sottolineato che anche i documenti «protetti» da questo meccanismo passano attraverso la rete in chiaro. Se la sicurezza è importante l'intera connessione HTTP dovrebbe essere cifrata con SSL.
				</para>
				 </sidebar> <para>
					Il file <filename>/etc/apache2/authfiles/htpasswd-private</filename> contiene una lista di utenti e password che sono generalmente manipolati con il comando <command>htpasswd</command>. Per esempio il seguente comando è utilizzato per aggiungere un utente o cambiare la sua password: <indexterm><primary><command>htpasswd</command></primary></indexterm>
				</para>
				 
<screen>
<computeroutput># </computeroutput><userinput>htpasswd /etc/apache2/authfiles/htpasswd-private <replaceable>utente</replaceable>
</userinput><computeroutput>New password:
Re-type new password:
Adding password for user <replaceable>user</replaceable>
</computeroutput></screen>

			</section>
			 <section>
				<title>Limitare l'accesso</title>
				 <indexterm>
					<primary>limitare l'accesso web</primary>
				</indexterm>
				 <para>
					La direttiva <literal>Require</literal> controlla le restrizioni di accesso ad una directory (e ricorsivamente, alle sue sottodirectory).
				</para>
				 <indexterm>
					<primary>Direttive Apache</primary>
				</indexterm>
				 <indexterm>
					<primary>directory, Apache</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Require</literal>, direttiva Apache</primary>
				</indexterm>
				 <para>
					Può essere usata per limitare l'accesso in base a molti criteri; ci soffermeremo alla descrizione delle limitazioni di accesso in base all'indirizzo IP del client, ma possono essere apllicate politiche ancora più restrittive, in particolare quando più direttive <literal>Require</literal> sono combinate all'interno di un blocco <literal>RequireAll</literal>.
				</para>
				 <example>
					<title>Consenti solo dalla rete locale</title>
					 
<programlisting>Require ip 192.168.0.0/16</programlisting>

				</example>
				 <sidebar> <title><emphasis>ALTERNATIVA</emphasis> Vecchia sintassi</title>
				 <para>
					La sintassi <literal>Require</literal> è disponibile solo in Apache 2.4 (la versione disponibile in <emphasis role="distribution">Jessie</emphasis>). Per gli utenti di <emphasis role="distribution">Wheezy</emphasis>, la sintassi di Apache 2.2 è differente, e qui la descriviamo principalmente per riferimento, anche se può anche essere resa disponibile in Apache 2.4 utilizzando il modulo <literal>mod_access_compact</literal>.
				</para>
				 <para>
					Le direttive <literal>Allow from</literal> e <literal>Deny from</literal> controllano le restrizioni di accesso ad una directory (e ricorsivamente, le sottodirectory).
				</para>
				 <indexterm>
					<primary><literal>Allow from</literal>, direttiva Apache</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Deny from</literal>, direttiva Apache</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Order</literal>, direttiva Apache</primary>
				</indexterm>
				 <para>
					La direttiva <literal>Order</literal> comunica al server l'ordine con cui le direttive <literal>Allow from</literal> e <literal>Deny from</literal> devono essere applicate: l'ultima che corrisponde ha la precedenza. In parole povere, <literal>Order deny,allow</literal> consente l'accesso se nessuna direttiva <literal>Deny from</literal> è soddisfatta oppure se lo è una direttiva <literal>Allow from</literal>. Al contrario <literal>Order allow,deny</literal> rifiuta l'accesso se nessuna direttiva <literal>Allow from</literal> è soddisfatta (oppure se lo è una direttiva <literal>Deny from</literal>).
				</para>
				 <para>
					Le direttive <literal>Allow from</literal> e <literal>Deny from</literal> possono essere seguite da un indirizzo IP, da una rete (come <literal>192.168.0.0/255.255.255.0</literal>, <literal>192.168.0.0/24</literal> o anche <literal>192.168.0</literal>), un nome host oppure un nome di dominio, o ancora dalla parola chiave <literal>all</literal> che indica tutti.
				</para>
				 <para>
					Ad esempio, per rifiutare di default le connessioni ma permetterle dalla rete locale, è possibile utilizzare questo:
				</para>
				 
<programlisting>
Order deny,allow
Allow from 192.168.0.0/16
Deny from all</programlisting>
				 </sidebar>
			</section>

		</section>
		 <section>
			<title>Analizzatori di log</title>
			 <para>
				Nel server web viene spesso installato un analizzatore di log: quest'ultimo fornisce agli amministratori una idea precisa riguardo le modalità d'utilizzo cui è sottoposto.
			</para>
			 <para>
				Gli amministratori della Falcot Corporation hanno scelto <emphasis>AWStats</emphasis> (<emphasis>Advanced Web Statistics</emphasis>) per analizzare i loro file log di Apache.
			</para>
			 <indexterm>
				<primary><emphasis>AWStats</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary>analizzatore di log web</primary>
			</indexterm>
			 <indexterm>
				<primary>log</primary>
				<secondary>analizzatore web log</secondary>
			</indexterm>
			 <indexterm>
				<primary>analizzatore dei log web</primary>
			</indexterm>
			 <para>
				Il primo passo per la configurazione è personalizzazione del file <filename>/etc/awstats/awstats.conf</filename>.Gli amministratori della Falcot lo mantengono così com'è modificando solo i parametri seguenti:
			</para>
			 
<programlisting>
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</programlisting>
			 <para>
				Tutti questi parametri sono documentati dai commenti nel file modello. In particolare i parametri <varname>LogFile</varname> e <varname>LogFormat</varname> descrivono la posizione ed il formato del file di log e le informazioni che contiene: <varname>SiteDomain</varname> e <varname>HostAliases</varname> elencano i vari nomi con cui il sito web principale viene indicato.
			</para>
			 <para>
				Per siti con molto traffico, <varname>DNSLookup</varname> non dovrebbe essere impostato a <literal>1</literal> ma per i siti minori, come quello della Falcot descritto in precedenza, questa impostazione permette di avere dei resoconti più leggibili che includono il nome completo delle macchine anziché il semplice indirizzo IP.
			</para>
			 <sidebar> <title><emphasis>SICUREZZA</emphasis> Accesso alle statistiche</title>
			 <para>
				AWStats rende disponibili le sue statistiche sul sito web senza alcuna restrizione in via predefinita ma le restrizioni possono essere attivate così che solo pochi indirizzi IP (probabilmente interni) possano accedervi: la lista degli indirizzi IP autorizzati dev'essere definita nel parametro <varname>AllowAccessFromWebToFollowingIPAddresses</varname>
			</para>
			 </sidebar> <para>
				AWStats sarà anche attivato per gli altri host virtuali: ogni host virtuale richiede il proprio file di configurazione, come <filename>/etc/awstats/awstats.www.falcot.org.conf</filename>.
			</para>
			 <example>
				<title>File di configurazione di AWStats per un host virtuale</title>
				 
<programlisting>
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"</programlisting>

			</example>
			 <para>
				AWStats usa molte delle icone conservate nella directory <filename>/usr/share/awstats/icon/</filename>. Perché queste icone siano disponibili sul sito web la configurazione di Apache dev'essere adattata per includere la seguente direttiva:
			</para>
			 
<programlisting>
Alias /awstats-icon/ /usr/share/awstats/icon/</programlisting>
			 <para>
				Dopo qualche minuto (e una volta che lo script è stato eseguito qualche volta) i risultati saranno visibili online: <ulink type="block" url="http://www.falcot.com/cgi-bin/awstats.pl" /><ulink type="block" url="http://www.falcot.org/cgi-bin/awstats.pl" />
			</para>
			 <sidebar> <title><emphasis>ATTENZIONE</emphasis> Rotazione dei file di log</title>
			 <para>
				Perché le statistiche prendano in considerazione tutti i log nell'account,<emphasis>AWStats</emphasis> necessita di essere eseguito subito prima che i file di log di Apache siano ruotati. Guardando la direttiva <literal>prerotate</literal> del file <filename>/etc/logrotate.d/apache2</filename>, questo si può ottenere aggiungendo un link simbolico a <filename>/usr/share/awstats/tools/update.sh</filename> in <filename>/etc/logrotate.d/httpd-prerotate</filename>:
			</para>
			 
<screen><computeroutput>$ </computeroutput><userinput>cat /etc/logrotate.d/apache2
</userinput><computeroutput>/var/log/apache2/*.log {
  daily
  missingok
  rotate 14
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    if /etc/init.d/apache2 status &gt; /dev/null ; then \
      /etc/init.d/apache2 reload &gt; /dev/null; \
    fi;
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ </computeroutput><userinput>sudo mkdir -p /etc/logrotate.d/httpd-prerotate
</userinput><computeroutput>$ </computeroutput><userinput>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats
</userinput></screen>
			 <para>
				Notare inoltre che i file di log creati da <command>logrotate</command> devono essere leggibili da chiunque, specialmente da AWStats. Nell'esempio visto prima, questo è assicurato dalla riga <literal>create 644 root adm</literal> (invece dei permessi <literal>640</literal> predefiniti).
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.ftp-file-server">
		<title>Server di file FTP</title>
		 <indexterm>
			<primary>FTP (<emphasis>File Transfer Protocol</emphasis>)</primary>
		</indexterm>
		 <para>
			FTP (<emphasis>File Transfer Protocol</emphasis>) è uno dei primi protocolli di Internet (la RFC 959 è stata rilasciata nel 1985!). È stato utilizzato per distribuire i file ancor prima che il Web nascesse (il protocollo HTTP è stato creato nel 1990 e formalmente definito nella sua versione 1.0 dalla RFC 1945 rilasciata nel 1996).
		</para>
		 <para>
			Questo protocollo consente sia l'invio che la ricezione di file: per questa ragione è ancora largamente utilizzato per applicare aggiornamenti a siti internet ospitati presso un provider Internet (o qualsiasi altra entità che ospita siti web). In questi casi l'accesso è reso sicuro dall'impiego di un identificativo utente ed una password. Dopo l'autenticazione il server FTP garantisce l'accesso in lettura e scrittura alla directory home dell'utente.
		</para>
		 <para>
			Altri server FTP vengono impiegati principalmente per distribuire file scaricabili dal pubblico (i pacchetti di Debian sono un buon esempio). Il contenuto di questi server è recuperato da altri server lontani geograficamente che a loro volta rendono disponibili i file agli utenti a loro più prossimi. Questo significa che l'autenticazione del client non è richiesta: conseguentemente questa modalità operativa è conosciuta come «FTP anonimo». Per essere precisi i client si autenticano con il nome utente <literal>anonymous</literal> e spesso, per convenzione, la password impiegata è l'indirizzo email dell'utente, anche se il server lo ignora.
		</para>
		 <para>
			Molti server FTP sono disponibili in Debian (<emphasis role="pkg">ftpd</emphasis>, <emphasis role="pkg">proftpd</emphasis>, <emphasis role="pkg">wu-ftpd</emphasis> e così via). Gli amministratori della Falcot Corporation hanno scelto <emphasis role="pkg">vsftpd</emphasis> perché utilizzano il server FTP unicamente per distribuire alcuni file (incluso un repository dei pacchetti Debian); dato che non necessitano di funzionalità avanzate, hanno scelto di concentrarsi sugli aspetti di sicurezza.
		</para>
		 <indexterm>
			<primary><emphasis role="pkg">vsftpd</emphasis></primary>
		</indexterm>
		 <para>
			Installando il pacchetto viene creato un utente di sistema <literal>ftp</literal>. Questo account viene utilizzato per le connessioni FTP anonime, e la sua directory home (<filename>/srv/ftp/</filename>) è la radice dell'albero reso disponibile agli utenti che si collegano al servizio. La configurazione predefinita (in <filename>/etc/vsftpd.conf</filename>) richiede alcune modifiche per soddisfare il semplice bisogno di rendere disponibili file di grandi dimensioni per il download pubblico: l'acesso anonimo deve essere abilitato (<literal>anonymous_enable=YES</literal>) e l'accesso in sola lettura degli utenti locali deve essere disattivato (<literal>local_enable=NO</literal>). Quest'ultima è particolarmente importante dal momento che il protocollo FTP non usa alcuna forma di crittografia e la password utente potrebbe essere intercettata.
		</para>

	</section>
	 <section id="sect.nfs-file-server">
		<title>Server di file NFS</title>
		 <para>
			NFS (<emphasis>Network File System</emphasis>) è un protocollo che consente l'accesso remoto ad un filesystem attraverso la rete. Tutti i sistemi Unix possono utilizzare questo protocollo: quando i sistemi Windows sono coinvolti dev'essere utilizzato Samba al suo posto.
		</para>
		 <indexterm>
			<primary>NFS</primary>
		</indexterm>
		 <indexterm>
			<primary><emphasis>Network</emphasis></primary>
			<secondary><emphasis>File System</emphasis></secondary>
		</indexterm>
		 <indexterm>
			<primary>filesystem</primary>
			<secondary>rete</secondary>
		</indexterm>
		 <indexterm>
			<primary>file</primary>
			<secondary>server</secondary>
		</indexterm>
		 <indexterm>
			<primary>server</primary>
			<secondary>file</secondary>
		</indexterm>
		 <para>
			NFS è uno strumento molto utile ma, storicamente, ha sempre sofferto di molte limitazioni, la maggior parte delle quali sono state affrontate con la versione 4 del protocollo. Lo svantaggio è che l'ultima versione di NFS è più difficile da configurare quando si desidera fare uso di funzionalità di sicurezza di base come l'autenticazione e la crittografia di dati che si basa su Kerberos. E senza quelle, il protocollo NFS deve essere limitato a una rete locale fidata (trusted) in quanto i dati passano attraverso la rete in chiaro (una <emphasis>sniffer</emphasis> può intercettarli) ed i diritti di accesso sono concessi in base all'indirizzo IP del client (che può essere falsificato).
		</para>
		 <sidebar> <title><emphasis>DOCUMENTAZIONE</emphasis> NFS HOWTO</title>
		 <para>
			Una buona documentazione per spiegare NFSv4 è piuttosto scarsa. Ecco alcune indicazioni con contenuti di diversa qualità, ma che dovrebbero almeno dare alcuni suggerimenti su ciò che dovrebbe essere fatto. <ulink type="block" url="https://help.ubuntu.com/community/NFSv4Howto" /> <ulink type="block" url="http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration" />
		</para>
		 </sidebar> <section>
			<title>Mettere in sicurezza NFS</title>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>sicurezza</secondary>
			</indexterm>
			 <para>
				Se non si utilizzano le funzioni di sicurezza basate su Kerberos, è vitale assicurarsi che solo le macchine autorizzate all'uso di NFS possano connettersi ai vari server RPC richiesti, in quanto il protocollo di base si fida dei dati ricevuti dalla rete. Il firewall deve inoltre bloccare l'<emphasis>IP spoofing</emphasis> per prevenire che macchine esterne possano agire come una interna, e limitare l'accesso alle porte appropriate alle solo macchine che devono accedere alle condivisioni NFS.
			</para>
			 <sidebar> <title><emphasis>FONDAMENTALI</emphasis> RPC</title>
			 <para>
				RPC (<emphasis>Remote Procedure Call</emphasis>) è uno standard Unix per i servizi remoti. NFS è uno di questi servizi.
			</para>
			 <indexterm>
				<primary>RPC</primary>
			</indexterm>
			 <indexterm>
				<primary><emphasis>Remote Procedure Call</emphasis></primary>
			</indexterm>
			 <para>
				I servizi RPC si registrano in una directory conosciuta con il nome di <emphasis>portmapper</emphasis>. Un client che desidera eseguire una richiesta NFS contatta prima di tutto il <emphasis>portmapper</emphasis> (sulla porta 111, TCP o UDP) e chiede del server NFS: la risposta generalmente menziona la porta 2049 (quella predefinita per NFS). Non tutti i servizi RPC necessariamente usano una porta fissa.
			</para>
			 </sidebar> <para>
				Le vecchie versioni del protocollo richiedono altri servizi RPC che usano porte assegnate dinamicamente. Fortunatamente, con NFS versione 4, sono necessarie solo porta 2049 (per NFS) e 111 (per il portmapper) e sono quindi facili da filtrare sul firewall.
			</para>
			 <indexterm>
				<primary><command>portmapper</command></primary>
			</indexterm>

		</section>
		 <section>
			<title>Server NFS</title>
			 <para>
				Il server NFS è parte del kernel Linux: nei kernel forniti da Debian è compilato come modulo. Se il server NFS è eseguito automaticamente all'avvio il pacchetto <emphasis role="pkg">nfs-kernel-server</emphasis> dev'essere installato poiché contiene gli script di avvio necessari.
			</para>
			 <para>
				Il file di configurazione del server NFS, <filename>/etc/exports</filename>, elenca le directory che vengono rese disponibili attraverso la rete (<emphasis>esportate</emphasis>). Per ogni condivisione NFS l'accesso è garantito solo alla lista di macchine fornita. Un controllo degli accessi più accurato può essere ottenuto con qualche opzione. La sintassi di questo file è piuttosto semplice:
			</para>
			 <indexterm>
				<primary><filename>exports</filename></primary>
			</indexterm>
			 <indexterm>
				<primary><filename>/etc/exports</filename></primary>
			</indexterm>
			 
<programlisting>
/directory/da/condividere macchina1(opzione1,opzione2,...) macchina2(...) ...</programlisting>
			 <para>
				Si noti che con NFSv4, tutte le directory esportate devono essere parte di un unica gerarchia e che la directory radice di quella gerarchia deve essere esportata e identificata con l'opzione <literal>fsid=0</literal> oppure <literal>fsid=root</literal>.
			</para>
			 <para>
				Ogni macchina può essere identificata sia dal suo nome DNS che dal suo IP. È anche possibile specificare un intero insieme di macchine utilizzando una sintassi come <literal>*.falcot.com</literal> o un intervallo di indirizzi IP come <literal>192.168.0.0/255.255.255.0</literal> o <literal>192.168.0.0/24</literal>.
			</para>
			 <para>
				Le directory sono rese disponibili in sola lettura in via predefinita (o con l'opzione <literal>ro</literal>). L'opzione <literal>rw</literal> permette l'accesso in lettura e scrittura. I client NFS si connettono tipicamente da una porta riservata a root (in altre parole inferiore a 1024): questa restrizione può essere sospesa con l'opzione <literal>insecure</literal> (l'opzione <literal>secure</literal> è implicita ma può essere resa esplicita, se necessario, per rendere le cose più chiare).
			</para>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>opzioni</secondary>
			</indexterm>
			 <para>
				Per impostazione predefinita il server risponde ad una richiesta NFS unicamente quando l'operazione corrente sul disco è completata (opzione <literal>sync</literal>); questo comportamento può essere disabilitato con l'opzione <literal>async</literal>. La scrittura asincrona può aumentare un po' le prestazioni, ma diminuisce l'affidabilità poiché c'è il rischio di perdere dati nel caso in cui il server subisca un crash tra la conferma di scrittura e la reale scrittura sul disco. Poiché il valore predefinito è cambiato recentemente (rispetto al valore storico di NFS), si raccomanda di rendere esplicita questa impostazione.
			</para>
			 <para>
				Per non fornire a qualsiasi client NFS l'accesso root al file system, tutte le richieste provenienti da un utente root sono considerate dal server come provenienti dall'utente <literal>anonymous</literal>. Questo comportamento corrisponde all'opzione <literal>root_squash</literal>, ed è abilitata per impostazione predefinita. L'opzione <literal>no_root_squash</literal>, che disabilita questo comportamento, è rischiosa e dovrebbe essere usata solo in ambienti controllati. Le opzioni <literal>anonuid=<replaceable>uid</replaceable></literal> e <literal>anongid=<replaceable>gid</replaceable></literal> permettono di specificare un altro falso utente da utilizzare al posto di UID/GID 65534 (che corrisponde all'utente <literal>nobody</literal> ed al gruppo <literal>nogroup</literal>).
			</para>
			 <para>
				Con NFSv4, è possibile aggiungere l'opzione <literal>sec</literal> per indicare il livello di protezione desiderato: <literal>sec=sys</literal> è l'impostazione predefinita senza particolari caratteristiche di sicurezza, <literal>sec=krb5</literal> abilita solo l'autenticazione, <literal>sec=krb5i</literal> aggiunge protezione di integrità, e <literal>sec=krb5p</literal> è il livello più completo che comprende la tutela della privacy (con crittografia dei dati). Per questo lavoro bisogna lavorare alla configurazione di Kerberos (questo servizio non è coperto da questo libro).
			</para>
			 <para>
				Sono disponibili altre opzioni: sono documentate nella pagina di manuale <citerefentry><refentrytitle>exports</refentrytitle>
				 <manvolnum>5</manvolnum></citerefentry>.
			</para>
			 <sidebar> <title><emphasis>ATTENZIONE</emphasis> Prima installazione</title>
			 <para>
				Lo script di avvio <filename>/etc/init.d/nfs-kernel-server</filename> avvia il server solo se <filename>/etc/exports</filename> elenca una o più condivisioni NFS valide. Durante la fase di configurazione iniziale, una volta che questo file è stato modificato per contenere delle condivisioni valide, il server NFS dev'essere avviato con il seguente comando:
			</para>
			 
<screen>
<computeroutput># </computeroutput><userinput>service nfs-kernel-server start</userinput></screen>
			 </sidebar>
		</section>
		 <section>
			<title>Client NFS</title>
			 <indexterm>
				<primary>client</primary>
				<secondary>NFS</secondary>
			</indexterm>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>client</secondary>
			</indexterm>
			 <para>
				Così come avviene con altri filesystem, integrare una condivisione NFS nella gerarchia del sistema richiede il mount. Poiché questo filesystem ha le sue peculiarità, sono necessari alcuni aggiustamenti alla sintassi del comando <command>mount</command> ed al file <filename>/etc/fstab</filename>.
			</para>
			 <example>
				<title>Montare manualmente con il comando <command>mount</command></title>
				 
<screen>
          <computeroutput># </computeroutput><userinput>mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/shared</userinput></screen>

			</example>
			 <example>
				<title>Condivisione NFS nel file <filename>/etc/fstab</filename></title>
				 
<programlisting>
arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0 0</programlisting>

			</example>
			 <para>
				La riga descritta in precedenza monta, all'avvio del sistema, la directory NFS <filename>/srv/shared/</filename> dal server <literal>arrakis</literal> nella directory locale <filename>/shared/</filename>. L'accesso in lettura-scrittura è richiesto (da qui il parametro <literal>rw</literal>). L'opzione <literal>nosuid</literal> è una misura di protezione che rimuove qualsiasi bit <literal>setuid</literal> o <literal>setgit</literal> dai programmi contenuti nella condivisione. Se la condivisione NFS è pensata unicamente per conservare documenti, un'altra opzione raccomandata è <literal>noexec</literal> che previene l'esecuzione di eventuali programmi conservati nella condivisione. Si noti che sul server, la directory <filename>shared</filename> è sotto NFSv4 root export (per esempio <filename>/export/shared</filename>), non è una directory di livello superiore.
			</para>
			 <para>
				La pagina di manuale <citerefentry><refentrytitle>nfs</refentrytitle>
				 <manvolnum>5</manvolnum></citerefentry> descrive tutte le opzioni dettagliatamente.
			</para>

		</section>

	</section>
	 <section id="sect.windows-file-server-with-samba">
		<title>Configurare condivisioni Windows con Samba</title>
		 <para>
			Samba è una raccolta di strumenti per gestire il protocollo SMB (chiamato anche "CIFS") su Linux. Questo protocollo è utilizzato da Windows per le condivisioni di rete e le stampanti condivise.
		</para>
		 <indexterm>
			<primary>Condivisione Windows</primary>
		</indexterm>
		 <indexterm>
			<primary>Samba</primary>
		</indexterm>
		 <indexterm>
			<primary>SMB</primary>
		</indexterm>
		 <indexterm>
			<primary>CIFS</primary>
		</indexterm>
		 <indexterm>
			<primary>server</primary>
			<secondary>file</secondary>
		</indexterm>
		 <para>
			Samba può anche agire come un controller di dominio Windows. Questo è un ottimo strumento per garantire l'integrazione dei server Linux con le macchine desktop dell'ufficio che continuano ad utilizzare Windows.
		</para>
		 <section>
			<title>Server Samba</title>
			 <para>
				Il pacchetto <emphasis role="pkg">samba</emphasis> contiene i due server principali di Samba 4, <command>smbd</command> e <command>nmbd</command>.
			</para>
			 <indexterm>
				<primary><command>smbd</command></primary>
			</indexterm>
			 <indexterm>
				<primary><command>nmbd</command></primary>
			</indexterm>
			 <sidebar> <title><emphasis>DOCUMENTAZIONE</emphasis> Andiamo oltre</title>
			 <para>
				Il server Samba è estremamente configurabile e versatile, e può assolvere efficacemente a molti casi d'utilizzo che corrispondono ad esigenze ed architetture di rete molto differenti. Questo libro si focalizza sull'utilizzo di Samba come server standalone, ma può anche essere impiegato come Controller di Dominio NT4 o come full Controller di un Dominio Active Directory, o come semplice membro di un dominio esistente (che potrebbe essere gestito da un server Windows).
			</para>
			 <indexterm>
				<primary>controller di dominio</primary>
			</indexterm>
			 <indexterm>
				<primary>Dominio Windows</primary>
			</indexterm>
			 <para>
				Il pacchetto <emphasis role="pkg">samba-doc</emphasis> contiene una grande quantitàdi file di esempio commentati in <filename>/usr/share/doc/samba-doc/examples/</filename>.
			</para>
			 </sidebar> <sidebar> <title><emphasis>STRUMENTO</emphasis> Autenticarsi con un Server Windows</title>
			 <para>
				Winbind fornisce agli amministratori di sistema l'opzione per utilizzare un server Windows NT come server d'autenticazione. Inoltre Winbind si integra bene con PAM e NSS. Questo permette di configurare postazioni Linux dove tutti gli utenti di un dominio Windows ottengono automaticamente un account.
			</para>
			 <indexterm>
				<primary>Winbind</primary>
			</indexterm>
			 <para>
				Maggiori informazioni possono essere trovate nella directory <filename>/usr/share/doc/samba-doc/examples/pam_winbind/</filename>.
			</para>
			 </sidebar> <section>
				<title>Configurare con <command>debconf</command></title>
				 <para>
					Il pacchetto imposta una configurazione minimale durante l'installazione iniziale ma in realtà si dovrebbe eseguire <command>dpkg-reconfigure samba-common</command>per adattarlo:
				</para>
				 <para>
					Il primo pezzo di informazioni richieste è il nome del gruppo di lavoro a cui apparterrà il server Samba (la risposta nel nostro caso è <literal>FALCOTNET</literal>).
				</para>
				 <para>
					Il pacchetto propone inoltre di identificare il server WINS attraverso le informazioni fornite dal demone DHCP. Gli amministratori della Falcot Corporation rifiutano questa opzione, poiché intendono utilizzare lo stesso server Samba come server WINS.
				</para>
				 <indexterm>
					<primary>WINS</primary>
				</indexterm>

			</section>
			 <section>
				<title>Configurazione manuale</title>
				 <section>
					<title>Modifiche a <filename>smb.conf</filename></title>
					 <para>
						Le necessità della Falcot richiedono che altre opzioni siano modificate nel file di configurazione <filename>/etc/samba/smb.conf</filename>. Gli estratti seguenti riassumono le modifiche applicate alla sezione <literal>[global]</literal>.
					</para>
					 
<programlisting>
[global]

## Browsing/Identification ###

# Change this to the workgroup/NT-domain name your Samba server will part of
   workgroup = FALCOTNET

# Windows Internet Name Serving Support Section:
# WINS Support - Tells the NMBD component of Samba to enable its WINS Server
   wins support = yes <co id="smb.conf.wins"></co>

[...]

####### Authentication #######

# Server role. Defines in which mode Samba will operate. Possible
# values are "standalone server", "member server", "classic primary
# domain controller", "classic backup domain controller", "active
# directory domain controller". 
#
# Most people will want "standalone sever" or "member server".
# Running as "active directory domain controller" will require first
# running "samba-tool domain provision" to wipe databases and create a
# new domain.
   server role = standalone server

# "security = user" is always a good idea. This will require a Unix account
# in this server for every user accessing the server.
   security = user <co id="smb.conf.security"></co>

[...]</programlisting>
					 <calloutlist>
						<callout arearefs="smb.conf.wins">
							<para>
								Indica che Samba agirà come name server Netbios (WINS) per la rete locale.
							</para>

						</callout>
						 <callout arearefs="smb.conf.security">
							<para>
								Questo è il valore predefinito per questo parametro. Ad ogni modo, poiché è un punto chiave per la configurazione di Samba, è raccomandato indicare esplicitamente la propria scelta. Ogni utente deve autenticarsi prima di accedere a qualsiasi condivisione.
							</para>

						</callout>

					</calloutlist>

				</section>
				 <section>
					<title>Aggiungere utenti</title>
					 <para>
						Ogni utente Samba necessita di un account sul server. L'account Unix dev'essere creato per primo, quindi l'utente dev'essere registrato nel database di Samba. La creazione dell'account Unix viene eseguita normalmente (utilizzando per esempio <command>adduser</command>).
					</para>
					 <para>
						Un utente esistente viene aggiunto al database di Samba con il comando <command>smbpasswd -a <replaceable>utente</replaceable></command>: questo comando chiede di inserire la password in modalità interattiva.
					</para>
					 <para>
						Un utente può essere cancellato con il comando <command>smbpasswd -x <replaceable>utente</replaceable></command>. Un account Samba può anche essere disabilitato temporaneamente con <command>smbpasswd -d <replaceable>utente</replaceable></command> ed essere riabilitato in seguito con <command>smbpasswd -e <replaceable>utente</replaceable></command>.
					</para>

				</section>

			</section>

		</section>
		 <section>
			<title>Client Samba</title>
			 <para>
				Le funzionalità client in Samba permettono ad una macchina Linux di accedere alle condivisioni Windows ed alle stampanti condivise. I programmi richiesti sono disponibili nei pacchetti <emphasis role="pkg">cifs-utils</emphasis> e <emphasis role="pkg">smbclient</emphasis>.
			</para>
			 <indexterm>
				<primary><emphasis>smbclient</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary><emphasis>cifs-utils</emphasis></primary>
			</indexterm>
			 <section>
				<title>Il programma <command>smbclient</command></title>
				 <para>
					Il programma <command>smbclient</command> interroga i server SMB. Accetta una opzione <literal>-U <replaceable>utente</replaceable></literal> per connettersi al server attraverso una specifica identità. <command>smbclient //<replaceable>server</replaceable>/<replaceable>condivisione</replaceable></command> accede alla condivisione con una modalità interattiva simile alla riga di comando dei client FTP. <command>smbclient -L <replaceable>server</replaceable></command> elenca tutte le condivisioni disponibili (e visibili) sul server.
				</para>

			</section>
			 <section>
				<title>Montare le condivisioni Windows</title>
				 <para>
					Il comando <command>mount</command> permette di montare una condivisione Windows all'interno della gerarchia di un filesystem Linux (con l'aiuto di <command>mount.cifs</command> fornito da <emphasis role="pkg">cifs-utils</emphasis>).
				</para>
				 <indexterm>
					<primary><command>mount.cifs</command></primary>
				</indexterm>
				 <indexterm>
					<primary>Condivisione Windows, montaggio</primary>
				</indexterm>
				 <example>
					<title>Montare una condivisione Windows</title>
					 
<programlisting>
mount -t cifs //arrakis/shared /shared \
      -o credentials=/etc/smb-credentials</programlisting>

				</example>
				 <para>
					Il file <filename>/etc/smb-credentials</filename> (che non dev'essere leggibile dagli utenti) ha il seguente formato:
				</para>
				 
<programlisting>
username = <replaceable>utente</replaceable>
password = <replaceable>password</replaceable></programlisting>
				 <para>
					Altre opzioni possono essere specificate dalla riga di comando. La lista completa è disponibile nella pagina di manuale <citerefentry><refentrytitle>smbmount</refentrytitle>
					 <manvolnum>1</manvolnum></citerefentry>. Due opzioni in particolare possono risultare interessanti: <literal>uid</literal> e <literal>gid</literal> consentono di forzare l'assegnazione del proprietario ed del gruppo dei file disponibili al mount, così da non limitare l'accesso a root.
				</para>
				 <para>
					Il montaggio (mount) di una condivisione Windows può anche essere configurato in <filename>/etc/fstab</filename>:
				</para>
				 
<programlisting>
//<replaceable>server</replaceable>/shared /shared cifs credentials=/etc/smb-credentials</programlisting>
				 <para>
					Lo smontaggio di una condivisione SMB/CIFS è fatto con il comando standard <command>umount</command>.
				</para>

			</section>
			 <section>
				<title>Stampare su una stampante condivisa</title>
				 <para>
					CUPS è una soluzione elegante per stampare da una workstation Linux su di una stampante condivisa da una macchina Windows. Quando il <emphasis role="pkg">smbclient</emphasis> è installato, CUPS consente l'installazione automatica delle stampanti Windows condivise.
				</para>
				 <indexterm>
					<primary>stampa</primary>
					<secondary>rete</secondary>
				</indexterm>
				 <para>
					Seguono i passi richiesti:
				</para>
				 <itemizedlist>
					<listitem>
						<para>
							Accesso all'interfaccia di configurazione di CUPS: <literal>http://localhost:631/admin</literal>
						</para>

					</listitem>
					 <listitem>
						<para>
							Clicca su "Add Printer".
						</para>

					</listitem>
					 <listitem>
						<para>
							Scegliere la stampante, selezionare “Windows Printer via SAMBA”.
						</para>

					</listitem>
					 <listitem>
						<para>
							Inserire l'URI per la stampante di rete. Dovrebbe essere simile al seguente:
						</para>
						 <para>
							<literal>smb://<replaceable>utente</replaceable>:<replaceable>password</replaceable>@<replaceable>server</replaceable>/<replaceable>stampante</replaceable></literal>.
						</para>

					</listitem>
					 <listitem>
						<para>
							Inserire il nome che identificherà in modo univoco questa stampante. Quindi inserire la descrizione e la posizione della stampante. Queste sono le stringhe che verranno mostrate agli utenti finali per aiutarli ad identificare le stampanti.
						</para>

					</listitem>
					 <listitem>
						<para>
							Identificare il produttore/modello della stampante, ofornire direttamente un file di descrizione della stampante di lavoro (PPD).
						</para>

					</listitem>

				</itemizedlist>
				 <para>
					Voilà, la stampante è operativa!
				</para>

			</section>

		</section>

	</section>
	 <section id="sect.http-ftp-proxy">
		<title>Proxy HTTP/FTP</title>
		 <para>
			Un proxy FTP/HTTP agisce come intermediario per connessioni HTTP o FTP. Il ruolo è duplice:
		</para>
		 <itemizedlist>
			<listitem>
				<para>
					Cache: i documenti scaricati di recente sono copiati localmente, cosa che previene scaricamenti multipli.
				</para>

			</listitem>
			 <listitem>
				<para>
					Server di filtraggio: se l'utilizzo del proxy è obbligato (e le connessioni in uscita sono bloccate a meno che non transitino per il proxy) allora il proxy può determinare quando soddisfare o negare una richiesta.
				</para>

			</listitem>

		</itemizedlist>
		 <indexterm>
			<primary>proxy HTTP/FTP</primary>
		</indexterm>
		 <indexterm>
			<primary>cache del proxy</primary>
		</indexterm>
		 <para>
			La Falcot Corporation ha scelto Squid come server proxy.
		</para>
		 <indexterm>
			<primary>Squid</primary>
		</indexterm>
		 <section>
			<title>Installazione</title>
			 <para>
				Il pacchetto <emphasis role="pkg">squid3</emphasis> di Debian contiene solo il proxy modulare (con funzione di cache). Trasformarlo in un server per il filtraggio richiede l'installazione del pacchetto addizionale <emphasis role="pkg">squidguard</emphasis>. In aggiunta <emphasis role="pkg">squid-cgi</emphasis> fornisce un interfaccia di consultazione ed amministrazione per il proxy Squid.
			</para>
			 <para>
				Prima dell'installazione bisogna accertarsi di controllare che il sistema possa identificarsi con il proprio nome completo: <command>hostname -f</command> deve restituire un nome pienamente qualificato (che include il dominio). Se così non è allora il file <filename>/etc/hosts</filename> dev'essere modificato per contenere il nome completo del sistema (per esempio, <literal>arrakis.falcot.com</literal>). Il nome ufficiale del computer dev'essere verificato con l'amministratore di rete per evitare potenziali conflitti di nome.
			</para>

		</section>
		 <section>
			<title>Configurare una cache</title>
			 <para>
				Abilitare la funzionalità di cache è una semplice questione di modifica del file di configurazione <filename>/etc/squid3/squid.conf</filename> e consente alle macchine nella rete locale di eseguire richieste attraverso il proxy. L'esempio seguente indica le modifiche eseguite dagli amministratori della Falcot Corporation:
			</para>
			 <example>
				<title>Il file <filename>/etc/squid3/squid.conf</filename> (estratti)</title>
				 
<programlisting>
# INSERIRE QUI LE PROPRIE REGOLE PER CONSENTIRE L'ACCESSO AI PROPRI CLIENT

# Regola d'esempio che consente l'accesso dalla propria rete locale.
# Adattarla per elencare tutti gli IP delle reti (interne) per le quali si
# desidera autorizzare la navigazione
acl our_networks src 192.168.1.0/24 192.168.2.0/24
http_access allow our_networks
http_access allow localhost
# Infine, negare tutti gli altri accessi a questo proxy
http_access deny all</programlisting>

			</example>

		</section>
		 <section>
			<title>Configurare un filtro</title>
			 <para>
				<command>squid</command> non esegue direttamente il filtraggio; questa azione è delegata a <command>squidGuard</command>. Il primo deve essere configurato per interagire con quest'ultimo. Questo richiede l'aggiunta delle seguenti direttive al file <filename>/etc/squid3/squid.conf</filename>:
			</para>
			 <indexterm>
				<primary><command>squidGuard</command></primary>
			</indexterm>
			 
<programlisting>
url_rewrite_program /usr/bin/squidGuard -c /etc/squid3/squidGuard.conf</programlisting>
			 <para>
				Il programma CGI <filename>/usr/lib/cgi-bin/squidGuard.cgi</filename> deve a sua volta essere installato utilizzando <filename>/usr/share/doc/squidguard/examples/squidGuard.cgi.gz</filename> come punto di partenza. Le modifiche richieste a questo script riguardano le variabili <varname>$proxy</varname> e <varname>$proxymaster</varname> (il nome del proxy ed il contatto email dell'amministratore). Le variabili <varname>$image</varname> e <varname>$redirect</varname> dovrebbero puntare ad immagini esistenti che rappresentano il rifiuto di una richiesta.
			</para>
			 <para>
				Il filtro viene abilitato con il comando <command>service squid3 reload</command>. Tuttavia, poiché il pacchetto <emphasis role="pkg">squidguard</emphasis> non filtra nulla per impostazione predefinita, è compito dell'amministratore definire le regole. Questo può essere fatto creando il file <filename>/etc/squid3/squidGuard.conf</filename> (usando <filename>/etc/squidguard/squidGuard.conf.default</filename> come modello se necessario).
			</para>
			 <para>
				Il database di produzione dev'essere rigenerato con <command>update-squidguard</command> dopo ogni modifica del file di configurazione di <command>squidGuard</command> (oppure di una delle liste di domini o URL che menziona). La sintassi del file di configurazione è documentata nel sito web: <ulink type="block" url="http://www.squidguard.org/Doc/configure.html" />
			</para>
			 <indexterm>
				<primary><command>update-squidguard</command></primary>
			</indexterm>
			 <sidebar> <title><emphasis>ALTERNATIVA</emphasis> DansGuardian</title>
			 <indexterm>
				<primary><emphasis role="pkg">dansguardian</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary>PICS</primary>
			</indexterm>
			 <para>
				Il pacchetto <emphasis role="pkg">dansguardian</emphasis> è un'alternativa a <emphasis>squidguard</emphasis>. Questo software non si limita a gestire una blacklist di URL proibiti, ma trae vantaggio dal sistema PICS (<emphasis>Platform for Internet Content Selection</emphasis>) per decidere quando una pagina è accettabile attraverso analisi dinamiche del contenuto.
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.ldap-directory">
		<title>Directory LDAP</title>
		 <indexterm>
			<primary>LDAP</primary>
		</indexterm>
		 <indexterm>
			<primary>OpenLDAP</primary>
		</indexterm>
		 <indexterm>
			<primary>directory, LDAP</primary>
		</indexterm>
		 <para>
			OpenLDAP è un'implementazione del protocollo LDAP; in altre parole, si tratta di un database progettato con lo speciale scopo di conservare directory. Il caso d'uso più comune, è l'impiego di un server LDAP per permettere di centralizzare la gestione degli account utente ed i relativi permessi. Inoltre, un database LDAP è facilmente replicato, cosa che permette di impostare sincronizzazioni multiple con altri server LDAP. Quando la rete e la base utenti crescono velocemente, il carico può essere bilanciato tra i vari server.
		</para>
		 <para>
			I dati di LDAP sono strutturati e gerarchici. La struttura è definita attraverso «schemi» che descrivono il tipo di oggetti che il database può contenere, con una lista di tutti i loro possibili attributi. La sintassi usata per riferirsi ad un particolare oggetto nel database è basata su questa struttura, cosa che spiega la sua complessità.
		</para>
		 <section>
			<title>Installazione</title>
			 <para>
				Il pacchetto <emphasis role="pkg">slapd</emphasis> contiene il server OpenLDAP. Il pacchetto <emphasis role="pkg">ldap-utils</emphasis> include strumenti a riga di comando per interagire con i server LDAP.
			</para>
			 <indexterm>
				<primary><emphasis>slapd</emphasis></primary>
			</indexterm>
			 <para>
				L'installazione di <emphasis role="pkg">slapd</emphasis> necessita normalmente di rispondere a molto poche domande ed il database risultante è improbabile che soddisfi le vostre esigenze. Fortunatamente un semplice <command>dpkg-reconfigure slapd</command> vi permetterà di riconfigurare il database LDAP con maggiori dettagli:
			</para>
			 <itemizedlist>
				<listitem>
					<para>
						Omettere la configurazione del server OpenLDAP? No, naturalmente vogliamo configurare questo servizio.
					</para>

				</listitem>
				 <listitem>
					<para>
						Nome di dominio DNS: “<literal>falcot.com</literal>”.
					</para>

				</listitem>
				 <listitem>
					<para>
						Nome dell'organizzazione: “Falcot Corp”.
					</para>

				</listitem>
				 <listitem>
					<para>
						Dev'essere inserita una password amministrativa.
					</para>

				</listitem>
				 <listitem>
					<para>
						Database di backend da usare: “MDB”.
					</para>

				</listitem>
				 <listitem>
					<para>
						Eliminare il database in caso di rimozione completa di <emphasis role="pkg">slapd</emphasis>? No. Non ha senso rischiare di perdere il database in caso di uno sbaglio.
					</para>

				</listitem>
				 <listitem>
					<para>
						Spostare il vecchio database? Questa domanda è posta solamente quando viene tentata un configurazione ed un database è già presente. Rispondere «sì» se si desidera ricominciare da un database pulito, per esempio se si esegue <command>dpkg-reconfigure slapd</command> subito dopo la prima installazione.
					</para>

				</listitem>
				 <listitem>
					<para>
						Abilitare il protocollo LDAPv2? No, non c'è motivo. Tutti gli strumenti che vogliamo utilizzare utilizzano il protocollo LDAPv3.
					</para>

				</listitem>

			</itemizedlist>
			 <sidebar> <title><emphasis>FONDAMENTALI</emphasis> Il formato LDIF</title>
			 <para>
				Un file LDIF (<emphasis>LDAP Data Interchange Format</emphasis>) è un file di testo portabile che descrive il contenuto di un database LDAP (o di una sua porzione): può quindi essere usato per inserire dati in qualsiasi altro server LDAP.
			</para>
			 <indexterm>
				<primary>LDIF</primary>
			</indexterm>
			 </sidebar> <para>
				Un database minimale è attualmente configurato, come dimostra la seguente richiesta:
			</para>
			 
<screen>
<computeroutput>$ </computeroutput><userinput>ldapsearch -x -b dc=falcot,dc=com</userinput>
<computeroutput># extended LDIF
#
# LDAPv3
# base &lt;dc=falcot,dc=com&gt; with scope sub
# filter: (objectclass=*)
# requesting: ALL
#

# falcot.com
dn: dc=falcot,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Falcot Corp
dc: falcot

# admin, falcot.com
dn: cn=admin,dc=falcot,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2
</computeroutput></screen>
			 <para>
				La richiesta restituisce due oggetti: l'organizzazione stessa e l'utente amministrativo.
			</para>

		</section>
		 <section>
			<title>Riempire la directory</title>
			 <para>
				Dato che un database vuoto non è particolarmente utile, ci apprestiamo ad inserire al suo interno tutte le directory esistenti; inclusi i database degli utenti, dei gruppi, dei servizi e degli host.
			</para>
			 <para>
				Il pacchetto <emphasis role="pkg">migrationtools</emphasis> fornisce un insieme di script dedicati ad estrarre i dati dalle directory standard di Unix (<filename>/etc/passwd</filename>, <filename>/etc/group</filename>, <filename>/etc/services</filename>, <filename>/etc/hosts</filename> e così via), convertire questi dati ed inserirli all'interno del database LDAP.
			</para>
			 <indexterm>
				<primary><emphasis role="pkg">migrationtools</emphasis></primary>
			</indexterm>
			 <para>
				Dopo averlo installato il pacchetto il file <filename>/etc/migrationtools/migrate_common.ph</filename> dev'essere modificato. Le opzioni <varname>IGNORE_UID_BELOW</varname> e <varname>IGNORE_GID_BELOW</varname> devono essere abilitate (è sufficiente decommentarle), e <varname>DEFAULT_MAIL_DOMAIN</varname><varname>DEFAULT_BASE</varname> devono essere aggiornate.
			</para>
			 <para>
				La reale operazione di migrazione è gestita dal comando <command>migrate_all_online.sh</command>, come segue:
			</para>
			 
<screen>
<computeroutput># </computeroutput><userinput>cd /usr/share/migrationtools</userinput>
<computeroutput># </computeroutput><userinput>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</userinput></screen>
			 <para>
				<command>migrate_all_online.sh</command> rivolge alcune domande a proposito del database LDAP nel quale si vogliono migrare i dati. <xref linkend="tab-migrate-all" xrefstyle="select: label nopage" /> riassume le risposte fornite nel caso d'uso della Falcot.
			</para>
			 <table colsep="1" id="tab-migrate-all">
				<title>Le risposte fornite alle domande poste dallo script <command>migrate_all_online.sh</command></title>
				 <tgroup cols="2">
					<colspec align="justify"></colspec>
					<colspec align="justify"></colspec>
					 <thead>
						<row>
							<entry>Domanda</entry>
							<entry>Risposta</entry>
						</row>

					</thead>
					 <tbody>
						<row>
							<entry>X.500 naming context</entry>
							 <entry><literal>dc=falcot,dc=com</literal></entry>

						</row>
						 <row>
							<entry>Nome host del server LDAP</entry>
							 <entry><literal>localhost</literal></entry>

						</row>
						 <row>
							<entry>Manager DN</entry>
							 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

						</row>
						 <row>
							<entry>Bind credentials</entry>
							 <entry>la password amministrativa</entry>

						</row>
						 <row>
							<entry>Create DUAConfigProfile</entry>
							 <entry>no</entry>

						</row>

					</tbody>

				</tgroup>

			</table>
			 <para>
				Abbiamo deliberatamente ignorato la migrazione del file <filename>/etc/aliases</filename> dato che lo schema standard fornito da Debian non include le strutture che utilizza questo script per gli alias email. Se dovessimo integrare questi dati nella directory il file <filename>/etc/ldap/schema/misc.schema</filename> dovrebbe essere aggiunto allo schema standard.
			</para>
			 <sidebar> <title><emphasis>STRUMENTO</emphasis> Consultare una directory LDAP</title>
			 <para>
				Il comando <command>jxplorer</command> (contenuto nell'omonimo pacchetto) è uno strumento grafico per navigare e modificare un database LDAP. È uno strumento interessante che garantisce all'amministratore una buona panoramica sulla struttura gerarchica dei dati LDAP.
			</para>
			 <indexterm>
				<primary><command>jxplorer</command></primary>
			</indexterm>
			 </sidebar> <para>
				Notare altresì l'uso dell'opzione <literal>-c</literal> con il comando <command>ldapadd</command>: questa opzione richiede che l'elaborazione non si interrompa in caso di errori. Utilizzare questa opzione è necessario poiché convertire il database <filename>/etc/services</filename> genera spesso qualche errore che può essere ignorato senza conseguenze.
			</para>

		</section>
		 <section>
			<title>Gestire gli account con LDAP</title>
			 <para>
				Ora il database LDAP contiene diverse informazioni utili ed è giunto il momento di sfruttarle. Questa sezione si concentra su come configurare un sistema Linux per far sì che le varie directory di sistema utilizzino il database LDAP.
			</para>
			 <section id="sect.config-nss">
				<title>Configurare NSS</title>
				 <para>
					Il sistema NSS (Name Service Switch, si veda il riquadro <xref linkend="sidebar.intro-nss" />) è un sistema modulare progettato per definire o recuperare informazioni sulle directory di sistema. Utilizzare LDAP come sorgente di dati per NSS richiede l'installazione del pacchetto <emphasis role="pkg">libnss-ldap</emphasis>. La sua installazione pone alcune domande; le risposte sono riassunte nella <xref linkend="tab-libnss-ldap" xrefstyle="select: label nopage" />.
				</para>
				 <indexterm>
					<primary><emphasis>libnss-ldap</emphasis></primary>
				</indexterm>
				 <table colsep="1" id="tab-libnss-ldap">
					<title>Configurare il pacchetto <emphasis role="pkg">libnss-ldap</emphasis></title>
					 <tgroup cols="2">
						<colspec align="justify"></colspec>
						 <colspec align="justify"></colspec>
						 <thead>
							<row>
								<entry>Domanda</entry>
								 <entry>Risposta</entry>

							</row>

						</thead>
						 <tbody>
							<row>
								<entry>L'Uniform Resource Identifier del server LDAP</entry>
								 <entry><literal>ldap://ldap.falcot.com</literal></entry>

							</row>
							 <row>
								<entry>Il nome distintivo per la base di ricerca</entry>
								 <entry><literal>dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>La versione di LDAP da utilizzare</entry>
								 <entry><literal>3</literal></entry>

							</row>
							 <row>
								<entry>Il database LDAP deve richiedere il login?</entry>
								 <entry>no</entry>

							</row>
							 <row>
								<entry>Privilegi speciali LDAP per root</entry>
								 <entry>si</entry>

							</row>
							 <row>
								<entry>Rendere il file di configurazione leggibile/scrivibile solo dal suo proprietario</entry>
								 <entry>no</entry>

							</row>
							 <row>
								<entry>L'account LDAP per root</entry>
								 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>La password per l'account root di LDAP</entry>
								 <entry>la password amministrativa</entry>

							</row>

						</tbody>

					</tgroup>

				</table>
				 <para>
					Il file <filename>/etc/nsswitch.conf</filename> richiede poi di essere modificato per configurare NSS in modo che utilizzi il modulo <command>ldap</command> appena installato.
				</para>
				 <example>
					<title>Il file <filename>/etc/nsswitch.conf</filename></title>
					 
<programlisting>
# /etc/nsswitch.conf
#
# Example configuration of GNU Name Service Switch functionality.
# If you have the `glibc-doc' and `info' packages installed, try:
# `info libc "Name Service Switch"' for information about this file.

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files</programlisting>

				</example>
				 <para>
					Il modulo <command>ldap</command> è generalmente inserito prima degli altri, e sarà di conseguenza richiamato per primo. L'unica eccezione degna di nota è il servizio <literal>hosts</literal> dato che contattare il server LDAP richiede prima la consultazione del DNS (per risolvere <literal>ldap.falcot.com</literal>). Senza questa eccezione, la richiesta cercherebbe di contattare il server LDAP; questo causerebbe un tentativo di risoluzione del nome per il server LDAP, e così via in un ciclo infinito.
				</para>
				 <para>
					Se il server LDAP dev'essere considerato autoritativo (e i file locali utilizzati dal modulo <command>files</command> ignorati) i servizi possono essere configurati con la seguente sintassi:
				</para>
				 <para>
					<literal><replaceable>servizio</replaceable>: ldap [NOTFOUND=return] files</literal>.
				</para>
				 <para>
					Se l'entità richiesta non esiste nel database LDAP, la richiesta restituirà una risposta «non esistente» anche se la risorsa esiste in uno dei file locali: questi file locali saranno utilizzati unicamente quando il servizio LDAP non è raggiungibile.
				</para>

			</section>
			 <section id="sect.config-pam">
				<title>Configurare PAM</title>
				 <para>
					Questa sezione descrive una configurazione di PAM (si veda il riquadro <xref linkend="sidebar.intro-pam" />) che consentirà alle applicazioni di eseguire le autenticazioni richieste attraverso il database LDAP.
				</para>
				 <sidebar> <title><emphasis>ATTENZIONE</emphasis> Rischio di rendere l'autenticazione inutilizzabile</title>
				 <para>
					Cambiare la configurazione standard di PAM utilizzata da vari programmi è un'operazione delicata. Un errore può portare all'impossibiltà di autenticarsi ovvero potrebbe impedire il login. Mantenere una shell aperta con root è una buona precauzione. Se si verificano errori potranno sempre essere corretti ed i servizi riavviati con uno sforzo minimo.
				</para>
				 </sidebar> <para>
					Il modulo LDAP per PAM è fornito dal pacchetto <emphasis role="pkg">libpam-ldap</emphasis>. L'installazione di questo pacchetto pone alcune domande molto simili a quelle viste con <emphasis role="pkg">libnss-ldap</emphasis>: alcuni parametri di configurazione (come l'URI del server LDAP) sono in realtà persino condivisi con il pacchetto <emphasis role="pkg">libnss-ldap</emphasis>. Le risposte sono riassunte in <xref linkend="tab-libpam-ldap" xrefstyle="select: label nopage" />.
				</para>
				 <indexterm>
					<primary><emphasis>libpam-ldap</emphasis></primary>
				</indexterm>
				 <table colsep="1" id="tab-libpam-ldap">
					<title>Configurazione di <emphasis>libpam-ldap</emphasis></title>
					 <tgroup cols="2">
						<colspec align="justify"></colspec>
						 <colspec align="justify"></colspec>
						 <thead>
							<row>
								<entry>Domanda</entry>
								 <entry>Risposta</entry>

							</row>

						</thead>
						 <tbody>
							<row>
								<entry>Permettere all'account amministrativo LDAP di agire come root?</entry>
								 <entry>Sì. Questo ci consente di utilizzare il comando <command>passwd</command> per cambiare le password conservate nel database LDAP.</entry>

							</row>
							 <row>
								<entry>Il database LDAP richiede il login?</entry>
								 <entry>no</entry>

							</row>
							 <row>
								<entry>L'account LDAP per root</entry>
								 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>La password per l'account root di LDAP</entry>
								 <entry>La password amministrativa del database LDAP</entry>

							</row>
							 <row>
								<entry>Algoritmo di crittografia locale da utilizzare per le password</entry>
								 <entry>cripta</entry>

							</row>

						</tbody>

					</tgroup>

				</table>
				 <para>
					L'installazione di <emphasis role="pkg">libpam-ldap</emphasis> adatta automaticamente la configurazione predefinita di PAM contenuta nei file <filename>/etc/pam.d/common-auth</filename>, <filename>/etc/pam.d/common-password</filename> e <filename>/etc/pam.d/common-account</filename>. Questo meccanismo utilizza lo strumento dedicato <command>pam-auth-update</command> (fornito con il pacchetto <emphasis role="pkg">libpam-runtime</emphasis>). Questo strumento può anche essere eseguito dall'amministratore qualora desideri abilitare o disabilitare dei moduli PAM.
				</para>
				 <indexterm>
					<primary><filename>common-auth</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-auth</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>common-password</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-password</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>common-account</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-account</filename></primary>
				</indexterm>

			</section>
			 <section>
				<title>Mettere al sicuro lo scambio dati di LDAP</title>
				 <indexterm>
					<primary>LDAP</primary>
					<secondary>sicurezza</secondary>
				</indexterm>
				 <para>
					In via predefinita il protocollo LDAP transita sulla rete come testo in chiaro: questo include le password (cifrate). Poiché le password cifrate possono essere estratte dalla rete rimangono vulnerabili ad attacchi a dizionario. Questo può essere evitato utilizzando uno strato di cifratura addizionale: abilitare questo strato è l'argomento di questa sezione.
				</para>
				 <section>
					<title>Configurazione del server</title>
					 <indexterm>
						<primary><foreignphrase>OpenSSL</foreignphrase></primary>
						<secondary>creazione delle chiavi</secondary>
					</indexterm>
					 <indexterm>
						<primary>coppia di chiavi</primary>
					</indexterm>
					 <para>
						Il primo passo richiede la creazione di una coppia di chiavi (comprensiva di chiave pubblica e chiave privata) per il server LDAP. Gli amministratori della Falcot riutilizzano <emphasis>easy-rsa</emphasis> per generarla (vedere <xref linkend="sect.easy-rsa" />). L'esecuzione di <command>./build-server-key ldap.falcot.com</command> pone alcune domande banali (luogo, nome dell'organizzazione e così via). La risposta alla domanda "common name" <emphasis>deve</emphasis> essere il nome di dominio pienamente qualificato del server LDAP; nel nostro caso <literal>ldap.falcot.com</literal>.
					</para>
					 <para>
						Questo comando crea un certificato nel file <filename>keys/ldap.falcot.com.crt</filename>; la corrispondente chiave privata è conservata nel file <filename>keys/ldap.falcot.com.key</filename>.
					</para>
					 <para>
						Ora questi tasti devono essere installati nella loro posizione standard, e dobbiamo fare in modo che il file privato sia leggibile dal server LDAP che gira sotto l'identità utente <literal>openldap</literal>:
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>adduser openldap ssl-cert
</userinput><computeroutput>Adding user `openldap' to group `ssl-cert' ...
Adding user openldap to group ssl-cert
Done.
# </computeroutput><userinput>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chmod 0640 /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem
</userinput></screen>
					 <para>
						Bisogna anche dire al demone <command>slapd</command> di usare queste chiavi per la crittografia. La configurazione del server LDAP è gestita dinamicamente: la configurazione può essere aggiornata con le normali operazioni LDAP sulla gerarchia di oggetti <literal>cn=config</literal>, ed il server aggiornerà <filename>/etc/ldap/slapd.d</filename> in tempo reale per rendere la configurazione persistente. <command>ldapmodify</command> è quindi lo strumento giusto per aggiornare la configurazione:
					</para>
					 <example>
						<title>Configurare <command>slapd</command> per la cifratura</title>
						 
<screen><computeroutput># </computeroutput><userinput>cat &gt;ssl.ldif &lt;&lt;END
dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key
-
END
</userinput><computeroutput># </computeroutput><userinput>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif
</userinput><computeroutput>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
</computeroutput></screen>

					</example>
					 <sidebar> <title><emphasis>STRUMENTO</emphasis> <command>ldapvi</command> per modificare una directory LDAP</title>
					 <indexterm>
						<primary><command>ldapvi</command></primary>
					</indexterm>
					 <para>
						Con il comando <command>ldapvi</command>, è possibile visualizzare un output LDIF di qualsiasi parte della directory LDAP, apportare alcune modifiche nell'editor di testo, e lasciare che lo strumento faccia le operazione LDAP per voi.
					</para>
					 <para>
						E' quindi un modo conveniente per aggiornare la configurazione del server LDAP, semplicemente modificando la gerarchia <literal>cn=config</literal>.
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config
</userinput></screen>
					 </sidebar> <para>
						L'ultimo passo per abilitare la cifratura richiede la modifica della variabile <varname>SLAPD_SERVICES</varname> nel file <filename>/etc/default/slapd</filename>. Inoltre, per essere prudenti, si renderà necessario disabilitare l'LDAP non sicuro.
					</para>
					 <example>
						<title>Il file <filename>/etc/default/slapd</filename></title>
						 
<programlisting>
# Default location of the slapd.conf file or slapd.d cn=config directory. If
# empty, use the compiled-in default (/etc/ldap/slapd.d with a fallback to
# /etc/ldap/slapd.conf).
SLAPD_CONF=

# System account to run the slapd server under. If empty the server
# will run as root.
SLAPD_USER="openldap"

# System group to run the slapd server under. If empty the server will
# run in the primary group of its user.
SLAPD_GROUP="openldap"

# Path to the pid file of the slapd server. If not set the init.d script
# will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf by
# default)
SLAPD_PIDFILE=

# slapd normally serves ldap only on all TCP-ports 389. slapd can also
# service requests on TCP-port 636 (ldaps) and requests via unix
# sockets.
# Example usage:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# If SLAPD_NO_START is set, the init script will not start or restart
# slapd (but stop will still work).  Uncomment this if you are
# starting slapd via some other means or if you don't want slapd normally
# started at boot.
#SLAPD_NO_START=1

# If SLAPD_SENTINEL_FILE is set to path to a file and that file exists,
# the init script will not start or restart slapd (but stop will still
# work).  Use this for temporarily disabling startup of slapd (when doing
# maintenance, for example, or through a configuration management system)
# when you don't want to edit a configuration file.
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# For Kerberos authentication (via SASL), slapd by default uses the system
# keytab file (/etc/krb5.keytab).  To use a different keytab file,
# uncomment this line and change the path.
#export KRB5_KTNAME=/etc/krb5.keytab

# Additional options to pass to slapd
SLAPD_OPTIONS=""</programlisting>

					</example>

				</section>
				 <section>
					<title>Configurare il client</title>
					 <para>
						Sul client, la configurazione per i moduli <emphasis>libpam-ldap</emphasis> e <emphasis>libnss-ldap</emphasis> deve essere modificata per usare un URI <literal>ldaps://</literal>.
					</para>
					 <para>
						I cliet LDAP devono essere in grado di autenticare il server. In un'infrastruttura a chiave pubblica X.509, i certificati pubblici sono firmati con una chiavedi un'autorità di certificazione (CA). Con <emphasis>esy-rsa</emphasis>, gli amministratori Falcot hanno creato la propria CA ed ora hanno bisogno di configurare il sistema per rendere fidate (trusted) le firme della CA di Falcot. Questo può essere fatto mettendo il certificato CA in <filename>/usr/local/share/ca-certificates</filename> ed eseguendo <command>update-ca-certificates</command>.
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt
</userinput><computeroutput># </computeroutput><userinput>update-ca-certificates
</userinput><computeroutput>Aggiornamento certificati in /etc/ssl/certs... 1 aggiunto, 0 rimossi; fatto.
Esecuzione gancio in /etc/ca-certificates/update.d....
Aggiunto debian:falcot.pem
fatto.
fatto.
</computeroutput></screen>
					 <para>
						Ultimo ma non meno importante, l'URI LDAP predefinito e la base DN predefinita utilizzati dai vari strumenti della riga di comando possono essere modificati in <filename>/etc/ldap/ldap.conf</filename>. Ciò farà risparmiare un bel po' di battitura.
					</para>
					 <example>
						<title>Il file <filename>/etc/ldap/ldap.conf</filename></title>
						 
<programlisting>#
# LDAP Defaults
#

# See ldap.conf(5) for details
# This file should be world readable but not world writable.

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# TLS certificates (needed for GnuTLS)
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt</programlisting>

					</example>

				</section>

			</section>

		</section>

	</section>
	 <section id="sect.rtc-services">
		<title>Servizi di Comunicazione Real-Time</title>
		 <para>
			I servizi Real-Time Communication (RTC) includono voce, video/webcam, instant messaging (IM) e condivisione desktop. Questo capitolo fornisce una breve introduzione a tre dei servizi necessari per il funzionamento RTC, tra cui il server TURN, server SIP e il server XMPP. i dettagli completi di come pianificare, installare e gestire questi servizi sono disponibili nella Guida rapida Real-Time Communications, che include esempi specifici di Debian. <ulink type="block" url="http://rtcquickstart.org" />
		</para>
		 <indexterm>
			<primary>VoIP</primary>
			<secondary>server</secondary>
		</indexterm>
		 <indexterm>
			<primary>RTC</primary>
			<secondary>server</secondary>
		</indexterm>
		 <indexterm>
			<primary>Instant Messaging</primary>
			<secondary>server</secondary>
		</indexterm>
		 <indexterm>
			<primary>Chat</primary>
			<secondary>server</secondary>
		</indexterm>
		 <para>
			Sia SIP e XMPP in grado di fornire le stesse funzionalità. SIP è un po' più conosciuto per voce e video mentre XMPP è tradizionalmente considerato come un protocollo di messaggistica istantanea. In realtà, entrambi possono essere utilizzati per qualsiasi di questi scopi. Per massimizzare le opzioni di connettività, si consiglia di eseguire entrambi in parallelo.
		</para>
		 <indexterm>
			<primary>SIP</primary>
		</indexterm>
		 <indexterm>
			<primary>XMPP</primary>
		</indexterm>
		 <para>
			Questi servizi si basano su certificati X.509 sia per l'autenticazione che per la riservatezza. Vedere <xref linkend="sect.easy-rsa" /> per i dettagli su come crearli. In alternativa <emphasis>Real-Time Communications Quick Start Guide</emphasis> ha anche alcune spiegazioni utili: <ulink type="block" url="http://rtcquickstart.org/guide/multi/tls.html" />
		</para>
		 <section id="sect.rtc-dns-settings">
			<title>Impostazioni DNS per i servizi RTC</title>
			 <para>
				I servizi RTC richiedono registrazioni DNS SVR e NAPTR. Un esempio di configurazione che può essere collocato nel file di zona per <literal>falcot.com</literal>:
			</para>
			 <indexterm>
				<primary>DNS</primary>
				<secondary>record SRV</secondary>
			</indexterm>
			 <indexterm>
				<primary>DNS</primary>
				<secondary>record NAPTR</secondary>
			</indexterm>
			 
<programlisting>
; the server where everything will run
server1            IN     A      198.51.100.19
server1            IN     AAAA   2001:DB8:1000:2000::19

; IPv4 only for TURN for now, some clients are buggy with IPv6
turn-server        IN     A      198.51.100.19

; IPv4 and IPv6 addresses for SIP
sip-proxy          IN     A      198.51.100.19
sip-proxy          IN     AAAA   2001:DB8:1000:2000::19

; IPv4 and IPv6 addresses for XMPP
xmpp-gw            IN     A      198.51.100.19
xmpp-gw            IN     AAAA   2001:DB8:1000:2000::19

; DNS SRV and NAPTR for STUN / TURN
_stun._udp  IN SRV    0 1 3467 turn-server.falcot.com.
_turn._udp  IN SRV    0 1 3467 turn-server.falcot.com.
@           IN NAPTR  10 0 "s" "RELAY:turn.udp" "" _turn._udp.falcot.com.

; DNS SRV and NAPTR records for SIP
_sips._tcp  IN SRV    0 1 5061 sip-proxy.falcot.com.
@           IN NAPTR  10 0 "s" "SIPS+D2T" "" _sips._tcp.falcot.com.

; DNS SRV records for XMPP Server and Client modes:
_xmpp-client._tcp  IN     SRV    5 0 5222 xmpp-gw.falcot.com.
_xmpp-server._tcp  IN     SRV    5 0 5269 xmpp-gw.falcot.com.</programlisting>

		</section>
		 <section id="sect.turn-server">
			<title>Server TURN</title>
			 <para>
				TURN è un servizio che aiuta i clienti dietro router NAT e firewall a scoprire il modo più efficace per comunicare con altri clienti e per trasmettere i flussi multimediali se non può essere trovato nessun percorso multimediale diretto. E' vivamente consigliato che il server TURN sia installato prima che tutti gli altri servizi RTC vengano offerti agli utenti finali.
			</para>
			 <indexterm>
				<primary>TURN</primary>
				<secondary>server</secondary>
			</indexterm>
			 <para>
				TURN e il relativo protocollo ICE sono degli standard aperti. Per beneficiare di questi protocolli, massimizzando la connettività e riducendo al minimo la frustrazione degli utenti, è importante assicurarsi che tutto il software client supporti ICE e TURN.
			</para>
			 <indexterm>
				<primary>ICE</primary>
			</indexterm>
			 <para>
				Perchè l'algoritmo ICE lavori in modo efficace, il server deve avere due indirizzi IPv4 pubblici.
			</para>
			 <section id="sect.turn-server-install">
				<title>Installare il server TURN</title>
				 <para>
					Installare il pacchetto <emphasis role="pkg">resiprocate-turn-server</emphasis>.
				</para>
				 <para>
					Modificare il file di configurazione <filename>/etc/reTurn/reTurnServer.config</filename>. La cosa più importante da fare è inserire gli indirizzi IP del server.
				</para>
				 
<programlisting>
# your IP addresses go here:
TurnAddress = 198.51.100.19
TurnV6Address = 2001:DB8:1000:2000::19
AltStunAddress = 198.51.100.20
# your domain goes here, it must match the value used
# to hash your passwords if they are already hashed
# using the HA1 algorithm:
AuthenticationRealm = myrealm

UserDatabaseFile = /etc/reTurn/users.txt
UserDatabaseHashedPasswords = true</programlisting>
				 <para>
					Riavvia il servizio.
				</para>

			</section>
			 <section id="sect.turn-server-management">
				<title>Gestione degli utenti TURN</title>
				 <para>
					Utilizzare l'utility htdigest per gestire l'elenco utenti del server TURN.
				</para>
				
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/reTurn/users.txt myrealm joe</userinput></screen>
				 <para>
					Utilizzare il segnale HUP signal per consentire al server di ricaricare il file <filename>/etc/reTurn/users.txt</filename> dopo la modifica o abilitare la funzione automatica di ricarica nel <filename>/etc/reTurn/reTurnServer.config</filename>.
				</para>

			</section>

		</section>
		 <section id="sect.sip-server">
			<title>Proxy Server SIP</title>
			 <para>
				Un server proxy SIP gestisce le connessioni SIP in entrata e in uscita tra le altre organizzazioni, fornitori di SIP trunking, PBXes SIP come Asterisk, telefoni SIP, softphone SIP-based e applicazioni WebRTC.
			</para>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>server</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>proxy</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>PBX</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>trunk</secondary>
			</indexterm>
			 <para>
				E' altamente raccomandato installare e configurare il proxy SIP prima di tentare una configurazione SIP PBX. Il proxy SIP normalizza la magior partedel traffico che raggiunge il PBX e fornisce una maggiore connettività e resilienza.
			</para>
			 <section id="sect.sip-server-install">
				<title>Installare il proxy SIP</title>
				 <para>
					Installare il apcchetto <emphasis role="pkg">repro</emphasis>. E' altamente raccomandato l'uso del pacchetto da <emphasis role="distribution">jessie-backports</emphasis>, in quanto ha i più recenti miglioramenti per massimizzare la connettività e la resilienza.
				</para>
				 <indexterm>
					<primary>repro</primary>
				</indexterm>
				 <para>
					Modifica il file di configurazione <filename>/etc/repro/repro.config</filename>. La cosa più importante da fare è inserire gli indirizzi IP del server. L'esempio sotto mostra come impostare correttamente sia SIP che WebSockets/WebRTC, utilizzando TLS, IPv4 e IPv6:
				</para>
				 
<programlisting>
# Transport1 will be for SIP over TLS connections
# We use port 5061 here but if you have clients connecting from
# locations with firewalls you could change this to listen on port 443
Transport1Interface = 198.51.100.19:5061
Transport1Type = TLS
Transport1TlsDomain = falcot.com
Transport1TlsClientVerification = Optional
Transport1RecordRouteUri = sip:falcot.com;transport=TLS
Transport1TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport1TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport2 is the IPv6 version of Transport1
Transport2Interface = 2001:DB8:1000:2000::19:5061
Transport2Type = TLS
Transport2TlsDomain = falcot.com
Transport2TlsClientVerification = Optional
Transport2RecordRouteUri = sip:falcot.com;transport=TLS
Transport2TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport2TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport3 will be for SIP over WebSocket (WebRTC) connections
# We use port 8443 here but you could use 443 instead
Transport3Interface = 198.51.100.19:8443
Transport3Type = WSS
Transport3TlsDomain = falcot.com
# This would require the browser to send a certificate, but browsers
# don't currently appear to be able to, so leave it as None:
Transport3TlsClientVerification = None
Transport3RecordRouteUri = sip:falcot.com;transport=WSS
Transport3TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport3TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport4 is the IPv6 version of Transport3
Transport4Interface = 2001:DB8:1000:2000::19:8443
Transport4Type = WSS
Transport4TlsDomain = falcot.com
Transport4TlsClientVerification = None
Transport4RecordRouteUri = sip:falcot.com;transport=WSS
Transport4TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport4TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport5: this could be for TCP connections to an Asterisk server
# in your internal network.  Don't allow port 5060 through the external
# firewall.
Transport5Interface = 198.51.100.19:5060
Transport5Type = TCP
Transport5RecordRouteUri = sip:198.51.100.19:5060;transport=TCP

HttpBindAddress = 198.51.100.19, 2001:DB8:1000:2000::19
HttpAdminUserFile = /etc/repro/users.txt

RecordRouteUri = sip:falcot.com;transport=tls
ForceRecordRouting = true
EnumSuffixes = e164.arpa, sip5060.net, e164.org
DisableOutbound = false
EnableFlowTokens = true
EnableCertificateAuthenticator = True</programlisting>
				 <para>
					Utilizzare l'utility di comando <command>htdigest</command> per gestire la password dell'amministratore per l'interfaccia web. Il nome utente deve essere <emphasis>admin</emphasis> ed il nome di dominio deve corrispondere al valore specificato in <filename>repro.config</filename>.
				</para>
				 
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/repro/users.txt repro admin</userinput></screen>
				 <para>
					Riavvia il servizio per usare la nuova configurazione.
				</para>

			</section>
			 <section id="sect.sip-server-management">
				<title>Gestione del proxy SIP</title>
				 <para>
					Vai all'interfaccia web all'indirizzo <literal>http://sip-proxy.falcot.com:5080</literal> per completare la configurazione ed aggiungere domini, utenti locali e route statiche.
				</para>
				 <para>
					Il primo passo è quello di aggiungere il dominio locale. Il processo deve essere riavviato dopo aggiunta o la rimozione di domini dall'elenco.
				</para>
				 <para>
					Il proxy sa come instradare le chiamate tra utenti locali e indirizzo completo SIP, la configurazione di routing è necessaria solo per sovrascritture del comportamento predefinito, ad esempio, per riconoscere i numeri di telefono, aggiungere un prefisso e instradarli a un provider SIP.
				</para>

			</section>

		</section>
		 <section id="sect.xmpp-server">
			<title>Server XMPP</title>
			 <para>
				Un server XMPP gestisce la connettività tra gli utenti XMPP locali e gli utenti XMPP in altri domini su Internet pubblico.
			</para>
			 <indexterm>
				<primary>XMPP</primary>
				<secondary>server</secondary>
			</indexterm>
			 <sidebar> <title><emphasis>VOCABOLARIO</emphasis> XMPP o Jabber?</title>
			 <indexterm>
				<primary>Jabber</primary>
			</indexterm>
			 <para>
				XMPP è a volte indicato come Jabber. In realtà, Jabber è un marchio e XMPP è il nome ufficiale dello standard.
			</para>
			 <indexterm>
				<primary>Jabber</primary>
			</indexterm>
			 </sidebar> <para>
				Prosody è un popolare server XMPP che opera in modo affidabile su server Debian.
			</para>
			 <indexterm>
				<primary>Prosody</primary>
			</indexterm>
			 <section id="sect.xmpp-server-install">
				<title>Installa il server XMPP</title>
				 <para>
					Installare il pacchetto <emphasis role="pkg">prosody</emphasis>. E' altamente raccomandato l'uso del pacchetto da <emphasis role="distribution">jessie-backports</emphasis> , in quanto ha i più recenti miglioramenti per massimizzare la connettività e la resilienza.
				</para>
				 <indexterm>
					<primary>Prosody</primary>
				</indexterm>
				 <para>
					Rivedere il file di configurazione <filename>/etc/prosody/prosody.cfg.lua</filename>. La cosa più importante da fare è inserire i JIDs degli utenti che hanno il permesso di gestire il server.
				</para>
				 
<programlisting>
admins = { "joe@falcot.com" }</programlisting>
				 <para>
					E' necessario un file di configurazione individuale per ogni dominio. Copiare l'esempio da <filename>/etc/prosody/conf.avail/example.com.cfg.lua</filename> ed usarlo come punto di partenza. Qui è <literal>falcot.com.cfg.lua</literal>:
				</para>
				 
<programlisting>
VirtualHost "falcot.com"
        enabled = true
        ssl = {
                key = "/etc/ssl/private/falcot.com-key.pem";
                certificate = "/etc/ssl/public/falcot.com.pem";
                }</programlisting>
				 <para>
					Per abilitare il dominio ci deve essere un collegamento simbolico a<filename>/etc/prosody/conf.d/</filename>. Crearlo in questo modo:
				</para>
				 
<screen><computeroutput># </computeroutput><userinput>ln -s /etc/prosody/conf.avail/falcot.com.cfg.lua /etc/prosody/conf.d/</userinput></screen>
				 <para>
					Riavvia il servizio per usare la nuova configurazione.
				</para>

			</section>
			 <section id="sect.xmpp-server-management">
				<title>Gestione del server XMPP</title>
				 <para>
					Alcune operazioni di gestione possono essere eseguite utilizzando l'utility da riga di comando <literal>prosodyctl</literal>. Per esempio, per aggiungere l'account amministratore specificato in <filename>/etc/prosody/prosody.cfg.lua</filename>:
				</para>
				
<programlisting>
# prosodyctl adduser joe@falcot.com</programlisting>
				 <para>
					Vedere <ulink url="http://prosody.im/doc/configure">Documentazione online di Prosody</ulink> per maggiori dettagli su come personalizzare la configurazione.
				</para>

			</section>

		</section>
		 <section id="sect.rtc-port-443">
			<title>Servizi in esecuzione sulla porta 443</title>
			 <para>
				Alcuni amministratori preferiscono eseguire tutti i loro servizi RTC sulla porta 443. Ciò consente agli utenti di collegarsi da postazioni remote come alberghi e aeroporti dove altre porte potrebbero essere bloccate o il traffico Internet venire instradato attraverso server proxy HTTP.
			</para>
			 <para>
				Per utilizzare questa strategia, ogni servizio (SIP, XMPP e TURN) ha bisogno di un indirizzo IP diverso. Tutti i servizi possono essere ancora sullo stesso host poiché Linux supporta più indirizzi IP su un singolo host. Il numero della porta, 443, deve essere specificato nel file di configurazione per ogni processo e anche nei record DNS SRV.
			</para>

		</section>
		 <section id="sect.rtc-webrtc">
			<title>Aggiungere WebRTC</title>
			 <para>
				La Falcot vuole consentire ai clienti di effettuare chiamate telefoniche direttamente dal sito web. Gli amministratori Falcot vogliono anche usare WebRTC come parte del loro piano di disaster recovery, possono utilizzare per uso personale il browser web a casa per accedere al sistema telefonico aziendale e lavorare normalmente in caso di emergenza.
			</para>
			 <indexterm>
				<primary>WebRTC</primary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>WebSocket</secondary>
			</indexterm>
			 <sidebar> <title><emphasis>IN PRATICA</emphasis> Provare WebRTC</title>
			 <indexterm>
				<primary>WebRTC</primary>
				<secondary>dimostrazione</secondary>
			</indexterm>
			 <para>
				Se non hai provato WebRTC prima, ci sono diversi siti che danno una dimostrazione online e strutture di prova. <ulink type="block" url="http://www.sip5060.net/test-calls" />
			</para>
			 </sidebar> <para>
				WebRTC è una tecnologia in rapida evoluzione ed è essenziale per utilizzare i pacchetti dalle distribuzioni <emphasis role="distribution">jessie-backports</emphasis> o <emphasis role="distribution">Testing</emphasis>.
			</para>
			 <para>
				JS Communicator è un generico, telefono WebRTC non marchiato che non richiede alcun scripting lato server come PHP. E 'costruito esclusivamente con HTML, CSS e JavaScript. E 'la base per molti altri servizi WebRTC e moduli per altri framework web publishing avanzati. <ulink type="block" url="http://jscommunicator.org" />
			</para>
			 <indexterm>
				<primary>JSCommunicator</primary>
			</indexterm>
			 <para>
				Il pacchetto <emphasis role="pkg">jscommunicator-web-phone</emphasis> è il modo più rapido per installare un telefono WebRTC in un sito web. E' richiesto un proxy SIP con un trasporto WebSocket. Le istruzioni nella <xref linkend="sect.sip-server-install" /> contengono i dettagli necessari per consentire il trasporto WebSocket nel proxy SIP <emphasis role="pkg">repro</emphasis>.
			</para>
			 <para>
				Dopo l'installazione di <emphasis role="pkg">jscommunicator-web-phone</emphasis>, ci sono vari modi per usarlo. Una strategia semplice è quello di includere o copiare la configurazione da <filename>/etc/jscommunicator-web-phone/apache.conf</filename> nella configurazione di un host virtuale di Apache.
			</para>
			 <para>
				Una volta che i file web-phone sono disponibili nel server web, personalizzare il <filename>/etc/jscommunicator-web-phone/config.js</filename> per puntare al server TURN ed al proxy SIP. Per esempio:
			</para>
			 
<programlisting>
JSCommSettings = {

  // Web server environment
  webserver: {
    url_prefix: null            // If set, prefix used to construct sound/ URLs
  },

  // STUN/TURN media relays
  stun_servers: [],
  turn_servers: [
    { server:"turn:turn-server.falcot.com?transport=udp", username:"joe", password:"j0Ep455d" }
  ],

  // WebSocket connection
  websocket: {
      // Notice we use the falcot.com domain certificate and port 8443
      // This matches the Transport3 and Transport4 example in
      // the falcot.com repro.config file
    servers: 'wss://falcot.com:8443',
    connection_recovery_min_interval: 2,
    connection_recovery_max_interval: 30
  },

  ...</programlisting>
			 <para>
				Siti web click-to-call più avanzati utilizzano generalmente script lato server per generare dinamicamente il file <literal>config.js</literal>. Il codice sorgente di <ulink url="http://drucall.org">DruCall</ulink> dimostra come farlo con PHP.
			</para>
			 <indexterm>
				<primary>DruCall</primary>
			</indexterm>
			 <para>
				Questo capitolo ha unicamente dato dimostrazione di una piccola parte dei software disponibili per i sistemi server: tuttavia molti dei servizi di rete comuni sono stati descritti. Ora è tempo di passare ad un capitolo ancora più tecnico: scenderemo ancor più in profondità su alcuni concetti, descrivendo implementazioni massive e virtualizzazione.
			</para>

		</section>

	</section>
</chapter>

