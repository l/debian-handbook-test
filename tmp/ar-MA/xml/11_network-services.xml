<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="network-services" lang="ar-MA">
	<chapterinfo>
		 <keywordset>
			<keyword>Postfix</keyword>
			 <keyword>Apache</keyword>
			 <keyword>NFS</keyword>
			 <keyword>Samba</keyword>
			 <keyword>Squid</keyword>
			 <keyword>OpenLDAP</keyword>
			 <keyword>SIP</keyword>

		</keywordset>

	</chapterinfo>
	 <title>خدمات الشبكة: Postfix،‏ Apache،‏ NFS،‏ Samba،‏ Squid،‏ LDAP،‏ SIP،‏ XMPP،‏ TURN</title>
	 <highlights> <para>
		خدمات الشبكة هي البرامج التي يتعامل معها المستخدمون مباشرة في عملهم اليومي. هذه الخدمات هي قمة هرم النظام المعلوماتي، ويركز هذا الفصل عليها؛ أما جذع ذاك الهرم فهي البنية التحتية التي تعرضنا لها من قبل.
	</para>
	 <para>
		تتطلب العديد من الخدمات الشبكية تقنية تشفير حتى تعمل بشكل آمن وموثوق، خصوصاً عند استخدامها عبر الإنترنت العمومي. تستخدم شهادات X.509 (التي يشار إليها أيضاً باسم شهادات SSL أو شهادات TLS) عادة لهذا الغرض. يمكن تشارك شهادة النطاق الواحدة عادة بين عدة خدمات من الخدمات التي سنناقشها في هذا الفصل.
	</para>
	 <indexterm>
		<primary>TLS</primary>
	</indexterm>
	 <indexterm>
		<primary>X.509</primary>
	</indexterm>
	 <indexterm>
		<primary>شهادات</primary>
	</indexterm>
	 </highlights> <section id="sect.smtp-mail-server">
		<title>مخدم البريد الإلكتروني</title>
		 <para>
			اختار مديرو النظم في شركة فلكوت Postfix كمخدم للبريد الإلكتروني، وذلك لموثوقيته وسهولة إعداده. وفعلاً، يفرض تصميمه استخدام عملية منفصلة تتمتع مجموعة صغيرة من الصلاحيات لكل واحدة من مهماته، وهذا إجراء ممتاز للحد من ضرر المشاكل الأمنية.
		</para>
		 <indexterm>
			<primary>بريد إلكتروني</primary>
			<secondary>مخدم</secondary>
		</indexterm>
		 <indexterm>
			<primary>مخدم بريد إلكتروني</primary>
		</indexterm>
		 <indexterm>
			<primary>Postfix</primary>
		</indexterm>
		 <sidebar> <title><emphasis>بدائل</emphasis> مخدم Exim4</title>
		 <indexterm>
			<primary>Exim</primary>
		</indexterm>
		 <para>
			تستخدم دبيان مخدم Exim4 كمخدم افتراضي للبريد الإلكتروني (لذلك يرفق Exim4 مع التثبيت الأولي). الإعدادات متوفرة في حزمة منفصلة، هي <emphasis role="pkg">exim4-config</emphasis>، وهي تخصص آلياً اعتماداً على إجابات مجموعة من أسئلة Debconf تشبه كثيراً الأسئلة التي تطرحها الحزمة <emphasis role="pkg">postfix</emphasis>.
		</para>
		 <para>
			إما أن تكون الإعدادات في ملف مفرد (<filename dir="ltr">/etc/exim4/exim4.conf.template</filename>) أو منفصلة في عدد من ملفات الضبط المخزنة في المجلد <filename dir="ltr">/etc/exim4/conf.d/</filename>. في كلا الحالتين، يستخدم <command>update-exim4.conf</command> الملفات كقالب لتوليد الملف <filename dir="ltr">/var/lib/exim4/config.autogenerated</filename>. يستخدم Exim4 الملف الأخير. بفضل هذه الآلية، يمكن حقن القيم المأخوذة من إعدادات debconf للمخدم Exim —المخزَّنة في <filename dir="ltr">/etc/exim4/update-exim4.conf.conf</filename>— في ملف إعداد Exim، حتى عندما يُعدِّل مدير النظام أو الحزم الأخرى على إعدادات Exim الافتراضية.
		</para>
		 <para>
			صيغة إعدادات Exim4 لها خصوصياتها وتحتاج زمناً لتعلمها؛ لكن إذا فهمت هذه الخصوصيات، فإن Exim4 هو مخدم بريد إلكتروني مكتمل وقوي جداً، كما تشهد عشرات صفحات الوثائق. <ulink type="block" url="http://www.exim.org/docs.html" />
		</para>
		 </sidebar> <section>
			<title>تثبيت Postfix</title>
			 <para>
				تتضمن الحزمة <emphasis role="pkg">postfix</emphasis> خدمة SMTP الرئيسية. أما الحزم الأخرى (مثل <emphasis role="pkg">postfix-ldap</emphasis> و<emphasis role="pkg">postfix-pgsql</emphasis>) فهي تضيف وظائف زائدة إلى Postfix، منها الوصول إلى قواعد معطيات جهات الاتصال. عليك تثبيتها فقط إذا كنت تعرف أنك تحتاجها.
			</para>
			 <sidebar id="sidebar.smtp"> <title><emphasis>أساسيات</emphasis> SMTP</title>
			 <indexterm>
				<primary>SMTP</primary>
			</indexterm>
			 <indexterm>
				<primary>Simple Mail Transfer Protocol</primary>
			</indexterm>
			 <indexterm>
				<primary>مخدم</primary>
				<secondary>SMTP</secondary>
			</indexterm>
			 <para>
				SMTP‏ (<emphasis>Simple Mail Transfer Protocol</emphasis>) هو البروتوكول الذي تستخدمه مخدمات البريد الإلكتروني لتبادل وتوجيه الرسائل الإلكترونية.
			</para>
			 </sidebar> <para>
				تطرح Debconf عدة أسئلة أثناء تثبيت الحزمة. تسمح الإجابات بتوليد نسخة أولية من ملف الإعداد <filename dir="ltr">/etc/postfix/main.cf</filename>.
			</para>
			 <para>
				يستفسر السؤال الأول عن نوع الإعداد. هناك إجابتين فقط من الإجابات المقترحة تناسب حالة المخدمات المتصلة بالإنترنت، هما ”Internet site“ و ”Internet with smarthost“. الأول مناسب للمخدمات التي تستقبل البريد الوارد وترسل البريد الصادر مباشرة إلى متلقيه، ولذلك فهو يناسب حالة شركة فلكوت تماماً. أما الثاني فيلائم المخدمات التي تستقبل البريد الوارد بشكل طبيعي، لكنها ترسل البريد الصادر عبر مخدم SMTP وسيط —”المضيف الذكي smarthost“— بدلاً من إرسالها مباشرة إلى المخدم المتلقي. يناسب هذا الخيار كثيراً الأفراد الذين يملكون عناوين IP ديناميكية، لأن العديد من مخدمات البريد الإلكتروني ترفض الرسائل الواردة من هذه العناوين. في هذه الحالة، سيكون المضيف الذكي عادة مخدم SMTP تابع لمزود خدمة الإنترنت، ويكون مُعدّاً بحيث يستقبل دوماً البريد الوارد من زبائن المزود وتوجيهها بشكل مناسب. هذا الإعداد (مع المضيف الذكي) يناسب أيضاً المخدمات التي لا تتصل بالإنترنت دائماً، حتى تتفادى إدارة رتل من الرسائل غير المسلّمة التي يجب إعادة محاولة إرسالها لاحقاً.
			</para>
			 <sidebar> <title><emphasis>مصطلحات</emphasis> ISP</title>
			 <indexterm>
				<primary>ISP, Internet Service Provider</primary>
			</indexterm>
			 <para>
				ISP هو اختصار للعبارة ”Internet Service Porvider“ (مزود خدمة الإنترنت). يشير المصطلح إلى الهيئة (غالباً شركة تجارية) التي تزود اتصالات بالإنترنت والخدمات الأساسية المرتبطة بها (بريد إلكتروني، أخبار، وغيرها) إلى زبائنها.
			</para>
			 <para>
			</para>
			 </sidebar> <para>
				يهتم السؤال الثاني بالاسم الكامل للجهاز، الذي سيستخدم لتوليد عناوين البريد الإلكتروني اعتماداً على اسم المستخدم المحلي (هذا هو الجزء الذي يوضع خلف علامة ”@“). في حالة فلكوت، يجب أن تكون الإجابة <literal>mail.falcot.com</literal>. هذا هو السؤال الوحيد الذي يطرح افتراضياً، لكن الإعداد الناتج ليس كاملاً كفاية بالنسبة لحاجات فلكوت، لذلك استدعى مديرو النظم الأمر <command>dpkg-reconfigure postfix</command> حتى يتمكنوا من تخصيص المزيد من المتغيرات.
			</para>
			 <para>
				أحد الأسئلة الإضافية يطلب جميع أسماء النطاقات المرتبطة بهذا الجهاز. تتضمن القائمة الافتراضية الاسم الكامل بالإضافة لبضعة مرادفات للاسم <literal>localhost</literal>. لكن يجب إضافة النطاق الرئيسي <literal>falcot.com</literal> يدوياً. بصورة عامة، يجب إجابة هذا السؤال بإعطاءه جميع أسماء النطاقات التي سيعمل هذا المخدم معها كمخدم MX؛ بكلمات أخرى، جميع أسماء النطاقات التي يبين مخدم DNS أنها تستطيع استقبال البريد الإلكتروني. ينتهي المطاف بهذه المعلومات في المتغير <literal>mydestination</literal> في الملف <filename dir="ltr">/etc/postfix/main.cf</filename> (ملف الإعداد الرئيسي لمخدم Postfix).
			</para>
			 <indexterm>
				<primary>مخدم</primary>
				<secondary>MX</secondary>
			</indexterm>
			 <indexterm>
				<primary>MX</primary>
				<secondary>مخدم</secondary>
			</indexterm>
			 <figure>
				<title>دور السجل <emphasis>MX</emphasis> (سجل DNS) أثناء إرسال البريد</title>
				 <mediaobject>
					<imageobject>
						<imagedata fileref="images/mail-server.png" format="PNG" scalefit="1" width="60%" />
					</imageobject>

				</mediaobject>

			</figure>
			 <sidebar> <title><emphasis>إضافة</emphasis> الاستعلام عن سجلات MX</title>
			 <para>
				عندما لا يحوي DNS سجل MX لنطاق ما، سيحاول مخدم البريد إرسال الرسائل إلى المضيف نفسه، عبر استخدام سجل A الموافق (أو AAAA في IPv6).
			</para>
			 </sidebar> <para>
				في بعض الحالات، قد يسأل التثبيت أيضاً عن الشبكات التي يجب السماح لها بإرسال البريد عبر الجهاز. في الإعداد الافتراضي، يقبل Postfix الرسائل الإلكترونية التي ترد من الجهاز نفسه فقط؛ لذلك نحتاج إضافة الشبكة المحلية عادة. أضاف مديرو النظم في شركة فلكوت <literal>192.168.0.0/16</literal> إلى الإجابة الافتراضية. إذا لم يطرح عليك هذا السؤال، فالمتغير الموافق له في ملف الإعداد هو <literal>mynetworks</literal>، كما هو واضح في المثال أدناه.
			</para>
			 <para>
				كما يمكن أيضاً توصيل البريد المحلي عبر <command>procmail</command>. تسمح هذه الأداة للمستخدمين بترتيب بريدهم الوارد وفق القواعد المخزنة في ملف <filename dir="ltr">~/.procmailrc</filename> الخاص بكل مستخدم.
			</para>
			 <indexterm>
				<primary><command>procmail</command></primary>
			</indexterm>
			 <indexterm>
				<primary>بريد إلكتروني</primary>
				<secondary>ترشيح</secondary>
			</indexterm>
			 <indexterm>
				<primary>ترشيح البريد الإلكتروني</primary>
			</indexterm>
			 <para>
				بعد هذه الخطوة الأولى، حصل مديرو النظم على ملف الإعداد التالي؛ الذي سيستخدمونه كنقطة انطلاق لإضافة بعض الوظائف الأخرى كما هو مشروح في الأقسام التالية.
			</para>
			 <example>
				<title>ملف <filename dir="ltr">/etc/postfix/main.cf</filename> الأولي</title>
				 
<programlisting>
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</programlisting>

			</example>
			 <sidebar> <title><emphasis>أمن</emphasis> شهادات <emphasis>زيت الثعبان</emphasis></title>
			 <para>
				الشهادات التي تدعى شهادات <emphasis>زيت الثعبان</emphasis> (snake oil)، مثل ”دواء“ <emphasis>زيت الثعبان</emphasis> الذي كان يبيعه المشعوذون عديمو الضمير في الأيام الخالية، ليس لها أي قيمة على الإطلاق: فلا يمكنك الاعتماد عليها للتحقق من هوية المخدم لأنها تولَّد آلياً ومُوقّعة ذاتياً (self-signed). لكنها تفيد في زيادة خصوصية التبادلات على أي حال.
			</para>
			 <para>
				بصورة عامة، يجب استخدام هذه الشهادات لأغراض الاختبار فقط، أما الخدمات النظامية فيجب أن تستخدم شهادات حقيقية؛ التي تُولَّد حسب الطريقة المبيّنة في <xref linkend="sect.easy-rsa" />.
			</para>
			 </sidebar>
		</section>
		 <section id="sect.configuring-virtual-domains">
			<title>إعداد النطاقات الظاهرية</title>
			 <indexterm>
				<primary>نطاق</primary>
				<secondary>ظاهري</secondary>
			</indexterm>
			 <indexterm>
				<primary>ظاهري، نطاق</primary>
			</indexterm>
			 <para>
				يستطيع مخدم البريد استقبال الرسائل الإلكترونية المرسلة إلى نطاقات أخرى بالإضافة إلى النطاق الرئيسي؛ تُعرَف هذه النطاقات باسم النطاقات الظاهرية (Virtual Domains). في معظم الحالات التي يحدث فيها هذا، لا تكون الرسائل موجهة في النهاية إلى المستخدمين المحليين. يُقدِّم Postfix ميزتين تفيدان في إدارة النطاقات الظاهرية.
			</para>
			 <sidebar> <title><emphasis>تحذير</emphasis> النطاقات الظاهرية والنطاقات الأصلية</title>
			 <para>
				يجب عدم الإشارة لأي نطاق ظاهري في المتغير <literal>mydestination</literal>؛ فهذا المتغير يحوي فقط أسماء النطاقات ”الاصلية canonical“ التي ترتبط مباشرة مع الجهاز مستخدميه المحليين.
			</para>
			 </sidebar> <section>
				<title>النطاقات الظاهرية للأسماء المستعارة</title>
				 <indexterm>
					<primary>اسم مستعار</primary>
					<secondary>النطاقات الظاهرية للأسماء المستعارة</secondary>
				</indexterm>
				 <indexterm>
					<primary>نطاق ظاهري</primary>
					<secondary>النطاقات الظاهرية للأسماء المستعارة</secondary>
				</indexterm>
				 <para>
					لا يحوي نطاق الأسماء المستعارة الظاهري إلا أسماء مستعارة (aliases) فقط، أي عناوين تستخدم لتوجيه الرسائل إلى عناوين أخرى فقط.
				</para>
				 <para>
					تُنشّط هذه النطاقات بإضافة أسمائها إلى المتغير <literal>virtual_alias_domains</literal>، والإشارة إلى ملف مقابلة الأسماء في المتغير <literal>virtual_alias_maps</literal>.
				</para>
				 <example>
					<title>السطور التي ستضاف إلى الملف <filename>/etc/postfix/main.cf</filename></title>
					 
<programlisting>
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual
</programlisting>

				</example>
				 <para>
					يُعرِّف الملف <filename dir="ltr">/etc/postfix/virtual</filename> التقابلات بصيغة بسيطة نوعاً ما: كل سطر يحوي حقلين تفصلهما مسافة بيضاء؛ الحقل الأول هو الاسم المستعار، أما الحقل الثاني فيحوي قائمة بالعناوين البريدية التي يشير إليها ذلك الاسم. تغطي الصيغة الخاصة <literal dir="ltr">@domain.com</literal> جميع الأسماء المستعارة المتبقية في النطاق.
				</para>
				 <example>
					<title>مثال عن الملف <filename dir="ltr">/etc/postfix/virtual</filename></title>
					 
<programlisting>
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com
</programlisting>

				</example>

			</section>
			 <section>
				<title>نطاقات صناديق البريد الظاهرية</title>
				 <sidebar> <title><emphasis>تحذير</emphasis> نطاقات ظاهرية مزدوجة</title>
				 <para>
					لا يسمح Postfix باستخدام النطاق نفسه في <literal>virtual_alias_domains</literal> و <literal>virtual_mailbox_domains</literal> معاً، لكن جميع النطاقات في <literal>virtual_mailbox_domains</literal> تضاف ضمنياً إلى <literal>virtual_alias_domains</literal>، وهذا يسمح بالجمع بين الأسماء المستعارة والصناديق البريدية في نطاق ظاهري واحد.
				</para>
				 </sidebar> <indexterm>
					<primary>صندوق بريد، نطاق ظاهري</primary>
				</indexterm>
				 <indexterm>
					<primary>نطاق ظاهري</primary>
					<secondary>نطاق ظاهري لصناديق البريد</secondary>
				</indexterm>
				 <para>
					تُخزَّن الرسائل المرسلة إلى نطاقات صناديق البريد الظاهرية في صناديق بريدية غير مرتبطة بأي مستخدم محلي للنظام.
				</para>
				 <para>
					لتفعيل نطاق صناديق بريد ظاهري يجب إضافة اسم هذا النطاق إلى المتغير <literal>virtual_mailbox_domains</literal>، والإشارة إلى ملف تقابل الصناديق البريدية في المتغير <literal>virtual_mailbox_maps</literal>. أما المتغير <literal>virtual_mailbox_base</literal> فيحوي المجلد الذي تخزن الصناديق البريدية فيه.
				</para>
				 <para>
					يشير المتغير <literal>virtual_uid_maps</literal> (أو المتغير <literal>virtual_gid_maps</literal>) إلى الملف الذي يحوي التقابلات بين العنوان البريدي ومستخدم النظام (أو المجموعة) الذي ”يملك“ هذا الصندوق البريدي. لمنح ملكية جميع الصناديق البريدية إلى مستخدم واحد أو مجموعة، يمكن استخدام الصيغة <literal>static:5000</literal> التي تسند قيمة UID/GID ثابتة (القيمة 5000 هنا).
				</para>
				 <example>
					<title>السطور التي ستضاف إلى الملف <filename>/etc/postfix/main.cf</filename></title>
					 
<programlisting>
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts
</programlisting>

				</example>
				 <para>
					صيغة الملف <filename dir="ltr">/etc/postfix/vmailbox</filename> بسيطة جداً أيضاً: حقلين تفصلهما مسافة بيضاء. الحقل الأول هو عنوان بريد إلكتروني ضمن أحد النطاقات الظاهرية، والثاني موقع صندوق البريد المرتبط معه (نسبةً إلى المجلد المحدّد في <emphasis>virtual_mailbox_base</emphasis>). إذا انتهى اسم صندوق البريد بشرطة مائلة امامية (<literal>/</literal>)، ستخزّن الرسائل الإلكترونية في صيغة <emphasis>maildir</emphasis>؛ وإلا سوف تستخدم صيغة <emphasis>mbox</emphasis> التقليدية بدلاً منها. تَستخدِم صيغة <emphasis>maildir</emphasis> مجلداً كاملاً لتخزين صندوق البريد، وكل رسالة مفردة تُخزَّن في ملف منفصل. أما في صيغة <emphasis>mbox</emphasis>، فيخزن صندوق البريد كله في ملف واحد، وكل سطر يبدأ بالصيغة ”<literal dir="ltr">From </literal>“ (كلمة <literal>From</literal> تليها مسافة) تشير إلى بداية رسالة جديدة.
				</para>
				 <example>
					<title>الملف <filename dir="ltr">/etc/postfix/vmailbox</filename></title>
					 
<programlisting>
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie
</programlisting>

				</example>

			</section>

		</section>
		 <section id="sect.restrictions-for-receiving-and-sending">
			<title>قيود الاستقبال والإرسال</title>
			 <para>
				تتطلب الأعداد المتزايدة من الرسائل غير المرغوبة (<emphasis>spam</emphasis>) زيادة التشديدات على السائل التي يجب أن يقبلها مخدم البريد. يعرض هذا القسم بعض الاستراتيجيات المضمنة في Postfix.
			</para>
			 <sidebar> <title><emphasis>ثقافة</emphasis> مشكلة الرسائل الدعائية</title>
			 <indexterm>
				<primary>spam</primary>
			</indexterm>
			 <para>
				الرسائل الدعائية أو ”spam“ هو مصطلح عام يستخدم للإشارة إلى كل الرسائل التجاريو غير المرغوبة (تدعى أيضاً UCE، أي unsolicited commercial emails) التي تُغرق صناديق البريد؛ ويدعى الأشخاص عديمو الضمير الذين يرسلونها باسم spammers. لا يهتم هؤلاء إلا قليلاً بالإزعاج الذي يسببونه، لأن كلفة إرسال الرسائل الإلكترونية منخفضة جداً، ويكفي جذب نسبة صغيرة جداً من مستقبلي رسائل هذه العروض حتى تجني العملية الدعائية أموالاً تفوق كلفتها. العملية مؤتمتة في معظمها، وأي عنوان بريد ينشر علناً (مثلاً، في منتدى، أو في أرشيف قائمة بريدية، أو على مدونة، وغيرها) ستكتشفها روبوتات الرسائل الدعائية، وستتعرض لسيل لا ينقطع من الرسائل غير المرغوبة.
			</para>
			 <para>
				يحاول جميع مديرو النظم مجابهة هذا الإزعاج بمرشحات الرسائل الدعائية، لكن طبعاً يستمر spammers في التكيف في سبيل المرور عبر هذه المرشحات. بل إن بعضهم يطلب خدمات من جماعات إجرامية لاستئجار شبكات من الأجهزة المصابة بدودة. تقدر الإحصائيات الأخيرة أن الرسائل الدعائية تشكل حتى 95% من مجمل الرسائل الإلكترونية التي تنتقل عبر الإنترنت!
			</para>
			 </sidebar> <section>
				<title>تقييد الوصول حسب عناوين IP</title>
				 <para>
					يتحكم المتغير <literal>smtpd_client_restrictions</literal> بالأجهزة التي يسمح لها بالتواصل مع مخدم البريد الإلكتروني.
				</para>
				 <example>
					<title>القيود المفروضة اعتماداً على عنوان العميل</title>
					 
<programlisting>
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org
</programlisting>

				</example>
				 <para>
					عندما يحوي المتغير مجموعة من القواعد، كما في المثال أعلاه، تقيّم هذه القواعد بالترتيب، من الأولى حتى الأخيرة. كل قاعدة إما أن تقبل الرسالة، أو ترفضها، أو تترك القرار للقاعدة التالية. ولذلك فالترتيب مهم، ومجرد التبديل بين قاعدتين قد يؤدي لتغيير كبير في السلوك.
				</para>
				 <para>
					تقبل التعليمة التوجيهية <literal>permit_mynetworks</literal> المستخدمة كقاعدة أولى كل الرسائل الإلكترونية التي ترد من جهاز من الشبكة المحلية (المحددة في متغير الإعداد <emphasis>mynetworks</emphasis>).
				</para>
				 <para>
					أما التعليمة التوجيهية الثانية فترفض في الحالة الطبيعية الرسائل التي ترد من الأجهزة التي لا تملك إعدادات DNS صحيحة بالكامل. هذه الإعدادات الصحيحة بالكامل تعني أن استبيان عنوان IP يعطي اسماً، وأن استبيان الاسم يعطي بدوره عنوان IP نفسه. هذا القيد صارم جداً غالباً، لأن معظم مخدمات البريد الإلكتروني لا تملك DNS عكسي لعناوين IP الخاصة بها. ولهذا السبب سبق مديرو النظم في فلكوت التعليمة <literal>reject_unknown_client</literal> بالخيار <literal>warn_if_reject</literal>: يؤدي هذا الخيار لاستبدال عملية الرفض بتحذير بسيط يُسجَّل في السجلات. يستطيع بعدها مديرو النظم متابعة عدد الرسائل التي كانت سترفض لو كانت القاعدة نشطة فعلاً، واتخاذ قرار لاحق بعد حسن اطلاع لتفعيل هذا القيد أو عدم تفعيله.
				</para>
				 <sidebar> <title><emphasis>تلميح</emphasis> جداول <emphasis>access</emphasis></title>
				 <para>
					تتضمن معايير التقييد جداول يستطيع تعديلها مدير النظام تحوي مجموعاغت من المرسلين، وعناوين IP، وأسماء الأجهزة المحظورة أو المسموحة. يمكن إنشاء هذه الجداول اعتماداً على نسخة غير مضغوطة من الملف <filename dir="ltr">/usr/share/doc/postfix-doc/examples/access.gz</filename>. هذا القالب يشرح نفسه بالتعليقات التي يحويها، أي أن كل جدول يشرح الصيغة الخاصة به.
				</para>
				 <para>
					يسرد الجدول <filename dir="ltr">/etc/postfix/access_clientip</filename> عناوين IP والشبكات؛ أما <filename dir="ltr">/etc/postfix/access_helo</filename> فيسرد أسماء النطاقات؛ ويحوي <filename dir="ltr">/etc/postfix/access_sender</filename> العناوين البريدية للمرسلين. يجب تحويل هذه الملفات إلى جداول تهشير (صيغة محسنة للوصول السريع) بعد كل تعديل باستخدام الأمر <command dir="ltr">postmap /etc/postfix/<replaceable>file</replaceable></command>.
				</para>
				 </sidebar> <para>
					تسمح التعليمة الثالثة لمدير النظام بإعداد قائمة سوداء وقائمة بيضاء لمخدمات البريد الإلكتروني، تُخزَّن في الملف <filename dir="ltr">/etc/postfix/access_clientip</filename>. تعتبر المخدمات في القائمة البيضاء موثوقة، وبالتالي لا تمر الرسائل الواردة منها عبر قواعد الترشيح التالية.
				</para>
				 <para>
					ترفض آخر قاعدتين أي رسائل ترد من مخدم مذكور في إحدى القوائم السوداء المحددة. RBL هو اختصار <emphasis>Remote Black List</emphasis>؛ هناك كثير من هذه القوائم، لكن كلها تذكر المخدمات ذات الإعدادات السيئة التي تسمح بترحيل الرسائل الدعائية، بالإضافة إلى مرحلات البريد غير المتوقعة مثل الأجهزة المصابة بالديدان أو الفيروسات.
				</para>
				 <indexterm>
					<primary>RBL</primary>
				</indexterm>
				 <indexterm>
					<primary>Remote Black List</primary>
				</indexterm>
				 <sidebar> <title><emphasis>تلميح</emphasis> القوائم البيضاء وقوائم RBL</title>
				 <para>
					أحياناً تتضمن القوائم السوداء مخدمات شرعية كانت ضحية حادثة طارئة. في هذه الحالات، سوف تُرفَض جميع الرسائل الإلكترونية التي ترد من أحد هذه المخدمات ما لم يذكر المخدم في قائمة بيضاء مُعرّفة في <filename dir="ltr">/etc/postfix/access_clientip</filename>.
				</para>
				 <para>
					تقتضي الحكمة إذاً إضافة جميع المخدمات الموثوقة التي ترد منها رسائل كثيرة عادة إلى القائمة البيضاء.
				</para>
				 </sidebar>
			</section>
			 <section>
				<title>التحقق من صحة أوامر <literal>EHLO</literal> أو <literal>HELO</literal></title>
				 <para>
					كل عملية تبادل SMTP تبدأ بأمر <literal>HELO</literal> (أو <literal>EHLO</literal>)، يتبعه اسم مخدم البريد المرسل؛ قد يكون التحقق من سلامة هذا الاسم مفيداً.
				</para>
				 <indexterm>
					<primary><literal>HELO</literal></primary>
				</indexterm>
				 <indexterm>
					<primary><literal>EHLO</literal></primary>
				</indexterm>
				 <example>
					<title>القيود المفروضة على الاسم المُعلَن في <literal>EHLO</literal></title>
					 
<programlisting>
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname
</programlisting>

				</example>
				 <para>
					تسمح التعليمة التوجيهية <literal>permit_mynetworks</literal> لجميع الأجهزة في الشبكة المحلية بتقديم نفسها كيفما اتفق. هذه مهم، لأن بعض برامج البريد الإلكتروني لا تحترم هذا الجزء من بروتوكول SMTP بشكل كاف، ويمكن أن تقدم نفسها بأسماء غير منطقية.
				</para>
				 <para>
					ترفض القاعدة <literal>reject_invalid_hostname</literal> الرسائل الإلكترونية عندما يعلن <literal>EHLO</literal> اسم مضيف صيغته غير صحيحة. وترفض القاعدة <literal>reject_non_fqdn_hostname</literal> الرسائل عندما لا يكون اسم المضيف المذكور اسم نطاق كامل التوصيف (fully-qualified، أي يتضمن اسم النطاق بالإضافة لاسم المضيف). ترفض القاعدة <literal>reject_unknown_hostname</literal> الرسائل إذا لم يكن الاسم المعلن مذكوراً في DNS. بما أن هذه القاعدة الأخيرة تؤدي لعمليات رفض كثيرة جداً لسوء الحظ، فقد حوّل مديرو النظم تأثيرها إلى مجرد تحذير باستخدام الخيار <literal>warn_if_reject</literal> كخطوة أولى؛ وقد يقررون إزالة هذا الخيار في مرحلة لاحقة، بعد فحص نتائج هذه القاعدة.
				</para>
				 <para>
					استخدام <literal>permit_mynetworks</literal> كقاعدة أولى له أثر جانبي ملفت: فالقواعد التالية ستُطبَّق فقط على المضيفات خارج الشبكة المحلية. يسمح هذا بحظر جميع المضيفات التي تعلن أنها جزء من <literal>falcot.com</literal>، عبر إضافة السطر <literal>falcot.com REJECT You're not in our network!</literal> مثلاً إلى الملف <filename dir="ltr">/etc/postfix/access_helo</filename>.
				</para>

			</section>
			 <section>
				<title>القبول أو الرفض اعتماداً على المرسِل المُعلَن</title>
				 <para>
					لكل رسالة هناك مرسل، يُعلِن عنه الأمر <literal>MAIL FROM</literal> من بروتوكول SMTP؛ يمكن التحقق من هذه المعلومات أيضاً بأساليب عديدة.
				</para>
				 <indexterm>
					<primary><literal>MAIL FROM</literal></primary>
				</indexterm>
				 <indexterm>
					<primary>بريد إلكتروني</primary>
					<secondary>الترشيح حسب المرسل</secondary>
				</indexterm>
				 <example>
					<title>التحقق من المرسل</title>
					 
<programlisting>
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender
</programlisting>

				</example>
				 <para>
					يربط الجدول <filename dir="ltr">/etc/postfix/access_sender</filename> بعض المعاملات الخاصة ببعض المرسلين. هذا يعني إضافة بعض المرسلين إلى قائمة بيضاء أو سوداء عادة.
				</para>
				 <para>
					تتطلب القاعدة <literal>reject_unknown_sender_domain</literal> أن يكون نطاق المرسل سليماً، لأنه لازم للعناوين الصحيحة. ترفض القاعدة <literal>reject_unlisted_sender</literal> المرسلين المحليين إذا لم يكن العنوان موجوداً؛ هذا يمنع إرسال الرسائل الإلكنرونية من عنوان غير صحيح في النطاق <literal>falcot.com</literal>، ولن تُقبَل الرسائل المنبعثة من <literal>joe.bloggs@falcot.com</literal> مثلاً إلا إذا كان هذا العنوان موجوداً فعلاً.
				</para>
				 <para>
					أخيراً، ترفض القاعدة <literal>reject_non_fqdn_sender</literal> الرسائل الإلكترونية التي تدّعي أنها ترد من عناوين ليس لها اسم نطاق كامل التوصيف. عملياً، هذا يعني رفض الرسائل الواردة من <literal>user@machine</literal>: ولذلك يجب إعلان العنوان على أنه <literal>user@machine.example.com</literal> أو <literal>user@example.com</literal>.
				</para>

			</section>
			 <section>
				<title>القبول أو الرفض اعتماداً على المستقبل</title>
				 <para>
					لكل رسالة مستقبل واحد على الأقل، يعلن عنه الأمر <literal>RCPT TO</literal> في بروتوكول SMTP. يضمن التحقق من هذه العناوين أيضاً شرعية الرسالة، حتى لو كانت أقل أهمية من التحقق من عنوان المرسل.
				</para>
				 <indexterm>
					<primary>RCPT TO</primary>
				</indexterm>
				 <indexterm>
					<primary>بريد إلكتروني</primary>
					<secondary>الترشيح حسب المستقبل</secondary>
				</indexterm>
				 <example>
					<title>التحقق من المستقبل</title>
					 
<programlisting>
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient
</programlisting>

				</example>
				 <para>
					<literal>reject_unauth_destination</literal> هي القاعدة الأساسية التي تتطلب أن تكون الرسائل الخارجية معنونة إلينا؛ أما الرسائل المرسلة إلى عنوان لا يخدمه هذا المخدم فسوف تُرفَض. دون هذه القاعدة، يسصبح المخدم محطة ترحيل مفتوحة تسمح بإرسال الرسائل الدعائية؛ أي أن هذه القاعدة إلزامية، والأفضل وضعها قرب بداية القائمة بحيث نقطع احتمال أن تسمح قاعدة أخرى للرسالة بالمرور قبل التحقق من وجهتها.
				</para>
				 <para>
					ترفض القاعدة <literal>reject_unlisted_recipient</literal> الرسائل المرسلة إلى مستخدمين محليين لا وجود لهم، وهذا منطقي. أخيراً، ترفض القاعدة <literal>reject_non_fqdn_recipient</literal> العناوين ذات التوصيف غير الكامل؛ هذا يمنع إرسال رسالة إلى <literal>jean</literal> أو <literal>jean@machine</literal>، بل يجب استخدام العنوان الكامل بدلاً من ذلك، مثل <literal>jean@machine.falcot.com</literal> أو <literal>jean@falcot.com</literal>.
				</para>

			</section>
			 <section>
				<title>القيود المتعلقة بالأمر <literal>DATA</literal></title>
				 <para>
					يُرسَل الأمر <literal>DATA</literal> التابع لبروتوكول SMTP قبل إرسال محتويات الرسالة. لا يقدّم هذا الأمر أي معلومات بحد ذاته، فيما عدا الإعلان عما سيرد تالياً. لكن لا يزال إخضاعه للفحوصات ممكناً.
				</para>
				 <indexterm>
					<primary><literal>DATA</literal></primary>
				</indexterm>
				 <example>
					<title>التحقق من <literal>DATA</literal></title>
					 
<programlisting>
smtpd_data_restrictions = reject_unauth_pipelining
</programlisting>

				</example>
				 <para>
					تسبب التعليمات <literal>reject_unauth_pipelining</literal> رفض الرسائل إذا أرسلت الجهة المرسلة أمراً قبل إرسال الرد على الأمر السابق. هذا يحمي من عمليات التسريع الشائعة التي تستخدمها روبوتات الرسائل الدعائية، إذا أنها عادة لا تهتم أبداً بالردود وتركز فقط على إرسال أكبر عدد ممكن من الرسائل بأقصر زمن ممكن.
				</para>

			</section>
			 <section>
				<title>تطبيق القيود</title>
				 <para>
					رغم أن الأوامر السابقة تتحقق من المعلومات في المراحل المختلفة من عملية تبادل SMTP، إلا أن Postfix يرسل الرفض الفعلي كردٍّ على الأمر <literal>RCPT TO</literal>.
				</para>
				 <para>
					هذا يعني أنه حتى لو رفضت الرسالة نتيجة أمر <literal>EHLO</literal> خاطئ، سيعلم Postfix من هو المرسل ومن المستقبل عند إعلان الرفض. ويستطيع عندها تسجيل رسالة أوضح في السجلات وهذا غير ممكن إذا قوطعت عملية التبادل منذ البداية. بالإضافة لذلك، لا يتوقع بعض عملاء SMTP إخفاق عملية التبادل عند أوامر SMTP الأولية، وسيقل تشوش هذه العملاء عند استلام الرفض في وقت متأخر.
				</para>
				 <para>
					هناك ميزة أخيرة لهذا الخيار هي أن القواعد تستطيع جمع المعلومات أثناء المراحل المتنوعة لعملية تبادل SMTP؛ وهذا يسمح بتعريف صلاحيات أدق، مثل رفض اتصال غير محلي إذا أعلن أن مرسله مرسل محلي.
				</para>

			</section>
			 <section>
				<title>الترشيح اعتماداً على محتويات الرسالة</title>
				 <para>
					لن يكتمل نظام التقييد والتحقق دون طريقو لتطبيق الفحوضات على محتويات الرسائل. يفرق Postfix بين الفحوصات المطبّقة على ترويسات البريد الإلكتروني من تلك التي تطبق على متن (body) الرسالة.
				</para>
				 <example>
					<title>تفعيل المرشحات التي تعتمد على المحتوى</title>
					 
<programlisting>
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks
</programlisting>

				</example>
				 <indexterm>
					<primary>بريد إلكتروني</primary>
					<secondary>الترشيح حسب المحتوى</secondary>
				</indexterm>
				 <para>
					يحوي كل ملف قائمة من التعابير المنتظمة (تعرف عادة باسم <emphasis>regexps</emphasis> أو <emphasis>regexes</emphasis>) والإجراءات المرتبطة معها التي تنشط عند مطابقة ترويسات الرسالة (أو متنها) للتعبير المنتظم:
				</para>
				 <sidebar> <title><emphasis>نظرة سريعة</emphasis> جداول التعابير المنتظمة</title>
				 <para>
					يحوي الملف <filename dir="ltr">/usr/share/doc/postfix-doc/examples/header_checks.gz</filename> تعليقات توضيحية عديدة ويمكن استخدامه كنقطة انطلاق لإنشاء الملفين <filename>/etc/postfix/header_checks</filename> و<filename>/etc/postfix/body_checks</filename>.
				</para>
				 </sidebar> <example>
					<title>مثال عن الملف <filename dir="ltr">/etc/postfix/header_checks</filename></title>
					 
<programlisting>
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification
</programlisting>

				</example>
				 <sidebar id="sidebar.regexp"> <title><emphasis>أساسيات</emphasis> التعابير المنتظمة</title>
				 <para>
					يشير المصطلح ”تعبير منتظم“ (<emphasis>regular expression</emphasis>، ويختصر إلى <emphasis>regexp</emphasis> أو <emphasis>regex</emphasis>) إلى صيغة تدوين عامة لتمثيل محتويات أو بنية سلسلة من المحارف. تسمح بعض المحارف الخاصة بتعريف بدائل (مثلاً، <literal>foo|bar</literal> تطابق إما ”foo“ أو ”bar“)، أو مجموعات من المحارف المسموحة (مثلاً، <literal>[0-9]</literal> تعني أي رقم، و <literal>.</literal> (نقطة) تعني أي محرف)، أو كميات (تطابق <literal dir="ltr">s?</literal> إما <literal>s</literal> أو السلسلة الفارغة، أي ورود الحرف <literal>s</literal> مرة واحدة أو عدم وروده أبداً؛ أما <literal dir="ltr">s+</literal> فيطابق ورود <literal>s</literal> مرة واحدة أو أي عدد من المرات؛ وهكذا). تسمح الأقواس بتجميع نتائج البحث.
				</para>
				 <para>
					تختلف صيغة كتابة هذه التعابير بين الأدوات التي تستخدمها، لكن المزايا الأساسية متشابهة. <ulink type="block" url="http://en.wikipedia.org/wiki/Regular_expression" />
				</para>
				 </sidebar> <para>
					يتحقق الأول من الترويسة التي تذكر برنامج البريد الإلكتروني؛ فإذا وجدت العبارة <literal>GOTO Sarbacane</literal> (برنامج لإرسال البريد بالكميات)، سوف ترفض الرسالة. يتحكم التعبير الثاني بموضوع الرسالة؛ فإذا كان يذكر تحذيراً من فيروس، يمكننا ألا نرفض الرسالة ولكن نحذفها مباشرة بدلاً من ذلك.
				</para>
				 <para>
					استخدام هذه المرشحات سيف ذو حدين، لأنه يسهل بناء قواعد عامة جداً وخسارة رسائل مشروعة نتيجة لذلك. في هذه الحالات، لن نخسر الرسائل وحسب، بل سيحصل مرسلوا هذه الرسائل على رسائل أخطاء غير مرغوبة (ومزعجة غالباً).
				</para>

			</section>

		</section>
		 <section id="sect.setting-up-greylisting">
			<title>إعداد <foreignphrase>القوائم الرمادية</foreignphrase></title>
			 <indexterm>
				<primary>greylisting</primary>
			</indexterm>
			 <para>
				“القوائم الرمادية“ (Greylisting) هي تقنية ترشيح تعتمد على رفض الرسالة في البداية مع الرد برمز خطأ مؤقت، وقبولها إذا أعيدت محاولة إرسالها ثانية بعد بعض الوقت. هذه التقنية فعالة خصوصاً لترشيح الرسائل الدعائية التي ترسلها العديد من الجهزة المصابة بالديدان والفيروسات، لأن هذه البرمجيات نادراً ما تتصرف كعميل SMTP كامل؛ فهي لا تتحقق من رمز الخطأ وتحاول إعادة إرسال الرسائل التي فشل إرسالها لاحقاً، خصوصاً وأن معظم العناوين المحصودة غير صحيحة أصلاً وإعادة محاولة الإرسال لا تعني إلا خسارة الوقت.
			</para>
			 <para>
				لا يدعم Postfix القوائم الرمادية داخلياً، لكن هناك ميزة تسمح بتوكيل برنامج خارجي لاتخاذ قرار قبول أو رفض رسالة معينة. هناك برنامج كهذا في الحزمة <emphasis role="pkg">postgrey</emphasis>، مصمم ليرتبط مع خدمة توكيل سياسة القبول.
			</para>
			 <para>
				بعد تثبيت <emphasis role="pkg">postgrey</emphasis>، سوف يعمل كخدمة وينصت للمنفذ 10023. يمكن عندها ضبط Postfix لاستخدامه، بإضافة المتغير <literal>check_policy_service</literal> كقيد إضافي:
			</para>
			 
<programlisting>
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023
</programlisting>
			 <para>
				في كل مرة يصل فيها Postfix لهذه القاعدة، سيتصل بخدمة <command>postgrey</command> ويرسل لها معلومات تخص الرسالة المعنية. ينظر Postgrey بدوره إلى ثلاثية (عنوان IP، المرسل، المستقبل) ويتحقق من رؤيته لهذه الثلاثية نفسها مؤخراً عبر قاعدة بياناته. إذا حدث ذلك، يرد Postgrey بأن الرسالة يجب أن تُقبَل؛ وإلا فإنه يرد بأن الرسالة يجب رفضها مؤقتاً، وتُسجَّل الثلاثية في قاعدة البيانات.
			</para>
			 <para>
				السيئة الرئيسية للقوائم الرمادية هي تأخر استلام الرسائل المشروعة، وهذا غير مقبول دائماً. كما يزيد العبئ على المخدمات التي ترسل الكثير من الرسائل المشروعة.
			</para>
			 <sidebar> <title><emphasis>ممارسة عملية</emphasis> عيوب القوائم الرمادية</title>
			 <para>
				نظرياً، يفترض أن تؤخر القوائم الرمادية الرسالة الأولى من مرسل معين إلى مستقبل معين، وأن التأخير نموذجياً لا يتعدى دقائق. لكن الواقع قد يختلف قليلاً. بعض ISP يستخدمون عناقيد من مخدمات SMTP، وعند رفض الرسالة اول مرة، قد يحاول مخدم آخر مختلف عن الأول إعادة إرسالها. عندما يحدث ذلك، يحصل المخدم الثاني أيضاً على رسالة خطأ مؤقت نتيجة استخدام القوائم الرمادية، وهكذا؛ قد تستغرق عملية الإرسال عدة ساعات قبل أن يحاول أحد المخدمات التي حاولت من قبل إعادة الإرسال، وذلك لأن مخدمات SMTP ترزيد عادة التأخير بين المحاولات بعد كل محاولة فاشلة.
			</para>
			 <para>
				نتيجة لذلك، قد يتغير مع الزمن عنوان IP لنفس المخدم المرسل أيضاً. بل وأكثر من ذلك، قد يتغير عنوان المرسل حتى. مثلاً، تُشفِّر الكثير من مخدمات القوائم البريدية معلومات إضافية في عنوان المرسل بحيث تتمكن من معالجة رسائل الأخطاء (تدعى <emphasis>bounces</emphasis>). كل رسالة جديدة ترسل إلى القائمة البريدية عليها عنئذ المرور عبر القوائم الرمادية، وهذا يعني أنه يجب تخزينها (مؤقتاً) على مخدم المرسل. بالنسبة للقوائم البريدية الكبيرة جداً (التي تحوي عشرات ألوف المشتركين)، سرعان ما يصبح هذا الأمر مشكلة.
			</para>
			 <para>
				لتخفيف هذه الأضرار، يدير Postgrey قائمة بيضاء بهذه المواقع، ويقبل الرسائل التي ترد منها فوراً. يمكن ملائمة هذه القائمة مع الاحتياجات المحلية بسهولة، إذ أنها مخزنة في الملف <filename dir="ltr">/etc/postgrey/whitelist_clients</filename>.
			</para>
			 </sidebar> <sidebar> <title><emphasis>التعمق أكثر</emphasis> الاستخدام الانتقائي للقوائم الرمادية باستخدام <emphasis role="pkg">milter-greylist</emphasis></title>
			 <para>
				يمكن تخفيف أضرار القوائم الرمادية باستخدامها فقط على مجموعة جزئية من العملاء الذي اعتبروا كمصدر للرسائل الدعائية مسبقاً (لأنهم مذكورون في قائمة DNS سوداء). هذا غير ممكن في <emphasis role="pkg">postgrey</emphasis> ولكن يمكن استخدام <emphasis role="pkg">milter-greylist</emphasis> بهذه الطريقة.
			</para>
			 <para>
				في تلك الحالة، يصبح استخدام القوائم السوداء الصارمة حلاً منطقياً، بما فيها القوائم التي تذكر جميع عناوين IP الديناميكة التابعة لعملاء ISP ما (مثل <literal>pbl.spamhaus.org</literal> أو <literal>dul.dnsbl.sorbs.net</literal>)، لأن قوائم DNS السوداء لن تسبب رفضاً قاطعاً.
			</para>
			 <para>
				بما أن milter-greylist يستخدم واجهة milter القياسية الخاصة ببرنامج Sendmail، يقتصر إعداد Postfix لاستخدامه على ”<literal>smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</literal>“. تشرح صفحة الدليل <citerefentry><refentrytitle>greylist.conf</refentrytitle>
				<manvolnum>5</manvolnum></citerefentry>‎ الملف <filename dir="ltr">/etc/milter-greylist/greylist.conf</filename> والطرق العديدة لإعداد milter-greylist. ستحتاج أيضاً لتحرير الملف <filename dir="ltr">/etc/default/milter-greylist</filename> لتفعيل الخدمة.
			</para>
			 </sidebar>
		</section>
		 <section>
			<title>تخصيص المرشحات حسب المستقبل</title>
			 <para>
				عرض <xref linkend="sect.restrictions-for-receiving-and-sending" /> و<xref linkend="sect.setting-up-greylisting" /> عدة قيود متاحة للاستخدام. لكل منها فائدته في الحد من كمية الرسائل الدعائية المستقبلة، لكن لكل منها عيوبه أيضاً. ولذلك يتزايد انتشار تخصيص مجموعة المرشحات اعتماداً على المستقبل أكثر فأكثر. في شركة فلكوت، تنفع القوائم الرمادية معظم المستخدمين، لكنها تعيق عمل بعض المستخدمين الذين يحتاجون وصول رسائلهم بتأخير قصير (مثل خدمة الدعم الفني). كما تعاني خدمة التجارة أحياناً من مشاكل في استلام ردود بعض المزودين الآسيويين لأنهم مذكورين في القوائم السوداء؛ وقد طلبت هذه الخدمة عنواناً دون ترشيح حتى يتمكنون من التواصل معهم.
			</para>
			 <para>
				يقدم Postfix ميزة تخصيص للمرشحات عبر مفهوم ”فئات التقييد restriction class“. يصرح عن الفئات في المتغير <literal>smtpd_restriction_classes</literal>، وتُعرَّف بنفس أسلوب <literal>smtpd_recipient_restrictions</literal>. بعدها تحدد التعليمة <literal>check_recipient_access</literal> جدولاً يقابل بين المستقبل المحدد ومجموعة القيود المناسبة.
			</para>
			 <example>
				<title>تعريف فئات التقييد في <filename>main.cf</filename></title>
				 
<programlisting>smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access
</programlisting>

			</example>
			 <example>
				<title>الملف <filename dir="ltr">/etc/postfix/recipient_access</filename></title>
				 
<programlisting>
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting
</programlisting>

			</example>

		</section>
		 <section id="sect.postfix-antivirus">
			<title>التكامل مع مضاد فيروسات</title>
			 <indexterm>
				<primary>مضاد فيروسات</primary>
			</indexterm>
			 <para>
				الفيروسات العديدة التي تتجوّل كمرفقات بريدية تضطرنا لإعداد مضاد فيروسات عند نقطة الدخول إلى شبكة الشركة، لأن بعض المستخدمين سيفتحون الملفات المرفقة مع الرسائل التي تبدو مشبوهة بشكل واضح، رغم حملات التوعية.
			</para>
			 <para>
				اختار مديرو النظم في شركة فلكوت <command>clamav</command> كمضاد فيروسات مجاني. الحزمة الرئيسية هي <emphasis role="pkg">clamav</emphasis>، لكنهم ثبّتوا أيضاً حزماً إضافية مثل <emphasis role="pkg">arj</emphasis>، و<emphasis role="pkg">unzoo</emphasis>، و<emphasis role="pkg">unrar</emphasis> و<emphasis role="pkg">lha</emphasis>، لأن مضاد الفيروسات يحتاجها حتى يتمكن من تحليل المرفقات المضغوطة بإحدى هذه الصيغ.
			</para>
			 <indexterm>
				<primary><command>clamav</command></primary>
			</indexterm>
			 <indexterm>
				<primary><command>clamav-milter</command></primary>
			</indexterm>
			 <para>
				يتولى <command>clamav-milter</command> مهمة الوصل ما بين مضاد الفيروسات وبين مخدم البريد الإلكتروني. الملتر (<emphasis>milter</emphasis>، اختصار <emphasis>mail filter</emphasis>) هو برنامج ترشيح مصمم خصيصاً للتواصل مع مخدمات البريد الإلكتروني. يستخدم الملتر واجهة برمجية تطبيقات (API أو application programming interface) تعطي أداءً أفضل بكثير من المرشحات الخارجية. قدم <emphasis>Sendmail</emphasis> الملاتر أول مرة، لكن سرعان ما لحق <emphasis>Postfix</emphasis> به.
			</para>
			 <sidebar> <title><emphasis>نظرة سريعة</emphasis> ملتر Spamassassin</title>
			 <indexterm>
				<primary><emphasis role="pkg">spamass-milter</emphasis></primary>
			</indexterm>
			 <para>
				تقدم الحزمة <emphasis role="pkg">spamass-milter</emphasis> ملتراً يعتمد على <emphasis>SpamAssassin</emphasis>، البرنامج الشهير لاكتشاف البريد الإلكتروني غير المرغوب. يمكن استخدامه لتحديد الرسائل على أنها يحتمل أن تكون دعائية (إضافة ترويسة زائدة) أو رفض الرسالة كلها إذا تجاوز مستوى ”spamminess“ عتبة محددة.
			</para>
			 </sidebar> <para>
				فور تثبيت الحزمة <emphasis role="pkg">clamav-milter</emphasis>، يجب إعادة ضبط الملتر ليعمل على منفذ TCP بدلاً من استخدام المقبس الشبكي المسمّى الافتراضي. يمكن تنفيذ ذلك باستخدام <command>dpkg-reconfigure clamav-milter</command>. عند طلب ”Communication interface with Sendmail“، أجب عليه بإدخال ”<literal>inet:10002@127.0.0.1</literal>“.
			</para>
			 <sidebar> <title><emphasis>ملاحظة</emphasis> منفذ TCP حقيقي أو مقبس مسمّى</title>
			 <para>
				سبب استعمالنا لمنفذ TCP حقيقي بدلاً من مقبس شبكي مسمّى هو أن خدمات Postfix تعمل تحت جذر مختلف (chrooted) غالباً ولا يمكنها الوصول للمجلد الذي يحوي المقبس المسمّى. يمكنك أيضاً أن تختار استخدام مقبس مسمّى لكن مع اختيار موقع ضمن الجذر المغيّر إليه (وهو <filename>/var/spool/postfix/</filename>).
			</para>
			 </sidebar> <para>
				تناسب إعدادات ClamAV القياسية معظم الحالات، لكن لا يزال تخصيص بعض البارامترات المهمة ممكناً عبر <command>dpkg-reconfigure clamav-base</command>.
			</para>
			 <para>
				الخطوة الأخيرة هي أن نطلب من Postfix استخدام المرشح الجديد؛ لتحقيق ذلك، يكفي إضافة التعليمة التالية إلى <filename dir="ltr">/etc/postfix/main.cf</filename>:
			</para>
			 
<programlisting>
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002
</programlisting>
			 <para>
				إذا سبب مضاد الفيروسات مشاكل، يمكن تعليق هذا السطر، وبعدها تنفيذ <command>service postfix reload</command> حتى يؤخذ هذا التغيير بعين الاعتبار.
			</para>
			 <sidebar> <title><emphasis>ممارسة عملية</emphasis> اختبار مضاد الفيروسات</title>
			 <para>
				فور إعداد مضاد الفيروسات، يجب اختبار سلامة سلوكه. أبسط طريقة هي إرسال رسالة اختبار وإرفاق الملف <filename>eicar.com</filename> (أو <filename>eicar.com.zip</filename>) بها، يمكن تنزيل هذا الملف من الإنترنت: <ulink type="block" url="http://www.eicar.org/86-0-Intended-use.html" />
			</para>
			 <para>
				هذا الملف ليس فيروساً حقيقياً، لكنه ملف اختبار تعتبره جميع برامج مكافحة الفيروسات في السوق فيروساً لاستخدامه في اختبار صحة عملية التثبيت.
			</para>
			 </sidebar> <para>
				ستمر جميع الرسائل التي يعالجها Postfix الآن عبر مرشح مكافحة الفيروسات.
			</para>

		</section>
		 <section id="sect.authenticated-smtp">
			<title>SMTP مع مصادقة</title>
			 <para>
				حتى تتمكن من إرسال الرسائل الإلكترونية يجب أن تتمكن من الوصول لمخدم SMTP؛ كما تحتاج أيضاً أن يسمح لك مخدم SMTP ذاك بإرسال رسائلك عبره. هذا قد يتطلب تحديث إعدادات عميل SMTP بشكل متكرر بالنسبة للمستخدمين المتنقلين، لأن مخدم SMTP في شركة فلكوت يرفض الرسائل التي ترد من عناوين IP لا تنتمي لشبكة الشركة. هناك حلان: إما أن يثبّت المستخدم الرحالة مخدم SMTP على حاسوبه، أو أن يستخدم مخدم الشركة عبر أسلوب مصادقة يثبت أنه موظف في الشركة. الحل الأول غير مستحسن لأن الحاسوب لن يكون متصلاً بالإنترنت دائماً، ولن يتمكن من إعادة إرسال الرسائل في حال مواجهة مشاكل؛ سوف نركز على الحل الأخير.
			</para>
			 <para>
				تعتمد مصادقة SMTP في Postfix على SASL‏ (<emphasis>Simple Authentication and Security Layer</emphasis>). هذا يتطلب تثبيت الحزمتين <emphasis role="pkg">libsasl2-modules</emphasis> و<emphasis role="pkg">sasl2-bin</emphasis>، ثم تسجيل كلمة سر في قاعدة بيانات SASL لكل مستخدم يحتاج المصادقة مع مخدم SMTP. هذا يتم بوساطة الأمر <command>saslpasswd2</command>، الذي يأخذ عدة بارامترات. يحدد الخيار <literal dir="ltr">-u</literal> نطاق المصادقة، الذي يجب أن يطابق المتغير <literal>smtpd_sasl_local_domain</literal> في إعدادات Postfix. يسمح الخيار <literal dir="ltr">-c</literal>بإنشاء مستخدم، ويسمح <literal dir="ltr">-f</literal> بتحديد الملف الذي تريد استخدامه لتخزين قاعدة بيانات SASL إذا كنت تريد تخزينها في مكان مختلف عن المكان الافتراضي (<filename dir="ltr">/etc/sasldb2</filename>).
			</para>
			 
<screen role="scale">
<computeroutput># </computeroutput><userinput>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</userinput>
<computeroutput>[... type jean's password twice ...]</computeroutput></screen>
			 <para>
				لاحظ أن قاعدة بيانات SASL قد أنشئت في مجلد Postfix. لضمان التوافق، سوف نجعل <filename dir="ltr">/etc/sasldb2</filename> أيضاً رابطاً رمزياً يشير إلى قاعدة البيانات التي يستخدمها Postfix، باستخدام الأمر <command>ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</command>.
			</para>
			 <para>
				نحتاج الآن إعداد Postfix بحيث يستخدم SASL. أولاً يجب إضافة المستخدم <literal>postfix</literal> إلى المجموعة <literal>sasl</literal>، حتى يستطيع الوصول لقاعدة البيانات التي يملكها حساب SASL. كما نحتاج لبضعة بارامترات جديدة لتفعيل SASL، ويجب ضبط المتغير <literal>smtpd_recipient_restrictions</literal> للسماح للعملاء الذين صادقوا هويتهم باستخدام SASL بإرسال البريد الإلكتروني دون قيود.
			</para>
			 <example>
				<title>تفعيل SASL في <filename dir="ltr">/etc/postfix/main.cf</filename></title>
				 
<programlisting>
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]
</programlisting>

			</example>
			 <sidebar> <title><emphasis>إضافة</emphasis> عميل SMTP مع مصادقة</title>
			 <para>
				تستطيع معظم عملاء البريد الإلكتروني المصادقة مع مخدم SMTP قبل إرسال الرسائل الصادرة، ولاستخدام تلك الميزة يكفي ضبط المتغيرات المناسبة. إذا كان العميل المستخدم لا يدعم هذه الميزة، فالحل هو استخدام مخدم Postfix محلي وضبطه بحيث يرحل البريد الإلكتروني إلى مخدم SMTP البعيد. في تلك الحالة، يصبح مخدم Posfix المحلي نفسه عميلاً يجري عملية المصادقة باستخدام SASL. إليك المتغيرات اللازمة:
			</para>
			 
<programlisting>
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]
</programlisting>
			 <para>
				يجب أن يحوي الملف <filename dir="ltr">/etc/postfix/sasl_passwd</filename> اسم المستخدم وكلمة السر التي ستستخدم عند المصادقة مع المخدم <literal>mail.falcot.com</literal>. هذا مثال:
			</para>
			 
<programlisting>
[mail.falcot.com]   joe:LyinIsji
</programlisting>
			 <para>
				كما هو حال جميع جداول التقابلات في Postfix، يجب تحويل هذا الملف إلى <filename dir="ltr">/etc/postfix/sasl_passwd.db</filename> باستخدام الأمر <command>postmap</command>.
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.http-web-server">
		<title>مخدم الوب (HTTP)</title>
		 <para>
			قرر مديرو النظم في شركة فلكوت استخدام أباتشي، مخدم HTTP، المتوفر في دبيان <emphasis role="distribution">جيسي</emphasis> بنسخته 2.4.10.
		</para>
		 <indexterm>
			<primary><command>apache</command></primary>
		</indexterm>
		 <indexterm>
			<primary>مخدم</primary>
			<secondary>وب</secondary>
		</indexterm>
		 <indexterm>
			<primary>وب، مخدم</primary>
		</indexterm>
		 <indexterm>
			<primary>مخدم</primary>
			<secondary>HTTP</secondary>
		</indexterm>
		 <indexterm>
			<primary>HTTP</primary>
			<secondary>مخدم</secondary>
		</indexterm>
		 <sidebar> <title><emphasis>بدائل</emphasis> مخدمات وب أخرى</title>
		 <para>
			أباتشي هو أشهر مخدمات الوب (وأكثرها استخداماً)، لكن هناك غيره؛ وقد تقدم أداء أفضل منه تحت ظروف عمل معينة، لكن ذلك يكون على حساب عدد المزايا والوحدات المتاحة غالباً. على أي حال، إذا كان مخدم الوب المنتظر سيخدم ملفات ستاتيكية أو يعمل كبروكسي، عندها تستحق البدائل، مثل <emphasis role="pkg">nginx</emphasis> و <emphasis role="pkg">lighttpd</emphasis>، أخذها بعين الاعتبار.
		</para>
		 <indexterm>
			<primary><emphasis role="pkg">nginx</emphasis></primary>
		</indexterm>
		 <indexterm>
			<primary><emphasis role="pkg">lighttpd</emphasis></primary>
		</indexterm>
		 </sidebar> <section>
			<title>تثبيت أباتشي</title>
			 <para>
				كل ما يلزم هو تثبيت الحزمة <emphasis role="pkg">apache2</emphasis>. تحوي هذه الحزمة كافة الوحدات، بما فيها وحدات المعالجة المتعددة (<emphasis>Multi-Processing Modules</emphasis> أو اختصاراً MPMs) التي تؤثر على أسلوب المعالجة التفرعي الذي ينتهجه أباتشي لمعالجة الطلبات العديدة (كانت هذه تأتي في حزم منفصلة تبدأ أسماؤها بـ <emphasis dir="ltr" role="pkg">apache2-mpm-*</emphasis>). كما أنها ستجلب حزمة <emphasis role="pkg">apache2-utils</emphasis> التي تحوي أدوات سطر الأوامر التي سنتعرف عليها لاحقاً.
			</para>
			 <para>
				تؤثر MPM المستخدمة بشكل كبير على طريقة تعامل Apache مع الطلبات المتوازية. عند استخدام <emphasis>worker</emphasis> MPM، يستخدم أباتشي ”الخيوط <emphasis>threads</emphasis>“ (عمليات خفيفة)، بينما يستخدم عند اختيار <emphasis>prefork</emphasis> MPM احتياطياً (pool) من عمليات منشأة مسبقاً. أما عند استخدام <emphasis>event</emphasis> MPM فهو يستخدم الخيوط أيضاً، لكن مع إعادة تسليم الاتصالات غير النشطة (خصوصاً تلك التي تبقى مفتوحة عبر ميزة <emphasis>keep-alive</emphasis> في HTTP) إلى خيط إدارة خاص.
			</para>
			 <para>
				كما ثبّت مديرو النظم في شركة فلكوت <emphasis role="pkg">libapache2-mod-php5</emphasis> أيضاً بحيث يُضافُ دعم PHP إلى أباتشي. هذا يؤدي لتعطيل <emphasis>event</emphasis> MPM الافتراضية، وتفعيل <emphasis>prefork</emphasis> بدلاً منها، لأن PHP لا تعمل إلا مع تلك MPM بعينها.
			</para>
			 <sidebar> <title><emphasis>أمن</emphasis> التنفيذ بصلاحيات المستخدم <literal>www-data</literal></title>
			 <indexterm>
				<primary><literal>www-data</literal></primary>
			</indexterm>
			 <indexterm>
				<primary>suexec</primary>
			</indexterm>
			 <para>
				افتراضياً، يعالح أباتشي الطلبات الواردة تحت هوية المستخدم <literal>www-data</literal>. هذا يعني أن أي ثغرة أمنية في سكربت CGI يُنفّذه أباتشي (في صفحة ديناميكية) لن يعرض النظام كله للخطر، بل الملفات التي يملكها هذا المستخدم فقط.
			</para>
			 <para>
				يسمح استخدام الوحدة <emphasis>suexec</emphasis> بتجاوز هذه القاعدة بحيث تُنفَّذ بعض سكربتات CGI تحت هويّة مستخدم آخر. يُضبَط هذا بتعليمة <literal>SuexecUserGroup <replaceable>user</replaceable><replaceable>group</replaceable></literal> في إعدادات أباتشي.
			</para>
			 <indexterm>
				<primary><emphasis role="pkg">libapache2-mpm-itk</emphasis></primary>
			</indexterm>
			 <para>
				وهناك احتمال آخر وهو استخدام MPM مخصصة لذلك. مثل التي توفرها الحزمة <emphasis role="pkg">libapache2-mpm-itk</emphasis>. تتمتع MPM هذه بالذات بسلوك مختلف قليلاً: فهي تسمح ”بعزل“ المضيفات الظاهرية (مجموعات الصفحات فعلياً) بحيث يعمل كل منها كمستخدم مختلف. بالتالي، لا تستطيع ثغرة في موقع واحد تعريض الملفات التي تنتمي لمالك موقع آخر للخطر.
			</para>
			 </sidebar> <sidebar> <title><emphasis>نظرة سريعة</emphasis> قائمة الوحدات</title>
			 <para>
				هناك قائمة كاملة بوحدات أباتشي متوفرة على الوب. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/index.html" />
			</para>
			 </sidebar> <para>
				أباتشي مخدم تجزيئي (modular)، وهناك مزايا كثيرة تقدمها وحدات (modules) خارجية يُحمّلها البرنامج الرئيسي أثناء مرحلة التهيئة. يُفعّل الإعداد الافتراضي أهم الوحدات شيوعاً، لكن لتفعيل وحدات جديدة يكفي استدعاء <command>a2enmod <replaceable>module</replaceable></command>؛ولتعطيل وحدة ما، يُستَخدَم الأمر <command>a2dismod <replaceable>module</replaceable></command>. في الواقع هذه البرامج تُنشِئ فقط (أو تحذف) وصلات رمزية في <filename>/etc/apache2/mods-enabled/</filename>، تشير إلى الملفات الفعلية (المُخزَّنة في <filename>/etc/apache2/mods-available/</filename>).
			</para>
			 <para>
				في الإعداد الافتراضي، ينصت مخدم الوب للمنفذ 80 (حسب الإعدادات في <filename dir="ltr">/etc/apache2/ports.conf</filename>)، ويخدّم الصفحات من المجلد <filename>/var/www/html/</filename> (حسب الإعدادات في <filename dir="ltr">/etc/apache2/sites-enabled/000-default.conf</filename>).
			</para>
			 <sidebar> <title><emphasis>التعمق أكثر</emphasis> إضافة دعم SSL</title>
			 <indexterm>
				<primary>HTTPS</primary>
			</indexterm>
			 <indexterm>
				<primary>HTTP</primary>
				<secondary>secure</secondary>
			</indexterm>
			 <para>
				يتضمن أباتشي 2.2 وحدة SSL اللازمة لاتصالات HTTP الآمنة (HTTPS) افتراضياً. يجب فقط تفعيلها بالأمر <command>a2enmod ssl</command>، الذي يضيف التعليمات التوجيهية المطلوبة لملفات الإعدادات. هناك مثال عن الإعداد متوفر في <filename dir="ltr">/etc/apache2/sites-available/default-ssl.conf</filename>. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html" />
			</para>
			 <para>
				يجب الاحتياط أكثر إذا كنت تريد تفضيل اتصالات SSL باستخدام <emphasis>Perfect Forward Secrecy</emphasis> (تستخدم هذه الاتصالات مفاتيح زائلة للجلسات تضمن عدم انكشاف البيانات المشفرة القديمة التي يحتمل أنها التقطت عبر التجسس على الشبكة إذا انكشف مفتاح المخدم السري). ألق نظرة على نصائح موزيلا بالذات: <ulink type="block" url="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache" />
			</para>
			 <indexterm>
				<primary><emphasis>Perfect Forward Secrecy</emphasis></primary>
			</indexterm>
			 </sidebar>
		</section>
		 <section>
			<title>إعداد مضيف ظاهري</title>
			 <para>
				المضيف الظاهري (virtual host) هو هوية إضافية لمخدم الوب.
			</para>
			 <indexterm>
				<primary>مضيف ظاهري</primary>
			</indexterm>
			 <para>
				يميّز أباتشي بين نوعين من الاستضافة الظاهرية: النوع الذي يعتمد على عنوان IP (أو المنفذ)، والنوع الذي يعتمد على اسم نطاق مخدم الوب. تحتاج الطريقة الأولى لتخصيص عنوان IP مختلف (أو منفذ) لكل موقع، بينما يمكن أن تعمل الثانية على عنوان IP (ومنفذ) وحيد، وتُفرَّق المواقع عن بعضها باسم المضيف (hostname) الذي يرسله عميل HTTP (وهذه لا تعمل إلا مع النسخة 1.1 من بروتوكول HTTP — لحسن الحظ هذه النسخة قديمة لدرجة أن جميع العملاء يستخدمونها فعلاً).
			</para>
			 <para>
				إن التناقص (المستمر) في عناوين IPv4 يدفعنا عادة لتفضيل الطريقة الثانية؛ لكنها تزيد تعقيد الأمور إذا كان المضيفات الظاهرية مضطرة لتوفير HTTPS أيضاً، لأن بروتوكول SSL لم يكن يدعم الاستضافة الظاهرية التي تعتمد على الأسماء قديماً؛ ولا تدعم جميع المتصفحات امتداد SNI (بيان اسم المخدم، <emphasis>Server Name Indication</emphasis>) التي تسمح بالجمع بينهما. عندما تحتاج عدة مواقع HTTPS العمل على المخدم نفسه، سيُفرّق بينها عادة بتشغيلها على منافذ مختلفة أو عناوين IP مختلفة (قد يساعد IPv6 هنا).
			</para>
			 <para>
				يُفعّل الإعداد الافتراضي لأباتشي 2 الاستضافة الظاهرية المعتمدة على الأسماء. بالإضافة لذلك، يُعرَّف مضيف ظاهري في الملف <literal dir="ltr">/etc/apache2/sites-enabled/000-default.conf</literal>؛ يستخدم هذا المضيف إذا لم يُعثَر على اسم مضيف يطابق طلب العميل.
			</para>
			 <sidebar> <title><emphasis>تحذير</emphasis> المضيف الظاهري الأول</title>
			 <para>
				أي طلب لمضيف غير معروف سيجاب عنه دوماً بالمضيف المعرّف أولاً، ولذلك عرفنا <literal>www.falcot.com</literal> أولاً هنا.
			</para>
			 </sidebar> <sidebar> <title><emphasis>نظرة سريعة</emphasis> أباتشي يدعم SNI</title>
			 <indexterm>
				<primary>Server Name Indication</primary>
			</indexterm>
			 <para>
				يدعم المخدم أباتشي امتداداً لبروتوكول SSL يدعى <emphasis>Server Name Indication</emphasis>‏ (SNI). يسمح هذا الامتداد للمتصفح أن يرسل اسم المضيف لمخدم الوب أثناء إنشاء اتصال SSL، قبل إرسال طلب HTTP بكثير، الذي كان يستعمل سابقاً للتعرف على المضيف الظاهري المطلوب من بين المضيفات على المخدم نفسه (الذين لهم عنوان IP والمنفذ نفسهما). يسمح هذا لأباتشي باختيار شهادة SSL الأنسب لمتابعة الطلب.
			</para>
			 <para>
				قبل SNI، كان أباتشي يستخدم دوماً الشهادة المعرفة في المضيف الظاهري الافتراضي. وعندئذ سيعرض العملاء الذين يحاولون الوصول لمضيف ظاهري آخر تحذيرات، لأن الشهادة التي استقبلوها لا توافق الموقع الذي يحاولون الوصول إليه. لحسن الحظ، تعمل معظم المتصفحات اليوم مع SNI؛ بما فيها Microsoft Internet Explorer منذ الإصدار 7.0 (منذ Vista)، وMozilla Firefox منذ الإصدار 2.0، وApple Safari منذ الإصدار 3.2.1، وجميع إصدارات Google Chrome.
			</para>
			 <para>
				حزمة أباتشي التي توفرها دبيان مبنية مع تضمين دعم SNI؛ ولذلك لا حاجة لأي إعداد أو ضبط.
			</para>
			 <para>
				يجب الانتباه أيضاً إلى ضمان تفعيل TLSv1 على المضيف الظاهري الأول (الذي يستخدم افتراضياً)، لأن أباتشي يستخدم بارمترات هذا المضيف الظاهري لبدء الاتصالات الآمنة، ومن الأفضل لهذه البارمترات أن تسمح بذلك!
			</para>
			 </sidebar> <para>
				بعد ذلك، يُعرّف كل مضيف ظاهري إضافي بملف يُخزَّن في <filename dir="ltr">/etc/apache2/sites-available/</filename>. بالتالي، لإعداد موقع وب للنطاق <literal>falcot.org</literal> يكفي إنشاء الملف التالي، ثم تفعيل المضيف الظاهري باستخدام <command>a2ensite www.falcot.org</command>.
			</para>
			 <example>
				<title>الملف <filename dir="ltr">/etc/apache2/sites-available/www.falcot.org.conf</filename></title>
				 
<programlisting>
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;
</programlisting>

			</example>
			 <para>
				يستخدم المخدم أباتشي، كما هي إعداداته حتى الآن، ملف سجلات وحيد لجميع المضيفات الظاهرية (رغم أن تغيير هذا ممكن عبر إضافة تعليمات <literal>CustomLog</literal> في تعاريف المضيفات الظاهرية). من المنطقي إذن تعديل صيغة ملف السجلات هذا بحيث يتضمن اسم المضيف الظاهري. يمكن تحقيق هذا عبر إنشاء ملف <filename dir="ltr">/etc/apache2/conf-available/customlog.conf</filename> يُعرِّف صيغة جديدة لكافة ملفات السجلات (باستخدام التعليمة التوجيهية <literal>LogFormat</literal>) وتفعيله بالأمر <command>a2enconf customlog</command>. كما يجب أيضاً إزالة (أو تعليق) سطر <literal>CustomLog</literal> من الملف <filename dir="ltr">/etc/apache2/sites-available/000-default.conf</filename>.
			</para>
			 <example>
				<title>الملف <filename dir="ltr">/etc/apache2/conf.d/customlog.conf</filename></title>
				 
<programlisting role="scale">
# New log format including (virtual) host name
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Now let's use this "vhost" format by default
CustomLog /var/log/apache2/access.log vhost</programlisting>

			</example>

		</section>
		 <section>
			<title>التعليمات التوجيهية الشائعة</title>
			 <para>
				يستعرض هذا القسم سريعاً بعض تعليمات إعداد أباتشي شائعة الاستخدام.
			</para>
			 <indexterm>
				<primary>أباتشي، التعليمات التوجيهية</primary>
			</indexterm>
			 <indexterm>
				<primary>توجيهات، أباتشي</primary>
			</indexterm>
			 <para>
				يحوي ملف الإعداد الرئيسي عدة كتل <literal>Directory</literal> عادة؛ تسمح بتحديد تصرفات المخدم المختلفة حسب موقع الملف الذي يقدمه. هذه الكتل تحوي عادة تعليمتي <literal>Options</literal> و <literal>AllowOverride</literal>.
			</para>
			 <indexterm>
				<primary><literal>Options</literal>، تعليمة أباتشي توجيهية</primary>
			</indexterm>
			 <indexterm>
				<primary><literal>AllowOverride</literal>، تعليمة أباتشي توجيهية</primary>
			</indexterm>
			 <example>
				<title>كتلة Directory</title>
				 
<programlisting>
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;
</programlisting>

			</example>
			 <para>
				تحوي تعليمة <literal>DirectoryIndex</literal> قائمة الملفات لتجربتها عند الرد على العميل عندما يطلب مجلداً. يستخدم أول ملف متوفر ويرسل كرد على الطلب.
			</para>
			 <indexterm>
				<primary><literal>DirectoryIndex</literal>، تعليمة أباتشي توجيهية</primary>
			</indexterm>
			 <para>
				تُتبَع التعليمة <literal>Options</literal> بقائمة من الخيارات المطلوب تفعيلها. تُعطّل القيمة <literal>None</literal> جميع الخيارات؛ وفي المقابل، تُفعِّلها <literal>All</literal> جميعاً عدا <literal>MultiViews</literal>. من الخيارات المتاحة:
			</para>
			 <itemizedlist>
				<listitem>
					<para>
						تشير <literal>ExecCGI</literal> إلى إمكانية تنفيذ سكربتات CGI. <indexterm><primary><literal>ExecCGI</literal>، تعليمة أباتشي توجيهية</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						تسمح <literal>FollowSymlinks</literal> للمخدم بتتبع الروابط الرمزية، ويطلب منه إرسال محتويات أهداف هذه الروابط في الردود. <indexterm><primary><literal>FollowSymlinks</literal>، تعليمة أباتشي توجيهية</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						تطلب <literal>SymlinksIfOwnerMatch</literal> من المخدم تتبع الروابط الرمزية أيضاً، لكن فقط عندما ينتمي الرابط والهدف للمالك نفسه. <indexterm><primary><literal>SymlinksIfOwnerMatch</literal>، تعليمة أباتشي توجيهية</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						تُفعّل <literal>Includes</literal> ميزة <emphasis>Server Side Includes</emphasis> (أو <emphasis>SSI</emphasis> اختصاراً). وهي تعليمات مضمنة في صفحات HTML وتُنفّذ آنياً عند كل طلب. <indexterm><primary><literal>Includes</literal>، تعليمة أباتشي توجيهية</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						تطلب <literal>Indexes</literal> من المخدم سرد محتويات المجلد إذا أشار طلب HTTP الذي أرسله العميل لمجلد لا يحوي ملف فهرس (أي عندما لا يحوي المجلد أي ملف من الملفات المذكورة في <literal>DirectoryIndex</literal>). <indexterm><primary><literal>Indexes</literal>، تعليمة أباتشي توجيهية</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						تُفعّل <literal>MultiViews</literal> التفاوض على المحتوى؛ يمكن أن يستخدم المخدم هذا لإعادة صفحة وب توافق اللغة المفضلة حسب إعدادات المتصفح. <indexterm><primary><literal>MultiViews</literal>، تعليمة أباتشي توجيهية</primary></indexterm>
					</para>

				</listitem>

			</itemizedlist>
			 <para>
			</para>
			 <sidebar> <title><emphasis>أساسيات</emphasis> ملف <filename dir="ltr">.htaccess</filename></title>
			 <para>
				يحوي الملف <filename dir="ltr">.htaccess</filename> تعليمات ضبط أباتشي تُفرض عليه عند كل طلب لأحد عناصر المجلد الذي يحوي هذا الملف. كما يمتد مدى هذه التعليمات إلى جميع المجلدات الفرعية ضمن ذاك المجلد.
			</para>
			 <indexterm>
				<primary><filename dir="ltr">.htaccess</filename></primary>
			</indexterm>
			 <para>
				معظم التعليمات التي يمكن وضعها في كتلة <literal>Directory</literal> مسموحة أيضاً في الملف <filename dir="ltr">.htaccess</filename>.
			</para>
			 </sidebar> <para>
				تسرد التعليمة <literal>AllowOverride</literal> جميع الخيارات التي يمكن تفعيلها أو تعطيلها باستخدام ملفات <filename dir="ltr">.htaccess</filename>. أحد الاستخدامات الشائعة لها هو تقييد <literal>ExecCGI</literal>، بحيث يختار مدير النظام المستخدمين الذين يحق لهم تشغيل البرامج تحت هوية مخدم الوب (المستخدم <literal>www-data</literal>).
			</para>
			 <indexterm>
				<primary><literal>AllowOverride</literal>، تعليمة أباتشي توجيهية</primary>
			</indexterm>
			 <section>
				<title>طلب المصادقة</title>
				 <indexterm>
					<primary>مصادقة في الوب</primary>
				</indexterm>
				 <para>
					يلزم أحياناً تقييد الوصول لأجزاء من موقع الوب، بحيث يسمح فقط للمستخدمين المشروعين الذي يدخلون اسم مستخدم وكلمة سر بالوصول للمحتويات.
				</para>
				 <example>
					<title>ملف <filename dir="ltr">.htaccess</filename> يطلب المصادقة</title>
					 
<programlisting>
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private
</programlisting>

				</example>
				 <sidebar> <title><emphasis>أمن</emphasis> لا أمن</title>
				 <para>
					الأمن في نظام المصادقة المستخدم في المثال السابق (<literal>Basic</literal>) ضعيف لأن كلمة السر ترسل بشكل نص صريح (ترمّز بشفرة <emphasis>base64</emphasis>، وهي ترميز بسيط وليست عملية تشفير). كما يجب الانتباه إلى أن المستندات ”المحمية" بهذه الطريقة ترسل أيضاً عبر الشبكة دون تشفير. إذا كان الأمن مهماً، يجب تشفير اتصال HTTP كله باستخدام SSL.
				</para>
				 </sidebar> <para>
					يحوي الملف <filename dir="ltr">/etc/apache2/authfiles/htpasswd-private</filename> قائمة المستخدمين وكلمات السر؛ ومن الشائع تعديله باستخدام الأمر <command>htpasswd</command>. مثلاً، يُستَخدم الأمر التالي لإضافة مستخدم أو لتغيير كلمة سره: <indexterm><primary><command>htpasswd</command></primary></indexterm>
				</para>
				 
<screen>
<computeroutput># </computeroutput><userinput>htpasswd /etc/apache2/authfiles/htpasswd-private <replaceable>user</replaceable>
</userinput><computeroutput>New password:
Re-type new password:
Adding password for user <replaceable>user</replaceable>
</computeroutput></screen>

			</section>
			 <section>
				<title>تقييد الوصول</title>
				 <indexterm>
					<primary>تقييد الوصول في الوب</primary>
				</indexterm>
				 <para>
					تتحكم تعليمة <literal>Require</literal> بتقييد الوصول للمجلد (ومجلداته الفرعية).
				</para>
				 <indexterm>
					<primary>أباتشي، التعليمات التوجيهية</primary>
				</indexterm>
				 <indexterm>
					<primary>توجيهات، أباتشي</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Require</literal>، تعليمة أباتشي توجيهية</primary>
				</indexterm>
				 <para>
					يمكن استخدامها لتقييد الوصول اعتماداً على معايير كثيرة؛ سنكتفي نحن بشرح تقييد الوصول اعتماداً على عنوان IP الخاص بالعميل، لكن يمكن جعل القيود أقوى من ذلك بكثير، خصوصاً عند جمع عدة تعليمات <literal>Require</literal> معاً ضمن كتلة <literal>RequireAll</literal>.
				</para>
				 <example>
					<title>السماح بالوصول من الشبكة المحلية فقط</title>
					 
<programlisting>Require ip 192.168.0.0/16</programlisting>

				</example>
				 <sidebar> <title><emphasis>بدائل</emphasis> الصيغة القديمة</title>
				 <para>
					صيغة تعليمة <literal>Require</literal> متاحة فقط في أباتشي 2.4 (النسخة المتاحة في <emphasis role="distribution">جيسي</emphasis>). أما بالنسبة لمستخدمي <emphasis role="distribution">ويزي</emphasis>، فالصيغة المستخدمة مع أباتشي 2.2 مختلفة، وقد بيناها هنا من باب العلم بالشيء، ولو أنك تستطيع استخدامها مع أباتشي 2.4 إذا فعلت وحدة <literal>mod_access_compat</literal>.
				</para>
				 <para>
					تتحكم تعليمتا <literal>Allow from</literal> و<literal>Deny from</literal> بتقييد الوصول للمجلد (ومجلداته الفرعية).
				</para>
				 <indexterm>
					<primary><literal>Allow from</literal>، تعليمة أباتشي توجيهية</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Deny from</literal>، تعليمة أباتشي توجيهية</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Order</literal>، تعليمة أباتشي توجيهية</primary>
				</indexterm>
				 <para>
					تحدد تعليمة <literal>Order</literal> ترتيب تطبيق تعليمتي <literal>Allow from</literal> و<literal>Deny from</literal>؛ والأولوية للتعليمة التي تُطبّق أخيراً. بشكل أوضح، تسمح تعليمة <literal>Order deny,allow</literal> للعميل بالوصول إذا لم تنطبق تعليمة <literal>Deny from</literal> عليه، أو إذا انطبقت عليه تعليمة <literal>Allow from</literal>. وبالعكس، ترفض <literal>Order allow,deny</literal> وصوله إذا لم تنطبق عليه تعليمة <literal>Allow from</literal> (أو إذا انطبق عليه تعليمة <literal>Deny from</literal>).
				</para>
				 <para>
					يمكن أن تلحق تعليمتي <literal>Allow from</literal> و<literal>Deny from</literal> بعنوان IP، أو شبكة (مثل <literal>192.168.0.0/255.255.255.0</literal>، أو <literal>192.168.0.0/24</literal> أو حتى <literal>192.168.0</literal>)، أو اسم مضيف أو اسم نطاق، أو الكلمة المفتاحية <literal>all</literal>، التي تشير للجميع.
				</para>
				 <para>
					مثلاً، لرفض الاتصالات افتراضياً مع السماح بالاتصال من الشبكة المحلية، يمكنك استخدام ما يلي:
				</para>
				 
<programlisting>
Order deny,allow
Allow from 192.168.0.0/16
Deny from all
</programlisting>
				 </sidebar>
			</section>

		</section>
		 <section>
			<title>محللات السجلات</title>
			 <para>
				كثيراً ما يُثبّت محلل سجلات على مخدم الوب؛ لأنه يعطي مديري النظم فكرة دقيقة عن أنماط استخدام المخدم.
			</para>
			 <para>
				اختار مديرو النظم في شركة فلكوت <emphasis>AWStats</emphasis> ‏(<emphasis>Advanced Web Statistics</emphasis>، إحصائيات الوب المتقدمة) لتحليل ملفات سجلات أباتشي.
			</para>
			 <indexterm>
				<primary><emphasis>AWStats</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary>وب، تحليل السجلات</primary>
			</indexterm>
			 <indexterm>
				<primary>سجل</primary>
				<secondary>محلل سجلات الوب</secondary>
			</indexterm>
			 <indexterm>
				<primary>تحليل سجلات الوب</primary>
			</indexterm>
			 <para>
				أولى خطوات الإعداد هي تخصيص الملف <filename dir="ltr">/etc/awstats/awstats.conf</filename>. لقد ترك مديرو النظم في فلكوت الملف دون تعديل عدا البارمترات التالية:
			</para>
			 
<programlisting>
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</programlisting>
			 <para>
				جميع هذه البارمترات مشروحة في التعليقات في ملف القالب. بالأخص، يحدد المتغيران <varname>LogFile</varname> و<varname>LogFormat</varname> موقع ملف السجلات وصيغة المعلومات التي يحويها؛ ويسرد <varname>SiteDomain</varname> و<varname>HostAliases</varname> الأسماء المتنوعة التي يعرف بها الموقع الرئيسي.
			</para>
			 <para>
				يجب ألا تعطى القيمة <literal>1</literal> للمتغير <varname>DNSLookup</varname> في المواقع عالية الطلب؛ أما بالنسبة للمواقع الأصغر، مثل موقع فلكوت المعروض أعلاه، فيسمح هذا الخيار بالحصول على تقارير أوضح تتضمن الأسماء الكاملة للأجهزة بدلاً من عناوين IP.
			</para>
			 <sidebar> <title><emphasis>أمن</emphasis> الوصول للإحصائيات</title>
			 <para>
				يتيح AWstats إحصائياته على الموقع دون قيود افتراضياً، لكن يمكن فرض قيود بحيث يسمح لبضعة عناوين IP فقط (قد تكون داخلية) بالوصول لها؛ يجب تعريف قائمة عناوين IP المصرح لها بالوصول في المتغير <varname>AllowAccessFromWebToFollowingIPAddresses</varname>.
			</para>
			 </sidebar> <para>
				يمكن تفعيل AWstats أيضاً للمضيفات الظاهرية الأخرى؛ يحتاج كل مضيف لملف إعداد خاص، مثل <filename dir="ltr">/etc/awstats/awstats.www.falcot.org.conf</filename>.
			</para>
			 <example>
				<title>ملف إعداد AWstats لمضيف ظاهري</title>
				 
<programlisting>
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"
</programlisting>

			</example>
			 <para>
				يستخدم AWstats أيقونات عديدة مُخزّنة في المجلد <filename>/usr/share/awstats/icon/</filename>. حتى تتوفر هذه الأيقونات على موقع الوب، يجب تعديل إعدادات أباتشي وإضافة التعليمة التوجيهية التالية:
			</para>
			 
<programlisting>
Alias /awstats-icon/ /usr/share/awstats/icon/
</programlisting>
			 <para>
				بعد بضعة دقائق (وبعد أن يعمل السكربت بضع مرات)، تصبح النتائج متوفرة على الموقع: <ulink type="block" url="http://www.falcot.com/cgi-bin/awstats.pl" /><ulink type="block" url="http://www.falcot.org/cgi-bin/awstats.pl" />
			</para>
			 <sidebar> <title><emphasis>تحذير</emphasis> تدوير ملفات السجلات</title>
			 <para>
				حتى تأخذ الإحصائيات جميع السجلات بعين الاعتبار، يجب تشغيل <emphasis>AWStats</emphasis> مباشرة قبل تدوير ملفات سجلات أباتشي. بالاطلاع على التعليمة <literal>prerotate</literal> في الملف <filename dir="ltr">/etc/logrotate.d/apache2</filename>، يمكن حل هذه المشكلة بإضافة رابط رمزي للسكربت <filename dir="ltr">/usr/share/awstats/tools/update.sh</filename> في المجلد <filename dir="ltr">/etc/logrotate.d/httpd-prerotate</filename>:
			</para>
			 
<screen><computeroutput>$ </computeroutput><userinput>cat /etc/logrotate.d/apache2
</userinput><computeroutput>/var/log/apache2/*.log {
  daily
  missingok
  rotate 14
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    if /etc/init.d/apache2 status &gt; /dev/null ; then \
      /etc/init.d/apache2 reload &gt; /dev/null; \
    fi;
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ </computeroutput><userinput>sudo mkdir -p /etc/logrotate.d/httpd-prerotate
</userinput><computeroutput>$ </computeroutput><userinput>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats
</userinput></screen>
			 <para>
				لاحظ أيضاً أنه يجب منح صلاحيات قراءة ملفات السجلات التي ينشئها <command>logrotate</command> للجميع، وخصوصاً AWstats. في المثال السابق، يضمن السطر <literal>create 644 root adm</literal> ذلك (بدلاً من الصلاحيات الافتراضية <literal>640</literal>).
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.ftp-file-server">
		<title>مخدم الملفات FTP</title>
		 <indexterm>
			<primary>FTP (<emphasis>File Transfer Protocol</emphasis>)</primary>
		</indexterm>
		 <para>
			FTP‏ (<emphasis>File Transfer Protocol</emphasis>، أو بروتوكول نقل الملفات) هو أحد بروتوكولات الإنترنت الأولى (أُصدِرَ RFC 959 سنة 1985!). لقد كان يستخدم لتوزيع الملفات حتى قبل ولادة الوب (أُنشئ بروتوكول HTTP في 1990، وعُرِّفت النسخة 1.0 منه رسمياً في RFC 1945، الصادر في 1996).
		</para>
		 <para>
			يسمح هذا البروتوكول برفع وتنزيل الملفات؛ لذلك لا يزال واسع الاستخدام لتنصيب التحديثات على المواقع التي يستضيفها مزوّدي خدمة الإنترنت (أو أي هيئة استضافة مواقع أخرى). في هذه الحالات، نستخدم اسم مستخدم وكلمة سر؛ وبعد المصادقة، يعطي مخدم FTP صلاحيات القراءة والكتابة لمجلد بيت المستخدم.
		</para>
		 <para>
			أما مخدمات FTP الأخرى فتستخدم بشكل رئيسي لتوزيع الملفات وإتاحتها للتنزيل للعموم؛ حزم دبيان هي مثال عن هذا. تسحب محتويات هذه المخدمات مخدمات أخرى، بعيدة عنها جغرافياً؛ وبعدها توفرها للمستخدمين الأقرب إليها. هذا يعني أن المصادقة مع العميل غير ضرورية؛ ولذلك، يدعى وضع العمل هذا باسم ”anonymous FTP“. للأمانة العلمية، هناك مصادقة مع العملاء في هذا الوضع حيث يستخدم الاسم <literal>anonymous</literal>؛ أما كلمة السر فهي، تقليدياً، عنوان البريد الإلكتروني للمستخدم، لكن المخدم يتجاهلها.
		</para>
		 <para>
			تتوفر مخدمات FTP عديدة في دبيان (<emphasis role="pkg">ftpd</emphasis>، ‏<emphasis role="pkg">proftpd-basic</emphasis>، ‏<emphasis role="pkg">pyftpd</emphasis> وغيرها). اختار مديرو النظم في شركة فلكوت <emphasis role="pkg">vsftpd</emphasis> لأنهم يستخدمون مخدم FTP لتوزيع بضعة ملفات فقط (من ضمنها مستودع لحزم دبيان)؛ وبما أنهم لا يحتاجون لأي مزايا متقدمة، فقد اختاروا التركيز على النواحي الأمنية.
		</para>
		 <indexterm>
			<primary><emphasis role="pkg">vsftpd</emphasis></primary>
		</indexterm>
		 <para>
			يؤدي تثبيت الحزمة لإنشاء المستخدم <literal>ftp</literal> على النظام. يستخدم هذا الحساب دوماً مع اتصالات FTP المجهولة، ويعتبر مجلد بيته (<filename>/srv/ftp/</filename>) جذراً لشجرة الملفات المتاحة للمستخدمين المتصلين بهذه الخدمة. تحتاج الإعدادات الافتراضية (في <filename dir="ltr">/etc/vsftpd.conf</filename>) إلى بعض التغييرات لتلبي الحاجة إلى توفير الملفات الكبيرة للتنزيل العمومي: يجب تفعيل الوصول المجهول (<literal>anonymous_enable=YES</literal>) كما يجب تعطيل صلاحية القراءة فقط للمستخدمين المحليين (<literal>local_enable=NO</literal>). تعطيل هذه الصلاحية مهم لأن بروتوكول FTP لا يستخدم أي شكل من أشكال التشفير وبالتالي يمكن التقاط كلمات سر المستخدمين عبر الشبكة.
		</para>

	</section>
	 <section id="sect.nfs-file-server">
		<title>مخدم الملفات NFS</title>
		 <para>
			NFS ‏(<emphasis>Network File System</emphasis>) هو بروتوكول يسمح بالوصول البعيد لنظم الملفات عبر الشبكة. تستطيع جميع نظم يونكس العمل مع هذا البروتوكول؛ لكن إذا دخلت نظم ويندوز على الصورة فلا بدَّ من استخدام Samba بدلاً منه.
		</para>
		 <indexterm>
			<primary>NFS</primary>
		</indexterm>
		 <indexterm>
			<primary><emphasis>شبكة</emphasis></primary>
			<secondary><emphasis>نظام ملفات</emphasis></secondary>
		</indexterm>
		 <indexterm>
			<primary>نظام ملفات</primary>
			<secondary>شبكي</secondary>
		</indexterm>
		 <indexterm>
			<primary>ملف</primary>
			<secondary>مخدم</secondary>
		</indexterm>
		 <indexterm>
			<primary>مخدم</primary>
			<secondary>ملفات</secondary>
		</indexterm>
		 <para>
			أداة قوية جداً ولكنه يعاني، منذ الأزل، من قيود كثيرة، معظمها حلت في الإصدار 4 من البروتوكول. ولكن العيب هو أن إعداد الإصدار الأخير من NFS أصعب عندما ترغب باستخدام مزايا الحماية البسيطة مثل المصادقة والتشفير لأنه يعتمد على Kerberos في هذه الأجزاء. وإذا لم تستخدم هذه المزايا عليك الاقتصار على استخدام بروتوكول NFS في الشبكات المحلية الموثوقة فقط لأن البيانات تنتقل عبر الشبكة دون تشفير (يستطيع <emphasis>sniffer</emphasis> التقاطها) كما تعطى صلاحيات الوصول اعتماداً على عنوان IP الخاص بالعميل (الذي يمكن تزويره).
		</para>
		 <sidebar> <title><emphasis>توثيق</emphasis> NFS HOWTO</title>
		 <para>
			لا توجد وثائق جيدة كثيرة تشرح استخدام NFSv4. إليك بعض المؤشرات إلى محتوى بمستويات جودة مختلفة لكن يجب على الأقل أن تعطيك تلميحات عما يجب أن تفعل. <ulink type="block" url="https://help.ubuntu.com/community/NFSv4Howto" /> <ulink type="block" url="http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration" />
		</para>
		 </sidebar> <section>
			<title>تأمين NFS</title>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>أمن</secondary>
			</indexterm>
			 <para>
				إذا لم تكن تستخدم مزايا الأمان التي تعتمد على Kerberos فلا بد أن تضمن أن الأجهزة التي يسمح لها باستخدام NFS هي الوحيدة التي تستطيع الاتصال بمختلف مخدمات RPC اللازمة، لأن البروتوكول البسيط يثق بالمعلومات التي يستقبلها من الشبكة. يجب أن يمنع الجدار الناري أيضاً تزوير عناوين IP ‏(<emphasis>IP spoofing</emphasis>) بحيث لا يسمح لأي جهاز خارجي أن ينتحل شخصية جهاز داخلي، ويجب حصر الوصول إلى المنافذ المعنية بالأجهزة التي يسمح لها بالوصول لمشاركات NFS.
			</para>
			 <sidebar> <title><emphasis>أساسيات</emphasis> RPC</title>
			 <para>
				RPC ‏(<emphasis>Remote Procedure Call</emphasis>، أو استدعاء الإجراءات البعيدة) هو معيار في يونكس للخدمات البعيدة. NFS هي واحدة من هذه الخدمات.
			</para>
			 <indexterm>
				<primary>RPC</primary>
			</indexterm>
			 <indexterm>
				<primary><emphasis>Remote Procedure Call</emphasis></primary>
			</indexterm>
			 <para>
				تُسجَّل خدمات RPC في دليل يعرف باسم <emphasis>portmapper</emphasis>. يتصل العميل الذي يرغب بإجراء طلب NFS مع <emphasis>portmapper</emphasis> أولاً (على المنفذ 111، إما TCP أو UDP)، ويسأل عن مخدم NFS؛ يتضمن الرد عادة المنفذ 2049 (منفذ NFS الافتراضي). لا يشترط أن تستخدم جميع خدمات RPC منافذ ثابتة.
			</para>
			 </sidebar> <para>
				كانت النسخ الأقدم من البروتوكول تتطلب خدمات RPC أخرى التي كانت تستخدم منافذ تتعين ديناميكياً. لحسن الحظ، لم تعد هناك حاجة إلا إلى المنفذ 2049 (لخدمة NFS) والمنفذ 111 (من أجل portmapper) وهذا يسهل إعداد الجدران النارية.
			</para>
			 <indexterm>
				<primary><command>portmapper</command></primary>
			</indexterm>

		</section>
		 <section>
			<title>مخدم NFS</title>
			 <para>
				مخدم NFS جزء من النواة لينكس؛ وهو مبني كوحدة في النَوَى التي تقدمها دبيان. إذا كان هناك رغبة بتشغيل مخدم NFS تلقائياً عند الإقلاع، يجب تثبيت الحزمة <emphasis role="pkg">nfs-kernel-server</emphasis>؛ فهي تحوي سكربتات بدء التشغيل المناسبة.
			</para>
			 <para>
				يسرد ملف إعداد مخدم NFS، ‏<filename>/etc/exports</filename>،المجلدات التي سيوفرها على الشبكة (المجلدات المُصدّرة <emphasis>exported</emphasis>). بالنسبة لكل مشاركة NFS، تمنح صلاحيات الوصول فقط للأجهزة المذكورة بجوارها. يمكن التحكم بالوصول بدقة أكبر باستخدام بضعة خيارات. صيغة الملف بسيطة جداً:
			</para>
			 <indexterm>
				<primary><filename>exports</filename></primary>
			</indexterm>
			 <indexterm>
				<primary><filename dir="ltr">/etc/exports</filename></primary>
			</indexterm>
			 
<programlisting>
/directory/to/share machine1(option1,option2,...) machine2(...) ...
</programlisting>
			 <para>
				لاحظ أنه في NFSv4، يجب أن تكون جميع المجلدات المصدرة تابعة لشجرة مجلدات واحدة وأن جذر تلك الشجرة يجب تصديره حتماً وتعريفه بالخيار <literal>fsid=0</literal> أو الخيار <literal>fsid=root</literal>.
			</para>
			 <para>
				يمكن التعرف على الأجهزة باسم DNS أو بعنوان IP الخاص بها. كما يمكن تحديد مجموعات من الأجهزة باستخدام صيغة مثل <literal dir="ltr">*.falcot.com</literal> أو مجال من عناوين IP مثل <literal>192.168.0.0/255.255.255.0</literal> أو <literal>192.168.0.0/24</literal>.
			</para>
			 <para>
				تُصدّر المجلدات في وضع القراءة فقط افتراضياً (أو باستخدام الخيار <literal>ro</literal>). يمنح الخيار <literal>rw</literal> صلاحيات القراءة والكتابة. يتصل عملاء NFS نموذجياً من منفذ مخصص للمستخدم الجذر (أي أنه أقل من 1024)؛ يمكن رفع هذا القيد باستخدام الخيار <literal>insecure</literal> (الخيار <literal>secure</literal> ضمني، لكن يمكن كتابته صراحة للتوضيح إذا اقتضت الحاجة).
			</para>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>خيارات</secondary>
			</indexterm>
			 <para>
				افتراضياً، يجيب المخدم فقط على طلبات NFS بعد إتمام العملية على القرص (الخيار <literal>sync</literal>)؛ لكن يمكن تعطيل هذا بالخيار <literal>async</literal>. تزيد عمليات الكتابة غير المتزامنة الأداء قليلاً، لكنها تخفض الموثوقية بسبب احتمال خسارة البيانات إذا انهار المخدم في الفترة ما بين إرسال تأكيد الكتابة وبين إنهاء الكتابة الفعلية على القرص. بما أن القيمة الافتراضية تغيرت مؤخراً (مقارنة بالقيمة التاريخية في NFS)، يُفضّل استخدام خيار صريح.
			</para>
			 <para>
				يعتبر المخدم جميع الطلبات التي تبدو أنها واردة من المستخدم الجذر على أنها ترد من المستخدم <literal>nobody</literal>، وذلك في سبيل عدم منح صلاحيات الجذر على نظام الملفات لأي عميل NFS. هذا السلوك يوافق الخيار <literal>root_squash</literal>، وهو مُفعّل افتراضياً. أما الخيار <literal>no_root_squash</literal>، الذي يُعطّل هذا السلوك، فهو خطر ويجب استخدامه فقط في البيئات المسيطر عليها. يسمح الخياران <literal>anonuid=<replaceable>uid</replaceable></literal> و<literal>anongid=<replaceable>gid</replaceable></literal> بتحديد مستخدم زائف آخر لاستخدامه بدلاً من UID/GID 65534 (التي توافق المستخدم <literal>nobody</literal> والمجموعة <literal>nogroup</literal>).
			</para>
			 <para>
				في NFSv4، يمكنك إضافة الخيار <literal>sec</literal> لتحديد مستوى الحماية الذي تريد: <literal>sec=sys</literal> هو الافتراضي وليس له خصائص أمنية مميزة، أما المستوى <literal>sec=krb5</literal> فيفعل المصادقة فقط، والمستوى <literal>sec=krb5i</literal> يضيف التحقق من سلامة المعلومات المنقولة، والمستوى <literal>sec=krb5p</literal> هو أكمل المستويات حيث يتضمن حماية الخصوصية (عبر تشفير البيانات). سوف تحتاج لإعداد Kerberos حتى تعمل هذه المستويات (هذه الخدمة غير مشروحة في هذا الكتاب).
			</para>
			 <para>
				هناك خيارات أخرى متاحة؛ وهي موثّقة في صفحة الدليل <citerefentry><refentrytitle>exports</refentrytitle>
				 <manvolnum>5</manvolnum></citerefentry>‎.
			</para>
			 <sidebar> <title><emphasis>تحذير</emphasis> التثبيت الأول</title>
			 <para>
				يبدأ سكربت الإقلاع <filename dir="ltr">/etc/init.d/nfs-kernel-server</filename> تشغيل المخدم فقط إذا كان الملف <filename dir="ltr">/etc/exports</filename> يذكر مشاركة NFS صالحة واحدة أو أكثر. عند الإعداد أول مرة، يجب تشغيل مخدم NFS يدوياً بعد تحرير هذا الملف باستخدام الأمر التالي:
			</para>
			 
<screen>
<computeroutput># </computeroutput><userinput>service nfs-kernel-server start</userinput></screen>
			 </sidebar>
		</section>
		 <section>
			<title>عميل NFS</title>
			 <indexterm>
				<primary>عميل</primary>
				<secondary>NFS</secondary>
			</indexterm>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>عميل</secondary>
			</indexterm>
			 <para>
				كما في نظم الملفات الأخرى، يجب ربط (mount) مشاركات NFS في شجرة ملفات النظام لمدجها معها. بما أن نظام الملفات هذا له خصوصياته، فقد أضيفت بعض التعديلات على صيغة الأمر <command>mount</command> والملف <filename dir="ltr">/etc/fstab</filename>.
			</para>
			 <example>
				<title>الربط اليدوي باستخدام الأمر <command>mount</command></title>
				 
<screen>
          <computeroutput># </computeroutput><userinput>mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/shared</userinput></screen>

			</example>
			 <example>
				<title>مدخلة NFS في الملف <filename dir="ltr">/etc/fstab</filename></title>
				 
<programlisting>
arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0 0</programlisting>

			</example>
			 <para>
				تعمل المدخلة المبينة أعلاه على ربط مجلد NFS ‏<filename>/shared/</filename> من المخدم <literal>arrakis</literal> مع المجلد المحلي <filename>/srv/shared/</filename> عند إقلاع النظام. صلاحيات الكتابة والقراءة مطلوبة (ولذلك استخدم الخيار <literal>rw</literal>). أما الخيار <literal>nosuid</literal> فهو للحماية حيث يزيل بتات <literal>setuid</literal> أو <literal>setgid</literal> من البرامج المخزّنة على المشاركة. إذا كان القصد من مشاركة NFS تخزين المستندات فقط، فهناك خيار آخر ننصح به هو <literal>noexec</literal>، الذي يمنع تنفيذ البرامج المُخزَّنة على المشاركة. لاحظ أن المجلد <filename>shared</filename> على المخدم يقع تحت جذر التصدير في NFSv4 (مثلاً <filename dir="ltr">/export/shared</filename>)، وليس مجلداً من المستوى الأعلى.
			</para>
			 <para>
				تشرح صفحة الدليل <citerefentry><refentrytitle>nfs</refentrytitle>
				 <manvolnum>5</manvolnum></citerefentry>‎ ‎جميع الخيارات بشيء من التفصيل.
			</para>

		</section>

	</section>
	 <section id="sect.windows-file-server-with-samba">
		<title>إعداد مشاركات ويندوز باستخدام سامبا</title>
		 <para>
			سامبا هي مجموعة أدوات تدعم بروتوكول SMB (يُعرَف أيضاً باسم ”CIFS“) على لينكس. يستخدم ويندوز هذا البروتوكول لمشاركة الملفات والطابعات على الشبكة.
		</para>
		 <indexterm>
			<primary>مشاركة Windows</primary>
		</indexterm>
		 <indexterm>
			<primary>Samba</primary>
		</indexterm>
		 <indexterm>
			<primary>SMB</primary>
		</indexterm>
		 <indexterm>
			<primary>CIFS</primary>
		</indexterm>
		 <indexterm>
			<primary>مخدم</primary>
			<secondary>ملفات</secondary>
		</indexterm>
		 <para>
			تستطيع سامبا أيضاً العمل كمتحكم نطاق ويندوز. وهي أداة ممتازة لضمان التكامل السلس بين مخدمات لينكس والحواسيب المكتبية التي لا تزال تعمل بنظام ويندوز.
		</para>
		 <section>
			<title>مخدم سامبا</title>
			 <para>
				تحوي الحزمة <emphasis role="pkg">samba</emphasis> المخدمين الرئيسين لسامبا 4، <command>smbd</command> و<command>nmbd</command>.
			</para>
			 <indexterm>
				<primary><command>smbd</command></primary>
			</indexterm>
			 <indexterm>
				<primary><command>nmbd</command></primary>
			</indexterm>
			 <sidebar> <title><emphasis>توثيق</emphasis> التعمق أكثر</title>
			 <para>
				مخدم سامبا استعمالاته متنوعة جداً وقابل للضبط بشكل كبير، ويستطيع معالجة حالات استخدام عديدة جداً تلبي احتياجات مختلفة كثيراً وبُنَى شبكات متنوعة. يُركّز هذا الكتاب على الحالة التي يستخدم فيها سامبا كمخدم مستقل، لكنه يستطيع أن يعمل أيضاً كمتحكم نطاق NT4 أو كمتحكم نطاق Active Directory كامل، أو كعضو بسيط في نطاق سابق (الذي قد يديره مخدم ويندوز).
			</para>
			 <indexterm>
				<primary>متحكم نطاق</primary>
			</indexterm>
			 <indexterm>
				<primary>نطاق Windows</primary>
			</indexterm>
			 <para>
				تحوي الحزمة <emphasis role="pkg">samba-doc</emphasis> ثروة من ملفات الأمثلة المزودة بتعليقات التي تثبت في <filename>/usr/share/doc/samba-doc/examples/</filename>.
			</para>
			 </sidebar> <sidebar> <title><emphasis>أدوات</emphasis> المصادقة مع مخدم ويندوز</title>
			 <para>
				تعطي Winbind مدير النظام إمكانية استخدام مخدم ويندوز كمخدم مصادقة. كما تتكامل Winbind بسلاسة مع PAM و NSS. يسمح هذا بإعداد أجهزة لينكس حيث يستطيع جميع مستخدمي نطاق ويندوز الحصول على حساب آلياً.
			</para>
			 <indexterm>
				<primary>Winbind</primary>
			</indexterm>
			 <para>
				يمكنك العثور على مزيد من المعلومات في المجلد <filename dir="ltr">/usr/share/doc/samba-doc/examples/pam_winbind/</filename>.
			</para>
			 </sidebar> <section>
				<title>الإعداد باستخدام <command>debconf</command></title>
				 <para>
					تُعدُّ الحزمة إعداداً أصغرياً أثناء التثبيت الأولي لكن هذا لا يغنيك عن استدعاء <command>dpkg-reconfigure samba-common</command> لتعديله:
				</para>
				 <para>
					أول معلومة مطلوبة هي اسم مجموعة العمل التي سينضم لها مخدم Samba (الإجابة هي <literal>FALCOTNET</literal> في مثالنا).
				</para>
				 <para>
					كما تقترح الحزمة التعرّف على مخدم WINS من المعلومات التي تقدمها خدمة DHCP. رفض مديرو النظم في شركة فلكوت هذا الخيار، لأنهم ينوون استخدام مخدم سامبا نفسه كمخدم WINS.
				</para>
				 <indexterm>
					<primary>WINS</primary>
				</indexterm>

			</section>
			 <section>
				<title>الإعداد اليدوي</title>
				 <section>
					<title>التعديلات على <filename>smb.conf</filename></title>
					 <para>
						تتطلب احتياجات شركة فلكوت تعديل خيارات أخرى من الملف <filename dir="ltr">/etc/samba/smb.conf</filename>. تلخص المقتطفات التالية التعديلات التي أجروها في قسم <literal>[global]</literal>.
					</para>
					 
<programlisting>
[global]

## Browsing/Identification ###

# Change this to the workgroup/NT-domain name your Samba server will part of
   workgroup = FALCOTNET

# Windows Internet Name Serving Support Section:
# WINS Support - Tells the NMBD component of Samba to enable its WINS Server
   wins support = yes <co id="smb.conf.wins"></co>

[...]

####### Authentication #######

# Server role. Defines in which mode Samba will operate. Possible
# values are "standalone server", "member server", "classic primary
# domain controller", "classic backup domain controller", "active
# directory domain controller". 
#
# Most people will want "standalone sever" or "member server".
# Running as "active directory domain controller" will require first
# running "samba-tool domain provision" to wipe databases and create a
# new domain.
   server role = standalone server

# "security = user" is always a good idea. This will require a Unix account
# in this server for every user accessing the server.
   security = user <co id="smb.conf.security"></co>

[...]</programlisting>
					 <calloutlist>
						<callout arearefs="smb.conf.wins">
							<para>
								يشير إلى ضرورة استخدام سامبا كمخدم أسماء Netbios‏ (WINS) للشبكة المحلية.
							</para>

						</callout>
						 <callout arearefs="smb.conf.security">
							<para>
								هذه هي القيمة الافتراضية لهذا المتغير؛ لكن بما أنها مركزية في إعدادات سامبا، فيفضّل إعادة ضبطها صراحة. كل مستخدم يحتاج المصادقة قبل أن يصل لأي مشاركة.
							</para>

						</callout>

					</calloutlist>

				</section>
				 <section>
					<title>إضافة المستخدمين</title>
					 <para>
						يحتاج كل مستخدم سامبا حساباً على المخدم؛ يجب إنشاء حسابات يونكس أولاً، بعدها يجب تسجيل المستخدم في قاعدة بيانات سامبا. خطوة إضافة مستخدم يونكس تتم حسب الطريقة المعتادة (باستخدام <command>adduser</command> مثلاً).
					</para>
					 <para>
						أما لإضافة مستخدم حالي إلى قاعدة بيانات سامبا فيكفي تشغيل الأمر <command>smbpasswd -a <replaceable>user</replaceable></command>؛ سيطلب هذا الأمر إدخال كلمة السر.
					</para>
					 <para>
						يمكن حذف المستخدم بالأمر <command>smbpasswd -x <replaceable>user</replaceable></command>. كما يمكن تعطيل حسابات سامبا مؤقتاً (باستخدام <command>smbpasswd -d <replaceable>user</replaceable></command>) وإعادة تفعيلها لاحقاً (باستخدام <command>smbpasswd -e <replaceable>user</replaceable></command>).
					</para>

				</section>

			</section>

		</section>
		 <section>
			<title>عميل سامبا</title>
			 <para>
				تسمح ميزة العميل في سامبا لأجهزة لينكس بالوصول لمشاركات ويندوز والطابعات المشتركة. تتوفر البرامج المطلوبة في الحزمتين <emphasis role="pkg">cifs-utils</emphasis> و <emphasis role="pkg">smbclient</emphasis>.
			</para>
			 <indexterm>
				<primary><emphasis>smbclient</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary><emphasis>cifs-utils</emphasis></primary>
			</indexterm>
			 <section>
				<title>البرنامج <command>smbclient</command></title>
				 <para>
					يستعلم البرنامج <command>smbclient</command> عن مخدمات SMB. وهو يقبل الخيار <literal>-U <replaceable>user</replaceable></literal>، للاتصال بالمخدم بالهوية المحددة. يتصل الأمر <command>smbclient //<replaceable>server</replaceable>/<replaceable>share</replaceable></command> بالمشاركة بطريقة تفاعلية تشابه استخدام عميل FTP نصي. يسرد <command>smbclient -L <replaceable>server</replaceable></command> جميع المشاركات المتاحة (والمرئية) على المخدم.
				</para>

			</section>
			 <section>
				<title>ربط مشاركات ويندوز</title>
				 <para>
					يسمح الأمر <command>mount</command> بربط مشاركة ويندوز مع شجرة نظام ملفات لينكس (بمساعدة الأمر <command>mount.cifs</command> المتوفر في <emphasis role="pkg">cifs-utils</emphasis>).
				</para>
				 <indexterm>
					<primary><command>mount.cifs</command></primary>
				</indexterm>
				 <indexterm>
					<primary>مشاركة Windows، ربط</primary>
				</indexterm>
				 <example>
					<title>ربط مشاركات ويندوز</title>
					 
<programlisting>
mount -t cifs //arrakis/shared /shared \
      -o credentials=/etc/smb-credentials</programlisting>

				</example>
				 <para>
					صيغة الملف <filename dir="ltr">/etc/smb-credentials</filename> (الذي يجب ألا تعطى صلاحية قراءته للمستخدمين) كالتالي:
				</para>
				 
<programlisting>
username = <replaceable>user</replaceable>
password = <replaceable>password</replaceable></programlisting>
				 <para>
					يمكن تحديد خيارات أخرى من سطر الأوامر؛ تتوفر قائمة كاملة بهذه الخيارات في صفحة الدليل <citerefentry><refentrytitle>mount.cifs</refentrytitle>
					 <manvolnum>1</manvolnum></citerefentry>‎. هناك خيارات بالذات قد يهمانك: <literal>uid</literal> و<literal>gid</literal> اللذان يسمحان بفرض مالك ومجموعة للملفات المتاحة على المشاركة، حتى لا تنحصر صلاحيات الوصول بالمستخدم الجذر.
				</para>
				 <para>
					كما يمكن ضبط عملية ربط مشاركة ويندوز في الملف <filename dir="ltr">/etc/fstab</filename>:
				</para>
				 
<programlisting>
//<replaceable>server</replaceable>/shared /shared cifs credentials=/etc/smb-credentials
</programlisting>
				 <para>
					أما فك ربط مشاركة SMB/CIFS فعبر أمر <command>umount</command> القياسي.
				</para>

			</section>
			 <section>
				<title>الطباعة على طابعة مشتركة</title>
				 <para>
					CUPS هو حل أنيق للطباعة من محطة عمل لينكس على طابعة يشاركها جهاز ويندوز. عند تثبيت الحزمة <emphasis role="pkg">smbclient</emphasis>، يسمح CUPS بثبيت طابعات ويدوز المشتركة تلقائياً.
				</para>
				 <indexterm>
					<primary>طباعة</primary>
					<secondary>شبكة</secondary>
				</indexterm>
				 <para>
					إليك الخطوات اللازمة:
				</para>
				 <itemizedlist>
					<listitem>
						<para>
							ادخل إلى واجهة إعداد CUPS: ‏<literal>http://localhost:631/admin</literal>
						</para>

					</listitem>
					 <listitem>
						<para>
							انقر على ”إضافة طابعة“.
						</para>

					</listitem>
					 <listitem>
						<para>
							اختر الطابعة، انتق ”طابعة ويندوز عبر سامبا“.
						</para>

					</listitem>
					 <listitem>
						<para>
							أدخل عنوان URI للاتصال بالطابعة الشبكية. يجب أن يشبه ما يلي:
						</para>
						 <para>
							<literal>smb://<replaceable>user</replaceable>:<replaceable>password</replaceable>@<replaceable>server</replaceable>/<replaceable>printer</replaceable></literal>.
						</para>

					</listitem>
					 <listitem>
						<para>
							أدخل الاسم الذي سيعرف هذه الطابعة بشكل فريد. بعدها أدخل وصف الطابعة ومكانها. سوف تُعرَض هذه المعلومات للمستخدمين النهائيين لمساعدتهم على تمييز الطابعات.
						</para>

					</listitem>
					 <listitem>
						<para>
							حدد الشركة الصانعة للطابعة وطرازها، أو فوراً قدّم ملف وصف طابعة مناسب (PPD).
						</para>

					</listitem>

				</itemizedlist>
				 <para>
					تهانينا! الطابعة تعمل!
				</para>

			</section>

		</section>

	</section>
	 <section id="sect.http-ftp-proxy">
		<title>بروكسي HTTP/FTP</title>
		 <para>
			يعمل بروكسي HTTP/FTP كوسيط في اتصالات HTTP و (أو) FTP. يتمثل دور البروكسي في جزأين:
		</para>
		 <itemizedlist>
			<listitem>
				<para>
					التخبئة (Caching): تخزين نسخ من الملفات الأخيرة المسحوبة من الإنترنت محلياً، لتفادي تنزيلها عدة مرات.
				</para>

			</listitem>
			 <listitem>
				<para>
					الترشيح: إذا كان العميل مجبراً على استخدام البروكسي (وكانت الاتصالات الخارجة ممنوعة إلا إذا مَرَّت عبر البروكسي)، عندها يستطيع البروكسي التحكم بمنع الطلبات أو السماح بتنفيذها.
				</para>

			</listitem>

		</itemizedlist>
		 <indexterm>
			<primary>بروكسي HTTP/FTP</primary>
		</indexterm>
		 <indexterm>
			<primary>مخبأ البروكسي</primary>
		</indexterm>
		 <para>
			اختارت شركة فلكوت Squid كمخدم بروكسي.
		</para>
		 <indexterm>
			<primary>Squid</primary>
		</indexterm>
		 <section>
			<title>التثبيت</title>
			 <para>
				تحوي الحزمة <emphasis role="pkg">squid3</emphasis> البروكسي التجزيئي فقط (الذي يقدم خدمة التخبئة). ولتحويله إلى مخدم ترشيح يجب تثبيت الحزمة الإضافية <emphasis role="pkg">squidguard</emphasis>. بالإضافة لذلك، تقدم الحزمة <emphasis role="pkg">squid-cgi</emphasis> واجهة استعلام وإدارة لبروكسيات Squid.
			</para>
			 <para>
				قبل التثبيت، يجب الانتباه إلى التحقق من أن النظام يستطيع التعرّف على اسمه الكامل: يجب أن يعيد الأمر <command>hostname -f</command> اسماً كامل التوصيف fully-qualified (أي يتضمن اسم نطاق). إذا لم يُعِد ذلك، يجب تعديل الملف <filename dir="ltr">/etc/hosts</filename> حتى يحوي الاسم الكامل للنظام (مثلاً، <literal>arrakis.falcot.com</literal>). يجب التحقق من الاسم الرسمي للحاسوب مع مدير الشبكة لتفادي أي تضاربات.
			</para>

		</section>
		 <section>
			<title>إعداد خدمة التخبئة</title>
			 <para>
				لتفعيل ميزة مخدم التخبئة يكفي تعديل ملف الضبط <filename dir="ltr">/etc/squid3/squid.conf</filename> والسماح للأجهزة ضمن الشبكة المحلية بإرسال طلبات عبر البروكسي. يُبيّن المثال التالي التعديلات التي أجراها مديرو النظم في شركة فلكوت.
			</para>
			 <example>
				<title>الملف <filename dir="ltr">/etc/squid3/squid.conf</filename> (مقتطفات)</title>
				 
<programlisting>
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS

# Example rule allowing access from your local networks. Adapt
# to list your (internal) IP networks from where browsing should
# be allowed
acl our_networks src 192.168.1.0/24 192.168.2.0/24
http_access allow our_networks
http_access allow localhost
# And finally deny all other access to this proxy
http_access deny all
</programlisting>

			</example>

		</section>
		 <section>
			<title>إعداد خدمة الترشيح</title>
			 <para>
				<command>squid</command> نفسه لا يقدم خدمة الترشيح؛ بل يوكّل <command>squidGuard</command> بهذا العمل. يجب إعداد الأول حتى يتعامل مع الثاني. هذا يشمل إضافة التعليمة التوجيهية التالية إلى الملف <filename dir="ltr">/etc/squid3/squid.conf</filename>:
			</para>
			 <indexterm>
				<primary><command>squidGuard</command></primary>
			</indexterm>
			 
<programlisting>
url_rewrite_program /usr/bin/squidGuard -c /etc/squid3/squidGuard.conf</programlisting>
			 <para>
				كما يجب تثبيت برنامج CGI التالي أيضاً: <filename dir="ltr">/usr/lib/cgi-bin/squidGuard.cgi</filename>، باستخدام <filename dir="ltr">/usr/share/doc/squidguard/examples/squidGuard.cgi.gz</filename> كنقطة انطلاق. التعديلات المطلوبة على هذا السكربت هي المتغيرات <varname dir="ltr">$proxy</varname> و<varname dir="ltr">$proxymaster</varname> (اسم البروكسي والبريد الإلكتروني للتواصل مع مدير النظام). أما المتغيران <varname dir="ltr">$image</varname> و<varname dir="ltr">$redirect</varname> فيجب أن يشيرا إلى صور متاحة لاستخدامها للتعبير عن رفض الطلب.
			</para>
			 <para>
				يُفعّل المرشح بالأمر <command>service squid3 reload</command>. لكن بما أن الحزمة <emphasis role="pkg">squidguard</emphasis> لا ترشّح أي شيء افتراضياً، فعلى مدير النظام تحديد سياسة الترشيح. يكون ذلك عبر إنشاء الملف <filename dir="ltr">/etc/squid3/squidGuard.conf</filename> (باستخدام القالب <filename dir="ltr">/etc/squidguard/squidGuard.conf.default</filename> إذا اقتضت الحاجة).
			</para>
			 <para>
				يجب إعادة توليد قاعدة بيانات العمل باستخدام <command>update-squidguard</command> بعد كل تعديل على ملف ضبط <command>squidGuard</command> (أو تعديل إحدى قوائم النطافات أو عناوين URL التي يحويها). صيغة ملف الضبط موثّقة على الموقع التالي: <ulink type="block" url="http://www.squidguard.org/Doc/configure.html" />
			</para>
			 <indexterm>
				<primary><command>update-squidguard</command></primary>
			</indexterm>
			 <sidebar> <title><emphasis>بدائل</emphasis> DansGuardian</title>
			 <indexterm>
				<primary><emphasis role="pkg">dansguardian</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary>PICS</primary>
			</indexterm>
			 <para>
				الحزمة <emphasis role="pkg">dansguardian</emphasis> هي بديلة للحزمة <emphasis>squidguard</emphasis>. هذا البرنامج لا يعتمد ببساطة على قائمة سوداء بالعناوين المحظورة، بل يستطيع الاستفادة من نظام PICS ‏(<emphasis>Platform for Internet Content Selection</emphasis> منصة انتقاء محتوى الإنترنت) ليقرر إذا كانت الصفحة مقبولة اعتماداً على التحليل الديناميكي لمحتوياتها.
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.ldap-directory">
		<title>دليل LDAP</title>
		 <indexterm>
			<primary>LDAP</primary>
		</indexterm>
		 <indexterm>
			<primary>OpenLDAP</primary>
		</indexterm>
		 <indexterm>
			<primary>دليل، LDAP</primary>
		</indexterm>
		 <para>
			OpenLDAP هي تطبيق لبروتوكول LDAP؛ أي أنها قاعدة بيانات خاصة مصممة لتخزين الأدلة. في أغلب الأحيان، يسمح استخدام مخدم LDAP بمركزة إدارة حسابات المستخدمين وصلاحياتهم. كما أن نسخ قاعدة بيانات LDAP سهل، وهذا يسمح بإعداد مجموعة مخدمات LDAP متزامنة. عندما تنمو الشبكة وقاعدة المستخدمين سريعاً، يمكن عندئذ موازنة الحمل بين عدة مخدمات.
		</para>
		 <para>
			بيانات LDAP بنيوية (structured) وهرمية (hierarchical). تتحدد بنى البيانات ”بالسكيماهات schemas“ التي تعرّف أنواع الكائنات التي تستطيع قاعدة البيانات تخزينها، بالإضافة لقائمة تشمل جميع الصفات التي قد تأخذها هذه الكائنات. تعتمد الصيغة المستخدمة لتمثيل كائن ما في قاعدة البيانات على هذه البنية، ولذلك فهي معقّدة.
		</para>
		 <section>
			<title>التثبيت</title>
			 <para>
				تحوي الحزمة <emphasis role="pkg">slapd</emphasis> مخدم OpenLDAP. وتتضمن الحزمة <emphasis role="pkg">ldap-utils</emphasis> أدوات نصية للتعامل مع مخدمات LDAP.
			</para>
			 <indexterm>
				<primary><emphasis>slapd</emphasis></primary>
			</indexterm>
			 <para>
				تطرح عادة بضعة أسئلة قليلة جداً أثناء تثبيت <emphasis role="pkg">slapd</emphasis> وقاعدة البيانات الناتجة لن تناسب احتياجاتك غالباً. لحسن الحظ يكفيك استدعاء الأمر البسيط <command>dpkg-reconfigure slapd</command> الذي يسمح لك بإعادة ضبط قاعدة بيانات LDAP بتفصيل أكبر:
			</para>
			 <itemizedlist>
				<listitem>
					<para>
						تجاهل إعداد مخدم OpenLDAP؟ طبعاً لا، نحن نريد إعداد هذه الخدمة.
					</para>

				</listitem>
				 <listitem>
					<para>
						اسم مخدم DNS: ‏”<literal>falcot.com</literal>“.
					</para>

				</listitem>
				 <listitem>
					<para>
						اسم المنظمة: ”Falcot Corp“.
					</para>

				</listitem>
				 <listitem>
					<para>
						يجب كتابة كلمة سر الإدارة.
					</para>

				</listitem>
				 <listitem>
					<para>
						الطرف النهائي (backend) المستخدم لقاعدة البيانات: ”MDB“.
					</para>

				</listitem>
				 <listitem>
					<para>
						هل تريد إزالة قاعدة البيانات عند تطهير <emphasis role="pkg">slapd</emphasis>؟ لا. لا فائدة من المخاطرة بخسارة قاعدة البيانات عن طريق الخطأ.
					</para>

				</listitem>
				 <listitem>
					<para>
						نقل قاعدة البيانات القديمة؟ يظهر هذا السؤال فقط إذا أجريت الإعداد مع وجود قاعدة بيانات سابقة. أجب ”بنعم“ فقط إذا كنت فعلاً تريد البدء من جديد مع قاعدة بيانات نظيفة، مثلاً إذا استدعيت <command>dpkg-reconfigure slapd</command> مباشرة بعد التثبيت الأولي.
					</para>

				</listitem>
				 <listitem>
					<para>
						السماح ببروتوكول LDAPv2؟ لا، لا فائدة ترجى من ذلك. جميع الأدوات التي سنستخدمها تفهم بروتوكول LDAPv3.
					</para>

				</listitem>

			</itemizedlist>
			 <sidebar> <title><emphasis>أساسيات</emphasis> صيغة LDIF</title>
			 <para>
				ملف LDIF ‏(<emphasis>LDAP Data Interchange Format</emphasis>) هو ملف نصي محمول يصف محتويات قاعدة بيانات LDAP (أو جزءاً منها)؛ يمكن استخدامه لاحقاً لحقن البيانات في أي مخدم LDAP آخر.
			</para>
			 <indexterm>
				<primary>LDIF</primary>
			</indexterm>
			 </sidebar> <para>
				أُعدَّت الآن قاعدة بيانات مصغرة، كما يوضح لنا الاستعلام التالي:
			</para>
			 
<screen>
<computeroutput>$ </computeroutput><userinput>ldapsearch -x -b dc=falcot,dc=com</userinput>
<computeroutput># extended LDIF
#
# LDAPv3
# base &lt;dc=falcot,dc=com&gt; with scope sub
# filter: (objectclass=*)
# requesting: ALL
#

# falcot.com
dn: dc=falcot,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Falcot Corp
dc: falcot

# admin, falcot.com
dn: cn=admin,dc=falcot,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2
</computeroutput></screen>
			 <para>
				أعاد الاستعلام كائنين: المنظّمة نفسها، والمستخدم الإداري.
			</para>

		</section>
		 <section>
			<title>تعبئة الدليل</title>
			 <para>
				بما أن قاعدة البيانات الفارغة لا تفيدنا بحد ذاتها، فسوف نحقن فيها جميع البيانات السابقة؛ بما في ذلك قواعد بيانات المستخدمين والمجموعات والخدمات والمضيفات.
			</para>
			 <para>
				توفر الحزمة <emphasis role="pkg">migrationtools</emphasis> مجموعة من السكربتات المخصصة لاستخراج البيانات من أدلة يونكس التقليدية (<filename dir="ltr">/etc/passwd</filename>، ‏<filename dir="ltr">/etc/group</filename>، ‏<filename dir="ltr">/etc/services</filename>، ‏<filename dir="ltr">/etc/hosts</filename> وغيرها)، وتحويل هذه البيانات وحقنها في قاعدة بيانات LDAP.
			</para>
			 <indexterm>
				<primary><emphasis role="pkg">migrationtools</emphasis></primary>
			</indexterm>
			 <para>
				بعد تثبيت الحزمة، يجب تحرير <filename dir="ltr">/etc/migrationtools/migrate_common.ph</filename>، لتفعيل الخيارين <varname>IGNORE_UID_BELOW</varname> و<varname>IGNORE_GID_BELOW</varname> (يكفي إزالة التعليق عنهما)، كما يجب تحديث قيمة <varname>DEFAULT_MAIL_DOMAIN</varname>/<varname>DEFAULT_BASE</varname>.
			</para>
			 <para>
				يجري الأمر <command>migrate_all_online.sh</command> عملية الهجرة الفعلية، كما يلي:
			</para>
			 
<screen>
<computeroutput># </computeroutput><userinput>cd /usr/share/migrationtools</userinput>
<computeroutput># </computeroutput><userinput>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</userinput></screen>
			 <para>
				يطرح <command>migrate_all_online.sh</command> بضعة أسئلة عن قاعدة بيانات LDAP التي يجب تهجير البيانات إليها. يلخص <xref linkend="tab-migrate-all" xrefstyle="select: label nopage" /> الإجابات التي استخدمت في حالة فلكوت.
			</para>
			 <table colsep="1" id="tab-migrate-all">
				<title>إجابات الأسئلة التي يطرحها السكربت <command>migrate_all_online.sh</command></title>
				 <tgroup cols="2">
					<colspec align="justify"></colspec>
					<colspec align="justify"></colspec>
					 <thead>
						<row>
							<entry>السؤال</entry>
							<entry>الجواب</entry>
						</row>

					</thead>
					 <tbody>
						<row>
							<entry>X.500 naming context</entry>
							 <entry><literal>dc=falcot,dc=com</literal></entry>

						</row>
						 <row>
							<entry>LDAP server hostname</entry>
							 <entry><literal>localhost</literal></entry>

						</row>
						 <row>
							<entry>Manager DN</entry>
							 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

						</row>
						 <row>
							<entry>Bind credentials</entry>
							 <entry>كلمة سر الإدارة</entry>

						</row>
						 <row>
							<entry>Create DUAConfigProfile</entry>
							 <entry>لا</entry>

						</row>

					</tbody>

				</tgroup>

			</table>
			 <para>
				لقد تجاهلنا تهجير الملف <filename dir="ltr">/etc/aliases</filename> عمداً، لأن السكيما القياسية التي توفرها دبيان لا تتضمن البنى التي يستخدمها هذا السكربت لتوصيف الأسماء المتعددة لعناوين البريد الإلكتروني. إذا أردنا نقل هذه البيانات إلى المجلد، يجب إضافة الملف <filename dir="ltr">/etc/ldap/schema/misc.schema</filename> إلى السكيما القياسية.
			</para>
			 <sidebar> <title><emphasis>أدوات</emphasis> استعراض دليل LDAP</title>
			 <para>
				الأمر <command>jxplorer</command> (من الحزمة ذات الاسم نفسه) هو أداة رسومية تسمح باستعراض وتحرير قاعدة بيانات LDAP. هذه الأداة أداة مفيدة تعطي مدير النظام صورة أفضل عن البنية الهرمية لبيانات LDAP.
			</para>
			 <indexterm>
				<primary><command>jxplorer</command></primary>
			</indexterm>
			 </sidebar> <para>
				لاحظ أيضاً استخدام الخيار <literal dir="ltr">-c</literal> مع الأمر <command>ldapadd</command>؛ يطلب هذا الأمر عدم إيقاف المعالجة في حال حدوث خطأ. نحتاج استخدام هذا الخيار لأن تحويل <filename dir="ltr">/etc/services</filename> يولّد غالباً بضعة أخطاء يمكن تجاهلها بأمان.
			</para>

		</section>
		 <section>
			<title>إدارة الحسابات باستخدام LDAP</title>
			 <para>
				بعد أن حَوَت قاعدة بيانات LDAP الآن بعض المعلومات المفيدة. آن اوان استخدام هذه البيانات. يركز هذا القسم على طريقة إعداد نظام لينكس بحيث تَستخدِم أدلة النظام المتنوعة قاعدة بيانات LDAP بشكل شفاف.
			</para>
			 <section id="sect.config-nss">
				<title>إعداد NSS</title>
				 <para>
					نظام NSS ‏(Name Service Switch، انظر <xref linkend="sidebar.intro-nss" />) هو نظام تجزيئي مصمم لتعريف أو جلب معلومات أدلة النظام. لاستخدام LDAP كمصدر لبيانات NSS، يجب تثبيت الحزمة <emphasis role="pkg">libnss-ldap</emphasis>. تطرح عملية تثبيتها بضعة أسئلة؛ لقد لخصنا الإجابات في <xref linkend="tab-libnss-ldap" xrefstyle="select: label nopage" />.
				</para>
				 <indexterm>
					<primary><emphasis>libnss-ldap</emphasis></primary>
				</indexterm>
				 <table colsep="1" id="tab-libnss-ldap">
					<title>إعداد الحزمة <emphasis role="pkg">libnss-ldap</emphasis></title>
					 <tgroup cols="2">
						<colspec align="justify"></colspec>
						 <colspec align="justify"></colspec>
						 <thead>
							<row>
								<entry>السؤال</entry>
								 <entry>الجواب</entry>

							</row>

						</thead>
						 <tbody>
							<row>
								<entry>LDAP server Uniform Resource Identifier (عنوان URI لمخدم LDAP)</entry>
								 <entry><literal>ldap://ldap.falcot.com</literal></entry>

							</row>
							 <row>
								<entry>Distinguished name of the search base (الاسم المميِّز لقاعدة البحث)</entry>
								 <entry><literal>dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>LDAP version to use (نسخة LDAP المستخدمة)</entry>
								 <entry><literal>3</literal></entry>

							</row>
							 <row>
								<entry>Does the LDAP database require login?‎ (هل تحتاج قاعدة بيانات LDAP تسجيل الدخول؟)</entry>
								 <entry>لا</entry>

							</row>
							 <row>
								<entry>Special LDAP privileges for root (إعطاء صلاحيات LDAP خاصة للجذر)</entry>
								 <entry>نعم</entry>

							</row>
							 <row>
								<entry>Make the configuration file readable/writeable by its owner only (منح صلاحيات قراءة وتعديل ملف الضبط لمالكه فقط)</entry>
								 <entry>لا</entry>

							</row>
							 <row>
								<entry>LDAP account for root (حساب LDAP للجذر)</entry>
								 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>LDAP root account password (كلمة سر حساب جذر LDAP)</entry>
								 <entry>كلمة سر الإدارة</entry>

							</row>

						</tbody>

					</tgroup>

				</table>
				 <para>
					بعدها يجب تعديل الملف <filename dir="ltr">/etc/nsswitch.conf</filename>، بحيث يستخدم NSS وحدة <command>ldap</command> المُثبّتة حديثاً.
				</para>
				 <example>
					<title>الملف <filename dir="ltr">/etc/nsswitch.conf</filename></title>
					 
<programlisting>
# /etc/nsswitch.conf
#
# Example configuration of GNU Name Service Switch functionality.
# If you have the `glibc-doc' and `info' packages installed, try:
# `info libc "Name Service Switch"' for information about this file.

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files
</programlisting>

				</example>
				 <para>
					تضاف الوحدة <command>ldap</command> قبل الوحدات الأخرى عادة، وبالتالي تُرسَل الطلبات إليها أولاً. الاستثناء الواضح هو خدمة <literal>hosts</literal> لأن الاتصال بمخدم LDAP يحتاج استشارة DNS أولاً (لاستبيان <literal>ldap.falcot.com</literal>). إذا لم نضع هذا الاستثناء، ستحاول طلبات استبيان (resolve) أسماء المضيفات سؤال مخدم LDAP، وهذا سيحتاج لطلب استبيان اسم مخدم LDAP نفسه، وتدور الطلبات في حلقة لا نهائية.
				</para>
				 <para>
					إذا كنا سنعتبر مخدم LDAP المرجع الوحيد (ولن نأخذ الملفات المحلية التي تستخدمها الوحدة <command>files</command> بعين الاعتبار)، فيجب إعداد الخدمات باستخدام الصيغة التالية:
				</para>
				 <para>
					<literal><replaceable>service</replaceable>: ldap [NOTFOUND=return] files</literal>.
				</para>
				 <para>
					إذا اكنت المدخلة المطلوبة غير موجودة في قاعدة بيانات LDAP فسوف يعطي الاستعلام رد ”غير موجود“، حتى لو كان المورد المطلوب متوفراً في أحد الملفات المحلية؛ ولن تستخدم هذه الملفات المحلية إلا عندما تتوقف خدمة LDAP عن العمل.
				</para>

			</section>
			 <section id="sect.config-pam">
				<title>إعداد PAM</title>
				 <para>
					يشرح هذا القسم إعداد PAM (انظر <xref linkend="sidebar.intro-pam" />) بطريقة تسمح للتطبيقات بإجراء المصادقات المطلوية مع قاعدة بيانات LDAP.
				</para>
				 <sidebar> <title><emphasis>تحذير</emphasis> تعطل المصادقة</title>
				 <para>
					تعديل إعدادات PAM القياسية التي تستخدمها البرامج المختلفة عملية حساسة. قد تتعطل المصادقة بالخطأ، وهذا قد يمنع تسجيل الدخول. من الإجراءات الوقائية الجيدة ترك سطر أوامر بصلاحيات الجذر مفتوحاً. فإذا حدث خطأ في الإعدادات، يمكن إصلاحه وإعادة تشغيل الخدمات دون جهد يذكر.
				</para>
				 </sidebar> <para>
					تقدم الحزمة <emphasis role="pkg">libpam-ldap</emphasis> وحدة LDAP التي توفر PAM. تطرح عملية تثبيت هذه الحزمة بضعة أسئلة شبيهة جداً بتلك التي تطرحها <emphasis role="pkg">libnss-ldap</emphasis>؛ بل إن بعض متغيرات الضبط (مثل URI مخدم LDAP) مشتركة بين الحزمتين. لخصنا الإجابات في <xref linkend="tab-libpam-ldap" xrefstyle="select: label nopage" />.
				</para>
				 <indexterm>
					<primary><emphasis>libpam-ldap</emphasis></primary>
				</indexterm>
				 <table colsep="1" id="tab-libpam-ldap">
					<title>إعداد <emphasis>libpam-ldap</emphasis></title>
					 <tgroup cols="2">
						<colspec align="justify"></colspec>
						 <colspec align="justify"></colspec>
						 <thead>
							<row>
								<entry>السؤال</entry>
								 <entry>الجواب</entry>

							</row>

						</thead>
						 <tbody>
							<row>
								<entry>Allow LDAP admin account to behave like local root?‎ (السماح لحساب مدير LDAP بالعمل مثل الجذر المحلي؟)</entry>
								 <entry>نعم. هذا يسمح باستخدام الأمر المعتاد <command>passwd</command> لتغيير كلمات السر المخزّنة في قاعدة بيانات LDAP.</entry>

							</row>
							 <row>
								<entry>Does the LDAP database require logging in?‎ (هل تحتاج قاعدة بيانات LDAP لتسجيل الدخول؟)</entry>
								 <entry>لا</entry>

							</row>
							 <row>
								<entry>LDAP account for root (حساب LDAP للجذر)</entry>
								 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>LDAP root account password (كلمة سر حساب جذر LDAP)</entry>
								 <entry>كلمة سر إدارة قاعدة بيانات LDAP</entry>

							</row>
							 <row>
								<entry>Local encryption algorithm to use for passwords (خوارزمية تشفير كلمات السر المستخدمة محلياً)</entry>
								 <entry>crypt</entry>

							</row>

						</tbody>

					</tgroup>

				</table>
				 <para>
					عملية تثبيت <emphasis role="pkg">libpam-ldap</emphasis> تتبنى تلقائياً إعدادات PAM الافتراضية المعرّفة في الملفات <filename>/etc/pam.d/common-auth</filename> و<filename>/etc/pam.d/common-password</filename> و<filename>/etc/pam.d/common-account</filename>. تستخدم هذه الآلية الأداة المتخصصة <command>pam-auth-update</command> (التي توفرها الحزمة <emphasis role="pkg">libpam-runtime</emphasis>). كما يستطيع مدير النظام أيضاً تشغيل هذه الأداة إذا أراد تفعيل او تعطيل وحدات PAM.
				</para>
				 <indexterm>
					<primary><filename>common-auth</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-auth</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>common-password</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-password</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>common-account</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-account</filename></primary>
				</indexterm>

			</section>
			 <section>
				<title>تأمين تبادلات بيانات LDAP</title>
				 <indexterm>
					<primary>LDAP</primary>
					<secondary>secure</secondary>
				</indexterm>
				 <para>
					افتراضياً، ينقل LDAP البيانات عبر الشبكة بشكلها الصريح؛ وهذا يشمل كلمات السر (المشفرة). بما أنه يمكن استخلاص كلمات السر المشفرة من الشبكة، فقد تتعرض لهجمات القواميس (Dictionary attacks). يمكن تفادي هذا باستخدام طبقة تشفير إضافية، يتحدث هذا القسم عن تفعيل هذه الطبقة.
				</para>
				 <section>
					<title>إعداد المخدم</title>
					 <indexterm>
						<primary><foreignphrase>OpenSSL</foreignphrase></primary>
						<secondary>إنشاء المفاتيح</secondary>
					</indexterm>
					 <indexterm>
						<primary>زوج مفاتيح</primary>
					</indexterm>
					 <para>
						الخطوة الأولى هي إنشاء زوج من المفاتيح (يتألف من مفتاح عام ومفتاح خاص) لمخدم LDAP. عاد مديرو النظم في فلكوت لاستخدام <emphasis>easy-rsa</emphasis> لتوليده (انظر <xref linkend="sect.easy-rsa" />). عند تشغيل <command dir="ltr">./build-key-server ldap.falcot.com</command> سيطرح أسئلة سخيفة كثيرة (المكان، اسم المنظّمة، وماشابه). <emphasis>يجب</emphasis> الإجابة على السؤال عن ”Common Name“ بالاسم الكامل (fully-qualified) لمخدم LDAP؛ في حالتنا، <literal>ldap.falcot.com</literal>.
					</para>
					 <para>
						ينشئ هذا الأمر شهادة في الملف <filename>keys/ldap.falcot.com.crt</filename>، ويخزّن المفتاح الخاص الموافق لها في <filename>keys/ldap.falcot.com.key</filename>.
					</para>
					 <para>
						يجب الآن تثبيت هذه المفاتيح في موقعها القياسي، كما يجب أن نتأكد أن مخدم LDAP الذي يعمل بهوبة المستخدم <literal>openldap</literal> يملك صلاحية قراءة الملف الخاص:
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>adduser openldap ssl-cert
</userinput><computeroutput>Adding user `openldap' to group `ssl-cert' ...
Adding user openldap to group ssl-cert
Done.
# </computeroutput><userinput>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chmod 0640 /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem
</userinput></screen>
					 <para>
						كما يجب إعداد خدمة <command>slapd</command> أيضاً لاستخدام هذه المفاتيح للتشفير. إدارة إعدادات مخدم LDAP ديناميكية: بما أنها مخزنة في جزء خاص من الدليل نفسه، فيمكن تحديث الإعدادات باستخدام عمليات LDAP عادية تُجرَى على شجرة الكائنات <literal>cn=config</literal>، ويحدّث المخدم الملف <filename dir="ltr">/etc/ldap/slapd.d</filename> في الوقت الحقيقي حتى تصبح الإعدادات دائمة. الأداة <command>ldapmodify</command> هي الأداة الصحيحة لتحديث الإعدادات:
					</para>
					 <example>
						<title>إعداد <command>slapd</command> لاستخدام التشفير</title>
						 
<screen><computeroutput># </computeroutput><userinput>cat &gt;ssl.ldif &lt;&lt;END
dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key
-
END
</userinput><computeroutput># </computeroutput><userinput>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif
</userinput><computeroutput>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
</computeroutput></screen>

					</example>
					 <sidebar> <title><emphasis>أدوات</emphasis> تحرير مجلد LDAP باستخدام <command>ldapvi</command></title>
					 <indexterm>
						<primary><command>ldapvi</command></primary>
					</indexterm>
					 <para>
						يمكنك استخدام <command>ldapvi</command> لعرض مخرجات LDIF لأي جزء من دليل LDAP، ثم إجراء بعض التعديلات باستخدام محرر نصوص، وبعدها ترك الأداة تجري عمليات LDAP الموافقة بدلاً منك.
					</para>
					 <para>
						هذه الطريقة مريحة خصوصاً عند تحديث إعدادات مخدم LDAP، وذلك بتحرير الشجرة <literal>cn=config</literal> ببساطة.
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config
</userinput></screen>
					 </sidebar> <para>
						تشمل آخر خطوة في تفعيل التشفير تعديل المتغير <varname>SLAPD_SERVICES</varname> في الملف <filename dir="ltr">/etc/default/slapd</filename> . حتى نتفادى أي مخاطرات، سوف نعطّل LDAP غير المؤمن كله.
					</para>
					 <example>
						<title>الملف <filename dir="ltr">/etc/default/slapd</filename></title>
						 
<programlisting>
# Default location of the slapd.conf file or slapd.d cn=config directory. If
# empty, use the compiled-in default (/etc/ldap/slapd.d with a fallback to
# /etc/ldap/slapd.conf).
SLAPD_CONF=

# System account to run the slapd server under. If empty the server
# will run as root.
SLAPD_USER="openldap"

# System group to run the slapd server under. If empty the server will
# run in the primary group of its user.
SLAPD_GROUP="openldap"

# Path to the pid file of the slapd server. If not set the init.d script
# will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf by
# default)
SLAPD_PIDFILE=

# slapd normally serves ldap only on all TCP-ports 389. slapd can also
# service requests on TCP-port 636 (ldaps) and requests via unix
# sockets.
# Example usage:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# If SLAPD_NO_START is set, the init script will not start or restart
# slapd (but stop will still work).  Uncomment this if you are
# starting slapd via some other means or if you don't want slapd normally
# started at boot.
#SLAPD_NO_START=1

# If SLAPD_SENTINEL_FILE is set to path to a file and that file exists,
# the init script will not start or restart slapd (but stop will still
# work).  Use this for temporarily disabling startup of slapd (when doing
# maintenance, for example, or through a configuration management system)
# when you don't want to edit a configuration file.
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# For Kerberos authentication (via SASL), slapd by default uses the system
# keytab file (/etc/krb5.keytab).  To use a different keytab file,
# uncomment this line and change the path.
#export KRB5_KTNAME=/etc/krb5.keytab

# Additional options to pass to slapd
SLAPD_OPTIONS=""
</programlisting>

					</example>

				</section>
				 <section>
					<title>إعداد العميل</title>
					 <para>
						عند جهة العميل، يجب تعديل إعدادات الوحدتين <emphasis>libpam-ldap</emphasis> و<emphasis>libnss-ldap</emphasis> حتى تستخدما عناوين <literal dir="ltr">ldaps://</literal>.
					</para>
					 <para>
						كما يجب أن يتمكن العملاء أيضاً من المصادقة مع المخدم. في البنية التحتية لمفاتيح X.509 العامة، تُوقّع الشهادات العامة باستخدام مفتاح سلطة تصديق (certificate authority، أو CA). استخدام مديرو النظم في فلكوت <emphasis>easy-rsa</emphasis> لإنشاء سلطة تصديق خاصة بهم، وعليهم الآن إعداد النظام بحيث يثق بتواقيع سلطة التصديق هذه الخاصة بشركة فلكوت. يمكن إجراء هذا بإضافة الشهادة إلى <filename dir="ltr">/usr/local/share/ca-certificates</filename> واستدعاء <command>update-ca-certificates</command>.
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt
</userinput><computeroutput># </computeroutput><userinput>update-ca-certificates
</userinput><computeroutput>Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
Adding debian:falcot.pem
done.
done.
</computeroutput></screen>
					 <para>
						أخيراً وليس آخراً، يمكن تعديل عنوان URI الافتراضي وDN الأساسي التي تستخدمها العديد من أدوات سطر الأوامر افتراضياً في الملف <filename dir="ltr">/etc/ldap/ldap.conf</filename>. هذا سيوفر طباعة هذه المتغيرات كلما استدعينا أحد هذه الأوامر.
					</para>
					 <example>
						<title>الملف <filename dir="ltr">/etc/ldap/ldap.conf</filename></title>
						 
<programlisting>#
# LDAP Defaults
#

# See ldap.conf(5) for details
# This file should be world readable but not world writable.

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# TLS certificates (needed for GnuTLS)
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt
</programlisting>

					</example>

				</section>

			</section>

		</section>

	</section>
	 <section id="sect.rtc-services">
		<title>خدمات التواصل في الزمن الحقيقي</title>
		 <para>
			تشمل خدمات التواصل في الزمن الحقيقي (Real-Time Communication أو RTC اختصاراً) خدمات نقل الصوت، والفيديو أو كميرات الوب، والتواصل المباشر (instant messaging ‏— IM) ومشاركة سطح المكتب. يقدم هذا الفصل مدخلاً مختصراً إلى ثلاثة خدمات مطلوبة لتشغيل RTC، يشمل إعداد مخدم TURN، ومخدم SIP ومخدم XMPP. هناك تفاصيل موسعة عن كيفية التخطيط لهذه الخدمات وتثبيتها وإدارتها في دليل البدء السريع مع اتصالات الزمن الحقيقي (Real-Time Communications Quick Start Guide) الذي يحوي أمثلة خاصة بدبيان. <ulink type="block" url="http://rtcquickstart.org" />
		</para>
		 <indexterm>
			<primary>VoIP</primary>
			<secondary>مخدم</secondary>
		</indexterm>
		 <indexterm>
			<primary>RTC</primary>
			<secondary>مخدم</secondary>
		</indexterm>
		 <indexterm>
			<primary>مراسلة فورية</primary>
			<secondary>مخدم</secondary>
		</indexterm>
		 <indexterm>
			<primary>دردشة</primary>
			<secondary>مخدم</secondary>
		</indexterm>
		 <para>
			يوفر كلاً من SIP وXMPP نفس الوظائف. لكن SIP معروف أكثر في مجال الصوت والفيديو بينما يعتبر XMPP تقليدياً بروتوكولاً للمراسلة الفورية (IM). في الواقع، يمكن استخدام أي منهما لأي من هذه الأغراض. من المستحسن استخدام الاثنين معاً على التوازي لزيادة خيارات الاتصال.
		</para>
		 <indexterm>
			<primary>SIP</primary>
		</indexterm>
		 <indexterm>
			<primary>XMPP</primary>
		</indexterm>
		 <para>
			تعتمد هذه الخدمات على شهادات X.509 لأغراض المصادقة والتوثق. انظر <xref linkend="sect.easy-rsa" /> للاطلاع على تفاصيل إنشاء هذه الشهادات. أو يمكنك الاطلاع على <emphasis>Real-Time Communications Quick Start Guide</emphasis> الذي يحوي بعض الشروحات المفيدة: <ulink type="block" url="http://rtcquickstart.org/guide/multi/tls.html" />
		</para>
		 <section id="sect.rtc-dns-settings">
			<title>إعدادات DNS لخدمات RTC</title>
			 <para>
				تحتاج خدمات RTC لسجلات DNS SRV وNAPTR. هذا مثال عن إعداد يمكن وضعه في ملف المنطقة الخاص بنطاق <literal>falcot.com</literal>:
			</para>
			 <indexterm>
				<primary>DNS</primary>
				<secondary>سجل SRV</secondary>
			</indexterm>
			 <indexterm>
				<primary>DNS</primary>
				<secondary>سجل NAPTR</secondary>
			</indexterm>
			 
<programlisting>
; the server where everything will run
server1            IN     A      198.51.100.19
server1            IN     AAAA   2001:DB8:1000:2000::19

; IPv4 only for TURN for now, some clients are buggy with IPv6
turn-server        IN     A      198.51.100.19

; IPv4 and IPv6 addresses for SIP
sip-proxy          IN     A      198.51.100.19
sip-proxy          IN     AAAA   2001:DB8:1000:2000::19

; IPv4 and IPv6 addresses for XMPP
xmpp-gw            IN     A      198.51.100.19
xmpp-gw            IN     AAAA   2001:DB8:1000:2000::19

; DNS SRV and NAPTR for STUN / TURN
_stun._udp  IN SRV    0 1 3467 turn-server.falcot.com.
_turn._udp  IN SRV    0 1 3467 turn-server.falcot.com.
@           IN NAPTR  10 0 "s" "RELAY:turn.udp" "" _turn._udp.falcot.com.

; DNS SRV and NAPTR records for SIP
_sips._tcp  IN SRV    0 1 5061 sip-proxy.falcot.com.
@           IN NAPTR  10 0 "s" "SIPS+D2T" "" _sips._tcp.falcot.com.

; DNS SRV records for XMPP Server and Client modes:
_xmpp-client._tcp  IN     SRV    5 0 5222 xmpp-gw.falcot.com.
_xmpp-server._tcp  IN     SRV    5 0 5269 xmpp-gw.falcot.com.</programlisting>

		</section>
		 <section id="sect.turn-server">
			<title>مخدم TURN</title>
			 <para>
				TURN هي خدمة تساعد العملاء الذين تفصل بينهم موجهات NAT والجدران النارية على اكتشاف الطريق الأكثر فعالية للتواصل فيما بينهم ونقل تيار البيانات (stream) إذا لم يعثروا على طريق مباشر لنقل الوسائط. ينصح بشدة بتثبيت مخدم TURN قبل إتاحة أي خدمة RTC أخرى للمستخدمين النهائيين.
			</para>
			 <indexterm>
				<primary>TURN</primary>
				<secondary>مخدم</secondary>
			</indexterm>
			 <para>
				TURN وبروتوكول ICE المرتبط بها هما معياران مفتوحان. من المهم أن تضمن أن كافة برمجيات العملاء تدعم ICE وTURN للاستفادة من هذين المعيارين وتحقيق أعظم قدر من الاتصالية وتقليل خيبات المستخدمين إلى أدنى حد.
			</para>
			 <indexterm>
				<primary>ICE</primary>
			</indexterm>
			 <para>
				يجب أن يملك المخدم عنواني IPv4 عموميين حتى تعمل خوارزمية ICE بفعالية.
			</para>
			 <section id="sect.turn-server-install">
				<title>تثبيت مخدم TURN</title>
				 <para>
					ثبت الحزمة <emphasis role="pkg">resiprocate-turn-server</emphasis>.
				</para>
				 <para>
					حرر ملف الإعداد <filename dir="ltr">/etc/reTurn/reTurnServer.config</filename>. أهم شيء هو إضافة عناوين IP الخاصة بالمخدم.
				</para>
				 
<programlisting>
# your IP addresses go here:
TurnAddress = 198.51.100.19
TurnV6Address = 2001:DB8:1000:2000::19
AltStunAddress = 198.51.100.20
# your domain goes here, it must match the value used
# to hash your passwords if they are already hashed
# using the HA1 algorithm:
AuthenticationRealm = myrealm

UserDatabaseFile = /etc/reTurn/users.txt
UserDatabaseHashedPasswords = true</programlisting>
				 <para>
					إعادة تشغيل الخدمة
				</para>

			</section>
			 <section id="sect.turn-server-management">
				<title>إدارة مستخدمي TURN</title>
				 <para>
					استخدام الأداة htdigest لإدارة قائمة مستخدمي مخدم TURN.
				</para>
				
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/reTurn/users.txt myrealm joe</userinput></screen>
				 <para>
					استخدم إشارة HUP لجعل المخدم يعيد تحميل الملف <filename dir="ltr">/etc/reTurn/users.txt</filename> بعد تعديله أو فعّل ميزة إعادة التحميل الآلي في <filename dir="ltr">/etc/reTurn/reTurnServer.config</filename>.
				</para>

			</section>

		</section>
		 <section id="sect.sip-server">
			<title>مخدم بروكسي SIP</title>
			 <para>
				يدير مخدم بروكسي SIP اتصالات SIP الواردة والصادرة بين المنظمات الأخرى، أو مزودي SIP trunking، أو مقاسم SIP الهاتفية الخاصة (Private Automatic Branch eXchange أو PBX اختصاراً) مثل Asterisk، أو هواتف SIP، أو تطبيقات المهاتفة وWebRTC المعتمدة على SIP.
			</para>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>مخدم</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>بروكسي</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>PBX</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>trunk</secondary>
			</indexterm>
			 <para>
				ننصح بشدة أن تثبت بروكسي SIP وتضبطه قبل محاولة تثبيت SIP PBX (المقسم الهاتفي الخاص). ينظم بروكسي SIP جزءاً كبيراً من البيانات الواردة إلى PBX ويسمح بدرجات أعلى من القدرة على الاتصال والمتانة.
			</para>
			 <section id="sect.sip-server-install">
				<title>تثبيت بروكسي SIP</title>
				 <para>
					ثبّت الحزمة <emphasis role="pkg">repro</emphasis>. ننصح بشدة باستخدام الحزمة من <emphasis role="distribution">jessie-backports</emphasis>، لأنها تحوي آخر التحسينات لزيادة القدرة على الاتصال والمتانة.
				</para>
				 <indexterm>
					<primary>repro</primary>
				</indexterm>
				 <para>
					حرر ملف الإعداد <filename dir="ltr">/etc/repro/repro.config</filename>. أهم شيء تفعله هو إدخال عناوين IP المخدم. يوضح المثال أدناه طريقة إعداد SIP عادي وأيضاً WebSockets/WebRTC، باستخدام TLS، وIPv4 وIPv6:
				</para>
				 
<programlisting>
# Transport1 will be for SIP over TLS connections
# We use port 5061 here but if you have clients connecting from
# locations with firewalls you could change this to listen on port 443
Transport1Interface = 198.51.100.19:5061
Transport1Type = TLS
Transport1TlsDomain = falcot.com
Transport1TlsClientVerification = Optional
Transport1RecordRouteUri = sip:falcot.com;transport=TLS
Transport1TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport1TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport2 is the IPv6 version of Transport1
Transport2Interface = 2001:DB8:1000:2000::19:5061
Transport2Type = TLS
Transport2TlsDomain = falcot.com
Transport2TlsClientVerification = Optional
Transport2RecordRouteUri = sip:falcot.com;transport=TLS
Transport2TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport2TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport3 will be for SIP over WebSocket (WebRTC) connections
# We use port 8443 here but you could use 443 instead
Transport3Interface = 198.51.100.19:8443
Transport3Type = WSS
Transport3TlsDomain = falcot.com
# This would require the browser to send a certificate, but browsers
# don't currently appear to be able to, so leave it as None:
Transport3TlsClientVerification = None
Transport3RecordRouteUri = sip:falcot.com;transport=WSS
Transport3TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport3TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport4 is the IPv6 version of Transport3
Transport4Interface = 2001:DB8:1000:2000::19:8443
Transport4Type = WSS
Transport4TlsDomain = falcot.com
Transport4TlsClientVerification = None
Transport4RecordRouteUri = sip:falcot.com;transport=WSS
Transport4TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport4TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport5: this could be for TCP connections to an Asterisk server
# in your internal network.  Don't allow port 5060 through the external
# firewall.
Transport5Interface = 198.51.100.19:5060
Transport5Type = TCP
Transport5RecordRouteUri = sip:198.51.100.19:5060;transport=TCP

HttpBindAddress = 198.51.100.19, 2001:DB8:1000:2000::19
HttpAdminUserFile = /etc/repro/users.txt

RecordRouteUri = sip:falcot.com;transport=tls
ForceRecordRouting = true
EnumSuffixes = e164.arpa, sip5060.net, e164.org
DisableOutbound = false
EnableFlowTokens = true
EnableCertificateAuthenticator = True</programlisting>
				 <para>
					استخدم أداة <command>htdigest</command> لإدارة كلمة سر المدير لواجهة الوب. يجب أن يكون اسم المستخدم <emphasis>admin</emphasis> كما يجب أن يطابق اسم realm القيمة المحددة في الملف <filename>repro.config</filename>.
				</para>
				 
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/repro/users.txt repro admin</userinput></screen>
				 <para>
					إعادة تشغيل الخدمة لاعتماد الإعدادات الجديدة.
				</para>

			</section>
			 <section id="sect.sip-server-management">
				<title>إدارة بروكسي SIP</title>
				 <para>
					انتقل إلى واجهة الوب على <literal>http://sip-proxy.falcot.com:5080</literal> لإكمال الإعداد بإضافة النطاقات، والمستخدمين المحليين، والمسارات الستاتيكية (static routes).
				</para>
				 <para>
					الخطوة الأولى هي إضافة النطاق المحلي. يجب إعادة تشغيل العملية بعد إضافة أو حذف النطاقات من القائمة.
				</para>
				 <para>
					يعرف البروكسي كيفية توجيه الاتصالات بين المستخدمين المحليين وعناوين SIP الكاملة، لن تحتاج إلى ضبط التوجيه إلا إذا أردت تغيير السلوك الافتراضي، مثلاً، للتعرف على أرقام الهواتف، وإضافة سابقة لها وتوجيهها إلى مزود SIP.
				</para>

			</section>

		</section>
		 <section id="sect.xmpp-server">
			<title>مخدم XMPP</title>
			 <para>
				يدير مخدم XMPP الاتصالات بين مستخدمي XMPP المحليين ومستخدمي XMPP في النطاقات الأخرى على الإنترنت العام.
			</para>
			 <indexterm>
				<primary>XMPP</primary>
				<secondary>مخدم</secondary>
			</indexterm>
			 <sidebar> <title><emphasis>مصطلحات</emphasis> XMPP أو Jabber؟</title>
			 <indexterm>
				<primary>Jabber</primary>
			</indexterm>
			 <para>
				يشار إلى XMPP أحياناً باسم Jabber. في الواقع، Jabber هي علامة تجارية وXMPP هو الاسم الرسمي للمعيار القياسي.
			</para>
			 <indexterm>
				<primary>Jabber</primary>
			</indexterm>
			 </sidebar> <para>
				Prosody هو مخدم XMPP شهير يعمل بشكل موثوق على مخدمات دبيان.
			</para>
			 <indexterm>
				<primary>Prosody</primary>
			</indexterm>
			 <section id="sect.xmpp-server-install">
				<title>تثبيت مخدم XMPP</title>
				 <para>
					ثبّت الحزمة <emphasis role="pkg">prosody</emphasis>. ننصح بشدة باستخدام الحزمة من <emphasis role="distribution">jessie-backports</emphasis>، لأنها تحوي آخر التحسينات لزيادة القدرة على الاتصال والمتانة.
				</para>
				 <indexterm>
					<primary>Prosody</primary>
				</indexterm>
				 <para>
					راجع ملف الإعداد <filename dir="ltr">/etc/prosody/prosody.cfg.lua</filename>. أهم شيء تفعله هو إدخال JIDs للمستخدمين الذين يُسمَح لهم بإدارة المخدم.
				</para>
				 
<programlisting>
admins = { "joe@falcot.com" }</programlisting>
				 <para>
					ستحتاج لملف إعداد منفصل لكل نطاق أيضاً. انسخ المثال من <filename dir="ltr">/etc/prosody/conf.avail/example.com.cfg.lua</filename> واستخدمه كنقطة بدء. هذا ملف <literal>falcot.com.cfg.lua</literal>:
				</para>
				 
<programlisting>
VirtualHost "falcot.com"
        enabled = true
        ssl = {
                key = "/etc/ssl/private/falcot.com-key.pem";
                certificate = "/etc/ssl/public/falcot.com.pem";
                }</programlisting>
				 <para>
					لتفعيل النطاق، يجب إنشاء رابط رمزي له من المجلد <filename>/etc/prosody/conf.d/</filename>. أنشئه كما يلي:
				</para>
				 
<screen><computeroutput># </computeroutput><userinput>ln -s /etc/prosody/conf.avail/falcot.com.cfg.lua /etc/prosody/conf.d/</userinput></screen>
				 <para>
					إعادة تشغيل الخدمة لاعتماد الإعدادات الجديدة.
				</para>

			</section>
			 <section id="sect.xmpp-server-management">
				<title>إدارة مخدم XMPP</title>
				 <para>
					يمكن إجراء بعض عمليات الإدارة باستخدام الأداة النصية <literal>prosodyctl</literal>. مثلاً، لإضافة حساب المدير المعرف في <filename dir="ltr">/etc/prosody/prosody.cfg.lua</filename>:
				</para>
				
<programlisting>
# prosodyctl adduser joe@falcot.com</programlisting>
				 <para>
					انظر <ulink url="http://prosody.im/doc/configure">وثائق Prosody على الإنترنت</ulink> لمزيد من التفاصيل عن تخصيص الإعدادات.
				</para>

			</section>

		</section>
		 <section id="sect.rtc-port-443">
			<title>تشغيل الخدمات على المنفذ 443</title>
			 <para>
				بفضل بعض مديرو النظم تشغيل كافة خدمات RTC على المنفذ 443. يساعد هذا المستخدمين على الاتصال من المواقع البعيدة مثل الفنادق والمطارات لأن المنافذ الأخرى قد تحجب أو قد تستخدم مخدمات HTTP وسيطة لتمرير الاتصال بالإنترنت.
			</para>
			 <para>
				لاستخدام هذه الاستراتيجية، ستحتاج كل خدمة (SIP، وXMPP وTURN) لعنوان IP مختلف. يمكن أن تبقى الخدمات كلها على المضيف نفسه حيث يدعم لينكس تعدد عناوين IP للمضيف الواحد. يجب تحديد رقم المنفذ 443 في ملفات الإعداد لكل عملية وأيضاً في سجلات DNS SRV.
			</para>

		</section>
		 <section id="sect.rtc-webrtc">
			<title>إضافة WebRTC</title>
			 <para>
				تريد فلكوت السماح للزبائن بالاتصال هاتفياً مباشرة من موقع الوب. كما يريد مديرو النظم في فلكوت أيضاً استخدام WebRTC كجزء من خطتهم للإنقاذ من الكوارث، بحيث يستطيع الموظفون استخدام متصفحات الوب من بيوتهم للدخول إلى نظام الشركة الهاتفي والعمل بشكل طبيعي في حالات الطوارئ.
			</para>
			 <indexterm>
				<primary>WebRTC</primary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>WebSockets</secondary>
			</indexterm>
			 <sidebar> <title><emphasis>ممارسة عملية</emphasis> تجربة WebRTC</title>
			 <indexterm>
				<primary>WebRTC</primary>
				<secondary>demonstration</secondary>
			</indexterm>
			 <para>
				إذا لم تجرب استخدام WebRTC من قبل، فهناك مواقع متنوعة توفر إمكانيات التجربة والاختبار عبر الإنترنت. <ulink type="block" url="http://www.sip5060.net/test-calls" />
			</para>
			 </sidebar> <para>
				WebRTC تقنية تتطور بسرعة ومن المهم استخدام الحزم من <emphasis role="distribution">jessie-backports</emphasis> أو التوزيعة <emphasis role="distribution">الاختبارية</emphasis>.
			</para>
			 <para>
				JSCommunicator هو هاتف WebRTC عام، وليس له علامة تجارية، ولا يحتاج لسكربتات على طرف المخدم مثل PHP. مبني بالكامل باستخدام HTML، وCSS، وJavaScript. وهو الأساس في خدمات WebRTC عديدة أخرى بالإضافة إلى وحدات لأطر النشر على الوب الأكثر تقدماً. <ulink type="block" url="http://jscommunicator.org" />
			</para>
			 <indexterm>
				<primary>JSCommunicator</primary>
			</indexterm>
			 <para>
				أسرع طريقة لتثبيت هاتف WebRTC على موقع وب هي عن طريق الحزمة <emphasis role="pkg">jscommunicator-web-phone</emphasis>. تحتاج الخدمة لبروكسي SIP مع نقل WebSocket. تتضمن التعليمات في <xref linkend="sect.sip-server-install" /> التفاصيل اللازمة لتفعيل نقل WebSocket في <emphasis role="pkg">repro</emphasis>.
			</para>
			 <para>
				بعد تثبيت <emphasis role="pkg">jscommunicator-web-phone</emphasis>، هناك طرق متنوعة لاستخدامه. من الطرق البسيطة تضمين أو نسخ الإعدادات من <filename dir="ltr">/etc/jscommunicator-web-phone/apache.conf</filename> إلى إعدادات أحد المضيفات الوهمية في أباتشي.
			</para>
			 <para>
				بعد توفير ملفات هاتف الوب على مخدم الوب، عليك تخصيص <filename dir="ltr">/etc/jscommunicator-web-phone/config.js</filename> ليشير إلى مخدم TURN وبروكسي SIP. مثلاً:
			</para>
			 
<programlisting>
JSCommSettings = {

  // Web server environment
  webserver: {
    url_prefix: null            // If set, prefix used to construct sound/ URLs
  },

  // STUN/TURN media relays
  stun_servers: [],
  turn_servers: [
    { server:"turn:turn-server.falcot.com?transport=udp", username:"joe", password:"j0Ep455d" }
  ],

  // WebSocket connection
  websocket: {
      // Notice we use the falcot.com domain certificate and port 8443
      // This matches the Transport3 and Transport4 example in
      // the falcot.com repro.config file
    servers: 'wss://falcot.com:8443',
    connection_recovery_min_interval: 2,
    connection_recovery_max_interval: 30
  },

  ...</programlisting>
			 <para>
				أما مواقع انقر واتصل المتطورة أكثر فهي تستخدم عادة سكربتات على طرف المخدم لتوليد الملف <literal>config.js</literal> ديناميكياً. الشفرة المصدرية في <ulink url="http://drucall.org">DruCall</ulink> توضح طريقة عمل هذا بلغة PHP.
			</para>
			 <indexterm>
				<primary>DruCall</primary>
			</indexterm>
			 <para>
				استعرض هذا الفصل جزءاً من برمجيات المخدمات المتاحة فقط؛ لكنه شرح معظم الخدمات الشبكية الشائعة. حان الوقت الآن للدخول في فصل تقني أكثر: سوف نتعمق في تفاصيل بعض المفاهيم، ونشرح عمليات التنصيب على نطاق واسع، والحوسبة الظاهرية.
			</para>

		</section>

	</section>
</chapter>

