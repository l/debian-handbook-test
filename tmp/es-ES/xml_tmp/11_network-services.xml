<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="network-services">
  <chapterinfo>
    <mediaobject condition="pdf">
      <imageobject>
        <imagedata fileref="images/chap-network-services.png" scalefit="1" />
      </imageobject>
    </mediaobject>
    <keywordset>
      <keyword>Postfix</keyword>
      <keyword>Apache</keyword>
      <keyword>NFS</keyword>
      <keyword>Samba</keyword>
      <keyword>Squid</keyword>
      <keyword>OpenLDAP</keyword>
      <keyword>SIP</keyword>
    </keywordset>
  </chapterinfo>
  <title>Servicios de red: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</title>
  <highlights>
    <para>Los servicios de red son los programas con los que los usuarios interactúan en su trabajo diario. Son la punta del iceberg del sistema de información y este capítulo se centra en ellos; las partes ocultas en las que se basan son la infraestructura que ya hemos descripto anteriormente.</para>

    
    <para>Muchos servicios de red modernos requieren tecnología de cifrado para operar de forma confiable y segura, especialmente cuando son usados de forma pública en internet. Los certificados X.509 (a los cuales se conoce tambien como Certificados SSL o Certificados TLS) se usan comúnmente para esta finalidad. Un certificado para un dominio concreto se comparte entre más de un servicio de los que discutiremos a lo largo de este capítulo.</para>
    <indexterm><primary>TLS</primary></indexterm>
    <indexterm><primary>X.509</primary></indexterm>
    <indexterm><primary>Certificados</primary></indexterm>
  </highlights>
  <section id="sect.smtp-mail-server">
    <title>Servidor de correo</title>

    <para>Los administradores de Falcot Corp eligieron Postfix como servidor de correo electrónico debido a su fiabilidad y su facilidad de configuración. De hecho, su diseño fuerza a que cada tarea sea implementada en un proceso con el mínimo conjunto de permisos, lo que es una gran medida paliativa contra problemas de seguridad.</para>
    <indexterm><primary>correo</primary><secondary>servidor de</secondary></indexterm>
    <indexterm><primary>servidor de correo</primary></indexterm>
    <indexterm><primary>Postfix</primary></indexterm>

    <sidebar>
      <title><emphasis>ALTERNATIVA</emphasis> El servidor Exim4</title>
      <indexterm><primary>Exim</primary></indexterm>

      <para>Debian utiliza Exim4 como servidor de correo predeterminado (razón por la que la instalación inicial incluye Exim4). Un paquete diferente provee su configuración, <emphasis role="pkg">exim4-config</emphasis>, la cual es personalizada automáticamente basándose en las respuestas a un conjunto de preguntas Debconf muy similares a las que pregunta el paquete <emphasis role="pkg">postfix</emphasis>.</para>

      <para>La configuración puede estar en un único archivo (<filename>/etc/exim4/exim4.conf.template</filename>) o dividida en diferentes trozos que se almacenan en el directorio <filename>/etc/exim4/conf.d/</filename>. En ambos casos, <command>update-exim4.conf</command> utiliza los archivos como plantillas para generar <filename>/var/lib/exim4/config.autogenerated</filename> . Exim4 utiliza este último archivo. Gracias a este mecanismo, se pueden introducir los valores definidos durante la configuración debconf de Exim — almacenados en <filename>/etc/exim4/update-exim4.conf.conf</filename> — en el archivo de configuración de Exim aún cuando el administrador y otro paquete haya modificado la configuración predeterminada de Exim.</para>

      <para>La sintaxis de los archivos de configuración de Exim4 tiene sus peculiaridades y curva de aprendizaje. Sin embargo, una vez que se entienden estas peculiaridades, Exim4 resulta ser un servidor de correo muy completo y potente, como se puede apreciar en las decenas de páginas de documentación. <ulink type="block" url="http://www.exim.org/docs.html" /></para>
    </sidebar>

    
    <section>
      <title>Instalación de Postfix</title>

      <para>El paquete <emphasis role="pkg">postfix</emphasis> incluye el demonio SMTP principal. Otros paquetes (como <emphasis role="pkg">postfix-ldap</emphasis> y <emphasis role="pkg">postfix-pgsql</emphasis>) añaden funcionalidad adicional, incluyendo el acceso a bases de datos. Sólo debe instalarlos si sabe que los necesitará.</para>

      <sidebar id="sidebar.smtp">
        <title><emphasis>VOLVER A LOS CIMIENTOS</emphasis> SMTP</title>
        <indexterm><primary>SMTP</primary></indexterm>
        <indexterm><primary>Simple Mail Transfer Protocol</primary></indexterm>
        <indexterm><primary>servidor</primary><secondary>SMTP</secondary></indexterm>

	<para>SMTP (protoclo sencillo de transferencia de correo: «<emphasis>Simple Mail Transfer Protocol</emphasis>») es el protocolo que utilizan los servidores de correo para intercambiar y enrutar los correos electrónicos.</para>
      </sidebar>

      <para>Durante la instalación del paquete se realizan varias preguntas Debconf. Las respuestas permiten crear una primera versión del archivo de configuración <filename>/etc/postfix/main.cf</filename>.</para>

      <para>La primera pregunta es sobre el tipo de instalación. Sólamente dos de las respuestas propuestas son relevantes en caso de tener un servidor conectado a Internet: «Sitio de Internet» e «Internet con smarthost». La primera es apropiada para un servidor que recibe correo entrante y envía el correo saliente directamente a los destinatarios, y por lo tanto se adapta al caso del Falcot Corp. La segunda es apropiada para un servidor que recibe correo de forma normal pero que envía el correo saliente a través de otro servidor SMTP intermedio — el «smarthost» — en lugar de enviarlo directamente al servidor de los destinatarios. Esto es especialmente útil para individuos con una dirección IP dinámica puesto que muchos servidores de correo rechazan los mensajes que vienen desde este tipo de dirección. En este caso, el smarthost es normalmente el servidor SMTP del ISP que siempre suele estar configurado para aceptar los correos provenientes de sus clientes y reenviarlos correctamente. Este tipo de instalación (con un smarthost) también es útil para servidores que no estén conectados permanentemente a Internet puesto que impide tener que gestionar una cola de mensajes no entregables que tienen que volver a ser enviados más tarde.</para>

      <sidebar>
        <title><emphasis>VOCABULARIO</emphasis> ISP</title>
        <indexterm><primary>ISP, proveedor de servicios de Internet</primary></indexterm>

	<para>ISP es la sigla de «Proveedor de servicios de Internet» («Internet Service Provider»). Se trata de una entidad, a menudo una empresa comercial, que proporciona conexiones de Internet y los servicios básicos asociados (correo electrónico, noticias, etc.).</para>

        <para></para>
      </sidebar>

      <para>La segunda pregunta es sobre el nombre completo de la máquina y se utiliza para generar las direcciones de correo a partir de los nombres de usuario locales; el nombre completo de la máquina se convierte en la parte de la dirección que sigue a la arroba («@»). En el caso de Falcot, la respuesta debería ser <literal>mail.falcot.com</literal>. Esta es la única pregunta que se hace de forma predeterminada, pero la configuración que genera no es lo suficientemente completa para las necesidades de Falcot, por lo que los administradores deben ejecutar <command>dpkg-reconfigure</command> para poder personalizar más parámetros.</para>

      <para>Una de las preguntas adicionales pide los nombres de los dominios relacionados con la máquina. La lista inicial incluye su nombre completo así como también algunos sinónimos de <literal>localhost</literal>, pero el dominio principal <literal>falcot.com</literal> tiene que ser agregado de forma manual. En general se deberían añadir todos los dominios para los que esta máquina debe ejercer como servidor MX; en otras palabras, todos los dominios para los cuales el DNS anuncie que esta máquina aceptará correo. Esta información acaba siendo escrita en la variable <literal>mydestination</literal> del archivo de configuración principal de Postfix — <filename>/etc/postfix/main.cf</filename>.</para>
      <indexterm><primary>servidor</primary><secondary>MX</secondary></indexterm>
      <indexterm><primary>MX</primary><secondary>servidor</secondary></indexterm>

      <figure>
        <title>Rol del registro DNS <emphasis>MX</emphasis> al enviar un correo</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/mail-server.png" scalefit="1" width="60%" />
          </imageobject>
        </mediaobject>
      </figure>

      <sidebar>
        <title><emphasis>EXTRA</emphasis> Consulta de los registros MX</title>

	<para>Cuando no existe un registro MX para un dominio en DNS, el servidor de correo intentará enviar el mensaje a la dirección del equipo directamente, utilizando para ello el registro A (o AAAA en IPv6).</para>
      </sidebar>

      <para>En algunos casos, la instalación también puede preguntar desde qué redes se permitirá enviar correo a través de la máquina. En la configuración predeterminada, Postfix únicamente acepta correos que provengan desde la propia máquina; normalmente agregará la red local. Los administradores de Falcot Corp añadieron la red <literal>192.168.0.0/16</literal> al valor predeterminado. Si no se realiza esta pregunta durante la instalación, la variable de configuración correspondiente es <literal>mynetworks</literal>, tal y como puede verse en el ejemplo siguiente.</para>

      <para>El correo local también puede ser entregado mediante <command>procmail</command>. Esta herramienta permite a los usuarios clasificar su correo en función de reglas contenidas en su archivo <filename>~/.procmailrc</filename>.</para>
      <indexterm><primary><command>procmail</command></primary></indexterm>
      <indexterm><primary>correo</primary><secondary>filtro</secondary></indexterm>
      <indexterm><primary>filtro de correo</primary></indexterm>

      <para>Después de este paso, los administradores obtuvieron el siguiente archivo de configuración; será usado en las siguientes secciones como punto de partida para agregar alguna funcionalidad adicional.</para>

      <example>
        <title>Archivo <filename>/etc/postfix/main.cf</filename> inicial</title>

        <programlisting>
# Revise /usr/share/postfix/main.cf.dist para una versión completa
# y con comentarios

# Específico a Debian: determine el nombre del archivo cuya
# primera línea será utilizada como nombre. El valor predeterminado
# en Debian es /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# agragar .dominio es trabajo del MUA.
append_dot_mydomain = no

# Descomente la siguiente línea para generar advertencias sobre
# «correo demorado»
#delay_warning_time = 4h

readme_directory = no

# Parámetros TLS
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# Revise /usr/share/doc/postfix/TLS_README.gz en el paquete postfix-doc
# para más información sobre cómo habilitar SSL en el cliente smtp.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</programlisting>
      </example>
      <sidebar>
        <title><emphasis>SEGURIDAD</emphasis> Certificados SSL de <emphasis>Snake oil</emphasis></title>

	<para>Los certificados <emphasis>snake oil</emphasis>, al igual que los medicamentos vendidos por charlatanes sin escrúpulos en los viejos tiempos (promocionados como <emphasis>aceite de serpiente</emphasis>, de ahí su nombre), no tienen absolutamente ningún valor: no puede confiar en ellos para autenticación del servidor  puesto que son certificados autofirmados generados automáticamente. No obstante son útiles para mejorar la privacidad de los intercambios.</para>
        <para>Por lo general deben utilizarse exclusivamente para pruebas y el servicio normal debe utilizar certificados reales; puede generarlos utilizado el procedimiento descripto en la <xref linkend="sect.easy-rsa" />.</para>
      </sidebar>
    </section>
    <section id="sect.configuring-virtual-domains">
      <title>Configuración de dominios virtuales</title>
      <indexterm><primary>dominio</primary><secondary>virtual</secondary></indexterm>
      <indexterm><primary>virtual, dominio</primary></indexterm>

      <para>El servidor de correo puede recibir correos dirigidos a otros dominios distintos del dominio principal; estos dominios se conocen como «dominios virtuales». En la mayoría de los casos en los que es así, los correos no se dirigen en última instancia a los usuarios locales. Postfix proporciona dos características interesantes para gestionar dominios virtuales.</para>

      <sidebar>
        <title><emphasis>ATENCIÓN</emphasis> Dominios virtuales y dominios canónicos</title>

	<para>No se debe hacer referencia a ninguno de los dominios virtuales en la variable <literal>mydestination</literal>; esta variable únicamente contiene los nombres de los dominios «canónicos» asociados directamente con la máquina y sus usuarios locales.</para>
      </sidebar>
      <section>
        <title>Alias de dominio virtual</title>
        <indexterm><primary>alias</primary><secondary>de dominios virtuales</secondary></indexterm>
        <indexterm><primary>dominio virtual</primary><secondary>alias de</secondary></indexterm>

	<para>Un «alias de dominio virtual» («virtual alias domain») únicamente contiene alias, es decir direcciones que únicamente reenvían los correos hacia otras direcciones.</para>

	<para>Para habilitar un dominio de este tipo, agregue su nombre a la variable <literal>virtual_alias_domains</literal> y establezca un archivo de traducción de direcciones en la variable <literal>virtual_alias_maps</literal>.</para>

        <example>
          <title>Directivas a agregar en el archivo <filename>/etc/postfix/main.cf</filename></title>

          <programlisting>
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual</programlisting>
        </example>

	<para>El archivo <filename>/etc/postfix/virtual</filename> describe la relación con una sintaxis muy sencilla: cada línea contiene dos campos separados por espacios en blanco; el primer campo es el nombre del alias y el segundo es una lista de las direcciones de correo a las que se redirigen. La sintaxis especial <literal>@dominio.com</literal> abarca todos los alias pertenecientes a un dominio.</para>

        <example>
          <title>Archivo <filename>/etc/postfix/virtual</filename> de ejemplo</title>

          <programlisting>
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# El alias siguiente es genérico y abarca todas las direcciones 
# del dominio falcotsbrand.com que no están incluidas explícitamente
# en este archivo.
# Estas direcciones reenvían el correo al usuario con el mismo nombre
# pero del dominio falcot.com
@falcotsbrand.com           @falcot.com</programlisting>
        </example>
      </section>
      <section>
        <title>Casillas de dominio virtual</title>

        <sidebar>
          <title><emphasis>PRECAUCIÓN</emphasis> ¿Dominio virtual combinado?</title>

	  <para>Postfix no permite utilizar el mismo dominio en <literal>virtual_alias_domains</literal> y <literal>virtual_mailbox_domains</literal>. Sin embargo, cada dominio de <literal>virtual_mailbox_domains</literal> es incluido implícitamente en <literal>virtual_alias_domains</literal> lo que permite mezclar alias y casillas en un dominio virtual.</para>
        </sidebar>

        <indexterm><primary>casilla de dominio virtual</primary></indexterm>
	<indexterm><primary>dominio virtual</primary><secondary>casilla de correo</secondary></indexterm>

	<para>Los mensajes dirigidos a una casilla de dominio virtual son almacenados en casillas que no están asignadas a un usuario local del sistema.</para>

	<para>Activar una casilla de dominio virtual requiere agregar este dominio en la variable <literal>virtual_mailbox_domains</literal> y hacer referencia a un archivo de asociación de casillas en <literal>virtual_mailbox_maps</literal>. El parámetro <literal>virtual_mailbox_base</literal> contiene el directorio en el que se almacenarán todas las casillas.</para>

	<para>El parámetro <literal>virtual_uid_maps</literal> (o <literal>virtual_gid_maps</literal> respectivamente) hace referencia al archivo que contiene la asociación entre las direcciones de correo y el usuario de sistema (o grupo respectivamente) «dueño» de la casilla correspondiente. Para lograr que todas las casillas pertenezcan al mismo usuario/grupo, la sintaxis <literal>static:5000</literal> asigna un UID/GID fijo (aquí el valor 5000).</para>

        <example>
          <title>Directivas a agregar en el archivo <filename>/etc/postfix/main.cf</filename></title>

          <programlisting>
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts</programlisting>
        </example>

	<para>Nuevamente, la sintaxis del archivo <filename>/etc/postfix/vmailbox</filename> es bastante directo: dos campos separados con espacios en blanco. El primer campo es una dirección de correo en alguno de los dominios virtuales y el segundo campo es la ubicación de la casilla asociada (relativa al directorio especificado en <emphasis>virtual_mailbox_base</emphasis>). Si el nombre de la casilla finaliza con una barra (<literal>/</literal>), se almacenarán los correos en formato <emphasis>maildir</emphasis>; de lo contrario se utilizará el formato <emphasis>mbox</emphasis> tradicional. El formato <emphasis>maildir</emphasis> utiliza un directorio completo para almacenar una casilla, cada mensaje individual es almacenado en un archivo separado. Por el otro lado, en el formato <emphasis>mbox</emphasis> se almacena toda la casilla en un archivo y cada línea que comience con «<literal>From </literal> (<literal>From</literal> es seguido por un espacio) indica el comienzo de un nuevo mensaje.</para>

        <example>
          <title>El archivo <filename>/etc/postfix/vmailbox</filename></title>

          <programlisting>
# Se almacena el correo de Jean como maildir, con
# un archivo por correo en un directorio dedicado
jean@falcot.org falcot.org/jean/
# Se almacena el correo de Sophie en un archivo
# «mbox» tradicional con todos los correos
# en un solo archivo
sophie@falcot.org falcot.org/sophie</programlisting>
        </example>
      </section>
    </section>
    <section id="sect.restrictions-for-receiving-and-sending">
      <title>Restricciones para recibir y enviar</title>

      <para>La cantidad creciente de correo masivo no solicitado (<emphasis>spam</emphasis>) hace necesario ser cada vez más estricto al decidir qué correos debe aceptar un servidor. Esta sección presenta alguna de las estrategias incluidas en Postfix.</para>

      <sidebar>
        <title><emphasis>CULTURA</emphasis> El problema del spam</title>
        <indexterm><primary>spam</primary></indexterm>

	<para>«Spam» es un término genérico utilizado para designar todo el correo comercial no solicitado (UCE por su siglas en inglés: «Unsolicited Commercial Emails») que inundan nuestras casillas electrónicas; los individuos sin escrúpulos que lo envían son conocidos como spammers. Poco les importan las molestias que causan ya que enviar un correo cuesta muy poco y sólo necesitan atraer con sus ofertas un porcentaje muy pequeño de quienes lo reciban para que la operación de spam genere más dinero de lo que cuesta. El proceso es mayormente automático y cualquier dirección de correo que sea publicada (por ejemplo en un foro web, en los compendios de una lista de correo, en un blog, etc.) será descubierta por los robots de los spammers y víctima de un flujo interminable de mensajes no solicitados.</para>

	<para>Todos los administradores de sistemas intentan enfrentarse a esta molestia con filtros de spam pero, por supuesto, los spammers continúan adaptándose para evitar estos filtros. Algunos inclusive alquilan redes de máquinas comprometidas por algún gusano de varios sindicatos criminales. ¡Estadísticas recientes estiman que hasta un 95% de todos los correos circulando en Internet son spam!</para>
      </sidebar>
      <section>
        <title>Restricciones de acceso basadas en IP</title>

	<para>La directiva <literal>smtpd_client_restrictions</literal> controla qué máquinas pueden comunicarse con el servidor de correo.</para>

        <example>
          <title>Restricciones basadas en la dirección del cliente</title>

          <programlisting>
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org</programlisting>
        </example>

	<para>Cuando una variable contiene una lista de reglas, como en el ejemplo anterior, estas reglas son evaluadas en orden desde la primera hasta la última. Cada regla puede aceptar el mensaje, rechazarlo o dejar la decisión de qué hacer a reglas posteriores. Por lo tanto, el orden importa y cambiar el orden en el que están establecidas las reglas puede provocar un comportamiento completamente diferente.</para>

	<para>La directiva <literal>permit_mynetworks</literal>, como primera regla, acepta todos los correos que provienen de equipos en la red local (definida por la variable de configuración <emphasis>mynetworks</emphasis>).</para>

	<para>La segunda directiva normalmente rechazará correos que provienen de equipos sin una configuración de DNS completamente válida. Esta configuración válida significa que la dirección IP está asociada a un nombre y que este nombre, además, resuelve a dicha dirección IP. Generalmente, esta restricción es demasiado estricta ya que muchos servidores de correo no tienen un DNS inverso para su dirección IP. Esto explica porqué los administradores de Falcot agregaron el modificador <literal>warn_if_reject</literal> antes de la directiva <literal>reject_unkown_client</literal>: este modificado convierte el rechazo en una simple advertencia guardada en los registros. Los administradores pueden revisar la cantidad de mensajes que hubiesen sido rechazados si esta regla hubiese sido aplicada y luego tomar decisiones informadas si desean activarla.</para>

        <sidebar>
          <title><emphasis>SUGERENCIA</emphasis> Tablas <emphasis>access</emphasis></title>

	  <para>El criterio de restricción incluye tablas que pueden ser modificadas por un administrador que contienen combinaciones de remitente, dirección IP y nombres de equipo permitidos o prohibidos. Puede crear estas tablas desde una copia descomprimida del archivo <filename>/usr/share/doc/postfix-doc/examples/access.gz</filename>. Este modelo está documentado en sus comentarios, lo que significa que cada tabla describe su propia sintaxis.</para>

	  <para>La tabla <filename>/etc/postfix/access_clientip</filename> enumera direcciones IP y redes; <filename>/etc/postfix/access_helo</filename> enumera nombres de dominio; <filename>/etc/postfix/access_sender</filename> contiene direcciones de correo de remintentes. Necesita convertir todos estos archivos en «tablas hash» (un formato optimizado para acceso rápido) luego de cada cambio ejecutando <command>postmap /etc/postfix/<replaceable>archivo</replaceable></command>.</para>
        </sidebar>

	<para>La tercera directiva permite al administrador definir listas negras y blancas de servidores de correo, almacenadas en el archivo <filename>/etc/postfix/access_clientip</filename>. Se consideran confiables aquellos servidores en la lista blanca y, por lo tanto, sus correos no pasarán por las siguientes reglas de filtrado.</para>

	<para>Las últimas dos reglas rechazan cualquier mensaje que provenga de un servidor incluido en una de las listas negras indicadas. RBL es un acrónimo de <emphasis>Remote Black List</emphasis> (lista negra remota); hay muchas de estas listas pero todas enumeran servidores mal configurados que los spammers utilizan para redirigir sus correos, así como equipos que no siendo servidores de correo legítimos están infectados con algún gusano o virus y actuan como tales.</para>
        <indexterm><primary>RBL</primary></indexterm>
        <indexterm><primary>Remote Black List</primary></indexterm>

        <sidebar>
          <title><emphasis>SUGERENCIA</emphasis> Listas blancas y RBLs</title>

	  <para>Las listas negras a veces incluyen un servidor legítimo que ha sufrido un incoveniente. En estas situaciones, se rechazarán todos los correos que provengan de alguno de estos servidores a menos que el servidor esté incluido en una lista blanca definida en <filename>/etc/postfix/access_clientip</filename>.</para>

	  <para>Por este motivo es recomendable incluir en la lista blanca los servidores confiables desde los que habitualmente se reciban muchos correos.</para>
        </sidebar>
      </section>
      <section>
        <title>Revisión de la validez de las órdenes <literal>EHLO</literal> o <literal>HELO</literal></title>

	<para>Cada intercambio SMTP comienza con la orden <literal>HELO</literal> (o <literal>EHLO</literal>) seguida del nombre del servidor que envía el correo; puede ser interesante validar este nombre.</para>
        <indexterm><primary><literal>HELO</literal></primary></indexterm>
        <indexterm><primary><literal>EHLO</literal></primary></indexterm>

        <example>
          <title>Restricciones en el nombre anunciado con <literal>EHLO</literal></title>
          
          <programlisting>
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname</programlisting>
        </example>

	<para>La primera directiva <literal>permit_my_networks</literal> permite que todas las máquinas en la red local se presenten libremente. Esto es importante ya que algunos programas de correo no respetan esta parte del protocolo SMTP de forma suficientemente correcta y pueden presentarse a sí mismos con nombres sin sentido.</para>

	<para>La regla <literal>reject_invalid_hostname</literal> rechaza los correos cuando el anuncio <literal>EHLO</literal> enumere un nombre sintácticamente incorrecto. La regla <literal>reject_non_fqdn_hostname</literal> rechaza mensajes cuando el nombre anunciado no es un nombre de dominio completamente calificado (incluye un nombre de dominio así como también el nombre del equipo). La regla <literal>reject_unkown_hostname</literal> rechaza los mensajes si el nombre anunciado no existe en su DNS. Los administradores hicieron que los efectos de esta regla sean sólo una advertencia con el modificador <literal>warn_if_reject</literal> debido a que, lamentablemente, genera demasiados rechazos. Esto es sólo un primer paso, pueden decidir eliminar el modificador en el futuro luego de analizar los resultados de esta regla.</para>

	<para>Utilizar <literal>permit_mynetworks</literal> como la primera regla tiene un efecto secundario interesante: las reglas siguientes sólo serán aplicadas a los equipos fuera de la red local. Esto permite rechazar todos los equipos que se anuncien a sí mismos como parte de <literal>falcot.com</literal>, por ejemplo agregando una línea <literal>falcot.com REJECT ¡No es parte de nuestra red!</literal> en el archivo <filename>/etc/postfix/access_helo</filename>.</para>
      </section>
      <section>
        <title>Aceptación o rechazo basado en el remitente anunciado</title>

	<para>Cada mensaje tiene un remitente anunciado con la orden <literal>MAIL FROM</literal> del protocolo SMTP; nuevamente, puede validar esta información de varias formas.</para>
        <indexterm><primary><literal>MAIL FROM</literal></primary></indexterm>
        <indexterm><primary>correo</primary><secondary>filtro de remitente</secondary></indexterm>

        <example>
          <title>Verificación de remitente</title>

          <programlisting>
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender</programlisting>
        </example>

	<para>La tabla <filename>/etc/postfix/access_sender</filename> asocia algún tratamiento especial a algunos remitentes. Esto generalmente significa enumerar algunos remitentes en una lista negra o blanca.</para>

	<para>La regla <literal>reject_unknown_sender_domain</literal> requiere un remitente con dominio válido, ya que es necesario en una dirección válida. La regla <literal>reject_unlisted_sender</literal> rechaza remitentes locales si la dirección no existe; esto evita que se envíen correos desde una dirección inválida en el dominio <literal>falcot.com</literal> y los mensajes de <literal>joe.bloggs@falcot.com</literal> sólo son aceptados si existe dicha dirección.</para>

	<para>Finalmente, la regla <literal>reject_non_fqdn_sender</literal> rechaza los correos que dicen provenir de direcciones sin un nombre de dominio completamente calificado. En la práctica significa rechazar correos que provienen de <literal>usuario@equipo</literal>: la dirección debe anunciarse como <literal>usuario@equipo.example.com</literal> o <literal>usuario@example.com</literal>.</para>
      </section>
      <section>
        <title>Aceptación o rechazo basado en el receptor</title>

	<para>Cada correo tiene al menos un receptor, anunciado con la orden <literal>RCPT TO</literal> en el protocolo SMTP. Estas direcciones también requieren validación, aún si pueden ser menos relevantes que las verificaciones realizadas en la dirección del remitente.</para>
        <indexterm><primary>RCPT TO</primary></indexterm>
        <indexterm><primary>correo</primary><secondary>filtro de receptor</secondary></indexterm>

        <example>
          <title>Verificación de receptor</title>

          <programlisting>
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient</programlisting>
        </example>

	<para><literal>reject_unauth_destination</literal> es la regla básica que requiere que los mensajes externos estén destinados a nosotros; se rechazarán los mensajes que sean enviados a una dirección que no sea gestionada por este servidor. Sin esta regla, el servidor se convierte en una forma abierta de reenvío que permite que los spammers envíen correos no solicitados; por lo tanto esta regla es obligatoria y preferentemente debe estar ubicada cerca del principio de la lista para evitar que otras reglas autoricen el mensaje antes que se verifique su destino.</para>

	<para>La regla <literal>reject_unlisted_recipient</literal> rechaza los mensajes enviados a usuarios locales que no existen, lo que tiene sentido. Finalmente, la regla <literal>reject_non_fqdn_recipient</literal> rechaza direcciones que no sean completamente calificadas; esto hace imposible enviar un correo a <literal>jean</literal> o <literal>jean@equipo</literal> y necesita, en cambio, utilizar la dirección completa como <literal>literal@equipo.falcot.com</literal> o <literal>jean@falcot.com</literal>.</para>
      </section>
      <section>
        <title>Restricciones asociadas con la orden <literal>DATA</literal></title>

	<para>Se emite la orden <literal>DATA</literal> en SMTP antes del contenido del mensaje. No provee ninguna información en sí misma además de anunciar lo que seguirá. Todavía puede ser sujeta a verificación.</para>
        <indexterm><primary><literal>DATA</literal></primary></indexterm>

        <example>
          <title>Verificación de <literal>DATA</literal></title>

          <programlisting>
smtpd_data_restrictions = reject_unauth_pipelining</programlisting>
        </example>

	<para>Las directivas <literal>reject_unauth_pipelining</literal> causa que se rechace el mensaje si el remitente envía una orden antes que se envía la respuesta a la orden anterior. Esto previene una optimización común utilizada por los robots de spammers ya que no tienen el menor interés en las respuestas y sólo están interesados en enviar tantos correos como sea posible en el menor tiempo posible.</para>
      </section>
      <section>
        <title>Implementación de restricciones</title>

	<para>Si bien las órdenes anteriores validan la información en las varias etapas del intercambio SMTP, Postfix sólo envía el rechazo en sí como respuesta a la orden <literal>RCPT TO</literal>.</para>

	<para>Esto significa que aún si se rechaza el mensaje debido a una orden <literal>EHLO</literal> no válida, Postfix conoce el remitente y el receptor cuando anuncia un rechazo. Luego puede registrar un mensaje más explícito de lo que podría si se hubiera interrumpido la transacción al comienzo. Además, una cantidad de clientes SMTP no esperan fallos en las primeras órdenes de SMTP y estos clientes no se molestarán tanto por este rechazo tardío.</para>

	<para>Una ventaja final de esta opción es que las reglas pueden acumular información durante las varias etapas del intercambio SMTP; esto permite definir permisos más precisos, como rechazar conexiones remotas si se anuncia como un remitente local.</para>
      </section>
      <section>
        <title>Filtros basados en el contenido del mensaje</title>

	<para>El sistema de validación y restricción no estaría completo sin una forma de realizar verificaciones en el contenido de los mensajes. Postfix diferencia las verificaciones en las cabeceras del correo de aquellas sobre el cuerpo del mensaje.</para>

        <example>
          <title>Habilitación de filtros basados en contenido</title>

          <programlisting>
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks</programlisting>
        </example>
        <indexterm><primary>email</primary><secondary>filtro de contenido</secondary></indexterm>

	<para>Ambos archivos contienen una lista de expresiones regulares (normalmente conocidas como <emphasis>regexps</emphasis> o <emphasis>regexes</emphasis>) y las acciones asociadas que se deben disparar cuando las cabeceras (o cuerpo) del mensaje coincida con la expresión.</para>

        <sidebar>
          <title><emphasis>VISTA RÁPIDA</emphasis> Tablas de expresiones regulares («regexp»)</title>

	  <para>El archivo <filename>/usr/share/doc/postfix-doc/examples/header_checks.gz</filename> contiene muchos comentarios explicativos y puede utilizarlo como punto de partida para crear los archivos <filename>/etc/postfix/header_checks</filename> y <filename>/etc/postfix/body_checks</filename>.</para>
        </sidebar>

        <example>
          <title>Archivo <filename>/etc/postfix/header_checks</filename> de ejemplo</title>

          <programlisting>
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Su email contiene VIRUS/ DESCARTAR notificación de virus</programlisting>
        </example>

        <sidebar id="sidebar.regexp">
          <title><emphasis>VOLVER A LOS CIMIENTOS</emphasis> Expresiones regulares</title>

	  <para>El término <emphasis>expresión regular</emphasis> (acortado como <emphasis>regexp</emphasis> o <emphasis>regex</emphasis>) hace referencia a una notación genérica para expresar una descripción del contenido o estructura de una cadena de caracteres. Algunos caracteres especiales permiten definir alternativas (por ejemplo <literal>foo|bar</literal> coincidirá tanto «foo» como «bar»), conjuntos de caracteres permitidos (por ejemplo <literal>[0-9]</literal> significa cualquier dígito y <literal>.</literal> — un punto — significa cualquier carácter), cuantificadores (<literal>s?</literal> coincidirá tanto con <literal>s</literal> como con la cadena vacía, en otras palabras 0 o 1 ocurrencia de <literal>s</literal>; <literal>s+</literal> coincidirá con uno o más caracteres <literal>s</literal> consecutivos, etc.). Los paréntesis permiten agrupar resultados de búsqueda.</para>

	  <para>La sintaxis exacta de estas expresiones es diferente en cada herramienta que las utilizan, pero las características básicas son similares. <ulink type="block" url="http://es.wikipedia.org/wiki/Expresión_regular" /></para>
        </sidebar>

	<para>El primero revisa la cabecera que menciona el software de correo; si es <literal>GOTO Sarbacane</literal> (un software en correo masivo), el mensaje es rechazado. La segunda expresión revisa el asunto del mensaje; si menciona una notificación de virus podemos decidir no rechazar el mensaje sino, en cambio, descartarlo inmediatamente.</para>

	<para>Utilizar estos filtros es un arma de doble filo ya que es sencillo crear reglas demasiado genéricas y, en consecuencia, perder correos legítimos. En estos casos, no sólo se perderán los mensajes sino que sus remitentes recibirán mensajes de error no deseados (y molestos).</para>
      </section>
    </section>
    <section id="sect.setting-up-greylisting">
      <title>Configuración de «listas grises» (<foreignphrase>greylisting</foreignphrase>)</title>
      <indexterm><primary>greylisting</primary></indexterm>

      <para>Las «listas grises» («greylisting») son una técnica de filtrado en la que, inicialmente, el mensaje se rechaza con un código de error temporal, y sólo es aceptado en un intento posterior tras cierta demora. Este filtro es particularmente eficiente contra el spam enviado por máquinas infectadas con gusanos y virus, ya que éstos rara vez actúan como agentes SMTP completos (revisando el código de error y reintentando luego mensajes fallidos), especialmente debido a que muchas de las direcciones recolectadas son inválidas y reintentarlas sólo sería una pérdida de tiempo.</para>

      <para>Postfix no provee listas grises de forma nativa, pero posee una funcionalidad en la que la decisión de aceptar o rechazar un mensaje dado puede ser delegada a un programa externo. El paquete <emphasis role="pkg">postgrey</emphasis> contiene dicho programa, diseñado para interactuar con su servicio de delegación de políticas de acceso.</para>

      <para>Una vez que instaló <emphasis role="pkg">postgrey</emphasis>, éste se ejecutará como un demonio que escucha en el puerto 10023. Luego puede configurar postfix para utilizarlo si agrega el parámetro <literal>check_policy_service</literal> como una restricción adicional:</para>

      <programlisting>
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023</programlisting>

      <para>Cada vez que Postfix alcance esta regla, se conectará con el demonio <command>postgrey</command> y le enviará la información del mensaje en cuestión. Por su parte, Postgrey considerará la terna compuesta por la dirección IP, el remitente y el receptor y revisará en su base de datos si ésta fue intentada recientemente. En caso que así sea, Postgrey responderá que el mensaje debe ser aceptado; de lo contrario, la respuesta indicará que el mensaje deberá ser rechazado temporalmente y agregará la terna a su base de datos.</para>

      <para>La principal desventaja de las listas grises es que demorará mensajes legítimos, lo que no siempre es aceptable. También aumenta la carga en los servidores que envían muchos correos legítimos.</para>

      <sidebar>
        <title><emphasis>EN LA PRÁCTICA</emphasis> Desventajas de las listas grises</title>

	<para>En teoría, las listas grises sólo deberían demorar el primer correo de un remitente a un receptor particular, y la demora típica es del orden de minutos. La realidad, sin embargo, puede ser ligeramente diferente. Algunos ISPs grandes utilizan conjuntos de servidores SMTP y, cuando el mensaje es rechazado inicialmente, el servidor que lo reintente puede no ser el mismo que el que envió el mensaje inicial. Cuando ocurre esto, el segundo servidor también recibirá un error temporal debido a la lista gris y así sucesivamente; puede tomar varias horas hasta que la transmisión sea intentada por un servidor que ya estuvo involucrado ya que los servidores SMTP generalmente aumentan la demora entre intentos cuando éstos fallan.</para>

	<para>Como consecuencia, la dirección IP puede cambiar en el tiempo aún para un remitente particular. Pero hay más: la dirección del remitente también puede cambiar. Por ejemplo, muchos servidores de listas de correo codifican información extra en la dirección del remitente para poder gestionar mensajes de error (conocidos como «<emphasis>bounces</emphasis>»). Luego, puede que cada nuevo mensaje enviado a una lista de correo necesite pasar por las listas grises, lo que significa que debe ser almacenado (temporalmente) en el servidor del remitente. Para listas de correo muy grandes (con decenas de miles de suscriptos), esto puede convertirse en un problema rápidamente.</para>

	<para>Para mitigar estas desventajas, Postgrey gestiona listas blancas de estos sitios y los mensajes que provengan desde ellos son aceptados inmediatamente sin pasar a través de las listas grises. Puede adaptar esta lista fácilmente a sus necesidades locales ya que se encuentra almacenada en el archivo <filename>/etc/postgrey/whitelist_clients</filename>.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>YENDO MÁS ALLÁ</emphasis> Listas grises selectivas con <emphasis role="pkg">milter-greylist</emphasis></title>

	<para>También puede evitar los inconvenientes de las listas grises utilizándolas únicamente para el subconjunto de clientes que ya son considerados como fuentes probables de spam (porque se encuentran en una lista negra de DNS). Esto no es posible con <emphasis role="pkg">postgrey</emphasis>, pero puede utilizar <emphasis role="pkg">milter-greylist</emphasis> para hacer esto.</para>

	<para>En este escenario, debido a que una lista negra de DNS nunca genera un rechazo definitivo, es razonable utilizar listas negras de DNS agresivas, incluyendo aquellas que incluyen todas las direcciones IP dinámicas de clientes de ISPs (como <literal>pbl.spamhaus.org</literal> o <literal>dul.dnsbl.sorbs.net</literal>).</para>

	<para>Como milter-greylist utiliza la interfaz de milter de Sendmail, la configuración del lado de postfix se limita a «<literal>smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</literal>». La página de manual <citerefentry><refentrytitle>greylist.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> documenta <filename>/etc/milter-greylist/greylist.conf</filename> y las muchas formas de configurar milter-greylist. Deberá tambien editar el archivo <filename>/etc/default/milter-greylist</filename> para activar realmente el servicio.</para>
      </sidebar>
    </section>
    <section>
      <title>Personalización de filtros basados en el receptor</title>

      <para><xref linkend="sect.restrictions-for-receiving-and-sending" /> y <xref linkend="sect.setting-up-greylisting" /> revisaron muchas de las restricciones posibles. Todas son útiles para limitar la cantidad de spam recibido, pero también tienen su desventajas. Por lo tanto, es más y más común, personalizar el conjunto de filtros según el receptor. En Falcot Corp, las listas grises son interesantes para la mayoría de los usuarios pero entorpece el trabajo de algunos usuarios que necesitan una latencia baja en sus correos (como el servicio de soporte técnico). De forma similar, el servicio comercial a veces tiene problemas para recibir correos de algunos proveedores asiáticos que pueden encontrarse en listas negras; este servicio solicitó una dirección sin filtros para poder intercambiar correspondencia.</para>

      <para>Postfix provee tal personalización de filtros con el concepto de «clases de restricción». Declarará las clases en el parámetro <literal>smtpd_restriction_classes</literal> de la misma forma que <literal>smtpd_recipient_restrictions</literal>. La directiva <literal>check_recipient_access</literal> define luego una tabla que asocia un receptor dado con el conjunto de restricciones apropiadas.</para>

      <example>
        <title>Definición de clases de restricción en <filename>main.cf</filename></title>

        <programlisting>smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access</programlisting>
      </example>

      <example>
        <title>El archivo <filename>/etc/postfix/recipient_access</filename></title>

        <programlisting>
# Direcciones sin filtro
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Filtros agresivos para algunos usuarios privilegiados
joe@falcot.com         aggressive

# Regla especial para el administrador de la lista de correos
sympa@falcot.com       reject_unverified_sender

# Listas grises de forma predeterminada
falcot.com             greylisting</programlisting>
      </example>
    </section>
    <section id="sect.postfix-antivirus">
      <title>Integración con un antivirus</title>
      <indexterm><primary>antivirus</primary></indexterm>

      <para>La cantidad de virus circulando como adjuntos de correos hace importante configurar un antivirus en el punto de entrada de la red corporativa, ya que a pesar de una campaña de concientización, algunos usuarios aún abriran los adjuntos de mensajes obviamente sospechosos.</para>

      <para>Los administradores de Falcot seleccionaro <command>clamav</command> como su antivirus libre. El paquete principal es <emphasis role="pkg">clamav</emphasis>, pero tambien instalaron algunos paquetes adicionales como <emphasis role="pkg">arj</emphasis>, <emphasis role="pkg">unzoo</emphasis>, <emphasis role="pkg">unrar</emphasis> y <emphasis role="pkg">lha</emphasis> ya que son necesarios para que el antivirus analice archivos adjuntos en alguno de estos formatos.</para>
      <indexterm><primary><command>clamav</command></primary></indexterm>
      <indexterm><primary><command>clamav-milter</command></primary></indexterm>

      <para>La tarea de interactuar entre el antivirus y el servidor de correo le corresponde a <command>clamav-milter</command>. Un «<emphasis>milter</emphasis>» (apócope de «filtro de correo»: «<emphasis>mail filter</emphasis>») es un programa de filtrado diseñado especialmente para interactuar con servidores de correo. Un milter utiliza una interfaz de programación de aplicaciones (API: «Application Programming Interface») que provee un rendimiento mucho mejor que los filtros ajenos a los servidores de correo. <emphasis>Sendmail</emphasis> introdujo inicialmente a los milters, pero <emphasis>Postfix</emphasis> los implementó poco después.</para>

      <sidebar>
        <title><emphasis>VISTA RÁPIDA</emphasis> Un milter para Spamassassin</title>
        <indexterm><primary><emphasis role="pkg">spamass-milter</emphasis></primary></indexterm>

	<para>El paquete <emphasis role="pkg">spamass-milter</emphasis> provee un milter basado en <emphasis>SpamAssassin</emphasis>, el famoso detector de correo no deseado. Puede utilizarlo para marcar mensajes como probable spam (agregando una cabecera adicional) y/o rechazar el mensaje completamente si su «puntaje de spam» supera cierto límite.</para>
      </sidebar>

      <para>Una vez que instaló el paquete <emphasis role="pkg">clamav-milter</emphasis>, debería reconfigurar el milter para que ejecute en un puerto TCP en lugar del zócalo con nombre predeterminado. Puede lograr esto ejecutando <command>dpkg-reconfigure clamav-milter</command>. Cuando se le pregunte por la «Interfaz de comunicación con Sendmail», responda «<literal>inet:10002@127.0.0.1</literal>».</para>

      <sidebar>
        <title><emphasis>NOTA</emphasis> Puerto TCP real contra zócalo con nombre</title>
	<para>La razón por la que utilizamos un puerto TCP real en lugar del zócalo con nombres es que los demonios postfix generalmente ejecutan en un chroot y no tienen acceso al directorio que contiene el zócalo con nombre. En caso que decida utilizar el zócalo con nombre, utilice una ubicación dentro del chroot (<filename>/var/spool/postfix/</filename>).</para>
      </sidebar>

      <para>La configuración estándar de ClamAV se ajusta a la mayoría de las situaciones, pero puede personalizar algunos parámetros importantes con <command>dpkg-reconfigure clamav-base</command>.</para>

      <para>El último paso involucra decirle a Postfix que utilice el filtro recientemente configurado. Esto es tan simple como agregar la siguiente directiva a <filename>/etc/postfix/main.cf</filename>:</para>

      <programlisting>
# Revisión de virus con clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002</programlisting>

      <para>Si el antivirus causa problema, puede comentar esta línea; deberá ejecutar <command>service postfix reload</command> para que se tenga en cuenta el cambio.</para>

      <sidebar>
        <title><emphasis>EN LA PRÁCTICA</emphasis> Prueba del antivirus</title>

	<para>Una vez que configuró el antivirus, debe probar que funciona correctamente. La forma más simple de hacerlo es enviar un correo de prueba con un adjunto que contenga el archivo <filename>eicar.com</filename> (o <filename>eicar.com.zip</filename>) que puede descargar: <ulink type="block" url="http://www.eicar.org/86-0-Intended-use.html" /></para>

	<para>Este archivo no es un virus real sino un archivo de prueba que todo software antivirus en el mercado diagnostica como un virus para poder probar instalaciones.</para>
      </sidebar>

      <para>Todos los mensajes gestionados por Postfix ahora pasarán a través del filtro antivirus.</para>
    </section>
    <section id="sect.authenticated-smtp">
      <title>SMTP autenticado</title>

      <para>Para poder enviar correos es necesario poder acceder a un servidor SMTP; también requiere que dicho servidor SMTP permita el envío de correos. Para usuarios móviles, puede ser necesario cambiar la configuración de su cliente SMTP regularmente, ya que el servidor SMTP de Falcot rechaza los mensajes que provienen de direcciones IPs que no parecen pertenecer a la compañía. Existen dos soluciones: o bien los usuarios móviles instalan un servidor SMTP en sus equipos, o utilizan el servidor de la compañía con alguna forma de autenticarse como empleados. No se recomienda la primera solución ya que el equipo no estará conectado permanentemente y no podrá volver a intentar enviar mensajes en caso de problemas; nos centraremos en la última solución.</para>

      <para>La autenticación SMTN en Postfix depende de SASL (<emphasis>capa de seguridad y autenticación simple</emphasis>: «Simple Authentication and Security Layer»). Necesitará instalar los paquetes <emphasis role="pkg">libsasl2-modules</emphasis> y <emphasis role="pkg">sasl2-bin</emphasis>, y luego registrar una contraseña en la base de datos SALS para cada usuario que necesite autenticarse en el servidor SMTP. Puede hacerlo con el programa <command>saslpasswd2</command> que toma varios parámetros. La opción <literal>-u</literal> define el dominio de autenticación, que debe coincidir con el parámetro <literal>smtpd_sasl_local_domain</literal> en la configuración de Postfix. La opción <literal>-c</literal> permite crear un usuario y la opción <literal>-f</literal> permite especificar el archivo a utilizar si necesita almacenar la base de datos SALS en una ubicación diferente a la predeterminada (<filename>/etc/sasldb2</filename>).</para>

      <screen role="scale">
<computeroutput># </computeroutput><userinput>saslpasswd2 -u `postconf -h myservidor` -f /var/spool/postfix/etc/sasldb2 -c jean</userinput>
<computeroutput>[... ingrese la contraseña de jean dos veces ...]</computeroutput></screen>

      <para>Note que se creó la base de datos SASL en el directorio de Postfix. Para poder asegurar consistencia, también convertimos <filename>/etc/sasldb2</filename> en un enlace simbólico que apunta a la base de datos utilizada por Postfix  con <command>ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</command>.</para>

      <para>Ahora necesitamos configurar Postfix para que utilice SASL. Primero necesita agregar al usuario <literal>postfix</literal> al grupo <literal>sasl</literal> para que pueda acceder a la base de datos SASL. También necesitará agregar algunos parámetros nuevos para activar SASL y necesita configurar el parámetro <literal>smtpd_recipient_restrictions</literal> para permitir que los clientes autenticados por SASL puedan enviar correos libremente.</para>

      <example>
        <title>Activación de SASL en <filename>/etc/postfix/main.cf</filename></title>

        <programlisting>
# Activar autenticación SASL
smtpd_sasl_auth_enable = yes
# Definir el dominio de autenticación SASL
smtpd_sasl_local_domain = $myhostname
[...]
# Agregar permit_sasl_authenticated antes de reject_unauth_destination
# permite reenviar correos enviados por usuarios autenticados por SASL
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]</programlisting>
      </example>

      <sidebar>
        <title><emphasis>EXTRA</emphasis> Cliente SMTP autenticado</title>

	<para>La mayoría de los clientes de correo pueden autenticarse con un servidor SMTP antes de enviar mensajes, y utilizar esta funcionalidad es tan simple como configurar los parámetros apropiados. Si el cliente utilizado no provee esta funcionalidad, puede utilizar un servidor Postfix local y configurarlo para reenviar el correo a través de un servidor SMTP remoto. En este caso, el Postfix local será el cliente que se autentica con SASL. Estos son los parámetros necesarios:</para>

        <programlisting>
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]</programlisting>

	<para>El archivo <filename>/etc/postfix/sasl_passwd</filename> necesita contener el nombre de usuarios y la contraseña a utilizar para autenticarse en el servidor <literal>mail.falcot.com</literal>. Por ejemplo:</para>

        <programlisting>
[mail.falcot.com]   joe:LyinIsji</programlisting>

	<para>Como en todos los archivos de asociación de Postfix, debe convertir este archivo en <filename>/etc/postfix/sasl_passwd.db</filename> con el programa <command>postmap</command>.</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.http-web-server">
    <title>Servidor web (HTTP)</title>

    <para>Los administradores de Falcot Corp decidieron utilizar el servidor HTTP Apache, cuya versión 2.4.10 estaba incluida en la distribucion Debian <emphasis role="distribution">Wheezy</emphasis>.</para>
    <indexterm><primary><command>apache</command></primary></indexterm>
    <indexterm><primary>servidor</primary><secondary>web</secondary></indexterm>
    <indexterm><primary>web, servidor</primary></indexterm>
    <indexterm><primary>servidor</primary><secondary>HTTP</secondary></indexterm>
    <indexterm><primary>HTTP</primary><secondary>servidor</secondary></indexterm>

    <sidebar>
      <title><emphasis>ALTERNATIVA</emphasis> Otros servidores web</title>

      <para>Apache es simplemente el servidor web más conocido (y más utilizado), pero existen otros; pueden ofrecen mejor rendimiento bajo ciertos tipos de carga pero tienen la desventaja de una menor cantidad de funcionalidad y módulos disponibles. Sin embargo, cuando el servidor web en consideración es para proveer archivos estáticos o funcionar como proxy, vale la pena investigar las alternativas como <emphasis role="pkg">nginx</emphasis> y <emphasis role="pkg">lighttpd</emphasis>.</para>
      <indexterm><primary><emphasis role="pkg">nginx</emphasis></primary></indexterm>
      <indexterm><primary><emphasis role="pkg">lighttpd</emphasis></primary></indexterm>
    </sidebar>
    <section>
      <title>Instalación de Apache</title>

      <para>Lo único que necesita es instalar el paquete <emphasis role="pkg">apache2</emphasis>. Contiene todos los módulos, incluídos los <emphasis>Módulos de Multi-proceso</emphasis> (MPMs), que afectan a cómo Apache gestiona el procesamiento en paralelo de muchas peticiones (que suelen facilitarse en los paquetes separados <emphasis role="pkg">apache2-mpm-*"</emphasis>. Arrastrará también <emphasis role="pkg">apache2-utils</emphasis>, que contiene las utilidades de linea de órdenes que descubriremos más tarde.</para>

      <para>El uso de MPM en Apache afecta significativamente al manejo de las peticiones concurrentes. Con el <emphasis>worker</emphasis> MPM, se usan <emphasis>hilos</emphasis> (procesos ligeros) mientras que con <emphasis>prefork</emphasis> MPM usa un conjunto de procesos creados préviamente. Con el uso de <emphasis>event</emphasis> MPM tambien usa hilos pero las conexiones inactivas (las que se mantienen abiertas por la característica <emphasis>keep-alive</emphasis> de HTTP) son llevadas por el gestor de hilos dedicado.</para>

      <para>Los administradores de Falcot también instalan <emphasis role="pkg">libapache2-mod-php5</emphasis> para incluir la compatibilidad con PHP en Apache. Esto causa que se el MPM se desactive en el <emphasis>evento</emphasis> por defecto y, en su lugar se haga uso de <emphasis>prefork</emphasis>, ya que PHP sólo funciona bajo ese MPM particular.</para>

      <sidebar>
        <title><emphasis>SEGURIDAD</emphasis> Ejecución bajo el usuario <literal>www-data</literal></title>
        <indexterm><primary><literal>www-data</literal></primary></indexterm>
        <indexterm><primary>suexec</primary></indexterm>

	<para>De forma predeterminada, Apache administra todas las peticiones entrantes bajo la identidad del usuario <literal>www-data</literal>. Esto significa que, en caso de una vulnerabilidad de seguridad en un script CGI ejecutado por Apache (para una página dinámica), no se comprometerá todo el sistema sino sólo los archivos que son propiedad de este usuario en particular.</para>

	<para>Los módulos <emphasis>suexec</emphasis> permiten evitar esta limitación para que algunos scripts CGI ejecuten bajo la identidad de otros usuarios. Puede configurarlo con la directiva <literal>SuexecUserGroup <replaceable>usuario</replaceable> <replaceable>grupo</replaceable></literal> en la configuración de Apache.</para>
        <indexterm><primary><emphasis role="pkg">libapache2-mpm-itk</emphasis></primary></indexterm>

	<para>Otra posibilidad es utilizar un MPM dedicado, como el que provee el paquete <emphasis role="pkg">libapache2-mpm-itk</emphasis>. Este MPM en particular tiene un comportamiento ligeramente diferente: permite «aislar» los servidores virtuales («virtual hosts») (actualmente, conjuntos de páginas) para que cada uno ejecute como un usuario diferente. Por lo tanto, una vulnerabilidad en un sitio web no puede comprometer los archivos que pertenecen al dueño de otro sitio web.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>VISTA RÁPIDA</emphasis> Lista de módulos</title>

	<para>Puede encontrar la lista completa de los módulos estándar de Apache en la red. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/index.html" /></para>
      </sidebar>

      <para>Apache es un servidor modular y mucha funcionalidad está implementada por módulos externos que el programa principal carga durante su inicialización. La configuración predeterminada sólo activa los módulos más comunes, pero activar nuevos módulos es tan simple como ejecutar <command>a2enmod <replaceable>módulo</replaceable></command>; similarmente, podrá desactivar un módulo ejecutando <command>a2dismod <replaceable>módulo</replaceable></command>. En realidad, estos programas sólo crean (o eliminan) enlaces simbólicos en <filename>/etc/apache2/mods-enabled/</filename> que apuntan a los archivos en sí (almacenados en <filename>/etc/apache2/mods-available/</filename>).</para>

      <para>Con su configuración predeterminada, el servidor web escuchará en el puerto 80 (según se encuentra configurado en <filename>/etc/apache2/ports.conf</filename>) y servirá páginas del directorio <filename>/var/www/html/</filename> (según se encuentra configurado en <filename>/etc/apache2/sites-enabled/000-default.conf</filename>).</para>

      <sidebar>
        <title><emphasis>YENDO MÁS ALLÁ</emphasis> Compatibilidad con SSL</title>
        <indexterm><primary>HTTPS</primary></indexterm>
        <indexterm><primary>HTTP</primary><secondary>seguro</secondary></indexterm>

	<para>Apache 2.4, así como viene, incluye el módulo SSL necesario para HTTP seguro (HTTPS). Sólo necesita activarlo con <command>a2enmod ssl</command> y luego agregar las directivas necesarias a los archivos de configuración. Puede encontrar un archivo de configuración de ejemplo en <filename>/etc/apache2/sites-available/default-ssl.conf</filename>. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html" /></para>

	<para>Debe tener ciertos cuidados adicionales si prefiere conexiones SSL con «<emphasis>Perfect Forward Secrecy</emphasis>» (secreto perfecto a futuro, donde las conexiones utilizan llaves efímeras en cada sesión asegurándose que si se compromete la llave privada del servidor no signifique que se haya comprometido todo el tráfico antiguo que puede haberse almacenado desde la red). En particular, revise las recomendaciones de Mozilla: <ulink type="block" url="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache" /></para>
	<indexterm><primary><emphasis>Perfect Forward Secrecy</emphasis></primary></indexterm>
      </sidebar>
    </section>
    <section>
      <title>Configuración de servidores virtuales («virtual hosts»)</title>

      <para>Un servidor virtual es una identidad adicional para el servidor web.</para>
      <indexterm><primary>virtual, servidor</primary></indexterm>

      <para>Apache considera dos tipos distintos de servidores virtuales: aquellos basados en la dirección IP (o puerto) y aquellos basados en el nombre de dominio del servidor web. El primer método requiere reservar una dirección IP (o puerto) diferente para cada sitio, mientras que el segundo puede funcionar en sólo una dirección IP (y puerto) y se diferencian los sitios por el nombre enviado por el cliente HTTP (que sólo funciona en la versión 1.1 del protocolo HTTP — afortunadamente esta versión es suficientemente antigua para que todos los clientes ya lo utilicen).</para>

      <para>La escasez (creciente) de direcciones IPv4 generalmente favorece el segundo método; sin embargo, es más complejo si los servidores virtuales también necesitan proveer HTTPS ya que el protocolo SSL no siempre se adecuó a los servidores virtuales basados en nombres; no todos los navegadores son compatibles con la extensión SNI (<emphasis>indicación de nombre de servidor</emphasis>: «Server Name Indication») que permite esta combinación. Cuando varios sitios HTTPS necesitan ejecutar en el mismo servidor, generalmente se diferenciarán bien por ejecutar en un puerto o en una dirección IP diferente (IPv6 puede ayudar).</para>

      <para>La configuración predeterminada de Apache 2, activa servidores virtuales basados en nombre. Además, define un servidor virtual predeterminado en el archivo <literal>/etc/apache2/sites-enabled/000-default.conf</literal>; utilizará este servidor virtual si no se encuentra ningún servidor que coincida con el pedido enviado por el cliente.</para>

      <sidebar>
        <title><emphasis>PRECAUCIÓN</emphasis> Primer servidor virtual</title>

	<para>Los pedidos que involucren un servidor virtual desconocido siempre serán gestionados por el primer servidor virtual definido, razón por la que definimos allí a <literal>www.falcot.com</literal>.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>VISTA RÁPIDA</emphasis> Compatibilidad SNI de Apache</title>
        <indexterm><primary>Server Name Indication</primary></indexterm>

	<para>El servidor Apache es compatible con la extensión del protocolo SSL llamada <emphasis>indicación de nombre de servidor</emphasis> (SNI: «Server Name Indication»). Esta extensión permite al navegador enviar el nombre del servidor web durante el establecimiento de la conexión SSL, mucho antes del pedido HTTP en sí, lo que antes utilizaba para identificar el servidor virtual pedido entre aquellos que se encuentran en el mismo servidor (con la misma dirección IP y puerto). Esto le permite a Apache seleccionar el certificado SSL apropiado para que continúe la transacción.</para>

	<para>Antes de SNI, Apache siempre proveía el certificado configurado en el servidor virtual predeterminado. Los clientes que intentaban acceder a otros servidores virtuales recibirían advertencias ya que el certificado que recibieron no coincidía con el sitio web que estaban intentando acceder. Afortunadamente, la mayoría de los navegadores ahora utilizan SNI; esto incluye Microsoft Internet Explorer a partir de la versión 7.0 (comenzando con Vista), Mozilla Firefox desde la versión 2.0, Apple Safari desde la versión 3.2.1 y todas las versiones de Google Chrome.</para>

	<para>El paquete Apache proporcionado en Debian está compilado con soporte SNI; de modo que no es necesario ninguna configuración particular.</para>

	<para>También debe tener cuidado de asegurar que la configuración del primer servidor virtual (el utilizado de forma predeterminada) tenga TLSv1 activo, debido a que Apache utiliza los parámetros de este primer servidor virtual para establecer conexiones seguras y ¡debería permitirlo!</para>
      </sidebar>

      <para>Luego puede describir cada servidor virtual adicional con un archivo almacenado en <filename>/etc/apache2/sites-available/</filename>. La configuración de un sitio web para el dominio <literal>falcot.org</literal> es tan simple como crear el siguiente archivo y luego habilitar el servidor virtual con <command>a2ensite www.falcot.org</command>.</para>

      <example>
        <title>El archivo <filename>/etc/apache2/sites-available/www.falcot.org.conf</filename></title>

        <programlisting>
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</programlisting>
      </example>

      <para>El servidor Apache, como está configurado hasta ahora, utiliza los mismos archivos de registro para todos los servidores virtuales (puede cambiarlo agregando directivas <literal>CustomLog</literal> en las definiciones de servidores virtuales). Por lo tanto, tiene sentido personalizar el formato de este archivo de registro para incluir el nombre del servidor virtual. Puede hacerlo creando un archivo <filename>/etc/apache2/conf-available/customlog.conf</filename> que define un nuevo formato para todos los archivos de registro (con la directiva <literal>LogFormat</literal>) y habilitándolo con la orden <command>a2enconf customlog</command>. También debe eliminar (o comentar) la línea <literal>CustomLog</literal> del archivo <filename>/etc/apache2/sites-available/000-default.conf</filename>.</para>

      <example>
        <title>El archivo <filename>/etc/apache2/conf.d/customlog.conf</filename></title>

        <programlisting role="scale">
# Nuevo formato de registro que incluye el nombre del servidor (virtual)
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Ahora utilicemos este formato de forma predeterminada
CustomLog /var/log/apache2/access.log vhost</programlisting>
      </example>
    </section>
    <section>
      <title>Directivas comunes</title>

      <para>Esta sección revisa brevemente alguna de las directivas de configuración de Apache más utilizadas.</para>
      <indexterm><primary>Apache, directivas</primary></indexterm>
      <indexterm><primary>directivas Apache</primary></indexterm>

      <para>El archivo de configuración principal generalmente incluye varios bloques <literal>Directory</literal> que permiten diferentes comportamientos del servidor dependiendo de la ubicación del archivo que está proveyendo. Tales bloques usualmente incluyen directivas <literal>Options</literal> y <literal>AllowOverride</literal>.</para>
      <indexterm><primary><literal>Options</literal>, directiva de Apache</primary></indexterm>
      <indexterm><primary><literal>AllowOverride</literal>, directiva de Apache</primary></indexterm>

      <example>
        <title>Bloque Directory</title>

        <programlisting>
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;</programlisting>
      </example>

      <para>La directiva <literal>DirectoryIndex</literal> contiene una lista de archivos a intentar cuando el pedido del cliente es un directorio. El primer archivo de la lista que exista será utilizado y enviado como respuesta.</para>
      <indexterm><primary><literal>DirectoryIndex</literal>, directiva de Apache</primary></indexterm>

      <para>La directiva <literal>Options</literal> debe seguirse de una lista de opciones a activar. El valor <literal>None</literal> desactiva todas las opciones; correspondientemente, <literal>All</literal> las activa todas excepto <literal>MultiViews</literal>. Las opciones disponibles incluyen:</para>
      <itemizedlist>
        <listitem>
	  <para><literal>ExecCGI</literal> indica que puede ejecutar scripts CGI. <indexterm><primary><literal>ExecCGI</literal>, directiva de Apache</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>FollowSymlinks</literal> le dice al servidor que puede seguir los enlaces simbólicos y que la respuesta debe contener el contenido del objetivo de dichos enlaces. <indexterm><primary><literal>FollowSymlinks</literal>, directiva de Apache</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>SymlinksIfOwnerMatch</literal> también le indica al servidor que siga los enlaces simbólicos, pero sólo cuando el enlace y su objetivo tengan el mismo dueño. <indexterm><primary><literal>SymlinksIfOwnerMatch</literal>, directiva de Apache</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>Includes</literal> activa <emphasis>inclusiones del lado del servidor</emphasis> (<emphasis>SSI</emphasis>: «Server Side Includes»). Estas directivas se encuentran en las páginas HTML y son ejecutadas en el momento de cada pedido. <indexterm><primary><literal>Includes</literal>, directiva de Apache</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>Indexes</literal> le indica al servidor que provea una lista del contenido de los directorios si el pedido HTTP del cliente apunta a un directorio sin un archivo de índice (es decir, que no existe en él ninguno de los archivos enumerados en la directiva <literal>DirectoryIndex</literal>). <indexterm><primary><literal>Indexes</literal>, directiva de Apache</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>MultiViews</literal> activa la negociación de contenido; el servidor puede utilizar esto para proveer una página web que utilice el idioma preferido configurado en el navegador. <indexterm><primary><literal>MultiViews</literal>, directiva de Apache</primary></indexterm></para>
        </listitem>
      </itemizedlist>

      <para></para>

      <sidebar>
        <title><emphasis>VOLVER A LOS CIMIENTOS</emphasis> Archivo <filename>.htaccess</filename></title>

	<para>El archivo <filename>.htaccess</filename> contiene directivas de configuración de Apache que aplican cada vez que un pedido involucra un elemento del directorio en el que se encuentra este archivo. El alcance de estas directivas también incluye a sus subdirectorios.</para>
        <indexterm><primary><filename>.htaccess</filename></primary></indexterm>

	<para>La mayoría de las directivas que pueden ocurrir en un bloque <literal>Directory</literal> también son válidas en un archivo <filename>.htaccess</filename>.</para>
      </sidebar>

      <para>La directiva <literal>AllowOverride</literal> enumera todas las opciones que pueden ser activadas o desactivadas en un archivo <filename>.htaccess</filename>. Un uso común de esta opción es restringir <literal>ExecCGI</literal> para que los administradores puedan elegir los usuarios que podrán ejecutar programas bajo la identidad del servidor web (el usuario <literal>www-data</literal>).</para>
      <indexterm><primary><literal>AllowOverride</literal>, directiva de Apache</primary></indexterm>
      <section>
        <title>Autenticación obligatoria</title>
        <indexterm><primary>autenticación web</primary></indexterm>

	<para>En algunas cirucunstancia necesitará restringir el acceso a partes de un sitio web, de forma que sólo usuarios legítimos que provean un nombre de usuario y una contraseña tengan acceso al contenido.</para>

        <example>
          <title>Archivo <filename>.htaccess</filename> para autenticación obligatoria</title>

          <programlisting>
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private</programlisting>
        </example>

        <sidebar>
          <title><emphasis>SEGURIDAD</emphasis> Sin seguridad</title>

	  <para>El sistema de autenticación utilizado en el ejemplo anterior (<literal>Basic</literal>) tiene una seguridad mínima ya que se envía la contraseña en texto plano (codificada sólamente con <emphasis>base64</emphasis> que es sólo una codificación, no un método de cifrado). También debe saber que los documentos «protegidos» por este mecanismo también son enviados sin cifrar a través de la red. Si la seguridad es importante, debe cifrar la conexión HTTP completa con SSL.</para>
        </sidebar>

	<para>El archivo <filename>/etc/apache2/authfiles/htpasswd-private</filename> contiene una lista de usuarios y contraseñas; usualmente lo manipulará con el programa <command>htpasswd</command>. Por ejemplo, ejecute lo siguiente para agregar un usuario o cambiar su contraseña: <indexterm><primary><command>htpasswd</command></primary></indexterm></para>

        <screen>
<computeroutput># </computeroutput><userinput>htpasswd /etc/apache2/authfiles/htpasswd-private <replaceable>usuario</replaceable>
</userinput><computeroutput>New password:
Re-type new password:
Adding password for user <replaceable>usuario</replaceable>
</computeroutput></screen>
      </section>
      <section>
        <title>Restricción de acceso</title>
        <indexterm><primary>restricción de acceso web</primary></indexterm>

	<para>Las directiva <literal>Require</literal> controla las restricciones de acceso a un directorio (y sus subdirectorios de forma recursiva).</para>

	<indexterm><primary>Apache, directivas</primary></indexterm>
	<indexterm><primary>directivas Apache</primary></indexterm>
	<indexterm><primary><literal>Require</literal>, directiva de Apache</primary></indexterm>

	<para>Puede usarse para restringir el acceso basado en varios criterios; Pararemos describiendo la restricción de acceso basada en la dirección IP del cliente, pero puede realizarse de un modo mucho más potente que eso, especificando varias directivas <literal>Require</literal> combinadas con un bloque <literal>RequireAll</literal>.</para>

        <example>
          <title>Sólo  permitir desde la red local</title>

          <programlisting>Require ip 192.168.0.0/16</programlisting>
        </example>

      <sidebar>
        <title><emphasis>ALTERNATIVA</emphasis> Sintaxis antigua</title>

        <para>La sintaxis <literal>Require</literal> sólo está disponible en Apache 2.4 (la versión que se encuentra en <emphasis role="distribution">Jessie</emphasis>). Para los usuarios de <emphasis role="distribution">Wheezy</emphasis>, la sintaxis de Apache 2.2 es diferente, y la describiremos aquí principalmente como referencia, aunque también puede estar disponible en Apache 2.4 haciendo uso del módulo <literal>mod_access_compat</literal>.</para>

	<para>Las directivas <literal>Allow from</literal> y <literal>Deny from</literal> controlan las restricciones de acceso a un directorio (y sus subdirectorios de forma recursiva).</para>

	<indexterm><primary><literal>Allow from</literal>, directiva de Apache</primary></indexterm>
	<indexterm><primary><literal>Deny from</literal>, directiva de Apache</primary></indexterm>
	<indexterm><primary><literal>Order</literal>, directiva de Apache</primary></indexterm>

	<para>La directiva <literal>Order</literal> le indica al servidor el orden en el que aplicar las directivas <literal>Allow from</literal> y <literal>Deny from</literal>; la última que coincida tiene precedencia. En términos concretos, <literal>Order deny,allow</literal> permite acceso si no coincide ninguna regla <literal>Deny from</literal> o si coincide una directiva <literal>Allow from</literal>. A la inversa, <literal>Order allow,deny</literal> rechaza el acceso si no coincide ninguna directiva <literal>Allow from</literal> (o si coincide una directiva <literal>Deny from</literal>).</para>

	<para>A las directivas <literal>Allow from</literal> y <literal>Deny from</literal> le puede seguir una dirección IP, una red (como <literal>192.168.0.0/255.255.255.0</literal>, <literal>192.168.0.0/24</literal> o inclusive <literal>192.168.0</literal>), un nombre de equipo o nombre de dominio o la palabra clave <literal>all</literal> que incluye a todos.</para>

        <para>Por ejemplo, para rechazar conexiones de forma predeterminada pero permitir las que provienen de la red local podría usar esto:</para>
        <programlisting>
Order deny,allow
Allow from 192.168.0.0/16
Deny from all</programlisting>
        </sidebar>
      </section>
    </section>
    <section>
      <title>Analizadores de registros</title>

      <para>Generalmente se instala un analizador de registros en un servidor web; ya que éste provee a los administradores una idea precisa sobre los patrones de uso del servidor.</para>

      <para>Los administradores de Falcot Corp seleccionaron <emphasis>AWStats</emphasis> (estadísticas web avanzadas: «<emphasis>Advanced Web Statistics</emphasis>) para analizar sus archivos de registro de Apache.</para>
      <indexterm><primary><emphasis>AWStats</emphasis></primary></indexterm>
      <indexterm><primary>analizador de registros web</primary></indexterm>
      <indexterm><primary>registros</primary><secondary>analizador de registros web</secondary></indexterm>
      <indexterm><primary>analizador de registros web</primary></indexterm>

      <para>El primer paso de configuración es personalizar el archivo <filename>/etc/awstats/awstats.conf</filename>. Los administradores de Falcot lo mantuvieron sin cambios más que los siguientes parámetros:</para>

      <programlisting>
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</programlisting>

      <para>Todos estos parámetros están documentados con comentarios en el archivo de la plantilla. En particular, los parámetros <varname>LogFile</varname> y <varname>LogFormat</varname> describen la ubicación y el formato del archivo de registros y la información que contiene; <varname>SiteDomain</varname> y <varname>HostAliases</varname> enumeran los varios nombres con los que se conocerá el sitio web principal.</para>

      <para>En sitios con mucho tráfico, no debería definir <varname>DNSLookup</varname> como <literal>1</literal>; para sitios más pequeños, como el de Falcot ya descripto, esta configuración permite conseguir reportes más legibles que incluyen nombres completos de equipos en lugar de sólo direcciones IP.</para>

      <sidebar>
        <title><emphasis>SEGURIDAD</emphasis> Acceso a las estadísticas</title>

	<para>De forma predeterminada AWStats genera estadísticas disponibles en el sitio web sin restricciones, pero puede configurarlas para que sólo unas pocas direcciones IP (probablemente internas) puedan accederlas; necesita definir la lista de direcciones IP permitidas en el parámetro <varname>ALlowAccessFromWebToFollowingIPAddresses</varname></para>
      </sidebar>

      <para>AWStats también estará activo para otros servidores virtuales; cada servidor virtual necesita su propio archivo de configuración, como <filename>/etc/awstats/awstats.www.falcot.org.conf</filename>.</para>

      <example>
        <title>Archivo de configuración de AWStats para un servidor virtual</title>

        <programlisting>
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"</programlisting>
      </example>

      <para>AWStats utiliza varios íconos almacenados en el directorio <filename>/usr/share/awstats/icon/</filename>. Para que éstos estén disponibles en el sitio web, necesita adaptar la configuración de Apache para incluir la siguiente directiva:</para>

      <programlisting>
Alias /awstats-icon/ /usr/share/awstats/icon/</programlisting>

      <para>Luego de unos minutos (y una vez que el script ejecutó varias veces), los resultados estarán disponibles en el sitio web: <ulink type="block" url="http://www.falcot.com/cgi-bin/awstats.pl" /><ulink type="block" url="http://www.falcot.org/cgi-bin/awstats.pl" /></para>

      <sidebar>
        <title><emphasis>PRECAUCIÓN</emphasis> Rotación de archivos de registro</title>

	<para>Para que las estadísticas tengan en cuenta todos los registros, <emphasis>AWStats</emphasis> necesita ejecutar justo antes que se roten los archivos de registro de Apache. Teniendo en cuenta la directiva <literal>prerotate</literal> del archivo <filename>/etc/logrotate.d/apache2</filename>, puede solucionarlo agregando un enlace simbólico a <filename>/usr/share/awstats/tools/update.sh</filename> en <filename>/etc/logrotate.d/httpd-prerotate</filename>:</para>

        <screen><computeroutput>$ </computeroutput><userinput>cat /etc/logrotate.d/apache2
</userinput><computeroutput>/var/log/apache2/*.log {
  daily
  missingok
  rotate 14
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    if /etc/init.d/apache2 status &gt; /dev/null ; then \
      /etc/init.d/apache2 reload &gt; /dev/null; \
    fi;
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ </computeroutput><userinput>sudo mkdir -p /etc/logrotate.d/httpd-prerotate
</userinput><computeroutput>$ </computeroutput><userinput>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats
</userinput></screen>

	<para>Sepa también que los archivos de registro creados por <command>logrotate</command> necesitan ser legibles por todos, especialmente AWStats. En el ejemplo anterior, se garantiza esto con la línea <literal>create 644 root adm</literal> (en lugar de los permisos predeterminados <literal>640</literal>).</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.ftp-file-server">
    <title>Servidor de archivos FTP</title>
    <indexterm><primary>FTP (<emphasis>File Transfer Protocol</emphasis>)</primary></indexterm>

    <para>FTP (<emphasis>protocolo de transferencia de archivos</emphasis>: «File Transfer Protocol») es uno de los primeros protocolos de Internet (¡RFC 959 fue publicado en 1985!). Era utilizado para distribuir archivos antes que naciera la web (se creó el protocolo HTTP en 1990, y su versión 1.0 fue formalmente definida en el RFC 1945 publicado en 1996).</para>

    <para>El protocolo permite tanto subir como descargar archivos; por esta razón, todavía continúa siendo utilizado para desplegar actualizaciones a un sitio web almacenado por nuestro proveedor de Internet (o cualquier otra entidad que almacene sitios web). En estos casos, se fuerza el acceso seguro con un identificador de usuario y una contraseña; si éste es exitoso, el servidor FTP proporciona acceso de lectura y escritura al directorio del usuario.</para>

    <para>Otros servidores FTP son utilizados principalmente para distribuir archivos para descargar públicamente; los paquetes Debian son un buen ejemplo. Se obtiene el contenido de estos servidores desde otros servidores, geográficamente remotos; luego éstos estarán disponibles para usuarios menos distantes. Esto significa que no necesita autenticación del cliente; como consecuencia, se conoce este modo de operación como «FTP anónimo». Para ser perfectamente correcto, los clientes sí se autentican con el nombre de usuario <literal>anonymous</literal> («anónimo»); la contraseña es generalmente, por convención, la dirección de correo del usuario, pero el servidor la ignora.</para>

    <para>Hay muchos servidores FTP disponibles en Debian (<emphasis role="pkg">ftpd</emphasis>, <emphasis role="pkg">proftpd-basic</emphasis>, <emphasis role="pkg">ftpd</emphasis>, etc.). Los administradores de Falcot Corp seleccionaron <emphasis role="pkg">vsftpd</emphasis> porque sólo utilizan el servidor FTP para distribuir unos pocos archivos (incluyendo un repositorio de paquetes Debian); como no necesitan funcionalidades avanzadas, eligieron enfocarse en los aspectos de seguridad.</para>
    <indexterm><primary><emphasis role="pkg">vsftpd</emphasis></primary></indexterm>

    <para>Instalar el paquete crea un usuario de sistema <literal>ftp</literal>. Siempre se utiliza esta cuenta para conexiones FTP anónimas, y su directorio personal (<filename>/srv/ftp/</filename>) es la raíz del árbol al que tienen acceso los usuarios que se conecten a este servicio. La configuración predeterminada (en <filename>/etc/vsftpd.conf</filename>) requiere algunso cambios para permitir poner a disposición archivos grandes para su descarga pública: es necesario habilitar el acceso anonimo (<literal>anonymous_enable=YES</literal>) y se debe desactivar el acceso (de sólo lectura) para los usuarios locales  (<literal>local_enable=NO</literal>). Este último punto es particularmente importante, puesto que el protocolo FTP no utiliza cifrado y podría interceptarse la contraseña de los usuario a través de la red.</para>
  </section>
  <section id="sect.nfs-file-server">
    <title>Servidor de archivos NFS</title>

    <para>NFS (<emphasis>sistema de archivos de red</emphasis>: «Network File System») es un protocolo que permite acceso remoto a un sistema de archivos a través de la red. Todos los sistemas Unix pueden trabajar con este protocolo; cuando se involucran sistemas Windows, debe utilizar Samba en su lugar.</para>
    <indexterm><primary>NFS</primary></indexterm>
    <indexterm><primary><emphasis>red</emphasis></primary><secondary><emphasis>sistema de archivos</emphasis></secondary></indexterm>
    <indexterm><primary>sistema de archivos</primary><secondary>red</secondary></indexterm>
    <indexterm><primary>archivo</primary><secondary>servidor</secondary></indexterm>
    <indexterm><primary>servidor</primary><secondary>archivo</secondary></indexterm>

    <para>NFS es una herramienta muy útil. Si bien anteriormente ha tenido muchas limitaciones, la mayoría ha desaparecido con la versión 4 del protocolo. El inconveniente es qu ela última versión de NFS e más díficil de configurar cuando se quieren utilizar funciones básicas de seguridad como la autenticación y el cifrado, puesto que se basa en Kerberos para estas funcionalidades. Sin éstas, el protocolo NFS tiene que restringirse a la utilización en una red local de confianza puesto que los datos que circulan por la red no están cifrados (un <emphasis><foreignphrase>sniffer</foreignphrase></emphasis> los puede interceptar) y los permisos de acceso se conceden en función de la dirección IP del cliente (que puede ser suplantada).</para>

    <sidebar>
      <title><emphasis>DOCUMENTACIÓN</emphasis> «HOWTO» de NFS</title>

      <para>Es relativamente complicado encontrar buena documentación acerca de NFSv4. Incluímos aquí algunos enlaces con explicaciones de distinta calidad que al menos proporcionan algunas pistas (en inglés) sobre lo que debe hacerse. <ulink type="block" url="https://help.ubuntu.com/community/NFSv4Howto" /> <ulink type="block" url="http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration" /></para>
    </sidebar>
    <section>
      <title>Protección de NFS</title>
      <indexterm><primary>NFS</primary><secondary>seguridad</secondary></indexterm>

      <para>Si no se utilizan las características de seguridad basadas en Kerberos, debería asegurarse de que sólo los equipos autorizados a utilizar NFS puedan conectarse a los varios servidores RPC necesarios, porque el protocolo básico confía en la información recibida a través de la red. El firewall debería por tanto prohibir la <emphasis>usurpación de IPs</emphasis> («IP spoofing») para prevenir que una máquina externa se haga pasar por una interna y el acceso a los puertos apropiados debería estar restringido únicamente a los equipos que deban acceder a espacios compartidos por NFS.</para>

      <sidebar>
        <title><emphasis>VOLVER A LOS CIMIENTOS</emphasis> RPC</title>

	<para>RPC (<emphasis>llamada a procedimiento remoto</emphasis>: «Remote Procedure Call») es un estándar Unix para servicios remotos. NFS es uno de esos servicios.</para>
        <indexterm><primary>RPC</primary></indexterm>
        <indexterm><primary><emphasis>Remote Procedure Call</emphasis></primary></indexterm>

	<para>Los servicios RPC se registran en un directorio conocido como <emphasis>portmapper</emphasis> («asociador de puertos»). Un cliente que desee realizar una consulta NFS primero debe dirigirse al <emphasis>portmapper</emphasis> (en el puerto 111, TCP o UDP) y preguntar por el servidor NFS; la respuesta generalmente mencionará el puerto 2049 (el predeterminado para NFS). No todos los servicios RPC utilizan un puerto fijo necesariamente.</para>
      </sidebar>

      <para>Las versiones antiguas del protocolo requerían otros servicios RPC que utilizaban puertos asignados dinámicamente. Afortunadamente, con la versíon 4 de NFS solo son necesarios los puertos 2049 (para el NFS propiamente) y el 111 (para el <foreignphrase>portmapper</foreignphrase>), por lo que son fáciles de filtrar mediante un cortafuegos.</para>
      <indexterm><primary><command>portmapper</command></primary></indexterm>

    </section>
    <section>
      <title>Servidor NFS</title>

      <para>El servidor NFS es parte del núcleo Linux; en los núcleos que Debian provee está compilado como un módulo de núcleo. Si necesita ejecutar el servidor NFS automáticamente al iniciar, debe instalar el paquete <emphasis role="pkg">nfs-kernel-server</emphasis>; contiene los scripts de inicio relevantes.</para>

      <para>El archivo de configuración del servidor NFS, <filename>/etc/exports</filename>, enumera los directorios que estarán disponibles en la red (<emphasis>exportados</emphasis>). Para cada espacio compartido NFS, sólo tendrán acceso las máquinas especificadas. Puede obtener un control más detallado con unas pocas opciones. La sintaxis para este archivo es bastante simple:</para>
      <indexterm><primary><filename>exports</filename></primary></indexterm>
      <indexterm><primary><filename>/etc/exports</filename></primary></indexterm>

      <programlisting>
/directorio/a/compartir maquina1(opcion1,opcion2,...) maquina2(...) ...</programlisting>

      <para>Es importante recalcar que con NFSv4 todas las carpetas exportadas deben ser parte de un único arbol de directorios y que el directorio raiz  de este arbol debe ser exportado e identificado con la opción <literal>fsid=0</literal> o <literal>fsid=root</literal>.</para>

      <para>Puede identificar cada máquina mediante su nombre DNS o su dirección IP. También puede especificar conjuntos completos de máquinas utilizando una sintaxis como <literal>*.falcot.com</literal> o un rango de direcciones IP <literal>192.168.0.0/255.255.255.0</literal> o <literal>192.168.0.0/24</literal>.</para>

      <para>De forma predeterminada (o si utiliza la opción <literal>ro</literal>), los directorios están disponibles sólo para lectura. La opción <literal>rw</literal> permite acceso de lectura y escritura. Los clientes NFS típicamente se conectan desde un puerto restringido sólo a root (en otras palabras, menor a 1024); puede eliminar esta restricción con la opción <literal>insecure</literal> (la opción <literal>secure</literal> es implícita, pero puede hacerla explícita para más claridad).</para>
      <indexterm><primary>NFS</primary><secondary>opciones</secondary></indexterm>

      <para>De forma predeterminada, el servidor sólo responderá a peticiones NFS cuando se complete la operación actual de disco (la opción <literal>sync</literal>); puede desactivar esta funcionalidad con la opción <literal>async</literal>. Las escrituras asíncronas aumentarán un poco el rendimiento a cambio de una disminución de la fiabilidad, debido al riesgo de pérdida de datos en caso de un cierre inesperado del servidor durante el tiempo que transcurre entre que se recibe la petición de escritura y cuando los datos hayan sido escritos realmente en el disco. Debido a que el valor predeterminado cambió recientemente (comparado con el valor histórico de NFS), se recomienda configurarlo explícitamente.</para>

      <para>Para no proveerle acceso de root al sistema de archivos a ningún cliente NFS, el servidor considerará todas las consultas que parezcan provenir de un usuario root como si provinieran del usuario <literal>nobody</literal>. Este comportamiento corresponde a la opción <literal>root_squash</literal> y está activado de forma predeterminada. La opción <literal>no_root_squash</literal>, que desactiva este comportamiento, es riesgosa y sólo debe ser utilizada en entornos controlados. Las opciones <literal>anonuid=<replaceable>uid</replaceable></literal> y <literal>anongid=<replaceable>gid</replaceable></literal> permiten especificar otro usuario falso que será utilizado en lugar deñ UID/GID 65534 (que corresponden al usuario <literal>nobody</literal> y al grupo <literal>nogroup</literal>).</para>

      <para>Con NFSv4 se puede añadir la opción <literal>sec</literal> para precisar el nivel de seguridad deseado: <literal>sec=sys</literal> es el valor predeterminado sin ningún tipo de seguridad particular,  <literal>sec=krb5</literal> habilita únicamente la autenticación, <literal>sec=krb5i</literal> añade una protección de integridad y <literal>sec=krb5p</literal> es el nivel más alto, que incluye la protección de la confidencialidad (mediante el cifrado de datos). Para que todo esto pueda funcionar es necesaria una instalación funcional de Kerberos (este libro no se trata en este libro).</para>

      <para>Existen otras opciones disponibles; están documentadas en la página de manual <citerefentry><refentrytitle>exports</refentrytitle> <manvolnum>5</manvolnum></citerefentry>.</para>

      <sidebar>
        <title><emphasis>PRECAUCIÓN</emphasis> Primera instalación</title>

	<para>El script de inicio <filename>/etc/init.d/nfs-kernel-server</filename> sólo inicia el servidor si el archivo <filename>/etc/exports</filename> incluye al menos uno o más espacios compartidos NFS válidos. En la configuración inicial, una vez que editó este archivo para que contenga elementos válidos, deberá iniciar el servidor NFS ejecutando lo siguiente:</para>

        <screen>
<computeroutput># </computeroutput><userinput>service nfs-kernel-server start</userinput></screen>
      </sidebar>
    </section>
    <section>
      <title>Cliente NFS</title>
      <indexterm><primary>cliente</primary><secondary>NFS</secondary></indexterm>
      <indexterm><primary>NFS</primary><secondary>cliente</secondary></indexterm>

      <para>Como con cualquier otro sistema de archivos, incorporar un espacio compartido NFS en el jerarquía del sistema es necesario montarlo. Debido a que este sistema de archivos tiene sus peculiaridades fueron necesarios unos pocos ajustes en la sintaxis de <command>mount</command> y en el archivo <filename>/etc/fstab</filename>.</para>

      <example>
        <title>Montaje manual con el programa <command>mount</command></title>

        <screen>
          <computeroutput># </computeroutput><userinput>mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/shared</userinput></screen>
      </example>

      <example>
        <title>Elemento NFS en el archivo <filename>/etc/fstab</filename></title>

        <programlisting>
arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0 0</programlisting>
      </example>

      <para>El elemento descrito monta automáticamente en cada arranque del sistema el directorio NFS <filename>/shared/</filename> desde el servidor <literal>arrakis</literal> en el directorio local <filename>/srv/shared/</filename>. Se solicita acceso de lectura y escritura (de ahí el parámetro <literal>rw</literal>). La opción <literal>nosuid</literal> es una medida de protección que elimina cualquier bit <literal>setuid</literal> o <literal>setgid</literal> de los programas almacenados en el espacio compartido. Si el espacio compartido NFS está destinado únicamente a almacenar documentos, también se recomienda utilizar la opción <literal>noexec</literal>, que evita la ejecución de programas almacenados en el espacio compartido. Es importante tener en en cuenta que, en el servidor, el directorio <filename>shared</filename> se encuentra dentro del directorio exportado como raiz de NFSv4 (por ejemplo <filename>/export/shared</filename>), no es un directorio de primer nivel.</para>

      <para>La página de manual <citerefentry><refentrytitle>nfs</refentrytitle> <manvolnum>5</manvolnum></citerefentry> describe todas las opciones con algo de detalle.</para>
    </section>
  </section>
  <section id="sect.windows-file-server-with-samba">
    <title>Configuración de espacios compartidos Windows con Samba</title>

    <para>Samba es un conjunto de herramientas que administran el protocolo SMB (también conocido como «CIFS») en Linux. Windows utiliza este protocolo para espacios compartidos de red e impresoras compartidas.</para>
    <indexterm><primary>Windows, espacio compartido</primary></indexterm>
    <indexterm><primary>Samba</primary></indexterm>
    <indexterm><primary>SMB</primary></indexterm>
    <indexterm><primary>CIFS</primary></indexterm>
    <indexterm><primary>servidor</primary><secondary>archivo</secondary></indexterm>

    <para>Samba también puede actuar como un controlador de dominio Windows. Esta es una herramienta sobresaliente para asegurar una integración perfecta entre servidores Linux y las máquinas de escritorios en las oficinas que todavía utilizan Windows.</para>
    <section>
      <title>Servidor Samba</title>

      <para>El paquete <emphasis role="pkg">samba</emphasis> contiene los dos servidores principales de Samba 4: <command>smbd</command> y <command>nmbd</command>.</para>
      <indexterm><primary><command>smbd</command></primary></indexterm>
      <indexterm><primary><command>nmbd</command></primary></indexterm>

      

      <sidebar>
        <title><emphasis>DOCUMENTACIÓN</emphasis> Yendo más allá</title>

	<para>El servidor Samba es extremadamente configurable y versátil y puede adaptarse a muchos casos de uso diferentes con requisitos y arquitecturas de red muy distintas. Este libro se centrará en el uso de Samba como un servidor autónomo, pero también puede utilizarse como controlador de un dominio NT4, como controlador de un dominio basado en Active Directory o también como un simple servidor integrado en un dominio ya existente (que puede estar gestionado por un servidor Windows).</para>
        <indexterm><primary>controlador de dominio</primary></indexterm>
        <indexterm><primary>Windows, dominio</primary></indexterm>

	<para>El paquete <emphasis role="pkg">samba-doc</emphasis> package contiene una gran cantidad de archivos de ejemplo comentados en <filename>/usr/share/doc/samba-doc/examples/</filename>.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>HERRAMIENTA</emphasis> Autenticación con un servidor Windows</title>

	<para>Winbind provee a los administradores de sistemas la opción de utilizar un servidor Windows como servidor de autenticación. Winbind también se integra limpiamente con PAM y NSS. Esto permite configurar máquinas Linux en las que todos los usuarios de un dominio Windows automáticamente tienen una cuenta.</para>
        <indexterm><primary>Winbind</primary></indexterm>

	<para>Puede encontrar más información en el directorio <filename>/usr/share/doc/samba-doc/examples/pam_winbind/</filename>.</para>
      </sidebar>
      <section>
        <title>Configuración con <command>debconf</command></title>

	<para>El paquete define una configuración mínima durante la instalación inicial. No obstante es muy recomendable adaptar la configuración a posteriori ejecutando la orden <command>dpkg-reconfigure samba-common</command>.</para>

	<para>Lo primero que tenemos que configurar es el nombre del grupo de trabajo al que pertenecerá el servidor Samba (en el caso de Falcot, la respuesta es <literal>FALCOTNET</literal>).</para>

	<para>El paquete también propone identificar el servidor WINS de la información provista por el demonio DHCP. Los administradores de Falcot Corp rechazaron esta opción ya que pretenden utilizar el servidor Samba en sí como servidor WINS.</para>
        <indexterm><primary>WINS</primary></indexterm>
      </section>
      <section>
        <title>Configuración manual</title>
        <section>
          <title>Cambios en <filename>smb.conf</filename></title>

	  <para>Los requisitos en Falcotr requieren modificar otras opciones en el archivo de configuración <filename>/etc/samba/smb.conf</filename>. Los siguientes extractos resumen los cambios realizados en la sección <literal>[global]</literal>.</para>

          <programlisting>
[global]

## Browsing/Identification ###

# Change this to the workgroup/NT-domain name your Samba server will part of
   workgroup = FALCOTNET

# Windows Internet Name Serving Support Section:
# WINS Support - Tells the NMBD component of Samba to enable its WINS Server
   wins support = yes <co id="smb.conf.wins"></co>

[...]

####### Authentication #######

# Server role. Defines in which mode Samba will operate. Possible
# values are "standalone server", "member server", "classic primary
# domain controller", "classic backup domain controller", "active
# directory domain controller". 
#
# Most people will want "standalone sever" or "member server".
# Running as "active directory domain controller" will require first
# running "samba-tool domain provision" to wipe databases and create a
# new domain.
   server role = standalone server

# "security = user" is always a good idea. This will require a Unix account
# in this server for every user accessing the server.
   security = user <co id="smb.conf.security"></co>

[...]</programlisting>
          <calloutlist>
            <callout arearefs="smb.conf.wins">
	      <para>Indica que Samba debe funcionar como un servidor de nombres Netbios (WINS) para la red local.</para>
            </callout>
            <callout arearefs="smb.conf.security">
	      <para>Este es el valor predeterminado para este parámetro; sin embargo, como es central a la configuración de Samba, se recomienda rellenarlo explícitamente. Cada usuario debe autenticarse antes de acceder a cualquier espacio compartido.</para>
            </callout>
          </calloutlist>
        </section>
        <section>
          <title>Añadir usuarios</title>

	  <para>Cada usuario Samba necesita una cuenta en el servidor; primero debe crear las cuentas Unix, luego necesita registrar el usuario en la base de datos de Samba. El paso de Unix se realiza de la forma normal (por ejemplo, utilizando <command>adduser</command>).</para>

	  <para>Agregar un usuario existente a la base de datos de Samba sólo es cuestión de ejecutar <command>smbpasswd -a <replaceable>usuario</replaceable></command>; esto pedirá la contraseña de forma interactiva.</para>

	  <para>Puede eliminar un usuario ejecutando <command>smbpasswd -x <replaceable>usuario</replaceable></command>. También puede desactivar temporalmente una cuenta Samba (con <command>smbpasswd -d <replaceable>usuario</replaceable></command>) y reactivarla después (con <command>smbpasswd -e <replaceable>usuario</replaceable></command>).</para>
        </section>
      </section>
    </section>
    <section>
      <title>Cliente Samba</title>

      <para>La funcionalidad de cliente en Samba le permite a una máquina Linux acceder a espacios e impresoras compartidas en Windows. Los programas necesarios se encuentran en los paquetes <emphasis role="pkg">cifs-utils</emphasis> y <emphasis role="pkg">smbclient</emphasis>.</para>
      <indexterm><primary><emphasis>smbclient</emphasis></primary></indexterm>
      <indexterm><primary><emphasis>cifs-utils</emphasis></primary></indexterm>
      <section>
        <title>El programa <command>smbclient</command></title>

	<para>El programa <command>smbclient</command> consulta servidores SMB. Puede utilizarse la opción <literal>-U <replaceable>usuario</replaceable></literal>, para conectarse con el servidor bajo una identidad concreta. Con <command>smbclient //<replaceable>servidor</replaceable>/<replaceable>espaciocompartido</replaceable></command> se accede al espacio compartido de modo interactivo como si se tratara de un cliente FTP en una consola. <command>smbclient -L <replaceable>servidor</replaceable></command> enumerará todos los espacios compartidos (y visibles) en un servidor.</para>
      </section>
      <section>
        <title>Montaje de espacios compartidos de Windows</title>

	<para>El programa <command>mount</command> permite montar un espacio compartido de Windows en la jerarquía del sistema de archivos de Linux (con la ayuda de <command>mount.cifs</command> provisto por <emphasis role="pkg">cifs-utils</emphasis>).</para>
        <indexterm><primary><command>mount.cifs</command></primary></indexterm>
	<indexterm><primary>Windows, montaje de espacio compartido</primary></indexterm>

        <example>
          <title>Montaje de un espacio compartido de Windows</title>

          <programlisting>
mount -t cifs //arrakis/shared /shared \
      -o credentials=/etc/smb-credentials</programlisting>
        </example>

	<para>El archivo <filename>/etc/smb-credentials</filename> (que no debe ser accesible por usuarios) tiene el siguiente formato:</para>

        <programlisting>
username = <replaceable>usuario</replaceable>
password = <replaceable>contraseña</replaceable></programlisting>

	<para>Puede especificar otras opciones en la línea de órdenes; la lista completa se encuentra disponible en la página de manual <citerefentry><refentrytitle>mount.cifs</refentrytitle> <manvolnum>1</manvolnum></citerefentry>. Dos opciones en particular pueden ser interesantes: <literal>uid</literal> y <literal>gid</literal> que permiten forzar el usuario y grupo dueños de los archivos disponibles en el punto de montaje para no restringir el acceso a root.</para>

	<para>También puede configurar el montaje de un espacio compartido Windows en <filename>/etc/fstab</filename>:</para>

        <programlisting>
//<replaceable>servidor</replaceable>/shared /shared cifs credentials=/etc/smb-credentials</programlisting>

	<para>Puede desmontar un espacio compartido SMB/CIFS con el programa <command>umount</command> estándar.</para>
      </section>
      <section>
        <title>Impresión en una impresora compartida</title>

	<para>CUPS es una solución elegante para imprimir desde una estación de trabajo Linux en una impresora compartida por una máquina Windows. Cuando instale <emphasis role="pkg">smbclient</emphasis>, CUPS le permitirá instalar impresoras compartidas Windows de forma automática.</para>
        <indexterm><primary>impresión</primary><secondary>red</secondary></indexterm>

	<para>Los pasos necesarios son los siguientes:</para>
        <itemizedlist>
          <listitem>
	    <para>Introduzca la interfaz dec configuración CUPS: <literal>http://localhost:631/admin</literal></para>
          </listitem>
          <listitem>
	    <para>Pulse en «Agregar impresora».</para>
          </listitem>
          <listitem>
	    <para>Seleccione el dispositivo de impresión, elija «Impresora Windows via SAMBA».</para>
          </listitem>
          <listitem>
	    <para>Introduzca la URI de conexión para la impresora de red. Debería ser similar a la siguiente:</para>
	   
	    <para><literal>smb://<replaceable>usuario</replaceable>:<replaceable>contraseña</replaceable>@<replaceable>servidor</replaceable>/<replaceable>impresora</replaceable></literal>.</para>
          </listitem>
	  <listitem>
	    <para>Introduzca el nombre que identificará unívocamente a esta impresora. Luego introduzca la descripción y la ubicación de la impresora. Se mostrarán estas cadenas a los usarios para ayudarlos a identificar las impresoras.</para>
	  </listitem>
	  <listitem>
	    <para>Indique el fabricante/modelo de la impresora o, directamente, provea un archivo de descripción de impresora (PDD: «Printer Description File») funcional.</para>
	  </listitem>
        </itemizedlist>

	<para>Voilà, ¡la impresora ya está lista!</para>
      </section>
    </section>
  </section>
  <section id="sect.http-ftp-proxy">
    <title>Proxy HTTP/FTP</title>

    <para>Un proxy HTTP/FTP funciona como intermediaro para conexiones HTTP y/o FTP. Su rol es doble:</para>
    <itemizedlist>
      <listitem>
	<para>Actuar como caché: los documentos que han sido descargados recientemente son copiados localmente para evitar múltiples descargas.</para>
      </listitem>
      <listitem>
	<para>Servidor de filtro: si el uso del proxy es obligatorio (y se bloquean las conexiones salientes a menos que sean a través del proxy), entonces el proxy puede determinar si se permite o no el pedido.</para>
      </listitem>
    </itemizedlist>
    <indexterm><primary>proxy HTTP/FTP</primary></indexterm>
    <indexterm><primary>caché proxy</primary></indexterm>

    <para>Falcot Corp eligió a Squid como su servidor proxy.</para>
    <indexterm><primary>Squid</primary></indexterm>
    <section>
      <title>Instalación</title>

      <para>El paquete Debian <emphasis role="pkg">squid3</emphasis> sólo contiene el proxy (caché) modular. Para convertirlo en un servidor de filtro necesitará instalar el paquete adicional <emphasis role="pkg">squidguard</emphasis>. Además, <emphasis role="pkg">squid-cgi</emphasis> provee una interfaz de consulta y administración para un proxy Squid.</para>

      <para>Antes de instalarlo, debe asegurarse que el sistema pueda identificar su propio nombre completo: <command>hostname f</command> debe devolver el nombre completamente calificado (incluyendo el dominio). Si no lo hace, entonces debe editar el archivo <filename>/etc/hosts</filename> para que contenga el nombre completo del sistema (por ejemplo, <literal>arrakis.falcot.com</literal>). El nombre oficial del equipo debe ser validado con el administrador de la red para evitar posibles conflictos de nombre.</para>
    </section>
    <section>
      <title>Configuración de un caché</title>

      <para>Activar la funcionalidad de servidor de caché es tan simple como editar el archivo de configuración <filename>/etc/squid3/squid.conf</filename> y permitir que las máquinas en la red local realicen consultas a través del proxy. El siguiente ejemplo muestra las modificaciones realizadas por los administradores de Falcot Corp:</para>

      <example>
        <title>El archivo <filename>/etc/squid3/squid.conf</filename> (extractos)</title>

        <programlisting>
# AGREGUE SUS PROPIAS REGLAS AQUÍ PARA PERMITIR ACCESO DE SUS CLIENTES

# Regla de ejemplo que permite acceso desde su red local. Adáptela
# para incluir sus redes IP (internas) desde las que se debe
# permitir navegar
acl our_networks src 192.168.1.0/24 192.168.2.0/24
http_access allow our_networks
http_access allow localhost
# Finalmente, negar todo otro acceso a este proxy
http_access deny all</programlisting>
      </example>
    </section>
    <section>
      <title>Configuración de un filtro</title>

      <para><command>squid</command> por sí mismo no realiza el filtrado; esta acción es delegada a <command>squidGuard</command>. Debe configurar el primero para que interactúe con este último. Esto incluye agregar la siguiente directiva en el archivo <filename>/etc/squid3/squid.conf</filename>:</para>
      <indexterm><primary><command>squidGuard</command></primary></indexterm>

      <programlisting>
url_rewrite_program /usr/bin/squidGuard -c /etc/squid3/squidGuard.conf </programlisting>

      <para>También necesita instalar el programa CGI <filename>/usr/lib/cgi-bin/squidGuard.cgi</filename> utilizando <filename>/usr/share/doc/squidguard/examples/squidGuard.cgi.gz</filename> como punto de partida. Las modificaciones necesarias a este script son las varialbes <varname>$proxy</varname> y <varname>$proxymaster</varname> (el nombre del proxy y el correo de contacto del administrador, respectivamente). Las variables <varname>$image</varname> y <varname>$redirect</varname> deben apuntar a imágenes existentes que representen el rechazo de una consulta.</para>

      <para>Debe ejecutar <command>service squid3 reload</command> para activar el filtro. Sin embargo, debido a que el paquete <emphasis role="pkg">squidguard</emphasis> no realiza ningún filtrado de forma predeterminada, corresponde al administrador definir una política. Puede hacerlo se debe crear el archivo <filename>/etc/squid3/squidGuard.conf</filename> (utilizando la plantilla <filename>/etc/squidguard/squidGuard.conf.default</filename> si lo desea).</para>

      <para>Debe regenerar la base de datos de trabajo con <command>update-squidguard</command> luego de cada modificación al archivo de configuración de <command>squidGuard</command> (o uno de las listas de dominios o URLs que menciona). La sintaxis del archivo de configuración se encuentra documentada en el siguiente sitio web: <ulink type="block" url="http://www.squidguard.org/Doc/configure.html" /></para>
      <indexterm><primary><command>update-squidguard</command></primary></indexterm>

      <sidebar>
        <title><emphasis>ALTERNATIVA</emphasis> DansGuardian</title>
        <indexterm><primary><emphasis role="pkg">dansguardian</emphasis></primary></indexterm>
        <indexterm><primary>PICS</primary></indexterm>

	<para>El paquete <emphasis role="pkg">dansguardian</emphasis> es una alternativa a <emphasis>squidguard</emphasis>. Este software no sólo gestiona una lista negra de URLs prohibidas, sino que puede aprovechar el sistema PICS (<emphasis>plataforma para selección de contenido en Internet</emphasis>: «Platform for Internet Content Selection») para decidir si una página es aceptable mediante el análisis dinámico de su contenido.</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.ldap-directory">
    <title>Directorio LDAP</title>
    <indexterm><primary>LDAP</primary></indexterm>
    <indexterm><primary>OpenLDAP</primary></indexterm>
    <indexterm><primary>directorio LDAP</primary></indexterm>

    <para>OpenLDAP es una implementación del protocolo LDAP; en otras palabras, es una base de datos de propósito especial diseñada para almacenar directorios (N.T. directorio en el sentido de directorio/agenda de personas, equipos o configuraciones, no directorio de un sistema de archivos). En el caso de uso más común, utilizar un servidor LDAP permite centralizar la administración de las cuentas de usuario y los permisos relacionados. Además se puede replicar fácilmente una base de datos LDAP, lo que permite configurar varios servidores LDAP sincronizados. Cuando la red y la cantidad de usuarios crecen rápidamente se puede balancear la carga entre varios servidores.</para>

    <para>Los datos LDAP son estructurados y jerárquicos. La estructura es definida por «esquemas» («schemas») que describen el tipo de objetos que la base de datos puede almacenar junto con una lista de todos sus atributos posibles. La sintaxis utilizada para hacer referencia a un objeto particular en la base de datos está basada en esta estructura, lo que explica su complejidad.</para>
    <section>
      <title>Instalación</title>

      <para>El paquete <emphasis role="pkg">slapd</emphasis> contiene el servidor OpenLDAP. El paquete <emphasis role="pkg">ldap-utils</emphasis> incluye herramientas de línea de órdenes para interactuar con servidores LDAP.</para>
      <indexterm><primary><emphasis>slapd</emphasis></primary></indexterm>

      <para>La instalación de <emphasis role="pkg">slapd</emphasis> normalmente solicita muy poca información, a menos que haya configurado debconf para que realice preguntas con menor prioridad. Afortunadamente basta ejecutar <command>dpkg-reconfigure slapd</command> para reconfigurar la base de datos LDAP más detalladamente:</para>
      <itemizedlist>
        <listitem>
	  <para>¿Evitar la configuración del servidor OpenLDAP? No, por supuesto que deseamos configurar este servicio.</para>
        </listitem>
        <listitem>
	  <para>Nombre de dominio DNS: «<literal>falcot.com</literal>».</para>
        </listitem>
        <listitem>
	  <para>Nombre de la organización: “Falcot Corp”.</para>
        </listitem>
        <listitem>
	  <para>Debe ingresar la contraseña de administración.</para>
        </listitem>
        <listitem>
	  <para>Base de datos a utilizar: «MDB».</para>
        </listitem>
        <listitem>
	  <para>¿Desea eliminar la base de datos cuando se purge <emphasis role="pkg">slapd</emphasis>? No. No tiene sentido arriesgarse a perder la base de datos por error.</para>
        </listitem>
        <listitem>
	  <para>¿Mover una base de datos anterior? Esta pregunta sólo es realizada cuando se intenta configurarlo y ya existe una base de datos. Sólo responda «yes» si realmente desea iniciar nuevamente desde una base de datos limpia; por ejemplo, si ejecuta <command>dpkg-reconfigure slapd</command> inmediatamente después de instalarlo por primera vez.</para>
        </listitem>
        <listitem>
	  <para>¿Permitir el protocol LDAPv2? No, no tiene sentido. Todas las herramientas que utilizaremos entienden el protocolo LDAPv3.</para>
        </listitem>
      </itemizedlist>

      <sidebar>
        <title><emphasis>VOLVER A LOS CIMIENTOS</emphasis> Formato LDIF</title>

	<para>Un archivo LDIF (<emphasis>formato de intercambios de datos LDAP</emphasis>: «LDAP Data Interchange Format») es un archivo de texto portable que describe el contenido de una base de datos LDAP (o una porción de la misma); puede utilizarlo para introducir datos en otro servidor LDAP.</para>
        <indexterm><primary>LDIF</primary></indexterm>
      </sidebar>

      <para>Ahora tiene configurada una base de datos mínima, como podrá ver con la siguiente consulta:</para>

      <screen>
<computeroutput>$ </computeroutput><userinput>ldapsearch -x -b dc=falcot,dc=com</userinput>
<computeroutput># extended LDIF
#
# LDAPv3
# base &lt;dc=falcot,dc=com&gt; with scope sub
# filter: (objectclass=*)
# requesting: ALL
#

# falcot.com
dn: dc=falcot,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Falcot Corp
dc: falcot

# admin, falcot.com
dn: cn=admin,dc=falcot,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2
</computeroutput></screen>

      <para>La consulta devolvió dos objetos: la organización en sí mismo y el usuario de administración.</para>
    </section>
    <section>
      <title>Relleno del directorio</title>

      <para>Debido a que una base de datos vacía no es particularmente útil, se trata ahora de integrar en ella todos los directorios existenes; esto incluye las bases de datos de usuarios, grupos, servicios y equipos.</para>

      <para>El paquete <emphasis role="pkg">migrationtools</emphasis> proporciona un conjunto de scripts para extraer los datos de los directorios estándar de Unix (<filename>/etc/passwd</filename>, <filename>/etc/group</filename>, <filename>/etc/services</filename>, <filename>/etc/hosts</filename>, etc.), convetir estos datos y agregarlos en la base de datos LDAP.</para>
      <indexterm><primary><emphasis role="pkg">migrationtools</emphasis></primary></indexterm>

      <para>Una vez que instaló el paquete, es necesario editar el archivo <filename>/etc/migrationtools/migrate_common.ph</filename>; debe activar las opciones <varname>IGNORE_UID_BELOW</varname> y <varname>IGNORE_GID_BELOW</varname> (descomentarlas es suficiente) y debe actualizar <varname>DEFAULT_MAIL_DOMAIN</varname>/<varname>DEFAULT_BASE</varname>.</para>

      <para>La operación de migración en sí es gestionada por el script <command>migrate_all_online.sh</command>, como sigue:</para>

      <screen>
<computeroutput># </computeroutput><userinput>cd /usr/share/migrationtools</userinput>
<computeroutput># </computeroutput><userinput>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</userinput></screen>

      <para><command>migrate_all_online.sh</command> realizará unas pocas preguntas sobre la base de datos LDAP a la que migrará los datos. La <xref linkend="tab-migrate-all" xrefstyle="select: label nopage" /> resume las respuestas dadas en el caso de uso de Falcot.</para>
 
      <table colsep="1" id="tab-migrate-all">
        <title>Respuestas a las preguntas del script <command>migrate_all_online.sh</command></title>
	<tgroup cols="2"><colspec align="justify"></colspec><colspec align="justify"></colspec>
	<thead>
	  <row><entry>Pregunta</entry><entry>Respuesta</entry></row>
	</thead>
	<tbody>
	  <row>
	    <entry>Contexto de nombre X.500</entry>
	    <entry><literal>dc=falcot,dc=com</literal></entry>
	  </row>
	  <row>
	    <entry>Nombre del servidor LDAP</entry>
	    <entry><literal>localhost</literal></entry>
	  </row>
	  <row>
	    <entry>Administrador del DN</entry>
	    <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
	  </row>
	  <row>
	    <entry>Credenciales Bind</entry>
	    <entry>la contraseña de administración</entry>
	  </row>
	  <row>
	    <entry>Crear DUAConfigProfile</entry>
	    <entry>no</entry>
	  </row>
	</tbody>
	</tgroup>
      </table>

      <para>Deliberadamente evitamos migrar el archivo <filename>/etc/aliases</filename>, ya que el esquema estándar provisto por Debian no incluye la estructura que utiliza este script para describir alias de correo. Si quisiéramos integrar estos datos en el directorio, debe agregar el archivo <filename>/etc/ldap/schema/misc.schema</filename> al esquema estándar.</para>

      <sidebar>
        <title><emphasis>HERRAMIENTA</emphasis> Navegación de un directorio LDAP</title>

	<para>El programa <command>jxplorer</command> (en el paquete del mismo nombre) es una herramienta gráfica que permite navegar y editar una base de datos LDAP. Es una herramienta interesante que proporciona al administrador una buena visión de la estructura jerárquica de los datos de LDAP.</para>
        <indexterm><primary><command>jxplorer</command></primary></indexterm>
      </sidebar>

      <para>Sepa también que el programa <command>ldapadd</command> tiene una opción <literal>-c</literal>; esta opción solicita que no se detenga el proceso en caso de errores. Es necesario utilizar esta opción debido a que la conversión del archivo <filename>/etc/services</filename> genera unos pocos errores que puede ignorar sin problemas.</para>
    </section>
    <section>
      <title>Administración de cuentas con LDAP</title>

      <para>Ahora que la base de datos LDAP contiene información útil, es momento de utilizar estos datos. Esta sección se enfoca en cómo configurar un sistema Linux para que los directorios de sistema utilicen la base de datos LDAP.</para>
      <section id="sect.config-nss">
        <title>Configuración de NSS</title>

	<para>El sistema NSS (cambio de servicio de nombres: «Name Service Switch», revise el recuadro <xref linkend="sidebar.intro-nss" />) es un sistema modular diseñado para definir u obtener información para directorios de sistemas. Utilizar LDAP como fuente de datos para NSS requiere instalar el paquete <emphasis role="pkg">libnss-ldap</emphasis>. Al hacerlo, se harán unas pocas preguntas cuyas respuestas están resumidas en la <xref linkend="tab-libnss-ldap" xrefstyle="select: label nopage" />.</para>
        <indexterm><primary><emphasis>libnss-ldap</emphasis></primary></indexterm>

        <table colsep="1" id="tab-libnss-ldap">
          <title>Configuración del paquete <emphasis role="pkg">lbnss-ldap</emphasis></title>
          <tgroup cols="2">
            <colspec align="justify"></colspec>
            <colspec align="justify"></colspec>
            <thead>
              <row>
                <entry>Pregunta</entry>
                <entry>Respuesta</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>Identificar de recurso uniforme (URI) del servidor LDAP</entry>
                <entry><literal>ldap://ldap.falcot.com</literal></entry>
              </row>
              <row>
                <entry>Nombre distinguido de la base de búsqueda</entry>
                <entry><literal>dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>Versión LDAP a utilizar</entry>
                <entry><literal>3</literal></entry>
              </row>
              <row>
                <entry>¿La base de datos LDAP requiere inicio de sesión?</entry>
                <entry>no</entry>
              </row>
	      <row>
	        <entry>Permisos LDAP especiales para root</entry>
		<entry>si</entry>
	      </row>
	      <row>
	        <entry>Modifique el archivo de configuración para que sólo pueda ser leído/escrito por su dueño</entry>
		<entry>no</entry>
	      </row>
              <row>
                <entry>cuenta LDAP para root</entry>
                <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>contraseña de la cuenta root de LDAP</entry>
                <entry>la contraseña de administración</entry>
              </row>
            </tbody>
          </tgroup>
        </table>

	<para>Luego necesita modificar el archivo <filename>/etc/nsswitch.conf</filename> para configurar que NSS utilice el módulo <command>ldap</command> recién instalado.</para>

        <example>
          <title>El archivo <filename>/etc/nsswitch.conf</filename></title>

          <programlisting>
# /etc/nsswitch.conf
#
# Ejemplo de configuración de la funcionalidad de GNU Name Service
# Switch. Si están instalados los paquetes «glibc-doc» e «info»,
# intente «info libc "Name Service Switch"» para más información
# sobre este archivo.

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files</programlisting>
        </example>

	<para>Generalmente agregará el módulo <command>ldap</command> antes que los demás para que, de esa forma, sea consultado primero. La excepción notable es el servicio <literal>hosts</literal> ya que para contactar el servidor LDAP necesita una consulta de DNS primero (para resolver <literal>ldap.falcot.com</literal>). Sin esta excepción, una consulta de nombres intentaría consultar al servidor LDAP; esto dispararía una resolución de nombres para el servidor LDAP, y así sucesivamente en un ciclo infinito.</para>

	<para>Si se debe considerar al servidor LDAP como autoritativo (e ignorar los archivos locales utilizados por el módulo <command>files</command>), puede configurar los servicios con la siguiente sintaxis:</para>

	<para><literal><replaceable>servicio</replaceable>: ldap [NOTFOUND=return] files</literal>.</para>

	<para>Si la entrada solicitada no existe en la base de datos LDAP, la consulta devolverá la respuesta «inexistente» aún cuando el recurso exista en uno de los archivos locales; sólo se utilizarán estos archivos locales cuando el servicio LDAP esté caído.</para>
      </section>
      <section id="sect.config-pam">
        <title>Configuración de PAM</title>

	<para>Esta sección describe una configuración PAM (revise el recuadro <xref linkend="sidebar.intro-pam" />) que permitirá a las aplicaciones realizar las autenticaciones necesarias contra la base de datos LDAP.</para>

        <sidebar>
          <title><emphasis>PRECAUCIÓN</emphasis> Autenticación rota</title>

	  <para>Modificar la configuración estándar de PAM utilizada por varios programas es una operación delicada. Un error puede llevar a una autenticación rota, lo que podría impedir iniciar sesiones. Por lo que recomendamos mantener una consola de root abierta. Si ocurriera cualquier error de configuración, podría solucionarlo y reiniciar los servicios fácilmente.</para>
        </sidebar>

	<para>El paquete <emphasis role="pkg">libpam-ldap</emphasis> provee el módulo LDAP para PAM. La instalación de este paquete realiza unas pocas preguntas muy similares a aquellas en el paquete <emphasis role="pkg">libnss-ldap</emphasis>; algunos parámetros de configuración (como el URI del servidor LDAP) son inclusive compartidos con el paquete <emphasis role="pkg">libnss-ldap</emphasis>. Encontrará resumidas las respuestas en la <xref linkend="tab-libpam-ldap" xrefstyle="select: label nopage" />.</para>
        <indexterm><primary><emphasis>libpam-ldap</emphasis></primary></indexterm>

        <table colsep="1" id="tab-libpam-ldap">
          <title>Configuración de <emphasis>libpam-ldap</emphasis></title>
          <tgroup cols="2">
            <colspec align="justify"></colspec>
            <colspec align="justify"></colspec>
            <thead>
              <row>
                <entry>Pregunta</entry>
                <entry>Respuesta</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>¿Permitir a la cuenta de administración LDAP comportarse como root local?</entry>
                <entry>Sí. Esto permite utilizar el programa <command>passwd</command> típico para modificar las contraseñas almacenadas en la base de datos LDAP.</entry>
              </row>
              <row>
                <entry>¿La base de datos LDAP requiere inicio de sesión?</entry>
                <entry>no</entry>
              </row>
              <row>
                <entry>cuenta LDAP para root</entry>
                <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>contraseña de la cuenta root de LDAP</entry>
                <entry>la contraseña de administración de la base de datos LDAP</entry>
              </row>
	      <row>
	        <entry>Algoritmo local de cifrado para las contraseñas</entry>
		<entry>crypt</entry>
	      </row>
            </tbody>
          </tgroup>
        </table>

	<para>Instalar el paquete <emphasis role="pkg">libpam-ldap</emphasis> automáticamente adapta la configuración PAM predeterminada definida en los archivos <filename>/etc/pam.d/common-auth</filename>, <filename>/etc/pam.d/common-password</filename> y <filename>/etc/pam.d/common-account</filename>. Este mecanismo utiliza la herramienta dedicada <command>pam-auth-update</command> (provista por el paquete <emphasis role="pkg">libpam-runtime</emphasis>). El administrador también puede utilizar esta herramienta si desea activar o desactivar módulos PAM.</para>
        <indexterm><primary><filename>common-auth</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-auth</filename></primary></indexterm>
        <indexterm><primary><filename>common-password</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-password</filename></primary></indexterm>
        <indexterm><primary><filename>common-account</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-account</filename></primary></indexterm>
      </section>
      <section>
        <title>Protección de intercambios de datos LDAP</title>
        <indexterm><primary>LDAP</primary><secondary>seguro</secondary></indexterm>

	<para>De forma predeterminada, el protocolo LDAP se transmite por la red como texto plano; incluyendo las contraseñas (cifradas). Debido a que se pueden obtener las claves cifradas de la red, pueden ser vulnerables a ataques de tipo diccionario. Puede evitarlo aplicando una capa extra de cifrado; el tema de esta sección es cómo activar esta capa.</para>
        <section>
          <title>Configuración del servidor</title>
          <indexterm><primary><foreignphrase>OpenSSL</foreignphrase></primary><secondary>creación de llaves</secondary></indexterm>
          <indexterm><primary>par de claves</primary></indexterm>

	  <para>El primer paso es crear un par de llaves (compuestas de una llave pública y una llave privada) para el servidor LDAP. Los administradores de Falcot reutilizaron <emphasis>easy-rsa</emphasis> para generarlas (revise la <xref linkend="sect.easy-rsa" />. Si ejecuta <command>./build-server-key ldap.falcot.com</command> deberá responder unas pocas preguntas mundanas (ubicación, nombre de la organización, etc.). La respuesta a la pregunta por el «nombre común» («common name») <emphasis>debe</emphasis> ser el nombre de equipo completamente calificado del servidor LDAP; en nuestro caso: <literal>ldap.falcot.com</literal>.</para>

	  <para>Este programa crea un certificado en el archivo <filename>keys/ldap.falcot.com.crt</filename>; la llave privada correspondiente es almacenada en <filename>keys/ldap.falcot.com.key</filename>.</para>

	  <para>Ahora debe instalar estas llaves en sus ubicaciones estándar y debemos asegurarnos que el servidor LDAP, que ejecuta bajo la identidad del usuario <literal>openldap</literal>, pueda leer el archivo privado:</para>

          <screen><computeroutput># </computeroutput><userinput>adduser openldap ssl-cert
</userinput><computeroutput>Adding user `openldap' to group `ssl-cert' ...
Adding user openldap to group ssl-cert
Done.
# </computeroutput><userinput>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chmod 0640 /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem
</userinput></screen>

	  <para>También necesita indicarle al demonio <command>slapd</command> que utilice estas llaves para el cifrado. La configuración del servidor LDAP es gestionada de forma dinámica: puede actualizar la configuración con operaciones LDAP normales en la jerarquía de objetos <literal>cn=config</literal> y el servidor actualizará <filename>/etc/ldap/slapd.d</filename> en tiempo real para que la configuración sea persistente. Por lo tanto, <command>ldapmodify</command> es la herramienta correcta para actualizar la configuración:</para>

          <example>
            <title>Configuración de <command>slapd</command> para cifrado</title>

            <screen><computeroutput># </computeroutput><userinput>cat &gt;ssl.ldif &lt;&lt;END
dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key
-
END
</userinput><computeroutput># </computeroutput><userinput>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif
</userinput><computeroutput>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
</computeroutput></screen>
          </example>

	  <sidebar>
	    <title><emphasis>HERRAMIENTA</emphasis> <command>ldapvi</command> para editar un directorio LDAP</title>
	    <indexterm><primary><command>ldapvi</command></primary></indexterm>
	    <para>Con <command>ldapvi</command> puede mostrar cualquier sección del directorio LDAP en formato LDIF, realizar cambios en el editor de texto y dejar que la herramienta realice las operaciones LDAP correspondientes.</para>
	    <para>Por lo tanto, es una forma conveniente para actualizar la configuración del servidor LDAP simplemente editando la jerarquía <literal>cn=config</literal>.</para>
	    <screen><computeroutput># </computeroutput><userinput>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config
</userinput></screen>
	  </sidebar>

	  <para>El último paso para activar el cifrado involucra cambiar la variable <varname>SLAPD_SERVICES</varname> en el archivo <filename>/etc/default/slapd</filename>. Para esta más seguros desactivaremos LDAP inseguro completamente.</para>

          <example>
            <title>El archivo <filename>/etc/default/slapd</filename></title>

            <programlisting>
# Ubicación predeterminada del archivo slapd.conf o el directorio cn=config
# de slapd.d. Si está vacío, utilice el valor predeterminado durante la
# compilación (/etc/ldap/slapd.d con /etc/ldap/slapd.conf como respaldo).
SLAPD_CONF=

# Cuenta del sistema bajo la que se ejecutará el servidor slapd. Si está
# vacío, el servidor ejecutará como root.
SLAPD_USER="openldap"

# Grupo del sistema bajo el que se ejecutará el servidor slapd. Si está
# vacío, el servidor ejecutará en el grupo primario de su usuario.
SLAPD_GROUP="openldap"

# Ruta al archivo de pid del servidor slapd. Si no está definido, el script
# init.d intentará adivinarlo basándose en $SLAPD_CONF
# (/etc/ldap/slapd.conf de forma predeterminada)
SLAPD_PIDFILE=

# slapd normalmente provee sólo ldap en todos los puertos TCP 389. slapd
# también puede atender pedidos en el puerto TCP 636 (ldaps) y a través
# de zócalos unix.
# Ejemplo de uso:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# Si está definida SLAPD_NO_START, el script de inicialización no iniciará
# o reiniciará slapd (podrá detenerlo, sin embargo). Descomente esta línea
# si está iniciando slapd por otros medios o no desea que inicie slapd
# durante el arranque del equipo.
#SLAPD_NO_START=1

# Si SLAPD_SENTINEL_FILE está configurado como la ruta a un archivo y dicho
# archivo exist, el script de inicialización no iniciará o reiniciará slapd
# (podrá detenerlo, sin embargo). Utilícelo para desactivar temporalmente
# el inicio de slapd (por ejemplo, mientras realiza mantenimiento o con un
# sistema de administración de configuraciones) cuando no desee editar
# un archivo de configuración.
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# Para autenticación Kerberos (a través de SASL), slapd utiliza el archivo
# keytab del sistema (/etc/krb5.keytab) de forma predeterminada. Descomente
# esta línea y cambie la ruta si desea utilizar otro archivo keytab.
#export KRB5_KTNAME=/etc/krb5.keytab

# Opciones adicionales para slapd
SLAPD_OPTIONS=""</programlisting>
          </example>
        </section>
        <section>
          <title>Configuración del cliente</title>

	  <para>En lado cliente, necesita modificar la configuración de los módulos <emphasis>libpam-ldap</emphasis> y <emphasis>libnss-ldap</emphasis> para que utilicen una URI <literal>ldaps://</literal>.</para>

	  <para>Los clientes LDAP también necesitan poder autenticar el servidor. En una infraestructura de llave pública X.509, los certificados públicos están firmados con la llave de una autoridad de certificación (CA). Con <emphasis>easy-rsa</emphasis>, los administradores de Falcot crearon su propia CA y ahora necesitan configurar el sistema para confiar en las firmas de la CA de Falcot. Puede lograr esto ubicando el certificado de la CA En <filename>/usr/local/share/ca-certificates</filename> y ejecutando <command>update-ca-certificates</command>.</para>
	  
	  <screen><computeroutput># </computeroutput><userinput>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt
</userinput><computeroutput># </computeroutput><userinput>update-ca-certificates
</userinput><computeroutput>Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
Adding debian:falcot.pem
done.
done.
</computeroutput></screen>

	  <para>Por último, puede modificar la URI LDAP predeterminada y el DN base predeterminado utilizado por varias herramientas de línea de órdenes en el archivo <filename>/etc/ldap/ldap.conf</filename>. Esto le ahorrará bastante tiempo.</para>

          <example>
            <title>El archivo <filename>/etc/ldap/ldap.conf</filename></title>

            <programlisting>#
# Valores predeterminados para LDAP
#

# Revise ldap.conf(5) para más detalles
# Este archivo debe poder ser leído (pero no escrito) por cualquiera.

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# Certificados TLC (necesarios para GnuTLS)
TLS_CACERT /etc/ssl/certs/ca-certificates.crt</programlisting>
          </example>

        </section>
      </section>
    </section>
  </section>
  <section id="sect.rtc-services">
    <title>Servicios de comunicación en tiempo real</title>

    <para>Los servicios de comunicación en tiempo real  (<foreignphrase>Real-Time Communication</foreignphrase>, RTC) agrupan los servicios de voz sobre IP, video/webcam, mensajería instantánea (<foreignphrase>instant messaging</foreignphrase>, IM) y de compartición de escritorio. Este capítulo proporciona una breve introducción a tres servicios necesarios para una infraestructura de comunicaicón en tiempo real: un servidor TURN, un servidor SIP y un servidor XMPP. Se pueden encontrar explicaciones más extensas de cómo planificar, instalar y gestionar estos servicios en inglés en <foreignphrase>Real-Time Communications Quick Start Guide</foreignphrase>, que contiene incluso ejemplos específicos para Debian.  <ulink type="block" url="http://rtcquickstart.org" /></para>
    <indexterm><primary>VoIP</primary><secondary>servidor</secondary></indexterm>
    <indexterm><primary>RTC</primary><secondary>servidor</secondary></indexterm>
    <indexterm><primary>Mensajería Instantánea</primary><secondary>servidor de</secondary></indexterm>
    <indexterm><primary>Chat</primary><secondary>servidor</secondary></indexterm>

    <para>Tanto SIP como XMPP pueden proporcionar la misma funcionalidad. SIP es algo más conociod para la voz sobre IP y para el video, mientras que XMPP se utiliza como protocolo de mensajería instantánea. En realidad ambos pueden ser utilizados para cualquier ade estos servicios. Para optimizar las opciones de conectividad se recomienda utilizar ambos en paralelo.</para>
    <indexterm><primary>SIP</primary></indexterm>
    <indexterm><primary>XMPP</primary></indexterm>

    
    <para>Estos dos servicios utilizan certificados X.509 para garantizar la confidencialidad y la autenticación. La <xref linkend="sect.easy-rsa" /> proporciona más detalles acerca de la creación de estos certificados. De forma alternativa también puede encontrar información muy útil en la <foreignphrase>Real-Time Communications Quick Start Guide</foreignphrase> (en inglés): <ulink type="block" url="http://rtcquickstart.org/guide/multi/tls.html" /></para>

    <section id="sect.rtc-dns-settings">
      <title>Parámetros DNS para los servicios RTC</title>

      <para>Los servicios RTC requieren registros DNS SRV y NAPTR. He aquí un ejemplo de configuración que se podría incluir en el fichero de zona para  <literal>falcot.com</literal>:</para>
      <indexterm><primary>DNS</primary><secondary>registro SRV</secondary></indexterm>
      <indexterm><primary>DNS</primary><secondary>registro NAPTR</secondary></indexterm>

<programlisting>
; the server where everything will run
server1            IN     A      198.51.100.19
server1            IN     AAAA   2001:DB8:1000:2000::19

; IPv4 only for TURN for now, some clients are buggy with IPv6
turn-server        IN     A      198.51.100.19

; IPv4 and IPv6 addresses for SIP
sip-proxy          IN     A      198.51.100.19
sip-proxy          IN     AAAA   2001:DB8:1000:2000::19

; IPv4 and IPv6 addresses for XMPP
xmpp-gw            IN     A      198.51.100.19
xmpp-gw            IN     AAAA   2001:DB8:1000:2000::19

; DNS SRV and NAPTR for STUN / TURN
_stun._udp  IN SRV    0 1 3467 turn-server.falcot.com.
_turn._udp  IN SRV    0 1 3467 turn-server.falcot.com.
@           IN NAPTR  10 0 "s" "RELAY:turn.udp" "" _turn._udp.falcot.com.

; DNS SRV and NAPTR records for SIP
_sips._tcp  IN SRV    0 1 5061 sip-proxy.falcot.com.
@           IN NAPTR  10 0 "s" "SIPS+D2T" "" _sips._tcp.falcot.com.

; DNS SRV records for XMPP Server and Client modes:
_xmpp-client._tcp  IN     SRV    5 0 5222 xmpp-gw.falcot.com.
_xmpp-server._tcp  IN     SRV    5 0 5269 xmpp-gw.falcot.com.</programlisting>
    </section>

    <section id="sect.turn-server">
      <title>Servidor TURN</title>

      <para>TURN es un servicio que permite a los clientes que se encuentran detrás de un router o firewall con NAT encontrar el camino más eficaz para comunicarse con otros clientes y en caso de no encontrarse ningún camino directo retransmitir los flujos de voz y datos. Se recomienda vivamente instalar un servidor TURN antes de ofrecer ningún otro servicio RTC a los usuarios finales.</para>
      <indexterm><primary>TURN</primary><secondary>servidor</secondary></indexterm>

      <para>TURN y el protocolo ICE son estándares abiertos. Para sacar provecho de estos protocolos, maximizando la conectividad y minimizando la frustración de los usuarios, es importante asegurarse que todos los programas cliente sean compatibles.</para>
      <indexterm><primary>ICE</primary></indexterm>

      <para>Para que el agoritmo ICE funcione eficazmente, el servidor tiene que tener do direcciones IPv4 públicas.</para>
      <section id="sect.turn-server-install">
        <title>Instalación de un servidor TURN</title>
        <para>Instale el paquete <emphasis role="pkg">resiprocate-turn-server</emphasis>.</para>

        <para>Edite el archivo de configuración <filename>/etc/reTurn/reTurnServer.config</filename>. Lo más importante es configurar las direcciones IP del servidor.</para>

<programlisting>
# your IP addresses go here:
TurnAddress = 198.51.100.19
TurnV6Address = 2001:DB8:1000:2000::19
AltStunAddress = 198.51.100.20
# your domain goes here, it must match the value used
# to hash your passwords if they are already hashed
# using the HA1 algorithm:
AuthenticationRealm = myrealm

UserDatabaseFile = /etc/reTurn/users.txt
UserDatabaseHashedPasswords = true</programlisting>

        <para>Reiniciar el servicio.</para>
      </section>
      <section id="sect.turn-server-management">
        <title>Gestionar los usuarios de TURN</title>
        <para>Utilice la herramienta <command>htdigest</command> para gestionar la lista de usuarios del servidor TURN.</para>
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/reTurn/users.txt myrealm joe</userinput></screen>
        <para>Después de cualquier modificación en <filename>/etc/reTurn/users.txt</filename> se debe notificar la señal HUP para que el servidor lo recargue (o también se puede autorizar la recarga automática en <filename>/etc/reTurn/reTurnServer.config</filename>).</para>
      </section>
    </section>

    <section id="sect.sip-server">
      <title>Servidor Proxy SIP</title>

      <para>Un servidor proxy SIP gestiona las conexiones SIP entrantes y salientes entre distintas organizaciones, los proveedores de enlaces SIP (<foreignphrase>SIP trunking</foreignphrase>), las centralitas privadas (<foreignphrase>Private Automatic Branch eXchange</foreignphrase>, PBX) como Asterisk, los teléfonos y programas de telefonía SIP y las aplicaciones WebRTC.</para>
      <indexterm><primary>SIP</primary><secondary>servidor</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>proxy</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>PBX</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary><command>dpkg-reconfigure slapd</command></secondary></indexterm>

      <para>Es altamente recomendable instalar y configurar un proxy SIP antes de intentar poner en servicio una centralita (<foreignphrase>PBX</foreignphrase>). El proxy SIP normaliza en gran medida el tráfico que llega a la centralita y proporciona una mayor conectividad y resiliencia.</para>

      <section id="sect.sip-server-install">
        <title>Instalación de un proxy SIP</title>
        <para>Instalar el paquete <emphasis role="pkg">repro</emphasis>. Se recomienda el uso del paquete desde <emphasis role="distribution">jessie-backports</emphasis>, ya que cuenta con las últimas mejoras de mejora de conectividad y resiliencia.</para>
        <indexterm><primary>repro</primary></indexterm>

        <para>Editar el fichero de configuración <filename>/etc/repro/repro.config</filename>. Lo más importante es poner la dirección IP del sevidor. El ejemplo de más abajo muestra cómo configurar tanto SIP como WebSockets/WebRTC, haciendo uso de TLS, IPv4 e IPv6:</para>

<programlisting>
# Transport1 será para SIP sobre conexiones TLS
# Aquí usamos el puerto 5061, pero si tiene clientes que se conectan desde
# lugares con firewalls puede cambiarlo para que escuche en el puerto 443
Transport1Interface = 198.51.100.19:5061
Transport1Type = TLS
Transport1TlsDomain = falcot.com
Transport1TlsClientVerification = Optional
Transport1RecordRouteUri = sip:falcot.com;transport=TLS
Transport1TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport1TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport2 es la versión IPv6 de Transport1
Transport2Interface = 2001:DB8:1000:2000::19:5061
Transport2Type = TLS
Transport2TlsDomain = falcot.com
Transport2TlsClientVerification = Optional
Transport2RecordRouteUri = sip:falcot.com;transport=TLS
Transport2TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport2TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport3 será para SIP sobre conexiones WebSocket (WebRTC)
# Aquí usamos el puerto 8443, pero puede hacer uso del 443
Transport3Interface = 198.51.100.19:8443
Transport3Type = WSS
Transport3TlsDomain = falcot.com
# Podría requerir que el navegador envíe un certificado pero, actualmente 
# parece que los navegadores no pueden hacerlo, por lo que déjelo como None:
Transport3TlsClientVerification = None
Transport3RecordRouteUri = sip:falcot.com;transport=WSS
Transport3TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport3TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport4 es la versión IPv6 de Transport3
Transport4Interface = 2001:DB8:1000:2000::19:8443
Transport4Type = WSS
Transport4TlsDomain = falcot.com
Transport4TlsClientVerification = None
Transport4RecordRouteUri = sip:falcot.com;transport=WSS
Transport4TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport4TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport5: Podría ser para conexiones TCP a un servidor Asterisk 
# de su red interna. No habilite el puerto 5060 a través del firewall
# externo.
Transport5Interface = 198.51.100.19:5060
Transport5Type = TCP
Transport5RecordRouteUri = sip:198.51.100.19:5060;transport=TCP

HttpBindAddress = 198.51.100.19, 2001:DB8:1000:2000::19
HttpAdminUserFile = /etc/repro/users.txt

RecordRouteUri = sip:falcot.com;transport=tls
ForceRecordRouting = true
EnumSuffixes = e164.arpa, sip5060.net, e164.org
DisableOutbound = false
EnableFlowTokens = true
EnableCertificateAuthenticator = True</programlisting>

        <para>Use la utilidad <command>htdigest</command> para gestionar la contraseña del administrador del interfaz web. El nombre del usuario debe ser <emphasis>admin</emphasis> y el realm debe coincidir con el indicado en <filename>repro.config</filename>.</para>

<screen><computeroutput># </computeroutput><userinput>htdigest /etc/repro/users.txt repro admin</userinput></screen>

        <para>Reinicie el servicio para usar la nueva configuración.</para>
      </section>
      <section id="sect.sip-server-management">
        <title>Gestionando el proxy SIP</title>
        <para>Vaya al interfaz web en <literal>http://sip-proxy.falcot.com:5080</literal> para completar la configuración añadiendio dominios, usuarios locales y rutas estáticas.</para>

        <para>El primer paso es añadir el dominio local. El proceso debe reiniciarse tras agregar o quitar dominios de la lista.</para>

        <para>El proxy sabe cómo dirigir las llamadas entre usuarios locales y direcciones completas SIP. La configuración de redirección solo es necesaria cuando se desea modificar el comportamiento por defecto. Por ejemplo, para reconocer números de teléfono, añadir un prefijo y redirigirlos a un proveedor SIP.</para>
      </section>
    </section>

    <section id="sect.xmpp-server">
      <title>Servidor XMPP</title>

      <para>Un servidor XMPP gestiona la conectividad entre usuarios locales XMPP y usuarios XMPP en otros dominios de la red pública Internet.</para>
      <indexterm><primary>Servidor</primary><secondary>XMPP</secondary></indexterm>

      <sidebar>
        <title><emphasis>VOCABULARIO</emphasis> ¿XMPP o Jabber?</title>
        <indexterm><primary>Jabber</primary></indexterm>

        <para>En ocasiones se menciona XMPP como Jabber. De hecho, Jabber es una marca y XMPP es el nombre oficial del estándard.</para>
        <indexterm><primary>Jabber</primary></indexterm>
      </sidebar>

      <para>Prosody es un conocido servidor de XMPP que opera de modo fiable en servidores Debian.</para>
      <indexterm><primary>Prosody</primary></indexterm>
      <section id="sect.xmpp-server-install">
        <title>Instalar el servidor XMPP</title>
        <para>Instalar el paquete <emphasis role="pkg">prosody</emphasis>. Se recomienda el uso del paquete desde <emphasis role="distribution">jessie-backports</emphasis>, ya que cuenta con las últimas mejoras de maximización de conectividad y resiliencia.</para>
        <indexterm><primary>Prosody</primary></indexterm>

        <para>Revisar el fichero de configuración <filename>/etc/prosody/prosody.cfg.lua</filename>. Lo más importante en agregar los JIDs de los usuarios a los que se les permite gestionar el servidor.</para>

<programlisting>
admins = { "joe@falcot.com" }</programlisting>

        <para>También se necesita un fichero de configuracion por cada dominio. Copiar el ejemplo de <filename>/etc/prosody/conf.avail/example.com.cfg.lua</filename> y usarlo como punto de partida. Este es <literal>falcot.com.cfg.lua</literal>:</para>

<programlisting>
VirtualHost "falcot.com"
        enabled = true
        ssl = {
                key = "/etc/ssl/private/falcot.com-key.pem";
                certificate = "/etc/ssl/public/falcot.com.pem";
                }</programlisting>

        <para>Para activar el dominio debe haber un enlace simbólico de <filename>/etc/prosody/conf.d/</filename>. Créelo de este modo:</para>

<screen><computeroutput># </computeroutput><userinput>ln -s /etc/prosody/conf.avail/falcot.com.cfg.lua /etc/prosody/conf.d/</userinput></screen>

        <para>Reinicie el servicio para usar la nueva configuración.</para>
      </section>
      <section id="sect.xmpp-server-management">
        <title>Gestionando el servidor XMPP</title>
        <para>Algunas operaciones de gestion pueden realizarse haciendo uso de la utilidad de línea de comandos <literal>prosodyctl</literal>. Por ejemplo, para añadir la cuenta del administrador especificada en <filename>/etc/prosody/prosody.cfg.lua</filename>:</para>
<programlisting>
# prosodyctl adduser joe@falcot.com</programlisting>

        <para>Para más detalles sobre cómo personalizar la configuración, vea la <ulink url="http://prosody.im/doc/configure">documentación en línea de Prosody</ulink>.</para>

      </section>

    </section>
    <section id="sect.rtc-port-443">
      <title>Servicios corriendo en el puerto 443</title>
      <para>Alguno administradores prefieren ejecutar todos sus servicios RTC en el puerto 443. Esto facilita a los usuarios conectarse desde lugares remotos, tales como hoteles y aeropuertos. Donde el resto de puertos pueden estar bloqueados o el tráfico de Internet se redirige a través de servidores proxy HTTP.</para>

      <para>Para usar esta estrategia cada servicio (SIP, XMPP y TURN) necesita una dirección IP distinta. Todos los servicios pueden estar todavía en el mismo equipo, ya que Linux soporta múltiples IP en un solo equipo. El número de puerto, 443, debe especificarse en los ficheros de configuración de cada uno de los procesos, y también en los registros SRV del DNS.</para>
    </section>
    <section id="sect.rtc-webrtc">
      <title>Agregando WebRTC</title>

      <para>Falcot quiere permitir a los clientes realizar llamadas telefónicas directamente desde el sitio web. Los administradores de Flacot también quieren usar WebRTC como parte de su plan de contingencia, de modo que el personal pueda hacer uso de los navegadores web desde casa y hacer uso del sistema de telefonía de la empresa y trabajar normalmente en caso de emergencia.</para>
      <indexterm><primary>WebRTC</primary></indexterm>
      <indexterm><primary>SIP</primary><secondary>WebSockets</secondary></indexterm>

      <sidebar>
        <title><emphasis>EN LA PRÁCTICA</emphasis> Pruebe WebRTC</title>
        <indexterm><primary>Demostración</primary><secondary>WebRTC</secondary></indexterm>

        <para>Si no ha probado WebRTC antes, hay varios portales que propocionan una demostración en línea y facilita pruebas. <ulink type="block" url="http://www.sip5060.net/test-calls" /></para>        
      </sidebar>

      <para>WebRTC es una tecnología que evoluciona rápidamente, y es esencial hacer uso de los paquetes de las distribuciones <emphasis role="distribution">jessie-backports</emphasis> o <emphasis role="distribution">Testing</emphasis>.</para>

      <para>JSCommunicator es un teléfono WebRTC genérico que no requiere de ningun script de tipo PHP en la parte servidora. Está construido exclusivamente con HTML, CSS y JavaScript. Es la base de muchos otros servicios y módulos WebRTC empleados en frameworks web avanzados. <ulink type="block" url="http://jscommunicator.org" /></para>
      <indexterm><primary>JSCommunicator</primary></indexterm>

      <para>El modo más rápido de instalar un teléfono WebRTC en un portal web es hacer uso del paquete <emphasis role="pkg">jscommunicator-web-phone</emphasis>. Requiere un proxy SIP proxy con transporte WebSocket. Las instruccones en <xref linkend="sect.sip-server-install" /> incluyen los detalles necesarios para habilitar el transporte WebSocket en el  proxy SIP <emphasis role="pkg">repro</emphasis>.</para>

      <para>Tras instalar <emphasis role="pkg">jscommunicator-web-phone</emphasis>, hay varios modos de usarlo. Una estrategia sencilla es incluir, o copiar, la configuración de <filename>/etc/jscommunicator-web-phone/apache.conf</filename> en la configuración de host virtual de Apache.</para>

      <para>Una vez los ficheros del teléfono web están disponibles en el servidor web, personalice <filename>/etc/jscommunicator-web-phone/config.js</filename> para que apunte al servidor TURN y al proxy SIP. Por ejemplo:</para>

<programlisting>
JSCommSettings = {

  // Entorno del servidor web
  webserver: {
    url_prefix: null            // Si se configura, prefijo empleado para construir URLs sound/
  },

  // STUN/TURN media relays
  stun_servers: [],
  turn_servers: [
    { server:"turn:turn-server.falcot.com?transport=udp", username:"joe", password:"j0Ep455d" }
  ],

  // Conexión WebSocket 
  websocket: {
      // Fíjese que empleamos el certificado del dominio falcot.com y el puerto 8443
      // Esto coincide con los ejemplos Transport3 y Transport4 en
      // el fichero repro.config para falcot.com
    servers: 'wss://falcot.com:8443',
    connection_recovery_min_interval: 2,
    connection_recovery_max_interval: 30
  },

  ...</programlisting>

      <para>Portales web más avanzados de tipo click-para-llamar normalmente hacen uso de scripts en la parte de servidor para generar dinámicamente el fichero <literal>config.js</literal>. El código fuente de <ulink url="http://drucall.org">DruCall</ulink> muestra cómo hacerlo con PHP.</para>
      <indexterm><primary>DruCall</primary></indexterm>

      <para>Este capítulo sólo analiza una parte de todo el software de servidor disponible; sin embargo, describimos la mayoría de los servicios de red. Ahora es el momento de un capítulo aún más técnico: profundizaremos en los detalles de algunos conceptos, describiremos los despliegues masivos y la virtualización.</para>

    </section>
  </section>
</chapter>
