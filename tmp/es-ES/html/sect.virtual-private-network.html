<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">10.2. Red virtual privada</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-es-ES-1.0-1" /><meta
        name="keywords"
        content="Red, Puerta de enlace, TCP/IP, IPv6, DNS, Bind, DHCP, QoS" /><link
        rel="home"
        href="index.html"
        title="El manual del Administrador de Debian" /><link
        rel="up"
        href="network-infrastructure.html"
        title="Capítulo 10. Infraestructura de red" /><link
        rel="prev"
        href="network-infrastructure.html"
        title="Capítulo 10. Infraestructura de red" /><link
        rel="next"
        href="sect.quality-of-service.html"
        title="10.3. Calidad del servicio" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/es-ES/stable/sect.virtual-private-network.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>Anterior</strong></a></li><li
          class="home">El manual del Administrador de Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>Siguiente</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.virtual-private-network"></a>10.2. Red virtual privada</h2></div></div></div><div
          class="para">
			Una <span
            class="emphasis"><em>red virtual privada</em></span> (VPN: «Virtual Private Network») es una forma de enlazar dos redes locales diferentes a través de Internet utilizando un túnel; el túnel generalmente está cifrado para confidencialidad. Usualmente se utilizan VPNs para integrar una máquina remota a la red local de una empresa.
		</div><a
          id="id-1.13.5.3"
          class="indexterm"></a><a
          id="id-1.13.5.4"
          class="indexterm"></a><a
          id="id-1.13.5.5"
          class="indexterm"></a><div
          class="para">
			Muchas herramientas lo proveen. OpenVPN es una solución eficiente, fácil de desplegar y mantener, basada en SSL/TLS. Otra posibilidad es utilizar IPsec para cifrar el tráfico IP entre dos máquinas; este cifrado es transparente, lo que significa que no necesita modificar las aplicaciones ejecutando en estos equipos para tener en cuenta la VPN. También puede utilizar SSH, además de para sus funcionalidades más convencionales, para proveer una VPN. Finalmente, puede establecer una VPN utilizando el protocolo PPTP de Microsoft. Existen otras soluciones, pero están más allá del alcance de este libro.
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.openvpn"></a>10.2.1. OpenVPN</h3></div></div></div><a
            id="id-1.13.5.7.2"
            class="indexterm"></a><div
            class="para">
				OpenVPN es un pedazo de software dedicado a crear redes privadas virtuales. Su configuración involucra crear interfaces de red virtuales en el servidor VPN y en los clientes; es compatible con interfaces <code
              class="literal">tun</code> (para túneles a nivel de IP) y <code
              class="literal">tap</code> (para túneles a nivel Ethernet). En la práctica, usualmente utilizará interfaces <code
              class="literal">tun</code> excepto cuando los clientes VPN deban intengrarse a la red local del servidor a través de un puente Ethernet.
			</div><div
            class="para">
				OpenVPN se basa en OpenSSL para toda la criptografía SSL/TLS y funcionalidades asociadas (confidencialidad, autenticación, integridad, falta de repudio). Puede configurarlo con una llave privada compartida o con un certificado X.509 basado en la infraestructura de llave pública. Se prefiere fuertemente esta última configuración ya que permite más flexibilidad cuando se enfrenta a un número creciente de usuarios itinerantes que acceden a la VPN.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>CULTURA</em></span> SSL y TLS</strong></p></div></div></div><a
              id="id-1.13.5.7.5.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.5.3"
              class="indexterm"></a><div
              class="para">
				Netscape inventó el protocolo SSL (<span
                class="emphasis"><em>capa de zócalos seguros</em></span>: «Secure Socket Layer») para asegurar conexiones con servidores web. Luego fue estandarizado por el IETF bajo el acrónimo TLS (<span
                class="emphasis"><em>seguridad de capa de transporte</em></span>: «Transport Layer Security»). Desde entonces, TLS ha seguido evolucionando y en nuestros días SSL ha quedado obsoleto debido a múltiples fallos de diseño que se han ido descubriendo.
			</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.easy-rsa"></a>10.2.1.1. Infraestructura de llave pública: <span
                      class="emphasis"><em>easy-rsa</em></span></h4></div></div></div><a
              id="id-1.13.5.7.6.2"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.3"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.4"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.5"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.6"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.7"
              class="indexterm"></a><a
              id="id-1.13.5.7.6.8"
              class="indexterm"></a><div
              class="para">
					El algoritmo RSA es ampliamente utilizado en criptografía de llave pública. Involucra un «par de llaves», compuestas de una llave privada y una llave pública. Las dos llaves están fuertemente relacionadas entre ellas y sus propiedades matemáticas son tales que un mensaje cifrado con la llave pública sólo puede ser descifrado por alguien que conozca la llave privada, lo que asegura confidencialidad. En la dirección opuesta, un mensaje cifrado con la clave privada puede ser descifrado por cualquiera que conozca la llave pública, lo que permite autenticar el origen del mensaje ya que sólo pudo haber sido generado por alguien con acceso a la llave privada. Cuando se asocie una función de hash digital (MD5, SHA1 o una variante más reciente), esto lleva a un mecanismo de firma que puede aplicarse a cualquier mensaje.
				</div><div
              class="para">
					Sin embargo, cualquiera puede crear un par de llaves, almacenar cualquier identidad en ella y pretender ser la identidad que elijan. Una solución involucra el concepto de una <span
                class="emphasis"><em>autoridad de certificación</em></span> (CA: «Certification Authority») formalizado por el estándar X.509. Este término se refiere a una entidad que posee un par de llaves confiable conocido como <span
                class="emphasis"><em>certificado raíz</em></span>. Sólo se utiliza este certificado para firmar otros certificados (pares de llaves), luego que se siguieron suficientes pasos para revisar la identidad almacenada en el par de llaves. Las aplicaciones que utilizan X.509 luego pueden verificar los certificados que se les presente si conocen los certificados raíz confiables.
				</div><div
              class="para">
					OpenVPN sigue esta regla. Dado que los CA públicos sólo expiden certificados a cambio de un pago (importante), también es posible crear una autoridad de certificación privada dentro de la empresa. El paquete <span
                class="emphasis"><em>easy-rsa</em></span> proporciona herramientas que dan soporte a la infraestructura de certificados X.509, implementados como un conjunto de scripts haciendo usp del comando <code
                class="command">openssl</code>.
				</div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>NOTA</em></span> <span
                          class="emphasis"><em>easy-rsa</em></span> antes <span
                          class="distribution distribution">Jessie</span></strong></p></div></div></div><div
                class="para">
					En versiones Debian hasta la <span
                  class="distribution distribution">Wheezy</span>, <span
                  class="emphasis"><em>easy-rsa</em></span> se distribuía como parte del paquete <span
                  class="pkg pkg">openvpn</span>, y sus scripts se encontraban en <code
                  class="filename">/usr/share/doc/openvpn/examples/easy-rsa/2.0/</code>. Configurar una CA implicaba copiar ese directorio, en vez de usar el comando <code
                  class="command">make-cadir</code> documentado aquí.
				</div></div><div
              class="para">
					Los administradores de Falcot Corp utilizan esta herramienta para crear los certificados necesarios, tanto para los servidores como para los clientes. Esto permite que la configuración de todos los clientes sea similar ya que sólo deberán configurarlos para confiar en certificados que provengan de la CA local de Falcot. Esta CA es el primer certificado a crear; para ello los administradores preparan un directorio con los ficheros necesarios para la CA en una ubicación apropiada, preferentemente a una máquina que no está conectada a la red para evitar el riesgo de robo de la llave privada de la CA.
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>make-cadir pki-falcot
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>cd pki-falcot</code></strong></pre><div
              class="para">
					Luego almacenan los parámetros necesarios en el archivo <code
                class="filename">vars</code>, especialmente aquellos cuyos nombres comienzan con <code
                class="literal">KEY_</code>; estas variables luego son integradas en el entorno:
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>vim vars
</code></strong><code
                class="computeroutput">$ </code><strong
                class="userinput"><code>grep KEY_ vars
</code></strong><code
                class="computeroutput">export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA`
export KEY_DIR="$EASY_RSA/keys"
echo NOTA: Si ejecuta ./clean-all, realizaré un rm -rf en $KEY_DIR
export KEY_SIZE=2048
export KEY_EXPIRE=3650
export KEY_COUNTRY="FR"
export KEY_PROVINCE="Loire"
export KEY_CITY="Saint-Étienne"
export KEY_ORG="Falcot Corp"
export KEY_EMAIL="admin@falcot.com"
export KEY_OU="Certificate authority"
export KEY_NAME="Certificate authority for Falcot Corp"
# Si desea firmar todas las claves con el mismo Nombre Común, descomente el siguiente exportación de KEY_CN
# export KEY_CN="CommonName"
$ </code><strong
                class="userinput"><code>. ./vars
</code></strong><code
                class="computeroutput">NOTE: If you run ./clean-all, I will be doing a rm -rf on /home/roland/pki-falcot/keys
$ </code><strong
                class="userinput"><code>./clean-all
</code></strong></pre><div
              class="para">
					El siguiente paso es crear el par de llaves en sí de la CA (durante este paso se almacenarán las dos partes del par de llaves en <code
                class="filename">keys/ca.crt</code> y <code
                class="filename">keys/ca.key</code>):
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-ca</code></strong>
<code
                class="computeroutput">Generando una clave privada RSA de 2048 bits
..............................................++++++
.......................++++++
escribiendo una nueva clave privada en 'ca.key'
-----
Se le va a solicitar que introduzca la información que se incorporará
en su solicitud de certificado.
Lo que va a intrducir es lo que se denomina Distinguished Name o DN.
Hay bastantes camos, pero puede dejar algunos en blanco
Algunos campos tendrán un valor por defecto,
Si introduce un '.', el campo se dejará en blanco.
-----
Country Name (código de 2 letras) [FR]:
State or Province Name (nombre completo) [Loire]:
Locality Name (p.e., ciudad) [Saint-Étienne]:
Organization Name (p.e., compañia) [Falcot Corp]:
Organizational Unit Name (p.e., sección) [Certificate authority]:
Common Name (p.e., su nombre o el del servidor) [Falcot Corp CA]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:
</code></pre><div
              class="para">
					Ahora puede crear el certificado para el servidor VPN, así como también los parámetros Diffie-Hellman necesarios en el servidor para la conexión SSL/TLS. Se identifica el servidor VPN por su nombre DNS <code
                class="literal">vpn.falcot.com</code>; se reutiliza este nombre para los archivos de llaves generados (<code
                class="filename">keys/vpn.falcot.com.crt</code> para el certificado público, <code
                class="filename">keys/vpn.falcot.com.key</code> para la llave privada):
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key-server vpn.falcot.com
</code></strong><code
                class="computeroutput">Generando clave privada RSA de 2048 bits
.....................................................................................................................+++
...........+++
escribiendo nueva clave privada en 'vpn.falcot.com.key'
-----
Se le va a solicitar que introduzca la información que se incorporará
en su solicitud de certificado.
Lo que va a introducir se denomina Distinguished Name o  DN.
Hay bastantes campos, pero puede dejar algunos en blanco
Algunos campos tendrán un valor por defecto,
si introduce ',', el campo se quedará en blanco.
-----
Country Name (Código de 2 letras) [ES]:
State or Province Name (nombre completo) [Loire]:
Locality Name (p.e., ciudad) [Saint-Étienne]:
Organization Name (p.e., empresa) [Falcot Corp]:
Organizational Unit Name (p.e., sección) [Certificate authority]:
Common Name (p.e., su nombre o  el del servidor) [vpn.falcot.com]:
Name [Certificate authority for Falcot Corp]:
Email Address [admin@falcot.com]:

Por favor, introduzca los siguientes atributos 'extra
para enviarlos junto con su solicitud de certificado
Un contraseña de desafío []:
Un nombre de empresa opcional []:
Usando la configuración de /home/roland/pki-falcot/openssl-1.0.0.cnf
Confirme que la solicitud coincide con la firma
Firma OK
El asunto del Distinguished Name es como sigue
countryName           :PRINTABLE:'ES'
stateOrProvinceName   :PRINTABLE:'Loire'
localityName          :T61STRING:'Saint-\0xFFFFFFC3\0xFFFFFF89tienne'
organizationName      :PRINTABLE:'Falcot Corp'
organizationalUnitName:PRINTABLE:'Certificate authority'
commonName            :PRINTABLE:'vpn.falcot.com'
name                  :PRINTABLE:'Certificate authority for Falcot Corp'
emailAddress          :IA5STRING:'admin@falcot.com'
El certificado será válido hasta el 6 Mar 1015 14:54:56  GMT (3650 days)
¿Firmar el certificado? [y/n]:</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">

Certificada 1 de 1 solicitud de certificado, ¿confirmar? [y/n]</code><strong
                class="userinput"><code>y
</code></strong><code
                class="computeroutput">Actualizada base de datos con una nueva entrada
Base de datos actualizada
$ </code><strong
                class="userinput"><code>./build-dh
</code></strong><code
                class="computeroutput">Generando parámetros DH, número primo seguro de 2048 bits de longitud, generador 2
Este proceso va a tardar un tiempo
[…]
</code></pre><div
              class="para">
					El siguiente paso crea los certificados para los clientes VPN; necesita un certificado para cada equipo o persona autorizada para utilizar la VPN:
				</div><pre
              class="screen">
<code
                class="computeroutput">$ </code><strong
                class="userinput"><code>./build-key JoeSmith
</code></strong><code
                class="computeroutput">
Generando una clave privada RSA de 2048 bit
................................+++
..............................................+++
escribiendo nueva clave privada para 'JoeSmith.key'
-----
Se te preguntará sobre información a introducir que será introducido
en tu petición de certificado
Lo que vas a introducir se llama Nombre Distinguido o un DN.
Hay algunos campos que puedes dejar en blanco
Para algunos campos habrá un valor por defecto
sí introduces '.' el campo se quedará en blanco.
-----
Nombre del País (código de dos letras) [FR]:
Nombre del Estado o Provincia (nombre completo) [Loire]:
Nombre de la Localidad (ej, ciudad) [Saint-Étienne]:
Nombre de la Organización (ej, compañía) [Falcot Corp]:
Nombre de la Unidad Organizativa (ej, sección) [Certificado de autoridad]:</code><strong
                class="userinput"><code>Development unit
</code></strong><code
                class="computeroutput">Nombre Común (ej, tu nombre o tu servidor host) [JoeSmith]:</code><strong
                class="userinput"><code>Joe
Smith
</code></strong><code
                class="computeroutput">[…]</code></pre><div
              class="para">
					Ahora que se crearon todos los certificados, necesita copiarlos donde correspondan: la llave pública del certificado raíz (<code
                class="filename">key/ca.crt</code>) será almacenada en todas las máquinas (tanto el servidor como los clientes) como <code
                class="filename">/etc/ssl/certs/Falcot_CA.crt</code>. Sólo instalará el certificado del servidor en el servidor (<code
                class="filename">key/vpn.falcot.com.crt</code> en <code
                class="filename">/etc/ssl/vpn.falcot.com.crt</code> y <code
                class="filename">key/vpn.falcot.com.key</code> en <code
                class="filename">/etc/ssl/private/vpn.falcot.com.key</code> con permisos restringidos para que sólo el administrador pueda leerlo), con los parámetros Diffie-Hellman correspondientes (<code
                class="filename">key/dh2048.pem</code>) instalados en <code
                class="filename">/etc/openvpn/dh2048.pem</code>. Instale los certificados de clientes en el cliente de VPN correspondiente de forma similar.
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.13.5.7.7"></a>10.2.1.2. Configuración del servidor OpenVPN</h4></div></div></div><div
              class="para">
					El script de inicialización de OpenVPN intenta, de forma predeterminada, iniciar todas las redes privadas virtuales definidas en <code
                class="filename">/etc/openvpn/*.conf</code>. Configurar un servidor VPN entonces es cuestión de almacenar el archivo de configuración correspondiente en este directorio. Un buen punto de partida es <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz</code> que lleva a un servidor bastante estándar. Por supuesto necesitará adaptar algunos parámetros: <code
                class="literal">ca</code>, <code
                class="literal">cert</code>, <code
                class="literal">key</code> y <code
                class="literal">dh</code> describirán las ubicaciones seleccionadas para cada uno (respectivamente: <code
                class="literal">/etc/ssl/certs/Falcot_CA.crt</code>, <code
                class="literal">/etc/ssl/vpn.falcot.com.crt</code>, <code
                class="literal">/etc/ssl/private/vpn.falcot.com.key</code> y <code
                class="literal">/etc/openvpn/dh2048.pem</code>). La directiva <code
                class="literal">server 10.8.0.0 255.255.255.0</code> define la subred utilizada por la VPN; el servidor utilizará la primera dirección IP en el rango (<code
                class="literal">10.8.0.1</code>) y se asignarán a los clientes el resto de las direcciones.
				</div><div
              class="para">
					Con esta configuración OpenVPN creará una interfaz de red virtual al iniciar, generalmente con el nombre <code
                class="literal">tun0</code>. Sin embargo, normalmente se configuran los firewalls al mismo tiempo que las interfaces de red reales, lo que ocurre antes que inicie OpenVPN. La creación de una interfaz de red virtual persistente, y configurar OpenVPN para que la utilice, es una buena práctica recomendada. Esto además permite elegir el nombre de esta interfaz. A tal efecto, <code
                class="command">openvpn -mktun -dev vpn -dev-type tun</code> crea una interfaz de red virtual llamada <code
                class="literal">vpn</code> de tipo <code
                class="literal">tun</code>; puede integrar fácilmente esta orden en el script de configuración del firewall o en la directiva <code
                class="literal">up</code> del archivo <code
                class="filename">/etc/network/interfaces</code>. Debe actualizar también el archivo de configuración de OpenVPN de forma acorde, con las directivas <code
                class="literal">dev vpn</code> y <code
                class="literal">dev-type tun</code>.
				</div><div
              class="para">
					Sin más cambios, los clientes VPN sólo pueden acceder el servidor VPN en sí a través de la dirección <code
                class="literal">10.8.0.1</code>. Para permitir a los clientes que accedan la red local (192.168.0.0/24) necesitará agregar una directiva <code
                class="literal">push route 192.168.0.0 255.255.255.0</code> a la configuración de OpenVPN para que los clientes VPN automáticamente obtengan una ruta de red que les indique que esta red está disponible a través de la VPN. Lo que es más, los equipos en la red local también necesitarán ser informados que la ruta a la VPN es a través del servidor de VPN (esto funciona automáticamente cuando instala el servidor VPN en la puerta de enlace). Otra alternativa es configurar el servidor VPN para realizar enmascaramiento de IPs de forma que las conexiones que provengan de los clientes VPN parezcan provenir del servidor VPN en su lugar (revise la <a
                class="xref"
                href="network-infrastructure.html#sect.gateway">Sección 10.1, “Puerta de enlace”</a>).
				</div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="id-1.13.5.7.8"></a>10.2.1.3. Configuración del cliente OpenVPN</h4></div></div></div><div
              class="para">
					Para configurar un cliente OpenVPN también necesita crear un archivo de configuración en <code
                class="filename">/etc/openvpn/</code>. Puede conseguir una configuración estándar utilizando <code
                class="filename">/usr/share/doc/openvpn/examples/sample-config-files/client.conf</code> como punto de partida. La directiva <code
                class="literal">remote vpn.falcot.com 1194</code> describe la dirección y puerto del servidor OpenVPN; también necesita adaptar <code
                class="literal">ca</code>, <code
                class="literal">cert</code> y <code
                class="literal">key</code> para describir la ubicación de los archivos de llave.
				</div><div
              class="para">
					Si no se debe iniciar la VPN automáticamente durante el inicio, configure la directiva <code
                class="literal">AUTOSTART</code> como <code
                class="literal">none</code> en el archivo <code
                class="filename">/etc/default/openvpn</code>. Siempre es posible iniciar o detener una conexión VPN dada con los comandos<code
                class="command">service openvpn@<em
                  class="replaceable">nombre</em> start</code> y <code
                class="command">service openvpn@<em
                  class="replaceable">nombre</em>stop</code> (donde la conexión <em
                class="replaceable">nombre</em> coincide con aquella definida en <code
                class="filename">/etc/openvpn/<em
                  class="replaceable">nombre</em>.conf</code>).
				</div><div
              class="para">
					El paquete <span
                class="pkg pkg">network-manager-openvpn-gnome</span> contiene una extensión para Network Manager (revise la <a
                class="xref"
                href="sect.network-config.html#sect.roaming-network-config">Sección 8.2.4, “Configuración de red automática para usuarios itinerantes”</a>) que permite administrar redes privadas virtuales OpenVPN. Esto permite que cada usuario configure gráficamente sus conexiones OpenVPN y las controle desde el ícono del gestor de red. <a
                id="id-1.13.5.7.8.4.3"
                class="indexterm"></a>
				</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.ssh-vpn"></a>10.2.2. Red privada virtual con SSH</h3></div></div></div><a
            id="id-1.13.5.8.2"
            class="indexterm"></a><a
            id="id-1.13.5.8.3"
            class="indexterm"></a><div
            class="para">
				En realidad existen dos formas de crear una red privada virtual con SSH. La histórica involucra establecer una capa PPP sobre el enlace SSH. Se describe este método en el siguiente «howto»: <div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://www.tldp.org/HOWTO/ppp-ssh/">http://www.tldp.org/HOWTO/ppp-ssh/</a></div>
			</div><div
            class="para">
				El segundo método es más reciente y fue introducido con OpenSSH 4.3; ahora OpenSSH puede crear interfaces de red virtuales (<code
              class="literal">tun*</code>) en ambos extremos de una conexión SSH y puede configurar estas interfaces virtuales exactamente como si fueran interfaces físicas. Primero debe activar el sistema de túneles configurando <code
              class="literal">PermitTunnel</code> como «yes» en el archivo de configuración del servidor SSH (<code
              class="filename">/etc/ssh/sshd_config</code>). Cuando se establece la conexión SSH debe solicitar explícitamente la creación del túnel con la opción <code
              class="literal">-w any:any</code> (puede reemplaza <code
              class="literal">any</code> con el número de dispositivo <code
              class="literal">tun</code> deseado). Esto necesita que el usuario tenga permisos de administrador en ambos extremos para poder crear el dispositivo de red (en otras palabras, debe establecer la conexión como root).
			</div><div
            class="para">
				Ambos métodos para crear redes privadas virtuales sobre SSH son bastante directos. Sin embargo, la VPN que proveen no es la más eficiente disponible; en particular, no maneja muy bien altos niveles de tráfico.
			</div><div
            class="para">
				La explicación es que cuando se encapsula TCP/IP en una conexión TCP/IP (para SSH) se utiliza el protocolo TCP dos veces, una vez para la conexión SSH y una vez dentro del túnel. Esto genera problemas, especialmente debido a la forma en la que TCP se adapta a condiciones de red modificando los tiempo de espera. El siguiente sitio describe el problema en más detalle: <div
              xmlns=""
              class="url">→ <a
                xmlns="http://www.w3.org/1999/xhtml"
                href="http://sites.inka.de/sites/bigred/devel/tcp-tcp.html">http://sites.inka.de/sites/bigred/devel/tcp-tcp.html</a></div> Por lo tanto debe limitar el uso de VPNs sobre SSH a túneles esporádicos y de un solo uso que no tengan requisitos de rendimiento.
			</div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.ipsec"></a>10.2.3. IPsec</h3></div></div></div><a
            id="id-1.13.5.9.2"
            class="indexterm"></a><a
            id="id-1.13.5.9.3"
            class="indexterm"></a><a
            id="id-1.13.5.9.4"
            class="indexterm"></a><div
            class="para">
				IPsec, a pesar de ser el estándar en VPNs IP, es bastante más complejo en su implementación. El motor de IPsec está incorporado al núcleo Linux; el paquete <span
              class="pkg pkg">ipsec-tools</span> provee las partes necesarias en espacio de usuario, las herramientas de control y configuración. En términos concretos, el archivo <code
              class="filename">/etc/ipsec-tools.conf</code> de cada equipo contiene los parámetros de los <span
              class="emphasis"><em>túneles IPsec</em></span> (en términos de IPsec: <span
              class="emphasis"><em>asociaciones de seguridad</em></span>, «Security Associations») en los que el equipo está involucrado; el script <code
              class="command">/etc/init.d/setkey</code> provee una forma de iniciar y detener el túnel (cada túnel es un enlace seguro a otra máquina conectada a la red privada virtual). Puede construir este archivo a mano desde la documentación que provee la página de manual <span
              class="citerefentry"><span
                class="refentrytitle">setkey</span>(8)</span>. Sin embargo, escribir los parámetros para todos los equipos en un conjunto de máquinas no trivial se convierte fácilmente en una tarea ardua ya que la cantidad de túneles crece rápidamente. Instalar un demonio IKE (<span
              class="emphasis"><em>intercambio de llaves IPsec</em></span>: «IPsec Key Exchange») como <span
              class="pkg pkg">racoon</span>, <span
              class="pkg pkg">strongswan</span> hace el proceso mucho más simple centralizando la administración y más seguro rotando las claves periódicamente.
			</div><a
            id="id-1.13.5.9.6"
            class="indexterm"></a><a
            id="id-1.13.5.9.7"
            class="indexterm"></a><a
            id="id-1.13.5.9.8"
            class="indexterm"></a><a
            id="id-1.13.5.9.9"
            class="indexterm"></a><div
            class="para">
				A pesar de su estado como referencia, la complejidad de configuración de IPsec restringe su uso en la práctica. Generalmente se preferirán soluciones basadas en OpenVPN cuando los túneles necesarios no sean muchos ni demasiado dinámicos.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>PRECAUCIÓN</em></span> IPsec y NAT</strong></p></div></div></div><div
              class="para">
				Los firewall con NAT y IPsec no funcionan bien juntos: IPsec firma los paquetes y cualquier cambio en estos paquetes que realice el firewall invalidará la firma y el destino rechazará los paquetes. Muchas implementaciones IPsec incluyen la técnica <span
                class="emphasis"><em>NAT-T</em></span> (<span
                class="emphasis"><em>NAT Traversal</em></span>), que básicamente encapsula un paquete IP en un paquete UDP estándar.
			</div><a
              id="id-1.13.5.9.11.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.11.4"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>SEGURIDAD</em></span> IPsec y firewalls</strong></p></div></div></div><div
              class="para">
				El modo de operación estándar de IPsec involucra intercambio de datos en el puerto UDP 500 para intercambio de llaves (también en el puerto UDP 4500 si utiliza NAT-T). Lo que es más, los paquetes IPsec utilizan dos protocolos IP dedicados que el firewall debe dejar pasar; la recepción de estos paquetes está basada en sus números de protocolo: 50 (ESP) y 51 (AH).
			</div><a
              id="id-1.13.5.9.12.3"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.4"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.5"
              class="indexterm"></a><a
              id="id-1.13.5.9.12.6"
              class="indexterm"></a></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="sect.pptp"></a>10.2.4. PPTP</h3></div></div></div><div
            class="para">
				PPTP (<span
              class="emphasis"><em>protocolo de túneles punto a punto</em></span>: «Point-to-Point Tunneling Protocol») utiliza dos canales de comunicación, uno para datos de control y otro para los datos; este último utiliza el protocolo GRE (<span
              class="emphasis"><em>encapsulación genérica de enrutamiento</em></span>: «Generic Routing Encapsulation»). Luego se establece un enlace PPP estándar sobre el canal de intercambio de datos.
			</div><a
            id="id-1.13.5.10.3"
            class="indexterm"></a><a
            id="id-1.13.5.10.4"
            class="indexterm"></a><a
            id="id-1.13.5.10.5"
            class="indexterm"></a><a
            id="id-1.13.5.10.6"
            class="indexterm"></a><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.pptp-config-client"></a>10.2.4.1. Configuración del cliente</h4></div></div></div><div
              class="para">
					El paquete <span
                class="pkg pkg">pptp-linux</span> contiene un cliente PPTP para Linux fácil de configurar. Las instrucciones a continuación están inspiradas en la documentación oficial: <div
                xmlns=""
                class="url">→ <a
                  xmlns="http://www.w3.org/1999/xhtml"
                  href="http://pptpclient.sourceforge.net/howto-debian.phtml">http://pptpclient.sourceforge.net/howto-debian.phtml</a></div>
				</div><a
              id="id-1.13.5.10.7.3"
              class="indexterm"></a><div
              class="para">
					Los administradores de Falcot crearon varios archivos: <code
                class="filename">/etc/ppp/options.pptp</code>, <code
                class="filename">/etc/ppp/peers/falcot</code>, <code
                class="filename">/etc/ppp/ip-up.d/falcot</code> y <code
                class="filename">/etc/ppp/ip-down.d/falcot</code>.
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-options.pptp"></a><p
                class="title"><strong>Ejemplo 10.2. El archivo <code
                    class="filename">/etc/ppp/options.pptp</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# opciones PPP utilizadas en una conexión PPTP
lock
noauth
nobsdcomp
nodeflate</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-peers-falcot"></a><p
                class="title"><strong>Ejemplo 10.3. El archivo <code
                    class="filename">/etc/ppp/peers/falcot</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# vpn.falcot.com es el servidor PPTP
pty "pptp vpn.falcot.com --nolaunchpppd"
# el usuario «vpn» identificará a la conexión
user vpn
remotename pptp
# necesita cifrado
require-mppe-128
file /etc/ppp/options.pptp
ipparam falcot</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-ip-up.d-falcot"></a><p
                class="title"><strong>Ejemplo 10.4. El archivo <code
                    class="filename">/etc/ppp/ip-up.d/falcot</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Crear la ruta a la red Falcot
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 es la red Falcot (remota)
  route add -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi</pre></div></div><div
              class="example"><a
                xmlns=""
                id="example.ppp-ip-down.d-falcot"></a><p
                class="title"><strong>Ejemplo 10.5. El archivo <code
                    class="filename">/etc/ppp/ip-down.d/falcot</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Eliminar la ruta a la red Falcot
if [ "$6" = "falcot" ]; then
  # 192.168.0.0/24 es la red Falcot (remota)
  route del -net 192.168.0.0 netmask 255.255.255.0 dev $1
fi</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SEGURIDAD</em></span> MPPE</strong></p></div></div></div><div
                class="para">
					Asegurar PPTP involucra utilizar la funcionalidad MPPE (<span
                  class="emphasis"><em>cifrado punto a punto de Microsoft</em></span>: «Microsoft Point-to-Point Encryption»), disponible como un módulo en los núcleos Debian oficiales.
				</div><a
                id="id-1.13.5.10.7.9.3"
                class="indexterm"></a><a
                id="id-1.13.5.10.7.9.4"
                class="indexterm"></a></div></div><div
            class="section"><div
              class="titlepage"><div><div><h4
                    class="title"><a
                      xmlns=""
                      id="sect.pptp-config-serveur"></a>10.2.4.2. Configuración del servidor</h4></div></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>PRECAUCIÓN</em></span> PPTP y firewalls</strong></p></div></div></div><div
                class="para">
					Necesita configurar los firewalls intermedios para que permitan pasar paquetes IP que utilizan el protocolo 47 (GRE). Lo que es más, necesita abrir el puerto 1723 del servidor PPTP para que pueda utilizar el canal de comunicación.
				</div></div><div
              class="para">
					<code
                class="command">pptpd</code> es el servidor PPTP para Linux. Necesitará cambiar pocas cosas de su archivo de configuración principal, <code
                class="filename">/etc/pptpd.conf</code>: <span
                class="emphasis"><em>localip</em></span> (dirección IP local) y <span
                class="emphasis"><em>remoteip</em></span> (dirección IP remota). En el ejemplo a continuación el servidor PPTP siempre utiliza la dirección <code
                class="literal">192.168.0.199</code> y los clientes PPTP reciben una dirección IP desde <code
                class="literal">192.168.0.200</code> a <code
                class="literal">192.168.0.250</code>.
				</div><div
              class="example"><a
                xmlns=""
                id="example.pptpd.conf"></a><p
                class="title"><strong>Ejemplo 10.6. El archivo <code
                    class="filename">/etc/pptpd.conf</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# ETIQUETA: speed
#
#       Especifica la velocidad a la que se comunica el demonio PPP.
#
speed 115200

# ETIQUETA: option
#
#       Especifica la ubicación del archivo de opciones PPP
#       De forma predeterminada, se lo busca en «/etc/ppp/options»
#
option /etc/ppp/pptpd-options

# ETIQUETA: debug
#
#       Activa (más) depuración al registro del sistema
#
# debug

# ETIQUETA: localip
# ETIQUETA: remoteip
#
#       Especifica los rangos de direcciones IP local y remoto
#
#       Puede especificar direcciones IP individuales separadas por coma o
#       rangos o ambos. Por ejemplo:
#
#               192.168.0.234,192.168.0.245-249,192.168.0.254
#
#       RESTRICCIONES IMPORTANTES:
#
#       1. No se permiten espacios entre las comas o en las direcciones.
#
#       2. Si provee más direcciones IP que MAX_CONNECTIONS, comenzará al
#          principio de la lista y continuará hasta que obtenga
#          MAX_CONNECTIONS direcciones IPs. De lo contrario será ignorado.
#
#       3. ¡Sin atajos en los rangos! Es decir que 234-8 no significa 234
#          a 238, para esto debe tipear 234-238.
#
#       4. Está bien si provee sólo una IP local - se configurarán todas 
#          las IPs locales como la provista. DEBE proveer al menos una IP
#          remota para cada cliente simultáneo.
#
#localip 192.168.0.234-238,192.168.0.245
#remoteip 192.168.1.234-238,192.168.1.245
#localip 10.0.1.1
#remoteip 10.0.1.2-100
localip 192.168.0.199
remoteip 192.168.0.200-250</pre></div></div><div
              class="para">
					La configuración PPP utilizada por el servidor PPTP también necesita algunos cambios en el archivo <code
                class="filename">/etc/ppp/pptpd-options</code>. Los parámetros importantes son el nombre del servidor (<code
                class="literal">pptp</code>), el nombre del dominio (<code
                class="literal">falcot.com</code> y la dirección IP para los servidores DNS y WINS.
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-pptpd-options"></a><p
                class="title"><strong>Ejemplo 10.7. El archivo <code
                    class="filename">/etc/ppp/pptpd-options</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
## activar la depuración de pppd en el registro del sistema
#debug

## modifique «servername» a lo que sea que especificó como su nombre de servidor en chap-secrets
name pptp
## modifique el nombre del dominio a su dominio local
domain falcot.com

## Estos son valores predeterminados razonables para clientes WinXXXX
## para las configuraciones relacionadas con seguridad
# El paquete pppd de Debian ahora es compatible tanto con MSCHAP como con MPPE, actívelos aquí.
# ¡Necesita tener también el módulo de núcleo para MPPE!
auth
require-chap
require-mschap
require-mschap-v2
require-mppe-128

## Complete con sus direcciones
ms-dns 192.168.0.1
ms-wins 192.168.0.1

## Complete con su máscara de red
netmask 255.255.255.0

## Algunos valores predeterminados
nodefaultroute
proxyarp
lock</pre></div></div><div
              class="para">
					El último paso consiste en registrar el usuario <code
                class="literal">vpn</code> (y su contraseña asociada) en el archivo <code
                class="filename">/etc/ppp/chap-secrets</code>. A diferencia de otras instancias en las que un asterisco («<code
                class="literal">*</code>») funcionaría, aquí debe proveer explícitamente el nombre del servidor. Lo que es más, los clientes PPTP Windows se identifican a sí mismo en la forma <code
                class="literal"><em
                  class="replaceable">DOMINIO</em>\\<em
                  class="replaceable">USUARIO</em></code> en lugar de sólo proveer un nombre de usuario. Esto explica porqué el archivo también menciona el usuario <code
                class="literal">FALCOT\\vpn</code>. También es posible especificar una dirección IP individual para los usuarios; un asterisco en este campo especifica que debe utilizar direcciones dinámicas.
				</div><div
              class="example"><a
                xmlns=""
                id="example.ppp-chap-secrets"></a><p
                class="title"><strong>Ejemplo 10.8. El archivo <code
                    class="filename">/etc/ppp/chap-secrets</code></strong></p><div
                class="example-contents"><pre
                  class="programlisting">
# Secretos para autenticación utilizando CHAP
# cliente       servidor secreto     dirección IP
vpn             pptp     f@Lc3au     *
FALCOT\\vpn     pptp     f@Lc3au     *</pre></div></div><div
              class="sidebar"><div
                class="titlepage"><div><div><p
                      class="title"><strong><span
                          class="emphasis"><em>SEGURIDAD</em></span> Vulnerabilidades PPTP</strong></p></div></div></div><div
                class="para">
					La primera implementación PPTP de Microsoft tuvo muchas críticas debido a su cantidad de vulnerabilidades de seguridad; la mayoría han sido solucionadas desde entonces en versiones más recientes. La configuración documentada en esta sección utiliza la última versión del protocolo. Sin embargo, debe saber que eliminar algunas opciones (como <code
                  class="literal">require-mppe-128</code> y <code
                  class="literal">require-mschap-v2</code>) podría hacer al servicio nuevamente vulnerable.
				</div></div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="network-infrastructure.html"><strong>Anterior</strong>Capítulo 10. Infraestructura de red</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Subir</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Inicio</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.quality-of-service.html"><strong>Siguiente</strong>10.3. Calidad del servicio</a></li></ul></body></html>
