<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">9.10. 备份</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-8-zh-CN-1.0-1" /><meta
        name="keywords"
        content="系统启动, 启动脚本, SSH, Telnet, 权限, 许可, 管理, Inetd, Cron, 备份, 热插拔, PCMCIA接口, APM, ACPI" /><link
        rel="home"
        href="index.html"
        title="Debian 管理员手册" /><link
        rel="up"
        href="unix-services.html"
        title="第 9 章 Unix 服务" /><link
        rel="prev"
        href="sect.quotas.html"
        title="9.9. 配额" /><link
        rel="next"
        href="sect.hotplug.html"
        title="9.11. 热插拔： 热插拔" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/zh-CN/stable/sect.backup.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>上一页</strong></a></li><li
          class="home">Debian 管理员手册</li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>下一页</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.backup"></a>9.10. 备份</h2></div></div></div><div
          class="para">
			制作备份是管理员的主要责任之一，但它是个相对复杂的课题，并包含一些很难掌握的强大工具。
		</div><a
          id="id-1.12.13.3"
          class="indexterm"></a><a
          id="id-1.12.13.4"
          class="indexterm"></a><div
          class="para">
			Many programs exist, such as <code
            class="command">amanda</code>, <code
            class="command">bacula</code>, <code
            class="command">BackupPC</code>. Those are client/server system featuring many options, whose configuration is rather difficult. Some of them provide user-friendly web interfaces to mitigate this. But Debian contains dozens of other backup software covering all possible use cases, as you can easily confirm with <code
            class="command">apt-cache search backup</code>.
		</div><a
          id="id-1.12.13.6"
          class="indexterm"></a><a
          id="id-1.12.13.7"
          class="indexterm"></a><a
          id="id-1.12.13.8"
          class="indexterm"></a><div
          class="para">
			本章节并没有详细介绍这些工具，而是介绍 Falcot Corp （本书中虚构的公司）管理员们确定备份策略时的思路。
		</div><div
          class="para">
			在 Falcot Corp公司，备份有两个目的：恢复被误删的文件，迅速恢复硬盘损坏的电脑。
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.11"></a>9.10.1. 使用 <code
                    class="command">rsync</code>备份</h3></div></div></div><div
            class="para">
				Backups on tape having been deemed too slow and costly, data will be backed up on hard drives on a dedicated server, on which the use of software RAID (see <a
              class="xref"
              href="advanced-administration.html#sect.raid-soft">第 12.1.1 节 “软 RAID”</a>) will protect the data from hard drive failure. Desktop computers are not backed up individually, but users are advised that their personal account on their department's file server will be backed up. The <code
              class="command">rsync</code> command (from the package of the same name) is used daily to back up these different servers.
			</div><a
            id="id-1.12.13.11.3"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>回到基础</em></span> 硬链接，文件的第二个名字</strong></p></div></div></div><a
              id="id-1.12.13.11.4.2"
              class="indexterm"></a><a
              id="id-1.12.13.11.4.3"
              class="indexterm"></a><div
              class="para">
				A hard link, as opposed to a symbolic link, cannot be differentiated from the linked file. Creating a hard link is essentially the same as giving an existing file a second name. This is why the deletion of a hard link only removes one of the names associated with the file. As long as another name is still assigned to the file, the data therein remain present on the filesystem. It is interesting to note that, unlike a copy, the hard link does not take up additional space on the hard drive.
			</div><div
              class="para">
				硬链接使用 <code
                class="command">ln <em
                  class="replaceable">target</em> <em
                  class="replaceable">link</em></code> 命令创建。 然后<em
                class="replaceable">link</em> 文件是<em
                class="replaceable">target</em> 文件另外的新名字。硬链接只能在相同的文件系统上创建，而符号链接不受此限制。
			</div></div><div
            class="para">
				有限的硬盘空间限制了每天完全备份数据。由此，<code
              class="command">rsync</code> 命令对之前备份的内容使用硬链接，这样可以避免使用过多的硬盘空间。 然后<code
              class="command">rsync</code> 进程只覆盖上次备份后修改过的文件。通过这种机制，大量的备份只占用小的磁盘空间。所有的备份会立即生效并且可以读写（例如，在共享网络上的不同目录），可以迅速比较两个不同日期的文件。
			</div><a
            id="id-1.12.13.11.6"
            class="indexterm"></a><a
            id="id-1.12.13.11.7"
            class="indexterm"></a><a
            id="id-1.12.13.11.8"
            class="indexterm"></a><div
            class="para">
				这种备份机制可以通过 <code
              class="command">dirvish</code> 程序执行。使用备份存储空间（“空”的），放置有时间戳的备份文件集（这些文件集在dirvish 文档中被成为“vaults”）。
			</div><div
            class="para">
				主要配置在 <code
              class="filename">/etc/dirvish/master.conf</code> 文件中。它定义了备份存储空间的位置，要管理的“vaults”，和备份超期的默认值。配置的其他部分在 <code
              class="filename"><em
                class="replaceable">bank</em>/<em
                class="replaceable">vault</em>/dirvish/default.conf</code> 文件中，包含对应文件集的特殊配置。
			</div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-master"></a><p
              class="title"><strong>例 9.3. The <code
                  class="filename">/etc/dirvish/master.conf</code> file</strong></p><div
              class="example-contents"><pre
                class="programlisting">bank:
    /backup
exclude:
    lost+found/
    core
    *~
Runall:
    root    22:00
expire-default: +15 days
expire-rule:
# MIN HR    DOM MON       DOW  STRFTIME_FMT
    *   *     *   *         1    +3 months
    *   *     1-7 *         1    +1 year
    *   *     1-7 1,4,7,10  1</pre></div></div><div
            class="para">
				The <code
              class="literal">bank</code> setting indicates the directory in which the backups are stored. The <code
              class="literal">exclude</code> setting allows you to indicate files (or file types) to exclude from the backup. The <code
              class="literal">Runall</code> is a list of file sets to backup with a time-stamp for each set, which allows you to assign the correct date to the copy, in case the backup is not triggered at precisely the assigned time. You have to indicate a time just before the actual execution time (which is, by default, 10:04 pm in Debian, according to <code
              class="filename">/etc/cron.d/dirvish</code>). Finally, the <code
              class="literal">expire-default</code> and <code
              class="literal">expire-rule</code> settings define the expiration policy for backups. The above example keeps forever backups that are generated on the first Sunday of each quarter, deletes after one year those from the first Sunday of each month, and after 3 months those from other Sundays. Other daily backups are kept for 15 days. The order of the rules does matter, Dirvish uses the last matching rule, or the <code
              class="literal">expire-default</code> one if no other <code
              class="literal">expire-rule</code> matches.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>实践</em></span>　使用SSH远程备份</strong></p></div></div></div><div
              class="para">
				The expiration rules are not used by <code
                class="command">dirvish-expire</code> to do its job. In reality, the expiration rules are applied when creating a new backup copy to define the expiration date associated with that copy. <code
                class="command">dirvish-expire</code> simply peruses the stored copies and deletes those for which the expiration date has passed.
			</div></div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-vault"></a><p
              class="title"><strong>例 9.4. <code
                  class="filename">/backup/root/dirvish/default.conf</code> 文件</strong></p><div
              class="example-contents"><pre
                class="programlisting">client: rivendell.falcot.com
tree: /
xdev: 1
index: gzip
image-default: %Y%m%d
exclude:
    /var/cache/apt/archives/*.deb
    /var/cache/man/**
    /tmp/**
    /var/tmp/**
    *.bak</pre></div></div><div
            class="para">
				上面的例子中指明了要备份的文件集：这些文件在机器 <span
              class="emphasis"><em>rivendell.falcot.com</em></span> 上（对本地数据备份，只需指明本地机器 <code
              class="command">hostname</code>），主要是在根目录下（<code
              class="literal">tree: /</code>），除了在 <code
              class="literal">exclude</code>中列出的文件。备份仅限于一个文件系统中的内容（<code
              class="literal">xdev: 1</code>）。不包含其他挂载点的文件。产生保存文件的索引（<code
              class="literal">index: gzip</code>），镜像根据当前日期进行命名（<code
              class="literal">image-default: %Y%m%d</code>）。
			</div><div
            class="para">
				有许多可用选项，都记录在 <span
              class="citerefentry"><span
                class="refentrytitle">dirvish.conf</span>(5)</span> 手册中。一旦这些配置文件设定好后，必须要使用<code
              class="command">dirvish --vault <em
                class="replaceable">vault</em> --init</code> 命令来初始化每个文件集。此后每天在删除过期备份之后，就会自动唤起 <code
              class="command">dirvish-runall</code> 进行备份。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>实践</em></span>　使用SSH远程备份</strong></p></div></div></div><div
              class="para">
				When dirvish needs to save data to a remote machine, it will use <code
                class="command">ssh</code> to connect to it, and will start <code
                class="command">rsync</code> as a server. This requires the root user to be able to automatically connect to it. The use of an SSH authentication key allows precisely that (see <a
                class="xref"
                href="sect.remote-login.html#sect.ssh-key-based-auth">第 9.2.1.1 节 “基于密钥的认证”</a>).
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.12"></a>9.10.2. 不使用备份恢复系统</h3></div></div></div><div
            class="para">
				Desktop computers, which are not backed up, will be easy to reinstall from custom DVD-ROMs prepared with <span
              class="emphasis"><em>Simple-CDD</em></span> (see <a
              class="xref"
              href="sect.automated-installation.html#sect.simple-cdd">第 12.3.3 节 “Simple-CDD: The All-In-One Solution”</a>). Since this performs an installation from scratch, it loses any customization that can have been made after the initial installation. This is fine since the systems are all hooked to a central LDAP directory for accounts and most desktop applications are preconfigured thanks to dconf (see <a
              class="xref"
              href="sect.graphical-desktops.html#sect.gnome-desktop">第 13.3.1 节 “GNOME”</a> for more information about this).
			</div><div
            class="para">
				The Falcot Corp administrators are aware of the limits in their backup policy. Since they can't protect the backup server as well as a tape in a fireproof safe, they have installed it in a separate room so that a disaster such as a fire in the server room won't destroy backups along with everything else. Furthermore, they do an incremental backup on DVD-ROM once per week — only files that have been modified since the last backup are included.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>进阶 </em></span> 备份SQL 和LDAP 服务</strong></p></div></div></div><div
              class="para">
				Many services (such as SQL or LDAP databases) cannot be backed up by simply copying their files (unless they are properly interrupted during creation of the backups, which is frequently problematic, since they are intended to be available at all times). As such, it is necessary to use an “export” mechanism to create a “data dump” that can be safely backed up. These are often quite large, but they compress well. To reduce the storage space required, you will only store a complete text file per week, and a <code
                class="command">diff</code> each day, which is created with a command of the type <code
                class="command">diff <em
                  class="replaceable">file_from_yesterday</em> <em
                  class="replaceable">file_from_today</em></code>. The <code
                class="command">xdelta</code> program produces incremental differences from binary dumps.
			</div><a
              id="id-1.12.13.12.4.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.4"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.5"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>文化</em></span> <span
                        class="emphasis"><em>TAR</em></span>，磁带备份标准</strong></p></div></div></div><a
              id="id-1.12.13.12.5.2"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.4"
              class="indexterm"></a><div
              class="para">
				历史上，在Unix 上制作备份最简单的方法是将一个 <span
                class="emphasis"><em>TAR</em></span> 档案存到磁带上。 <code
                class="command">tar</code> 甚至得名于“Tape ARchive”。
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>上一页</strong>9.9. 配额</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一级</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始页</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>下一页</strong>9.11. 热插拔： 热插拔</a></li></ul></body></html>
