<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="existing-setup">
  <chapterinfo>
    <mediaobject condition="pdf">
      <imageobject>
        <imagedata fileref="images/chap-existing-setup.png" scalefit="1" />
      </imageobject>
    </mediaobject>
    <keywordset>
      <keyword>当前设置</keyword>
      <keyword>重用</keyword>
      <keyword>迁移</keyword>
    </keywordset>
  </chapterinfo>
  <title>分析当前设置与迁移</title>
  <highlights>
    <para>任何系统的彻底修检都应考虑到已有的系统。其中包括让尽可能多的资源复用，和保证组成系统的各个部分协调无碍。以下的学习案列会介绍一个将设备向 Linux 迁移的通用技术框架。</para>
  </highlights>
  <section id="sect.heterogeneous-environments">
    <title>在异构环境中共存</title>
    <indexterm><primary>环境</primary><secondary>异构环境</secondary></indexterm>

    <para>Debian能和既有的环境整合无碍，并和其他操作系统共存。这近乎完美的兼容来自市场的压力：市场要求软件发布者需要遵从一定的标准。接受这些标准让管理员能灵活替换各种程序，客户端或服务端，免费与否，都不是问题。</para>
    <section>
      <title>和Windows机器整合</title>

      <para>Samba提供的SMB/CIFS服务确保了在Windows占优的环境下也能无缝通信。它可以将文件和打印队列分享给Windows客户端，并包含了一些软件，使得Linux机器也能使用Windows服务器所提供的服务。</para>

      <sidebar>
        <title><emphasis>工具</emphasis> Samba</title>
        <indexterm><primary>Samba</primary></indexterm>

        <para>最新版本的Samba可以替换Windows的大多数功能：它可以模拟成一个简单的Windows NT服务器开展工作（包括验证、文件分享、打印队列、下载打印机启动、分布式文件系统（DFS），等等），也可以支持一些最高级的服务功能（例如，作为与Active Directory兼容的域控制器工作）。</para>
      </sidebar>
    </section>
    <section>
      <title>和OS X机器整合</title>

      <indexterm><primary>Zeroconf</primary></indexterm>
      <indexterm><primary>Bonjour</primary></indexterm>
      <indexterm><primary>Avahi</primary></indexterm>
      <para>OS X 机器能够提供的网络服务包括文件共享及打印机共享。这些服务在本地网络中使用 Zereconf 协议软件包进行发布，并允许其他机器在没有手动配置的情况下自动发现设备。Debian 包括另外一个名为 Avahi 的实现，提供类似的服务。</para>

      <indexterm><primary>AFP</primary></indexterm>
      <indexterm><primary>AppleShare</primary></indexterm>
      <para>从另外方向看， Netatalk 服务可用于在 OS X 机器上提供文件共享服务。它使用 AFP（AppleShare） 协议作为依赖以实现该服务在客户端自动发现。</para>

      <indexterm><primary>AppleTalk</primary></indexterm>
      <para>OS X 之前的系统使用称为 AppleTalk 的协议。为了兼容使用此等协议的环境，Netatalk 也能提供 AppleTalk 协议 (实际上，是重实现该协议)。确保文件服务器、打印队列以及时间服务器 (时钟同步)的运作。它的路由器被设计允许与 AppleTalk 网络互联。</para>
    </section>
    <section>
      <title>与其他 Linux/Unix 设备集成</title>

      <para>最后，NFS 与 NIS 两者保证与 Unix 系统交互。NFS 确保文件服务器的运作，NIS 添加用户的文件夹。大部分 Unix 系统用到的 BSD 打印层，允许共享打印队列。</para>

      <figure>
        <title>Debian 与 OS X，Windows，Unix 系统的共存</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/existing-setup-1.png" width="25%" />
          </imageobject>
        </mediaobject>
      </figure>
    </section>
  </section>
  <section id="sect.how-to-migrate">
    <title>如何迁移</title>
    <indexterm><primary>迁移</primary></indexterm>

    <para>为了确保后续的服务，必须依照计划运行迁移的作业。每种操作系统都需遵守这个原则。</para>
    <section>
      <title>流行度调查和身份识别服务</title>

      <para>如你看到的，该步骤是必要的。一个严谨的管理员应当确切的知道每部服务器的确切角色，但是角色可以被改变，有时候有经验的用户会安装一些服务。了解这些服务的功能让你知道如何处理它，而不是粗暴的删除它们。</para>

      <para>基于这个目的，迁移服务器前先告知用户是明智之举。把用户拉入计划里，在迁移前安装最常见的免费软件程序（比如Libre Office 、Mozilla 套件）可能会很有用，在迁移到Debian之后它们会再次出现。</para>
      <section>
        <title>网络与程序</title>
        <indexterm><primary><command>nmap</command></primary></indexterm>
       
	<para><command>nmap</command> 工具 (在同名软件包中) 可以在未登录的前提下，快速地探测一台线上机器上运行着哪些互联网服务。只需在连接到同一网络的另一台计算机上调用以下命令：</para>

        <screen>
<computeroutput>$ </computeroutput><userinput>nmap mirwiz</userinput>
<computeroutput>Starting Nmap 7.40 ( https://nmap.org ) at 2017-06-06 14:41 CEST
Nmap scan report for mirwiz (192.168.1.104)
Host is up (0.00062s latency).
Not shown: 992 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
25/tcp   open  smtp
80/tcp   open  http
111/tcp  open  rpcbind
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
5666/tcp open  nrpe
9999/tcp open  abyss

Nmap done: 1 IP address (1 host up) scanned in 0.06 seconds</computeroutput>
</screen>

        <sidebar>
          <title><emphasis>替代</emphasis> 使用 <command>netstat</command> 以查找可用服务列表</title>

	  <para>在 Linux 机器里，<command>netstat -tupan</command> 指令可显示活动中或传输中的 TCP 会话，以及运行中程序监听的 UDP 端口。这有助于识别机器上提供的服务。</para>
        </sidebar>

        <sidebar>
          <title><emphasis>更进一步</emphasis> IPv6</title>

	  <para>有些网络指令可在 IPv4 (通常是缺省的) 或 IPv6 运行。包括 <command>nmap</command> 与 <command>netstat</command> 指令；但是也有不同的命令，如 <command>route</command> 或 <command>ip</command>，需要使用 <parameter>-6</parameter> 参数启动它们。</para>
        </sidebar>

	<para>Unix 机器的服务器提供 shell 帐号给用户，在拥有者缺席的情况下可以决定该进程是否在后台运行。指令 <command>ps auxw</command> 显示所有进程并包括他们的用户ID。将此等信息与 <command>who</command> 指令的输出的 已登陆用户 对比，就能辨识出在后台运行的流氓程序、未声明的服务或程序。使用 <filename>crontabs</filename> (依用户自动排串行出所有的作业) 可查看服务器提供的服务信息 (<command>cron</command> 的完整说明在 <xref linkend="sect.task-scheduling-cron-atd" />)。</para>

	<para>任何状况下，都该先备份您的服务器：当在迁移后用户报告特定问题时，该备份可以用来恢复一些信息。</para>
      </section>
    </section>
    <section>
      <title>备份配置</title>

      <para>保留所有已知服务的配置以便在更新后的服务器上安装同等的服务。最低限度是制作配置文件的副本。</para>

      <para>Unix 机器的配置档，通常在 <filename>/etc/</filename> 文件夹内，有时放在 <filename>/usr/local/</filename> 的子文件夹里。比如源码安装的程序，配置档就会放在前述的子文件夹内，有时候也被放在 <filename>/opt/</filename> 。</para>

      <para>在数据管理服务 (如数据库) 时，强烈建议以标准格式导出数据，更容易被新软件导入。通常是被组织的文本格式，比如一个从SQL数据库 dump 出的文件，或者一个从LDAP服务器导出的 LDIF 格式文件。</para>

      <figure>
        <title>备份数据库</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/existing-setup-2.png" width="50%" />
          </imageobject>
        </mediaobject>
      </figure>

      <para>每个服务器都不一样，这里无法详述所有个案。比较新旧软件的文档辨认可导出 (因此可以重新导入) 的部分以及需要人工处理的部分。此书阐述 Linux 服务器主要程序的配置。</para>
    </section>
    <section>
      <title>接手现有的 Debian 服务器</title>
      <indexterm><primary>恢复 Debian 机器</primary></indexterm>
      <indexterm><primary>探索 Debian 机器</primary></indexterm>
      <indexterm><primary>接手 Debian 服务器</primary></indexterm>

      <para>先分析正在运行 Debian 的机器，才能有效地接管维护工作。</para>

      <para>第一个查看的文件是 <filename>/etc/debian_version</filename>，通常包括 Debian 系统的版本编号 (它是 <emphasis>base-files</emphasis> 软件包的一部分)。若以 <literal><replaceable>代码</replaceable>/sid</literal> 方式呈现，表示此系统从该代码版本取得的最新版软件包 (测试版或不稳定版)。</para>

      <para><command>apt-show-versions</command> 程序 (来自 Debian 同名软件包) 检查已安装软件包的列表并标识可用的版本。<command>aptitude</command> 程序可以做到同样的工作，但是不是特别系统化。</para>

      <para>查看 <filename>/etc/apt/sources.list</filename> 文件 (以及 <filename>/etc/apt/sources.list.d/</filename> 文件夹) 可看到已安装 Debian 软件包的来源。若出现不明来源，管理员可能选择重新安装电脑系统确保其软件与 Debian 兼容。</para>

      <para><filename>sources.list</filename> 文件是个重要的指针：大部分的管理者保留一份使用中的 APT 来源清单。但不能忘记曾使用的来源可能被删除，有可能以人工方式安装 (以 <command>dpkg</command> 指令) 从互联网随机抓来的软件包。在此情况下，可能表面上是 “标准” Debian。碰到这种情况应放弃外来的软件包 (在不寻常的文件夹出现 <filename>deb</filename> 文件、软件包版本编号出现 Debian 未使用的特殊前置字符，诸 <literal>ubuntu</literal> 或 <literal>lmde</literal>，等字样。)</para>

      <para>同样的，分析 <filename>/usr/local/</filename> 文件夹的内容，其目的是收录编译后与手动安装后的程序。列出以此方式安装的软件清单，指出一个问题，为什么不使用 Debian 对应的软件包。</para>

      <sidebar>
        <title><emphasis>速看</emphasis> <emphasis role="pkg">cruft</emphasis></title>

	<para><emphasis role="pkg">cruft</emphasis> 软件包列出未被其他软件包拥有的文件。它有一些筛选器 (多数是有效的，但或多或少有点过时) 以避免报告合法的文件 (Debian 软件包产生的文件，或未被<command>dpkg</command> 管理的配置文件等)。</para>

	<para>小心不要盲目地删除可能被 <command>cruft</command> 列出的文件！</para>
      </sidebar>
    </section>
    <section>
      <title>安装 Debian</title>

      <para>知道当前服务器的必要信息后，就可以关闭它并开始安装 Debian。</para>
      <indexterm><primary>架构</primary></indexterm>

      <para>依照电脑的架构，选择适当的版本。近几年的 PC，很可能是 amd64 (稍旧的是 i386)。其他的情况，则依照安装的旧系统来判断。</para>

      <para><xref linkend="tab-corresp" xrefstyle="select: label nopage" /> 不是完整的，但相当有用。任何情况下，电脑的原始文档是最有用的数据源。</para>

      <table colsep="1" id="tab-corresp">
        <title>操作系统与架构对照表</title>
        <tgroup cols="2">
          <thead>
            <row>
              <entry>操作系统</entry>
              <entry>架构</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>DEC Unix (OSF/1)</entry>
              <entry>alpha, mipsel</entry>
            </row>
            <row>
              <entry>HP Unix</entry>
              <entry>ia64、hppa</entry>
            </row>
            <row>
              <entry>IBM AIX</entry>
              <entry>powerpc</entry>
            </row>
            <row>
              <entry>Irix</entry>
              <entry>mips</entry>
            </row>
            <row>
              <entry>OS X</entry>
              <entry>amd64、powerpc、 i386</entry>
            </row>
            <row>
              <entry>z/OS、MVS</entry>
              <entry>s390x、s390</entry>
            </row>
            <row>
              <entry>Solaris、 SunOS</entry>
              <entry>sparc, i386, m68k</entry>
            </row>
            <row>
              <entry>Ultrix</entry>
              <entry>mips</entry>
            </row>
            <row>
              <entry>VMS</entry>
              <entry>alpha</entry>
            </row>
            <row>
              <entry>Windows 95/98/ME</entry>
              <entry>i386</entry>
            </row>
            <row>
              <entry>Windows NT/2000</entry>
              <entry>i386, alpha, ia64, mipsel</entry>
            </row>
            <row>
              <entry>Windows XP / Windows Server 2008</entry>
              <entry>i386, amd64, ia64</entry>
            </row>
            <row>
              <entry>Windows RT</entry>
              <entry>armel, armhf, arm64</entry>
            </row>
            <row>
              <entry>Windows Vista / Windows 7-8-10</entry>
              <entry>i386, amd64</entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <sidebar>
        <title><emphasis>硬件</emphasis> 64 位电脑 vs 32 位电脑</title>
        <indexterm><primary>amd64</primary></indexterm>
        <indexterm><primary>i386</primary></indexterm>

	<para>近年的电脑使用 64 位 Intel 或 AMD 处理器，兼容于稍旧的 32 位处理器；为 “i386” 架构编绎的软件也适用。从另个角度来看，此兼容的软件无法充分发挥新处理器的性能。所以 Debian 提供 “amd64” 架构的版本，针对最新的 AMD 芯片以及 Intel “em64t” 处理器 (包括大多数的 Core 系列)，它们极度类似 AMD64。</para>
      </sidebar>
    </section>
    <section>
      <title>安装与配置选定的服务</title>

      <para>Debian 安装之后，必须逐一安装与设置该电脑的所有服务。新的配置必须参考过去的配置才能确保转换的顺利。前述两个步骤的搜集信息对于完成此部分极为重要。</para>

      <figure>
        <title>安装指定的服务</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/existing-setup-4.png" width="66%" />
          </imageobject>
        </mediaobject>
      </figure>

      <para>全面进入此练习前，强烈建议您阅读本书其他部分。才能够较精准地了解对预期服务的配置方式。</para>

      <para></para>
    </section>
  </section>
</chapter>
