<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="network-services">
  <chapterinfo>
    <mediaobject condition="pdf">
      <imageobject>
        <imagedata fileref="images/chap-network-services.png" scalefit="1" />
      </imageobject>
    </mediaobject>
    <keywordset>
      <keyword>Postfix</keyword>
      <keyword>Apache</keyword>
      <keyword>NFS</keyword>
      <keyword>Samba</keyword>
      <keyword>Squid</keyword>
      <keyword>OpenLDAP</keyword>
      <keyword>SIP</keyword>
    </keywordset>
  </chapterinfo>
  <title>Netzwerkdienste: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</title>
  <highlights>
    <para>Netzwerkdienste sind die Programme, mit denen Benutzer in ihrer täglichen Arbeit direkt interagieren. Sie sind die Spitze des Eisbergs des Informationssystems,  und dieses Kapitel richtet sein Hauptaugenmerk auf sie; die verborgenen Teile, auf denen sie aufbauen, sind die Infrastruktur, die wir bereits besprochen haben.</para>

    
    <para>Viele moderne Netzwerkdienste erfordern Verschlüsselung um zuverlässig und sicher zu funktionieren, besonders wenn diese im öffentlichen Internet verwendet werden. X.509 Zertifikate (die auch SSL Zertifikate oder TLS Zertifikate genannt werden) werden für diesen Zweck häufig eingesetzt. Ein Zertifikat für eine spezielle Domäne kann von mehr als einem in diesem Papier diskutierten Diensten verwendet werden.</para>
    <indexterm><primary>TSL</primary></indexterm>
    <indexterm><primary>X.509</primary></indexterm>
    <indexterm><primary>Zertifikate</primary></indexterm>
  </highlights>
  <section id="sect.smtp-mail-server">
    <title>Mail-Server</title>

    <para>Die Falcot Corp. Administratoren haben Postfix wegen seiner Zuverlässigkeit und seiner leichten Konfigurierbarkeit als elektronischen Mail-Server gewählt. Sein Design zwingt dazu, jede Aufgabe als Prozess mit dem geringstmöglichen Satz an Berechtigungen umzusetzen, eine gute Vorbeugungsmaßnahme gegen Sicherheitsprobleme.</para>
    <indexterm><primary>Email</primary><secondary>Server</secondary></indexterm>
    <indexterm><primary>Email Server</primary></indexterm>
    <indexterm><primary>Postfix</primary></indexterm>

    <sidebar>
      <title><emphasis>ALTERNATIVE</emphasis> Der Exim4-Server</title>
      <indexterm><primary>Exim</primary></indexterm>

      <para>Debian verwendet Exim4 standardmäßig als E-Mail-Server (daher enthält die Erstinstallation auch Exim4). Die Konfiguration wird durch ein separates Paket, <emphasis role="pkg">exim4-config</emphasis>, bereitgestellt und selbsttätig anhand der Antworten auf eine Anzahl von Debconf-Fragen eingerichtet, in ähnlicher Weise wie bei den vom Paket <emphasis role="pkg">postfix</emphasis> gestellten Fragen.</para>

      <para>Die Konfiguration kann sich entweder in einer einzelnen Datei (<filename>/etc/exim4/exim4.conf.template</filename>) befinden oder über mehrere einzelne Konfigurationsdateien verteilt sein, die unter <filename>/etc/exim4/conf.d/</filename> gespeichert sind. In beiden Fällen werden die Dateien von <command>update-exim4.conf</command> als Vorlage benutzt, um <filename>/var/lib/exim4/config.autogenerated</filename> zu erzeugen. Letztere Datei wird von Exim4 benutzt. Dank diesem Mechanismus können die durch die Debconf-Konfiguration von Exim zur Verfügung gestellten Werte — die in <filename>/etc/exim4/update-exim4.conf.conf</filename> gespeichert sind — in die Konfigurationsdatei von Exim eingefügt werden, auch dann, wenn ein Administrator oder ein anderes Paket die Standard-Einstellungen verändert hat.</para>

      <para>Die Syntax der Exim4-Konfigurationsdatei hat ihre Besonderheiten und erfordert eine Lernphase; sobald man jedoch diese Besonderheiten verstanden hat, ist Exim4 ein sehr umfassender und leistungsstarker E-Mail-Server, wie Dutzende von Dokumentationsseiten zeigen. <ulink type="block" url="http://www.exim.org/docs.html" /></para>
    </sidebar>

    
    <section>
      <title>Postfix installieren</title>

      <para>Das Paket <emphasis role="pkg">postfix</emphasis> enthält den Kern des SMTP-Daemons. Andere Pakete (wie <emphasis role="pkg">postfix-ldap</emphasis> und <emphasis role="pkg">postfix-pgsql</emphasis>) fügen weitere Funktionsmerkmale zu Postfix hinzu, einschließlich des Zugangs zu Zuordnungsdatenbanken. Sie sollten sie nur installieren, wenn Sie wissen, dass Sie sie benötigen.</para>

      <sidebar id="sidebar.smtp">
        <title><emphasis>ZURÜCK ZU DEN GRUNDLAGEN</emphasis> SMTP</title>
        <indexterm><primary>SMTP</primary></indexterm>
        <indexterm><primary>Simple Mail Transfer Protocol</primary></indexterm>
        <indexterm><primary>Server</primary><secondary>SMTP</secondary></indexterm>

	<para>SMTP (<emphasis>Simple Mail Transfer Protocol</emphasis>) ist das von Mail-Servern für den Austausch und die Zustellung von E-Mails verwendete Protokoll.</para>
      </sidebar>

      <para>Während der Installation des Pakets werden mehrere Debconf-Fragen gestellt. Die Antworten ermöglichen es, eine erste Version der Konfigurationsdatei <filename>/etc/postfix/main.cf</filename> zu erstellen.</para>

      <para>Die erste Frage bezieht sich auf die Art der Aufbaus. Nur zwei der vorgeschlagenen Antworten sind im Falle eines mit dem Internet verbundenen Servers relevant, „Internet site“ und „Internet with smarthost“. Die erste ist für einen Server richtig, der eingehende E-Mails empfängt und ausgehende E-Mails direkt an ihre Empfänger verschickt, und ist daher für die Situation der Falcot Corp. gut geeignet. Die zweite ist für einen Server angebracht, der eingehende E-Mails normal empfängt, aber ausgehende E-Mails über einen zwischengeschalteten SMTP-Server - den „smarthost“ - verschickt, statt direkt an den Server des Empfängers. Dies ist meistens für Personen mit einer dynamischen IP-Adresse sinnvoll, da viele E-Mail-Server Nachrichten, die direkt von einer derartigen IP-Adresse kommen, zurückweisen. In diesem Fall ist der Smarthost gewöhnlich der SMTP-Server des ISPs, der stets so konfiguriert ist, dass er E-Mails annimmt, die von den Kunden des ISP kommen, und sie in geeigneter Weise weiterleitet. Dieser Aufbau (mit einem Smarthost) ist auch für Server relevant, die nicht ständig mit dem Internet verbunden sind, da es so nicht erforderlich ist, eine Warteschlange nicht zustellbarer Nachrichten zu verwalten, für die später ein neuer Zustellversuch unternommen werden muss.</para>

      <sidebar>
        <title><emphasis>WÖRTERVERZEICHNIS</emphasis> ISP</title>
        <indexterm><primary>ISP, Internet Service Provider</primary></indexterm>

	<para>ISP ist die Abkürzung für „Internet Service Provider“. Hiermit ist eine Einrichtung gemeint, in vielen Fällen ein kommerzielles Unternehmen, die Internetverbindungen und damit zusammenhängende grundlegende Dienste (E-Mail, Nachrichten und so weiter) bereitstellt.</para>

        <para></para>
      </sidebar>

      <para>Die zweite Frage bezieht sich auf die vollständige Bezeichnung des Rechners, die zur Erstellung von E-Mail-Adressen aus einem lokalen Benutzernamen verwendet wird; die vollständige Bezeichnung des Rechners wird zu dem Teil hinter dem at-Zeichen („@“). Im Falle von Falcot sollte die Antwort <literal>mail.falcot.com</literal> lauten. Dies ist die einzige standardmäßig gestellte Frage, aber die Konfigurierung, zu der sie führt, ist für die Bedürfnisse von Falcot nicht vollständig genug, weshalb die Administratoren <command>dpkg-reconfigure postfix</command> aufrufen, um so weitere Parameter einstellen zu können.</para>

      <para>Eine der zusätzlichen Fragen erkundigt sich nach allen Domain-Namen, die mit diesem Rechner in Zusammenhang stehen. Die Standardliste umfasst seine vollständige Bezeichnung sowie einige Synonyme für <literal>localhost</literal>, jedoch muss die Hauptdomain <literal>falcot.com</literal> von Hand hinzugefügt werden. Allgemeiner gesagt sollte diese Frage normalerweise mit allen Domain-Namen beantwortet werden, für die dieser Rechner als MX-Server dienen soll; mit anderen Worten, allen Domain-Namen, für die der DNS angibt, dass dieser Rechner E-Mails annimmt. Diese Information geht in die Variable <literal>mydestination</literal> der Hauptkonfigurationsdatei von Postfix — <filename>/etc/postfix/main.cf</filename> — ein.</para>
      <indexterm><primary>Server</primary><secondary>MX</secondary></indexterm>
      <indexterm><primary>MX</primary><secondary>Server</secondary></indexterm>

      <figure>
        <title>Rolle des DNS-<emphasis>MX</emphasis>-Eintrags beim Versenden einer E-Mail</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/mail-server.png" scalefit="1" width="60%" />
          </imageobject>
        </mediaobject>
      </figure>

      <sidebar>
        <title><emphasis>EXTRA</emphasis> Die MX-Einträge abfragen</title>

	<para>Wenn im DNS kein MX-Eintrag für eine Domain vorliegt, versucht der E-Mail-Server, die Nachrichten unter Verwendung des passenden A-Eintrags (oder AAAA bei IPv6) an den Host selbst zu schicken.</para>
      </sidebar>

      <para>In manchen Fällen kann während der Installation auch gefragt werden, welchen Netzwerken es erlaubt sein soll, E-Mails über den Rechner zu verschicken. In seiner Standard-Konfiguration akzeptiert Postfix nur E-Mails, die von diesem Rechner selbst kommen; das lokale Netzwerk wird gewöhnlich hinzugefügt. Die Falcot Corp. Administratoren haben <literal>192.168.0.0/16</literal> zur Standardantwort hinzugefügt. Falls diese Frage nicht gestellt wird, ist <literal>mynetworks</literal> die relevante Variable in der Konfigurationsdatei, wie in unten stehendem Beispiel zu sehen ist.</para>

      <para>Lokale E-Mail kann auch durch <command>procmail</command> zugestellt werden. Dieses Programm ermöglicht es Benutzern, ihre ankommende E-Mail nach Regeln, die in der Datei <filename>~/.procmailrc</filename> gespeichert sind, zu sortieren.</para>
      <indexterm><primary><command>procmail</command></primary></indexterm>
      <indexterm><primary>E-Mail</primary><secondary>filtern</secondary></indexterm>
      <indexterm><primary>E-Mail filtern</primary></indexterm>

      <para>Nach diesem ersten Schritt verfügen die Administratoren über die folgende Konfigurationsdatei; sie wird als Ausgangspunkt verwendet, um in den nächsten Abschnitten einige weitere Funktionsmerkmale hinzuzufügen.</para>

      <example>
        <title>Anfängliche <filename>/etc/postfix/main.cf</filename>-Datei</title>

        <programlisting>
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</programlisting>
      </example>
      <sidebar>
        <title><emphasis>SICHERHEIT</emphasis> <emphasis>Schlangenöl</emphasis> SSL-Zertifikate</title>

	<para>Die <emphasis>Schlangenöl</emphasis>-Zertifikate sind, wie die <emphasis>Schlangenöl</emphasis>-„Medizin“, die früher von gewissenlosen Quacksalbern verkauft wurde, völlig wertlos: Man kann sich nicht darauf verlassen dass sie den Server authentifizieren  da sie in automatisch erzeugte selbstsignierte Zertifikate sind. Sie können jedoch dazu dienen die Vertraulichkeit des Austausches zu verbessern.</para>
        <para>Sie sollten nur zu Testzwecken benutzt werden, während im Normalbetrieb echte Zertifikate verwendet werden müssen; diese können mit dem unter <xref linkend="sect.easy-rsa" /> beschriebenen Verfahren erstellt werden.</para>
      </sidebar>
    </section>
    <section id="sect.configuring-virtual-domains">
      <title>Virtuelle Domains konfigurieren</title>
      <indexterm><primary>Domain</primary><secondary>virtuell</secondary></indexterm>
      <indexterm><primary>Virtuelle Domain</primary></indexterm>

      <para>Der Mail-Server kann außer E-Mails, die an die Hauptdomain adressiert sind, auch solche entgegennehmen, die an andere Domains gerichtet sind. Diese werden dann virtuelle Domains genannt. In den meisten derartigen Fällen sind die E-Mails letztlich nicht für lokale Benutzer bestimmt. Postfix stellt für die Verwendung virtueller Domains zwei interessante Leistungsmerkmale bereit.</para>

      <sidebar>
        <title><emphasis>VORSICHT</emphasis> Virtuelle und autorisierte Domains</title>

	<para>Auf keine der virtuellen Domains darf in der Variablen <literal>mydestination</literal> verwiesen werden; diese Variable enthält nur die Namen der direkt dem Rechner und seinen lokalen Benutzern zugeordneten „autorisierten“ Domains.</para>
      </sidebar>
      <section>
        <title>Virtuelle Alias-Domains</title>
        <indexterm><primary>Alias</primary><secondary>Virtuelle Alias-Domäne</secondary></indexterm>
        <indexterm><primary>Virtuelle Domäne</primary><secondary>Virtuelle Alias Domäne</secondary></indexterm>

	<para>Eine virtuelle Alias-Domain enthält nur Aliasse, das heißt Adressen, die nur E-Mails an andere Adressen weiterleiten.</para>

	<para>Eine derartige Domain wird durch das Hinzufügen ihres Namens zur Variablen <literal>virtual_alias_domains</literal> und das Eintragen eines Verweises auf eine Adressen-Bezugsdatei in die Variable <literal>virtual_alias_maps</literal> aktiviert.</para>

        <example>
          <title>In die Datei <filename>/etc/postfix/main.cf</filename> einzufügende Anweisungen</title>

          <programlisting>
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual</programlisting>
        </example>

	<para>Die Datei <filename>/etc/postfix/virtual</filename> stellt eine Zuordnung in einer recht einfachen Syntax dar: jede Zeile enthält zwei durch Leerzeichen getrennte Felder; das erste Feld ist der Alias-Name, das zweite eine Liste der E-Mail-Adressen, an die er weiterleitet. Die spezielle Syntax <literal>@domain.com</literal> deckt alle übrigen Aliasse in der Domain ab.</para>

        <example>
          <title>Beispiel der Datei <filename>/etc/postfix/virtual</filename></title>

          <programlisting>
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com</programlisting>
        </example>
      </section>
      <section>
        <title>Virtuelle Postfach-Domains</title>

        <sidebar>
          <title><emphasis>VORSICHT</emphasis> Kombinierte virtuelle Domain?</title>

	  <para>Postfix erlaubt es nicht, dieselbe Domain sowohl in <literal>virtual_alias_domains</literal> als auch in <literal>virtual_mailbox_domains</literal> zu verwenden. Jedoch ist jede Domain in <literal>virtual_mailbox_domains</literal> stillschweigend auch in <literal>virtual_alias_domains</literal> erfasst, so dass es möglich ist, Aliasse und Postfächer in einer virtuellen Domain zu kombinieren.</para>
        </sidebar>

        <indexterm><primary>Postfach, virtuelle Domain</primary></indexterm>
	<indexterm><primary>Virtuelle Domäne</primary><secondary>Domäne Virtueller Postfächer</secondary></indexterm>

	<para>An ein virtuelles Postfach adressierte Nachrichten werden in Postfächern gespeichert, die keinem lokalen Systembenutzer zugeordnet sind.</para>

	<para>Um eine virtuelle Postfach-Domain zu aktivieren, ist es erforderlich, diese Domain in der Variablen <literal>virtual_mailbox_domains</literal> einzutragen und in <literal>virtual_mailbox_maps</literal> einen Verweis auf eine Mailbox-Bezugsdatei anzugeben. Der Parameter <literal>virtual_mailbox_base</literal> enthält das Verzeichnis, in dem die Postfächer gespeichert werden.</para>

	<para>Der Paramater <literal>virtual_uid_maps</literal> (beziehungsweise <literal>virtual_gid_maps</literal>) verweist auf die Datei, die den Bezug zwischen der E-Mail-Adresse und dem Systembenutzer (beziehungsweise der Gruppe) enthält, dem das entsprechende Postfach „gehört“. Um alle Postfächer zusammen fassen zu können, die dem selben Benutzer beziehungsweise der selben Gruppe gehören, weist man mittels der Syntax <literal>static:5000</literal> eine feste UID/GID (hier mit dem Wert 5000) zu.</para>

        <example>
          <title>In die Datei <filename>/etc/postfix/main.cf</filename> einzufügende Anweisungen</title>

          <programlisting>
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts</programlisting>
        </example>

	<para>Auch die Syntax der Datei <filename>/etc/postfix/vmailbox</filename> ist recht einfach: zwei durch Leerzeichen getrennte Felder. Das erste Feld ist eine E-Mail-Adresse innerhalb einer der virtuellen Domains, und das zweite ist der Ort des dazugehörigen Postfachs (relativ zum Verzeichnis, das in <emphasis>virtual_mailbox_base</emphasis> angegeben ist). Falls die Bezeichnung des Postfachs mit einem Schrägstrich (<literal>/</literal>) endet, werden die E-Mails im <emphasis>maildir</emphasis>-Format gespeichert; anderenfalls wird das traditionelle <emphasis>mbox</emphasis>-Format benutzt. Das <emphasis>maildir</emphasis>-Format verwendet ein ganzes Verzeichnis zur Speicherung eines Postfachs, wobei jede individuelle Nachricht in einer eigenen Datei gespeichert wird. Dagegen ist beim <emphasis>mbox</emphasis>-Format das gesamte Postfach in einer einzigen Datei gespeichert, wobei jede Zeile, die mit „<literal>From </literal>“ beginnt (<literal>From</literal> gefolgt von einem Leerzeichen), den Beginn einer neuen Nachricht anzeigt.</para>

        <example>
          <title>Die Datei <filename>/etc/postfix/vmailbox</filename></title>

          <programlisting>
# Jeans E-Mail ist als maildir gespeichert mit
# einer Datei je E-Mail in einem gesonderten Verzeichnis
jean@falcot.org falcot.org/jean/
# Sophies E-Mail ist in einer traditionellen „mbox“-Datei gespeichert
# mit allen Mails zu einer einzigen Datei verkettet
sophie@falcot.org falcot.org/sophie</programlisting>
        </example>
      </section>
    </section>
    <section id="sect.restrictions-for-receiving-and-sending">
      <title>Einschränkungen beim Empfangen und Senden</title>

      <para>Die wachsende Zahl unerwünschter Massen-E-Mails (<emphasis>spam</emphasis>) macht es erforderlich, bei der Entscheidung, welche E-Mails ein Server annehmen sollte, in zunehmendem Maße strikt zu sein. Dieser Abschnitt zeigt einige der in Postfix enthaltenen Strategien.</para>

      <sidebar>
        <title><emphasis>KULTUR</emphasis> Das Spam-Problem</title>
        <indexterm><primary>Spam</primary></indexterm>

	<para>„Spam“ ist der allgemeine Begriff zur Bezeichnung all der unerwünschten kommerziellen E-Mails (auch bekannt als UCE = unsolicited commercial email), die unsere elektronischen Postfächer überfluten; die gewissenlosen Individuen, die sie verschicken, werden Spammer genannt. Sie kümmern sich wenig um die Belästigung, die sie verursachen, da das Verschicken einer E-Mail sehr wenig kostet, und es genügt, dass sich nur ein sehr geringer Prozentsatz der Empfänger von diesen Angeboten angezogen fühlt, damit die Spamming-Aktion mehr Geld einbringt als sie kostet. Der Vorgang ist weitgehend automatisiert, und jede E-Mail-Adresse, die öffentlich bekannt gemacht wird (zum Beispiel in einem Web-Forum, den Archiven einer Mailingliste oder einem Blog und so weiter) wird von den Robotern des Spammers entdeckt und einem niemals endenden Strom unerwünschter Nachrichten unterworfen.</para>

	<para>Alle System-Administratoren versuchen, dieser Belästigung mit Spamfiltern zu begegnen, aber natürlich passen sich die Spammer an und versuchen, diese Filter zu umgehen. Einige mieten sogar Rechnernetzwerke an, die von diversen kriminellen Banden mit einem Wurm infiziert worden sind. Jüngste Statistiken schätzen, dass bis zu 95% aller über das Internet laufenden E-Mails Spam sind!</para>
      </sidebar>
      <section>
        <title>IP-basierte Zugangsbeschränkungen</title>

	<para>Die Anweisung <literal>smtpd_client_restrictions</literal> bestimmt, welchen Rechnern es erlaubt ist, mit dem E-Mail-Server zu kommunizieren.</para>

        <example>
          <title>Beschränkungen aufgrund von Client-Adressen</title>

          <programlisting>
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org</programlisting>
        </example>

	<para>Wenn eine Variable wie in oben stehendem Beispiel eine Liste von Regeln enthält, werden diese Regeln der Reihe nach von der ersten bis zur letzten ausgewertet. Jede Regel kann die Nachricht entweder annehmen, zurückweisen oder d. Daher ist die Reihenfolge wichtig, und das Vertauschen zweier Regeln kann zu einem völlig anderen Verhalten führen.</para>

	<para>Die Anweisung <literal>permit_mynetworks</literal>, die als erste Regel verwendet wurde, akzeptiert alle E-Mails, die von einem Rechner im lokalen Netzwerk (wie in der Konfigurationsvariablen <emphasis>mynetworks</emphasis> festgelegt) kommen.</para>

	<para>Die zweite Direktive würde normalerweise alle E-Mails zurückweisen, die von Rechnern ohne vollständig gültige DNS-Konfiguration kommen. Solch eine gültige Konfiguration bedeutet, dass die IP-Adresse einem Namen zugeordnet werden kann, und dass dieser Name wiederum der IP-Adresse zugeordnet ist. Diese Beschränkung ist häufig zu strikt, da manche E-Mail-Server keinen umgekehrten DNS für ihre IP-Adresse haben. Dies erklärt, warum die Falcot Administratoren der Direktive <literal>reject_unknown_client</literal> den Modifikator <literal>warn_if_reject</literal> vorangestellt haben: dieser Modifikator wandelt die Zurückweisung in eine einfache Warnung um, die in den Protokollen aufgezeichnet wird. Die Administratoren können dann die Anzahl der Nachrichten im Blick behalten, die zurückgewiesen würden, wenn die Regel tatsächlich durchgesetzt würde und später aufgrund dieser Informationen eine Entscheidung treffen, ob sie die Durchsetzung aktivieren wollen.</para>

        <sidebar>
          <title><emphasis>TIPP</emphasis> <emphasis>access</emphasis>-Tabellen</title>

	  <para>Die Einschränkungskriterien bestehen unter anderem aus Tabellen, die vom Administrator geändert werden können und Kombinationen aus Absendern, IP-Adressen und erlaubten oder verbotenen Rechnernamen auflisten. Diese Tabellen können aus einer entpackten Kopie der Datei <filename>/usr/share/doc/postfix-doc/examples/access.gz</filename> erstellt werden. Diese Musterdatei ist in ihren Kommentaren dokumentiert, das heißt, dass jede Tabelle ihre eigene Syntax erläutert.</para>

	  <para>Die Tabelle <filename>/etc/postfix/access_clientip</filename> führt IP-Adressen und Netzwerke auf; <filename>/etc/postfix/access_helo</filename> listet Domain-Namen; <filename>/etc/postfix/access_sender</filename> enthält E-Mail-Adressen von Absendern. Alle diese Dateien müssen nach jeder Änderung mithilfe des Befehls <command>postmap /etc/postfix/<replaceable>datei</replaceable></command> in Hash-Tabellen umgewandelt werden (ein Format, das für schnellen Zugriff optimiert ist).</para>
        </sidebar>

	<para>Die dritte Anweisung ermöglicht es dem Administrator, eine schwarze Liste und eine Positivliste von E-Mail-Servern aufzustellen, die in der Datei <filename>/etc/postfix/access_clientip</filename> abgespeichert werden. Server in der Positivliste gelten als zuverlässig, und die von dort kommenden E-Mails durchlaufen daher nicht die anschließenden Filterregeln.</para>

	<para>Die beiden letzten Regeln weisen jede Nachricht zurück, die von einem Server kommt, der in einer der angezeigten schwarzen Listen aufgeführt ist. RBL ist die Abkürzung für <emphasis>Remote Black List</emphasis>; es gibt mehrere derartige Listen, aber alle führen sowohl schlecht konfigurierte Server auf, die von Spammern zur Übermittlung ihrer E-Mails benutzt werden, als auch unerwartete Mail-Übermittler, wie von Würmern oder Viren infizierte Rechner.</para>
        <indexterm><primary>RBL</primary></indexterm>
        <indexterm><primary>Remote Black List</primary></indexterm>

        <sidebar>
          <title><emphasis>TIPP</emphasis> Positivliste und RBLs</title>

	  <para>Manchmal enthalten schwarze Listen auch seriöse Server, die einen Störfall erlitten haben. In diesem Fall würden alle E-Mails, die von einem dieser Server kommen, zurückgewiesen, es sei denn, der Server ist in einer von <filename>/etc/postfix/access_clientip</filename> festgelegten Positivliste aufgeführt.</para>

	  <para>Es empfiehlt sich daher, vernünftigerweise alle seriösen Server, von denen man gewöhnlich zahlreiche E-Mails erhält, in die Positivliste aufzunehmen.</para>
        </sidebar>
      </section>
      <section>
        <title>Die Gültigkeit der Befehle <literal>EHLO</literal> und <literal>HELO</literal> überprüfen</title>

	<para>Jeder SMTP-Austausch beginnt mit einem <literal>HELO</literal>- oder <literal>EHLO</literal>-Befehl, gefolgt vom Namen des sendenden E-Mail-Servers; es kann interessant sein, die Gültigkeit dieses Namens zu überprüfen.</para>
        <indexterm><primary><literal>HELO</literal></primary></indexterm>
        <indexterm><primary><literal>EHLO</literal></primary></indexterm>

        <example>
          <title>Beschränkungen für den in <literal>EHLO</literal> genannten Namen</title>
          
          <programlisting>
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname</programlisting>
        </example>

	<para>Die erste Anweisung, <literal>permit_mynetworks</literal>, erlaubt es allen Rechnern des lokalen Netzwerks, sich ungehindert einzuführen. Dies ist wichtig, da einige E-Mail-Programme diesen Teil des SMTP-Protokolls nicht in ausreichendem Maße beachten und sich mit unsinnigen Namen einführen können.</para>

	<para>Die Regel <literal>reject_invalid_hostname</literal> weist E-Mails zurück, wenn die <literal>EHLO</literal>-Angabe einen syntaktisch unkorrekten Rechnernamen enthält. Die Regel <literal>reject_non_fqdn_hostname</literal> weist Nachrichten zurück, wenn der angegebene Rechnername kein vollständig ausgewiesener Domain-Name ist (dies schließt einen Domain-Namen wie auch einen Rechnernamen ein). Die Regel <literal>reject_unknown_hostname</literal> weist Nachrichten zurück, falls es den angegebenen Namen im DNS nicht gibt. Da diese letzte Regel leider zu viele Zurückweisungen zur Folge hat, haben die Administratoren ihre Wirkung mit Hilfe des Modifikators <literal>warn_if_reject</literal> bis auf Weiteres in eine einfache Warnung umgewandelt; sie können entscheiden, diesen Modifikator später zu entfernen, nachdem sie die Ergebnisse dieser Regel überprüft haben.</para>

	<para>Die Verwendung von <literal>permit_mynetworks</literal> als erster Regel hat eine interessante Nebenwirkung: die folgenden Regeln gelten nur für Rechner außerhalb des lokalen Netzwerks. Hierdurch ist es möglich, alle Rechner, die sich als Teil von <literal>falcot.com</literal> bezeichnen, auf die schwarze Liste zu setzen, indem zum Beispiel die Zeile <literal>falcot.com ABGELEHNT Sie sind nicht in unserem Netzwerk!</literal> zur Datei <filename>/etc/postfix/access_helo</filename> hinzugefügt wird.</para>
      </section>
      <section>
        <title>Annahme oder Ablehnung aufgrund des angegebenen Absenders</title>

	<para>Jede Nachricht hat einen Absender, der durch den Befehl <literal>MAIL FROM</literal> des SMTP-Protokolls angegeben wird; auch diese Information kann auf verschiedene Weise überprüft werden.</para>
        <indexterm><primary><literal>MAIL FROM</literal></primary></indexterm>
        <indexterm><primary>E-Mail</primary><secondary>filtern nach Absender</secondary></indexterm>

        <example>
          <title>Überprüfung des Absenders</title>

          <programlisting>
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender</programlisting>
        </example>

	<para>Die Tabelle <filename>/etc/postfix/access_sender</filename> ordnet einigen Absendern eine besondere Behandlung zu. Dies bedeutet für gewöhnlich, dass einige Absender in eine Positivliste oder eine schwarze Liste aufgenommen werden.</para>

	<para>Die Regel <literal>reject_unknown_sender_domain</literal> verlangt eine gültige Absenderdomain, da sie für eine gültige Adresse benötigt wird. Die Regel <literal>reject_unlisted_sender</literal> weist lokale Absender zurück, falls die Adresse nicht existiert; hierdurch wird vermieden, dass E-Mails von einer ungültigen Adresse in der <literal>falcot.com</literal>-Domain verschickt werden, und Nachrichten, die von <literal>joe.bloggs@falcot.com</literal> ausgehen, werden nur akzeptiert, wenn eine solche Adresse tatsächlich existiert.</para>

	<para>Schließlich weist die Regel <literal>reject_non_fqdn_sender</literal> E-Mails zurück, die vorgeben, von Adressen ohne einen vollständig ausgewiesenen Domain-Namen zu kommen. In der Praxis bedeutet dies, dass E-Mails, die von <literal>benutzer@rechner</literal> kommen, zurückgewiesen werden: die Adresse muss entweder als <literal>benutzer@rechner.beispiel.com</literal> oder <literal>benutzer@beispiel.com</literal> angegeben werden.</para>
      </section>
      <section>
        <title>Annehmen oder zurückweisen aufgrund des Empfängers</title>

	<para>Jede E-Mail hat wenigstens einen Empfänger, der im SMTP-Protokoll mit dem Befehl <literal>RCPT TO</literal> angegeben wird. Diese Adressen erfordern ebenfalls eine Gültigkeitsprüfung, selbst wenn dies weniger wichtig sein sollte als die Überprüfung des Absenders.</para>
        <indexterm><primary>RCPT TO</primary></indexterm>
        <indexterm><primary>E-Mail</primary><secondary>filtern nach Empfänger</secondary></indexterm>

        <example>
          <title>Überprüfung des Empfängers</title>

          <programlisting>
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient</programlisting>
        </example>

	<para>Die grundlegende Regel lautet <literal>reject_unauth_destination</literal>, und sie verlangt, dass externe Nachrichten an uns adressiert sein müssen; Nachrichten an eine Adresse, die von diesem Server nicht bedient wird, werden zurückgewiesen. Ohne diese Regel wird ein Server zu einem offenen Übermittler, der es Spammern erlaubt, unerwünschte E-Mails zu verschicken; diese Regel ist daher obligatorisch, und sie wird am besten ziemlich am Anfang der Liste platziert, damit nicht andere Regeln die Nachricht zulassen, bevor ihre Zieladresse überprüft worden ist.</para>

	<para>Die Regel <literal>reject_unlisted_recipient</literal> weist Nachrichten zurück, die an nicht existierende lokale Benutzer geschickt werden, was natürlich Sinn macht. Schließlich weist die Regel <literal>reject_non_fqdn_recipient</literal> nicht vollständig ausgewiesene Adressen zurück; dies macht es unmöglich, eine E-Mail an <literal>jean</literal> oder <literal>jean@rechner</literal> zu schicken, und erfordert stattdessen, die vollständige Adresse zu verwenden, wie <literal>jean@rechner.falcot.com</literal> or <literal>jean@falcot.com</literal>.</para>
      </section>
      <section>
        <title>Beschränkungen in Verbindung mit dem Befehl <literal>DATA</literal></title>

	<para>SMTPs Befehl <literal>DATA</literal> wird vor dem Inhalt der Nachricht verschickt. An sich stellt er keine Information bereit, außer anzukündigen, was als nächstes kommt.Dennoch kann er Überprüfungen unterworfen werden.</para>
        <indexterm><primary><literal>DATA</literal></primary></indexterm>

        <example>
          <title>Überprüfungen von <literal>DATA</literal></title>

          <programlisting>
smtpd_data_restrictions = reject_unauth_pipelining</programlisting>
        </example>

	<para>Die Anweisung <literal>reject_unauth_pipelining</literal> bewirkt, dass die Nachricht zurückgewiesen wird, falls die aussendende Partei einen Befehl verschickt, bevor die Antwort auf den vorhergehenden Befehl gesendet worden ist. Dies schützt vor einer häufig von Spam-Robotern benutzten Optimierung, da sie sich gewöhnlich keinen Deut um Antworten scheren und sich nur darauf konzentrieren, in möglichst kurzer Zeit möglichst viele E-Mails zu verschicken.</para>
      </section>
      <section>
        <title>Beschränkungen anwenden</title>

	<para>Obwohl die oben stehenden Befehle Informationen in verschiedenen Phasen des SMTP-Austauschs überprüfen, verschickt Postfix die eigentliche Zurückweisung nur als Antwort auf den Befehl <literal>RCPT TO</literal>.</para>

	<para>Dies bedeutet, dass selbst wenn die Nachricht aufgrund eines ungültigen <literal>EHLO</literal>-Befehls zurückgewiesen wird, Postfix den Absender und den Empfänger kennt, wenn es die Zurückweisung bekanntgibt. Es kann dann eine eindeutigere Nachricht protokollieren, als möglich gewesen wäre, falls die Übertragung gleich zu Anfang abgebrochen worden wäre. Außerdem erwarten manche SMTP-Clients keine Störungen bei den frühen SMTP-Befehlen, und diese Clients werden durch die späte Zurückweisung weniger gestört.</para>

	<para>Ein letzter Vorteil dieser Vorgehensweise ist, dass die Regeln im Verlauf der verschiedenen SMTP-Stadien Informationen sammeln können; dies ermöglicht es, feinkörnigere Berechtigungen zu formulieren, wie zum Beispiel eine nicht-lokale Verbindung zurückzuweisen, wenn sie sich als lokaler Absender ausgibt.</para>
      </section>
      <section>
        <title>Filtern aufgrund des Nachrichteninhalts</title>

	<para>Das Überprüfungs- und Beschränkungssystem wäre nicht vollständig ohne eine Möglichkeit, Überprüfungen des Nachrichteninhalts durchzuführen. Postfix unterscheidet die Überprüfungen, die es auf die E-Mail-Kopfzeilen anwendet, von denen, die es für den E-Mail-Inhalt benutzt.</para>

        <example>
          <title>Inhaltsbezogene Filter aktivieren</title>

          <programlisting>
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks</programlisting>
        </example>
        <indexterm><primary>E-Mail</primary><secondary>filtern nach Inhalt</secondary></indexterm>

	<para>Beide Dateien enthalten eine Liste regulärer Ausdrücke (gewöhnlich als <emphasis>regexps</emphasis> oder <emphasis>regexes</emphasis> bezeichnet) und damit zusammenhängender Aktionen, die ausgelöst werden, wenn die E-Mail-Kopfzeilen (oder der Inhalt) einem Ausdruck entsprechen.</para>

        <sidebar>
          <title><emphasis>KURZER BLICK</emphasis> Regexp-Tabellen</title>

	  <para>Die Datei <filename>/usr/share/doc/postfix-doc/examples/header_checks.gz</filename> enthält zahlreiche erläuternde Kommentare und kann als Grundlage für die Erstellung der Dateien <filename>/etc/postfix/header_checks</filename> und <filename>/etc/postfix/body_checks</filename> verwendet werden.</para>
        </sidebar>

        <example>
          <title>Beispiel einer Datei <filename>/etc/postfix/header_checks</filename></title>

          <programlisting>
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification</programlisting>
        </example>

        <sidebar id="sidebar.regexp">
          <title><emphasis>ZURÜCK ZU DEN GRUNDLAGEN</emphasis> Regulärer Ausdruck</title>

	  <para>Der Begriff <emphasis>regulärer Ausdruck</emphasis> (abgekürzt <emphasis>regexp</emphasis> oder <emphasis>regex</emphasis>) bezieht sich auf eine allgemeine Bezeichnung zur Beschreibung des Inhalts oder der Struktur einer Zeichenkette. Bestimmte Sonderzeichen ermöglichen die Festlegung von Alternativen (so trifft zum Beispiel <literal>foo|bar</literal> entweder für „foo“ oder für „bar“ zu), von Reihen zugelassener Zeichen (zum Beispiel bedeutet <literal>[0-9]</literal> eine beliebige Ziffer und <literal>.</literal> - ein Punkt - ein beliebiger Buchstabe) und von Quantifizierungen (<literal>s?</literal> trifft entweder auf <literal>s</literal> oder die Nullkette zu, mit anderen Worten das Ereignis 0 oder 1 von <literal>s</literal>; <literal>s+</literal> trifft auf ein oder mehrere aufeinander folgende <literal>s</literal>-Zeichen zu und so weiter). Klammern ermöglichen das Gruppieren von Suchergebnissen.</para>

	  <para>Die genaue Syntax dieser Ausdrücke unterscheidet sich zwischen den Programmen, die sie verwenden, aber die grundlegenden Merkmale sind ähnlich. <ulink type="block" url="https://de.wikipedia.org/wiki/Regulärer_Ausdruck" /></para>
        </sidebar>

	<para>Der erste überprüft die Kopfzeile, die die E-Mail-Software nennt; falls <literal>GOTO Sarbacane</literal> gefunden wird (ein Programm zum Versenden von Massen-E-Mails), wird die Nachricht zurückgewiesen. Der zweite Ausdruck überprüft den Nachrichtenbetreff; falls er eine Virenmeldung nennt, können wir entscheiden, die Nachricht nicht zurückzuweisen, sondern stattdessen sofort zu löschen.</para>

	<para>Die Verwendung dieser Filter ist ein zweischneidiges Schwert, da die Regeln leicht zu allgemein formuliert werden können und als Folge seriöse E-Mails verloren gehen. In diesen Fällen sind nicht nur die Nachrichten verloren, sondern ihre Absender erhalten zudem unerwünschte (und störende) Fehlermeldungen.</para>
      </section>
    </section>
    <section id="sect.setting-up-greylisting">
      <title><foreignphrase>Greylisting</foreignphrase> einrichten</title>
      <indexterm><primary>greylisting</primary></indexterm>

      <para>„Greylisting“ ist eine Filtertechnik, der zufolge eine Nachricht zunächst mit einem vorläufigen Fehlercode zurückgewiesen und erst bei einem weiteren Versuch nach einer gewissen Verzögerung angenommen wird. Dieses Filtern ist vor allem gegen Spam wirkungsvoll, der von den vielen mit Würmern und Viren infizierten Rechnern verschickt wird, da dieses Programm nur selten als vollständiger SMTP-Agent agiert (mit Überprüfung des Fehlercodes und einem späteren erneuten Zustellversuch für gescheiterte Nachrichten), vor allem weil viele der gesammelten Adressen in Wirklichkeit ungültig sind und ein erneuter Versuch nur Zeitverschwendung wäre.</para>

      <para>Postfix stellt Greylisting nicht von Haus aus zur Verfügung, jedoch gibt es eine Funktion, mit der die Entscheidung, eine bestimmte Nachricht anzunehmen oder zurückzuweisen, an ein externes Programme delegiert werden kann. Das Paket <emphasis role="pkg">postgrey</emphasis> enthält genau solch ein Programm, das dafür ausgelegt ist, sich in diesen Dienst zur Delegierung der Zugangsrichtlinien einzubinden.</para>

      <para>Sobald <emphasis role="pkg">postgrey</emphasis> installiert ist, läuft es als Daemon und nimmt an Port 10023 Verbindungen an. Postfix kann dann auf seine Verwendung eingestellt werden, indem der Parameter <literal>check_policy_service</literal> als zusätzliche Bedingung hinzugefügt wird:</para>

      <programlisting>
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023</programlisting>

      <para>Jedes Mal, wenn Postfix diese Regel in seinem Regelsatz erreicht, verbindet es sich mit dem <command>postgrey</command>-Daemon und schickt ihm Informationen über die entsprechende Nachricht. Wenn Postgrey überprüft seinerseits die Dreiergruppe aus IP-Adresse, Absender und Empfänger und sieht in seiner Datenbank nach, ob dieselbe Dreiergruppe vor kurzem bereits aufgetreten ist. n dies der Fall ist, antwortet Postgrey, dass die Nachricht angenommen werden sollte; anderenfalls zeigt die Antwort an, dass die Nachricht vorübergehend zurückgewiesen werden soll, und die Dreiergruppe wird in die Datenbank eingetragen.</para>

      <para>Der Hauptnachteil des Greylistings besteht darin, dass seriöse Nachrichten verzögert werden, was nicht immer akzeptabel ist. Es erhöht außerdem die Belastung von Servern, die zahlreiche seriöse E-Mails versenden.</para>

      <sidebar>
        <title><emphasis>IN DER PRAXIS</emphasis> Unzulänglichkeiten des Greylistings</title>

	<para>Theoretisch sollte Greylisting nur die erste Nachricht eines bestimmten Absenders an einen bestimmten Empfänger verzögern, und die typische Verzögerungsdauer liegt dabei im Bereich von Minuten. Die Wirklichkeit kann jedoch etwas anders aussehen. Einige große Internetdienstanbieter verwenden Gruppen von SMTP-Servern, und wenn eine Nachricht zunächst zurückgewiesen wird, kann es sein, dass der Server, der die Übertragung erneut versucht, nicht derselbe wie der ursprüngliche ist. In diesem Fall erhält der zweite Server aufgrund des Greylistings ebenfalls eine vorläufige Fehlermeldung und so weiter; so kann es mehrere Stunden dauern, bevor die Übertragung wieder von einem Server versucht wird, der schon einmal beteiligt war, da SMTP-Server normalerweise nach jedem Fehlschlag die Verzögerungszeit bis zu einem erneuten Versuch erhöhen.</para>

	<para>Folglich kann sich die ankommende IP-Adresse selbst für denselben Absender im Zeitverlauf ändern. Das ist jedoch nicht alles: selbst die Absenderadresse kann wechseln. Zum Beispiel kodieren viele Mailinglisten-Server zusätzliche Informationen in die Absenderadresse, um bestimmte Fehlermeldungen (<emphasis>bounces</emphasis> genannt) verarbeiten zu können. Jede an eine Mailingliste verschickte Nachricht wird dann möglicherweise durch das Greylisting gehen müssen mit der Folge, dass sie (vorübergehend) auf dem Server des Absenders gespeichert werden muss. Bei sehr großen Mailinglisten (mit zehntausenden von Abonnenten) kann dies sehr schnell zu Problemen führen.</para>

	<para>Um diesen Nachteilen entgegen zu wirken, verwaltet Postgrey eine Positivliste solcher Stellen, und von ihnen ausgehende Nachrichten werden direkt ohne den Umweg über das Greylisting angenommen. Diese Liste kann leicht an die örtlichen Bedürfnisse angepasst werden, da sie in der Datei <filename>/etc/postgrey/whitelist_clients</filename> gespeichert ist.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>WEITERE SCHRITTE</emphasis> Selektives Greylisting mit <emphasis role="pkg">milter-greylist</emphasis></title>

	<para>Den Nachteilen des Greylistings kann dadurch begegnet werden, dass es nur auf die Untergruppe von Clients angewendet wird, die bereits als mögliche Spamquellen angesehen werden (da sie in einer schwarzen Liste des DNS aufgeführt sind). Dies ist mit <emphasis role="pkg">postgrey</emphasis> nicht möglich,  wohl aber mit <emphasis role="pkg">milter-greylist</emphasis>.</para>

	<para>Da DNS-Blacklisten nicht zu einer endgültigen Ablehnung führen, ist es in diesem Szenario vernünftig, aggressive schwarze Listen einzusetzten, einschließlich derer, die alle dynamischen IP-Adressen von Internetdienstanbietern auflisten (wie zum Beispiel <literal>pbl.spamhaus.org</literal> oder <literal>dul.dnsbl.sorbs.net</literal>).</para>

	<para>Da die Milter-greylist die Milter-Schnittstelle von Sendmail benutzt, ist die Postfix-Seite der Konfiguration beschränkt auf “<literal>smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</literal>”. Die Handbuchseite <citerefentry><refentrytitle>greylist.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> dokumentiert <filename>/etc/milter-greylist/greylist.conf</filename> und die vielfältigen Möglichkeiten die Milter-greylist zu konfigurieren. Sie werden auch  <filename>/etc/default/milter-greylist</filename> bearbeiten müssen um den Dienst wirklich freizugeben.</para>
      </sidebar>
    </section>
    <section>
      <title>Filter anhand des Empfängers einstellen</title>

      <para>In den Abschnitten <xref linkend="sect.restrictions-for-receiving-and-sending" /> und <xref linkend="sect.setting-up-greylisting" />sind zahlreiche Beschränkungsmöglichkeiten betrachtet worden. Sie alle haben ihren Nutzen bei der Begrenzung der eingehenden Spam-Menge, aber sie haben auch ihre Nachteile. Es wird daher immer üblicher, den Filtersatz anhand des Empfängers einzustellen. Bei Falcot Corp. ist das Greylisting für die meisten Benutzer interessant, es behindert jedoch die Arbeit einiger Benutzer, die bei ihren E-Mails kurze Wartezeiten benötigen (wie zum Beispiel der technische Betreuungsdienst). In ähnlicher Weise hat die Handelsabteilung manchmal Probleme beim Empfang von E-Mails einiger asiatischer Anbieter, die vielleicht in schwarzen Listen aufgeführt sind; diese Abteilung hat um eine ungefilterte Adresse gebeten, so dass sie mit ihnen korrespondieren kann.</para>

      <para>Postfix bietet eine derartige Filteranpassung mit dem Konzept einer „restriction class“ an. Diese Klassen werden in dem Parameter <literal>smtpd_restriction_classes</literal> angegeben und in der gleichen Weise wie <literal>smtpd_recipient_restrictions</literal> festgelegt. Die Anweisung <literal>check_recipient_access</literal> bezeichnet dann eine Tabelle, die einem bestimmten Empfänger den richtigen Satz von Beschränkungen zuordnet.</para>

      <example>
        <title>Beschränkungsklassen in <filename>main.cf</filename> festlegen</title>

        <programlisting>smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access</programlisting>
      </example>

      <example>
        <title>Die Datei <filename>/etc/postfix/recipient_access</filename></title>

        <programlisting>
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting</programlisting>
      </example>
    </section>
    <section id="sect.postfix-antivirus">
      <title>Einen Virenschutz integrieren</title>
      <indexterm><primary>Virenschutz</primary></indexterm>

      <para>Die zahlreichen als E-Mail-Anhänge umlaufenden Viren erfordern das Einrichten eines Virenschutzes am Eingang des Firmennetzwerks, da einige Benutzer trotz einer Aufklärungskampagne weiterhin Anhänge von offensichtlich fragwürdigen Nachrichten öffnen.</para>

      <para>Die Falcot Administratoren haben <command>clamav</command> als ihren kostenlosen Virenschutz ausgewählt. Das Hauptpaket ist <emphasis role="pkg">clamav</emphasis>, aber sie haben auch einige Zusatzpakete wie <emphasis role="pkg">arj</emphasis>, <emphasis role="pkg">unzoo</emphasis>, <emphasis role="pkg">unrar</emphasis> und <emphasis role="pkg">lha</emphasis> installiert, da diese benötigt werden, damit der Virenschutz Anhänge analysieren kann, die in einem dieser Formate komprimiert sind.</para>
      <indexterm><primary><command>clamav</command></primary></indexterm>
      <indexterm><primary><command>clamav-milter</command></primary></indexterm>

      <para>Die Aufgabe, die Verbindung zwischen dem Virenschutz und dem E-Mail-Server bereitzustellen, fällt dem Programm <command>clamav-milter</command> zu. Ein <emphasis>Milter</emphasis> (kurz für <emphasis>Mailfilter</emphasis>) ist ein speziell für die Verbindung mit E-Mail-Servern ausgelegtes Programm. Ein Milter verwendet eine standardmäßige Programmierschnittstelle (API = application programming interface), die eine deutlich bessere Leistung aufweist als Filter außerhalb der E-Mail-Server. Milter wurden ursprünglich von <emphasis>Sendmail</emphasis> eingeführt, aber <emphasis>Postfix</emphasis> ist dem bald gefolgt.</para>

      <sidebar>
        <title><emphasis>KURZER BLICK</emphasis> Ein Milter für Spamassassin</title>
        <indexterm><primary><emphasis role="pkg">spamass-milter</emphasis></primary></indexterm>

	<para>Das Paket <emphasis role="pkg">spamass-milter</emphasis> stellt einen Milter zur Verfügung, der auf <emphasis>SpamAssassin</emphasis> beruht, dem bekannten Suchprogramm für unerwünschte E-Mails. Er kann dazu benutzt werden, Nachrichten als möglichen Spam zu markieren (indem er eine zusätzliche Kopfzeile hinzufügt) oder die Nachrichten vollständig zurückzuweisen, falls ihr Spam-Grad einen bestimmten Schwellenwert übersteigt.</para>
      </sidebar>

      <para>Nachdem das Paket <emphasis role="pkg">clamav-milter</emphasis> installiert ist, sollte milter umkonfiguriert werden um auf einen TCP-Port statt auf den Named Socket aufzusetzen. Das geht mit <command>dpkg-reconfigure clamav-milter</command>. Wenn die Frage nach dem "Communication interface with Sendmail" gestellt wird geben Sie “<literal>inet:10002@127.0.0.1</literal>” ein.</para>

      <sidebar>
        <title><emphasis>ANMERKUNG</emphasis> Wirklicher TCP Port vs Named Socket</title>
	<para>Der Grund, warum wir einen wirklichen TCP Port verwenden statt eines Named Socket liegt darin, dass die Postfix-Hintergrundprozesse oft mit chroot gestartet werden und keinen Zugriff auf die Verzeichnisse mit den Named Sockets haben. Sie können ebenso entscheiden, einen Named Socket zu verwenden und dafür einen Ort unterhalb des mit chroot gesetzten Wurzelverzeichnisses wählen (<filename>/var/spool/postfix/</filename>).</para>
      </sidebar>

      <para>Die standardmäßige ClamAV-Konfiguration eignet sich für die meisten Situationen, aber einige wichtige Parameter können noch mit <command>dpkg-reconfigure clamav-base</command> angepasst werden.</para>

      <para>Im letzten Schritt wird Postfix angewiesen, den neu konfigurierten Filter zu verwenden. Dies geschieht einfach durch das Hinzufügen der folgenden Anweisung zu <filename>/etc/postfix/main.cf</filename>:</para>

      <programlisting>
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002</programlisting>

      <para>Falls der Virenschutz Probleme verursacht, kann diese Zeile kommentiert und dann <command>service postfix reload</command> aufgerufen werden, damit diese Veränderung berücksichtigt wird.</para>

      <sidebar>
        <title><emphasis>IN DER PRAXIS</emphasis> Den Virenschutz überprüfen</title>

	<para>Sobald der Virenschutz eingerichtet ist, sollte er einem Test unterworfen werden. Dies geschieht am einfachsten dadurch, dass man eine Test-E-Mail mit einem Anhang verschickt, der die Datei <filename>eicar.com</filename> (oder <filename>eicar.com.zip</filename>) enthält, die aus dem Internet heruntergeladen werden kann: <ulink type="block" url="http://www.eicar.org/86-0-Intended-use.html" /></para>

	<para>Diese Datei ist kein wirkliches Virus, sondern eine Testdatei, die alle auf dem Markt befindlichen Virenschutzprogramme als Virus diagnostizieren, um so die Überprüfung von Installationen zu ermöglichen.</para>
      </sidebar>

      <para>Alle Nachrichten, die von Postfix verarbeitet werden, laufen jetzt durch den Virenschutzfilter.</para>
    </section>
    <section id="sect.authenticated-smtp">
      <title>Authentifiziertes SMTP</title>

      <para>Um E-Mails verschicken zu können, ist es erforderlich, dass ein SMTP-Server erreichbar ist; besagter SMTP-Server muss außerdem E-Mails durchleiten. Für Benutzer, die auf Reisen sind, würde dies bedeuten, dass die Konfiguration des SMTP-Clients regelmäßig geändert werden muss, da Falcots SMTP-Server Nachrichten abweist, die von IP-Adressen kommen, die offensichtlich nicht zum Unternehmen gehören. Es gibt zwei Lösungen: Entweder installiert ein Benutzer auf Reisen einen SMTP-Server auf seinem Rechner, oder er benutzt weiterhin den Unternehmensserver unter Verwendung einiger Hilfsmittel, mit denen er sich als Angestellter authentifiziert. Die erste Lösung wird nicht empfohlen, da der Rechner nicht ununterbrochen verbunden wäre und im Falle von Problemen nicht wiederholt versuchen könnte, Nachrichten zu senden; wir werden uns daher auf die zweite Lösung konzentrieren.</para>

      <para>SMTP-Authentifizierung in Postfix ist auf SASL angewiesen (<emphasis>Simple Authentication and Security Layer</emphasis>). Hierzu ist es erforderlich, die Pakete <emphasis role="pkg">libsasl2-modules</emphasis> und <emphasis role="pkg">sasl2-bin</emphasis> zu installieren und dann für jeden Benutzer, der eine Authentifizierung beim SMTP-Server benötigt, ein Passwort in die SASL-Datenbank einzutragen. Dies geschieht mithilfe des Befehls <command>saslpasswd2</command>, der verschiedene Parameter akzeptiert. Die Option <literal>-u</literal> legt die Authentifizierungs-Domain fest, die mit dem Parameter <literal>smtpd_sasl_local_domain</literal> in der Postfix-Konfiguration übereinstimmen muss. Die Option <literal>-c</literal> ermöglicht das Anlegen eines Benutzers und <literal>-f</literal> gestattet es, die Datei zu bestimmen, die benutzt werden soll, wenn die SASL-Datenbank an einem anderen als dem standardmäßig vorgegebenen Ort (<filename>/etc/sasldb2</filename>) gespeichert werden muss.</para>

      <screen role="scale">
<computeroutput># </computeroutput><userinput>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</userinput>
<computeroutput>[... geben Sie Jeans Passwort zweimal ein ...]</computeroutput></screen>

      <para>Beachten Sie, dass die SASL-Datenbank im Verzeichnis von Postfix erstellt worden ist. Um Konsistenz sicherzustellen, wandeln wir außerdem <filename>/etc/sasldb2</filename> in einen symbolischen Verweis um, der auf die von Postfix verwendete Datenbank weist. Dies geschieht mit dem Befehl <command>ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</command>.</para>

      <para>Nun müssen wir Postfix so einstellen, dass es SASL benutzt. Zunächst muss der Benutzer <literal>postfix</literal> zur Gruppe <literal>sasl</literal> hinzugefügt werden, damit er auf die Datenbank des SASL-Kontos zugreifen kann. Einige zusätzliche Parameter sind erforderlich, um SASL zu aktivieren, und der Parameter <literal>smtpd_recipient_restrictions</literal> muss so eingestellt werden, dass Benutzer, die für SASL authentifiziert sind, ungehindert E-Mails versenden können.</para>

      <example>
        <title>SASL in <filename>/etc/postfix/main.cf</filename> aktivieren</title>

        <programlisting>
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]</programlisting>
      </example>

      <sidebar>
        <title><emphasis>EXTRA</emphasis> Authentifizierter SMTP-Client</title>

	<para>Die meisten E-Mail-Clients können sich bei einem SMTP-Server authentifizieren, bevor sie abgehende Nachrichten verschicken, und die Verwendung dieses Merkmals ist einfach eine Frage der passenden Parametereinstellung. Falls der verwendete Client diese Fähigkeit nicht besitzt, besteht eine Umgehungslösung darin, einen lokalen Postfix-Server zu verwenden und ihn für die Weiterleitung der E-Mails über den entfernten SMTP-Server einzustellen. In diesem Fall wird das lokale Postfix selbst der Client sein, der sich bei SASL authentifiziert. Hier sind die erforderlichen Parameter:</para>

        <programlisting>
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]</programlisting>

	<para>Die Datei <filename>/etc/postfix/sasl_passwd</filename> muss den Benutzernamen und das Passwort zur Authentifizierung beim Server <literal>mail.falcot.com</literal> enthalten. Hier ist ein Beispiel:</para>

        <programlisting>
[mail.falcot.com]   joe:LyinIsji</programlisting>

	<para>Wie bei allen Postfix-Zuordnungen muss diese Datei mit dem Befehl <command>postmap</command> in die Datei <filename>/etc/postfix/sasl_passwd.db</filename> umgewandelt werden.</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.http-web-server">
    <title>Webserver (HTTP)</title>

    <para>Die Falcot Corp. Administratoren haben sich entschlossen, den Apache HTTP-Server zu verwenden, der in der Version 2.4.10 in Debian <emphasis role="distribution">Jessie</emphasis> enthalten ist.</para>
    <indexterm><primary><command>apache</command></primary></indexterm>
    <indexterm><primary>Server</primary><secondary>Web</secondary></indexterm>
    <indexterm><primary>Webserver</primary></indexterm>
    <indexterm><primary>Server</primary><secondary>HTTP</secondary></indexterm>
    <indexterm><primary>HTTP</primary><secondary>Server</secondary></indexterm>

    <sidebar>
      <title><emphasis>ALTERNATIVE</emphasis> Andere Webserver</title>

      <para>Apache ist lediglich der am besten bekannte (und meistbenutzte) Webserver, es gibt jedoch auch andere; sie können bei bestimmten Beanspruchungen bessere Leistungen bieten, dies hat jedoch eine Kehrseite in der geringeren Anzahl verfügbarer Leistungsmerkmale und Module. Wenn aber der zu verwendende Webserver zur Bereitstellung statischer Dateien eingesetzt werden oder als Proxy fungieren soll, sind Alternativen wie <emphasis role="pkg">nginx</emphasis> und <emphasis role="pkg">lighttpd</emphasis> eine nähere Betrachtung wert.</para>
      <indexterm><primary><emphasis role="pkg">nginx</emphasis></primary></indexterm>
      <indexterm><primary><emphasis role="pkg">lighttpd</emphasis></primary></indexterm>
    </sidebar>
    <section>
      <title>Apache installieren</title>

      <para>Die Installation des Pakets <emphasis role="pkg">apache2</emphasis> genügt. Es enthält alle Module, einschließlich der <emphasis>Multi-Processing-Module</emphasis> (MPMs), die beeinflussen, wie der Apache mit der parallelen Verarbeitung vieler Anfragen umgeht (die früher in separaten <emphasis role="pkg">apache2-mpm-*</emphasis>-Paketen bereitgestellt wurden). Auch wird es <emphasis role="pkg">apache2-utils</emphasis> mit den Kommandozeilenprogrammen, die wir später behandeln werden, nachladen.</para>

      <para>Das verwendete MPM beeinflusst wesentlich die Art und Weise, wie Apache gleichzeitige Anfragen behandelt. Mit dem <emphasis>worker</emphasis> MPM verwendet es <emphasis>Threads</emphasis> (leichte Prozesse), während es mit dem <emphasis>Prefork</emphasis> MPM einen Pool von im Voraus erstellten Prozessen verwendet. Mit dem <emphasis>Event</emphasis> MPM werden auch Threads verwendet, aber die inaktiven Verbindungen (insbesondere die, die durch das HTTP <emphasis>keep-alive</emphasis> Feature offen gehalten werden) werden an einen dedizierten Management Thread zurückgegeben.</para>

      <para>Die Falcot-Administratoren installieren auch <emphasis role="pkg">libapache2-mod-php5</emphasis>, um die PHP-Unterstützung in den Apache einzubeziehen. Dadurch wird die Standardeinstellung <emphasis>Event</emphasis> MPM deaktiviert, und <emphasis>Prefork</emphasis> wird stattdessen verwendet, da PHP nur unter diesem speziellen MPM funktioniert.</para>

      <sidebar>
        <title><emphasis>SICHERHEIT</emphasis> Ausführung unter dem Benutzer <literal>www-data</literal></title>
        <indexterm><primary><literal>www-data</literal></primary></indexterm>
        <indexterm><primary>suexec</primary></indexterm>

	<para>Standardmäßig verarbeitet Apache ankommende Anfragen unter der Identität des Benutzers <literal>www-data</literal>. Dies bedeutet, dass eine Sicherheitslücke in einem CGI-Skript, das von Apache (für eine dynamische Seite) ausgeführt wird, nicht das ganze System gefährden würde, sondern nur die Dateien im Besitz dieses speziellen Benutzers.</para>

	<para>Der Einsatz der <emphasis>suexec</emphasis>-Module macht es möglich, diese Regel zu umgehen, so dass einige CGI-Skripte unter der Identität eines anderen Benutzers ausgeführt werden. Dies wird mit einer Anweisung der Art <literal>SuexecUserGroup <replaceable>benutzer</replaceable><replaceable>gruppe</replaceable></literal> in der Apache-Konfiguration eingestellt.</para>
        <indexterm><primary><emphasis role="pkg">libapache2-mpm-itk</emphasis></primary></indexterm>

	<para>Eine weitere Möglichkeit besteht darin, ein speziell hierfür vorgesehenes MPM zu benutzen, wie das von <emphasis role="pkg">libapache2-mpm-itk</emphasis> bereitgestellte. Dieses Modul weist ein etwas abweichendes Verhalten auf: es ermöglicht das „Isolieren“ virtueller Hosts (eigentlich eine Anzahl Seiten), so dass jeder von ihnen als ein anderer Benutzer läuft. Eine Schwachstelle in einer Website kann somit keine Dateien gefährden, die dem Benutzer einer anderen Website gehören.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>KURZER BLICK</emphasis> Liste der Module</title>

	<para>Eine vollständige Liste der Apache-Standardmodule ist online zu finden. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/index.html" /></para>
      </sidebar>

      <para>Apache ist ein modularer Server, und viele Leistungsmerkmale werden durch externe Module umgesetzt, die das Hauptprogramm während der Initialisierung lädt. Die Standardkonfiguration aktiviert nur die gebräuchlichsten Module, aber das Aktivieren neuer Module geschieht einfach mit dem Befehl <command>a2enmod <replaceable>modul</replaceable></command>; der Befehl zum Abschalten eines Moduls lautet <command>a2dismod <replaceable>modul</replaceable></command>. Diese Programme erstellen (oder löschen) in Wirklichkeit nur symbolische Verknüpfungen in der Datei <filename>/etc/apache2/mods-enabled/</filename>, die auf die tatsächlichen Dateien zeigen (die in <filename>/etc/apache2/mods-available/</filename> gespeichert sind).</para>

      <para>In seiner Standardkonfiguration nimmt der Webserver an Port 80 Verbindungen an (wie in <filename>/etc/apache2/ports.conf</filename> konfiguriert), und liefert Seiten aus dem Verzeichnis <filename>/var/www/html/</filename> (wie in <filename>/etc/apache2/sites-enabled/000-default.conf</filename> konfiguriert).</para>

      <sidebar>
        <title><emphasis>WEITERE SCHRITTE</emphasis> SSL-Unterstützung hinzufügen</title>
        <indexterm><primary>HTTPS</primary></indexterm>
        <indexterm><primary>HTTP</primary><secondary>sicheres</secondary></indexterm>

	<para>Apache 2.4 bringt von vornherein das für sicheres HTTP (HTTPS) erforderliche Modul mit. Man muss es nur durch den Befehl <command>a2enmod ssl</command> aktivieren und danach die erforderlichen Anweisungen zur Konfigurationsdatei hinzufügen. Ein Konfigurationsbeispiel wird in <filename>/etc/apache2/sites-available/default-ssl.conf</filename> bereitgestellt. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html" /></para>

	<para>Besondere Vorsicht ist angebracht, wenn Sie SSL-Verbindungen mit <emphasis>Perfect Forward Secrecy</emphasis> favorisieren (diese Verbindungen verwenden kurzlebige Sitzungsschlüssel die sicherstellen, dass durch das Knacken des geheimen Schlüssels des Servers nicht auch die Schlüssel vorangegangener verschlüsselter Verbindungen kompromittiert werden, die möglicherweise bei früheren Einbrüchen ins Netzwerk mitgeschnitten wurden). Zu Einzelheiten schauen Sie die Empfehlungen von Mozilla an: <ulink type="block" url="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache" /></para>
	<indexterm><primary><emphasis>Perfect Forward Secrecy</emphasis></primary></indexterm>
      </sidebar>
    </section>
    <section>
      <title>Virtuelle Hosts konfigurieren</title>

      <para>Ein virtueller Host ist eine zusätzliche Identität des Web-Servers.</para>
      <indexterm><primary>virtueller Host</primary></indexterm>

      <para>Apache berücksichtigt zwei verschiedene Arten virtueller Hosts: diejenigen, die auf der IP-Adresse (oder dem Port) basieren, und diejenigen, die sich auf den Domainnamen des Web-Servers stützen. Bei der ersten Methode muss jeder Seite eine andere IP-Adresse (oder ein anderer Port) zugeordnet werden, während die zweite mit einer einzigen IP-Adresse (und einem einzigen Port) auskommt und die Seiten durch den Hostnamen, der vom HTTP-Client gesendet wird, unterschieden werden (was nur in Version 1.1 des HTTP-Protokolls funktioniert - glücklicherweise ist diese Version schon so alt, dass alle Clients sie verwenden).</para>

      <para>Die (zunehmende) Knappheit von IPv4-Adressen begünstigt gewöhnlich die zweite Methode; jedoch ist sie komplizierter, wenn der virtuelle Host auch HTTPS bereitstellen muss, da das SSL-Protokoll nicht von jeher virtuelles Hosting auf Namensbasis ermöglicht hat. Nicht alle Browser können mit der SNI-Erweiterung (<emphasis>Server Name Indication</emphasis>), die diese Kombination ermöglicht, umgehen. Wenn mehrere HTTPS-Seiten auf demselben Server laufen müssen, werden sie gewöhnlich dadurch unterschieden, dass sie auf verschiedenen Ports laufen oder unter verschiedenen IP-Adressen (IPv6 ist hier hilfreich).</para>

      <para>Die Standardkonfiguration für Apache 2 aktiviert virtuelle Hosts auf Namensbasis. Zusätzlich wird ein voreingestellter virtueller Host in der Datei <literal>/etc/apache2/sites-enabled/000-default.conf</literal> ausgewiesen; dieser virtuelle Host wird verwendet, wenn es keinen anderen Host gibt, der zur Anfrage des Clients passt.</para>

      <sidebar>
        <title><emphasis>VORSICHT</emphasis> Erster virtueller Host</title>

	<para>Anfragen an unbekannte virtuelle Hosts werden stets vom ersten ausgewiesenen virtuellen Host bedient, weshalb wir hier als erstes <literal>www.falcot.com</literal> bestimmt haben.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>KURZER BLICK</emphasis> Apache unterstützt SNI</title>
        <indexterm><primary>Server Name Indication</primary></indexterm>

	<para>Der Apache-Server unterstützt eine SSL-Protokollerweiterung namens <emphasis>Server Name Indication</emphasis> (SNI). Diese Erweiterung ermöglicht es dem Browser, den Hostnamen während des Aufbaus der SSL-Verbindung zu senden, viel früher als die HTTP-Anfrage selbst, die vorher dazu benutzt wurde, den gewünschten virtuellen Host unter denen zu identifizieren, die auf demselben Server (mit derselben IP-Adresse und demselben Port) untergebracht sind.</para>

	<para>Vor SNI hätte Apache stets das Zertifikat des voreingestellten virtuellen Hosts verwendet. Clients, die auf einen anderen virtuellen Host zugreifen wollten, würden dann Warnmeldungen anzeigen, da das erhaltene Zertifikat nicht zu der Website passte, auf die sie zugreifen wollten. Glücklicherweise arbeiten die meisten Browser inzwischen mit SNI; hierzu gehören Microsoft Internet Explorer ab Version 7.0 (ab Vista), Mozilla Firefox ab Version 2.0, Apple Safari ab Version 3.2.1 und alle Versionen von Google Chrome.</para>

	<para>Das in Debian bereitgestellte Apache-Paket wird mit Unterstützung für SNI erstellt; daher ist keine besondere Konfiguration erforderlich.</para>

	<para>Man sollte auch darauf achten, dass die Konfiguration des ersten virtuellen Hosts (des standardmäßig verwendeten) TLSv1 aktiviert, da Apache die Parameter dieses ersten virtuellen Hosts verwendet, um sichere Verbindungen aufzubauen, und dies muss ihm auf jeden Fall erlaubt sein!</para>
      </sidebar>

      <para>Jeder zusätzliche virtuelle Host wird dann in einer unter <filename>/etc/apache2/sites-available/</filename> gespeicherten Datei festgelegt. Die Einrichtung einer Website für die Domain <literal>falcot.org</literal> erfordert daher nur die Erstellung der folgenden Datei und anschließend die Aktivierung des virtuellen Hosts mit dem Befehl <command>a2ensite www.falcot.org</command>.</para>

      <example>
        <title>Die Datei <filename>/etc/apache2/sites-available/www.falcot.org.conf</filename></title>

        <programlisting>
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</programlisting>
      </example>

      <para>The Apache server, as configured so far, uses the same log
      files for all virtual hosts (although this could be changed by adding
      <literal>CustomLog</literal> directives in the definitions of the
      virtual hosts). It therefore makes good sense to customize the format
      of this log file to have it include the name of the virtual host.
      This can be done by creating a
      <filename>/etc/apache2/conf-available/customlog.conf</filename> file that defines
      a new format for all log files (with the <literal>LogFormat</literal>
      directive) and by enabling it with <command>a2enconf customlog</command>.
      The <literal>CustomLog</literal> line must also be
      removed (or commented out) from the
      <filename>/etc/apache2/sites-available/000-default.conf</filename>
      file.</para>

      <example>
        <title>Die Datei <filename>/etc/apache2/conf.d/customlog.conf</filename></title>

        <programlisting role="scale">
# Neues Log-Format einschließlich des (virtuellen) Hostnamens
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Jetzt soll dieses „vhost“-Format standardmäßig benutzt werden
CustomLog /var/log/apache2/access.log vhost</programlisting>
      </example>
    </section>
    <section>
      <title>Gebräuchliche Anweisungen</title>

      <para>Dieser Abschnitt rekapituliert in Kürze einige der häufig genutzten Konfigurations-Direktiven von Apache.</para>
      <indexterm><primary>Apache Direktiven</primary></indexterm>
      <indexterm><primary>Direktiven, Apache</primary></indexterm>

      <para>Die Hauptkonfigurationsdatei enthält gewöhnlich mehrere <literal>Directory</literal>-Blöcke; sie ermöglichen es, unterschiedliches Verhalten des Servers in Abhängigkeit von der zu liefernden Datei festzulegen. Solch ein Block enthält häufig Anweisungen des Typs <literal>Options</literal> und <literal>AllowOverride</literal>.</para>
      <indexterm><primary><literal>Options</literal>, Apache Direktive</primary></indexterm>
      <indexterm><primary><literal>AllowOverride</literal>, Apache-Anweisung</primary></indexterm>

      <example>
        <title>Verzeichnisblock</title>

        <programlisting>
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;</programlisting>
      </example>

      <para>Die Anweisung <literal>DirectoryIndex</literal> enthält eine Liste von Dateien, die ausgewählt werden sollen, wenn die Client-Anfrage auf ein Verzeichnis zutrifft. Die in der Liste als erste aufgeführte Datei wird herangezogen und als Antwort gesendet.</para>
      <indexterm><primary><literal>DirectoryIndex</literal>, Apache Direktive</primary></indexterm>

      <para>Auf die Anweisung <literal>Options</literal> folgt eine Liste von zu aktivierenden Optionen. Der Wert <literal>None</literal> deaktiviert alle Optionen; dementsprechend aktiviert <literal>All</literal> alle außer <literal>MultiViews</literal>. Unter anderem stehen folgende Optionen zur Verfügung:</para>
      <itemizedlist>
        <listitem>
	  <para><literal>ExecCGI</literal> bedeutet, dass CGI-Skripte ausgeführt werden können. <indexterm><primary><literal>ExecCGI</literal>, Apache-Anweisung</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>FollowSymlinks</literal> teilt dem Server mit, dass er symbolischen Verweisen folgen kann, und dass die Antwort den Inhalt des Ziels solcher Verweise enthalten soll. <indexterm><primary><literal>FollowSymlinks</literal>, Apache-Anweisung</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>SymlinksIfOwnerMatch</literal> weist den Server ebenfalls an, symbolischen Verweisen zu folgen, aber nur, wenn der Verweis und sein Ziel demselben Benutzer gehören. <indexterm><primary><literal>SymlinksIfOwnerMatch</literal>, Apache-Anweisung</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>Includes</literal> aktiviert <emphasis>Server Side Includes</emphasis> (abgekürzt <emphasis>SSI</emphasis>). Dies sind in HTML-Seiten eingebettete Anweisungen, die bei jeder Anforderung im laufenden Betrieb ausgeführt werden. <indexterm><primary><literal>Includes</literal>, Apache-Anweisung</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>Indexes</literal> weist den Server an, den Inhalt eines Verzeichnisses aufzulisten, falls die von einem Client gesendete HTTP-Anforderung auf ein Verzeichnis ohne Indexdatei weist (das heißt, wenn es in diesem Verzeichnis keine der von der Anweisung <literal>DirectoryIndex</literal> genannten Dateien gibt). <indexterm><primary><literal>Indexes</literal>, Apache-Anweisung</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>MultiViews</literal> aktiviert die Inhaltsabstimmung; diese kann vom Server dazu verwendet werden, eine Webseite in der im Browser eingestellten bevorzugten Sprache anzuzeigen. <indexterm><primary><literal>MultiViews</literal>, Apache-Anweisung</primary></indexterm></para>
        </listitem>
      </itemizedlist>

      <para></para>

      <sidebar>
        <title><emphasis>ZURÜCK ZU DEN GRUNDLAGEN</emphasis> Die Datei <filename>.htaccess</filename></title>

	<para>Die Datei <filename>.htaccess</filename> enthält Apache-Konfigurationsanweisungen, die jedes Mal ausgeführt werden, wenn eine Anforderung ein Element des Verzeichnisses betrifft, in dem diese Datei gespeichert ist. Der Geltungsbereich dieser Anweisungen erstreckt sich auch auf alle darunter befindlichen Unterverzeichnisse.</para>
        <indexterm><primary><filename>.htaccess</filename></primary></indexterm>

	<para>Die meisten Anweisungen, die in einem <literal>Directory</literal>-Block auftreten können, gelten auch in einer <filename>.htaccess</filename>-Datei.</para>
      </sidebar>

      <para>Die Anweisung <literal>AllowOverride</literal> führt alle Optionen auf, die mithilfe einer <filename>.htaccess</filename>-Datei aktiviert oder deaktiviert werden können. Eine verbreitete Anwendung dieser Option besteht darin, <literal>ExecCGI</literal> einzuschränken, so dass der Administrator entscheidet, welchen Benutzern es erlaubt ist, Programme unter der Identität des Web-Servers (des Benutzers <literal>www-data</literal>) auszuführen.</para>
      <indexterm><primary><literal>AllowOverride</literal>, Apache-Anweisung</primary></indexterm>
      <section>
        <title>Authentifizierung verlangen</title>
        <indexterm><primary>Web-Authentifizierung</primary></indexterm>

	<para>Unter manchen Umständen muss der Zugang zu Teilen einer Website beschränkt werden, so dass nur berechtigte Benutzer, die einen Benutzernamen und ein Passwort angeben, Zugang zum Inhalt erhalten.</para>

        <example>
          <title>Authentifizierung für die Datei <filename>.htaccess</filename> verlangen</title>

          <programlisting>
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private</programlisting>
        </example>

        <sidebar>
          <title><emphasis>SICHERHEIT</emphasis> Keine Sicherheit</title>

	  <para>Das in oben stehendem Beispiel verwendete Authentifizierungssystem (<literal>Basic</literal>) bietet nur geringfügige Sicherheit, da das Passwort als Klartext gesendet wird (es ist nur als <emphasis>base64</emphasis> kodiert, die eine einfache Kodierungs- aber keine Verschlüsselungsmethode ist). Es sollte auch beachtet werden, dass die mit diesem Verfahren „geschützten“ Dokumente ebenfalls als Klartext über das Netzwerk laufen. Falls Sicherheit wichtig ist, sollte die gesamte HTTP-Verbindung mit SSL verschlüsselt sein.</para>
        </sidebar>

	<para>Die Datei <filename>/etc/apache2/authfiles/htpasswd-private</filename> enthält eine Liste von Benutzern und Passwörtern; sie wird normalerweise mit dem Befehl <command>htpasswd</command> gehandhabt. Der folgende Befehl wird zum Beispiel dazu benutzt, einen Benutzer hinzuzufügen oder sein Passwort zu ändern: <indexterm><primary><command>htpasswd</command></primary></indexterm></para>

        <screen>
<computeroutput># </computeroutput><userinput>htpasswd /etc/apache2/authfiles/htpasswd-private <replaceable>user</replaceable>
</userinput><computeroutput>New password:
Re-type new password:
Adding password for user <replaceable>user</replaceable>
</computeroutput></screen>
      </section>
      <section>
        <title>Zugang beschränken</title>
        <indexterm><primary>Web-Zugangsbeschränkung</primary></indexterm>

	<para>Die Direktive <literal>Require</literal> steuert Zugriffsbeschränkungen für Verzeichnisse (und rekursiv, deren Unterverzeichnisse).</para>

	<indexterm><primary>Apache Direktiven</primary></indexterm>
	<indexterm><primary>Direktiven, Apache</primary></indexterm>
	<indexterm><primary><literal>Require</literal>, Apache-Richtlinie</primary></indexterm>

	<para>Es kann eingesetzt werden, um den Zugriff auf der Grundlage vieler Kriterien zu beschränken. Wir werden uns darauf beschränken, die Zugriffsbeschränkung auf der Grundlage der IP-Adresse des Clients zu beschreiben, aber es kann viel mächtiger gemacht werden, besonders wenn mehrere <literal>Require</literal> Direktiven in einem <literal>RequireAll</literal>-Block kombiniert werden.</para>

        <example>
          <title>Only allow from the local network</title>

          <programlisting>Require ip 192.168.0.0/16</programlisting>
        </example>

      <sidebar>
        <title><emphasis>ALTERNATIVE</emphasis> Old syntax</title>

        <para>Die Syntax <literal>Require</literal> ist nur in Apache 2.4 verfügbar (die Version in <emphasis role="distribution">Jessie</emphasis>). Für Benutzer von <emphasis role="distribution">Wheezy</emphasis> ist die Syntax des Apache 2.2 anders, und wir beschreiben sie hier hauptsächlich als Referenz, obwohl sie auch in Apache 2.4 durch das Modul <literal>mod_access_compat</literal> verfügbar ist.</para>

	<para>Die Direktiven <literal>Allow from</literal> und <literal>Deny from</literal> steuern Zugriffsbeschränkungen für Verzeichnisse (und, rekursiv, deren Unterverzeichnisse).</para>

	<indexterm><primary><literal>Allow from</literal>, Apache directive</primary></indexterm>
	<indexterm><primary><literal>Deny from</literal>, Apache directive</primary></indexterm>
	<indexterm><primary><literal>Order</literal>, Apache directive</primary></indexterm>

	<para>Die Anweisung <literal>Order</literal> informiert den Server über die Reihenfolge, in der die Anweisungen <literal>Allow from</literal> und <literal>Deny from</literal> angewendet werden; die zuletzt zutreffende erhält Vorrang. Konkret erlaubt <literal>Order deny,allow</literal> Zugang, falls kein <literal>Deny from</literal> gilt, oder falls eine <literal>Allow from</literal> Anweisung zutrifft. Umgekehrt verweigert <literal>Order allow,deny</literal> den Zugang, falls keine <literal>Allow from</literal> Anweisung zutrifft (oder falls eine <literal>Deny from</literal> Anweisung gilt).</para>

	<para>Auf die Anweisungen <literal>Allow from</literal> und <literal>Deny from</literal> kann eine IP-Adresse folgen, ein Netzwerk (wie zum Beispiel <literal>192.168.0.0/255.255.255.0</literal>, <literal>192.168.0.0/24</literal> oder sogar <literal>192.168.0</literal>), ein Host- oder Domain-Name oder das Schlüsselwort <literal>all</literal>, das jeden bezeichnet.</para>

        <para>Zum Beispiel, um Verbindungen standardmäßig abzulehnen, sie aber aus dem lokalen Netzwerk zuzulassen, können Sie folgendes verwenden:</para>
        <programlisting>
Order deny,allow
Allow from 192.168.0.0/16
Deny from all</programlisting>
        </sidebar>
      </section>
    </section>
    <section>
      <title>Protokoll-Analysatoren</title>

      <para>Häufig wird ein Protokoll-Analysator auf einem Web-Server installiert, da er den Administratoren ein genaues Bild der Einsatzmuster des Servers vermittelt.</para>

      <para>Die Falcot Corp. Administratoren haben <emphasis>AWStats</emphasis> (<emphasis>Advanced Web Statistics</emphasis>) für die Analyse ihrer Apache-Protokolldateien ausgewählt.</para>
      <indexterm><primary><emphasis>AWStats</emphasis></primary></indexterm>
      <indexterm><primary>Webprotokoll-Analysator</primary></indexterm>
      <indexterm><primary>Protokolle</primary><secondary>Webprotokoll-Analysator</secondary></indexterm>
      <indexterm><primary>Webprotokoll-Analysator</primary></indexterm>

      <para>Der erste Konfigurierungsschritt besteht darin, die Datei <filename>/etc/awstats/awstats.conf</filename> anzupassen. Die Falcot Administratoren lassen sie bis auf die folgenden Parameter unverändert:</para>

      <programlisting>
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</programlisting>

      <para>All diese Parameter sind durch Kommentare in der Vorlagendatei dokumentiert. Insbesondere bezeichnen die Parameter <varname>LogFile</varname> und <varname>LogFormat</varname> den Ort und das Format der Protokolldatei sowie die Information, die sie enthält; <varname>SiteDomain</varname> und <varname>HostAliases</varname> führen die verschiedenen Bezeichnungen auf, unter denen die Haupt-Website bekannt ist.</para>

      <para>Für Internet-Präsenzen mit starkem Datenverkehr sollte <varname>DNSLookup</varname> normalerweise nicht auf <literal>1</literal> gesetzt werden; für kleinere, wie die oben beschriebene Falcot-Site, ermöglicht diese Einstellung jedoch besser lesbare Berichte, die vollständige Rechnernamen enthalten statt unverarbeiteter IP-Adressen.</para>

      <sidebar>
        <title><emphasis>SICHERHEIT</emphasis> Zugang zu Statistiken</title>

	<para>AWStats stellt seine Statistiken auf der Website standardmäßig ohne Beschränkungen zur Verfügung, jedoch können Beschränkungen eingerichtet werden, so dass nur einige (wohl interne) IP-Adressen auf sie zugreifen können; die Liste der zugelassenen IP-Adressen muss in dem Parameter <varname>AllowAccessFromWebToFollowingIPAddresses</varname> festgelegt werden</para>
      </sidebar>

      <para>AWStats wird auch für andere virtuelle Hosts aktiviert; jeder virtuelle Host benötigt seine eigene Konfigurationsdatei, wie zum Beispiel <filename>/etc/awstats/awstats.www.falcot.org.conf</filename>.</para>

      <example>
        <title>AWStats-Konfigurationsdatei für einen virtuellen Host</title>

        <programlisting>
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"</programlisting>
      </example>

      <para>AWStats verwendet zahlreiche im Verzeichnis <filename>/usr/share/awstats/icon/</filename> gespeicherte Piktogramme. Damit diese Symbole auf der Website zur Verfügung stehen, muss die Apache-Konfiguration durch das Hinzufügen folgender Anweisung angepasst werden:</para>

      <programlisting>
Alias /awstats-icon/ /usr/share/awstats/icon/</programlisting>

      <para>Einige Minuten später (und nachdem das Skript einige Male gelaufen ist) stehen die Ergebnisse online zur Verfügung: <ulink type="block" url="http://www.falcot.com/cgi-bin/awstats.pl" /><ulink type="block" url="http://www.falcot.org/cgi-bin/awstats.pl" /></para>

      <sidebar>
        <title><emphasis>VORSICHT</emphasis> Rotation von Protokolldateien</title>

	<para>Damit die Statistiken alle Protokolle berücksichtigen, muss <emphasis>AWStats</emphasis> unmittelbar vor dem Rotieren der Apache-Protokolldateien ausgeführt werden. Ein Blick auf die Direktive <literal>prerotate</literal> in der Datei <filename>/etc/logrotate.d/apache2</filename>, zeigt, dass man das durch Einfügen eines Symlinks auf  <filename>/usr/share/awstats/tools/update.sh</filename> in <filename>/etc/logrotate.d/httpd-prerotate</filename> erreicht:</para>

        <screen><computeroutput>$ </computeroutput><userinput>cat /etc/logrotate.d/apache2
</userinput><computeroutput>/var/log/apache2/*.log {
  daily
  missingok
  rotate 14
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    if /etc/init.d/apache2 status &gt; /dev/null ; then \
      /etc/init.d/apache2 reload &gt; /dev/null; \
    fi;
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ </computeroutput><userinput>sudo mkdir -p /etc/logrotate.d/httpd-prerotate
</userinput><computeroutput>$ </computeroutput><userinput>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats
</userinput></screen>

	<para>Beachten Sie auch, dass die von <command>logrotate</command> erzeugten Protokolldateien für jeden lesbar sein müssen, insbesondere für AWStats. In oben stehendem Beispiel wird dies durch die Zeile <literal>create 644 root adm</literal> (anstelle der voreingestellten Berechtigung <literal>640</literal>) gewährleistet.</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.ftp-file-server">
    <title>FTP-Dateiserver</title>
    <indexterm><primary>FTP (<emphasis>File Transfer Protocol</emphasis>)</primary></indexterm>

    <para>FTP (<emphasis>File Transfer Protocol</emphasis>) ist eines der ersten Internet-Protokolle (RFC 959 ist 1985 veröffentlicht worden!). Es wurde zur Verteilung von Dateien benutzt, sogar schon bevor das Web geboren war (das HTTP-Protokoll wurde 1990 entwickelt und formal in seiner 1.0 Version durch RFC 1945 festgelegt, die 1996 veröffentlicht worden ist).</para>

    <para>Dieses Protokoll ermöglicht sowohl das Hoch- als auch das Herunterladen von Dateien; daher wird es noch häufig verwendet, um Aktualisierungen auf einer bei einem Internetdienstanbieter untergebrachten Website einzustellen (oder bei irgendeiner anderen Stelle, die Websites aufnimmt). In diesen Fällen wird ein sicherer Zugriff durch eine Benutzerkennung und ein Passwort erreicht; nach der erfolgreichen Authentifizierung gewährt der FTP-Server Lese- und Schreibzugriff auf das Benutzerverzeichnis des jeweiligen Benutzers.</para>

    <para>Andere FTP-Server dienen in erster Linie dazu, Dateien zum öffentlichen Download zu verbreiten; Debian-Pakete sind hierfür ein gutes Beispiel. Der Inhalt dieser Server wird von anderen, geografisch entfernten Servern bezogen; er wird dann weniger entfernten Benutzern zur Verfügung gestellt. Dies bedeutet, dass Client-Authentifizierung nicht erforderlich ist; daher wird diese Betriebsart als „anonymes FTP“ bezeichnet. Um ganz genau zu sein, authentifizieren sich die Clients mit dem Benutzernamen <literal>anonymous</literal>; das Passwort ist dabei üblicherweise die E-Mail-Adresse des Benutzers, aber der Server ignoriert sie.</para>

    <para>In Debian stehen zahlreiche FTP-Server zur Verfügung (<emphasis role="pkg">ftpd</emphasis>, <emphasis role="pkg">proftpd-basic</emphasis>, <emphasis role="pkg">pyftpd</emphasis> und so weiter). Die Falcot Corp. Administratoren haben <emphasis role="pkg">vsftpd</emphasis> gewählt, weil sie den FTP-Server nur dazu benutzen, einige Dateien zu verbreiten (einschließlich eines Debian-Paketdepots); da sie keine weitergehenden Leistungsmerkmale benötigen, haben sie sich dafür entschieden, die Sicherheitsaspekte in den Mittelpunkt zu stellen.</para>
    <indexterm><primary><emphasis role="pkg">vsftpd</emphasis></primary></indexterm>

    <para>Installing the package creates an <literal>ftp</literal> system
    user. This account is always used for anonymous FTP connections, and
    its home directory (<filename>/srv/ftp/</filename>) is the root of the
    tree made available to users connecting to this service. The default
    configuration (in <filename>/etc/vsftpd.conf</filename>) requires some
    changes to cater to the simple need of making big files available
    for public downloads: anonymous access needs to be enabled
    (<literal>anonymous_enable=YES</literal>) and read-only access of
    local users needs to be disabled (<literal>local_enable=NO</literal>).
    The latter is particularly important since the FTP protocol doesn't
    use any form of encryption and the user password could be intercepted
    over the wire.
    </para>
  </section>
  <section id="sect.nfs-file-server">
    <title>NFS-Dateiserver</title>

    <para>NFS (<emphasis>Network File System</emphasis>) ist ein Protokoll, das den Fernzugriff auf ein Dateisystem über ein Netzwerk ermöglicht. Alle Unix-Systeme sind in der Lage, mit diesem Protokoll umzugehen; wenn Windows-Systeme beteiligt sind, muss stattdessen Samba eingesetzt werden.</para>
    <indexterm><primary>NFS</primary></indexterm>
    <indexterm><primary><emphasis>Netzwerk</emphasis></primary><secondary><emphasis>Dateisystem</emphasis></secondary></indexterm>
    <indexterm><primary>Dateisystem</primary><secondary>Netzwerk</secondary></indexterm>
    <indexterm><primary>Datei</primary><secondary>Server</secondary></indexterm>
    <indexterm><primary>Server</primary><secondary>Datei</secondary></indexterm>

    <para>NFS ist ein sehr nützliches Werkzeug, hat aber in der Vergangenheit unter vielen Einschränkungen gelitten, von denen die meisten mit Version 4 des Protokolls gelöst wurden. Der Nachteil ist, dass die neueste Version von NFS schwieriger zu konfigurieren ist, wenn Sie grundlegende Sicherheitsfunktionen wie Authentifizierung und Verschlüsselung nutzen wollen, da sie dafür auf Kerberos basiert. Ohne diese muss das NFS-Protokoll auf ein vertrauenswürdiges lokales Netzwerk beschränkt werden, da Daten unverschlüsselt über das Netzwerk gehen (ein <emphasis>Sniffer</emphasis> kann es abfangen) und Zugriffsrechte basierend auf der IP-Adresse des Clients vergeben werden (die gefälscht werden kann).</para>

    <sidebar>
      <title><emphasis>DOKUMENTATION</emphasis> NFS-HOWTO</title>

      <para>Eine gute Dokumentation für den Einsatz von NFSv4 ist selten. Hier sind einige Quellen mit Inhalten unterschiedlicher Qualität, aber das sollte zumindest einige Hinweise darauf geben, was man tun kann. <ulink type="block" url="https://help.ubuntu.com/community/NFSv4Howto" /> <ulink type="block" url="http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration" /></para>
    </sidebar>
    <section>
      <title>NFS absichern</title>
      <indexterm><primary>NFS</primary><secondary>Sicherheit</secondary></indexterm>

      <para>If you don't use the Kerberos-based security features, 
      it is vital to ensure that only the machines allowed to use NFS can
      connect to the various required RPC servers, because the basic
      protocol trusts the data received from the network. The firewall
      must also block <emphasis>IP spoofing</emphasis> so as to prevent an
      outside machine from acting as an inside one, and access to the
      appropriate ports must be restricted to the machines meant to access
      the NFS shares.</para>

      <sidebar>
        <title><emphasis>ZURÜCK ZU DEN GRUNDLAGEN</emphasis> RPC</title>

	<para>RPC (<emphasis>Remote Procedure Call</emphasis>) ist ein Unix-Standard für entfernte Dienste. NFS ist ein solcher Dienst.</para>
        <indexterm><primary>RPC</primary></indexterm>
        <indexterm><primary><emphasis>Remote Procedure Call</emphasis></primary></indexterm>

	<para>RPC-Dienste tragen sich in einem als <emphasis>portmapper</emphasis> bekannten Verzeichnis ein. Ein Client, der eine NFS-Anfrage durchführen möchte, wendet sich zunächst an den <emphasis>portmapper</emphasis> (auf Port 111, entweder TCP oder UDP) und fragt nach dem NFS-Server; die Antwort nennt normalerweise Port 2049 (den Standardport für NFS). Nicht alle RPC-Dienste verwenden notwendigerweise einen festen Port.</para>
      </sidebar>

      <para>Ältere Versionen des Protokolls erforderten andere RPC-Dienste, die dynamisch zugewiesene Ports verwendeten. Glücklicherweise werden bei NFS Version 4 nur Port 2049 (für NFS) und 111 (für den Portmapper) benötigt und sind somit einfach per Firewall zu sichern.</para>
      <indexterm><primary><command>portmapper</command></primary></indexterm>

    </section>
    <section>
      <title>NFS-Server</title>

      <para>Der NFS-Server ist Teil des Linux-Kernels; in den von Debian bereitgestellten Kerneln ist er als Kernel-Modul eingebaut. Falls der NFS-Server beim Hochfahren automatisch anlaufen soll, sollte das Paket <emphasis role="pkg">nfs-kernel-server</emphasis> installiert werden; es enthält die entsprechenden Start-Skripten.</para>

      <para>Die Konfigurationsdatei des NFS-Servers, <filename>/etc/exports</filename>, listet die Verzeichnisse auf, die über das Netzwerk zur Verfügung gestellt werden (<emphasis>exported</emphasis>). Zu jeder NFS-Freigabe wird nur den Rechnern Zugang gewährt, die auf dieser Liste stehen. Eine feiner eingestellte Zugangskontrolle kann durch einige Optionen erzielt werden. Die Syntax dieser Datei ist recht einfach:</para>
      <indexterm><primary><filename>exports</filename></primary></indexterm>
      <indexterm><primary><filename>/etc/exports</filename></primary></indexterm>

      <programlisting>
/freizugebendes/verzeichnis rechner1(option1,option2,...) rechner2(...) ...</programlisting>

      <para>Beachten Sie, dass bei NFSv4 alle exportierten Verzeichnisse Teil einer einzigen Hierarchie sein müssen und dass das Wurzelverzeichnis dieser Hierarchie exportiert und mit der Option <literal>fsid=0</literal> oder <literal>fsid=root</literal> identifiziert werden muss.</para>

      <para>Jeder Rechner kann entweder durch seinen DNS-Namen oder seine IP-Adresse bestimmt werden. Ganze Rechnergruppen können auch festgelegt werden, indem entweder eine Syntax wie <literal>*.falcot.com</literal> oder ein IP-Adressbereich wie <literal>192.168.0.0/255.255.255.0</literal> oder <literal>192.168.0.0/24</literal> verwendet wird.</para>

      <para>Verzeichnisse werden in der Standardeinstellung (oder durch die Option <literal>ro</literal>) schreibgeschützt bereitgestellt. Die Option <literal>rw</literal> ermöglicht Schreibzugriff. NFS-Clients nehmen typischerweise über einen Port Verbindung auf, der Administratorrechte erfordert (mit anderen Worten, unterhalb von 1024); diese Einschränkung kann mit der Option <literal>insecure</literal> aufgehoben werden (die Option <literal>secure</literal> ist stillschweigend eingestellt, kann aber auch ausdrücklich angegeben werden, wenn dies der Deutlichkeit halber erforderlich ist).</para>
      <indexterm><primary>NFS</primary><secondary>Optionen</secondary></indexterm>

      <para>Standardmäßig beantwortet der Server eine NFS-Anfrage nur dann, wenn der gegenwärtige Plattenzugriff beendet ist (Option <literal>sync</literal>); dies kann durch die Option <literal>async</literal> abgestellt werden. Asynchrones Schreiben erhöht die Leistung ein wenig, es verringert jedoch die Zuverlässigkeit, da die Gefahr eines Datenverlusts besteht, falls der Server zwischen der Annahmebestätigung des Schreibauftrags und dem tatsächlichen Schreibvorgang auf der Festplatte abstürzt. Da der voreingestellte Wert (im Vergleich zur früheren Einstellung von NFS) kürzlich geändert wurde, empfiehlt es sich, ihn ausdrücklich einzustellen.</para>

      <para>Um einem NFS-Client keinen Root-Zugriff auf das Dateisystem zu geben, werden alle Anfragen, die von einem Root-Benutzer zu kommen scheinen, vom Server so angesehen, als kämen sie vom Benutzer <literal>nobody</literal>. Dieses Verhalten entspricht der Option <literal>root_squash</literal> und ist standardmäßig aktiviert. Die Option <literal>no_root_squash</literal>, die dieses Verhalten abstellt, ist gefährlich und sollte nur in überwachten Umgebungen eingesetzt werden. Die Optionen <literal>anonuid=<replaceable>uid</replaceable></literal> und <literal>anongid=<replaceable>gid</replaceable></literal> ermöglichen es, anstelle von UID/GID 65534 (was dem User <literal>nobody</literal> und der Gruppe <literal>nogroup</literal> entspricht) einen anderen fingierten Benutzer anzugeben.</para>

      <para>Mit NFSv4 können Sie die Option <literal>sec</literal> hinzufügen, um die gewünschte Sicherheitsstufe anzugeben: <literal>sec=sys</literal> ist der Standard ohne spezielle Sicherheitsmerkmale, <literal>sec=krb5</literal> aktiviert nur die Authentifizierung, <literal>sec=krb5i</literal> fügt Integritätsschutz hinzu, und <literal>sec=krb5p</literal> ist die umfassendste Stufe, die Datenschutz (mit Datenverschlüsselung) enthält. Damit dies funktioniert, benötigen Sie ein funktionierendes Kerberos-Setup (dieser Service wird in diesem Buch nicht behandelt).</para>

      <para>Weitere Optionen stehen zur Verfügung; sie sind auf der Handbuchseite <citerefentry><refentrytitle>exports</refentrytitle> <manvolnum>5</manvolnum></citerefentry> dokumentiert.</para>

      <sidebar>
        <title><emphasis>VORSICHT</emphasis> Erste Installation</title>

	<para>Das Start-Skript <filename>/etc/init.d/nfs-kernel-server</filename> startet den Server nur dann, wenn <filename>/etc/exports</filename> eine oder mehrere gültig NFS-Freigaben auflistet. Daher muss der NFS-Server, sobald diese Datei bei der Erstkonfigurierung dahingehend geändert wurde, dass sie gültige Einträge enthält, mit folgendem Befehl gestartet werden:</para>

        <screen>
<computeroutput># </computeroutput><userinput>service nfs-kernel-server start</userinput></screen>
      </sidebar>
    </section>
    <section>
      <title>NFS-Client</title>
      <indexterm><primary>Client</primary><secondary>NFS</secondary></indexterm>
      <indexterm><primary>NFS</primary><secondary>Client</secondary></indexterm>

      <para>Wie bei anderen Dateisystemen, so erfordert auch das Einbinden einer NFS-Freigabe in die Systemhierarchie, dass sie eingehängt wird. Da dieses Dateisystem seine Besonderheiten hat, waren einige Anpassungen in den Syntaxen des Befehls <command>mount</command> und der Datei <filename>/etc/fstab</filename> erforderlich.</para>

      <example>
        <title>Manuelles Einhängen mit dem Befehl <command>mount</command></title>

        <screen>
          <computeroutput># </computeroutput><userinput>mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/shared</userinput></screen>
      </example>

      <example>
        <title>NFS-Eintrag in der Datei <filename>/etc/fstab</filename></title>

        <programlisting>
arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0 0</programlisting>
      </example>

      <para>The entry described above mounts, at system startup, the
      <filename>/shared/</filename> NFS directory from the
      <literal>arrakis</literal> server into the local
      <filename>/srv/shared/</filename> directory. Read-write access is
      requested (hence the <literal>rw</literal> parameter). The
      <literal>nosuid</literal> option is a protection measure that wipes
      any <literal>setuid</literal> or <literal>setgid</literal> bit from
      programs stored on the share. If the NFS share is only meant to store
      documents, another recommended option is <literal>noexec</literal>,
      which prevents executing programs stored on the share. Note that
      on the server, the <filename>shared</filename> directory is below
      the NFSv4 root export (for example
      <filename>/export/shared</filename>), it is not a top-level
      directory.</para>

      <para>Die Handbuchseite <citerefentry><refentrytitle>nfs</refentrytitle> <manvolnum>5</manvolnum></citerefentry> beschreibt alle Optionen näher.</para>
    </section>
  </section>
  <section id="sect.windows-file-server-with-samba">
    <title>Einrichten von Windows-Freigaben mit Samba</title>

    <para>Samba ist ein Satz von Programmen, die das SMB-Protokoll (auch als „CIFS“ bekannt) auf Linux handhaben. Dieses Protokoll wird von Windows für Netzwerk-Freigaben und Netzwerkdrucker benutzt.</para>
    <indexterm><primary>Windows-Freigabe</primary></indexterm>
    <indexterm><primary>Samba</primary></indexterm>
    <indexterm><primary>SMB</primary></indexterm>
    <indexterm><primary>CIFS</primary></indexterm>
    <indexterm><primary>Server</primary><secondary>Datei</secondary></indexterm>

    <para>Samba kann auch als Domänencontroller unter Windows agieren. Es ist ein hervorragendes Instrument, um die nahtlose Integration von Linux-Servern und Arbeitsplatzrechnern, die noch unter Windows laufen, zu gewährleisten.</para>
    <section>
      <title>Samba-Server</title>

      <para>Das Paket <emphasis role="pkg">samba</emphasis> enthält die beiden Hauptserver von Samba 4, <command>smbd</command> und <command>nmbd</command>.</para>
      <indexterm><primary><command>smbd</command></primary></indexterm>
      <indexterm><primary><command>nmbd</command></primary></indexterm>

      

      <sidebar>
        <title><emphasis>DOKUMENTATION</emphasis> Weitere Schritte</title>

	<para>The Samba server is extremely configurable and versatile, and
	can address a great many different use cases matching very
	different requirements and network architectures. This book only
        focuses on the use case where Samba is used as a standalone server,
        but it can also be a NT4 Domain Controller or a full Active
        Directory Domain Controller, or a simple member of an existing
        domain (which could be a managed by a Windows server).</para>
        <indexterm><primary>Domain-Controller</primary></indexterm>
        <indexterm><primary>Windows Domäne</primary></indexterm>

	<para>Das Paket <emphasis role="pkg">samba-doc</emphasis> enthält eine Fülle kommentierter Beispieldateien in <filename>/usr/share/doc/samba-doc/examples/</filename>.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>HILFSPROGRAMM</emphasis> Mit einem Windows-Server authentifizieren</title>

	<para>Winbind gibt Systemadministratoren die Möglichkeit, einen Windows-Server als Authentifizierungsserver zu verwenden. Winbind integriert sich auch sauber in PAM und NSS. Dies ermöglicht es, Linux-Rechner so einzurichten, dass alle Benutzer einer Windows-Domäne automatisch ein Konto erhalten.</para>
        <indexterm><primary>Winbind</primary></indexterm>

	<para>More information can be found in the
	<filename>/usr/share/doc/samba-doc/examples/pam_winbind/</filename>
	directory.</para>
      </sidebar>
      <section>
        <title>Mit <command>debconf</command> konfigurieren</title>

	<para>The package sets up a minimal configuration during the initial
        installation but you should really run <command>dpkg-reconfigure
        samba-common</command> to adapt it:</para>

	<para>Die erste benötigte Information ist der Name der Arbeitsgruppe, zu der der Samba-Server gehören soll (die Antwort in unserem Fall ist <literal>FALCOTNET</literal>).</para>

	<para>Das Paket schlägt auch vor, den WINS-Server mithilfe der Information, die vom DHCP-Daemon bereitgestellt wird, zu identifizieren. Die Falcot Corp. Administratoren haben diese Option abgelehnt, da sie beabsichtigen, den Samba-Server selbst als WINS-Server zu verwenden.</para>
        <indexterm><primary>WINS</primary></indexterm>
      </section>
      <section>
        <title>Von Hand konfigurieren</title>
        <section>
          <title>Änderungen in <filename>smb.conf</filename></title>

	  <para>Aufgrund der Erfordernisse bei Falcot müssen weitere Optionen in der Konfigurationsdatei <filename>/etc/samba/smb.conf</filename> angepasst werden. Die folgenden Auszüge fassen die Änderungen zusammen, die im Abschnitt <literal>[global]</literal> vorgenommen wurden.</para>

          <programlisting>
[global]

## Browsing/Identification ###

# Change this to the workgroup/NT-domain name your Samba server will part of
   workgroup = FALCOTNET

# Windows Internet Name Serving Support Section:
# WINS Support - Tells the NMBD component of Samba to enable its WINS Server
   wins support = yes <co id="smb.conf.wins"></co>

[...]

####### Authentication #######

# Server role. Defines in which mode Samba will operate. Possible
# values are "standalone server", "member server", "classic primary
# domain controller", "classic backup domain controller", "active
# directory domain controller". 
#
# Most people will want "standalone sever" or "member server".
# Running as "active directory domain controller" will require first
# running "samba-tool domain provision" to wipe databases and create a
# new domain.
   server role = standalone server

# "security = user" is always a good idea. This will require a Unix account
# in this server for every user accessing the server.
   security = user <co id="smb.conf.security"></co>

[...]</programlisting>
          <calloutlist>
            <callout arearefs="smb.conf.wins">
	      <para>Zeigt an, dass Samba für das lokale Netzwerk als ein Netbios-Namensserver (WINS) dienen soll.</para>
            </callout>
            <callout arearefs="smb.conf.security">
	      <para>Dies ist die Standardeinstellung dieses Parameters; da er jedoch für die Samba-Konfiguration wesentlich ist, wird empfohlen, ihn ausdrücklich einzutragen. Jeder Benutzer muss sich vor dem Zugriff auf eine Freigabe authentifizieren.</para>
            </callout>
          </calloutlist>
        </section>
        <section>
          <title>Benutzer hinzufügen</title>

	  <para>Jeder Samba-Benutzer benötigt ein Konto auf dem Server; als erstes müssen die Unix-Konten erstellt, dann die Benutzer in Sambas Datenbank eingetragen werden. Der Unix-Schritt verläuft wie üblich (zum Beispiel unter Verwendung von <command>adduser</command>).</para>

	  <para>Das Hinzufügen eines bestehenden Benutzers zur Samba-Datenbank erfolgt durch den Befehl <command>smbpasswd -a <replaceable>benutzer</replaceable></command>; dieser Befehl fragt interaktiv nach dem Passwort.</para>

	  <para>Ein Benutzer kann mit dem Befehl <command>smbpasswd -x <replaceable>benutzer</replaceable></command> gelöscht werden. Auch ein Samba-Konto kann zeitweilig deaktiviert werden (mit <command>smbpasswd -d <replaceable>benutzer</replaceable></command>) und später wieder reaktiviert (mit <command>smbpasswd -e <replaceable>benutzer</replaceable></command>).</para>
        </section>
      </section>
    </section>
    <section>
      <title>Samba-Client</title>

      <para>Die Client-Merkmale in Samba ermöglichen es einem Linux-Rechner, auf Windows-Freigaben und freigegebene Rechner zuzugreifen. Die hierfür benötigten Programme befinden sich in den Paketen <emphasis role="pkg">cifs-utils</emphasis> und <emphasis role="pkg">smbclient</emphasis>.</para>
      <indexterm><primary><emphasis>smbclient</emphasis></primary></indexterm>
      <indexterm><primary><emphasis>cifs-utils</emphasis></primary></indexterm>
      <section>
        <title>Das Programm <command>smbclient</command></title>

	<para>Das Programm <command>smbclient</command> stellt Anfragen an SMB-Server. Es nimmt die Option <literal>-U <replaceable>benutzer</replaceable></literal> entgegen, um sich mit dem Server unter einer bestimmten Identität zu verbinden. <command>smbclient //<replaceable>server</replaceable>/<replaceable>freigabe</replaceable></command> greift interaktiv auf die Freigabe zu, in ähnlicher Weise wie der FTP-Client auf der Befehlszeile. <command>smbclient -L <replaceable>server</replaceable></command> listet alle auf einem Server verfügbaren (und sichtbaren) Freigaben auf.</para>
      </section>
      <section>
        <title>Windows-Freigaben einhängen</title>

	<para>Der Befehl <command>mount</command> ermöglicht es (mit Hilfe von <command>mount.cifs</command> aus dem Paket <emphasis role="pkg">cifs-utils</emphasis>), eine Windows-Freigabe in die Linux-Dateisystemhierarchie  einzuhängen.</para>
        <indexterm><primary><command>mount.cifs</command></primary></indexterm>
	<indexterm><primary>Windows-Freigabe, einhängen einer</primary></indexterm>

        <example>
          <title>Eine Windows-Freigabe einhängen</title>

          <programlisting>
mount -t cifs //arrakis/shared /shared \
      -o credentials=/etc/smb-credentials</programlisting>
        </example>

	<para>Die Datei <filename>/etc/smb-credentials</filename> (die nicht von Benutzern lesbar sein darf) hat das folgende Format:</para>

        <programlisting>
username = <replaceable>benutzer</replaceable>
password = <replaceable>passwort</replaceable></programlisting>

	<para>Weitere Optionen können auf der Befehlszeile angegeben werden; sie sind auf der Handbuchseite <citerefentry><refentrytitle>mount.cifs</refentrytitle> <manvolnum>1</manvolnum></citerefentry> vollständig aufgelistet. Insbesondere zwei Optionen können interessant sein: <literal>uid</literal> und <literal>gid</literal> ermöglichen es, den Benutzer und die Gruppe der am Einhängepunkt verfügbaren Dateien einzustellen, um den Zugriff nicht auf den Administrator zu begrenzen.</para>

	<para>EIn Einhängen einer Windows-Freigabe kann auch in <filename>/etc/fstab</filename> konfiguriert werden:</para>

        <programlisting>
//<replaceable>server</replaceable>/shared /shared cifs credentials=/etc/smb-credentials</programlisting>

	<para>Eine SMB/CIFS-Freigabe wird mit dem Befehl <command>umount</command> ausgehängt.</para>
      </section>
      <section>
        <title>Auf einem Netzwerkdrucker drucken</title>

	<para>CUPS ist eine elegante Lösung, um von einem Linux-Arbeitsplatzrechner aus auf einem von einem Windows-Rechner freigegebenen Drucker zu drucken. Wenn das Paket <emphasis role="pkg">smbclient</emphasis> installiert ist, ist es mit CUPS möglich, freigegebene Windows-Rechner automatisch zu installieren.</para>
        <indexterm><primary>drucken</primary><secondary>Netzwerk</secondary></indexterm>

	<para>Dies sind die erforderlichen Schritte:</para>
        <itemizedlist>
          <listitem>
	    <para>Melden Sie sich an der Beniutzerschnittstelle von CUPS an: <literal>http://localhost:631/admin</literal></para>
          </listitem>
          <listitem>
	    <para>Klicken Sie auf "Drucker hinzufügen".</para>
          </listitem>
          <listitem>
	    <para>Wählen Sie das Gerät Drucker, nehmen Sie „Windows-Printer via SAMBA“.</para>
          </listitem>
          <listitem>
	    <para>Geben Sie den URI für den Drucker ein, er sieht folgendermaßen aus:</para>
	   
	    <para><literal>smb://<replaceable>benutzer</replaceable>:<replaceable>passwort</replaceable>@<replaceable>server</replaceable>/<replaceable>drucker</replaceable></literal>.</para>
          </listitem>
	  <listitem>
	    <para>Geben Sie den Namen ein der den Drucker eindeutig bezeichnet. Dann fügen Sie die Beschreibung und den Aufstellort des Druckers hinzu. Das sind die Angaben, die den Endanwendern angezeigt werden, um den Drucker identifizieren zu können.</para>
	  </listitem>
	  <listitem>
	    <para>Geben Sie den Hersteller und das Modell des Druckers an oder stellen Sie direkt eine funktionierende Druckerbeschreibung (PPD, PostScript Printer Description) zur Verfügung.</para>
	  </listitem>
        </itemizedlist>

	<para>Voilà, der Drucker ist einsatzbereit!</para>
      </section>
    </section>
  </section>
  <section id="sect.http-ftp-proxy">
    <title>HTTP/FTP-Proxy</title>

    <para>Ein HTTP/FTP-Proxy agiert als Vermittler bei HTTP- und FTP-Verbindungen. Er erfüllt zwei Rollen:</para>
    <itemizedlist>
      <listitem>
	<para>Zwischenspeichern: Kopien kürzlich heruntergeladener Dokumente werden lokal gespeichert, wodurch mehrfaches Herunterladen vermieden wird.</para>
      </listitem>
      <listitem>
	<para>Filter-Server: falls die Benutzung des Proxy vorgeschrieben ist (und ausgehende Verbindungen gesperrt werden, wenn sie nicht über den Proxy laufen), kann der Proxy bestimmen, ob die Anfrage erlaubt wird oder nicht.</para>
      </listitem>
    </itemizedlist>
    <indexterm><primary>HTTP/FTP-Proxy</primary></indexterm>
    <indexterm><primary>Proxy-Cache</primary></indexterm>

    <para>Falcot Corp. hat Squid als ihren Proxy-Server ausgewählt.</para>
    <indexterm><primary>Squid</primary></indexterm>
    <section>
      <title>Installieren</title>

      <para>Das Debian-Paket <emphasis role="pkg">squid3</emphasis> enthält nur den modularen (zwischenspeichernden) Proxy. Das Paket <emphasis role="pkg">squidguard</emphasis> muss zusätzlich installiert werden, um ihn zu einem Filter-Server zu machen. Zusätzlich stellt <emphasis role="pkg">squid-cgi</emphasis> eine Anfrage- und Verwaltungsschnittstelle für einen Squid-Proxy bereit.</para>

      <para>Vor dem Installieren sollte sichergestellt werden, dass das System seinen eigenen vollständigen Namen feststellen kann: der Befehl <command>hostname -f</command> muss einen vollqualifizierten Namen (einschließlich einer Domain) ergeben. Anderenfalls sollte die Datei <filename>/etc/hosts</filename> so editiert werden, dass sie den vollständigen Namen des Systems (zum Beispiel <literal>arrakis.falcot.com</literal>) enthält. Der vollständige Rechnername sollte vom Netz-Administrator bestätigt werden, um mögliche Namenskonflikte zu vermeiden.</para>
    </section>
    <section>
      <title>Einen Cache konfigurieren</title>

      <para>Das Aktivieren der Zwischenspeicherung des Servers geschieht einfach dadurch, dass die Konfigurationsdatei <filename>/etc/squid3/squid.conf</filename> editiert und es so Rechnern des lokalen Netzwerks ermöglicht wird, Anfragen durch den Proxy zu leiten. Das folgende Beispiel zeigt die von den Falcot Corp. Administratoren vorgenommenen Veränderungen:</para>

      <example>
        <title>Die Datei <filename>/etc/squid3/squid.conf</filename> (Auszüge)</title>

        <programlisting>
# GEBEN SIE HIER IHRE EIGENEN REGELN EIN, UM ZUGRIFF VON ALLEN CLIENTS ZU ERMÖGLICHEN

# Beispiel-Regel, um Zugriff von Ihren lokalen Netzwerken zu ermöglichen.
# Passen Sie sie an, so dass sie Ihre (internen) Netzwerke auflistet, von
# denen aus das Browsen erlaubt sein soll.
acl our_networks src 192.168.1.0/24 192.168.2.0/24
http_access allow our_networks
http_access allow localhost
# Und schließlich verweigern Sie alle sonstigen Zugriffe auf diesen Proxy
http_access deny all</programlisting>
      </example>
    </section>
    <section>
      <title>Einen Filter konfigurieren</title>

      <para><command>squid</command> selbst führt die Filterung nicht durch; dieser Arbeitsgang wird an <command>squidGuard</command> delegiert. Ersteres muss dann so konfiguriert werden, dass es mit letzterem zusammenarbeitet. Hierzu wird folgende Anweisung zur Datei <filename>/etc/squid3/squid.conf</filename> hinzugefügt:</para>
      <indexterm><primary><command>squidGuard</command></primary></indexterm>

      <programlisting>
url_rewrite_program /usr/bin/squidGuard -c /etc/squid3/squidGuard.conf </programlisting>

      <para>Das CGI-Programm <filename>/usr/lib/cgi-bin/squidGuard.cgi</filename> muss ebenfalls installiert werden, wobei die Datei <filename>/usr/share/doc/squidguard/examples/squidGuard.cgi.gz</filename> als Ausgangspunkt dient. In diesem Skript müssen die Variablen <varname>$proxy</varname> und <varname>$proxymaster</varname> angepasst werden (der Name des Proxy und die E-Mail-Adresse des Administrators). Die Variablen <varname>$image</varname> und <varname>$redirect</varname> sollten auf bestehende Abbilder zeigen, die die Ablehnung einer Anfrage darstellen.</para>

      <para>Der Filter wird mit dem Befehl <command>service squid3 reload</command> aktiviert. Da das Paket <emphasis role="pkg">squidguard</emphasis> jedoch nicht standardmäßig Filterungen durchführt, ist es Aufgabe des Administrators, die Richtlinien festzulegen. Dies kann durch Erstellen der Datei <filename>/etc/squid3/squidGuard.conf</filename> geschehen (evt. mit Hilfe von <filename>/etc/squidguard/squidGuard.conf.default</filename> als Vorlage).</para>

      <para>Die aktive Datenbank muss nach jeder Änderung der Konfigurationsdatei <command>squidGuard</command> (oder einer der Domain- beziehungsweise URL-Listen, die sich auf sie beziehen) mit dem Befehl <command>update-squidguard</command> aktualisiert werden. Die Syntax der Konfigurationsdatei ist auf der folgenden Website dokumentiert: <ulink type="block" url="http://www.squidguard.org/Doc/configure.html" /></para>
      <indexterm><primary><command>update-squidguard</command></primary></indexterm>

      <sidebar>
        <title><emphasis>ALTERNATIVE</emphasis> DansGuardian</title>
        <indexterm><primary><emphasis role="pkg">dansguardian</emphasis></primary></indexterm>
        <indexterm><primary>PICS</primary></indexterm>

	<para>Das Paket <emphasis role="pkg">dansguardian</emphasis> stellt eine Alternative zu <emphasis>squidguard</emphasis> dar. Dieses Programm verwaltet nicht einfach eine schwarze Liste verbotener URLs, sondern kann mithilfe des PICS-Systems (<emphasis>Platform for Internet Content Selection</emphasis>) den Inhalt einer Seite dynamisch analysieren, um zu entscheiden, ob sie zulässig ist.</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.ldap-directory">
    <title>LDAP-Verzeichnis</title>
    <indexterm><primary>LDAP</primary></indexterm>
    <indexterm><primary>OpenLDAP</primary></indexterm>
    <indexterm><primary>Verzeichnis, LDAP</primary></indexterm>

    <para>OpenLDAP ist eine Umsetzung des LDAP-Protokolls; mit anderen Worten, es ist eine Spezialdatenbank zum Speichern von Verzeichnissen. Im gebräuchlichsten Anwendungsfall macht die Verwendung eines LDAP-Servers es möglich, die Verwaltung von Benutzerkonten und der dazugehörigen Berechtigungen zusammenzufassen. Außerdem lässt sich eine LDAP-Datenbank leicht kopieren, wodurch die Einrichtung mehrerer synchronisierter LDAP-Server möglich wird. Wenn das Netzwerk und die Benutzerzahl schnell anwachsen, kann so die Arbeitslast auf mehrere Server verteilt werden.</para>

    <para>LDAP-Daten sind strukturiert und hierarchisch. Die Struktur wird durch „Schemata“ festgelegt, die die Art der Objekte, die die Datenbank speichern kann, zusammen mit einer Liste all ihrer möglichen Attribute beschreiben. Die Syntax, die zum Verweis auf ein bestimmtes Objekt der Datenbank verwendet wird, basiert auf diesen Strukturen, wodurch sich ihre Komplexität erklärt.</para>
    <section>
      <title>Installieren</title>

      <para>Das Paket <emphasis role="pkg">slapd</emphasis> enthält den OpenLDAP-Server. Das Paket <emphasis role="pkg">ldap-utils</emphasis> umfasst Befehlszeilen-Werkzeuge für die Zusammenarbeit mit LDAP-Servern.</para>
      <indexterm><primary><emphasis>slapd</emphasis></primary></indexterm>

      <para>
        Installing <emphasis role="pkg">slapd</emphasis> usually
        asks very few questions and the resulting database is unlikely
        to suit your needs. Fortunately a simple <command>dpkg-reconfigure
        slapd</command> will let you reconfigure the LDAP database with
        more details:
      </para>
      <itemizedlist>
        <listitem>
	  <para>Konfigurierung des OpenLDAP-Servers auslassen? Natürlich nicht, wir wollen diesen Dienst konfigurieren.</para>
        </listitem>
        <listitem>
	  <para>DNS-Domain-Name: „<literal>falcot.com</literal>“.</para>
        </listitem>
        <listitem>
	  <para>Name der Organisation: „Falcot Corp.“.</para>
        </listitem>
        <listitem>
	  <para>Ein Verwaltungspasswort muss eingegeben werden.</para>
        </listitem>
        <listitem>
	  <para>Zu verwendendes Datenbank-Backend: „MDB“.</para>
        </listitem>
        <listitem>
	  <para>Möchten Sie, dass die Datenbank entfernt wird, wenn <emphasis role="pkg">slapd</emphasis> gelöscht wird? Nein. Es wäre nicht sinnvoll, den Verlust der Datenbank im Falle eines Versehens zu riskieren.</para>
        </listitem>
        <listitem>
	  <para>Die alte Datenbank verschieben? Diese Frage wird nur gestellt, wenn die Konfigurierung vorgenommen wird, während eine Datenbank bereits existiert. Antworten Sie nur mit „ja“, wenn Sie tatsächlich wieder mit einer leeren Datenbank beginnen möchten, zum Beispiel, wenn Sie <command>dpkg-reconfigure slapd</command> unmittelbar nach der ersten Installierung ausführen.</para>
        </listitem>
        <listitem>
	  <para>Das LDAPv2-Protokoll erlauben? Nein, das macht keinen Sinn. Alle Programme, die wir verwenden werden, verstehen das LDAPv3-Protokoll.</para>
        </listitem>
      </itemizedlist>

      <sidebar>
        <title><emphasis>ZURÜCK ZU DEN GRUNDLAGEN</emphasis> Das LDIF-Format</title>

	<para>Eine LDIF-Datei (<emphasis>LDAP Data Interchange Format</emphasis>) ist eine übertragbare Textdatei, die den Inhalt einer LDAP-Datenbank (oder einen Teil davon) beschreibt; sie kann dazu verwendet werden, die Daten auf einen beliebigen anderen LDAP-Server einzuspeisen.</para>
        <indexterm><primary>LDIF</primary></indexterm>
      </sidebar>

      <para>Eine minimale Datenbank ist jetzt konfiguriert, wie die folgende Anfrage zeigt:</para>

      <screen>
<computeroutput>$ </computeroutput><userinput>ldapsearch -x -b dc=falcot,dc=com</userinput>
<computeroutput># extended LDIF
#
# LDAPv3
# base &lt;dc=falcot,dc=com&gt; with scope sub
# filter: (objectclass=*)
# requesting: ALL
#

# falcot.com
dn: dc=falcot,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Falcot Corp
dc: falcot

# admin, falcot.com
dn: cn=admin,dc=falcot,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2
</computeroutput></screen>

      <para>Die Anfrage ergibt zwei Objekte: die Organisation selbst und den verwaltenden Benutzer.</para>
    </section>
    <section>
      <title>Das Verzeichnis ausfüllen</title>

      <para>Da eine leere Datenbank nicht sehr nützlich ist, werden wir alle bestehenden Verzeichnisse in sie einspeisen; hierzu gehören die Benutzer-, Gruppen-, Dienst- und Host-Datenbanken.</para>

      <para>Das Paket <emphasis role="pkg">migrationtools</emphasis> stellt einen Satz von Skripten bereit, die dazu dienen, Daten aus den Standard-Unix-Verzeichnissen (<filename>/etc/passwd</filename>, <filename>/etc/group</filename>, <filename>/etc/services</filename>, <filename>/etc/hosts</filename> und so weiter) zu extrahieren, diese Daten zu konvertieren und sie in die LDAP-Datenbank einzuspeisen.</para>
      <indexterm><primary><emphasis role="pkg">migrationtools</emphasis></primary></indexterm>

      <para>Nachdem das Paket installiert ist, muss die Datei <filename>/etc/migrationtools/migrate_common.ph</filename> editiert werden; die Optionen <varname>IGNORE_UID_BELOW</varname> and <varname>IGNORE_GID_BELOW</varname> müssen aktiviert werden (es genügt, das Kommentarzeichen zu entfernen) und  die Variablen <varname>DEFAULT_MAIL_DOMAIN</varname>/<varname>DEFAULT_BASE</varname> müssen aktualisiert werden.</para>

      <para>Der tatsächliche Übertragungsvorgang wird mit dem Befehl <command>migrate_all_online.sh</command> folgendermaßen ausgeführt:</para>

      <screen>
<computeroutput># </computeroutput><userinput>cd /usr/share/migrationtools</userinput>
<computeroutput># </computeroutput><userinput>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</userinput></screen>

      <para>Das Skript <command>migrate_all_online.sh</command> stellt einige Fragen zur LDAP-Datenbank, auf die die Daten übertragen werden sollen. <xref linkend="tab-migrate-all" xrefstyle="select: label nopage" /> fasst die Antworten zusammen, die im Fallbeispiel Falcot gegeben wurden.</para>
 
      <table colsep="1" id="tab-migrate-all">
        <title>Antworten auf die vom Skript <command>migrate_all_online.sh</command> gestellten Fragen</title>
	<tgroup cols="2"><colspec align="justify"></colspec><colspec align="justify"></colspec>
	<thead>
	  <row><entry>Frage</entry><entry>Antwort</entry></row>
	</thead>
	<tbody>
	  <row>
	    <entry>X.500 Benennungskontext</entry>
	    <entry><literal>dc=falcot,dc=com</literal></entry>
	  </row>
	  <row>
	    <entry>Hostname des LDAP-Servers</entry>
	    <entry><literal>localhost</literal></entry>
	  </row>
	  <row>
	    <entry>Manager-DN</entry>
	    <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
	  </row>
	  <row>
	    <entry>Verbindungslegitimation</entry>
	    <entry>das Verwaltungspasswort</entry>
	  </row>
	  <row>
	    <entry>Ein DUAConfigProfil anlegen</entry>
	    <entry>nein</entry>
	  </row>
	</tbody>
	</tgroup>
      </table>

      <para>Wir haben bewusst die Übertragung der Datei <filename>/etc/aliases</filename> außerachtgelassen, da das von Debian bereitgestellte Standardschema nicht die Strukturen enthält, die dieses Skript zur Beschreibung der E-Mail-Aliasse verwendet. Falls wir diese Daten in das Verzeichnis integrieren möchten, müssen wir die Datei <filename>/etc/ldap/schema/misc.schema</filename> zum Standardschema hinzufügen.</para>

      <sidebar>
        <title><emphasis>HILFSPROGRAMM</emphasis> Ein LDAP-Verzeichnis durchsuchen</title>

	<para>Das Programm <command>jxplorer</command> (im gleichnamigen Paket) ist ein grafisches Hilfsprogramm, das es ermöglicht, eine LDAP-Datenbank zu durchsuchen und zu editieren. Es ist ein interessantes Programm, das einem Administrator einen guten Überblick über die hierarchische Struktur der LDAP-Daten gibt.</para>
        <indexterm><primary><command>jxplorer</command></primary></indexterm>
      </sidebar>

      <para>Beachten Sie auch die Verwendung der Option <literal>-c</literal> des Befehls <command>ldapadd</command>; diese Option bestimmt, dass der Verarbeitungsablauf im Falle eines Fehlers nicht abgebrochen wird. Die Verwendung dieser Option ist notwendig, da die Konvertierung der Datei <filename>/etc/services</filename> häufig einige Fehler hervorruft, die ohne Gefahr ignoriert werden können.</para>
    </section>
    <section>
      <title>Konten mit LDAP verwalten</title>

      <para>Jetzt, da die LDAP-Datenbank einige nützliche Informationen enthält, ist es an der Zeit diese Daten zu nutzen. Dieser Abschnitt richtet sein Augenmerk darauf, wie ein Linux-System so zu konfigurieren ist, dass die verschiedenen Systemverzeichnisse die LDAP-Datenbank benutzen.</para>
      <section id="sect.config-nss">
        <title>NSS konfigurieren</title>

	<para>Das NSS-System (Name Service Switch, siehe Seitenleiste <xref linkend="sidebar.intro-nss" />) ist ein modulares System, das Informationen für Systemverzeichnisse festlegen oder einholen kann. Um LDAP als Datenquelle für NSS verwenden zu können, muss das Paket <emphasis role="pkg">libnss-ldap</emphasis> installiert werden. Bei seiner Installierung werden einige Fragen gestellt; die Antworten sind in <xref linkend="tab-libnss-ldap" xrefstyle="select: label nopage" /> zusammengefasst.</para>
        <indexterm><primary><emphasis>libnss-ldap</emphasis></primary></indexterm>

        <table colsep="1" id="tab-libnss-ldap">
          <title>Das Paket <emphasis role="pkg">libnss-ldap</emphasis> konfigurieren</title>
          <tgroup cols="2">
            <colspec align="justify"></colspec>
            <colspec align="justify"></colspec>
            <thead>
              <row>
                <entry>Frage</entry>
                <entry>Antwort</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>Uniform Resource Identifier des LDAP-Servers</entry>
                <entry><literal>ldap://ldap.falcot.com</literal></entry>
              </row>
              <row>
                <entry>Kennzeichnender Name der Suchbasis</entry>
                <entry><literal>dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>Zu verwendende LDAP-Version</entry>
                <entry><literal>3</literal></entry>
              </row>
              <row>
                <entry>Benötigt die LDAP-Datenbank eine Anmeldung?</entry>
                <entry>nein</entry>
              </row>
	      <row>
	        <entry>Spezielle LDAP-Privilegien für den Benutzer Root</entry>
		<entry>ja</entry>
	      </row>
	      <row>
	        <entry>Erlauben Sie nur dem Eigentümer Lese/Schreibzugriff auf die Konfigurationsdatei</entry>
		<entry>nein</entry>
	      </row>
              <row>
                <entry>LDAP-Administratorkonto</entry>
                <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>Passwort des LDAP-Administratorkontos</entry>
                <entry>das Verwaltungspasswort</entry>
              </row>
            </tbody>
          </tgroup>
        </table>

	<para>Die Datei <filename>/etc/nsswitch.conf</filename> muss nun angepasst werden, um NSS so zu konfigurieren, dass es das neu installierte <command>ldap</command>-Modul benutzt.</para>

        <example>
          <title>Die Datei <filename>/etc/nsswitch.conf</filename></title>

          <programlisting>
# /etc/nsswitch.conf
#
# Example configuration of GNU Name Service Switch functionality.
# If you have the `glibc-doc' and `info' packages installed, try:
# `info libc "Name Service Switch"' for information about this file.

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files</programlisting>
        </example>

	<para>Das <command>ldap</command>-Modul wird normalerweise vor den anderen aufgenommen und wird daher zuerst abgefragt. Eine beachtenswerte Ausnahme stellt der <literal>hosts</literal>-Dienst dar, da zunächst der DNS befragt werden muss (um <literal>ldap.falcot.com</literal> aufzulösen), bevor mit dem LDAP-Server Verbindung aufgenommen werden kann. Ohne diese Ausnahme würde eine Anfrage nach einem Hostnamen an den LDAP-Server gerichtet; dies würde eine Namensauflösung für den LDAP-Server auslösen, und so weiter in einer unendlichen Schleife.</para>

	<para>Falls der LDAP-Server als maßgeblich angesehen werden soll (und die lokalen vom Modul <command>files</command> benutzten Dateien ignoriert werden sollen), können die Dienste mit der folgenden Syntax konfiguriert werden:</para>

	<para><literal><replaceable>dienst</replaceable>: ldap [NOTFOUND=return] files</literal>.</para>

	<para>Falls der gesuchte Eintrag in der LDAP-Datenbank nicht vorhanden ist, wird die Anfrage die Antwort „nicht vorhanden“ ergeben, selbst wenn er in einer der lokalen Dateien vorhanden ist; diese lokalen Dateien werden nur benutzt, wenn der LDAP-Service abgeschaltet ist.</para>
      </section>
      <section id="sect.config-pam">
        <title>PAM konfigurieren</title>

	<para>Dieser Abschnitt beschreibt die Konfiguration von PAM (siehe Seitenleiste <xref linkend="sidebar.intro-pam" />), die es Anwendungen ermöglicht, die gegenüber der LDAP-Datenbank erforderlichen Authentifizierungen vorzunehmen.</para>

        <sidebar>
          <title><emphasis>VORSICHT</emphasis> Fehlerhafte Authentifizierung</title>

	  <para>Die Änderung der von verschiedenen Programmen verwendeten standardmäßigen PAM-Konfiguration ist ein heikler Vorgang. Ein Fehler kann zu einer fehlerhaften Authentifizierung führen, die das Anmelden verhindern kann. Eine gute Vorsichtsmaßnahme besteht daher darin, eine Root-Konsole offen zu halten. So können mit geringem Aufwand eventuell auftretende Konfigurierungsfehler behoben und Dienste neu gestartet werden.</para>
        </sidebar>

	<para>Das LDAP-Modul für PAM wird von dem Paket <emphasis role="pkg">libpam-ldap</emphasis> bereitgestellt. Beim Installieren dieses Pakets werden einige Fragen gestellt, die denen bei <emphasis role="pkg">libnss-ldap</emphasis> ähnlich sind; einige Konfigurationsparameter (wie zum Beispiel die URI des LDAP-Servers) werden sogar mit dem Paket <emphasis role="pkg">libnss-ldap</emphasis> gemeinsam benutzt. Die Antworten sind in <xref linkend="tab-libpam-ldap" xrefstyle="select: label nopage" /> zusammengefasst.</para>
        <indexterm><primary><emphasis>libpam-ldap</emphasis></primary></indexterm>

        <table colsep="1" id="tab-libpam-ldap">
          <title>Konfigurierung von <emphasis>libpam-ldap</emphasis></title>
          <tgroup cols="2">
            <colspec align="justify"></colspec>
            <colspec align="justify"></colspec>
            <thead>
              <row>
                <entry>Frage</entry>
                <entry>Antwort</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>Dem LDAP-Administrationskonto erlauben, sich wie lokales Root zu verhalten?</entry>
                <entry>Ja. Dies ermöglicht es, den normalen <command>passwd</command>-Befehl zur Änderung von Passwörtern zu verwenden, die in der LDAP-Datenbank gespeichert sind.</entry>
              </row>
              <row>
                <entry>Erfordert die LDAP-Datenbank eine Anmeldung?</entry>
                <entry>nein</entry>
              </row>
              <row>
                <entry>LDAP-Administratorkonto</entry>
                <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>Passwort des LDAP-Administratorkontos</entry>
                <entry>das Verwaltungspasswort der LDAP-Datenbank</entry>
              </row>
	      <row>
	        <entry>Lokaler Verschlüsselungsalgorithmus für Passwörter</entry>
		<entry>crypt</entry>
	      </row>
            </tbody>
          </tgroup>
        </table>

	<para>Durch das Installieren von <emphasis role="pkg">libpam-ldap</emphasis> wird die standardmäßige PAM-Konfiguration, die in den Dateien <filename>/etc/pam.d/common-auth</filename>, <filename>/etc/pam.d/common-password</filename> und <filename>/etc/pam.d/common-account</filename> festgelegt ist, automatisch angepasst. Dieser Vorgang verwendet das spezielle Hilfsprogramm <command>pam-auth-update</command> (vom Paket <emphasis role="pkg">libpam-runtime</emphasis> bereitgestellt). Dieses Programm kann auch vom Administrator eingesetzt werden, falls er PAM-Module aktivieren oder deaktivieren möchte.</para>
        <indexterm><primary><filename>common-auth</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-auth</filename></primary></indexterm>
        <indexterm><primary><filename>common-password</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-password</filename></primary></indexterm>
        <indexterm><primary><filename>common-account</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-account</filename></primary></indexterm>
      </section>
      <section>
        <title>LDAP-Datenaustausch absichern</title>
        <indexterm><primary>LDAP</primary><secondary>abgesichert</secondary></indexterm>

	<para>Standardmäßig überträgt das LDAP-Protokoll im Klartext über das Netzwerk; dies gilt auch für die (verschlüsselten) Passwörter. Da die verschlüsselten Passwörter aus dem Netzwerk entnommen werden können, können sie anfällig für Wörterbuchangriffe sein. Dies kann durch den Einsatz einer zusätzlichen Verschlüsselungsschicht verhindert werden; die Aktivierung dieser Schicht ist das Thema dieses Abschnitts.</para>
        <section>
          <title>Den Server konfigurieren</title>
          <indexterm><primary><foreignphrase>OpenSSL</foreignphrase></primary><secondary>Schlüssel erzeugen</secondary></indexterm>
          <indexterm><primary>Schlüsselpaar</primary></indexterm>

	  <para>Der erste Schritt besteht darin, für den LDAP-Server ein Schlüsselpaar (bestehend aus einem öffentlichen und einem privaten Schlüssel) zu erzeugen. Die Administratoren bei Falcot erzeugen diesen wiederum unter Verwendung von <emphasis>easy-rsa</emphasis> (siehe <xref linkend="sect.easy-rsa" />). Beim Aufruf von <command>./build-key-server ldap.falcot.com</command> werden einige banale Fragen gestellt (Ort, Name der Organisation und so weiter). Als Antwort auf die Frage nach dem "common name"  <emphasis>muss</emphasis> der vollständig qualifizierte Hostname des LDAP-Servers angegeben werden; in unserem Fall <literal>ldap.falcot.com</literal>.</para>

	  <para>Dieser Befehl erstellt ein Zertifikat in der Datei <filename>keys/ldap.falcot.com.crt</filename>; der dazugehörige private Schlüssel wird in der Datei <filename>keys/ldap.falcot.com.key</filename> abgespeichert.</para>

	  <para>Jetzt müssen diese Schlüssel an ihrem Standard-Platz installiert werden, und wir müssen dafür Sorge tragen, dass die private Datei vom LDAP-Sever gelesen werden kann, der unter der Userkennung <literal>openldap</literal> läuft:</para>

          <screen><computeroutput># </computeroutput><userinput>adduser openldap ssl-cert
</userinput><computeroutput>Adding user `openldap' to group `ssl-cert' ...
Adding user openldap to group ssl-cert
Done.
# </computeroutput><userinput>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chmod 0640 /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem
</userinput></screen>

	  <para>Der Hintergrundprozess  <command>slapd</command> muss ebenfalls dazu gebracht werden, diese Schlüssel für die Verschlüsselung zu verwenden. Die Konfiguration des LDAP-Servers wird dynamisch verwaltet: die Konfiguration kann mit normalen LDAP-Operationen innerhalb der Objekt-Hierarchie <literal>cn=config</literal> aktualisiert werden und der Server aktualisiert <filename>/etc/ldap/slapd.d</filename> in Echtzeit um die Konfiguration durchgängig zu halten. <command>Ldapmodify</command> ist also das geeignete Werkzeug um die Konfiguration zu aktualisieren:</para>

          <example>
            <title><command>slapd</command> für eine Verschlüsselung konfigurieren</title>

            <screen><computeroutput># </computeroutput><userinput>cat &gt;ssl.ldif &lt;&lt;END
dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key
-
END
</userinput><computeroutput># </computeroutput><userinput>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif
</userinput><computeroutput>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
</computeroutput></screen>
          </example>

	  <sidebar>
	    <title><emphasis>WERKZEUG</emphasis> <command>ldapvi</command> um ein LDAP-Verzeichnis zu editieren</title>
	    <indexterm><primary><command>ldapvi</command></primary></indexterm>
	    <para>Mit <command>ldapvi</command> kann man eine LDIV-Ausgabe von beliebigen Teilen eines LDAP-Verzeichnisses erzeugen, darin mit einem Texteditor einige Änderungen vornehmen und das Werkzeug dann die entsprechenden LDAP-Operationen durchführen lassen.</para>
	    <para>Es ist deshalb ein komfortabler Weg, die Konfiguration des LDAP-Servers einfach durch Ändern der Hierarchie <literal>cn=config</literal> auf dem Laufenden zu halten.</para>
	    <screen><computeroutput># </computeroutput><userinput>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config
</userinput></screen>
	  </sidebar>

	  <para>Der letzte Schritt zur Aktivierung der Verschlüsselung besteht darin, die Variable <varname>SLAPD_SERVICES</varname> in der Datei <filename>/etc/default/slapd</filename> zu ändern. Wir gehen dabei auf Nummer Sicher und deaktivieren nicht abgesichertes LDAP vollständig.</para>

          <example>
            <title>Die Datei <filename>/etc/default/slapd</filename></title>

            <programlisting>
# Default location of the slapd.conf file or slapd.d cn=config directory. If
# empty, use the compiled-in default (/etc/ldap/slapd.d with a fallback to
# /etc/ldap/slapd.conf).
SLAPD_CONF=

# System account to run the slapd server under. If empty the server
# will run as root.
SLAPD_USER="openldap"

# System group to run the slapd server under. If empty the server will
# run in the primary group of its user.
SLAPD_GROUP="openldap"

# Path to the pid file of the slapd server. If not set the init.d script
# will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf by
# default)
SLAPD_PIDFILE=

# slapd normally serves ldap only on all TCP-ports 389. slapd can also
# service requests on TCP-port 636 (ldaps) and requests via unix
# sockets.
# Example usage:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# If SLAPD_NO_START is set, the init script will not start or restart
# slapd (but stop will still work).  Uncomment this if you are
# starting slapd via some other means or if you don't want slapd normally
# started at boot.
#SLAPD_NO_START=1

# If SLAPD_SENTINEL_FILE is set to path to a file and that file exists,
# the init script will not start or restart slapd (but stop will still
# work).  Use this for temporarily disabling startup of slapd (when doing
# maintenance, for example, or through a configuration management system)
# when you don't want to edit a configuration file.
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# For Kerberos authentication (via SASL), slapd by default uses the system
# keytab file (/etc/krb5.keytab).  To use a different keytab file,
# uncomment this line and change the path.
#export KRB5_KTNAME=/etc/krb5.keytab

# Additional options to pass to slapd
SLAPD_OPTIONS=""</programlisting>
          </example>
        </section>
        <section>
          <title>Den Client konfigurieren</title>

	  <para>Auf der Client-Seite muss die Konfiguration der Module <emphasis>libpam-ldap</emphasis> und <emphasis>libnss-ldap</emphasis> angepasst werden um einen <literal>ldaps://</literal> URI zu nutzen zu können.</para>

	  <para>LDAP-Clients müssen auch in der Lage sein, den Server zu authentifizieren. In einer X.500 Public-Key-Infrastruktur werden öffentliche Zertifikate mit dem Schlüssel einer Zertifikatsausgabestelle (CA, certificate authority) signiert. Mit <emphasis>easy-rsa</emphasis> haben die Administratoren von Falcot ihre eigene Zertifikatsstelle erzeugt und jetzt müssen sie  das System so konfigurieren, dass es den Unterschriften der Zertifikatsstelle von Falcot vertraut. Das tut man, indem man das CA-Zertifikat in <filename>/usr/local/share/ca-certificates</filename> einträgt und dann <command>update-ca-certificates</command> startet.</para>
	  
	  <screen><computeroutput># </computeroutput><userinput>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt
</userinput><computeroutput># </computeroutput><userinput>update-ca-certificates
</userinput><computeroutput>Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
Adding debian:falcot.pem
done.
done.
</computeroutput></screen>

	  <para>Nicht zuletzt kann der voreingestellte URI und die Basis-DN, die von diversen Kommandozeilen-Tools verwendet werden, können in <filename>/etc/ldap/ldap.conf</filename> geändert werden. Das erspart einiges an Tipparbeit.</para>

          <example>
            <title>Die Datei <filename>/etc/ldap/ldap.conf</filename></title>

            <programlisting>#
# LDAP Defaults
#

# See ldap.conf(5) for details
# This file should be world readable but not world writable.

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# TLS certificates (needed for GnuTLS)
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt</programlisting>
          </example>

        </section>
      </section>
    </section>
  </section>
  <section id="sect.rtc-services">
    <title>Echtzeit-Kommunikationsdienste</title>

    <para>Real-Time Communication (RTC) Dienste beinhalten Sprache, Video/Webcam, Instant Messaging (IM) und Desktop Sharing. Dieses Kapitel gibt eine kurze Einführung in drei der für den Betrieb von RTC erforderlichen Dienste, darunter ein TURN-Server, SIP-Server und XMPP-Server. Ausführliche Informationen zur Planung, Installation und Verwaltung dieser Dienste finden Sie im Real-Time Communications Quick Start Guide, der Beispiele speziell für Debian enthält. <ulink type="block" url="http://rtcquickstart.org" /></para>
    <indexterm><primary>VoIP</primary><secondary>Server</secondary></indexterm>
    <indexterm><primary>RTC</primary><secondary>Server</secondary></indexterm>
    <indexterm><primary>Instant Messaging</primary><secondary>Server</secondary></indexterm>
    <indexterm><primary>Chat</primary><secondary>Server</secondary></indexterm>

    <para>Sowohl SIP als auch XMPP können die gleiche Funktionalität bieten. SIP ist etwas bekannter für Sprache und Video, während XMPP traditionell als IM-Protokoll angesehen wird. Allerdings können beide für jeden dieser Zwecke verwendet werden. Um die Konnektivitätsmöglichkeiten zu maximieren, wird empfohlen, beide parallel zu betreiben.</para>
    <indexterm><primary>SIP</primary></indexterm>
    <indexterm><primary>XMPP</primary></indexterm>

    
    <para>Diese Dienste basieren auf X.509-Zertifikaten, sowohl für die Authentifizierung als auch für Vertraulichkeit. Siehe <xref linkend="sect.easy-rsa" /> für Details zur Erstellung. Alternativ dazu bietet die <emphasis>Real-Time Communications Quick Start Guide</emphasis> auch nützliche Erklärungen: <ulink type="block" url="http://rtcquickstart.org/guide/multi/tls.html" /></para>

    <section id="sect.rtc-dns-settings">
      <title>DNS-Einstellungen für RTC-Dienste</title>

      <para>RTC-Dienste erfordern DNS SRV- und NAPTR-Einträge. Eine Beispielkonfiguration, die in der Zonendatei für <literal>falcot.com</literal> abgelegt werden kann:</para>
      <indexterm><primary>DNS</primary><secondary>SRV record</secondary></indexterm>
      <indexterm><primary>DNS</primary><secondary>NAPTR Record</secondary></indexterm>

<programlisting>
; the server where everything will run
server1            IN     A      198.51.100.19
server1            IN     AAAA   2001:DB8:1000:2000::19

; IPv4 only for TURN for now, some clients are buggy with IPv6
turn-server        IN     A      198.51.100.19

; IPv4 and IPv6 addresses for SIP
sip-proxy          IN     A      198.51.100.19
sip-proxy          IN     AAAA   2001:DB8:1000:2000::19

; IPv4 and IPv6 addresses for XMPP
xmpp-gw            IN     A      198.51.100.19
xmpp-gw            IN     AAAA   2001:DB8:1000:2000::19

; DNS SRV and NAPTR for STUN / TURN
_stun._udp  IN SRV    0 1 3467 turn-server.falcot.com.
_turn._udp  IN SRV    0 1 3467 turn-server.falcot.com.
@           IN NAPTR  10 0 "s" "RELAY:turn.udp" "" _turn._udp.falcot.com.

; DNS SRV and NAPTR records for SIP
_sips._tcp  IN SRV    0 1 5061 sip-proxy.falcot.com.
@           IN NAPTR  10 0 "s" "SIPS+D2T" "" _sips._tcp.falcot.com.

; DNS SRV records for XMPP Server and Client modes:
_xmpp-client._tcp  IN     SRV    5 0 5222 xmpp-gw.falcot.com.
_xmpp-server._tcp  IN     SRV    5 0 5269 xmpp-gw.falcot.com.</programlisting>
    </section>

    <section id="sect.turn-server">
      <title>TURN Server</title>

      <para>TURN ist ein Dienst, der Clients hinter NAT-Routern und Firewalls hilft, die effizienteste Art der Kommunikation mit anderen Clients zu finden und die Medienströme weiterzuleiten, wenn kein direkter Medienpfad gefunden werden kann. Es wird dringend empfohlen, den TURN-Server zu installieren, bevor die anderen RTC-Dienste den Endbenutzern angeboten werden.</para>
      <indexterm><primary>TURN</primary><secondary>Server</secondary></indexterm>

      <para>TURN und das zugehörige ICE-Protokoll sind offene Standards. Um von diesen Protokollen zu profitieren, die Konnektivität zu maximieren und die Frustration der Benutzer zu minimieren, ist es wichtig sicherzustellen, dass jede Client-Software ICE und TURN unterstützt.</para>
      <indexterm><primary>ICE</primary></indexterm>

      <para>Damit der ICE-Algorithmus effektiv funktioniert, muss der Server zwei öffentliche IPv4-Adressen haben.</para>
      <section id="sect.turn-server-install">
        <title>Den TURN-Server installieren</title>
        <para>Install the <emphasis role="pkg">resiprocate-turn-server</emphasis> package.</para>

        <para>Bearbeiten Sie die Konfigurationsdatei <filename>/etc/reTurn/reTurnServer.config</filename>. Das Wichtigste ist, die IP-Adressen des Servers einzugeben.</para>

<programlisting>
# your IP addresses go here:
TurnAddress = 198.51.100.19
TurnV6Address = 2001:DB8:1000:2000::19
AltStunAddress = 198.51.100.20
# your domain goes here, it must match the value used
# to hash your passwords if they are already hashed
# using the HA1 algorithm:
AuthenticationRealm = myrealm

UserDatabaseFile = /etc/reTurn/users.txt
UserDatabaseHashedPasswords = true</programlisting>

        <para>Dienst neu starten.</para>
      </section>
      <section id="sect.turn-server-management">
        <title>TURN-Benutzer verwalten</title>
        <para>Verwenden Sie das Dienstprogramm htdigest, um die Benutzerliste des TURN-Servers zu verwalten.</para>
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/reTurn/users.txt myrealm joe</userinput>
</screen>
        <para>Verwenden Sie das HUP-Signal, damit der Server die Datei <filename>/etc/reTurn/users.txt</filename> nach dem Ändern neu lädt oder aktivieren Sie die automatische Reload-Funktion in <filename>/etc/reTurn/reTurnServer.config</filename>.</para>
      </section>
    </section>

    <section id="sect.sip-server">
      <title>SIP Proxy Server</title>

      <para>Ein SIP-Proxy-Server verwaltet die ein- und ausgehenden SIP-Verbindungen zwischen anderen Organisationen, SIP-Trunking-Providern, SIP-Telefonanlagen wie Asterisk, SIP-Telefonen, SIP-basierten Softphones und WebRTC-Anwendungen.</para>
      <indexterm><primary>SIP</primary><secondary>server</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>proxy</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>PBX</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>trunk</secondary></indexterm>

      <para>Es wird dringend empfohlen, den SIP-Proxy zu installieren und zu konfigurieren, bevor Sie eine SIP-Telefonanlage einrichten. Der SIP-Proxy normalisiert einen Großteil des Datenverkehrs, der die Telefonanlage erreicht und sorgt für mehr Konnektivität und Ausfallsicherheit.</para>

      <section id="sect.sip-server-install">
        <title>SIP-Proxy installieren</title>
        <para>Installieren Sie das Paket <emphasis role="pkg">repro</emphasis>. Die Verwendung des Pakets von <emphasis role="distribution">jessie-backports</emphasis> wird dringend empfohlen, da es die neuesten Verbesserungen zur Maximierung der Konnektivität und Ausfallsicherheit enthält.</para>
        <indexterm><primary>repro</primary></indexterm>

        <para>Bearbeiten Sie die Konfigurationsdatei <filename>/etc/repro/repro/repro.config</filename>. Das Wichtigste ist, die IP-Adressen des Servers einzugeben. Das folgende Beispiel zeigt, wie man sowohl normale SIP- als auch WebSockets/WebRTCs mit TLS, IPv4 und IPv6 einrichtet:</para>

<programlisting>
# Transport1 will be for SIP over TLS connections
# We use port 5061 here but if you have clients connecting from
# locations with firewalls you could change this to listen on port 443
Transport1Interface = 198.51.100.19:5061
Transport1Type = TLS
Transport1TlsDomain = falcot.com
Transport1TlsClientVerification = Optional
Transport1RecordRouteUri = sip:falcot.com;transport=TLS
Transport1TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport1TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport2 is the IPv6 version of Transport1
Transport2Interface = 2001:DB8:1000:2000::19:5061
Transport2Type = TLS
Transport2TlsDomain = falcot.com
Transport2TlsClientVerification = Optional
Transport2RecordRouteUri = sip:falcot.com;transport=TLS
Transport2TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport2TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport3 will be for SIP over WebSocket (WebRTC) connections
# We use port 8443 here but you could use 443 instead
Transport3Interface = 198.51.100.19:8443
Transport3Type = WSS
Transport3TlsDomain = falcot.com
# This would require the browser to send a certificate, but browsers
# don't currently appear to be able to, so leave it as None:
Transport3TlsClientVerification = None
Transport3RecordRouteUri = sip:falcot.com;transport=WSS
Transport3TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport3TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport4 is the IPv6 version of Transport3
Transport4Interface = 2001:DB8:1000:2000::19:8443
Transport4Type = WSS
Transport4TlsDomain = falcot.com
Transport4TlsClientVerification = None
Transport4RecordRouteUri = sip:falcot.com;transport=WSS
Transport4TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport4TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport5: this could be for TCP connections to an Asterisk server
# in your internal network.  Don't allow port 5060 through the external
# firewall.
Transport5Interface = 198.51.100.19:5060
Transport5Type = TCP
Transport5RecordRouteUri = sip:198.51.100.19:5060;transport=TCP

HttpBindAddress = 198.51.100.19, 2001:DB8:1000:2000::19
HttpAdminUserFile = /etc/repro/users.txt

RecordRouteUri = sip:falcot.com;transport=tls
ForceRecordRouting = true
EnumSuffixes = e164.arpa, sip5060.net, e164.org
DisableOutbound = false
EnableFlowTokens = true
EnableCertificateAuthenticator = True</programlisting>

        <para>Verwenden Sie das Dienstprogramm <command>htdigest</command>, um das Admin-Passwort für das Web-Interface zu verwalten. Der Benutzername muss <emphasis>admin</emphasis> sein und der Realmname muss mit dem in <filename>repro.config</filename> angegebenen Wert übereinstimmen.</para>

<screen><computeroutput># </computeroutput><userinput>htdigest /etc/repro/users.txt repro admin</userinput>
</screen>

        <para>Starten Sie den Dienst neu, um die neue Konfiguration zu verwenden.</para>
      </section>
      <section id="sect.sip-server-management">
        <title>Den SIP-Proxy verwalten</title>
        <para>Gehen Sie zum Webinterface unter <literal>http://sip-proxy.falcot.com:5080</literal>, um die Konfiguration durch Hinzufügen von Domänen, lokalen Benutzern und statischen Routen abzuschließen.</para>

        <para>Der erste Schritt ist das Hinzufügen der lokalen Domäne. Der Vorgang muss nach dem Hinzufügen oder Entfernen von Domänen aus der Liste neu gestartet werden.</para>

        <para>Der Proxy weiß, wie man Anrufe zwischen lokalen Benutzern und vollen SIP-Adressen weiterleitet, die Routing-Konfiguration ist nur notwendig, um das Standardverhalten zu überschreiben, z.B. um Telefonnummern zu erkennen, ein Präfix hinzuzufügen und sie an einen SIP-Provider weiterzuleiten.</para>
      </section>
    </section>

    <section id="sect.xmpp-server">
      <title>XMPP Server</title>

      <para>Ein XMPP-Server verwaltet die Konnektivität zwischen lokalen XMPP-Benutzern und XMPP-Benutzern in anderen Domänen im öffentlichen Internet.</para>
      <indexterm><primary>XMPP</primary><secondary>server</secondary></indexterm>

      <sidebar>
        <title><emphasis>VOCABULARY</emphasis> XMPP or Jabber?</title>
        <indexterm><primary>Jabber</primary></indexterm>

        <para>XMPP wird manchmal als Jabber bezeichnet. Tatsächlich ist Jabber ein Warenzeichen und XMPP ist der offizielle Name des Standards.</para>
        <indexterm><primary>Jabber</primary></indexterm>
      </sidebar>

      <para>Prosody ist ein beliebter XMPP-Server, der zuverlässig auf Debian-Servern läuft.</para>
      <indexterm><primary>Prosody</primary></indexterm>
      <section id="sect.xmpp-server-install">
        <title>Installieren des XMPP-Servers</title>
        <para>Installieren Sie das Paket <emphasis role="pkg">repro</emphasis>. Die Verwendung des Pakets von <emphasis role="distribution">jessie-backports</emphasis> wird dringend empfohlen, da es die neuesten Verbesserungen zur Maximierung der Konnektivität und Ausfallsicherheit enthält.</para>
        <indexterm><primary>Prosody</primary></indexterm>

        <para>Überprüfen Sie die Konfigurationsdatei <filename>/etc/prosody/prosody.cfg.lua</filename>. Das Wichtigste ist das Einfügen von JIDs der Benutzer, die den Server verwalten dürfen.</para>

<programlisting>
admins = { "joe@falcot.com" }</programlisting>

        <para>Außerdem wird für jede Domäne eine eigene Konfigurationsdatei benötigt. Kopieren Sie das Beispiel aus <filename>/etc/prosody/conf.avail/example.com.cfg.lua</filename> und verwenden Sie es als Ausgangspunkt. Hier ist <literal>falcot.com.cfg.lua</literal>:</para>

<programlisting>
VirtualHost "falcot.com"
        enabled = true
        ssl = {
                key = "/etc/ssl/private/falcot.com-key.pem";
                certificate = "/etc/ssl/public/falcot.com.pem";
                }</programlisting>

        <para>Um die Domain zu aktivieren, muss ein Symlink von <filename>/etc/prosody/conf.d/</filename> vorhanden sein. Erstellen Sie es so:</para>

<screen><computeroutput># </computeroutput><userinput>ln -s /etc/prosody/conf.avail/falcot.com.cfg.lua /etc/prosody/conf.d/</userinput>
</screen>

        <para>Starten Sie den Dienst neu, um die neue Konfiguration zu verwenden.</para>
      </section>
      <section id="sect.xmpp-server-management">
        <title>Managing the XMPP server</title>
        <para>Einige Verwaltungsvorgänge können mit dem Kommandozeilenprogramm <literal>prosodyctl</literal> durchgeführt werden. Zum Beispiel, um das unter <filename>/etc/prosody/prosody.cfg.lua</filename> angegebene Administratorkonto hinzuzufügen:</para>
<programlisting>
# prosodyctl adduser joe@falcot.com</programlisting>

        <para>Finden Sie in der <ulink url="http://prosody.im/doc/configure"> Prosody online documentation</ulink> weitere Details zur Anpassung der Konfiguration.</para>

      </section>

    </section>
    <section id="sect.rtc-port-443">
      <title>Laufende Dienste auf Port 443</title>
      <para>Einige Administratoren bevorzugen alle ihre RTC-Dienste auf Port 443 laufen zu lassen. Dies hilft Benutzern, sich von entfernten Orten wie Hotels und Flughäfen aus zu verbinden, wo andere Ports blockiert werden können oder der Internetverkehr über HTTP-Proxy-Server geleitet wird.</para>

      <para>Um diese Strategie zu nutzen, benötigt jeder Dienst (SIP, XMPP und TURN) eine andere IP-Adresse. Alle Dienste können sich weiterhin auf demselben Host befinden, da Linux mehrere IP-Adressen auf einem einzigen Host unterstützt. Die Portnummer 443 muss in den Konfigurationsdateien für jeden Prozess und auch in den DNS-SRV-Einträgen angegeben werden.</para>
    </section>
    <section id="sect.rtc-webrtc">
      <title>Adding WebRTC</title>

      <para>Falcot möchte Kunden direkt von der Website aus telefonieren lassen. Die Falcot-Administratoren wollen WebRTC auch als Teil ihres Disaster-Recovery-Plans nutzen, so dass sich die Mitarbeiter zu Hause über Webbrowser in die Telefonanlage des Unternehmens einloggen und im Notfall normal arbeiten können.</para>
      <indexterm><primary>WebRTC</primary></indexterm>
      <indexterm><primary>SIP</primary><secondary>WebSockets</secondary></indexterm>

      <sidebar>
        <title><emphasis>IN PRACTICE</emphasis> Try WebRTC</title>
        <indexterm><primary>WebRTC</primary><secondary>demonstration</secondary></indexterm>

        <para>Wenn Sie WebRTC noch nicht ausprobiert haben, gibt es verschiedene Webseiten, die eine Online-Demonstration sowie Testmöglichkeiten bieten. <ulink type="block" url="http://www.sip5060.net/test-calls" /></para>        
      </sidebar>

      <para>WebRTC ist eine sich schnell entwickelnde Technologie und es ist wichtig, Pakete aus der <emphasis role="distribution">jessie-backports</emphasis> oder <emphasis role="distribution">Testing</emphasis> Distributionen zu verwenden.</para>

      <para>JSCommunicator ist ein generisches, markenfreies WebRTC-Telefon, das kein serverseitiges Scripting wie PHP benötigt. Es wurde ausschließlich mit HTML, CSS und JavaScript erstellt. Es ist die Basis für viele weitere WebRTC-Dienste und Module für erweiterte Web-Publishing-Frameworks. <ulink type="block" url="http://jscommunicator.org" /></para>
      <indexterm><primary>JSCommunicator</primary></indexterm>

      <para>Das Paket <emphasis role="pkg">jscommunicator-web-phone</emphasis> ist der schnellste Weg, ein WebRTC-Telefon in eine Website zu installieren. Es wird ein SIP-Proxy mit einem WebSocket-Transport benötigt. Die Anweisungen in <xref linkend="sect.sip-server-install" /> enthalten die notwendigen Details, um den WebSocket-Transport in der <emphasis role="pkg">repro</emphasis> SIP-Proxy zu aktivieren.</para>

      <para>Nach der Installation von <emphasis role="pkg">jscommunicator-web-phone</emphasis> gibt es verschiedene Möglichkeiten, es zu verwenden. Eine einfache Methode besteht darin, die Konfiguration von <filename>/etc/jscommunicator-web-phone/apache.conf</filename> in eine virtuelle Apache-Host-Konfiguration einzubinden oder zu kopieren.</para>

      <para>Sobald die Web-Telefondateien im Webserver verfügbar sind, passen Sie den <filename>/etc/jscommunicator-web-phone/config.js</filename> so an, dass er auf den TURN-Server und den SIP-Proxy zeigt. Zum Beispiel:</para>

<programlisting>
JSCommSettings = {

  // Web server environment
  webserver: {
    url_prefix: null            // If set, prefix used to construct sound/ URLs
  },

  // STUN/TURN media relays
  stun_servers: [],
  turn_servers: [
    { server:"turn:turn-server.falcot.com?transport=udp", username:"joe", password:"j0Ep455d" }
  ],

  // WebSocket connection
  websocket: {
      // Notice we use the falcot.com domain certificate and port 8443
      // This matches the Transport3 and Transport4 example in
      // the falcot.com repro.config file
    servers: 'wss://falcot.com:8443',
    connection_recovery_min_interval: 2,
    connection_recovery_max_interval: 30
  },

  ...</programlisting>

      <para>Erweiterte Click-to-Call-Websites verwenden normalerweise serverseitiges Scripting, um die Datei <literal>config.js</literal> dynamisch zu erzeugen. Der <ulink url="http://drucall.org">DruCall</ulink> Quellcode zeigt, wie man dies mit PHP macht.</para>
      <indexterm><primary>DruCall</primary></indexterm>

      <para>Dieses Kapitel hat nur einen Bruchteil der verfügbaren Serversoftware dargestellt; jedoch wurden die meisten der üblichen Netzwerkdienste beschrieben. Jetzt ist es Zeit für ein noch technischeres Kapitel: wir werden tiefer in die Einzelheiten einiger Konzepte eindringen, sowie Masseneinsätze und Virtualisierungen beschreiben.</para>

    </section>
  </section>
</chapter>
