<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="network-services">
  <chapterinfo>
    <mediaobject condition="pdf">
      <imageobject>
        <imagedata fileref="images/chap-network-services.png" scalefit="1" />
      </imageobject>
    </mediaobject>
    <keywordset>
      <keyword>Postfix</keyword>
      <keyword>Apache</keyword>
      <keyword>NFS</keyword>
      <keyword>Samba</keyword>
      <keyword>Squid</keyword>
      <keyword>OpenLDAP</keyword>
      <keyword>SIP</keyword>
    </keywordset>
  </chapterinfo>
  <title>سرویس‌های شبکه: Postfix، Apache، NFS، Samba، Squid، LDAP، SIP، XMPP، Turn</title>
  <highlights>
    <para>سرویس‌های شبکه برنامه‌هایی هستند که کاربران به صورت روزانه با آن‌ها سر و کار دارند. این ابزارها بخش عظیمی از دنیای فناوری را شامل می‌شوند که در این فصل به بررسی آن‌ها خواهیم پرداخت؛ قسمت پنهانی که  این ابزارها روی آن قرار می‌گیرند همان زیرساختی است که تاکنون بررسی کرده‌ایم.</para>

    
    <para>بسیاری سرویس‌های نوین شبکه به منظور عملکرد صحیح و امن نیازمند فناوری رمزنگاری هستند، بخصوص زمانی که در شبکه عمومی اینترنت مورد استفاده باشند. گواهینامه‌های X.509 (که به نام گواهینامه‌های SSL یا TLS نیز شناخته می‌شوند) اغلب به این منظور استفاده می‌شوند. یک گواهینامه برای دامنه‌ای بخصوص می‌تواند برای تعداد بیشتری از سرویس‌های مورد بحث در این فصل استفاده شود.</para>
    <indexterm><primary>TLS</primary></indexterm>
    <indexterm><primary>X.509</primary></indexterm>
    <indexterm><primary>گواهینامه‌ها</primary></indexterm>
  </highlights>
  <section id="sect.smtp-mail-server">
    <title>سرور ایمیل</title>

    <para>مدیرسیستم‌های شرکت فالکوت Postfix را، با توجه به قابلیت اطمینان بالا و سادگی در پیکربندی برای سرور ایمیل خود انتخاب کرده‌اند. در حقیقت، طراحی آن بگونه‌ای است که هر وظیفه با حداقل تعداد مجوزهای مورد نیاز پیاده‌سازی شود، که این روش یک عامل کاهنده در رابطه با مشکلات امنیتی است.</para>
    <indexterm><primary>ایمیل</primary><secondary>سرور</secondary></indexterm>
    <indexterm><primary>سرور ایمیل</primary></indexterm>
    <indexterm><primary>Postfix</primary></indexterm>

    <sidebar>
      <title><emphasis>جایگزین</emphasis> سرور Exim4</title>
      <indexterm><primary>Exim</primary></indexterm>

      <para>دبیان از Exim4 به عنوان سرور پیشفرض ایمیل استفاده می‌کند (به همین دلیل است که زمان نصب اولیه سیستم انتخاب شده است). پیکربندی آن در بسته جداگانه‌ای بنام <emphasis role="pkg">exim4-config</emphasis> قرار دارد و به صورت خودکار توسط پرسش‌های مطرح شده از Debconf سفارشی‌سازی می‌شود، که بسیار شبیه به پرسش‌های مطرح شده توسط بسته <emphasis role="pkg">postfix</emphasis> است.</para>

      <para>پیکربندی می‌تواند در یک فایل جداگانه قرار داشته باشد (<filename>/etc/exim4/exim4.conf.template</filename>) یا در مسیر <filename>/etc/exim4/conf.d/</filename> بین چندین فایل مختلف تقسیم گردد. در هر دو مورد، فایل‌ها توسط <command>update-exim4.conf</command> به عنوان قالبی برای تولید <filename>/var/lib/exim4/config.autogenerated</filename> مورد استفاده قرار می‌گیرند. فایل آخر همان فایلی است که توسط Exim4 مورد استفاده قرار می‌گیرد. به لطف این مکانیزم، مقادیر بدست آمده از پیکربندی debconf در Exim - که در فایل <filename>/etc/exim4/update-exim4.conf.conf</filename> ذخیره شده‌اند - می‌توانند درون فایل پیکربندی Exim قرار گیرند، حتی زمانی که مدیرسیستم یا بسته دیگری پیکربندی پیشفرض آن را تغییر داده باشند.</para>

      <para>شیوه نگارش فایل پیکربندی Exim4 ویژگی‌های عجیب و غریب خود را دارد؛ اگرچه، زمانی که این قوانین فراگرفته شوند، Exim4 به یک سرور ایمیل بسیار کامل و قدرتمند تبدیل می‌شود، که گواه آن صفحات مستندات پروژه است. <ulink type="block" url="http://www.exim.org/docs.html" /></para>
    </sidebar>

    
    <section>
      <title>نصب Postfix</title>

      <para>بسته <emphasis role="pkg">postfix</emphasis> شامل فرآیند پس‌زمینه اصلی SMTP است. سایر بسته‌ها از جمله <emphasis role="pkg">postfix-ldap</emphasis> و <emphasis role="pkg">postfix-pgsql</emphasis> قابلیت‌های بیشتری را به آن اضافه می‌کنند از جمله دسترسی به پایگاه‌داده‌های نگاشت شده. تنها زمانی که به آن‌ها نیاز دارید باید نصبشان کنید.</para>

      <sidebar id="sidebar.smtp">
        <title><emphasis>بارگشت به مقدمات</emphasis> SMTP</title>
        <indexterm><primary>SMTP</primary></indexterm>
        <indexterm><primary>Simple Mail Transfer Protocol</primary></indexterm>
        <indexterm><primary>سرور</primary><secondary>SMTP</secondary></indexterm>

	<para>SMTP یا <emphasis>Simple Mail Transfer Protocol</emphasis> پروتکل مورد استفاده سرورهای ایمیل برای تبادل و مسیریابی ایمیل‌ها است.</para>
      </sidebar>

      <para>هنگام نصب بسته، چندین پرسش از طرف Debconf مطرح می‌شود. پاسخ‌های داده شده برای تولید اولین فایل پیکربندی <filename>/etc/postfix/main.cf</filename> بکار می‌روند.</para>

      <para>پرسش اول درباره نوع راه‌اندازی است. تنها دو تا از پاسخ‌های پیشنهادی در مورد یک سرور متصل به اینترنت مناسب هستند، “Internet site” و “Internet with smarthost”. اولی برای سروری مناسب است که ایمیل ورودی را دریافت کرده و پاسخ را مستقیم به گیرنده می‌فرستد، که به همین دلیل برای شرکت فالکوت مناسب است. دومی برای سروری مناسب است که ایمیل ورودی را دریافت کرده، اما پاسخ را از طریق یک سرور SMTP میانی - یا همان “smarthost” - به گیرنده می‌فرستد. این گزینه اغلب برای افرادی مناسب است که از نشانی IP پویا استفاده می‌کنند، چرا که بسیاری سرورهای ایمیل از دریافت پیام‌های ارسالی از طرف چنین نشانی‌هایی خودداری می‌کنند. در این مورد، smarthost معمولا سرور SMTP شرکت ارائه دهنده خدمات اینترنتی است، که معمولا طوری پیکربندی می‌شود تا ایمیل‌های دریافتی از مشتریان خود را به درستی مسیریابی کند. این راه‌اندازی (با یک smarthost) برای سرورهایی که دائم به اینترنت متصل نیستند نیز مناسب است، چرا که از مدیریت صف پیام‌های غیرقابل ارسال که نیاز به حذف شدن در زمان دیگری را دارند، جلوگیری می‌کند.</para>

      <sidebar>
        <title><emphasis>واژگان</emphasis> ISP</title>
        <indexterm><primary>ISP, Internet Service Provider</primary></indexterm>

	<para>ISP مخفف عبارت “Internet Service Provider” یا همان ارائه دهنده خدمات اینترنتی است. معمولا شامل یک شرکت تجاری است که خدمات پایه در اینترنت را فراهم می‌کند (وب، ایمیل، خبر و ...).</para>

        <para></para>
      </sidebar>

      <para>پرسش دوم درباره نام کامل رایانه‌ای است که نشانی‌های ایمیل را از یک کاربر محلی تولید می‌کند؛ نام کامل پس از قسمت جلوی “@” می‌آید. در مورد فالکوت، پاسخ برابر است با <literal>mail.falcot.com</literal>. این تنها پرسشی است که به صورت پیشفرض مطرح می‌شود، اما پیکربندی که در پی دارد نیازهای شرکت فالکوت را تامین نمی‌کند، به همین دلیل مدیرسیستم‌های آن اقدام به اجرای <command>dpkg-reconfigure postfix</command> می‌کنند تا بتوانند گزینه‌های بیشتری را پیکربندی نمایند.</para>

      <para>یکی از پرسش‌های اضافی که پرسیده می‌شود درباره تمام دامنه‌های مرتبط با این رایانه است. فهرست پیشفرض شامل نام کامل آن به همراه برخی نام‌های مترادف برای <literal>localhost</literal> است، اما دامنه اصلی <literal>falcot.com</literal> باید به صورت دستی اضافه شود. به صورت کلی، این پرسش باید با تمام نام‌های دامنه که برای آن‌ها این رایانه به عنوان یک سروی MX عمل می‌کند پاسخ داده شود؛ به عبارت دیگر، تمام دامنه‌هایی که DNS می‌گوید برای این رایانه ایمیل دریافت می‌کنند. این اطلاعات در متغیر <literal>mydestination</literal> واقع در فایل پیکربندی اصلی Postfix - <filename>/etc/postfix/main.cf</filename> - قرار می‌گیرند.</para>
      <indexterm><primary>سرور</primary><secondary>MX</secondary></indexterm>
      <indexterm><primary>MX</primary><secondary>سرور</secondary></indexterm>

      <figure>
        <title>نقش رکورد <emphasis>MX</emphasis> در DNS هنگام ارسال ایمیل</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/mail-server.png" scalefit="1" width="60%" />
          </imageobject>
        </mediaobject>
      </figure>

      <sidebar>
        <title><emphasis>اضافی</emphasis> پرس و جو از رکوردهای MX</title>

	<para>زمانی که DNS برای یک دامنه شامل رکورد MX نباشد، سرور ایمیل تلاش می‌کند که پیام‌ها را مستقیم به خود سیستم میزبان بفرستد، با استفاده از رکورد A متناظر (یا AAAA در IPv6).</para>
      </sidebar>

      <para>در برخی موارد، فرآیند نصب می‌تواند شبکه‌ای را که مجاز به ارسال ایمیل است درخواست کند. در پیکربندی پیشفرض، Postfix فقط ایمیل‌های ارسالی از خود رایانه را قبول می‌کند؛ شبکه محلی نیز معمولا اضافه می‌شود. مدیرسیستم‌های فالکوت <literal>192.168.0.0/16</literal> را به پاسخ پیشفرض اضافه کرده‌اند. اگر این پرسش مطرح نشود، متغیر مربوطه در فایل پیکربندی عبارت است از <literal>mynetworks</literal>، که در نمونه زیر نیز مشاهده می‌شود.</para>

      <para>ایمیل محلی می‌تواند از طریق <command>procmail</command> تحویل داده شود. این ابزار به کاربران امکان می‌دهد که ایمیل دریافتی خود را با توجه به قوانین ذخیره شده در فایل <filename>~/.procmailrc</filename> مرتب‌سازی کنند.</para>
      <indexterm><primary><command>procmail</command></primary></indexterm>
      <indexterm><primary>ایمیل</primary><secondary>فیلترکردن</secondary></indexterm>
      <indexterm><primary>فیلترکردن ایمیل</primary></indexterm>

      <para>پس از این گام اولیه، فایل پیکربندی مقابل در اختیار مدیرسیستم‌ها قرار گرفته است؛ از این فایل به عنوان نقطه شروعی برای افزودن قابلیت‌های بیشتر در قسمت‌های بعدی استفاده می‌شود.</para>

      <example>
        <title>فایل اولیه <filename>/etc/postfix/main.cf</filename></title>

        <programlisting>
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</programlisting>
      </example>
      <sidebar>
        <title><emphasis>امنیت</emphasis> گواهینامه‌های SSL <emphasis>زهر ماری</emphasis></title>

	<para>گواهینامه‌های <emphasis>زهر ماری</emphasis> مانند "داروی" <emphasis>زهر ماری</emphasis> که توسط کلاهبرداران در زمان گذشته فروخته می‌شد، هیچ ارزشی ندارند. شما نمی‌توانید روی آن‌ها برای احرازهویت سرور حساب کنید چرا که این‌ها گواهینامه‌های بدون اعتباری هستند. با این حال، برای بهبود حریم‌شخصی در تبادل ارتباطات مفید واقع می‌شوند.</para>
        <para>در حالت کلی تنها برای اهداف آزمایشی باید مورد استفاده قرار گیرند، و یک سرویس عادی باید از گواهینامه‌های واقعی استفاده کند؛ این گواهینامه‌ها می‌توانند به شیوه مطرح شده در قسمت <xref linkend="sect.easy-rsa" /> تولید گردند.</para>
      </sidebar>
    </section>
    <section id="sect.configuring-virtual-domains">
      <title>پیکربندی دامنه‌های مجازی</title>
      <indexterm><primary>دامنه</primary><secondary>مجازی</secondary></indexterm>
      <indexterm><primary>دامنه مجازی</primary></indexterm>

      <para>سرور ایمیل می‌تواند ایمیل‌هایی که به سایر دامنه‌ها در کنار دامنه اصلی ارسال شده‌اند را دریافت کند؛ این دامنه‌ها بنام دامنه‌های مجازی شناخته می‌شوند. در اکثر مواردی که این اتفاق می‌افتد، ایمیل‌ها الزاما به کاربران محلی مورد نظر خود ارجاع داده نمی‌شوند. Postfix دو ویژگی جالب فراهم می‌کند که برای دامنه‌های مجازی بکار می‌روند.</para>

      <sidebar>
        <title><emphasis>احتیاط</emphasis> دامنه‌های مجازی و دامنه‌های استاندارد</title>

	<para>هیچ یک از دامنه‌های مجازی نباید در متغیر <literal>mydestination</literal> قرار بگیرند؛ این متغیر تنها شامل نام‌ دامنه‌های “استاندارد” است که به طور مستقیم با رایانه و کاربران محلی آن متناظر می‌باشد.</para>
      </sidebar>
      <section>
        <title>دامنه‌های مستعار مجازی</title>
        <indexterm><primary>مستعار</primary><secondary>دامنه مستعار مجازی</secondary></indexterm>
        <indexterm><primary>دامنه مجازی</primary><secondary>دامنه مستعار مجازی</secondary></indexterm>

	<para>یک دامنه مستعار مجازی تنها شامل نام‌های مستعار است، نشانی‌هایی که ایمیل‌ها را به سایر نشانی‌ها فوروارد می‌کنند.</para>

	<para>چنین دامنه‌ای با افزودن نامش به متغیر <literal>virtual_alias_domains</literal> و ارجاع دادن به یک فایل نگاشت نشانی در متغیر <literal>virtual_alias_maps</literal>، فعال می‌شود.</para>

        <example>
          <title>دستوراتی برای افزودن به فایل <filename>/etc/postfix/main.cf</filename></title>

          <programlisting>
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual</programlisting>
        </example>

	<para>فایل <filename>/etc/postfix/virtual</filename> یک نگاشت با شیوه‌ای ساده را توضیح می‌دهد: هر خط شامل دو فیلد است که با فاصله از یکدیگر جدا شده‌اند؛ فیلد اول نام مستعار و فیلد دوم فهرستی از نشانی‌های ایمیل است که به آن ارسال می‌شود. شیوه نگارشی بخصوص <literal>@domain.com</literal> تمام نام‌های مستعار در یک دامنه را پوشش می‌دهد.</para>

        <example>
          <title>نمونه فایل <filename>/etc/postfix/virtual</filename></title>

          <programlisting>
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com</programlisting>
        </example>
      </section>
      <section>
        <title>دامنه‌های صندوق‌پستی مجازی</title>

        <sidebar>
          <title><emphasis>احتیاط</emphasis> دامنه مجازی ترکیبی؟</title>

	  <para>Postfix اجازه نمی‌دهد که از یک دامنه در هر دو متغیر <literal>virtual_alias_domains</literal> و <literal>virtual_mailbox_domains</literal> استفاده شود. با این حال هر دامنه موجود در <literal>virtual_mailbox_domains</literal> به طور ضمنی در <literal>virtual_alias_domains</literal> نیز قرار داده می‌شود که امکان ترکیب نام‌های مستعار و صندوق‌های پستی در یک دامنه مجازی را فراهم می‌آورد.</para>
        </sidebar>

        <indexterm><primary>صندوق‌پستی، دامنه مجازی</primary></indexterm>
	<indexterm><primary>دامنه مجازی</primary><secondary>دامنه صندوق‌پستی مجازی</secondary></indexterm>

	<para>پیام‌هایی که به یک دامنه صندوق‌پستی مجازی ارسال می‌شوند در صندوق‌پستی‌هایی ذخیره می‌گردد که در اختیار کاربر محلی سیستم نیست.</para>

	<para>فعال‌سازی یک دامنه صندوق‌پستی مجازی نیازمند نام بردن از این دامنه در متغیر <literal>virtual_mailbox_domains</literal> و ارجاع به یک فایل نگاشت صندوق‌پستی در <literal>virtual_mailbox_maps</literal> است. پارامتر <literal>virtual_mailbox_base</literal> شامل دایرکتوری است که در آن صندوق‌های پستی ذخیره می‌شوند.</para>

	<para>پارامتر <literal>virtual_uid_maps</literal> (به همین ترتیب پارامتر <literal>virtual_gid_maps</literal>) به فایلی ارجاع می‌دهد که شامل نگاشت بین نشانی ایمیل و کاربر سیستم است که "مالک" صندوق‌پستی مربوطه می‌باشد (به همین ترتیب برای گروه). برای دریافت تمام صندوق‌پستی‌هایی که توسط مالک/گروه یکسانی اداره می‌شوند، عبارت <literal>static:5000</literal> یک شناسه‌کاربر/شناسه‌گروه ثابت را به آن اختصاص می‌دهد (در اینجا مقدار ۵۰۰۰).</para>

        <example>
          <title>دستوراتی برای افزودن به فایل <filename>/etc/postfix/main.cf</filename></title>

          <programlisting>
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts</programlisting>
        </example>

	<para>مجدد، شیوه نگارش فایل <filename>/etc/postfix/vmailbox</filename> کاملا واضح است: دو فیلد که با فاصله از یکدیگر جدا شده‌اند. فیلد اول نشانی ایمیل یکی از دامنه‌های مجازی است و فیلد دوم مکان صندوق‌پستی مورد نظر است (نسبت به دایرکتوری مشخص شده در <emphasis>virtual_mailbox_base</emphasis>). اگر نام صندوق‌پستی با یک اسلش (<literal>/</literal>) تمام شود، ایمیل‌ها در قالب <emphasis>maildir</emphasis> ذخیره‌سازی می‌شوند؛ در غیر اینصورت از قالب سنتی <emphasis>mbox</emphasis> استفاده می‌گردد. قالب <emphasis>maildir</emphasis> از یک دایکتوری کامل برای ذخیره‌سازی یک صندوق‌پستی استفاده می‌کند، که هر پیام آن در یک فایل جداگانه قرار می‌گیرد. از طرف دیگر، در قالب <emphasis>mbox</emphasis> تمام صندوق‌پستی در یک فایل بزرگ ذخیره می‌شود و هر خطی که با <literal>From </literal> (به همراه یک فاصله) آغاز گردد، نشانگر ابتدای یک پیام است.</para>

        <example>
          <title>فایل <filename>/etc/postfix/vmailbox</filename></title>

          <programlisting>
# Jean's email is stored as maildir, with
# one file per email in a dedicated directory
jean@falcot.org falcot.org/jean/
# Sophie's email is stored in a traditional "mbox" file,
# with all mails concatenated into one single file
sophie@falcot.org falcot.org/sophie</programlisting>
        </example>
      </section>
    </section>
    <section id="sect.restrictions-for-receiving-and-sending">
      <title>محدودیت برای ارسال و دریافت</title>

      <para>تعداد رو به افزایش ایمیل‌های انبوه ناخواسته (<emphasis>spam</emphasis>) تصمیم‌گیری درباره اینکه سرور چه ایمیل‌هایی را دریافت کند، دشوار می‌سازد. این قسمت به بررسی برخی راهبردهای موجود در Postfix می‌پردازد.</para>

      <sidebar>
        <title><emphasis>فرهنگ</emphasis> مشکل اسپم</title>
        <indexterm><primary>اسپم</primary></indexterm>

	<para>"اسپم" یک عبارت عمومی برای تشخیص دادن تمام ایمیل‌های تجاری ناخواسته (که به نام UCE شناخته می‌شوند) است که به صندوق‌پستی‌های الکترونیک ما سرازیر می‌شوند؛ افرادی که به شیوه‌ای بی‌مهابا این ایمیل‌ها را ارسال می‌کنند با نام اسپمر شناخته می‌شوند. آن‌ها اهمیتی به میزان مزاحمت ایجاد شده برای کاربر نمی‌دهند و از آنجا که هزینه ارسال چنین ایمیل‌هایی بسیار پایین است اگر تنها درصد کمی از مخاطبان آن‌ها جذب این ایمیل‌ها شوند، تمام هزینه آن‌ها جبران خواهد شد. این فرآیند اغلب به صورت خودکار انجام می‌شود و هر نشانی ایمیل عمومی (برای نمونه، در یک انجمن وب، یا بایگانی یک فهرست پستی، یا یک وبلاگ و از این قبیل) توسط ربات‌های اسپمرها شناسایی شده و قربانی جریان بی‌پایانی از پیام‌های ناخواسته خواهد شد.</para>

	<para>تمام مدیرسیستم‌ها تلاش می‌کنند که با استفاده از فیلترهای اسپم با این مزاحمت مقابله کنند، اما اسپمرها نیز در این میان بیکار نمی‌شینند. برخی از آن‌ها برای کار خود حتی شبکه‌ای از رایانه‌ها را از اتحادیه‌های خلافکاری به اجاره می‌گیرند. محاسبات آماری اخیر نشان می‌دهد که بالغ بر ۹۵٪ از ترافیک ایمیل روی اینترنت مربوط به اسپم است!</para>
      </sidebar>
      <section>
        <title>محدودیت‌های دسترسی مبتنی بر IP</title>

	<para>عبارت <literal>smtpd_client_restrictions</literal> کنترل می‌کند که چه رایانه‌هایی مجاز به برقراری ارتباط با سرور ایمیل هستند.</para>

        <example>
          <title>محدودیت‌های مبتنی بر نشانی میزبان</title>

          <programlisting>
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org</programlisting>
        </example>

	<para>زمانی که یک متغیر شامل فهرستی از قوانین باشد، مانند نمونه بالا، این قوانین به ترتیب از ابتدا تا انتها ارزیابی می‌گردند. هر قانون می‌تواند پیام را دریافت، رد یا تصمیم‌گیری درباره آن را به قانون بعدی بسپارد. به همین دلیل، ترتیب قرارگیری آن‌ها مهم است و تعویض دو گزینه می‌تواند نتایج متفاوتی به همراه داشته باشد.</para>

	<para>عبارت <literal>permit_mynetworks</literal>، که به عنوان قانون اول استفاده شد، تمام ایمیل‌های ارسالی از یک رایانه شبکه محلی را قبول می‌کند (به ترتیبی که در متغیر پیکربندی <emphasis>mynetworks</emphasis> بیان شده است).</para>

	<para>عبارت دوم ایمیل‌هایی را که از یک رایانه با پیکربندی DNS نامعتبر آمده باشند، نادیده می‌گیرد. چنین پیکربندی معتبری به این معنی است که نشانی IP بتواند به یک نام تبدیل شود و عکس آن نیز اتفاق بیفتد. این محدودیت‌ها اغلب سخت‌گیرانه هستند، چرا که بسیاری سرورهای ایمیل شامل DNS معکوس برای نشانی‌های IP خود نیستند. به همین دلیل است که مدیرسیستم‌های فالکوت از عملگر <literal>warn_if_reject</literal> قبل از عبارت <literal>reject_unknown_client</literal> استفاده می‌کنند: این عملگر منجر به تبدیل عملیات به یک پیام ساده اخطار در فایل‌های گزارش می‌گردد. سپس مدیرسیستم‌ها می‌توانند نگاهی به تعداد پیام‌های احتمالی برای نادیده گرفتن شدن بیندازند اگر این قانون در عمل اجرایی می‌شد، و در آینده تصمیم بگیرند که به چنین قابلیتی نیاز دارند یا خیر.</para>

        <sidebar>
          <title><emphasis>نکته</emphasis> جدول‌های <emphasis>دسترسی</emphasis></title>

	  <para>شرایط محدودکننده شامل جدول‌های قابل تغییر توسط مدیرسیستم می‌شود که فهرستی از فرستندگان، نشانی‌های IP و نام‌های میزان مجاز و ممنوع را شامل می‌شود. این جدول‌ها می‌توانند از یک نسخه فشرده نشده فایل <filename>/usr/share/doc/postfix-doc/examples/access.gz</filename> ایجاد گردند. این مدل در توضیحات خود بیان شده است، یعنی هر جدول شیوه نگارش خود را مشخص می‌کند.</para>

	  <para>جدول <filename>/etc/postfix/access_clientip</filename> فهرستی از نشانی‌های IP و شبکه‌ها را ذخیره می‌کند؛ جدول <filename>/etc/postfix/access_helo</filename> فهرستی از نام‌های دامنه را ذخیره می‌کند و جدول <filename>/etc/postfix/access_sender</filename> شامل نشانی‌های ایمیل فرستنده است. تمام این فایل‌ها پس از هر تغییر با استفاده از دستور <command>postmap /etc/postfix/<replaceable>file</replaceable></command> باید به صورت جدول‌های hash درآیند (قالبی که برای دسترسی سریع بهینه شده است).</para>
        </sidebar>

	<para>عبارت سوم به مدیرسیستم اجازه می‌دهد که فهرست سیاه و سفیدی از سرورهای ایمیل، که در فایل <filename>/etc/postfix/access_clientip</filename> ذخیره می‌شوند، ایجاد کند. سرورهای موجود در فهرست سفید قابل اعتماد در نظر گرفته می‌شوند و ایمیل‌های ارسالی از آن‌ها از قوانین فیلترینگ گفته شده عبور داده نمی‌شوند.</para>

	<para>دو قانون آخر نیز تمام پیام‌های ارسالی از طرف یکی از سرورهای موجود در فهرست سیاه را رد می‌کنند. RBL مخفف عبارت <emphasis>Remote Black List</emphasis> است؛ چنین فهرست‌های موجود است اما تمام آن‌ها شامل سرورهایی هستند که به شیوه‌ای بد پیکربندی شده‌اند که اسپمرها از آن‌ها برای بازپخش ایمیل‌های خود استفاده می‌کنند، این رایانه‌ها اغلب توسط کرم‌ها یا ویروس‌ها آلوده گشته‌اند.</para>
        <indexterm><primary>RBL</primary></indexterm>
        <indexterm><primary>فهرست سیاه راه‌دور</primary></indexterm>

        <sidebar>
          <title><emphasis>نکته</emphasis> فهرست سفید و RBLها</title>

	  <para>فهرست‌های سیاه گاهی شامل سرورهای قانونی هستند که دچار حادثه شده‌اند. در این شرایط، تمام ایمیل‌های ارسالی از این سرورها رد می‌شوند مگر اینکه نام آن‌ها در یک فهرست سفید تعریف شده در <filename>/etc/postfix/access_clientip</filename> وجود داشته باشد.</para>

	  <para>احتیاط حکم می‌کند که تمام سرورهای قابل اعتماد که اکثر ایمیل‌ها از طرف آن‌ها است درون فهرست سفید قرار دهید.</para>
        </sidebar>
      </section>
      <section>
        <title>بررسی اعتبار دستورات <literal>EHLO</literal> یا <literal>HELO</literal></title>

	<para>هر تبادل SMTP با یک دستور <literal>HELO</literal> (یا <literal>EHLO</literal>) آغاز می‌شود، به همراه نام سرور ایمیل فرستنده؛ بررسی اعتبار این نام می‌تواند کار جالبی باشد.</para>
        <indexterm><primary><literal>HELO</literal></primary></indexterm>
        <indexterm><primary><literal>EHLO</literal></primary></indexterm>

        <example>
          <title>محدودیت‌های نام اعلام شده در <literal>EHLO</literal></title>
          
          <programlisting>
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname</programlisting>
        </example>

	<para>عبارت ابتدایی <literal>permit_mynetworks</literal> به تمام رایانه‌های شبکه محلی اجازه می‌دهد که خود را آزادانه معرفی کنند. این مهم است چرا که برخی برنامه‌های ایمیل برای این بخش از پروتکل SMTP به اندازه کافی احترام قائل نیستند و آن‌ها می‌توانند خود را با نام‌های مهمل معرفی کنند.</para>

	<para>قانون <literal>reject_invalid_hostname</literal> ایمیل‌هایی را که شامل غلط نگارشی در <literal>EHLO</literal> باشند رد می‌کند. قانون <literal>reject_non_fqdn_hostname</literal> پیام‌هایی را رد می‌کند که نام میزبان آن‌ها یک نام دامنه تمام-عیار نباشد (شامل نام دامنه به همراه نام میزبان). قانون <literal>reject_unknown_hostname</literal> پیام‌هایی را رد می‌کند که نام میزبان آن‌ها درون DNS موجود نباشد. از آنجا که این قانون آخر منجر به رد بسیاری پیام‌ها می‌شود مدیرسیستم‌ها تصمیم گرفته‌اند که آن را با یک عملگر <literal>warn_if_reject</literal> به صورت پیام اخطار ساده‌ای تبدیل کنند؛ آن‌ها می‌توانند در مرحله دیگری این عملگر را حذف کنند، پس از اینکه از نتایج آن باخبر شوند.</para>

	<para>استفاده از <literal>permit_mynetworks</literal> به عنوان قانون اول یک تاثیر جانبی جالب دارد: قوانین پیش رو تنها برای میزبان‌های خارج از شبکه محلی اعمال می‌شوند. اینکار امکان افزودن تمام میزبان‌هایی که قصد معرفی خود بجای <literal>falcot.com</literal> را دارند، به فهرست سیاه فراهم می‌آورد، برای نمونه، با افزودن یک خط <literal>گمشو بیرون، تو که تو شبکه ما نیستی!</literal> به فایل <filename>/etc/postfix/access_helo</filename>.</para>
      </section>
      <section>
        <title>پذیرش یا رد مبتنی بر فرستنده اعلام شده</title>

	<para>هر پیام شامل فرستنده است، که توسط دستور <literal>MAIL FROM</literal> از پروتکل SMTP اعلام می‌شود؛ مجدد، این اطلاعات می‌توانند به چندین روش ارزیابی گردند.</para>
        <indexterm><primary><literal>MAIL FROM</literal></primary></indexterm>
        <indexterm><primary>ایمیل</primary><secondary>فیلترینگ روی فرستنده</secondary></indexterm>

        <example>
          <title>بررسی‌های فرستنده</title>

          <programlisting>
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender</programlisting>
        </example>

	<para>جدول <filename>/etc/postfix/access_sender</filename> با برخی فرستندگان به شیوه‌ای خاص برخورد می‌کند. این معمولا به معنی قراردادن برخی فرستندگان در فهرست سیاه و سفید است.</para>

	<para>قانون <literal>reject_unknown_sender_domain</literal> نیازمند یک دامنه معتبر فرستنده است، چرا که برای یک نشانی معتبر لازم است. قانون <literal>reject_unlisted_sender</literal> کاربران محلی که نشانی آن‌ها موجود نباشد را رد می‌کند؛ اینکار از ارسال پیام‌هایی که از نشانی‌های نامعتبر وابسته به دامنه <literal>falcot.com</literal> می‌آیند، جلوگیری می‌کند. پیام‌هایی که به شکل <literal>joe.bloggs@falcot.com</literal> باشند تنها در شرایط وجود چنین نشانی پذیرفته می‌شوند.</para>

	<para>در نهایت، قانون <literal>reject_non_fqdn_sender</literal> پیام‌هایی که از یک نشانی بدون نام دامنه تمام-عیار ارسال شوند را رد می‌کند. در عمل، یعنی پیام‌هایی که به صورت <literal>user@machine</literal> باشند: نشانی باید به صورت <literal>user@machine.example.com</literal> یا <literal>user@example.com</literal> اعلام گردد.</para>
      </section>
      <section>
        <title>پذیرش یا رد مبتنی بر گیرنده</title>

	<para>هر ایمیل حداقل یک گیرنده دارد، که توسط دستور <literal>RCPT TO</literal> از پروتکل SMTP معرفی می‌شود. این نشانی‌ها همچنین عملیات اعتبارسنجی را تضمین می‌کنند، حتی اگر از بررسی‌های انجام شده روی نشانی فرستنده مشخص نباشد.</para>
        <indexterm><primary>RCPT TO</primary></indexterm>
        <indexterm><primary>ایمیل</primary><secondary>فیلترینگ روی گیرنده</secondary></indexterm>

        <example>
          <title>بررسی‌های گیرنده</title>

          <programlisting>
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient</programlisting>
        </example>

	<para><literal>reject_unauth_destination</literal> قانون پایه‌ای است که پیام‌های خارجی را ملزم می‌سازد نشانی ما را داشته باشند؛ پیام‌هایی که به نشانی خارج از محدوده پوشش این سرور فرستاده شوند رد می‌شوند. بدون این قانون، یک سرور به سیستم بازی تبدیل می‌شود  که به اسپمرها اجازه می‌دهد پیام‌های ناخواسته خود را ارسال کنند؛ بنابراین این قانون الزامی است و بهتر است که در قسمت ابتدایی فهرست قرار گیرد، تا قبل از مشخص نشدن گیرنده یک پیام، هیچ قانون دیگری نتواند آن را بررسی کند.</para>

	<para>قانون <literal>reject_unlisted_recipient</literal> پیام‌های ارسالی به کاربران غیرواقعی را رد می‌کند، که با عقل جور در می‌آید. در نهایت، قانون <literal>reject_non_fqdn_recipient</literal> نشانی‌هایی که تمام-عیار نباشند را رد می‌کند؛ این قانون منجر می‌شود که پیام به <literal>jean</literal> یا <literal>jean@machine</literal> ارسال نشود و نیازمند نشانی کامل می‌باشد از جمله <literal>jean@machine.falcot.com</literal> یا <literal>jean@falcot.com</literal>.</para>
      </section>
      <section>
        <title>محدودیت‌های مرتبط با دستور <literal>DATA</literal></title>

	<para>دستور <literal>DATA</literal> از پروتکل SMTP قبل از محتوای پیام قرار می‌گیرد. با اینکه هیچ اطلاعات خاصی را فراهم نمی‌کند، بجز معرفی قسمت بعدی، می‌تواند مورد بررسی قرار گیرد.</para>
        <indexterm><primary><literal>DATA</literal></primary></indexterm>

        <example>
          <title>بررسی‌های <literal>DATA</literal></title>

          <programlisting>
smtpd_data_restrictions = reject_unauth_pipelining</programlisting>
        </example>

	<para>عبارت <literal>reject_unauth_pipelining</literal> زمانی منجر به رد پیام می‌شود که فرستنده آن دستوری را قبل از پاسخ به دستور قبلی فرستاده باشد. این عملکرد در مقابل شیوه کار ربات‌های اسپمر قرار می‌گیرد، چرا که آن‌ها اغلب اهمیتی به پاسخ‌ها نمی‌دهند و تمرکز خود را روی ارسال بیشترین پیام در کمترین زمان معطوف می‌سازند.</para>
      </section>
      <section>
        <title>اعمال محدودیت‌ها</title>

	<para>با اینکه دستورات بالا اطلاعات را در مرحله‌های گوناگونی از فرآیند تبادل SMTP بررسی می‌کنند، Postfix عملیات رد پیام را در پاسخ به دستور <literal>RCPT TO</literal> ارسال می‌کند.</para>

	<para>یعنی حتی اگر پیام مبتنی بر یک دستور نامعتبر ... رد شده باشد، Postfix از فرستنده و گیرنده پیام هنگام اعلام رد آن آگاه است. در این مرحله است که می‌تواند پیام مرتبط‌تری را در فایل‌های گزارش قرار دهد تا اینکه همان ابتدای کار این فرآیند متوقف می‌شد. علاوه بر این، تعدادی از برنامه‌های SMTP انتظار شکست عملیات در همان دستورات ابتدایی SMTP را ندارند و این برنامه‌ها کمتر با این عملیات رد دیرموقع، مختل می‌‌شوند.</para>

	<para>مزیت نهایی این انتخاب این است که قوانین می‌توانند طی مراحل مختلف تبادل SMTP اطلاعات زیادی کسب کنند؛ این باعث می‌شود مجوزهای بهتری را بتوان تعریف کرد، از جمله رد یک ارتباط غیر-محلی که خود را به عنوان یک فرستنده محلی معرفی کرده باشد.</para>
      </section>
      <section>
        <title>فیلترکردن مبتنی بر محتوای پیام</title>

	<para>سیستم ارزیابی و ایجاد محدودیت بدون ایجاد روشی برای بررسی متن پیام کامل نیست. Postfix بین بررسی‌های انجام گرفته روی سرآیند ایمیل و بدنه آن تفاوت قائل می‌شود.</para>

        <example>
          <title>فعال‌سازی فیلترهای محتوا-محور</title>

          <programlisting>
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks</programlisting>
        </example>
        <indexterm><primary>ایمیل</primary><secondary>فیلترکردن محتوا</secondary></indexterm>

	<para>هر دو فایل شامل فهرستی از عبارت‌های منظم (که به نام <emphasis>regexps</emphasis> یا <emphasis>regexes</emphasis> نیز شاخته می‌شوند) و اقدامات مربوط به هر کدام در صورت تطبیق سرآیند یا بدنه ایمیل با آن‌ها می‌باشند.</para>

        <sidebar>
          <title><emphasis>نگاه سریع</emphasis> جدول‌های Regexp</title>

	  <para>فایل <filename>/usr/share/doc/postfix-doc/examples/header_checks.gz</filename> شامل توضیحاتی است که می‌تواند به عنوان نقطه آغازی برای ایجاد فایل‌های <filename>/etc/postfix/header_checks</filename> و <filename>/etc/postfix/body_checks</filename> بکار رود.</para>
        </sidebar>

        <example>
          <title>نمونه فایل <filename>/etc/postfix/header_checks</filename></title>

          <programlisting>
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification</programlisting>
        </example>

        <sidebar id="sidebar.regexp">
          <title><emphasis>بازگشت به مقدمات</emphasis> عبارت منظم</title>

	  <para>اصطلاح <emphasis>regular expression</emphasis> (که به طور مخفف <emphasis>regexp</emphasis> یا <emphasis>regex</emphasis> خوانده می‌شود) به یک شیوه نگارش عمومی از توضیح درباره محتوا و/یا ساختار رشته‌ای از کاراکترها گفته می‌شود. برخی کاراکترهای خاص امکان تعریف جایگزین را می‌دهند (برای نمونه، <literal>foo|bar</literal> برابر با “foo” یا “bar” است)، مجموعه‌ای از کاراکترهای مجاز (برای نمونه، <literal>[0-9]</literal> به معنی هر رقم و <literal>.</literal> - یک نقطه - به معنی هر کاراکتر است)، کمیت رشته‌ها (<literal>s?</literal> برابر با <literal>s</literal> یا رشته خالی، به عبارت دیگر ۰ یا ۱ تکرار از <literal>s</literal>؛ <literal>s+</literal> برابر با ۱ یا تعداد بیشتر از <literal>s</literal> و به همین ترتیب). پرانتزها امکان گروه‌بندی نتایج جستجو را فراهم می‌آورند.</para>

	  <para>شیوه نگارش دقیق این عبارت‌ها بسته به ابزارهای استفاده کننده از آن متفاوت است، اما از اصول پایه یکسانی استفاده می‌کنند. <ulink type="block" url="http://en.wikipedia.org/wiki/Regular_expression" /></para>
        </sidebar>

	<para>اولی به بررسی سرآیند می‌پردازد که آیا شامل نرم‌افزار ایمیل هست یا خیر؛ اگر <literal>GOTO Sarbacane</literal> (یک نرم‌افزار ایمیل انبوه) پیدا شد، پیام رد می‌شود. عبارت دوم نیز به بررسی محتوای پیام می‌پردازد؛ اگر شامل یک اطلاعیه ویروس باشد، می‌توان تصمیم گرفت بجای رد ایمیل، آن را نادیده بگیریم.</para>

	<para>استفاده از این فیلترها مانند راه رفتن روی لبه تیغ است، چرا که در صورت عمومی در نظر گرفتن این قوانین ممکن است بسیاری از ایمیل‌های معتبر و قانونی را از دست بدهیم. در این موارد، نه تنها پیام‌ها از دست می‌روند، بلکه برای فرستندگان آنان نیز پیام‌های خطای آزاردهنده ارسال می‌گردد.</para>
      </section>
    </section>
    <section id="sect.setting-up-greylisting">
      <title>برپایی <foreignphrase>فهرست خاکستری</foreignphrase></title>
      <indexterm><primary>فهرست خاکستری</primary></indexterm>

      <para>"فهرست خاکستری" یک تکنیک فیلترکردن است به طوری که در ابتدا پیام به صورت موقت رد می‌شود و در صورت گذشت یک بازه زمانی و تلاش مجدد، مورد پذیرش قرار می‌گیرد. این تکنیک اغلب در مورد رایانه‌هایی که توسط کرم‌ها و ویروس‌ها آلوده شده‌اند به خوبی جواب می‌دهد، چرا که این گونه نرم‌افزارها به ندرت به عنوان یک برنامه کامل SMTP عمل می‌کنند (با بررسی کد خطا و تلاش مجدد برای ارسال پیام در زمان دیگر)، به خصوص که بسیاری از نشانی‌های برداشت شده برای اینکار در حقیقت نامعتبر هستند و تلاش مجدد برای ارسال فقط به معنی اتلاف زمان است.</para>

      <para>Postfix به خودی خود شامل فهرست خاکستری نیست، اما گزینه‌ای وجود دارد که تصمیم‌گیری برای پذیرش یا رد یک پیام را می‌توان به یک برنامه خارجی سپرد. بسته <emphasis role="pkg">postgrey</emphasis> شامل همین عملکرد است، که به منظور سیاست دسترسی به عنوان سرویس نماینده طراحی شده است.</para>

      <para>زمانی که <emphasis role="pkg">postgrey</emphasis> نصب شود، به عنوان یک فرآیند پس‌زمینه به درگاه ۱۰۰۲۳ گوش می‌کند. سپس می‌توان با تنظیم پارامتر <literal>check_policy_service</literal> در Postfix، آن را به این منظور پیکربندی کرد:</para>

      <programlisting>
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023</programlisting>

      <para>هر زمان که Postfix به این قانون می‌رسد، به فرآیند پس‌زمینه <command>postgrey</command> متصل شده و اطلاعات مرتبط با پیام را به آن ارسال می‌کند. Postgrey در سمت خود، سه‌گانه نشانی IP/فرستنده/گیرنده را برای وجود در پایگاه‌داده خود مورد بررسی قرار می‌دهد. اگر وجود داشت، Postgrey اطلاع می‌دهد که پیام باید پذیرفته شود؛ در غیر اینصورت، پاسخی که نشان‌دهنده رد موقتی پیام است به همراه سه‌گانه مذکور در پایگاه‌داده خود ذخیره‌سازی می‌کند.</para>

      <para>اشکال اصلی فهرست خاکستری این است که پیام‌های قانونی با تاخیر مواجه می‌شوند، که برای همیشه قابل قبول نیست. همچنین بار سرورهایی که بسیاری ایمیل‌های قانونی را ارسال می‌کنند، افزایش می‌‌دهد.</para>

      <sidebar>
        <title><emphasis>در عمل</emphasis> نقطه ضعف فهرست خاکستری</title>

	<para>به لحاظ نظری، فهرست خاکستری تنها باید اولین پیام ارسالی از یک فرستنده به گیرنده را با تاخیر همراه سازد، که این تاخیر در حد چند دقیقه است. اما حقیقت چیزی دیگری است. برخی شرکت‌های بزرگ ارائه‌دهنده خدمات اینترنت، خوشه‌ای از سرورهای SMTP را استفاده می‌کنند و زمانی که یک پیام در ابتدا رد می‌شود، سروری که به این کد خطا پاسخ می‌دهد الزاما با سروری که پیام اولیه را فرستاده است، یکسان نیست. زمانی که این اتفاق می‌افتد، سرور دوم نیز این پیام خطای موقت را دریافت می‌کند و به همین ترتیب؛ ممکن است چندین ساعت طول بکشد تا همان سرور اولیه به مسیر تبادل پیام بازگردد، چرا که سرورهای SMTP با هر بار مواجه پیام خطا، زمان ارسال مجدد آن را افزایش می‌دهند.</para>

	<para>به عنوان یک پیامد، نشانی IP دریافتی حتی برای یک فرستنده نیز می‌تواند در طول زمان تغییر کند. اما مشکل دیگری نیز وجود دارد: حتی نشانی فرستنده نیز می‌تواند تغییر کند. برای نمونه، بسیاری سروهای میلینگ-لیست به منظور تعامل با پیام‌های خطا اقدام به رمزگذاری اطلاعات اضافی در قسمت نشانی فرستنده می‌کنند (که به عنوان <emphasis>bounces</emphasis> شناخته می‌شود). هر پیام جدید که به میلینگ-لیست ارسال می‌شود نیاز به عبور از فهرست خاکستری را دارد، که به معنی ذخیره‌سازی (موقت) آن در سرور فرستنده است. برای میلینگ‌-لیست‌های بسیار بزرگ (با ده‌ها هزار مشترک) این امر به زودی مشکل بزرگی می‌شود.</para>

	<para>برای مقابله با این مشکلات، Postgrey فهرست سفیدی از چنین سایت‌هایی را مدیریت می‌کند و پیام‌هایی که از آن‌ها ارسال شود را بدون عبور از فهرست خاکستری مورد پذیرش قرار می‌دهد. این فهرست به سادگی می‌تواند برای نیازهای شبکه محلی سازگار شود، چرا که در فایل <filename>/etc/postgrey/whitelist_clients</filename> قرار گرفته است.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>مطالعه بیشتر</emphasis> فهرست خاکستری انتخابی با استفاده از <emphasis role="pkg">milter-greylist</emphasis></title>

	<para>اشکالات موجود در فهرست خاکستری می‌تواند با اعمال آن‌ها بر مجموعه‌ای از رایانه‌ها که منبع احتمالی اسپم هستند، رفع گردد (چرا که آن‌ها در یک فهرست سیاه DNS قرار می‌گیرند). اینکار با استفاده از <emphasis role="pkg">postgrey</emphasis> ممکن نیست اما از <emphasis role="pkg">milter-greylist</emphasis> برای چنین مواقعی استفاده می‌گردد.</para>

	<para>در این سناریو، از آنجا که فهرست‌های سیاه DNS منجر به رد قعطی یک پیام نمی‌شود، استفاده از فهرست‌های سیاه تهاجمی منطقی به نظر می‌رسد، از جمله آن‌هایی که نشانی‌های IP پویا رایانه‌های ISP را شامل می‌شوند (از جمله <literal>pbl.spamhaus.org</literal> یا <literal>dul.dnsbl.sorbs.net</literal>).</para>

	<para>از آنجا که milter-greylist از رابط milter در Sendmail استفاده می‌کند، پیکربندی قسمت postfix آن محدود است به “<literal>smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</literal>”. صفحه راهنمای <citerefentry><refentrytitle>greylist.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> به مستندسازی <filename>/etc/milter-greylist/greylist.conf</filename> و راه‌های مختلف برای پیکربندی <filename>/etc/default/milter-greylist</filename> می‌پردازد. برای فعال‌سازی این سرویس همچنین باید ... را ویرایش کنید.</para>
      </sidebar>
    </section>
    <section>
      <title>سفارشی‌سازی فیلترها مبتنی بر گیرنده</title>

      <para>قسمت‌های <xref linkend="sect.restrictions-for-receiving-and-sending" /> و <xref linkend="sect.setting-up-greylisting" /> بسیاری محدودیت‌های ممکن را بررسی کرده‌اند. همگی آن‌ها کاربرد خود برای محدودکردن بخشی از اسپم‌ها را دارند اما شامل نواقصی نیز هستند. بنابراین بسیار متداول است که مجموعه فیلترهای بکار رفته روی گیرنده را سفارشی‌سازی کرد. در شرکت فالکوت، استفاده از فهرست خاکستری در کار اغلب کاربران مشکلی بوجود نمی‌آورد اما برخی نیز نیاز به تاخیر بسیار کمی در کار خود دارند (از جمله واحد پشتیبانی فنی). به همین شکل، واحد تجاری گاهی اوقات مشکلاتی با برخی مشتریان آسیایی دارد که در فهرست سیاه قرار گرفته‌اند؛ این واحد درخواست یک نشانی بدون فیلتر به منظور مکاتبه با آن‌ها را دارد.</para>

      <para>Postfix با استفاده از مفهوم “کلاس محدودیت” امکان سفارشی‌سازی فیلترها را فراهم می‌کند. کلاس‌ها در پارامتر <literal>smtpd_restriction_classes</literal> قرار گرفته و به شیوه مشابه <literal>smtpd_recipient_restrictions</literal> تعریف شده‌اند. عبارت <literal>check_recipient_access</literal> نگاشتی بین یک گیرنده و مجموعه‌ای از محدودیت‌های آن برقرار می‌کند.</para>

      <example>
        <title>تعریف کلاس‌های محدودیت در <filename>main.cf</filename></title>

        <programlisting>smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access</programlisting>
      </example>

      <example>
        <title>فایل <filename>/etc/postfix/recipient_access</filename></title>

        <programlisting>
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting</programlisting>
      </example>
    </section>
    <section id="sect.postfix-antivirus">
      <title>یکپارچه‌سازی آنتی‌ویروس</title>
      <indexterm><primary>آنتی‌ویروس</primary></indexterm>

      <para>طیف گسترده ویروس‌هایی که به عنوان فایل ضمیمه در ایمیل‌ها قرار می‌گیرند نیاز به استفاده از یک آنتی‌ویروس در نقطه ابتدایی شبکه شرکت را با اهمیت می‌سازد، چرا که با وجود آگاهی‌رسانی‌های بسیار، هنوز برخی کاربران اقدام به باز کردن فایل‌های ضمیمه پیام‌های ناخواسته می‌کنند.</para>

      <para>مدیرسیستم‌های فالکوت <command>clamav</command> را به عنوان آنتی‌ویروس آزاد خود انتخاب کرده‌اند. بسته اصلی <emphasis role="pkg">clamav</emphasis> نام دارد، اما آن‌ها اقدام به نصب بسته‌های اضافی از جمله <emphasis role="pkg">arj</emphasis>، <emphasis role="pkg">unzoo</emphasis>، <emphasis role="pkg">unrar</emphasis> و <emphasis role="pkg">lha</emphasis> نیز کرده‌اند چرا که استفاده از این بسته‌ها به منظور بررسی محتوای فایل‌های ضمیمه با قالب‌های مختلف مورد نیاز است.</para>
      <indexterm><primary><command>clamav</command></primary></indexterm>
      <indexterm><primary><command>clamav-milter</command></primary></indexterm>

      <para>وظیفه برقراری ارتباط بین آنتی‌ویروس و سرور ایمیل بر عهده <command>clamav-milter</command> است. یک <emphasis>milter</emphasis> (که مخفف <emphasis>mail filter</emphasis> است) یک برنامه فیلترکردن بخصوص است که برای تعامل با سرورهای ایمیل طراحی شده است. یک milter از یک رابط استاندارد برنامه‌نویسی یا API استفاده می‌کند که عملکرد بهتری در مقایسه با فیلترهای خارجی برای سرورهای ایمیل فراهم می‌کند. milterها در ابتدا توسط <emphasis>Sendmail</emphasis> معرفی شدند اما <emphasis>Postfix</emphasis> به زودی از آن‌ها پشتیبانی کرد.</para>

      <sidebar>
        <title><emphasis>نگاه سریع</emphasis> فیلتر ایمیل برای Spamassassin</title>
        <indexterm><primary><emphasis role="pkg">spamass-milter</emphasis></primary></indexterm>

	<para>بسته <emphasis role="pkg">spamass-milter</emphasis> فیلتر ایمیلی مبتنی بر <emphasis>SpamAssassin</emphasis> فراهم می‌کند، برنامه معروف شناسایی ایمیل ناخواسته. می‌تواند برای پرچم‌گذاری پیام‌ها به عنوان اسپم احتمالی استفاده شود (با افزودن یک سرآیند اضافی) و/یا رد پیام‌هایی که امتیاز “spamminess” آن‌ها بیش از محدوده استاندارد باشد.</para>
      </sidebar>

      <para>زمانی که بسته <emphasis role="pkg">clamav-milter</emphasis> نصب شود، فیلتر ایمیل باید به گونه‌ای پیکربندی شود که روی یک درگاه TCP جدا از مقدار پیشفرض سوکت نامگذاری شده قرار بگیرد. اینکار با استفاده از <command>dpkg-reconfigure clamav-milter</command> صورت می‌گیرد. زمانی که پرسش “Communication interface with Sendmail” مطرح می‌شود، “<literal>inet:10002@127.0.0.1</literal>” را پاسخ دهید.</para>

      <sidebar>
        <title><emphasis>یادداشت</emphasis> درگاه واقعی TCP در مقایسه با سوکت نامگذاری شده</title>
	<para>دلیلی که از درگاه واقعی TCP بجای سوکت نامگذاری شده استفاده می‌کنیم این است که فرآیندهای پس‌زمینه postfix اغلب به صورت chroot شده اجرا می‌گردند که در این حالت به دایرکتوری قرار گرفته در سوکت نامگذاری شده دسترسی ندارند. همچنین می‌توانید تصمیم بگیرید که هنگام استفاده از سوکت نامگذاری شده از یک محل درون chroot (<filename>/var/spool/postfix/</filename>) استفاده کنید.</para>
      </sidebar>

      <para>پیکربندی استاندارد ClamAV برای اکثر موقعیت‌های مناسب است، اما برخی پارامترهای مهم هنوز می‌توانند با استفاده از دستور <command>dpkg-reconfigure clamav-base</command> سفارشی گردند.</para>

      <para>گام آخر اطلاع‌رسانی به Postfix درباره فیلتر تازه-پیکربندی شده است که به سادگی افزودن عبارت زیر به <filename>/etc/postfix/main.cf</filename> است:</para>

      <programlisting>
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002</programlisting>

      <para>اگر آنتی‌ویروس مشکلاتی را بوجود آورد، می‌توان این خط را حذف و با اجرای دستور <command>service postfix reload</command> تغییرات اعمال شده را تنظیم کرد.</para>

      <sidebar>
        <title><emphasis>در عمل</emphasis> آزمایش آنتی‌ویروس</title>

	<para>زمانی که آنتی‌ویروس برپا شود، عملکرد صحیح آن باید مورد آزمایش قرار گیرد. ساده‌ترین راه برای اینکار ارسال یک ایمیل همراه با فایل ضمیمه <filename>eicar.com</filename> (یا <filename>eicar.com.zip</filename>) است، که می‌تواند به صورت آنلاین نیز دانلود شود: <ulink type="block" url="http://www.eicar.org/86-0-Intended-use.html" /></para>

	<para>این فایل یک ویروس واقعی نیست، بلکه به عنوان فایل آزمایشی توسط تمام آنتی‌ویروس‌های موجود در بازار به منظور آزمایش عملکرد صحیح برنامه مورد استفاده قرار می‌گیرد.</para>
      </sidebar>

      <para>اکنون تمام پیام‌های ارسالی به Postfix از طریق فیلتر آنتی‌ویروس عبور داده می‌شوند.</para>
    </section>
    <section id="sect.authenticated-smtp">
      <title>SMTP احرازهویت شده</title>

      <para>به منظور امکان ارسال ایمیل ابتدا باید به سرور SMTP دسترسی داشت؛ همچنین نیازمند سرور SMTP گفته شده به منظور ارسال ایمیل از درون خود است. برای کاربران رومینگ، اینکار نیازمند تغییر مداوم پیکربندی برنامه SMTP است چرا که سرور SMTP فالکوت پیام‌هایی را که نشانی‌های IP خارج از شرکت را داشته باشند رد می‌کند. دو راه حل موجود است: یا کاربر رومینگ سرور SMTP را روی رایانه خود نصب کند یا کماکان به شیوه‌ای از سرور شرکت استفاده کنند که به عنوان یک کارمند احرازهویت شوند. راه اول توصیه نمی‌شود چرا که رایانه ممکن است همیشه متصل نباشد و در صورت بروز مشکل امکان ارسال مجدد پیام وجود نخواهد داشت؛ ما روی راه حل دوم تمرکز می‌کنیم.</para>

      <para>احرازهویت SMTP در Postfix نیازمند SASL یا <emphasis>Simple Authentication and Security Layer</emphasis> است. اینکار نیازمند نصب بسته‌های <emphasis role="pkg">libsasl2-modules</emphasis> و <emphasis role="pkg">sasl2-bin</emphasis>، سپس ثبت گذرواژه در پایگاه‌داده SASL برای هر کاربری که نیازمند احرازهویت با استفاده از سرور SMTP است. اینکار با استفاده از دستور <command>saslpasswd2</command> انجام می‌شود که چندین پارامتر را دریافت می‌کند. گزینه <literal>-u</literal> دامنه احرازهویت را تعریف می‌کند که باید با پارامتر <literal>smtpd_sasl_local_domain</literal> در پیکربندی Postfix یکسان باشد. گزینه <literal>-c</literal> اجازه تعریف یک کاربر جدید و <literal>-f</literal> اجازه تعریف فایل پیکربندی آن را می‌دهد در صورتی که نیاز باشد پایگاه‌داده SASL در مسیر دیگری بجز <filename>/etc/sasldb2</filename> قرار بگیرد.</para>

      <screen role="scale">
<computeroutput># </computeroutput><userinput>saslpasswd2 -u `postconf -h myhostname` -f /var/spool/postfix/etc/sasldb2 -c jean</userinput>
<computeroutput>[... type jean's password twice ...]</computeroutput></screen>

      <para>نکته اینکه پایگاه‌داده SASL در دایرکتوی Postfix ایجاده شده است. به منظور حصوص اطمینان از یکپارچگی، فایل <filename>/etc/sasldb2</filename> را با دستور <command>ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</command> به یک پیوند نمادین پایگاه‌داده مورد استفاده Postfix تبدیل کرده‌ایم. </para>

      <para>اکنون نیازمند پیکربندی Postfix برای استفاده از SALS هستیم. ابتدا کاربر <literal>postfix</literal> باید به گروه <literal>sasl</literal> اضافه گردد تا بتواند به پایگاه‌داده SASL دسترسی داشته باشد. برای فعال‌سازی SASL به چندین پارامتر دیگر نیاز است و پارامتر <literal>smtpd_recipient_restrictions</literal> نیز به منظور اجازه به برنامه‌های احرازهویت شده با SASL برای ارسال ایمیل، مورد نیاز است.</para>

      <example>
        <title>فعال‌سازی SASL در <filename>/etc/postfix/main.cf</filename></title>

        <programlisting>
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]</programlisting>
      </example>

      <sidebar>
        <title><emphasis>اضافی</emphasis> برنامه SMTP احرازهویت شده</title>

	<para>اکثر برنامه‌های ایمیل قبل از ارسال پیام‌های خارجی، قادر به احزارهویت توسط سرور SMTP هستند که استفاده از این ویژگی به سادگی پیکربندی چند پارامتر متناسب با آن است. اگر برنامه مورد نظر چنین قابلیتی نداشته باشد، راهکار پیشنهادی استفاده از یک سرور Postfix محلی به منظور ارسال مجدد ایمیل از طریق سرور SMTP راه‌دور است. در این مورد، خود Postfix محلی برنامه‌ای است که با SASL احرازهویت می‌شود. پارامترهای مورد نیاز عبارتند از:</para>

        <programlisting>
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]</programlisting>

	<para>فایل <filename>/etc/postfix/sasl_passwd</filename> باید شامل نام کاربری و گذرواژه مورد نیاز برای احرازهویت در سرور <literal>mail.falcot.com</literal> است. برای نمونه:</para>

        <programlisting>
[mail.falcot.com]   joe:LyinIsji</programlisting>

	<para>مانند تمام نگاشت‌های Postfix، نیاز است که این فایل توسط دستور <command>postmap</command> به <filename>/etc/postfix/sasl_passwd.db</filename> تبدیل شود.</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.http-web-server">
    <title>سرور وب (HTTP)</title>

    <para>مدیرسیستم‌های شرکت فالکوت تصمیم گرفته‌اند که از سرور وب آپاچی، که در دبیان <emphasis role="distribution">Jessie</emphasis> با نسخه ۲.۴.۱۰ قرار دارد، استفاده کنند.</para>
    <indexterm><primary><command>apache</command></primary></indexterm>
    <indexterm><primary>سرور</primary><secondary>وب</secondary></indexterm>
    <indexterm><primary>سرور وب</primary></indexterm>
    <indexterm><primary>سرور</primary><secondary>HTTP</secondary></indexterm>
    <indexterm><primary>HTTP</primary><secondary>سرور</secondary></indexterm>

    <sidebar>
      <title><emphasis>جایگزین</emphasis> سایر سرورهای وب</title>

      <para>آپاچی تقریبا شناخته شده‌ترین (و پرکاربردترین) سرور وب موجود است، اما گزینه‌های دیگری نیز وجود دارد؛ آن‌ها می‌توانند تحت شرایط خاص عملکرد بهتری داشته باشند اما با در نظر گرفتن ویژگی‌های و افزونه‌های کمتر نسبت به آپاچی. با این حال، زمانی که از سرور وب برای میزبانی فایل‌های ایستا یا کاربرد به عنوان یک پروکسی استفاده گردد، گزینه‌های جایگزین مانند <emphasis role="pkg">nginx</emphasis> و <emphasis role="pkg">lighttpd</emphasis> قابل توجه هستند.</para>
      <indexterm><primary><emphasis role="pkg">nginx</emphasis></primary></indexterm>
      <indexterm><primary><emphasis role="pkg">lighttpd</emphasis></primary></indexterm>
    </sidebar>
    <section>
      <title>نصب آپاچی</title>

      <para>نصب بسته <emphasis role="pkg">apache2</emphasis> شامل تمام ویژگی‌های مورد نظر است. این بسته شامل تمام افزونه‌ها، از جمله <emphasis>Multi-Processing Modules</emphasis> یا MPM است که در شیوه تصمیم‌گیری آپاچی برای پردازش موازی درخواست‌های دریافتی تاثیر می‌گذارد (آن‌هایی که سابق بر این در بسته‌های <emphasis role="pkg">apache2-mpm-*</emphasis> فراهم می‌شدند). این بسته همچنین اقدام به نصب <emphasis role="pkg">apache2-utils</emphasis> می‌کند که شامل ابزارهای خط فرمان است، در مورد آن‌ها صحبت خواهیم کرد.</para>

      <para>استفاده از MPM تاثیر بسزایی در عملکرد آپاچی برای مدیریت درخواست‌های هم‌زمان دارد. با افزونه‌های چند-پردازشی <emphasis>worker</emphasis> از <emphasis>threads</emphasis> (فرآیندهای سبک) و افزونه‌های چند-پردازشی <emphasis>prefork</emphasis> از مجموعه فرآیندهای گردآوری شده از قبل استفاده می‌کند. با افزونه‌های چند-پردازشی <emphasis>event</emphasis> همچنین از threads استفاده می‌کند، اما ارتباطات غیرفعال (آن‌هایی که توسط ویژگی <emphasis>keep-alive</emphasis> در HTTP باز نگه داشته شده‌اند) به یک thread مدیریتی انحصاری بازگردانده می‌شوند.</para>

      <para>مدیرسیستم‌های فالکوت همچنین بسته <emphasis role="pkg">libapache2-mod-php5</emphasis> را نصب کرده‌اند تا پشتیبانی PHP در آپاچی فعال گردد. این عمل منجر به غیرفعال شدن افزونه‌های چند-پردازشی <emphasis>event</emphasis> می‌گردد و <emphasis>prefork</emphasis> جایگزین آن می‌شود چرا که PHP تنها در این حالت می‌تواند با آپاچی کار کند.</para>

      <sidebar>
        <title><emphasis>امنیت</emphasis> اجرا به عنوان کاربر <literal>www-data</literal></title>
        <indexterm><primary><literal>www-data</literal></primary></indexterm>
        <indexterm><primary>suexec</primary></indexterm>

	<para>به صورت پیشفرض، آپاچی درخواست‌های دریافتی را با استفاده از کاربر <literal>www-data</literal> مدیریت می‌کند. به این معنی که در صورت بروز یک آسیب‌پذیری امنیتی در یک اسکریپت CGI اجرا شده توسط آپاچی (برای یک صفحه پویا) کل سیستم به خطر نمی‌افتد، بلکه تنهای فایل‌های مرتبط با این کاربر خاص.</para>

	<para>استفاده از افزونه‌های <emphasis>suexec</emphasis> اجازه دور زدن این قانون را می‌دهد به طوری که برخی اسکریپت‌های CGI بتوانند به عنوان کاربر دیگری اجرا شوند. اینکار با استفاده از عبارت <literal>SuexecUserGroup <replaceable>user</replaceable><replaceable>group</replaceable></literal> در پیکربندی آپاچی صورت می‌گیرد.</para>
        <indexterm><primary><emphasis role="pkg">libapache2-mpm-itk</emphasis></primary></indexterm>

	<para>حالت دیگر استفاده از یک افزونه چند-پردازشی اختصاصی است که توسط <emphasis role="pkg">libapache2-mpm-itk</emphasis> فراهم می‌شود. این افزونه بخصوص عملکرد متفاوتی دارد: امکان “ایزوله‌کردن” گروه‌های مجازی (در حقیقت مجموعه‌ای از صفحات) را می‌دهد به گونه‌ای که هر کدام به عنوان کاربر جداگانه‌ای اجرا شوند. یک آسیب‌پذیری در یک وبسایت منجر نمی‌شود که فایل‌های مرتبط با وبسایت دیگر به خطر بیفتد.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>نگاه سریع</emphasis> فهرستی از افزونه‌ها</title>

	<para>فهرست کامل افزونه‌های استاندارد آپاچی می‌تواند به صورت آنلاین پیدا شود. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/index.html" /></para>
      </sidebar>

      <para>آپاچی یک سرور ماژولار است و بسیاری ویژگی‌های آن با استفاده از افزونه‌های خارجی که برنامه اصلی هنگام فرآیند راه‌اندازی اولیه فراخوانی می‌کند، پیاده‌سازی شده است. پیکربندی پیشفرض تنها متداول‌ترین افزونه‌ها را فعال می‌سازد، اما فعال‌سازی یک افزونه جدید به سادگی اجرای دستور <command>a2enmod <replaceable>module</replaceable></command> است؛ برای غیرفعال‌سازی یک افزونه، دستور <command>a2dismod <replaceable>module</replaceable></command> استفاده می‌شود. این برنامه‌ها در حقیقت اقدام به ایجاد (یا حذف) پیوندهای نمادین از <filename>/etc/apache2/mods-enabled/</filename> به فایل‌های واقعی موجود در <filename>/etc/apache2/mods-available/</filename> می‌کنند.</para>

      <para>با پیکربندی پیشفرض خود، سرور وب به درگاه ۸۰ گوش داده (پیکربندی شده در <filename>/etc/apache2/ports.conf</filename>) و صفحات موجود در دایرکتوری <filename>/var/www/html/</filename> را فراهم می‌کند (پیکربندی شده در <filename>/etc/apache2/sites-enabled/000-default.conf</filename>).</para>

      <sidebar>
        <title><emphasis>مطالعه بیشتر</emphasis> افزودن پشتیبانی برای SSL</title>
        <indexterm><primary>HTTPS</primary></indexterm>
        <indexterm><primary>HTTP</primary><secondary>ایمن</secondary></indexterm>

	<para>آپاچی ۲.۴ شامل افزونه SSL مورد نیاز HTTP ایمن یا HTTPS است. تنها کافی است با دستور <command>a2enmod ssl</command> فعال‌سازی شده و عبارت‌های مورد نیاز آن در فایل‌های پیکربندی قرار بگیرند. یک نمونه پیکربندی در فایل <filename>/etc/apache2/sites-available/default-ssl.conf</filename> قرار دارد. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html" /></para>

	<para>اگر قصد استفاده از <emphasis>Perfect Forward Secrecy</emphasis> همراه با ارتباطات SSL را دارید مراقبت‌های بیشتری باید صورت پذیرد (این ارتباطات از کلیدهای نشست موقتی استفاده می‌کنند به طوری که لو رفتن کلید خصوصی سرور منجر به لو رفتن ترافیک رمزگذاری شده از قدیم نشود که می‌توانست هنگام گوش کردن به شبکه در جایی ذخیره شده باشد). نگاهی به توصیه‌های موزیلا در این مورد خاص بیندازید: <ulink type="block" url="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache" /></para>
	<indexterm><primary><emphasis>Perfect Forward Secrecy</emphasis></primary></indexterm>
      </sidebar>
    </section>
    <section>
      <title>پیکربندی گروه‌های مجازی</title>

      <para>یک گروه مجازی مانند یک شناسه جدید برای سرور وب است.</para>
      <indexterm><primary>گروه مجازی</primary></indexterm>

      <para>آپاچی دو نوع متفاوت از گروه مجازی را در نظر می‌گیرد: آن‌هایی که مبتنی بر نشانی IP (یا درگاه) و آن‌هایی که مبتنی بر نام دامنه سرور وب هستند. روش اول نیازمند اختصاص یک نشانی IP (یا درگاه) به هر سایت است در صورتی که روش دوم می‌تواند با یک نشانی IP (یا درگاه) کار کند و سایت‌ها با توجه به نام میزبان که توسط برنامه HTTP ارسال می‌شود، تشخیص داده می‌شوند (که تنها در نسخه ۱.۱ از پروتکل HTTP کار می‌کند - خوشبختانه این نسخه به قدری قدیمی است که تقریبا تمام برنامه‌ها از آن استفاده می‌کنند).</para>

      <para>کمبود (رو به افزایش) نشانی‌های IPv4 معمولا منجر به استفاده از شیوه دوم می‌گردد؛ اگرچه، در صورت استفاده گروه‌های مجازی از HTTP، این فرآیند دشوارتر نیز می‌گردد، چرا که پروتکل SSL تا اکنون پشتیبانی از گروه مجازی نام-محور را فراهم نکرده است؛ افزونه <emphasis>Server Name Indication</emphasis> یا SNI که امکان چنین ترکیبی را می‌دهد توسط تمام مرورگرها پشتیبانی نمی‌شود. زمانی که نیاز به اجرای چندین سایت HTTPS روی یک سرور باشد، آن‌ها معمولا با اجرا روی یک درگاه جداگانه یا یک نشانی IP جداگانه (که IPv6 می‌تواند کمک کند) تشخیص داده می‌شوند.</para>

      <para>پیکربندی پیشفرض آپاچی ۲ منجر به فعال‌سازی گروه‌های مجازی نام-محور می‌گردد. به علاوه، یک گروه مجازی پیشفرض در فایل <literal>/etc/apache2/sites-enabled/000-default.conf</literal> قرار دارد: از این گروه مجازی در صورتی که هیچ گروه دیگری متناسب با درخواست پیدا نشود استفاده می‌گردد.</para>

      <sidebar>
        <title><emphasis>احتیاط</emphasis> اولین گروه مجازی</title>

	<para>درخواست‌هایی که به گروه‌های مجازی ناشناخته می‌شود همیشه توسط اولین گروه مجازی تعریف شده مدیریت می‌گردند، به همین دلیل است که ابتدا گروه مجازی <literal>www.falcot.com</literal> را تعریف کردیم.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>نگاه سریع</emphasis> آپاچی از SNI پشتبانی می‌کند</title>
        <indexterm><primary>Server Name Indication</primary></indexterm>

	<para>سرور آپاچی از یک افزونه پروتکل SSL بنام <emphasis>Server Name Indication</emphasis> یا SNI پشتیبانی می‌کند. این افزونه به مرورگر اجازه می‌دهد هنگام برقراری ارتباط SSL نام میزبان سرور وب را ارسال کند، درست قبل از خود درخواست HTTP، که سابق بر این برای تشخیص گروه مجازی درخواستی از میان میزبان‌های موجود در همان سرور استفاده می‌شد (با نشانی IP و درگاه یکسان). اینکار به آپاچی اجازه می‌دهد تا مناسب‌ترین گواهینامه SSL را برای تراکنش پیش روی خود انتخاب کند.</para>

	<para>قبل از SNI، آپاچی از گواهینامه تعریف شده در گروه مجازی پیشفرض استفاده می‌کرد. برنامه‌هایی که قصد دسترسی به گروه مجازی دیگری را داشتند، با اخطار رو به رو می‌شدند چرا که گواهینامه‌های دریافتی آنان با وبسایتی که قصد دسترسی آن را داشتند تطابق نداشت. خوشبختانه، اکنون اکثر مرورگرها با SNI کار می‌کنند؛ از جمله مایکروسافت اینترنت اکسپلورر از نسخه ۷.۰ (شروع در ویستا)، موزیلا فایرفاکس از نسخه ۲.۰، اپل سافاری از نسخه ۳.۲.۱ و تمام نسخه‌های گوگل کروم.</para>

	<para>بسته آپاچی که در دبیان قرار دارد همراه با پشتیبانی SNI ساخته شده است؛ بنابراین پیکربندی خاصی مورد نیاز نیست.</para>

	<para>هنگام پیکربندی اولین گروه مجازی (که به صورت پیشفرض استفاده می‌شود) برای اطمینان از فعال‌سازی TLSv1 باید دقت عمل به خرج داد، چرا که آپاچی از پارامترهای این اولین گروه مجازی به منظور برقراری ارتباط‌های ایمن استفاده می‌کند و بهتر است که این اجازه صادر شده باشد!</para>
      </sidebar>

      <para>هر گروه مجازی اضافی درون فایل جداگانه‌ای در مسیر <filename>/etc/apache2/sites-available/</filename> قرار می‌گیرد. برپایی یک وبسایت برای دامنه <literal>falcot.org</literal> به سادگی ایجاد فایل پیکربندی آن و فعال‌سازی گروه مجازی با استفاده از <command>a2ensite www.falcot.org</command> است.</para>

      <example>
        <title>فایل <filename>/etc/apache2/sites-available/www.falcot.org.conf</filename></title>

        <programlisting>
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</programlisting>
      </example>

      <para>سرور آپاچی که تاکنون پیکربندی شده است، از فایل‌های گزارش یکسانی برای تمام گروه‌های مجازی استفاده می‌کند (اگرچه این عمل می‌تواند با افزودن عبارت <literal>CustomLog</literal> در تعریف هر گروه مجازی تغییر کند). پس منطقی به نظر می‌رسد به منظور درج نام گروه مجازی در گزارش‌ها، اقدام به سفارشی‌سازی قالب آن کرد. اینکار با استفاده از ایجاد یک فایل <filename>/etc/apache2/conf-available/customlog.conf</filename> انجام می‌شود که قالب جدیدی برای تمام فایل‌های گزارش تعریف می‌کند (با عبارت <literal>LogFormat</literal>) و فعال‌سازی آن با استفاده از <command>a2enconf customlog</command> خط <literal>CustomLog</literal> باید از فایل <filename>/etc/apache2/sites-available/000-default.conf</filename> حذف (یا مخفی) شود.</para>

      <example>
        <title>فایل <filename>/etc/apache2/conf.d/customlog.conf</filename></title>

        <programlisting role="scale">
# New log format including (virtual) host name
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Now let's use this "vhost" format by default
CustomLog /var/log/apache2/access.log vhost</programlisting>
      </example>
    </section>
    <section>
      <title>عبارت‌های متداول</title>

      <para>این قسمت به بررسی برخی از متداول‌ترین عبارت‌های پیکربندی در آپاچی می‌پردازد.</para>
      <indexterm><primary>عبارت‌های آپاچی</primary></indexterm>
      <indexterm><primary>عبارت‌ها، آپاچی</primary></indexterm>

      <para>فایل پیکربندی اصلی معمولا شامل چندین بلاک <literal>Directory</literal> است؛ آن‌ها اجازه تعریف عملکردهای متفاوت برای سرور نسبت به محل قرارگیری فایل‌های ارائه شده را می‌دهند. چنین بلاکی معمولا شامل عبارت‌های <literal>Options</literal> و <literal>AllowOverride</literal> است.</para>
      <indexterm><primary><literal>Options</literal>، عبارت آپاچی</primary></indexterm>
      <indexterm><primary><literal>AllowOverride</literal>، عبارت آپاچی</primary></indexterm>

      <example>
        <title>بلاک Directory</title>

        <programlisting>
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;</programlisting>
      </example>

      <para>عبارت <literal>DirectoryIndex</literal> شامل فهرستی از فایل‌ها است که هنگام درخواست برنامه به سرور بررسی می‌شوند. اولین فایل موجود در فهرست استفاده شده و به عنوان پاسخ فرستاده می‌شود.</para>
      <indexterm><primary><literal>DirectoryIndex</literal>، عبارت آپاچی</primary></indexterm>

      <para>عبارت <literal>Options</literal> به همراه فهرستی از گزینه‌های قابل فعال‌سازی می‌آید. مقدار <literal>None</literal> تمام گزینه‌ها را غیرفعال می‌کند؛ به همین شکل <literal>All</literal> همه را فعال‌سازی می‌کند بجز <literal>MultiViews</literal>. گزینه‌های موجود عبارتند از:</para>
      <itemizedlist>
        <listitem>
	  <para><literal>ExecCGI</literal> نشان می‌دهد که اسکریپت‌های CGI می‌توانند اجرا شوند. <indexterm><primary><literal>ExecCGI</literal>، عبارت آپاچی</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>FollowSymlinks</literal> به سرور می‌گوید که می‌توان از پیوندهای نمادین استفاده کرد، و برای آن‌ها پاسخ باید شامل محتوای اصلی فایل باشد. <indexterm><primary><literal>FollowSymlinks</literal>، عبارت آپاچی</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>SymlinksIfOwnerMatch</literal> نیز به سرور می‌گوید که می‌توان از پیوندهای نمادین استفاده کرد اما تنها زمانی که پیوند و هدف آن به یک کاربر متعلق باشند. <indexterm><primary><literal>SymlinksIfOwnerMatch</literal>، عبارت آپاچی</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>Includes</literal> منجر به فعال‌سازی <emphasis>Server Side Includes</emphasis> یا <emphasis>SSI</emphasis> می‌شود. این‌ها عبارت‌هایی هستند که درون صفحات HTML قرار دارند و برای هر درخواست به صورت جداگانه اجرا می‌شوند. <indexterm><primary><literal>Includes</literal>، عبارت آپاچی</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>Indexes</literal> به سرور می‌گوید که محتوای یک دایرکتوری را به صورت فهرست‌وار نمایش دهد اگر درخواست HTTP ارسال شده توسط برنامه به یک دایرکتوری بدون فایل اندیس اشاره کند (زمانی که هیچ فایلی توسط عبارت <literal>DirectoryIndex</literal> در دایرکتوری موجود نباشد). <indexterm><primary><literal>Indexes</literal>, Apache directive</primary></indexterm></para>
        </listitem>
        <listitem>
	  <para><literal>MultiViews</literal> قابلیت تعامل محتوایی را فعال‌سازی می‌کند؛ این قابلیت می‌تواند توسط سرور به منظور ارسال صفحه‌ای به زبان تنظیم شده از طرف مرورگر مورد استفاده قرار گیرد. <indexterm><primary><literal>MultiViews</literal>, Apache directive</primary></indexterm></para>
        </listitem>
      </itemizedlist>

      <para></para>

      <sidebar>
        <title><emphasis>بازگشت به مقدمات</emphasis> فایل <filename>.htaccess</filename></title>

	<para>فایل <filename>.htaccess</filename> شامل عبارت‌های پیکربندی آپاچی است که با هر مرتبه درخواست از یک دایرکتوری که در آن ذخیره شده است، فراخوانی می‌گردد. حوزه این عبارت‌ها به دایرکتوری‌های فرزند آن نیز ادامه می‌یابد.</para>
        <indexterm><primary><filename>.htaccess</filename></primary></indexterm>

	<para>اکثر عبارت‌هایی که می‌توانند درون یک بلاک <literal>Directory</literal> قرار گیرند در یک فایل <filename>.htaccess</filename> نیز مجاز هستند.</para>
      </sidebar>

      <para>عبارت <literal>AllowOverride</literal> تمام گزینه‌هایی که می‌توانند توسط فایل <filename>.htaccess</filename> فعال یا غیرفعال شوند را فهرست می‌کند. یک کاربرد متداول این عبارت محدودکردن دسترسی به <literal>ExecCGI</literal> است، به طوری که مدیرسیستم تصمیم می‌گیرد کدام کاربران مجاز به اجرای برنامه با هویت سرور وب هستند (کاربر <literal>www-data</literal>).</para>
      <indexterm><primary><literal>AllowOverride</literal>، عبارت آپاچی</primary></indexterm>
      <section>
        <title>الزامی ساختن احرازهویت</title>
        <indexterm><primary>احرازهویت وب</primary></indexterm>

	<para>در برخی موارد، دسترسی به قسمت‌های یک وبسایت باید محدود شود، به طوری که تنها کاربران مجاز با داشتن نام کاربری و گذرواژه بتوانند به آن دسترسی یابند.</para>

        <example>
          <title>فایل <filename>.htaccess</filename> که احرازهویت را لازم می‌داند</title>

          <programlisting>
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private</programlisting>
        </example>

        <sidebar>
          <title><emphasis>امنیت</emphasis> بدون امنیت</title>

	  <para>سیستم احرازهویت استفاده شده در نمونه بالا (<literal>Basic</literal>) دارای حداقل امنیت لازم است چرا که گذرواژه بدون رمزنگاری ارسال می‌شود (تنها با استفاده از کدگذاری <emphasis>base64</emphasis> ارسال می‌شود و نه یک شیوه معمول رمزنگاری). شایان ذکر است که اسناد “محافظت‌شده” با این مکانیزم، درون شبکه بدون رمزنگاری ارسال می‌شوند. اگر امنیت مد نظر باشد، تمام ارتباط HTTP باید توسط SSL رمزنگاری گردد.</para>
        </sidebar>

	<para>فایل <filename>/etc/apache2/authfiles/htpasswd-private</filename> شامل فهرستی از کاربران و گذرواژه‌ها است؛ این فایل معمولا با دستور <command>htpasswd</command> ویرایش می‌گردد. برای نمونه، دستور زیر برای افزودن یک کاربر یا تغییر گذرواژه آن استفاده می‌شود: <indexterm><primary><command>htpasswd</command></primary></indexterm></para>

        <screen>
<computeroutput># </computeroutput><userinput>htpasswd /etc/apache2/authfiles/htpasswd-private <replaceable>user</replaceable>
</userinput><computeroutput>New password:
Re-type new password:
Adding password for user <replaceable>user</replaceable>
</computeroutput></screen>
      </section>
      <section>
        <title>محدود کردن دسترسی</title>
        <indexterm><primary>محدود کردن دسترسی وب</primary></indexterm>

	<para>عبارت <literal>Require</literal> شامل محدودیت‌های دسترسی برای یک دایرکتوری است (و دایرکتوری‌های فرزند آن به صورت بازگشتی).</para>

	<indexterm><primary>عبارت‌های آپاچی</primary></indexterm>
	<indexterm><primary>عبارت‌ها، آپاچی</primary></indexterm>
	<indexterm><primary><literal>Require</literal>، عبارت آپاچی</primary></indexterm>

	<para>می‌تواند به منظور محدود کردن دسترسی با شرایط گوناگون بکار رود؛ ما تنها به بررسی محدودیت برای نشانی IP برنامه درخواست کننده می‌پردازیم، اما می‌تواند کارهای قدرتمندتری نسبت به آن را انجام دهد، بخصوص زمانی که چندین عبارت <literal>Require</literal> درون یک بلاک <literal>RequireAll</literal> قرار می‌گیرند.</para>

        <example>
          <title>فقط به شبکه محلی اجازه دسترسی بده</title>

          <programlisting>Require ip 192.168.0.0/16</programlisting>
        </example>

      <sidebar>
        <title><emphasis>جایگزین</emphasis> شیوه نگارش قدیمی</title>

        <para>شیوه نگارش <literal>Require</literal> تنها در آپاچی ۲.۴ موجود است (نسخه موجود در <emphasis role="distribution">Jessie</emphasis>). برای کاربران <emphasis role="distribution">Wheezy</emphasis>، شیوه نگارش آپاچی ۲.۲ متفاوت است و در اینجا فقط به عنوان ارجاع اشاره می‌شود، با اینکه در آپاچی ۲.۴ و با استفاده از افزونه <literal>mod_access_compat</literal> می‌تواند قابل دسترس شود.</para>

	<para>عبارت‌های <literal>Allow from</literal> و <literal>Deny from</literal> محدودیت‌های دسترسی به یک دایرکتوری را کنترل می‌کنند (و دایرکتوری‌های فرزند آن به صورت بازگشتی).</para>

	<indexterm><primary><literal>Allow from</literal>، عبارت آپاچی</primary></indexterm>
	<indexterm><primary><literal>Deny from</literal>، عبارت آپاچی</primary></indexterm>
	<indexterm><primary><literal>Order</literal>، عبارت آپاچی</primary></indexterm>

	<para>عبارت <literal>Order</literal> به سرور می‌گوید به چه ترتیب عبارت‌های <literal>Allow from</literal> و <literal>Deny from</literal> را اعمال کند؛ آخرین عبارتی که منطبق باشد، انتخاب می‌شود. به عبارتی، <literal>Order deny,allow</literal> تنها در صورتی اجازه دسترسی می‌دهد که هیچ عبارت <literal>Deny from</literal> موجود نباشد یا یک عبارت <literal>Allow from</literal> موجود باشد. برعکس آن، <literal>Order allow,deny</literal> تنها در صورتی دسترسی را محدود می‌کند که هیچ عبارت <literal>Allow from</literal> موجود نباشد یا یک عبارت <literal>Deny from</literal> موجود باشد.</para>

	<para>عبارت‌های <literal>Allow from</literal> و <literal>Deny from</literal> می‌توانند همراه با یک نشانی IP، یک شبکه (از جمله <literal>192.168.0.0/255.255.255.0</literal>، <literal>192.168.0.0/24</literal> یا حتی <literal>192.168.0</literal>)، یک نام میزبان یا دامنه یا کلیدواژه <literal>all</literal> که نشانگر همه است، قرار گیرند.</para>

        <para>برای نمونه، به منظور محدود کردن ارتباطات تنها به شبکه محلی می‌توان از عبارت‌های زیر استفاده کرد:</para>
        <programlisting>
Order deny,allow
Allow from 192.168.0.0/16
Deny from all</programlisting>
        </sidebar>
      </section>
    </section>
    <section>
      <title>تحلیلگرهای گزارش</title>

      <para>یک تحلیلگر گزارش معمولا در یک سرور وب نصب می‌شود؛ چرا که با اینکار الگوهای مصرف منابع در سرور در اختیار مدیرسیستم‌ها قرار می‌گیرد.</para>

      <para>مدیرسیستم‌های شرکت فالکوت <emphasis>AWStats</emphasis> یا <emphasis>Advanced Web Statistics</emphasis> را برای تحلیل فایل‌های گزارش آپاچی انتخاب کرده‌اند.</para>
      <indexterm><primary><emphasis>AWStats</emphasis></primary></indexterm>
      <indexterm><primary>تحلیلگر گزارش‌های وب</primary></indexterm>
      <indexterm><primary>گزارش‌ها</primary><secondary>تحلیلگر گزارش‌های وب</secondary></indexterm>
      <indexterm><primary>تحلیلگر گزارش‌های وب</primary></indexterm>

      <para>اولین گام پیکربندی، سفارشی‌کردن فایل <filename>/etc/awstats/awstats.conf</filename> است. مدیرسیستم‌های فالکوت بجز پارامترهای زیر، تغییری در آن ایجاد نکرده‌اند:</para>

      <programlisting>
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</programlisting>

      <para>تمام این پارامترها توسط توضیحات موجود در فایل اولیه مستندسازی شده‌اند. به طور خاص، پارامترهای <varname>LogFile</varname> و <varname>LogFormat</varname> مکان و قالب فایل گزارش و اطلاعات موجود در آن را مشخص می‌کنند؛ <varname>SiteDomain</varname> و <varname>HostAliases</varname> فهرستی از تمام نام‌های شناخته شده که وبسایت با آن‌ها کار می‌کند را فهرست می‌کنند.</para>

      <para>برای سایت‌های پرترافیک، <varname>DNSLookup</varname> معمولا نباید به <literal>1</literal> تنظیم شود؛ برای سایت‌های کوچکتر، از جمله فالکوت که در بالا مطرح شد، این تنظیم امکان گزارش‌های خواناتری را فراهم می‌کند که شامل نام کامل رایانه بجای نشانی IP آن است.</para>

      <sidebar>
        <title><emphasis>امنیت</emphasis> دسترسی به آمار</title>

	<para>AWStats به صورت پیشفرض آمار خود را بدون هیچ محدودیتی در وبسایت قرار می‌دهد، اما امکان محدود کردن آن وجود دارد به طوری که تنها تعدادی نشانی‌های IP (شاید محلی) بتوانند به آن دسترسی داشته باشند؛ فهرست نشانی‌های IP مجاز می‌توانند درون پارامتر <varname>AllowAccessFromWebToFollowingIPAddresses</varname> قرار بگیرند.</para>
      </sidebar>

      <para>AWStats همچنین برای سایر گروه‌های مجازی نیر فعال می‌شود؛ هر گروه مجازی به فایل پیکربندی خود نیاز دارد، از جمله <filename>/etc/awstats/awstats.www.falcot.org.conf</filename>.</para>

      <example>
        <title>فایل پیکربندی AWStats برای یک گروه مجازی</title>

        <programlisting>
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"</programlisting>
      </example>

      <para>AWStats از شمایل‌های گوناگونی واقع در دایکتوری <filename>/usr/share/awstats/icon/</filename> استفاده می‌کند. به منظور قابل دسترس بودن این شمایل‌ها در وبسایت، پیکربندی آپاچی باید با استفاده از عبارت زیر تغییر کند:</para>

      <programlisting>
Alias /awstats-icon/ /usr/share/awstats/icon/</programlisting>

      <para>پس از چند دقیقه (و زمانی که اسکریپت چندین بار اجرا شود)، نتایج به صورت آنلاین قابل مشاهده هستند: <ulink type="block" url="http://www.falcot.com/cgi-bin/awstats.pl" /><ulink type="block" url="http://www.falcot.org/cgi-bin/awstats.pl" /></para>

      <sidebar>
        <title><emphasis>احتیاط</emphasis> چرخش فایل گزارش</title>

	<para>به منظور اینکه تمام فایل‌های گزارش مورد استفاده قرار گیرند، <emphasis>AWStats</emphasis> نیاز دارد که قبل از چرخش فایل‌های گزارش آپاچی اجرا گردد. با نگاه به عبارت <literal>prerotate</literal> از فایل <filename>/etc/logrotate.d/apache2</filename>، اینکار با قرار دادن یک پیوند نمادین به <filename>/usr/share/awstats/tools/update.sh</filename> در <filename>/etc/logrotate.d/httpd-prerotate</filename> انجام می‌شود.</para>

        <screen><computeroutput>$ </computeroutput><userinput>cat /etc/logrotate.d/apache2
</userinput><computeroutput>/var/log/apache2/*.log {
  daily
  missingok
  rotate 14
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    if /etc/init.d/apache2 status &gt; /dev/null ; then \
      /etc/init.d/apache2 reload &gt; /dev/null; \
    fi;
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ </computeroutput><userinput>sudo mkdir -p /etc/logrotate.d/httpd-prerotate
</userinput><computeroutput>$ </computeroutput><userinput>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats
</userinput></screen>

	<para>نکته اینکه فایل‌های گزارش ایجاد شده توسط <command>logrotate</command> باید توسط همگان قابل خواندن باشند، بخصوص AWStats. در نمونه بالا، اینکار با خط <literal>create 644 root adm</literal> تضمین شده است (بجای مجوزهای پیشفرض <literal>640</literal>).</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.ftp-file-server">
    <title>سرور فایل FTP</title>
    <indexterm><primary>FTP (<emphasis>File Transfer Protocol</emphasis>)</primary></indexterm>

    <para>FTP یا <emphasis>File Transfer Protocol</emphasis> یکی از اولین پروتکل‌های اینترنت است (RFC 959 که در سال ۱۹۸۵ ایجاد شد!). قبل از پیدایش وب، از آن به منظور توزیع فایل در شبکه استفاده می‌شد (پروتکل HTTP در سال ۱۹۹۰ و نسخه ۱.۰ آن به عنوان RFC 1945 در سال ۱۹۹۶ ایجاد شد).</para>

    <para>این پروتکل امکان بارگذاری و بارگیری فایل‌ها را ممکن می‌سازد؛ به همین دلیل، امروزه از آن برای بروزرسانی وبسایت‌هایی که توسط ارائه‌دهنده خدمات اینترنتی میزبانی می‌شوند استفاده می‌شود (یا هر موجودیت دیگری که میزبانی وبسایت را به عهده دارد). در این موارد، دسترسی امن با استفاده از یک شناسه کاربری و گذرواژه صورت می‌گیرد؛ در صورت موفقیت‌آمیز بودن احرازهویت، سرور FTP اجازه خواندن-نوشتن در دایرکتوری خانه آن کاربر را می‌دهد.</para>

    <para>سایر سرورهای FTP به منظور توزیع فایل‌ها برای دانلود عمومی آن‌ها بکار می‌روند؛ بسته‌های دبیان نمونه خوبی هستند. محتوای این سرورها از سایر سرورهای راه‌دور جغرافیایی بدست می‌آید؛ تا در اختیار کاربران نزدیک به آن سرور قرار بگیرند. یعنی نیازی به احرازهویت کاربر نیست؛ به همین دلیل به این حالت عملیات ... گفته می‌شود. به عبارت صحیح‌تر، برنامه‌ها با استفاده از نام کاربری <literal>anonymous</literal> احرازهویت می‌شوند؛ گذرواژه به صورت پیشفرض معمولا نشانی ایمیل است، که سرور آن را نادیده می‌گیرد.</para>

    <para>بسیاری سرورهای FTP در دبیان موجود هستند از جمله <emphasis role="pkg">ftpd</emphasis>، <emphasis role="pkg">proftpd-basic</emphasis>، <emphasis role="pkg">pyftpd</emphasis> و موارد دیگر. مدیرسیستم‌های شرکت فالکوت <emphasis role="pkg">vsftpd</emphasis> را انتخاب کرده‌اند چرا که آن‌ها از سرور FTP به منظور توزیع تعدادی فایل استفاده می‌کنند (از جمله یک مخزن بسته‌های دبیان)؛ از آنجا که به ویژگی‌های پیشرفته نیازی ندارند، تمرکز خود را روی امنیت معطوف ساخته‌اند.</para>
    <indexterm><primary><emphasis role="pkg">vsftpd</emphasis></primary></indexterm>

    <para>نصب این بسته یک کاربر سیستمی <literal>ftp</literal> ایجاد می‌کند. از این حساب کاربری همیشه برای ارتباطات FTP ناشناس استفاده می‌گردد که دایرکتوری خانه آن (<filename>/srv/ftp/</filename>) محل قرارگیری تمام فایل‌های عمومی برای سایر کاربران این سرویس است. پیکربندی پیشفرض آن در <filename>/etc/vsftpd.conf</filename> نیازمند برخی تغییرات است تا امکان دانلود فایل‌های عمومی بزرگ برای کاربران فراهم شود: دسترسی ناشناس باید فعال (<literal>anonymous_enable=YES</literal>) و دسترسی فقط-خواندنی کاربران محلی (<literal>local_enable=NO</literal>) باید غیرفعال شود. دومی از اهمیت خاصی برخوردار است، چرا که پروتکل FTP از هیچ شیوه رمزنگاری استفاده نمی‌کند و گذرواژه کاربر می‌تواند در طی مسیر شنود شود.</para>
  </section>
  <section id="sect.nfs-file-server">
    <title>سرور فایل NFS</title>

    <para>NFS یا <emphasis>Network File System</emphasis> پروتکلی است که اجازه دسترسی راه‌دور به فایل‌سیستم را از طریق شبکه می‌دهد. تمام سیستم‌های یونیکس می‌توانند با این پروتکل کار کنند؛ زمانی که سیستم‌های ویندوز در میان باشند، باید از Samba استفاده شود.</para>
    <indexterm><primary>NFS</primary></indexterm>
    <indexterm><primary><emphasis>شبکه</emphasis></primary><secondary><emphasis>فایل سیستم</emphasis></secondary></indexterm>
    <indexterm><primary>فایل‌سیستم</primary><secondary>شبکه</secondary></indexterm>
    <indexterm><primary>فایل</primary><secondary>سرور</secondary></indexterm>
    <indexterm><primary>سرور</primary><secondary>فایل</secondary></indexterm>

    <para>NFS ابزار بسیار مفیدی است، اما در گذر زمان از محدودیت‌های بسیاری رنج می‌برد، که اکثر آن‌ها با نسخه ۴ پروتکل برطرف شده‌اند. نقطه ضعف آن در پیکربندی آخرین نسخه است چرا که برای استفاده از ویژگی‌های پایه در امنیت مانند احرازهویت و رمزنگاری باید از ابزار Kerberos به این منظور استفاده شود و بدون استفاده از آن‌ها نباید این پروتکل را خارج از شبکه محلی استفاده کرد چرا که داده به صورت رمزنگاری نشده منتقل می‌شود (یک <emphasis>sniffer</emphasis> می‌تواند داده را رهگیری کند) و دسترسی‌ها نیز مبتنی بر نشانی IP درخواست‌کننده صادر می‌شود (که می‌توانند مورد سوءاستفاده قرار بگیرند).</para>

    <sidebar>
      <title><emphasis>مستندات</emphasis> راهنمای استفاده NFS</title>

      <para>مستندات خوبی که به شیوه پیکربندی NFSv4 اشاره می‌کند کم پیدا می‌شود. در اینجا چند پیوند مرتبط با مستندات مرتبط با آن را به عنوان نقطه شروعی برای پیکربندی ذکر می‌کنیم. <ulink type="block" url="https://help.ubuntu.com/community/NFSv4Howto" /> <ulink type="block" url="http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration" /></para>
    </sidebar>
    <section>
      <title>ایمن‌سازی NFS</title>
      <indexterm><primary>NFS</primary><secondary>امنیت</secondary></indexterm>

      <para>اگر از ویژگی‌های امنیتی مبتنی بر Kerberos استفاده نمی‌کنید، این نکته حیاتی است که تنها رایانه‌هایی که اجازه استفاده از NFS را دارند بتوانند به سرورهای درخواست RPC متصل شوند، چرا که پروتکل اولیه به داده دریافتی از شبکه اعتماد می‌کند. فایروال نیز باید <emphasis>IP spoofing</emphasis> را مسدود سازد تا رایانه‌ای خارج از شبکه نتواند خود را بجای یکی از اعضای شبکه معرفی کند، همچنین دسترسی به برخی درگاه‌ها نیز باید فقط به رایانه‌های قابل دسترس در NFS محدود شود.</para>

      <sidebar>
        <title><emphasis>بازگشت به مقدمات</emphasis> RPC</title>

	<para>RPC یا <emphasis>Remote Procedure Call</emphasis> یک استاندارد یونیکس برای سرویس‌های راه‌دور است. NFS یکی از این سرویس‌ها است.</para>
        <indexterm><primary>RPC</primary></indexterm>
        <indexterm><primary><emphasis>Remote Procedure Call</emphasis></primary></indexterm>

	<para>سرویس‌های RPC به یک دایرکتوری بنام <emphasis>portmapper</emphasis> متصل می‌شوند. برنامه‌ای که قصد پرس و جوی NFS را دارد ابتدا با <emphasis>portmapper</emphasis> تماس می‌گیرد (درگاه ۱۱۱ خواه TCP یا UDP) و به دنبال سرور NFS می‌گردد؛ پاسخ معمولا شامل درگاه ۲۰۴۹ (پیشفرض برای NFS) است. همه سرویس‌های RPC الزاما از یک درگاه ثابت استفاده نمی‌کنند.</para>
      </sidebar>

      <para>نسخه‌های قدیمی‌تر پروتکل به سرویس‌های دیگری از RPC نیاز دارند که از درگاه‌های انتساب پویا استفاده می‌کنند. خوشبختانه، با نسخه ۴ از NFS، تنها درگاه‌های ۲۰۴۹ (برای NFS) و ۱۱۱ (برای portmapper) مورد نیاز هستند که به سادگی توسط فایروال کنترل می‌شوند.</para>
      <indexterm><primary><command>portmapper</command></primary></indexterm>

    </section>
    <section>
      <title>سرور NFS</title>

      <para>سرور NFS بخشی از کرنل لینوکس است؛ در کرنل‌های فراهم شده توسط دبیان به صورت یک افزونه کرنل درآمده است. اگر سرور NFS در زمان راه‌اندازی به صورت خودکار باید اجرا گردد، بسته <emphasis role="pkg">nfs-kernel-server</emphasis> باید نصب گردد؛ این بسته شامل اسکریپت‌های راه‌اندازی اولیه است.</para>

      <para>فایل پیکربندی سرور NFS، <filename>/etc/exports</filename>، دایرکتوری‌های قابل دسترس در شبکه را فهرست می‌کند (<emphasis>exported</emphasis>). برای هر اشتراک NFS، تنها فهرست مشخص شده از رایانه‌ها قادر به دسترسی هستند. کنترل دسترسی بهتری با استفاده از گزینه‌های پیکربندی آن ممکن است. شیوه نگارش این فایل بسیار ساده است:</para>
      <indexterm><primary><filename>exports</filename></primary></indexterm>
      <indexterm><primary><filename>/etc/exports</filename></primary></indexterm>

      <programlisting>
/directory/to/share machine1(option1,option2,...) machine2(...) ...</programlisting>

      <para>نکته اینکه در NFSv4، تمام دایرکتوری‌های صادر شده باید بخشی از یک ساختار سلسله‌مراتبی باشند که ریشه آن باید توسط گزینه‌های <literal>fsid=0</literal> و <literal>fsid=root</literal> صادر و شناسایی شده باشد.</para>

      <para>هر رایانه می‌تواند با استفاده از نام DNS یا نشانی IP شناسایی شود. مجموعه‌ای از رایانه‌ها نیز می‌توانند یا با شیوه نگارش <literal>*.falcot.com</literal> یا با محدوده نشانی IP به صورت <literal>192.168.0.0/255.255.255.0</literal> یا <literal>192.168.0.0/24</literal> شناسایی شوند.</para>

      <para>دایرکتوری‌های به صورت فقط-خواندنی در حالت پیشفرض قرار می‌گیرند (یا با گزینه <literal>ro</literal>). گزینه <literal>rw</literal> اجازه دسترسی خواندنی-نوشتنی را می‌دهد. برنامه‌های NFS معمولا از درگاه مختص به root استفاده می‌کنند (به عبارت دیگر، زیر ۱۰۲۴)؛ این محدودیت با استفاده از گزینه <literal>insecure</literal> می‌تواند برداشته شود (گزینه <literal>secure</literal> به صورت ضمنی درج می‌شود اما برای خوانایی بیشتر می‌تواند استفاده شود).</para>
      <indexterm><primary>NFS</primary><secondary>گزینه‌ها</secondary></indexterm>

      <para>به صورت پیشفرض، سرور تنها زمانی به پرس و جوی NFS پاسخ می‌دهد که عملیات فعلی دیسک تمام شده باشد (گزینه <literal>sync</literal>)؛ این کار می‌تواند با استفاده از گزینه <literal>async</literal> غیرفعال گردد. نوشتن‌های غیر-همزمان می‌تواند اندکی عملکرد کلی را بهبود ببخشد، اما قابلیت اعتماد را نیز کاهش می‌دهند چرا که خطر از دست دادن داده زمانی که سرور بین فعالیت‌های تایید نوشتن روی دیسک و انجام واقعی آن متوقف شود، وجود دارد. از زمانی که مقدار پیشفرض آن اخیرا تغییر کرده است (در مقایسه با مقداری قدیمی آن در NFS) تنظیم صریح آن توصیه می‌شود.</para>

      <para>به منظور حذف دسترسی root به فایل‌سیستم اشتراکی از طرف NFS، تمام پرس و جوهایی که از طرف کاربر root دریافت شوند به عنوان کاربر <literal>nobody</literal> در نظر گرفته می‌شوند. این عملکرد مبتنی بر گزینه <literal>root_squash</literal> است، که به صورت پیشفرض فعال می‌باشد. گزینه <literal>no_root_squash</literal>، که این عملکرد را غیرفعال می‌کند، خطرناک بوده و تنها در محیط‌های کنترل شده باید استفاده گردد. گزینه‌های <literal>anonuid=<replaceable>uid</replaceable></literal> و <literal>anongid=<replaceable>gid</replaceable></literal> امکان استفاده از یک کاربر و گروه ساختگی را بجای شناسه‌کاربری/گروه ۶۵۵۳۴ را می‌دهند (که منطبق با کاربر <literal>nobody</literal> و گروه <literal>nogroup</literal> است).</para>

      <para>در NFSv4، شما می‌تواند با استفاده از گزینه <literal>sec</literal> سطح امنیتی مورد نظر خود را مشخص کنید: <literal>sec=sys</literal> گزینه پیشفرض است که ویژگی خاصی را شامل نمی‌شود، <literal>sec=krb5</literal> تنها احرازهویت را فعال می‌کند، <literal>sec=krb5i</literal> محافظت از جامعیت داده را می‌افزاید و <literal>sec=krb5p</literal> کامل‌ترین سطح امنیتی است که شامل محافظت از حریم شخصی می‌باشد (همراه با رمزنگاری). برای این منظور نیاز به یک راه‌اندازی آماده از Kerberos دارد (این سرویس در این کتاب پوشش داده نمی‌شود).</para>

      <para>گزینه‌های دیگری نیز وجود دارند؛ آن‌ها در صفحه راهنمای <citerefentry><refentrytitle>exports</refentrytitle> <manvolnum>5</manvolnum></citerefentry> مستندسازی شده‌اند.</para>

      <sidebar>
        <title><emphasis>احتیاط</emphasis> اولین نصب</title>

	<para>اسکریپت راه‌اندازی <filename>/etc/init.d/nfs-kernel-server</filename> تنها زمانی سرور را راه‌اندازی می‌کند که فایل <filename>/etc/exports</filename> فهرستی از اشتراک‌های معتبر NFS را فهرست کرده باشد. در پیکربندی اولیه، زمانی که این فایل به منظور درج مدخل‌های معتبر ویرایش می‌شود، سرور NFS با استفاده از دستور زیر باید راه‌اندازی شود:</para>

        <screen>
<computeroutput># </computeroutput><userinput>service nfs-kernel-server start</userinput></screen>
      </sidebar>
    </section>
    <section>
      <title>برنامه NFS</title>
      <indexterm><primary>برنامه</primary><secondary>NFS</secondary></indexterm>
      <indexterm><primary>NFS</primary><secondary>برنامه</secondary></indexterm>

      <para>مانند سایر فایل‌سیستم‌ها، یکپارچه‌سازی یک اشتراک NFS درون یک فایل‌سیستم نیازمند اتصال آن است. از آنجا که این فایل‌سیستم ویژگی‌های خود را دارد، برخی تنظیمات در رابطه با دستور <command>mount</command> و فایل <filename>/etc/fstab</filename> مورد نیاز هستند.</para>

      <example>
        <title>اتصال دستی با استفاده از دستور <command>mount</command></title>

        <screen>
          <computeroutput># </computeroutput><userinput>mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/shared</userinput></screen>
      </example>

      <example>
        <title>اتصال خودکار با درج در فایل <filename>/etc/fstab</filename></title>

        <programlisting>
arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0 0</programlisting>
      </example>

      <para>دستور بالا، هنگام راه‌اندازی سیستم، دایرکتوری NFS <filename>/shared/</filename> را از سرور <literal>arrakis</literal> به دایرکتوری محلی <filename>/srv/shared/</filename> متصل می‌کند. دسترسی خواندنی-نوشتنی درخواست شده است (پارامتر <literal>rw</literal>). گزینه <literal>nosuid</literal> یک مقیاس امنیتی است که بیت <literal>setuid</literal> یا <literal>setgid</literal> را از برنامه‌های اجرایی در محل اشتراک حذف می‌کند. اگر قرار بود از اشتراک NFS تنها برای ذخیره‌سازی اسناد استفاده می‌شد، گزینه توصیه شده دیگر <literal>noexec</literal> است، که از اجرای برنامه‌ها در فضای اشتراکی جلوگیری می‌کند. نکته اینکه در سرور، دایرکتوری <filename>shared</filename> زیر دایرکتوری اصلی NFSv4 (برای نمونه، <filename>/export/shared</filename>) قرار دارد، از این رو یک دایکتوری سطح-بالا به حساب نمی‌آید.</para>

      <para>صفحه راهنمای <citerefentry><refentrytitle>nfs</refentrytitle> <manvolnum>5</manvolnum></citerefentry> به توضیح تمام گزینه‌های بکار رفته در آن می‌پردازد.</para>
    </section>
  </section>
  <section id="sect.windows-file-server-with-samba">
    <title>راه‌اندازی اشتراک‌های ویندوز با Samba</title>

    <para>سامبا مجموعه ابزاری است که پروتکل SMB را (که بنام “CIFS” نیز شناخته می‌شود) در لینوکس مدیریت می‌کند. این پروتکل توسط ویندوز برای اشتراک‌های شبکه و چاپگرهای اشتراکی استفاده می‌شود.</para>
    <indexterm><primary>اشتراک ویندوز</primary></indexterm>
    <indexterm><primary>Samba</primary></indexterm>
    <indexterm><primary>SMB</primary></indexterm>
    <indexterm><primary>CIFS</primary></indexterm>
    <indexterm><primary>سرور</primary><secondary>فایل</secondary></indexterm>

    <para>سامبا همچنین می‌تواند به عنوان یک کنترل‌کننده دامنه ویندوز نیز کار کند. این یک ابزار فوق‌العاده برای یکپارچه‌سازی سرورهای لینوکس و رایانه‌های رومیزی ویندوز به حساب می‌آید.</para>
    <section>
      <title>سرور سامبا</title>

      <para>بسته <emphasis role="pkg">samba</emphasis> شامل دو سرور اصلی از نسخه ۴ سامبا است، <command>smbd</command> و <command>nmbd</command>.</para>
      <indexterm><primary><command>smbd</command></primary></indexterm>
      <indexterm><primary><command>nmbd</command></primary></indexterm>

      

      <sidebar>
        <title><emphasis>مستندات</emphasis> مطالعه بیشتر</title>

	<para>سرور سامبا به شدت قابل پیکربندی و همه فن حریف است، که می‌توانند کاربردهای بسیار زیادی را منطبق با نیازمندی‌های شبکه و معماری آن داشته باشد. این کتاب تنها به شیوه استفاده از سامبا به عنوان یک سرور منفرد اشاره می‌کند، اما سامبا می‌تواند به عنوان یک کنترل‌کننده دامنه NT4 یا Active Directory یا یک عضو ساده از یک گروه موجود عمل کند (که توسط یک سرور ویندوزی مدیریت می‌شود).</para>
        <indexterm><primary>کنترل‌کننده دامنه</primary></indexterm>
        <indexterm><primary>دامنه ویندوز</primary></indexterm>

	<para>بسته <emphasis role="pkg">samba-doc</emphasis> شامل تعداد بیشماری فایل‌های نمونه در  <filename>/usr/share/doc/samba-doc/examples/</filename> است.</para>
      </sidebar>

      <sidebar>
        <title><emphasis>ابزار</emphasis> احرازهویت با یک سرور ویندوز</title>

	<para>مدیرسیستم‌ها با استفاده از Winbind می‌توانند از یک سرور ویندوز به عنوان احرازهویت استفاده کنند. این ابزار به خوبی با PAM و NSS یکپارچه می‌شود. اینکار امکان راه‌اندازی رایانه‌های لینوکس که حساب‌ کاربری آن‌ها به صورت خودکار از دامنه ویندوز می‌آید را ممکن می‌سازد.</para>
        <indexterm><primary>Winbind</primary></indexterm>

	<para>اطلاعات بیشتر می‌تواند در دایرکتوری <filename>/usr/share/doc/samba-doc/examples/pam_winbind/</filename> پیدا شود.</para>
      </sidebar>
      <section>
        <title>پیکربندی با <command>debconf</command></title>

	<para>بسته‌ها هنگام نصب اولیه شامل پیکربندی حداقل می‌باشند، اما شما باید با اجرای دستور <command>dpkg-reconfigure samba-common</command> نسبت به انطباق آن نیازهای خود اقدام کنید:</para>

	<para>اولین قطعه اطلاعات مورد نیاز نام workgroup است که سرور سامبا به آن تعلق دارد (در این مورد پاسخ <literal>FALCOTNET</literal> است).</para>

	<para>بسته همچنین با اطلاعات بدست آمده از فرآیند پس‌زمینه DHCP اقدام به شناسایی سرور WINS می‌کند. مدیرسیستم‌های شرکت فالکوت این گزینه را نادیده گرفته‌اند، چرا که قصد دارند از خود سرور سامبا به عنوان WINS استفاده کنند.</para>
        <indexterm><primary>WINS</primary></indexterm>
      </section>
      <section>
        <title>پیکربندی دستی</title>
        <section>
          <title>تغییرات در <filename>smb.conf</filename></title>

	  <para>نیازمندی‌های فالکوت مستلزم تغییر در فایل پیکربندی <filename>/etc/samba/smb.conf</filename> است. گزیده زیر خلاصه‌ای از تغییرات اعمال شده در قسمت <literal>[global]</literal> را شامل می‌شود.</para>

          <programlisting>
[global]

## Browsing/Identification ###

# Change this to the workgroup/NT-domain name your Samba server will part of
   workgroup = FALCOTNET

# Windows Internet Name Serving Support Section:
# WINS Support - Tells the NMBD component of Samba to enable its WINS Server
   wins support = yes <co id="smb.conf.wins"></co>

[...]

####### Authentication #######

# Server role. Defines in which mode Samba will operate. Possible
# values are "standalone server", "member server", "classic primary
# domain controller", "classic backup domain controller", "active
# directory domain controller". 
#
# Most people will want "standalone sever" or "member server".
# Running as "active directory domain controller" will require first
# running "samba-tool domain provision" to wipe databases and create a
# new domain.
   server role = standalone server

# "security = user" is always a good idea. This will require a Unix account
# in this server for every user accessing the server.
   security = user <co id="smb.conf.security"></co>

[...]</programlisting>
          <calloutlist>
            <callout arearefs="smb.conf.wins">
	      <para>نشان می‌دهد که سامبا باید به عنوان یک سرور نام Netbios یا همان WINS برای شبکه محلی عمل کند.</para>
            </callout>
            <callout arearefs="smb.conf.security">
	      <para>این مقدار پیشفرض برای پارامتر است؛ با این حال، از آنجا که در مرکز پیکربندی سامبا قرار دارد، درج آن به صورت صریح توصیه می‌شود. هر کاربر قبل از دسترسی به اشتراک ابتدا باید احرازهویت شود.</para>
            </callout>
          </calloutlist>
        </section>
        <section>
          <title>افزودن کاربران</title>

	  <para>هر کاربر سامبا به یک حساب کاربری در سرور نیاز دارد؛ به منظور ثبت کاربران در پایگاه‌داده سامبا، ابتدا باید این حساب‌های کاربری یونیکس تولید شوند. اینکار به صورت نرمال توسط دستور <command>adduser</command> انجام می‌شود.</para>

	  <para>افزودن یک کاربر موجود به پایگاه‌داده سامبا به سادگی اجرای دستور <command>smbpasswd -a <replaceable>user</replaceable></command> است؛ این دستور گذرواژه را به صورت تعاملی هنگام اجرای خود می‌پرسد.</para>

	  <para>یک کاربر می‌تواند با استفاده از دستور <command>smbpasswd -x <replaceable>user</replaceable></command> حذف گردد. همچنین حساب کاربری سامبا به صورت موقت می‌تواند با دستور <command>smbpasswd -d <replaceable>user</replaceable></command> غیرفعال یا با دستور <command>smbpasswd -e <replaceable>user</replaceable></command> فعال‌سازی مجدد گردد.</para>
        </section>
      </section>
    </section>
    <section>
      <title>برنامه سامبا</title>

      <para>ویژگی‌های این برنامه در سامبا به رایانه‌های لینوکس اجازه می‌دهد که از اشتراک‌های فایل و چاپگر در ویندوز استفاده کنند. برنامه‌های مورد آن در بسته‌های <emphasis role="pkg">cifs-utils</emphasis> و <emphasis role="pkg">smbclient</emphasis> قرار دارند.</para>
      <indexterm><primary><emphasis>smbclient</emphasis></primary></indexterm>
      <indexterm><primary><emphasis>cifs-utils</emphasis></primary></indexterm>
      <section>
        <title>برنامه <command>smbclient</command></title>

	<para>برنامه <command>smbclient</command> از سرورهای SMB پرس و جو می‌کند. یک گزینه <literal>-U <replaceable>user</replaceable></literal> را به منظور اتصال به سرور با یک شناسه خاص می‌پذیرد. <command>smbclient //<replaceable>server</replaceable>/<replaceable>share</replaceable></command> به شیوه‌ای تعاملی و مشابه با FTP در خط فرمان به فضای اشتراکی یک سرور دسترسی می‌یابد. <command>smbclient -L <replaceable>server</replaceable></command> تمام اشتراک‌های موجود (و قابل مشاهده) در یک سرور را فهرست می‌کند.</para>
      </section>
      <section>
        <title>اتصال اشتراک‌های ویندوز</title>

	<para>دستور <command>mount</command> اجازه اتصال اشتراک‌های ویندوز به ساختار فایل‌سیستم لینوکس را می‌دهد (با کمک <command>mount.cifs</command> که توسط <emphasis role="pkg">cifs-utils</emphasis> فراهم شده است).</para>
        <indexterm><primary><command>mount.cifs</command></primary></indexterm>
	<indexterm><primary>اشتراک ویندوز، اتصال</primary></indexterm>

        <example>
          <title>اتصال یک اشتراک ویندوز</title>

          <programlisting>
mount -t cifs //arrakis/shared /shared \
      -o credentials=/etc/smb-credentials</programlisting>
        </example>

	<para>فایل <filename>/etc/smb-credentials</filename> (که نباید توسط کاربران خواندنی باشد) شامل قالب زیر است:</para>

        <programlisting>
username = <replaceable>user</replaceable>
password = <replaceable>password</replaceable></programlisting>

	<para>سایر گزینه‌ها نیز در خط-فرمان می‌توانند قرار گیرند؛ فهرست کامل آن‌ها در صفحه راهنمای <citerefentry><refentrytitle>mount.cifs</refentrytitle> <manvolnum>1</manvolnum></citerefentry> قرار دارد. دو گزینه از اهمیت خاصی برخوردار هستند: <literal>uid</literal> و <literal>gid</literal> که اجازه استفاده فایل‌های کاربر و گروه مشخص شده در نقطه اتصال را می‌دهند، به این منظور که تمام دسترسی‌ها در اختیار root نباشد.</para>

	<para>اتصال یک اشتراک ویندوز می‌توانند در <filename>/etc/fstab</filename> به صورت زیر پیکربندی شود:</para>

        <programlisting>
//<replaceable>server</replaceable>/shared /shared cifs credentials=/etc/smb-credentials</programlisting>

	<para>قطع اتصال یک اشتراک SMB/CIFS توسط دستور استاندارد <command>umount</command> صورت می‌گیرد:</para>
      </section>
      <section>
        <title>چاپ با استفاده از چاپگر اشتراکی</title>

	<para>CUPS یک راهکار زیبا برای عملیات چاپ از لینوکس با استفاده از چاپگر موجود در ویندوز است. زمانی که <emphasis role="pkg">smbclient</emphasis> نصب شود، CUPS اجازه نصب چاپگرهای اشتراکی ویندوز را به صورت خودکار فراهم می‌کند.</para>
        <indexterm><primary>چاپ</primary><secondary>شبکه</secondary></indexterm>

	<para>گام‌های مورد نیاز عبارتند از:</para>
        <itemizedlist>
          <listitem>
	    <para>رابط پیکربندی CUPS را وارد کنید: <literal>http://localhost:631/admin</literal></para>
          </listitem>
          <listitem>
	    <para>روی “Add Printer” کلیک کنید.</para>
          </listitem>
          <listitem>
	    <para>دستگاه چاپگر را انتخاب کنید، برای نمونه: “Windows Printer via SAMBA”.</para>
          </listitem>
          <listitem>
	    <para>نشانی ارتباطی برای چاپگر شبکه را وارد کنید. باید مشابه زیر باشد:</para>
	   
	    <para><literal>smb://<replaceable>user</replaceable>:<replaceable>password</replaceable>@<replaceable>server</replaceable>/<replaceable>printer</replaceable></literal>.</para>
          </listitem>
	  <listitem>
	    <para>نامی که به صورت اختصاصی چاپگر را مشخص می‌کند، وارد کنید. سپس توضیحات و مکان چاپگر را وارد کنید. این‌ها رشته‌هایی هستند که برای کمک به کاربران نهایی در استفاده از چاپگر نمایش داده می‌شوند.</para>
	  </listitem>
	  <listitem>
	    <para>تولیدکننده و مدل چاپگر، یا به صورت مستقیم یک فایل توضحیات چاپگر یا PPD را مشخص کنید.</para>
	  </listitem>
        </itemizedlist>

	<para>بسیار عالی، چاپگر آماده استفاده است!</para>
      </section>
    </section>
  </section>
  <section id="sect.http-ftp-proxy">
    <title>پروکسی HTTP/FTP</title>

    <para>یک پروکسی HTTP/FTP به عنوان یک ارتباط میانی برای HTTP و/یا FTP عمل می‌کند که کاربردی دوگانه دارد:</para>
    <itemizedlist>
      <listitem>
	<para>نهان‌سازی: اسناد تازه دانلود شده به صورت محلی ذخیره می‌شوند، که از دانلودهای بعدی جلوگیری می‌کند.</para>
      </listitem>
      <listitem>
	<para>سرور فیلترینگ: اگر استفاده از پروکسی الزامی باشد (و اتصالات خروجی فقط از درگاه پروکسی بتوانند عبور کنند)، سپس پروکسی می‌تواند تشخیص دهد آیا یک درخواست مورد پذیریش واقع شود یا خیر.</para>
      </listitem>
    </itemizedlist>
    <indexterm><primary>پروکسی HTTP/FTP</primary></indexterm>
    <indexterm><primary>حافظه پروکسی</primary></indexterm>

    <para>شرکت فالکوت، Squid را به عنوان سرور پروکسی انتخاب کرده است.</para>
    <indexterm><primary>Squid</primary></indexterm>
    <section>
      <title>نصب</title>

      <para>بسته دبیان <emphasis role="pkg">squid3</emphasis> تنها شامل پروکسی (نهان‌ساز) اولیه است. تبدیل آن به یک سرور فیلترینگ نیازمند نصب بسته <emphasis role="pkg">squidguard</emphasis> است. به علاوه، <emphasis role="pkg">squid-cgi</emphasis> یک رابط پرس و جو و مدیریتی برای پروکسی Squid فراهم می‌کند.</para>

      <para>پیش از نصب، از اینکه سیستم بتواند نام کامل خود را تشخیص دهد باید اطمینان حاصل کرد: <command>hostname -f</command> باید یک نام تمام-عیار (به همراه دامنه) را برگرداند. اگر اینکار را نکند، پس فایل <filename>/etc/hosts</filename> به منظور درج نام کامل سیستم (برای نمونه، <literal>arrakis.falcot.com</literal>) باید ویرایش گردد. نام رسمی رایانه باید توسط مدیر شبکه به منظور عدم تداخل با سایر نام‌ها مورد تایید قرار گیرد.</para>
    </section>
    <section>
      <title>پیکربندی یک حافظه نهان</title>

      <para>فعال‌سازی ویژگی سرور نهان‌سازی به سادگی ویرایش فایل پیکربندی <filename>/etc/squid3/squid.conf</filename> و اجازه به رایانه‌ها از شبکه محلی برای پرس و جو از طریق پروکسی است. مثال زیر تغییرات اعمال شده توسط مدیرسیستم‌های شرکت فالکوت را نمایش می‌دهد:</para>

      <example>
        <title>فایل <filename>/etc/squid3/squid.conf</filename> (چکیده)</title>

        <programlisting>
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS

# Example rule allowing access from your local networks. Adapt
# to list your (internal) IP networks from where browsing should
# be allowed
acl our_networks src 192.168.1.0/24 192.168.2.0/24
http_access allow our_networks
http_access allow localhost
# And finally deny all other access to this proxy
http_access deny all</programlisting>
      </example>
    </section>
    <section>
      <title>پیکربندی یک فیلتر</title>

      <para><command>squid</command> به خودی خود عملیات فیلترینگ را انجام نمی‌دهد؛ این عملیات در اختیار <command>squidGuard</command> قرار دارد. پس اولی به منظور تعامل با دومی باید پیکربندی شود. این کار شامل افزودن عبارت‌های زیر به فایل <filename>/etc/squid3/squid.conf</filename> است:</para>
      <indexterm><primary><command>squidGuard</command></primary></indexterm>

      <programlisting>
url_rewrite_program /usr/bin/squidGuard -c /etc/squid3/squidGuard.conf </programlisting>

      <para>برنامه <filename>/usr/lib/cgi-bin/squidGuard.cgi</filename> نیز باید نصب گردد، با استفاده از <filename>/usr/share/doc/squidguard/examples/squidGuard.cgi.gz</filename> به عنوان نقطه شروع. تغییرات مورد نیاز این اسکریپت شامل متغیرهای <varname>$proxy</varname> و <varname>$proxymaster</varname> می‌شود (نام پروکسی و نشانی ایمیل مدیر). متغیرهای <varname>$image</varname> و <varname>$redirect</varname>باید به تصویری که برای پرس و جوهای رد شده در نظر گرفته می‌شود، اشاره کنند.</para>

      <para>فیلتر با استفاده از دستور <command>service squid3 reload</command> فعال می‌شود. اگرچه، از آنجا که بسته <emphasis role="pkg">squidguard</emphasis> به صورت پیشفرض فیلترینگ را آغاز نمی‌کند، وظیفه مدیرسیستم است که خط مشی آن را تعریف کند. اینکار با ایجاد فایل <filename>/etc/squid3/squidGuard.conf</filename> صورت می‌پذیرد (در صورت نیاز می‌توان از <filename>/etc/squidguard/squidGuard.conf.default</filename> به عنوان قالب استفاده کرد).</para>

      <para>پس از هر تغییر در فایل پیکربندی <command>update-squidguard</command> (یا هر یک از فهرست‌های دامنه یا نشانی‌های آن)، پایگاه‌داده فعلی باید با استفاده از <command>squidGuard</command> بروزرسانی شود. شیوه نگارش فایل پیکربندی در وبسایت رو‌به‌رو آمده است: <ulink type="block" url="http://www.squidguard.org/Doc/configure.html" /></para>
      <indexterm><primary><command>update-squidguard</command></primary></indexterm>

      <sidebar>
        <title><emphasis>جایگزین</emphasis> DansGuardian</title>
        <indexterm><primary><emphasis role="pkg">dansguardian</emphasis></primary></indexterm>
        <indexterm><primary>PICS</primary></indexterm>

	<para>بسته <emphasis role="pkg">dansguardian</emphasis> یکی از جایگزین‌های <emphasis>squidguard</emphasis> است. این نرم‌افزار تنها به بررسی فهرستی از نشانی‌های ممنوع نمی‌پردازد، بلکه می‌تواند از سیستم PICS یا <emphasis>Platform for Internet Content Selection</emphasis> به منظور تصمیم‌گیری که آیا یک صفحه با توجه به محتویات داخلش می‌تواند مورد پذیریش واقع شود یا خیر، بهره‌مند شود.</para>
      </sidebar>
    </section>
  </section>
  <section id="sect.ldap-directory">
    <title>دایرکتوی LDAP</title>
    <indexterm><primary>LDAP</primary></indexterm>
    <indexterm><primary>OpenLDAP</primary></indexterm>
    <indexterm><primary>دایرکتوری، LDAP</primary></indexterm>

    <para>OpenLDAP یکی از پیاده‌سازی‌های پروتکل LDAP است؛ به عبارت دیگر، یک پایگاه‌داده به خصوص برای ذخیره‌سازی دایرکتوری‌ها. در متداول‌ترین کاربرد آن، استفاده از یک سرور LDAP اجازه متمرکزسازی مدیریت حساب‌های کاربری و مجوزهای مربوط به آن‌ها را می‌دهد. علاوه بر این، یک پایگاه‌داده LDAP به سادگی قابل تکثیر است، که امکان برپایی چندین سرور LDAP به صورت متقارن را فراهم می‌آورد. زمانی که شبکه و کاربران آن به سرعت رشد می‌کنند، عملکرد می‌تواند بین چندین سرور مختلف تقسیم شود.</para>

    <para>داده LDAP ساخت‌یافته و سلسله‌مراتبی است. ساختار آن با توجه به “schema” تعریف می‌شود که انواع گوناگون اشیا قابل ذخیره‌سازی توسط پایگاه‌داده را مشخص می‌کند، به همراه فهرستی از تمام ویژگی‌های آن‌ها. شیوه نگارش یک شی خاص در این پایگاه‌داده مبتنی بر ساختار آن است، که همین امر باعث پیچیدگی آن می‌شود.</para>
    <section>
      <title>نصب</title>

      <para>بسته <emphasis role="pkg">slapd</emphasis> شامل سرور OpenLDAP است. بسته <emphasis role="pkg">ldap-utils</emphasis> نیز ابزار خط-فرمان مورد نیاز برای تعامل با سرورهای LDAP را شامل می‌شود.</para>
      <indexterm><primary><emphasis>slapd</emphasis></primary></indexterm>

      <para>هنگام نصب <emphasis role="pkg">slapd</emphasis> معمولا پرسش‌های کمی مطرح می‌شود که این امر باعث می‌شود پایگاه‌داده نهایی برای نیاز شما مناسب نباشد. خوشبختانه با استفاده از <command>dpkg-reconfigure slapd</command> می‌توانید پایگاه‌داده LDAP را با جزئیات بیشتری تنظیم کنید.</para>
      <itemizedlist>
        <listitem>
	  <para>پیکربندی سرور OpenLDAP را نادیده گرفته‌اید؟ البته که نه، ما قصد پیکربندی آن را داریم.</para>
        </listitem>
        <listitem>
	  <para>نام دامنه DNS: “<literal>falcot.com</literal>”.</para>
        </listitem>
        <listitem>
	  <para>نام سازمانی: “Falcot Corp”.</para>
        </listitem>
        <listitem>
	  <para>یک گذرواژه مدیریتی باید وارد شود.</para>
        </listitem>
        <listitem>
	  <para>پایگاه‌داده‌ای که از آن استفاده می‌شود: “MDB”.</para>
        </listitem>
        <listitem>
	  <para>می‌خواهید در زمان حذف کامل <emphasis role="pkg">slapd</emphasis> پایگاه‌داده آن نیز حذف گردد؟ نه، دلیلی برای به خطر انداختن داده‌ها در صورت بروز اشتباه وجود ندارد.</para>
        </listitem>
        <listitem>
	  <para>پایگاه‌داده قدیمی جابجا شود؟ این پرسش زمانی مطرح می‌شود که یک پایگاه‌داده دیگر موجود باشد. فقط زمانی که می‌خواهید از دوباره شروع کنید به آن پاسخ مثبت بدهید. برای نمونه، اگر پس از نصب اولیه دستور <command>dpkg-reconfigure slapd</command> را اجرا کنید.</para>
        </listitem>
        <listitem>
	  <para>اجازه استفاده از پروتکل LDAPv2؟ نه، دلیلی برای اینکار وجود ندارد. تمام ابزاری که قصد استفاده آن‌ها را داریم با پروتکل LDAPv3 سازگار هستند.</para>
        </listitem>
      </itemizedlist>

      <sidebar>
        <title><emphasis>بازگشت به مقدمات</emphasis> قالب LDIF</title>

	<para>یک فایل LDIF یا <emphasis>LDAP Data Interchange Format</emphasis> یک فایل متنی پرتابل است که محتوای پایگاه‌داده LDAP را توضیح می‌دهد (یا قسمتی از آن را)؛ از این فایل می‌توان برای ورود داده به هر سرور LDAP دیگر استفاده کرد.</para>
        <indexterm><primary>LDIF</primary></indexterm>
      </sidebar>

      <para>یک پایگاه‌داده حداقلی با استفاده از پرس و جوهای زیر تعریف شده است:</para>

      <screen>
<computeroutput>$ </computeroutput><userinput>ldapsearch -x -b dc=falcot,dc=com</userinput>
<computeroutput># extended LDIF
#
# LDAPv3
# base &lt;dc=falcot,dc=com&gt; with scope sub
# filter: (objectclass=*)
# requesting: ALL
#

# falcot.com
dn: dc=falcot,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Falcot Corp
dc: falcot

# admin, falcot.com
dn: cn=admin,dc=falcot,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2
</computeroutput></screen>

      <para>پرس و جو دو شی را باز می‌گرداند: خود سازمان و کاربر مدیریتی آن.</para>
    </section>
    <section>
      <title>پرکردن دایرکتوری</title>

      <para>از آنجا که یک پایگاه‌داده خالی به هیچ دردی نمی‌خورد، قصد داریم کاربران، گروه‌ها، سرویس‌ها و پایگاه‌داده‌های میزبان را در آن وارد کنیم.</para>

      <para>بسته <emphasis role="pkg">migrationtools</emphasis> شامل چندین اسکریپت برای استخراج داده از دایکتوری‌های استاندارد یونیکس (<filename>/etc/passwd</filename>، <filename>/etc/group</filename>، <filename>/etc/services</filename> و <filename>/etc/hosts</filename>) می‌شود که با تبدیل آن‌ها، قابلیت ذخیره‌سازی در پایگاه‌داده LDAP را فراهم می‌کند.</para>
      <indexterm><primary><emphasis role="pkg">migrationtools</emphasis></primary></indexterm>

      <para>زمانی که بسته نصب شد، فایل <filename>/etc/migrationtools/migrate_common.ph</filename> باید ویرایش شود؛ گزینه‌های <varname>IGNORE_UID_BELOW</varname> و <varname>IGNORE_GID_BELOW</varname> باید فعال (با حذف توضیحات قبل از خود) و گزینه <varname>DEFAULT_MAIL_DOMAIN</varname>/<varname>DEFAULT_BASE</varname> باید بروزرسانی گردد.</para>

      <para>عملیات واقعی مهاجرت توسط دستور <command>migrate_all_online.sh</command> به صورت زیر اجرا می‌شود:</para>

      <screen>
<computeroutput># </computeroutput><userinput>cd /usr/share/migrationtools</userinput>
<computeroutput># </computeroutput><userinput>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</userinput></screen>

      <para>دستور <command>migrate_all_online.sh</command> درباره پایگاه‌داده LDAP که قرار است داده به داخل آن وارد شود چندین پرسش مطرح می‌کند. قسمت <xref linkend="tab-migrate-all" xrefstyle="select: label nopage" /> به بررسی پاسخ‌های مطرح شده در مورد شرکت فالکوت می‌پردازد.</para>
 
      <table colsep="1" id="tab-migrate-all">
        <title>پاسخ به پرسش‌های مطرح شده توسط اسکریپت <command>migrate_all_online.sh</command></title>
	<tgroup cols="2"><colspec align="justify"></colspec><colspec align="justify"></colspec>
	<thead>
	  <row><entry>پرسش</entry><entry>پاسخ</entry></row>
	</thead>
	<tbody>
	  <row>
	    <entry>شرایط نامگذاری X.500</entry>
	    <entry><literal>dc=falcot,dc=com</literal></entry>
	  </row>
	  <row>
	    <entry>نام سرور LDAP</entry>
	    <entry><literal>localhost</literal></entry>
	  </row>
	  <row>
	    <entry>مدیر دامنه</entry>
	    <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
	  </row>
	  <row>
	    <entry>مدرک اعتبارسنجی</entry>
	    <entry>گذرواژه مدیریتی</entry>
	  </row>
	  <row>
	    <entry>ایجاد DUAConfigProfile</entry>
	    <entry>no</entry>
	  </row>
	</tbody>
	</tgroup>
      </table>

      <para>ما به صورت عمدی از مهاجرت فایل <filename>/etc/aliases</filename> امتناع کردیم، چرا که شِمای استاندارد فراهم شده توسط دبیان ساختار مورد نظر این اسکریپت برای توضیح نام‌های مستعار ایمیل را شامل نمی‌شود. به منظور درج این داده در ساختار دایرکتوری، فایل <filename>/etc/ldap/schema/misc.schema</filename> باید به شِمای استاندارد اضافه گردد.</para>

      <sidebar>
        <title><emphasis>ابزار</emphasis> مرور یک دایرکتوری LDAP</title>

	<para>دستور <command>jxplorer</command> (در بسته‌ای با همین نام) یک ابزار گرافیکی است که اجازه مرور و ویرایش پایگاه‌داده LDAP را فراهم می‌کند. این ابزار جالبی برای مدیرسیستم است، چرا که ساختار سلسله‌مراتبی داده‌های LDAP را به شیوه‌ای خوب در اختیار وی قرار می‌دهد.</para>
        <indexterm><primary><command>jxplorer</command></primary></indexterm>
      </sidebar>

      <para>به استفاده از گزینه <literal>-c</literal> در دستور <command>ldapadd</command> دقت کنید؛ این گزینه درخواست می‌کند که در صورت بروز خطا، پردازش متوقف نشود. استفاده از این گزینه مورد نیاز است چرا که هنگام تبدیل فایل <filename>/etc/services</filename> اغلب چند خطای کوچک رخ می‌دهد که می‌توان از آن‌ها چشم‌پوشی کرد.</para>
    </section>
    <section>
      <title>مدیریت حساب‌ها با LDAP</title>

      <para>اکنون که پایگاه‌داده LDAP شامل اطلاعاتی خوبی است، زمان آن فرا رسیده که از آن‌ها استفاده کنیم. این قسمت به چگونگی پیکربندی یک سیستم لینوکس به شیوه‌ای که دایکتوری‌های سیستمی آن بتوانند از پایگاه‌داده LDAP استفاده کنند، می‌پردازد.</para>
      <section id="sect.config-nss">
        <title>پیکربندی NSS</title>

	<para>سیستم NSS (یا Name Service Switch،‌قسمت <xref linkend="sidebar.intro-nss" /> را مشاهده کنید) یک سیستم ماژولار به منظور تعریف یا دریافت اطلاعات برای دایرکتوری‌های سیستمی است. استفاده از LDAP به عنوان منبع داده برای NSS نیازمند نصب بسته <emphasis role="pkg">libnss-ldap</emphasis> است. در زمان نصب چندین پرسش مطرح می‌شود؛ پاسخ‌ها در قسمت <xref linkend="tab-libnss-ldap" xrefstyle="select: label nopage" /> بیان شده‌اند.</para>
        <indexterm><primary><emphasis>libnss-ldap</emphasis></primary></indexterm>

        <table colsep="1" id="tab-libnss-ldap">
          <title>پیکربندی بسته <emphasis role="pkg">libnss-ldap</emphasis></title>
          <tgroup cols="2">
            <colspec align="justify"></colspec>
            <colspec align="justify"></colspec>
            <thead>
              <row>
                <entry>پرسش</entry>
                <entry>پاسخ</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>شناسه منحصربفرد سرور LDAP</entry>
                <entry><literal>ldap://ldap.falcot.com</literal></entry>
              </row>
              <row>
                <entry>نام متمایز پایگاه جستجو</entry>
                <entry><literal>dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>نسخه LDAP مورد استفاده</entry>
                <entry><literal>3</literal></entry>
              </row>
              <row>
                <entry>آیا پایگاه‌داده LDAP نیازمند نام کاربری است؟</entry>
                <entry>no</entry>
              </row>
	      <row>
	        <entry>ویژگی‌های خاص LDAP برای root</entry>
		<entry>بله</entry>
	      </row>
	      <row>
	        <entry>فایل پیکربندی تنها توسط خود مالک خواندنی/نوشتنی باشد</entry>
		<entry>no</entry>
	      </row>
              <row>
                <entry>حساب‌کاربری LDAP برای root</entry>
                <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>گذرواژه حساب‌کاربری root در LDAP</entry>
                <entry>گذرواژه مدیریتی</entry>
              </row>
            </tbody>
          </tgroup>
        </table>

	<para>به منظور پیکربندی NSS برای استفاده از افزونه تازه-نصب‌شده <command>ldap</command>، فایل <filename>/etc/nsswitch.conf</filename> نیاز به تغییرات دارد.</para>

        <example>
          <title>فایل <filename>/etc/nsswitch.conf</filename></title>

          <programlisting>
# /etc/nsswitch.conf
#
# Example configuration of GNU Name Service Switch functionality.
# If you have the `glibc-doc' and `info' packages installed, try:
# `info libc "Name Service Switch"' for information about this file.

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files</programlisting>
        </example>

	<para>افزونه <command>ldap</command> معمولا قبل از دیگران قرار می‌گیرد، پس ابتدا از همه مورد پرس و جو می‌باشد. استثنا این مورد سرویس <literal>hosts</literal> است چرا که قبل از برقراری ارتباط با سرور LDAP، ابتدا به DNS نیاز است (برای شناسایی <literal>ldap.falcot.com</literal>). بدون این استثنا، یک پرس و جو مبتنی بر نام، از سرور LDAP اطلاعات خود را می‌پرسد؛ اینکار منجر به بروز خطا در سرور LDAP شده که آن را در یک حلقه بینهایت قرار می‌دهد.</para>

	<para>اگر نیاز به پرس و جو از سرور LDAP برای اینکار باشد (و فایل‌های محلی مورد استفاده افزونه <command>files</command> نادیده گرفته شوند)، سرویس‌ها می‌توانند با شیوه نگارش زیر پیکربندی گردند:</para>

	<para><literal><replaceable>service</replaceable>: ldap [NOTFOUND=return] files</literal>.</para>

	<para>اگر گزینه درخواست‌شده در پایگاه‌داده LDAP موجود نباشد، یک پاسخ “not existing” باز گردانده می‌شود حتی اگر گزینه مورد نظر در یکی از فایل‌های محلی موجود باشد؛ تنها زمانی از این فایل‌ها استفاده می‌شود که سرویس LDAP متوقف شده باشد.</para>
      </section>
      <section id="sect.config-pam">
        <title>پیکربندی PAM</title>

	<para>این قسمت به بررسی پیکربندی از PAM (<xref linkend="sidebar.intro-pam" /> را مشاهده کنید) می‌پردازد که به برنامه‌ها اجازه احرازهویت توسط پایگاه‌داده LDAP را می‌دهد.</para>

        <sidebar>
          <title><emphasis>احتیاط</emphasis> احرازهویت شکسته‌شده</title>

	  <para>تغییر پیکربندی استاندارد PAM که توسط بسیاری برنامه‌ها استفاده می‌شود کاری خطرناک است. یک اشتباه کافی است تا فرآیند احرازهویت شکست بخورد، که از ثبت گزارش‌های آن از جلوگیری می‌کند. بازنگه‌داشتن یک پوسته root عمل احتیاطی خوبی است. در صورت بروز خطا در پیکربندی، به راحتی می‌توانند برطرف شوند و سرویس مورد نظر نیز با حداقل تلاش لازم راه‌اندازی مجدد شود.</para>
        </sidebar>

	<para>افزونه LDAP برای PAM توسط بسته <emphasis role="pkg">libpam-ldap</emphasis> فراهم می‌شود. در زمان نصب این بسته پرسش‌های بسیار مشابهی به آنچه در <emphasis role="pkg">libpam-ldap</emphasis> مطرح شد پرسیده می‌شود؛ حتی برخی پارامترهای پیکربندی نیز (از جمله نشانی سرور LDAP) با بسته <emphasis role="pkg">libpam-ldap</emphasis> مشترک هستند. پاسخ‌ها در قسمت <xref linkend="tab-libpam-ldap" xrefstyle="select: label nopage" /> توضیح داده شده‌اند.</para>
        <indexterm><primary><emphasis>libpam-ldap</emphasis></primary></indexterm>

        <table colsep="1" id="tab-libpam-ldap">
          <title>پیکربندی <emphasis>libpam-ldap</emphasis></title>
          <tgroup cols="2">
            <colspec align="justify"></colspec>
            <colspec align="justify"></colspec>
            <thead>
              <row>
                <entry>پرسش</entry>
                <entry>پاسخ</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>حساب مدیر LDAP مجاز است که مانند root رفتار کند؟</entry>
                <entry>بله. اینکار باعث می‌شود بتواند از دستور <command>passwd</command> برای تغییر گذرواژه‌های ذخیره‌شده در پایگاه‌داده LDAP استفاده شود.</entry>
              </row>
              <row>
                <entry>پایگاه‌داده LDAP نیازمند اطلاعات ورود باشد؟</entry>
                <entry>no</entry>
              </row>
              <row>
                <entry>حساب‌کاربری LDAP برای root</entry>
                <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>
              </row>
              <row>
                <entry>گذرواژه حساب‌کاربری root در LDAP</entry>
                <entry>گذرواژه مدیریتی پایگاه‌داده LDAP</entry>
              </row>
	      <row>
	        <entry>الگوریتم رمزنگاری محلی برای استفاده گذرواژه‌ها</entry>
		<entry>crypt</entry>
	      </row>
            </tbody>
          </tgroup>
        </table>

	<para>نصب <emphasis role="pkg">libpam-ldap</emphasis> به صورت خودکار با پیکربندی پیشفرض PAM که در فایل‌های <filename>/etc/pam.d/common-auth</filename>، <filename>/etc/pam.d/common-password</filename> و <filename>/etc/pam.d/common-account</filename> تعریف شده است، منطبق می‌شود. این مکانیزم از ابزار انحصاری <command>pam-auth-update</command> استفاده می‌کند (که توسط بسته <emphasis role="pkg">libpam-runtime</emphasis> فراهم می‌شود). مدیرسیستم همچنین می‌تواند از این ابزار برای فعال‌سازی یا غیرفعال‌سازی افزونه‌های PAM استفاده کند.</para>
        <indexterm><primary><filename>common-auth</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-auth</filename></primary></indexterm>
        <indexterm><primary><filename>common-password</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-password</filename></primary></indexterm>
        <indexterm><primary><filename>common-account</filename></primary></indexterm>
        <indexterm><primary><filename>/etc/pam.d/common-account</filename></primary></indexterm>
      </section>
      <section>
        <title>ایمن‌سازی تبادل داده LDAP</title>
        <indexterm><primary>LDAP</primary><secondary>امنیت</secondary></indexterm>

	<para>پروتکل LDAP، به صورت پیشفرض، داده‌ها را در شبکه در حالت متنی جابجا می‌کند؛ این امر شامل گذرواژه‌ها (رمزنگاری‌شده) می‌شود. از آنجا که این گذرواژه‌ها می‌توانند از طریق شبکه استخراج شوند، نسبت به حملات dictionary-type آسیب‌پذیر هستند. این مشکل با فعال‌سازی یک لایه رمزنگاری اضافی برطرف می‌شود؛ فعال‌سازی این لایه موضوع بحث این قسمت است.</para>
        <section>
          <title>پیکربندی سرور</title>
          <indexterm><primary><foreignphrase>OpenSSL</foreignphrase></primary><secondary>ایجاد کلیدها</secondary></indexterm>
          <indexterm><primary>جفت کلید</primary></indexterm>

	  <para>اولین گام ایجاد یک جفت کلید (کلیدهای عمومی و خصوصی) برای سرور LDAP است. مدیرسیستم‌های فالکوت از <emphasis>easy-rsa</emphasis> برای تولید آن استفاده می‌کنند (<xref linkend="sect.easy-rsa" /> را مشاهده کنید). با اجرای <command>./build-key-server ldap.falcot.com</command> چند پرسش درباره محل، نام سازمان و از این قبیل پرسیده می‌شود. پاسخ به پرسش “نام متداول” باید مطابق با نام تمام-عیار سرور LDAP باشد؛ در این مورد، <literal>ldap.falcot.com</literal>.</para>

	  <para>این دستور یک گواهینامه در فایل <filename>keys/ldap.falcot.com.crt</filename> ایجاد می‌کند؛ کلید خصوصی متناظر آن در <filename>keys/ldap.falcot.com.key</filename> ذخیره می‌شود.</para>

	  <para>اکنون این کلیدها باید در مکان استاندارد خود نصب شوند و باید اطمینان یابیم که کلید خصوصی توسط سرور LDAP که تحت هویت کاربر <literal>openldap</literal> اجرا می‌شود، قابل خواندن باشد.</para>

          <screen><computeroutput># </computeroutput><userinput>adduser openldap ssl-cert
</userinput><computeroutput>Adding user `openldap' to group `ssl-cert' ...
Adding user openldap to group ssl-cert
Done.
# </computeroutput><userinput>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chmod 0640 /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem
</userinput></screen>

	  <para>همچنین نیاز است که فرآیند پس‌زمینه <command>slapd</command> نیز از این کلیدها برای رمزنگاری استفاده کند. پیکربندی سرور LDAP به صورت خودکار مدیریت می‌شود: پیکربندی می‌تواند با عملیات ساده LDAP روی سلسله‌مراتب شی <literal>cn=config</literal> بروزرسانی شود تا سرور در زمان واقعی و به صورت پایدار، اقدام به بروزرسانی <filename>/etc/ldap/slapd.d</filename> کند. از این رو، <command>ldapmodify</command> ابزار مناسب بروزرسانی پیکربندی به حساب می‌آید:</para>

          <example>
            <title>پیکربندی <command>slapd</command> برای رمزنگاری</title>

            <screen><computeroutput># </computeroutput><userinput>cat &gt;ssl.ldif &lt;&lt;END
dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key
-
END
</userinput><computeroutput># </computeroutput><userinput>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif
</userinput><computeroutput>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
</computeroutput></screen>
          </example>

	  <sidebar>
	    <title><emphasis>ابزار</emphasis> استفاده از <command>ldapvi</command> برای ویرایش یک دایرکتوری LDAP</title>
	    <indexterm><primary><command>ldapvi</command></primary></indexterm>
	    <para>با استفاده از <command>ldapvi</command> می‌توانید خروجی LDIF یک دایرکتوری LDAP را مشاهده کرده، برخی تغییرات را در ویرایشگر متن ایجاد کنید و به ابزار اجازه دهید که عملیات متناظر LDAP را اجرا کند.</para>
	    <para>بنابراین ابزار مناسبی به منظور بروزرسانی پیکربندی سرور LDAP با استفاده از سلسله‌مراتب <literal>cn=config</literal> و ویرایش آن به حساب می‌آید.</para>
	    <screen><computeroutput># </computeroutput><userinput>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config
</userinput></screen>
	  </sidebar>

	  <para>آخرین گام برای فعال‌سازی رمزنگاری تغییر متغیر <varname>SLAPD_SERVICES</varname> در فایل <filename>/etc/default/slapd</filename> است. ما به صورت امنی از آن استفاده کرده و تمام تبادل داده‌های ناامن LDAP را غیرفعال کرده‌ایم.</para>

          <example>
            <title>فایل <filename>/etc/default/slapd</filename></title>

            <programlisting>
# Default location of the slapd.conf file or slapd.d cn=config directory. If
# empty, use the compiled-in default (/etc/ldap/slapd.d with a fallback to
# /etc/ldap/slapd.conf).
SLAPD_CONF=

# System account to run the slapd server under. If empty the server
# will run as root.
SLAPD_USER="openldap"

# System group to run the slapd server under. If empty the server will
# run in the primary group of its user.
SLAPD_GROUP="openldap"

# Path to the pid file of the slapd server. If not set the init.d script
# will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf by
# default)
SLAPD_PIDFILE=

# slapd normally serves ldap only on all TCP-ports 389. slapd can also
# service requests on TCP-port 636 (ldaps) and requests via unix
# sockets.
# Example usage:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# If SLAPD_NO_START is set, the init script will not start or restart
# slapd (but stop will still work).  Uncomment this if you are
# starting slapd via some other means or if you don't want slapd normally
# started at boot.
#SLAPD_NO_START=1

# If SLAPD_SENTINEL_FILE is set to path to a file and that file exists,
# the init script will not start or restart slapd (but stop will still
# work).  Use this for temporarily disabling startup of slapd (when doing
# maintenance, for example, or through a configuration management system)
# when you don't want to edit a configuration file.
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# For Kerberos authentication (via SASL), slapd by default uses the system
# keytab file (/etc/krb5.keytab).  To use a different keytab file,
# uncomment this line and change the path.
#export KRB5_KTNAME=/etc/krb5.keytab

# Additional options to pass to slapd
SLAPD_OPTIONS=""</programlisting>
          </example>
        </section>
        <section>
          <title>پیکربندی برنامه</title>

	  <para>در سمت برنامه، پیکربندی افزونه‌های <emphasis>libpam-ldap</emphasis> و <emphasis>libnss-ldap</emphasis> نیاز به تغییر دارند تا از نشانی <literal>ldaps://</literal> استفاده کنند.</para>

	  <para>برنامه‌های LDAP همچنین باید بتوانند سرور را احرازهویت کنند. در یک زیرساخت کلید X.509، گواهینامه‌های عمومی توسط کلید یکی از صادرکنندگان گواهینامه (CA) با <emphasis>easy-rsa</emphasis> امضا می‌شوند. مدیرسیستم‌های فالکوت CA خود را ایجاد کرده‌اند و نیاز دارند که سیستم را مبتنی بر آن پیکربندی کنند. اینکار با قرار دادن گواهینامه CA در <filename>/usr/local/share/ca-certificates</filename> و اجرای <command>update-ca-certificates</command> انجام می‌شود.</para>
	  
	  <screen><computeroutput># </computeroutput><userinput>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt
</userinput><computeroutput># </computeroutput><userinput>update-ca-certificates
</userinput><computeroutput>Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
Adding debian:falcot.pem
done.
done.
</computeroutput></screen>

	  <para>در آخر نیز، URI و DN پیشفرض LDAP که توسط بسیاری ابزارهای خط-فرمان استفاده می‌شوند می‌توانند در <filename>/etc/ldap/ldap.conf</filename> تغییر کنند. اینکار از نوشتن‌های اضافی جلوگیری بعمل می‌آورد.</para>

          <example>
            <title>فایل <filename>/etc/ldap/ldap.conf</filename></title>

            <programlisting>#
# LDAP Defaults
#

# See ldap.conf(5) for details
# This file should be world readable but not world writable.

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# TLS certificates (needed for GnuTLS)
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt</programlisting>
          </example>

        </section>
      </section>
    </section>
  </section>
  <section id="sect.rtc-services">
    <title>سرویس‌های ارتباطی بلادرنگ</title>

    <para>سرویس‌های ارتباطی بلادرنگ (RTC) شامل صوت، تصویر/دوربین، پیام‌رسانی فوری (IM) و اشتراک‌گذاری صفحه نمایش هستند. این قسمت به معرفی سه تا از سرویس‌های RTC می‌پردازد که عبارتند از: سرورهای TURN، SIP و XMPP. چگونگی طرح‌ریزی، نصب و مدیریت این سرویس‌ها به صورت کامل در راهنمای سریع ارتباطات بلادرنگ همراه با مثال‌های موجود برای دبیان آورده شده است. <ulink type="block" url="http://rtcquickstart.org" /></para>
    <indexterm><primary>VoIP</primary><secondary>سرور</secondary></indexterm>
    <indexterm><primary>RTC</primary><secondary>سرور</secondary></indexterm>
    <indexterm><primary>Instant Messaging</primary><secondary>سرور</secondary></indexterm>
    <indexterm><primary>Chat</primary><secondary>سرور</secondary></indexterm>

    <para>هر دو سرویس SIP و ‌XMPP می‌توانند عملکرد یکسانی را فراهم کنند. SIP بیشتر برای صوت و تصویر شناخته شده است در صورتی که XMPP از قبل برای پروتکل IM استفاده می‌شد. در حقیقت، هر دو می‌توانند برای هر کدام از این اهداف استفاده شوند. برای استفاده حداکثری از گزینه‌های ارتباطی، توصیه می‌شود که هر دو به صورت موازی اجرا شوند.</para>
    <indexterm><primary>SIP</primary></indexterm>
    <indexterm><primary>XMPP</primary></indexterm>

    
    <para>این سرویس‌ها برای اهداف احرازهویت و محرمانگی داده مبتنی بر گواهینامه‌های X.509 هستند. برای جزئیات مرتبط با ایجاد هر کدام، <xref linkend="sect.easy-rsa" /> را مشاهده کنید. همچنین، <emphasis>راهنمای سریع ارتباطات بلادرنگ</emphasis> شامل برخی توضیحات مفید است: <ulink type="block" url="http://rtcquickstart.org/guide/multi/tls.html" /></para>

    <section id="sect.rtc-dns-settings">
      <title>تنظیمات DNS برای سرویس‌های RTC</title>

      <para>سرویس‌های RTC نیازمند رکوردهای SRV و NAPTR از DNS هستند. یک پیکربندی نمونه که می‌تواند در ناحیه مرتبط با <literal>falcot.com</literal> قرار بگیرد عبارت است از:</para>
      <indexterm><primary>DNS</primary><secondary>رکورد SRV</secondary></indexterm>
      <indexterm><primary>DNS</primary><secondary>رکورد NAPTR</secondary></indexterm>

<programlisting>
; the server where everything will run
server1            IN     A      198.51.100.19
server1            IN     AAAA   2001:DB8:1000:2000::19

; IPv4 only for TURN for now, some clients are buggy with IPv6
turn-server        IN     A      198.51.100.19

; IPv4 and IPv6 addresses for SIP
sip-proxy          IN     A      198.51.100.19
sip-proxy          IN     AAAA   2001:DB8:1000:2000::19

; IPv4 and IPv6 addresses for XMPP
xmpp-gw            IN     A      198.51.100.19
xmpp-gw            IN     AAAA   2001:DB8:1000:2000::19

; DNS SRV and NAPTR for STUN / TURN
_stun._udp  IN SRV    0 1 3467 turn-server.falcot.com.
_turn._udp  IN SRV    0 1 3467 turn-server.falcot.com.
@           IN NAPTR  10 0 "s" "RELAY:turn.udp" "" _turn._udp.falcot.com.

; DNS SRV and NAPTR records for SIP
_sips._tcp  IN SRV    0 1 5061 sip-proxy.falcot.com.
@           IN NAPTR  10 0 "s" "SIPS+D2T" "" _sips._tcp.falcot.com.

; DNS SRV records for XMPP Server and Client modes:
_xmpp-client._tcp  IN     SRV    5 0 5222 xmpp-gw.falcot.com.
_xmpp-server._tcp  IN     SRV    5 0 5269 xmpp-gw.falcot.com.</programlisting>
    </section>

    <section id="sect.turn-server">
      <title>سرور TURN</title>

      <para>ًَُٔTURN سرویسی است که به برنامه‌های پشت مسیریاب‌ها و فایروال‌های NAT کمک می‌کند تا به بهترین شیوه راهی برای برقراری ارتباط با سایر برنامه‌ها و ارسال و دریافت داده‌های چندرسانه‌ای در صورت نبود مسیر مستقیم، پیدا کنند. توصیه می‌شود قبل از ارائه سایر سرویس‌های RTC که برای کاربر نهایی طراحی شده‌اند، سرور TURN راه‌اندازی شود.</para>
      <indexterm><primary>TURN</primary><secondary>سرور</secondary></indexterm>

      <para>پروتکل TURN و ICE از جمله استانداردهای باز به حساب می‌آیند. به منظور بهره‌گیری از این پروتکل‌ها، برای ارتباط حداکثری و پیچیدگی حداقلی، اطمینان از اینکه تمام برنامه‌ها از ICE و TURN پشتیبانی می‌کنند، از اهمیت بالایی برخوردار است.</para>
      <indexterm><primary>ICE</primary></indexterm>

      <para>به منظور کارآیی بهتر الگوریتم ICE، سرور باید حداقل دو نشانی IPv4 عمومی داشته باشد.</para>
      <section id="sect.turn-server-install">
        <title>نصب سرور TURN</title>
        <para>نصب بسته <emphasis role="pkg">resiprocate-turn-server</emphasis></para>

        <para>فایل پیکربندی <filename>/etc/reTurn/reTurnServer.config</filename> را ویرایش کنید. یکی از مهم‌ترین کارها درج نشانی‌های IP سرور است.</para>

<programlisting>
# your IP addresses go here:
TurnAddress = 198.51.100.19
TurnV6Address = 2001:DB8:1000:2000::19
AltStunAddress = 198.51.100.20
# your domain goes here, it must match the value used
# to hash your passwords if they are already hashed
# using the HA1 algorithm:
AuthenticationRealm = myrealm

UserDatabaseFile = /etc/reTurn/users.txt
UserDatabaseHashedPasswords = true</programlisting>

        <para>راه‌اندازی سرویس</para>
      </section>
      <section id="sect.turn-server-management">
        <title>مدیریت کاربران TURN</title>
        <para>استفاده از ابزار htdigest برای مدیریت فهرست کاربران سرور TURN.</para>
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/reTurn/users.txt myrealm joe</userinput></screen>
        <para>پس از تغییر فایل <filename>/etc/reTurn/users.txt</filename> یا فعال‌سازی ویژگی بازنشانی خودکار در <filename>/etc/reTurn/reTurnServer.config</filename>، از سیگنال HUP استفاده کنید تا سرور مجبور شود آن را بازنشانی کند.</para>
      </section>
    </section>

    <section id="sect.sip-server">
      <title>سرور پروکسی SIP</title>

      <para>یک سرور پروکسی SIP ارتباطات دریافتی و ارسالی بین سایر سازمان‌های SIP، فراهم‌کنندگان سرویس SIP، PBXهایی مانند Asterisk، تلفن‌های SIP و برنامه‌های WebRTC را مدیریت می‌کند.</para>
      <indexterm><primary>SIP</primary><secondary>سرور</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>پروکسی</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>PBX</secondary></indexterm>
      <indexterm><primary>SIP</primary><secondary>trunk</secondary></indexterm>

      <para>به شدت توصیه می‌شود که قبل از راه‌اندازی SIP PBX ابتدا پروکسی آن را پیکربندی کنید. پروکسی SIP بسیاری از ترافیک دریافتی PBX را نرمال‌سازی می‌کند تا ارتباط و انعطاف‌پذیری بیشتری حاصل گردد.</para>

      <section id="sect.sip-server-install">
        <title>نصب پروکسی SIP</title>
        <para>بسته <emphasis role="pkg">repro</emphasis> را نصب کنید. استفاده از بسته موجود در <emphasis role="distribution">jessie-backports</emphasis> توصیه می‌شود چرا که شامل آخرین بهینه‌سازی‌های مربوطه است.</para>
        <indexterm><primary>repro</primary></indexterm>

        <para>فایل پیکربندی <filename>/etc/repro/repro.config</filename> را ویرایش کنید. مهم‌ترین کار درج نشانی‌های IP سرور است. نمونه زیر چگونگی پیکربندی SIP به صورت عمومی و کاربرد WebRTC را با استفاده از TLS، IPv4 و IPv6 نشان می‌دهد:</para>

<programlisting>
# Transport1 will be for SIP over TLS connections
# We use port 5061 here but if you have clients connecting from
# locations with firewalls you could change this to listen on port 443
Transport1Interface = 198.51.100.19:5061
Transport1Type = TLS
Transport1TlsDomain = falcot.com
Transport1TlsClientVerification = Optional
Transport1RecordRouteUri = sip:falcot.com;transport=TLS
Transport1TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport1TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport2 is the IPv6 version of Transport1
Transport2Interface = 2001:DB8:1000:2000::19:5061
Transport2Type = TLS
Transport2TlsDomain = falcot.com
Transport2TlsClientVerification = Optional
Transport2RecordRouteUri = sip:falcot.com;transport=TLS
Transport2TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport2TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport3 will be for SIP over WebSocket (WebRTC) connections
# We use port 8443 here but you could use 443 instead
Transport3Interface = 198.51.100.19:8443
Transport3Type = WSS
Transport3TlsDomain = falcot.com
# This would require the browser to send a certificate, but browsers
# don't currently appear to be able to, so leave it as None:
Transport3TlsClientVerification = None
Transport3RecordRouteUri = sip:falcot.com;transport=WSS
Transport3TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport3TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport4 is the IPv6 version of Transport3
Transport4Interface = 2001:DB8:1000:2000::19:8443
Transport4Type = WSS
Transport4TlsDomain = falcot.com
Transport4TlsClientVerification = None
Transport4RecordRouteUri = sip:falcot.com;transport=WSS
Transport4TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport4TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport5: this could be for TCP connections to an Asterisk server
# in your internal network.  Don't allow port 5060 through the external
# firewall.
Transport5Interface = 198.51.100.19:5060
Transport5Type = TCP
Transport5RecordRouteUri = sip:198.51.100.19:5060;transport=TCP

HttpBindAddress = 198.51.100.19, 2001:DB8:1000:2000::19
HttpAdminUserFile = /etc/repro/users.txt

RecordRouteUri = sip:falcot.com;transport=tls
ForceRecordRouting = true
EnumSuffixes = e164.arpa, sip5060.net, e164.org
DisableOutbound = false
EnableFlowTokens = true
EnableCertificateAuthenticator = True</programlisting>

        <para>از ابزار <command>htdigest</command> استفاده کرده تا گذرواژه مدیر برای رابط مبتنی بر وب را مدیریت کنید. نام‌کاربری باید <emphasis>admin</emphasis> باشد و نام قلمرو آن باید با آنچه در <filename>repro.config</filename> موجود است مطابقت کند.</para>

<screen><computeroutput># </computeroutput><userinput>htdigest /etc/repro/users.txt repro admin</userinput></screen>

        <para>سرویس را راه‌اندازی مجدد کنید تا از پیکربندی جدید استفاده کند.</para>
      </section>
      <section id="sect.sip-server-management">
        <title>مدیریت پروکسی SIP</title>
        <para>با استفاده از رابط مبتنی بر وب واقع در <literal>http://sip-proxy.falcot.com:5080</literal> پیکربندی را با افزودن دامنه‌ها، کاربران محلی و مسیرهای ایستا کامل کنید.</para>

        <para>گام اول افزودن دامنه محلی است. پس از افزودن یا حذف دامنه‌ها به/از فهرست، فرآیند باید راه‌اندازی مجدد گردد.</para>

        <para>پروکسی می‌داند چطور تماس‌ها را بین کاربران محلی و نشانی کامل SIP مسیریابی کند، بنابراین پیکربندی مسیریابی تنها برای تغییر این عملکرد پیشفرض مورد نیاز است. برای نمونه، به منظور افزودن شماره تلفن‌ها، پیشوند آن‌ها و مسیریابی از طریق یک فراهم‌کننده SIP.</para>
      </section>
    </section>

    <section id="sect.xmpp-server">
      <title>سرور XMPP</title>

      <para>سرور XMPP ارتباط بین کاربران محلی و سایر کاربران XMPP در دامنه‌های عمومی اینترنت را مدیریت می‌کند.</para>
      <indexterm><primary>XMPP</primary><secondary>سرور</secondary></indexterm>

      <sidebar>
        <title><emphasis>واژگان</emphasis> XMPP یا Jabber؟</title>
        <indexterm><primary>Jabber</primary></indexterm>

        <para>XMPP گاهی اوقات با نام Jabber نیز شناخته می‌شود. در حقیقت، Jabber یک نشانی تجاری ثبت شده برای استاندارد XMPP است.</para>
        <indexterm><primary>Jabber</primary></indexterm>
      </sidebar>

      <para>Prosody یک سرور محبوب XMPP است که قابلیت اعتماد بالایی در سرورهای دبیان دارد.</para>
      <indexterm><primary>Prosody</primary></indexterm>
      <section id="sect.xmpp-server-install">
        <title>نصب سرور XMPP</title>
        <para>بسته <emphasis role="pkg">prosody</emphasis> را نصب کنید. استفاده از بسته موجود در <emphasis role="distribution">jessie-backports</emphasis> توصیه می‌شود چرا که شامل آخرین بهینه‌سازی‌های مربوطه است.</para>
        <indexterm><primary>Prosody</primary></indexterm>

        <para>فایل پیکربندی <filename>/etc/prosody/prosody.cfg.lua</filename> را مرور کنید. مهم‌ترین کار درج UID کاربرانی است که مجاز به مدیریت سرور هستند.</para>

<programlisting>
admins = { "joe@falcot.com" }</programlisting>

        <para>برای هر دامنه به یک فایل پیکربندی جداگانه نیاز است. از فایل نمونه <filename>/etc/prosody/conf.avail/example.com.cfg.lua</filename> به عنوان نقطه آغاز پیکربندی استفاده کنید. در اینجا <literal>falcot.com.cfg.lua</literal> آورده شده است:</para>

<programlisting>
VirtualHost "falcot.com"
        enabled = true
        ssl = {
                key = "/etc/ssl/private/falcot.com-key.pem";
                certificate = "/etc/ssl/public/falcot.com.pem";
                }</programlisting>

        <para>برای فعال‌سازی دامنه، یک پیوند نمادین از <filename>/etc/prosody/conf.d/</filename> باید موجود باشد. به این صورت آن را ایجاد کنید:</para>

<screen><computeroutput># </computeroutput><userinput>ln -s /etc/prosody/conf.avail/falcot.com.cfg.lua /etc/prosody/conf.d/</userinput></screen>

        <para>سرویس را راه‌اندازی مجدد کنید تا از پیکربندی جدید استفاده کند.</para>
      </section>
      <section id="sect.xmpp-server-management">
        <title>مدیریت سرور XMPP</title>
        <para>برخی عملیات مدیریتی با استفاده از ابزار خط-فرمان <literal>prosodyctl</literal> قابل اجرا هستند. برای نمونه، به منظور افزودن حساب کاربری مدیر که در <filename>/etc/prosody/prosody.cfg.lua</filename> تعریف شده است.</para>
<programlisting>
# prosodyctl adduser joe@falcot.com</programlisting>

        <para><ulink url="http://prosody.im/doc/configure">مستندات آنلاین Prosody</ulink> را به منظور جزئیات بیشتر درباره سفارشی‌کردن پیکربندی مشاهده کنید.</para>

      </section>

    </section>
    <section id="sect.rtc-port-443">
      <title>اجرای سرویس‌ها روی درگاه ۴۴۳</title>
      <para>برخی مدیرسیستم‌ها ترجیح می‌دهند که تمام سرویس‌های RTC روی درگاه ۴۴۳ اجرا شوند. این امر به کاربرانی که از مکان‌های راه‌دور مانند هتل‌ها یا فرودگاه‌ها قصد ارتباط دارند اجازه می‌دهد که در صورت مسدود بودن سایر درگاه‌ها یا مسیریابی ترافیک اینترنت از طریق سرورهای پروکسی HTTP، به سرویس مورد نظر خود دسترسی داشته باشند.</para>

      <para>برای استفاده از این راهبرد، هر سرویس (SIP، XMPP و TURN ) نیازمند یک نشانی IP متفاوت است. تمام سرویس‌ها می‌توانند روی یک میزبان قرار گیرند چرا که لینوکس از نشانی‌های IP گوناگون در یک رایانه پشتیبانی می‌کند. درگاه ۴۴۳ باید در فایل پیکربندی هر سرویس و رکوردهای SRV مربوط به DNS درج گردد.</para>
    </section>
    <section id="sect.rtc-webrtc">
      <title>افزودن WebRTC</title>

      <para>فالکوت می‌خواهد به مشتریان خود اجازه دهد که از طریق وبسایت اقدام به برقراری تماس تلفنی کنند. مدیرسیستم‌های فالکوت همچنین می‌خواهند از WebRTC به عنوان بخشی از طرح بازیابی در موقع اضطرار استفاده کنند، تا کارکنان بتوانند از خانه خود با استفاده از مرورگر وب به سیستم تلفنی شرکت دسترسی داشته باشند، در زمان اضطرار.</para>
      <indexterm><primary>WebRTC</primary></indexterm>
      <indexterm><primary>SIP</primary><secondary>WebSockets</secondary></indexterm>

      <sidebar>
        <title><emphasis>در عمل</emphasis> WebRTC را امتحان کنید</title>
        <indexterm><primary>WebRTC</primary><secondary>نمونه</secondary></indexterm>

        <para>اگر تاکنون WebRTC را امتحان نکرده‌اید سایت‌های زیادی وجود دارند که ویژگی‌های آن را به شما نمایش می‌دهند. <ulink type="block" url="http://www.sip5060.net/test-calls" /></para>        
      </sidebar>

      <para>WebRTC یک فناوری رو به رشد است و استفاده از بسته‌های موجود در توزیع‌های <emphasis role="distribution">jessie-backports</emphasis> و <emphasis role="distribution">Testing</emphasis> امری ضروری به حساب می‌آید.</para>

      <para>JSCommunicator یک تلفن مبتنی بر WebRTC است که به هیچ اقدام سمت-سرور از جمله PHP نیاز ندارد. این ابزار به صورت انحصاری توسط HTML، CSS و JavaScript تولید شده است که پایه و اساس بسیاری از افزونه‌های WebRTC و چارچوب‌های نرم‌افزاری مبتنی بر وب به حساب می‌آید. <ulink type="block" url="http://jscommunicator.org" /></para>
      <indexterm><primary>JSCommunicator</primary></indexterm>

      <para>بسته <emphasis role="pkg">jscommunicator-web-phone</emphasis> یکی از ساده‌ترین روش‌های نصب تلفن WebRTC روی یک وبسایت است. این بسته نیازمند یک پروکسی SIP همراه با انتقال WebSocket است. توضحیات داخل <xref linkend="sect.sip-server-install" /> شامل جزئیات لازم برای راه‌اندازی انتقال WebSocket درون پروکسی SIP <emphasis role="pkg">repro</emphasis> است.</para>

      <para>پس از نصب <emphasis role="pkg">jscommunicator-web-phone</emphasis>، راه‌های مختلفی برای استفاده از آن وجود دارد. یک راهبرد ساده رونوشت گرفتن از فایل پیکربندی <filename>/etc/jscommunicator-web-phone/apache.conf</filename> درون پیکربندی گروه مجازی آپاچی است.</para>

      <para>زمانی که فایل‌های تلفن-وب در سرور موجود باشند، با سفارشی‌کردن <filename>/etc/jscommunicator-web-phone/config.js</filename> و اشاره به سرور TURN و پروکسی SIP، پیکربندی را انجام دهید. برای نمونه:</para>

<programlisting>
JSCommSettings = {

  // Web server environment
  webserver: {
    url_prefix: null            // If set, prefix used to construct sound/ URLs
  },

  // STUN/TURN media relays
  stun_servers: [],
  turn_servers: [
    { server:"turn:turn-server.falcot.com?transport=udp", username:"joe", password:"j0Ep455d" }
  ],

  // WebSocket connection
  websocket: {
      // Notice we use the falcot.com domain certificate and port 8443
      // This matches the Transport3 and Transport4 example in
      // the falcot.com repro.config file
    servers: 'wss://falcot.com:8443',
    connection_recovery_min_interval: 2,
    connection_recovery_max_interval: 30
  },

  ...</programlisting>

      <para>وبسایت‌های پیشرفته‌تر از اسکریپت‌های سمت-سرور به منظور تولید فایل <literal>config.js</literal> به صورت پویا استفاده می‌کنند. سورس کد <ulink url="http://drucall.org">DruCall</ulink> چگونگی استفاده از آن در PHP را نمایش می‌دهد.</para>
      <indexterm><primary>DruCall</primary></indexterm>

      <para>این فصل به بررسی تنها قسمتی از نرم‌افزار سرور پرداخت؛ اگرچه، اکثر سرویس‌های متداول شبکه توضیح داده شدند. اکنون زمان بررسی یک فصل فنی‌تر فرا رسیده است. اکنون به بررسی مفاهیم مجازی‌سازی و جزئیات پیاده‌سازی آن می‌پردازیم.</para>

    </section>
  </section>
</chapter>
