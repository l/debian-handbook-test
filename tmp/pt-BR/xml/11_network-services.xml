<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="network-services" lang="pt-BR">
	<chapterinfo>
		 <keywordset>
			<keyword>Postfix</keyword>
			 <keyword>Apache</keyword>
			 <keyword>NFS</keyword>
			 <keyword>Samba</keyword>
			 <keyword>Squid</keyword>
			 <keyword>OpenLDAP</keyword>
			 <keyword>SIP</keyword>

		</keywordset>

	</chapterinfo>
	 <title>Serviços de Rede: Postfix, Apache, NFS, Samba, Squid, LDAP, SIP, XMPP, TURN</title>
	 <highlights> <para>
		Serviços de rede são programas que os usuários interagem diretamente no seu dia-a-dia. Eles são a ponta do icebergue da informação, e este capítulo foca neles; as partes escondidas nas quais eles dependem são a infraestrutura que nós já descrevemos.
	</para>
	 <para>
		Muitos serviços de rede modernos requerem uma tecnologia de criptografia para operar de maneira confiável e segura, especialmente quando usados em internet pública. Certificados X.509 ( que também podem ser referenciados como Certificados SSL ou Certificados TLS) são usados para esse propósito com frequência. Um certificado para um domínio específico pode às vezes ser compartilhado entre mais de um dos serviços discutidos neste capítulo.
	</para>
	 <indexterm>
		<primary>TLS</primary>
	</indexterm>
	 <indexterm>
		<primary>X.509</primary>
	</indexterm>
	 <indexterm>
		<primary>Certificados</primary>
	</indexterm>
	 </highlights> <section id="sect.smtp-mail-server">
		<title>Servidor de Correio Eletrônico</title>
		 <para>
			Os administradores da Falcot Corp selecionaram o Postfiz como servidor de correio eletrônico, devido a sua confiabilidade e fácil configuração. De fato, seu projeto reforça que cada tarefa é implementada em um processo com um conjunto mínimo de permissões, que é uma medida de mitigação contra problemas de segurança.
		</para>
		 <indexterm>
			<primary>correio</primary>
			<secondary>servidor de</secondary>
		</indexterm>
		 <indexterm>
			<primary>servidor de correio eletrônico</primary>
		</indexterm>
		 <indexterm>
			<primary>Postfix</primary>
		</indexterm>
		 <sidebar> <title><emphasis>ALTERNATIVA</emphasis> O servidor Exim4</title>
		 <indexterm>
			<primary>Exim</primary>
		</indexterm>
		 <para>
			O Debian utiliza os Exim4 como o servidor de e-mail padrão (eis o porque da instalação inicial incluir o Exim4). A configuração é provida por um pacote diferente, <emphasis role="pkg">exim4-config</emphasis>, e automaticamente customizado baseado nas respostas de um conjunto de questões no Debconf muito similar as questões feitas pelo pacote <emphasis role="pkg">postfix</emphasis>.
		</para>
		 <para>
			A configuração pode ser tanto em um único arquivo (<filename>/etc/exim4/exim4.conf.template</filename>) ou divido em alguns trechos de configuração armazenados em <filename>/etc/exim4/conf.d/</filename>. Em ambos os casos, os arquivos são usados pelo <command>update-exim4.conf</command> como modelo para gerar o <filename>/var/lib/exim4/config.autogenerated</filename>. Este último é utilizado pelo Exim4. Graças ao seu mecanismo, os valores obtidos através da configuração debconf do Exim - que é armazenado em <filename>/etc/exim4/update-exim4.conf.conf</filename> - pode ser injetado no arquivo de configuração do Exim, mesmo quando o administrador ou outro pacote alterou a configuração padrão do Exim.
		</para>
		 <para>
			A sintaxe do arquivo de configuração do Exim4 tem suas particularidades e sua curva de aprendizado, contudo, uma vez que essas particularidades são compreendidas, o Exim4 se torna um servidor de e-mail muito completo e poderoso, como evidenciado pelas suas muitas páginas de documentação. <ulink type="block" url="http://www.exim.org/docs.html" />
		</para>
		 </sidebar> <section>
			<title>Instalando o Postfix</title>
			 <para>
				O pacote <emphasis role="pkg">postfix</emphasis> incluí um o daemon SMTP principal. Outros pacotes (como o <emphasis role="pkg">postfix-ldap</emphasis> e <emphasis role="pkg">postfix-pgsql</emphasis>) adicionam funcionalidades extras ao Postfix, incluindo acesso a bancos de dados. Você só deve instalá-los se souber que precisa dos mesmos.
			</para>
			 <sidebar id="sidebar.smtp"> <title><emphasis>DE VOLTA AO BÁSICO</emphasis> SMTP</title>
			 <indexterm>
				<primary>SMTP</primary>
			</indexterm>
			 <indexterm>
				<primary>Protocolo Simples para Transferência de Correio</primary>
			</indexterm>
			 <indexterm>
				<primary>server</primary>
				<secondary>SMTP</secondary>
			</indexterm>
			 <para>
				SMTP (<emphasis>Protocolo Simples para Transferência de Correio</emphasis>) é um protocolo usado por servidores de e-mail para intercambiar e rotear e-mails.
			</para>
			 </sidebar> <para>
				Diversas questões Debconf são feitas durante o processo de instalação do pacote. As respostas permitem gerar a primeira versão do arquivo de configuração <filename>/etc/postfix/main.cf</filename>.
			</para>
			 <para>
				A primeira pergunta é sobre qual o tipo de instalação. Apenas duas das respostas propostas são relevantes no caso de um servidor conectado à Internet , "site de Internet" e "Internet com smarthost". O primeiro é apropriado para um servidor que recebe e-mails entrantes e envia e-mails saintes diretamente aos seus destinatários, e portanto é se adapta bem ao caso da Falcot Corp . o último é apropriado para um servidor que recebe e-mails recebidos normalmente, mas que envia e-mails saintes através de um servidor SMTP intermediário - o "smarthost" - ao invés de diretamente para o servidor do destinatário . Isto é útil para os indivíduos com um endereço IP dinâmico , uma vez que muitos servidores de e-mail rejeitam mensagens diretas do referido endereço IP. Neste caso, o smarthost será geralmente o servidor SMTP do ISP, que é sempre configurado para aceitar e-mail proveniente de clientes do ISP e transmiti-los de forma adequada. Esta configuração (com um smarthost) também é relevante para os servidores que não estão permanentemente conectados à internet, uma vez que se evita ter de gerenciar uma fila de mensagens não entregues que precisam ser repetida mais tarde.
			</para>
			 <sidebar> <title><emphasis>VOCABULÁRIO</emphasis> ISP</title>
			 <indexterm>
				<primary>ISP, Provedor de Internet</primary>
			</indexterm>
			 <para>
				ISP é acrônico para "Internet Service Provider" (Provedor de Serviços de Internet). Isto cobre uma entidade, normalmente uma empresa, que provê conexões a internet e seus serviços básicos associados (e-mail, notícias e assim por diante).
			</para>
			 <para>
			</para>
			 </sidebar> <para>
				A segunda questão diz respeito ao nome completo da máquina, utilizada para gerar os endereços de e-mail a partir de um nome de usuário local; o nome completo da máquina acaba como a parte após o arroba ("@"). No caso da Falcot, a resposta deveria ser <literal>mail.falcot.com</literal>. Esta é a única pergunta feita por padrão, mas a configuração gerada não é completa o suficiente para as necessidades de Falcot, razão pela qual os administradores executam o <command>dpkg-reconfigure postfix</command>, para personalizar mais parâmetros.
			</para>
			 <para>
				Uma das questões extras pede para todos os nomes de domínio relacionados com esta máquina. A lista padrão inclui o seu nome completo, bem como alguns sinônimos para <literal>localhost</literal>, mas o principal domínio <literal>falcot.com</literal> precisa ser adicionado manualmente. De modo geral, esta questão deve ser respondida normalmente com todos os nomes de domínio para que esta máquina deve servir como um servidor MX; em outras palavras, todos os nomes de domínio para o qual o DNS diz que esta máquina vai aceitar e-mail. Esta informação acaba na variável <literal>mydestination</literal> do principal arquivo de configuração do Postfix - <filename>/etc/postfix/main.cf</filename>.
			</para>
			 <indexterm>
				<primary>servidor</primary>
				<secondary>MX</secondary>
			</indexterm>
			 <indexterm>
				<primary>MX</primary>
				<secondary>servidor</secondary>
			</indexterm>
			 <figure>
				<title>Papel do registro <emphasis>MX</emphasis> no DNS ao enviar um e-mail</title>
				 <mediaobject>
					<imageobject>
						<imagedata fileref="images/mail-server.png" format="PNG" scalefit="1" width="60%" />
					</imageobject>

				</mediaobject>

			</figure>
			 <sidebar> <title><emphasis>EXTRA</emphasis> Consultando os registros MX</title>
			 <para>
				Quando o DNS não contém um registro MX para o domínio, o servidor e-mail tentará enviar as mensagens para o hospedeiro em si, usando o registro correspondente A (ou AAAA em IPv6).
			</para>
			 </sidebar> <para>
				Em alguns casos, a instalação pode perguntar quais redes devem ser permitidas a enviar e-mail usando a máquina. Em sua configuração padrão, o Postfix somente aceita e-mails vindo da máquina em si, a rede local normalmente será adicionada. Os administradores da Falcot Corp adicionaram <literal>192.168.0.0/16</literal> na pergunta padrão. Se a questão não é feita, a variável relevante no arquivo de configuração é <literal>mynetworks</literal>, como visto no exemplo abaixo.
			</para>
			 <para>
				E-mails locais podem ser enviados através do comando <command>procmail</command>. Esta ferramenta permite aos usuários organizarem seus e-mail de entrada de acordo com a regras armazenadas em seu arquivo <filename>~/.procmailrc</filename>.
			</para>
			 <indexterm>
				<primary><command>procmail</command></primary>
			</indexterm>
			 <indexterm>
				<primary>e-mail</primary>
				<secondary>filtrando</secondary>
			</indexterm>
			 <indexterm>
				<primary>filtrando e-mails</primary>
			</indexterm>
			 <para>
				Após este primeiro passo, os administradores conseguiram o seguinte arquivo de configuração; ele será usado como ponto de partida para adicionarmos funcionalidades extras nas próximas seções.
			</para>
			 <example>
				<title>Arquivo inicial <filename>/etc/postfix/main.cf</filename></title>
				 
<programlisting>
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# TLS parameters
smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_use_tls=yes
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache

# See /usr/share/doc/postfix/TLS_README.gz in the postfix-doc package for
# information on enabling SSL in the smtp client.

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
myhostname = mail.falcot.com
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = /etc/mailname
mydestination = mail.falcot.com, falcot.com, localhost.localdomain, localhost
relayhost = 
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128 192.168.0.0/16
mailbox_command = procmail -a "$EXTENSION"
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all
inet_protocols = all</programlisting>

			</example>
			 <sidebar> <title><emphasis>SEGURANÇA</emphasis> Certificados SSL <emphasis>Snake oil</emphasis></title>
			 <para>
				Os certificados <emphasis>óleo de cobra</emphasis> (snake oil), como o "remédio" <emphasis>óleo de cobra</emphasis> vendido por charlatães sem escrúpulos nos velhos tempos, não tem absolutamente nenhum valor, você não pode se basear neles para autenticar o servidor já que eles são certificados auto-assinados automaticamente gerados. Contudo, eles são úteis para aprimorar a privacidade de intercâmbios.
			</para>
			 <para>
				Em geral, eles só devem ser usados para fins de teste e, o serviço normal deve utilizar certificados reais; estes podem ser gerados com o procedimento descrito no <xref linkend="sect.easy-rsa" />.
			</para>
			 </sidebar>
		</section>
		 <section id="sect.configuring-virtual-domains">
			<title>Configurando Domínios Virtuais</title>
			 <indexterm>
				<primary>domínio</primary>
				<secondary>virtual</secondary>
			</indexterm>
			 <indexterm>
				<primary>domínio virtual</primary>
			</indexterm>
			 <para>
				O servidor de e-mails pode receber e-mails de outros domínios além do domínio principal; estes são conhecidos como domínios virtuais. Na maioria dos casos quando isto ocorre, os e-mails não ultimamente destinados aos usuários locais. O Postfix provê duas funcionalidades interessantes para manipular domínios virtuais.
			</para>
			 <sidebar> <title><emphasis>ATENÇÃO</emphasis> Domínios virtuais e domínios canônicos</title>
			 <para>
				Nenhum dos domínios virtuais deve ser referenciado na variável <literal>mydestination</literal>; está variável somente contém os nomes "canônicos" dos domínios diretamente associados a máquina e seus usuários locais.
			</para>
			 </sidebar> <section>
				<title>Alias de domínios virtuais</title>
				 <indexterm>
					<primary>aliás</primary>
					<secondary>alias de domínio virtual</secondary>
				</indexterm>
				 <indexterm>
					<primary>domínio virtual</primary>
					<secondary>alias de domínio virtual</secondary>
				</indexterm>
				 <para>
					Um alias de domínio virtual contém somente aliases, isto é, endereços que encaminham unicamente os e-mails para outros endereços.
				</para>
				 <para>
					Tal domínio é ativado ao se adicionar seu nome a variável <literal>virtual_alias_domains</literal>, e referenciar um arquivo de mapa de endereços a variável <literal>virtual_alias_maps</literal>.
				</para>
				 <example>
					<title>Diretivas para serem adicionadas no arquivo <filename>/etc/postfix/main.cf</filename></title>
					 
<programlisting>
virtual_alias_domains = falcotsbrand.com
virtual_alias_maps = hash:/etc/postfix/virtual</programlisting>

				</example>
				 <para>
					O arquivo <filename>/etc/postfix/virtual</filename> descreve o mapeamento com uma sintaxe bastante simples: cada linha contém dois campos separados por espaços em branco; o primeiro campo é o nome do alias, o segundo campo é uma lista de endereços de e-mail onde ele redireciona. A sintaxe especial <literal>@domain.com</literal> abrange todos os aliases restantes em um domínio.
				</para>
				 <example>
					<title>Arquivo de exemplo <filename>/etc/postfix/virtual</filename></title>
					 
<programlisting>
webmaster@falcotsbrand.com  jean@falcot.com
contact@falcotsbrand.com    laure@falcot.com, sophie@falcot.com
# The alias below is generic and covers all addresses within 
# the falcotsbrand.com domain not otherwise covered by this file.
# These addresses forward email to the same user name in the
# falcot.com domain.
@falcotsbrand.com           @falcot.com</programlisting>

				</example>

			</section>
			 <section>
				<title>Domínios Virtuais de Caixa de Correio</title>
				 <sidebar> <title><emphasis>ATENÇÃO</emphasis> Domínio virtual combinado?</title>
				 <para>
					O Postfix não permitir o uso do mesmo domínio, tanto <literal>virtual_alias_domains</literal> e <literal>virtual_mailbox_domains</literal>. No entanto, todos os domínios da <literal>virtual_mailbox_domains</literal> está implicitamente incluído no <literal>virtual_alias_domains</literal>, o que torna possível misturar aliases e caixas de correio dentro de um domínio virtual.
				</para>
				 </sidebar> <indexterm>
					<primary>domínio virtual de caixas de correio</primary>
				</indexterm>
				 <indexterm>
					<primary>domínio virtual</primary>
					<secondary>domínio virtual de caixas de correio</secondary>
				</indexterm>
				 <para>
					As mensagens endereçadas a um domínio de caixa de correio virtual são armazenadas em caixas de correio não atribuídos a um usuário do sistema local.
				</para>
				 <para>
					Ativando um domínio de caixa de correio virtual requer nomear este domínio na variável <literal>virtual_mailbox_domains</literal>, e referenciar um arquivo de mapeamento de caixa de correio no <literal>virtual_mailbox_maps</literal>. O parâmetro <literal>virtual_mailbox_base</literal> contém o diretório sob o qual as caixas de correio serão armazenadas.
				</para>
				 <para>
					O parâmetro <literal>virtual_uid_maps</literal> (<literal>virtual_gid_maps</literal> respectivamente) faz referência ao arquivo que contém o mapeamento entre o endereço de e-mail e o usuário do sistema (grupo respectivamente) que "possui" a caixa correspondente. Para obter todas as caixas de correio de propriedade do mesmo dono/grupo, a sintaxe <literal>static:5000</literal> atribui um UID/GID fixo (de valor 5000 aqui).
				</para>
				 <example>
					<title>Diretivas para serem adicionadas no arquivo <filename>/etc/postfix/main.cf</filename></title>
					 
<programlisting>
virtual_mailbox_domains = falcot.org
virtual_mailbox_maps = hash:/etc/postfix/vmailbox
virtual_mailbox_base = /var/mail/vhosts</programlisting>

				</example>
				 <para>
					Novamente, a sintaxe do arquivo <filename>/etc/postfix/vmailbox</filename> é bastante simples: dois campos separados por espaço em branco. O primeiro campo é um endereço de e-mail dentro de um dos domínios virtuais, e o segundo campo é a localização da caixa de correio associada (relativo ao diretório especificado no <emphasis>virtual_mailbox_base</emphasis>). Se o nome da caixa de correio termina com uma barra (<literal>/</literal>), os e-mails serão armazenados no formato <emphasis>maildir</emphasis>; caso contrário, o tradicional formato <emphasis> mbox</emphasis> será usado. O formato <emphasis>maildir</emphasis> usa um diretório inteiro para armazenar a caixa de correio, cada mensagem que está sendo armazenada em um arquivo separado. No formato <emphasis>mbox</emphasis>, por outro lado, toda a caixa de correio é armazenado em um arquivo, e cada linha começando com "<literal>De </literal>" (<literal>De</literal> seguido de um espaço) indica o início de uma nova mensagem.
				</para>
				 <example>
					<title>O arquivo <filename>/etc/postfix/vmailbox</filename></title>
					 
<programlisting>
# Os e-mails de Jean são armazenados como maildir, com
# um arquivo por e-mail em um diretório dedicado
jean@falcot.org falcot.org/jean/
# Os e-mails de Sophie são armazenados em um arquivo tradicional "mbox",
# com todos os e-mails concatenados em um arquivo único
sophie@falcot.org falcot.org/sophie</programlisting>

				</example>

			</section>

		</section>
		 <section id="sect.restrictions-for-receiving-and-sending">
			<title>Restrições para Recebimento e Envio</title>
			 <para>
				O crescente número de e-mails em massa não solicitados (<emphasis>spams</emphasis>) requer cada vez ser mais rigoroso ao decidir quais e-mails um servidor deve aceitar. Esta seção apresenta algumas das estratégias incluídas no Postfix.
			</para>
			 <sidebar> <title><emphasis>CULTURA</emphasis> O problema do spam</title>
			 <indexterm>
				<primary>spam</primary>
			</indexterm>
			 <para>
				"Spam" é um termo genérico usado para designar todos os e-mails comerciais não solicitadas (também conhecidas como UCEs) que inundam nossas caixas de correio eletrônico; indivíduos sem escrúpulos que os enviam são conhecidos como spammers. Eles pouco se importam com o incômodo que causam já que os custos de envio de e-mail custa muito pouco e precisam somente atrair para suas ofertas uma percentagem muito pequena de quem os recebe para que a operação de spam gere mais dinheiro do que custa. O processo é praticamente todo automatizado, e qualquer endereço de e-mail tornado público (por exemplo, em um fórum na web, ou nos arquivos de uma lista de discussão, ou em um blog, e assim por diante) será descoberto pelos robôs dos spammers, e submetido para um fluxo interminável de mensagens não solicitadas.
			</para>
			 <para>
				Todos os administradores de sistema tentam enfrentar esse incômodo com filtros de spam, mas os spammers, claro, mantém os ajustes para tentar contornar esses filtros. Alguns até mesmo alugam redes de máquinas comprometidas por um worm de vários sindicatos do crime. Estatísticas recentes estimam que até 95% de todos os e-mails que circulam na Internet são spam!
			</para>
			 </sidebar> <section>
				<title>Restrições de Acesso Baseados no IP</title>
				 <para>
					A diretiva <literal>smtpd_client_restrictions</literal> controla quais máquinas tem permissão para se comunicar com o servidor de e-mail.
				</para>
				 <example>
					<title>Restrições Baseadas no Endereço do Cliente</title>
					 
<programlisting>
smtpd_client_restrictions = permit_mynetworks,
    warn_if_reject reject_unknown_client,
    check_client_access hash:/etc/postfix/access_clientip,
    reject_rbl_client sbl-xbl.spamhaus.org,
    reject_rbl_client list.dsbl.org</programlisting>

				</example>
				 <para>
					Quando uma variável contém uma lista de regras, como no exemplo acima, essas regras são avaliadas em ordem, desde a primeira até a última. Cada regra pode aceitar a mensagem, rejeitá-la, ou deixar a decisão para a seguinte regra. Como consequência, a ordem importa e simplesmente mudar duas regras pode levar a um comportamento completamente diferente.
				</para>
				 <para>
					A diretiva <literal>permit_mynetworks</literal>, usada como primeira regra, aceita e-mails vindos de uma máquina na rede local (como definido na variável de configuração <emphasis>mynetworks</emphasis>).
				</para>
				 <para>
					A segunda diretiva normalmente rejeitaria e-mails provenientes de máquinas sem uma configuração de DNS completamente válido. Tal configuração válida significa que o endereço IP pode ser resolvida para um nome, e que esse nome, por sua vez, resolve o endereço IP. Essa restrição é muitas vezes demasiada rigorosa, uma vez que muitos servidores de e-mail não tem um DNS reverso para o seu endereço IP. Isso explica por que os administradores da Falcot prefixaram o modificador <literal>warn_if_reject</literal> para a diretiva <literal>reject_unknown_client</literal>: este modificador transforma a rejeição em uma simples advertência registrada nos logs. Os administradores podem, em seguida, manter um olho sobre o número de mensagens que seriam rejeitadas se a regra fosse realmente cumprida, e tomar uma decisão informada mais tarde, se quiser ativar essa aplicação.
				</para>
				 <sidebar> <title><emphasis>DICA</emphasis> tabelas de <emphasis>acesso</emphasis></title>
				 <para>
					Os critérios de restrição incluem tabelas administrativas modificáveis listando combinações de remetentes, endereços IP e nomes de host permitidos ou proibidos. Essas tabelas podem ser criadas a partir de uma cópia descompactada do <filename>/usr/share/doc/postfix-doc/examples/access.gz</filename>. Este modelo é auto-documentado em suas observações, o que significa que cada tabela descreve sua própria sintaxe.
				</para>
				 <para>
					A tabela <filename>/etc/postfix/access_clientip</filename> lista os endereços IP e redes; <filename>/etc/postfix/access_helo</filename> lista nomes de domínio; <filename>/etc/postfix/access_sender</filename> contém endereços de e-mail do remetente. Todos esses arquivos precisam ser transformados em tabelas-hash (um formato otimizado para acesso rápido) após cada alteração, com o comando <command>postmap /etc/postfix/<replaceable>arquivo</replaceable></command>.
				</para>
				 </sidebar> <para>
					A terceira diretiva permite ao administrador criar uma lista negra e uma lista branca de servidores de e-mail, armazenados em <filename>/etc/postfix/access_clientip</filename>. Servidores na lista branca são considerados de confiança e os e-mails vindos de lá, portanto, não passam pelas regras seguintes de filtragem.
				</para>
				 <para>
					As últimas duas regras rejeitam qualquer mensagem proveniente de um servidor listados em uma das listas negras indicadas. RBL é um acrônimo para <emphasis>Remote Black List</emphasis> (Lista Negra Remota); existem várias dessas listas, mas todas elas listam servidores mal configurados em que os spammers usam para transmitir seus e-mails, bem como encaminham e-mails inesperados bem como máquinas infectadas com worms ou vírus.
				</para>
				 <indexterm>
					<primary>RBL</primary>
				</indexterm>
				 <indexterm>
					<primary>Lista Negra Remota</primary>
				</indexterm>
				 <sidebar> <title><emphasis>DICA</emphasis> Listas brancas e RBLs</title>
				 <para>
					Listas negras, por vezes, incluem um servidor legítimo que tem sofrido um incidente. Nestas situações, todos os e-mails provenientes de um desses servidores seria rejeitado a menos que o servidor esteja listado em uma lista branca definida em <filename>/etc/postfix/access_clientip</filename>.
				</para>
				 <para>
					A prudência recomenda a inclusão de todos os servidores confiáveis na lista branca de onde muito e-mail são geralmente recebidos.
				</para>
				 </sidebar>
			</section>
			 <section>
				<title>Verificando a Validade dos Comandos <literal>EHLO</literal> ou <literal>HELO</literal></title>
				 <para>
					Toda troca SMTP começa com um comando <literal>HELO</literal> (ou <literal>EHLO</literal>), seguido do nome do servidor de e-mail enviante; verificar a validade deste nome pode ser interessante.
				</para>
				 <indexterm>
					<primary><literal>HELO</literal></primary>
				</indexterm>
				 <indexterm>
					<primary><literal>EHLO</literal></primary>
				</indexterm>
				 <example>
					<title>Restrições no nome anunciado com <literal>EHLO</literal></title>
					 
<programlisting>
smtpd_helo_restrictions = permit_mynetworks,
    reject_invalid_hostname,
    check_helo_access hash:/etc/postfix/access_helo,
    reject_non_fqdn_hostname,
    warn_if_reject reject_unknown_hostname</programlisting>

				</example>
				 <para>
					A primeira diretiva <literal>permit_mynetworks</literal> permite que todas as máquinas da rede local se apresentem livremente. Isso é importante, porque alguns programas de e-mail não respeitam essa parte do protocolo SMTP de forma suficientemente correta e podem se apresentar com nomes sem sentido.
				</para>
				 <para>
					A regra <literal>reject_invalid_hostname</literal> rejeita e-mails quando o anuncio <literal>EHLO</literal> lista um nome de host incorreto sintaticamente. A regra <literal>reject_non_fqdn_hostname</literal> rejeita mensagens quando o nome do host anunciado não é um nome de domínio totalmente qualificado (incluindo um nome de domínio, bem como um nome de host). A regra <literal>reject_unknown_hostname</literal> rejeita mensagens se o nome anunciado não existe no DNS. Uma vez que esta última regra infelizmente leva a muitas rejeições,os administradores converteram seu efeito em uma simples advertência com o modificador <literal>warn_if_reject</literal> como um primeiro passo; eles podem decidir remover este modificador em uma etapa posterior, após a auditoria dos resultados desta regra.
				</para>
				 <para>
					Usando <literal>permit_mynetworks</literal> como a primeira regra tem um efeito colateral interessante: as regras seguintes aplicam-se apenas aos hosts fora da rede local. Isso permite bloquear todos os hosts que se anunciam como parte do <literal>falcot.com</literal>, por exemplo, adicionando uma linha <literal>falcot.com REJECT Você não é da nossa rede!</literal> no arquivo <filename>/etc/postfix/access_helo</filename>.
				</para>

			</section>
			 <section>
				<title>Aceitando ou recusando baseado em remetente anunciado</title>
				 <para>
					Toda mensagem tem um remetente, anunciado pelo comando <literal>MAIL FROM</literal> do protocolo SMTP; novamente esta informação pode ser validada de diversas maneiras.
				</para>
				 <indexterm>
					<primary><literal>MAIL FROM</literal></primary>
				</indexterm>
				 <indexterm>
					<primary>e-mail</primary>
					<secondary>filtrando pelo remetente</secondary>
				</indexterm>
				 <example>
					<title>Verificações do Remetente</title>
					 
<programlisting>
smtpd_sender_restrictions = 
    check_sender_access hash:/etc/postfix/access_sender,
    reject_unknown_sender_domain, reject_unlisted_sender,
    reject_non_fqdn_sender</programlisting>

				</example>
				 <para>
					A tabela <filename>/etc/postfix/access_sender</filename> mapeia algum tratamento especial a alguns remetentes. Isso geralmente significa listar alguns remetentes em uma lista branca ou uma lista negra.
				</para>
				 <para>
					A regra <literal>reject_unknown_sender_domain</literal> exige um domínio de remetente válido, já que tal domínio é necessário para um endereço válido. A regra <literal>reject_unlisted_sender</literal> rejeita remetentes locais se o endereço não existe; isso impede que emails sejam enviados a partir de um endereço inválido no domínio <literal>falcot.com</literal>, e as mensagens que se originam de <literal>joe.bloggs@falcot.com</literal> são apenas aceitas se tal endereço realmente existe.
				</para>
				 <para>
					Finalmente, a regra <literal>reject_non_fqdn_sender</literal> rejeita e-mails que pretendem vir de endereços sem um nome de domínio totalmente qualificado. Na prática, isso significa rejeitar e-mails vindos de um usuário <literal>@máquina</literal>: o endereço deve ser anunciado como <literal>user@machine.example.com</literal> ou <literal>user@example.com</literal>.
				</para>

			</section>
			 <section>
				<title>Aceitando e Rejeitando Baseado no Destinatário</title>
				 <para>
					Todo e-mail tem ao menos um destinatário, anunciado com o comando <literal>RCPT TO</literal> no protocolo SMTP. Estes endereços também são passíveis de validação, mesmo que sejam menos relevantes do que as verificações feitas no endereço do remetente.
				</para>
				 <indexterm>
					<primary>RCPT TO</primary>
				</indexterm>
				 <indexterm>
					<primary>e-mail</primary>
					<secondary>filtrando pelo destinatário</secondary>
				</indexterm>
				 <example>
					<title>Verificações pelo Destinatário</title>
					 
<programlisting>
smtpd_recipient_restrictions = permit_mynetworks, 
    reject_unauth_destination, reject_unlisted_recipient, 
    reject_non_fqdn_recipient</programlisting>

				</example>
				 <para>
					<literal>reject_unauth_destination</literal> é a regra básica que exige que mensagens externas sejam endereçadas para nós; mensagens enviadas para um endereço não servido por este servidor são rejeitadas. Sem esta regra, um servidor se torna um retransmissor ("relay") aberto que permite que spammers enviem e-mails não solicitados; esta regra é, portanto, obrigatória, e vai ser melhor incluí-la perto do início da lista, de forma que nenhuma outra regra possa autorizar a mensagem antes de seu destino ser verificado.
				</para>
				 <para>
					A regra <literal>reject_unlisted_recipient</literal> rejeita mensagens enviadas para usuários locais não-existentes, o que faz sentido. Finalmente, a regra <literal>reject_non_fqdn_recipient</literal> rejeita endereços não totalmente qualificados; isso faz com que seja impossível enviar um e-mail para <literal>jean</literal> ou <literal>jean@machine</literal>, e em vez disso requer o uso do endereço completo, como <literal>jean@machine.falcot.com</literal> ou <literal>jean@falcot.com</literal>.
				</para>

			</section>
			 <section>
				<title>Restrições Associadas ao Comando <literal>DATA</literal></title>
				 <para>
					O comando <literal>DATA</literal> do SMTP é emitido antes do conteúdo da mensagem. Ele não fornece qualquer informação, por si só, além de anunciar o que vem a seguir. Pode ainda ser submetidos a verificações.
				</para>
				 <indexterm>
					<primary><literal>DATA</literal></primary>
				</indexterm>
				 <example>
					<title>Verificações pelo <literal>DATA</literal></title>
					 
<programlisting>
smtpd_data_restrictions = reject_unauth_pipelining</programlisting>

				</example>
				 <para>
					A diretiva <literal>reject_unauth_pipelining</literal> faz com que a mensagem seja rejeitada se o remetente envia um comando antes da resposta ao comando anterior foi enviado. Isso evita uma otimização comum usada por robôs de spammers, uma vez que eles geralmente não se importam em nada pelas respostas e se concentram apenas no envio de tantos e-mails quanto possível em tão curto espaço de tempo possível.
				</para>

			</section>
			 <section>
				<title>Aplicando as Restrições</title>
				 <para>
					Embora os comandos acima validam as informações em vários estágios de troca SMTP, o Postfix só envia uma rejeição real como uma resposta ao comando <literal>RCPT TO</literal>.
				</para>
				 <para>
					Isto significa que mesmo se a mensagem for rejeitada devido a um comando <literal>EHLO</literal> inválido, o Postfix conhece o remetente e o destinatário ao anunciar a rejeição. Então ele pode registrar uma mensagem mais explícita do que ele poderia se a transação havia sido interrompida desde o início. Além disso, um número de clientes SMTP não esperam falhas nos comandos SMTP iniciais, e esses clientes serão menos perturbados por esta rejeição tardia.
				</para>
				 <para>
					A vantagem final para esta escolha é que as regras podem acumular informação durante as várias fases do intercâmbio SMTP; este permite definir permissões mais refinadas, como a rejeição de uma conexão não-local se ele se anuncia com um remetente local.
				</para>

			</section>
			 <section>
				<title>Filtrando Baseado no Conteúdo da Mensagem</title>
				 <para>
					O sistema de validação e restrição não seria completo sem uma maneira de aplicar verificações para o conteúdo da mensagem. O Postfix diferencia as verificações praticadas nos cabeçalhos de e-mail das que se aplicam ao corpo do e-mail.
				</para>
				 <example>
					<title>Habilitação de filtros baseados em conteúdo</title>
					 
<programlisting>
header_checks = regexp:/etc/postfix/header_checks
body_checks = regexp:/etc/postfix/body_checks</programlisting>

				</example>
				 <indexterm>
					<primary>e-mail</primary>
					<secondary>filtro de conteúdo</secondary>
				</indexterm>
				 <para>
					Ambos os arquivos contêm uma lista de expressões regulares (comumente conhecido como <emphasis>regexps</emphasis> ou <emphasis>regexes</emphasis>) e ações associadas a serem acionadas quando os cabeçalhos de e-mail (ou corpo) coincidir com a expressão.
				</para>
				 <sidebar> <title><emphasis>OLHADA RÁPIDA</emphasis> Tabelas de expressões regulares (regexp)</title>
				 <para>
					O arquivo <filename>/usr/share/doc/postfix-doc/examples/header_checks.gz</filename> contém muitos comentários explicativos e podem ser usados como ponto de partida para a criação dos arquivos <filename>/etc/postfix/header_checks</filename> e <filename>/etc/postfix/body_checks</filename>.
				</para>
				 </sidebar> <example>
					<title>Exemplos do arquivo <filename>/etc/postfix/header_checks</filename></title>
					 
<programlisting>
/^X-Mailer: GOTO Sarbacane/ REJECT I fight spam (GOTO Sarbacane)
/^Subject: *Your email contains VIRUSES/ DISCARD virus notification</programlisting>

				</example>
				 <sidebar id="sidebar.regexp"> <title><emphasis>DE VOLTA AO BASICO</emphasis> Expressão regular</title>
				 <para>
					o termo <emphasis>expressão regular</emphasis> (abreviado como <emphasis>regexp</emphasis> ou <emphasis>regex</emphasis>) faz referência a uma notação genérica para expressar uma descrição do conteúdo e/ou da estrutura de um conjunto de caracteres. Alguns caracteres especiais permitem a definição de alternativas (por exemplo, <literal>foo|bar</literal> corresponde a "foo" ou "bar"), conjuntos de caracteres permitidos (por exemplo, <literal>[0-9]</literal> significa qualquer dígito, e <literal>.</literal> - um ponto - significa qualquer caractere), quantificações (<literal>s:</literal> corresponde ou <literal>s</literal> ou a cadeia vazia, em outras palavras 0 ou 1 ocorrência de <literal>s</literal>, <literal>s+</literal> corresponde a um ou mais caracteres <literal>s</literal> consecutivos, e assim por diante). Parênteses permite o agrupamento dos resultados da pesquisa.
				</para>
				 <para>
					A sintaxe precisa dessas expressões varia entre as ferramentas que as usam, mas as características básicas são semelhantes. <ulink type="block" url="http://en.wikipedia.org/wiki/Regular_expression" />
				</para>
				 </sidebar> <para>
					O primeiro verifica o cabeçalho mencionando o software de e-mail; a mensagem será rejeitada se <literal>GOTO Sarbacane</literal> (um software de e-mail em massa) for encontrado. A segunda expressão controla o assunto da mensagem; se menciona uma notificação de vírus, podemos decidir não rejeitar a mensagem, mas descartá-lo imediatamente.
				</para>
				 <para>
					Usando esses filtros é uma espada de dois gumes, porque é fácil de fazer as regras demasiadamente genéricas e como consequência perder e-mails legítimos. Nestes casos, não apenas as mensagens serão perdidas, mas seus remetentes receberão mensagens de erro indesejadas (e chatas).
				</para>

			</section>

		</section>
		 <section id="sect.setting-up-greylisting">
			<title>Configurando "listas cinzas" (<foreignphrase>greylisting</foreignphrase>)</title>
			 <indexterm>
				<primary>greylisting</primary>
			</indexterm>
			 <para>
				“lista cinza” é uma técnica de filtragem na qual uma mensagem é inicialmente rejeitada com um código de error temporário, e é aceita apenas numa segunda tentativa após algum atraso. Esta filtragem é particularmente eficiente contra spam enviado de muitas máquinas infectadas por worms e vírus, já que estes softwares raramente agem como um agente SMTP completo (verificando o código de erro e tentando mandar a mensagem novamente mais tarde), especialmente se muitos dos endereços "harvested" são na verdade inválidos e tentar de novo seria apenas uma perda de tempo.
			</para>
			 <para>
				Postfix não fornece lista cinza nativamente, mas existe uma funcionalidade na qual a decisão de aceitar ou rejeitar uma dada mensagem pode ser delegada a um programa externo. O pacote <emphasis role="pkg">postgrey</emphasis> contém tal programa, feito para ser uma interface com este serviço de delegação de políticas de acesso.
			</para>
			 <para>
				Uma vez o <emphasis role="pkg">postgrey</emphasis> estando instalado, ele roda como um daemon e ouve na porta 10023. O Postfix pode então ser configurado para usá-lo. adicionando o parâmetro <literal>check_policy_service</literal> como uma restrição extra:
			</para>
			 
<programlisting>
smtpd_recipient_restrictions = permit_mynetworks,
    [...]
    check_policy_service inet:127.0.0.1:10023</programlisting>
			 <para>
				Cada vez que o Postfix alcança esta regra no conjunto de regras, ele irá se conectar ao daemon <command>postgrey</command> e enviar a ele informações a respeito de mensagens relevantes. Do seu lado, o Postgrey, considera a tripla endereço IP/remetente/destinatário e verifica em seu banco de dados se a mesma tripla foi vista recentemente. Se sim, o Postgrey responde que a mensagem foi aceita; se não, a resposta indica que a mensagem deve ser rejeitada temporariamente, e a tripla é registrada no banco de dados.
			</para>
			 <para>
				A principal desvantagem de listas cinza é que mensagens legítimas podem ser atrasadas, o que nem sempre é aceitável. também aumenta a carga em servidores que mandam muitos email legítimos.
			</para>
			 <sidebar> <title><emphasis>NA PRÁTICA</emphasis> Desvantagens das listas cinzas</title>
			 <para>
				Teoricamente, a lista cinza deve apenas atrasar o primeiro email de um determinado remetente para um determinado destinatário e o atraso típico é da ordem de minutos. A realidade, contudo, pode diferir ligeiramente. Alguns grandes ISPs usam clusters de servidores SMTP e quando uma mensagem é rejeitada inicialmente, o servidor que repete a transmissão pode não ser o mesmo que o inicial. Quando isso acontece, o segundo servidor obtém uma mensagem de erro temporária devido à lista cinza também e assim por diante; Pode levar várias horas até que a transmissão seja tentada por um servidor que já esteve envolvido, uma vez que servidores SMTP geralmente aumentam o intervalo entre tentativas após cada falha.
			</para>
			 <para>
				Como consequência, o endereço IP de entrada pode variar no tempo, mesmo para um único remetente. Porém isso vai mais além: até mesmo o endereço do remetente pode mudar. Por exemplo, muitos servidores de lista de discussão (mailing-list) codificam informações extra no endereço do remetente a fim de serem capazes de lidar com mensagens de erro (conhecidas como <emphasis>bounces</emphasis>). Cada nova mensagem enviada para uma lista de discussão pode então precisar passar por uma lista cinza, O que significa que ela tem que ser armazenada (temporariamente) no servidor do remetente. Para listas de discussão muito grandes (com dezenas de milhares de assinantes), isso pode em breve tornar-se um problema.
			</para>
			 <para>
				Para atenuar esses inconvenientes, o Postgrey gerencia uma lista branca de tais sites, e mensagens que são emanadas a partir deles são imediatamente aceitas sem passar pela lista cinza. Essa lista pode ser facilmente adaptada às necessidades locais, desde que ela seja armazenada no arquivo <filename>/etc/postgrey/whitelist_clients</filename>.
			</para>
			 </sidebar> <sidebar> <title><emphasis>INDO MAIS LONGE</emphasis> greylisting seletivas com <emphasis role="pkg">milter-greylist</emphasis></title>
			 <para>
				Os inconvenientes de uma lista cinza podem ser atenuados se a lista cinza só for usada em um subconjunto de clientes que já são considerados como prováveis fontes de spam (porque eles são listados em uma lista negra de DNS). Isso não é possível com o <emphasis role="pkg">postgrey</emphasis> mas o <emphasis role="pkg">milter-greylist</emphasis> pode ser utilizado para esse fim.
			</para>
			 <para>
				Neste cenário, como a lista negra do DNS nunca desencadeia uma rejeição definitiva, torna-se razoável usar listas negras agressivas, incluindo aquelas que listam todos os endereços IP dinâmicos de clientes ISP (tais como <literal>pbl.spamhaus.org</literal> ou <literal>dul.dnsbl.sorbs.net</literal>).
			</para>
			 <para>
				Como a milter-greylist usa a interface milter do Sendmail, a configuração do lado do postfix é limitada a "<literal>smtpd_milters = unix:/var/run/milter-greylist/milter-greylist.sock</literal>”. A página de manual de <citerefentry><refentrytitle>greylist.conf</refentrytitle>
				 <manvolnum>5</manvolnum></citerefentry> documenta o <filename>/etc/milter-greylist/greylist.conf</filename> e as inúmeras maneiras de configurar a milter-greylist. Você também terá que editar o <filename>/etc/default/milter-greylist</filename> para realmente habilitar o serviço.
			</para>
			 </sidebar>
		</section>
		 <section>
			<title>Personalização de filtros baseados no destinatário</title>
			 <para>
				<xref linkend="sect.restrictions-for-receiving-and-sending" /> e <xref linkend="sect.setting-up-greylisting" /> revisaram muitas das restrições possíveis. Todas objetivam limitar a quantidade de spam recebido, mas todas têm suas desvantagens. É portanto, mais e mais comum personalizar o conjunto de filtros dependendo do destinatário. Na Falcot Corp, a lista cinza é interessante para a maioria dos usuários, mas isso dificulta o trabalho de alguns usuários que precisam de baixa latência em seus e-mails (como o serviço de suporte técnico). De maneira similar, o serviço comercial às vezes tem problemas para receber e-mails de alguns provedores asiáticos que podem constar em listas negras; este serviço pede um endereço não filtrado de modo a ser capaz de corresponder.
			</para>
			 <para>
				O Postfix fornece tal customização de filtros com o conceito de “classe de restrição”. As classes são declaradas no parâmetro <literal>smtpd_restriction_classes</literal>, e definidas da mesma maneira como <literal>smtpd_recipient_restrictions</literal>. A diretiva <literal>check_recipient_access</literal> então define uma tabela de mapeamento de um determinado destinatário para o conjunto apropriado de restrições.
			</para>
			 <example>
				<title>Definição de classes de restrição em <filename>main.cf</filename></title>
				 
<programlisting>smtpd_restriction_classes = greylisting, aggressive, permissive

greylisting = check_policy_service inet:127.0.0.1:10023
aggressive = reject_rbl_client sbl-xbl.spamhaus.org,
        check_policy_service inet:127.0.0.1:10023
permissive = permit

smtpd_recipient_restrictions = permit_mynetworks,
        reject_unauth_destination,
        check_recipient_access hash:/etc/postfix/recipient_access</programlisting>

			</example>
			 <example>
				<title>O arquivo <filename>/etc/postfix/recipient_access</filename></title>
				 
<programlisting>
# Unfiltered addresses
postmaster@falcot.com  permissive
support@falcot.com     permissive
sales-asia@falcot.com  permissive

# Aggressive filtering for some privileged users
joe@falcot.com         aggressive

# Special rule for the mailing-list manager
sympa@falcot.com       reject_unverified_sender

# Greylisting by default
falcot.com             greylisting</programlisting>

			</example>

		</section>
		 <section id="sect.postfix-antivirus">
			<title>Integração com um antivírus</title>
			 <indexterm>
				<primary>antivírus</primary>
			</indexterm>
			 <para>
				Os muitos vírus circulando como anexos de e-mails fazem importante a configuração um antivírus no ponto de entrada de rede da empresa, pois mesmo após uma campanha de conscientização alguns usuários ainda abrirão anexos de mensagens obviamente obscuras.
			</para>
			 <para>
				Os administradores da Falcot selecionaram o <command>clamav</command> como seu antivírus livre. O pacote principal é o <emphasis role="pkg">clamav</emphasis>, mas eles também instalaram alguns pacotes extras como o <emphasis role="pkg">arj</emphasis>, <emphasis role="pkg">unzoo</emphasis>, <emphasis role="pkg">unrar</emphasis> e <emphasis role="pkg">lha</emphasis>, já que eles são necessários para o antivírus poder analisar arquivos anexados em um desses formatos.
			</para>
			 <indexterm>
				<primary><command>clamav</command></primary>
			</indexterm>
			 <indexterm>
				<primary><command>clamav-milter</command></primary>
			</indexterm>
			 <para>
				A tarefa de fazer a interface entre o antivírus e o servidor de email vai para o <command>clamav-milter</command>. Um<emphasis>milter</emphasis> (abreviação de <emphasis>mail filter</emphasis>) é um programa de filtragem especialmente projetado para fazer a interface com os servidores de email. O milter usa uma interface de programação de aplicativo (API) padrão que fornece uma performace muito melhor que os filtros externos para servidores de email. Os milters foram inicialmente introduzidos pelo <emphasis>Sendmail</emphasis>, mas o <emphasis>Postfix</emphasis> o adotou em seguida.
			</para>
			 <sidebar> <title><emphasis>OLHADA RÁPIDA</emphasis> Um milter para Spamassassin</title>
			 <indexterm>
				<primary><emphasis role="pkg">spamass-milter</emphasis></primary>
			</indexterm>
			 <para>
				O pacote <emphasis role="pkg">spamass-milter</emphasis> provê um milter baseado no <emphasis>SpamAssassin</emphasis>, o famoso detector de email não solicitado. Ele pode ser usado para sinalizar mensagens como prováveis spams (adicionando um cabeçalho extra) e/ou rejeitar as mensagens por completo se sua pontuação de “spam” ultrapassar um determinado limiar.
			</para>
			 </sidebar> <para>
				Uma vez que o pacote <emphasis role="pkg">clamav-milter</emphasis> esteja instalado, o milter deve ser reconfigurado para rodar em uma porta TCP ao invés do soquete nomeado padrão. Isso pode ser feito com <command>dpkg-reconfigure clamav-milter</command>. Quando questionado pela “Communication interface with Sendmail”, responda “<literal>inet:10002@127.0.0.1</literal>”.
			</para>
			 <sidebar> <title><emphasis>NOTA</emphasis> Porta TCP real versus soquete nomeado</title>
			 <para>
				A razão porque nós usamos uma porta TCP real ao invés de um socket nomeado é que os daemons do postfix geralmente são executados em um ambiente "chrooted" e não têm acesso ao diretório que hospeda o socket nomeado. Você também poderia decidir continuar usando um socket nomeado e escolher um local dentro do ambiente "chroot" (<filename>/var/spool/postfix/</filename>).
			</para>
			 </sidebar> <para>
				A configuração padrão do ClamAV se encaixa na maioria das situações, mas alguns parâmetros importantes ainda podem ser customizados com <command>dpkg-reconfigure clamav-base</command>.
			</para>
			 <para>
				O último passo envolve informar ao Postfix para usar o filtro recém-configurado. Isso é uma simples questão de adicionar a seguinte diretiva ao <filename>/etc/postfix/main.cf</filename>:
			</para>
			 
<programlisting>
# Virus check with clamav-milter
smtpd_milters = inet:[127.0.0.1]:10002</programlisting>
			 <para>
				Se o antivírus causa problemas, essa linha pode ser comentada, e o <command>service postfix reload</command> deve ser executado para que essa alteração seja levada em conta.
			</para>
			 <sidebar> <title><emphasis>NA PRÁTICA</emphasis> Testando o antivírus</title>
			 <para>
				Uma vez que o antivírus esteja configurado, seu comportamento correto deve ser testado. A maneira mais simples de fazer isso é enviar um email de teste com um anexo contendo o arquivo <filename>eicar.com</filename> (ou <filename>eicar.com.zip</filename>), o qual pode ser baixado online em: <ulink type="block" url="http://www.eicar.org/86-0-Intended-use.html" />
			</para>
			 <para>
				Esse arquivo não é um vírus verdadeiro, mas um arquivo teste que todos os softwares de antivírus no mercado diagnosticam como um vírus para permitir a checagem das instalações.
			</para>
			 </sidebar> <para>
				Todas as mensagens manipuladas pelo Postfix agora passam pelo filtro de antivírus.
			</para>

		</section>
		 <section id="sect.authenticated-smtp">
			<title>SMTP autenticado</title>
			 <para>
				Ser capaz de enviar emails requer um servidor SMTP ao alcance; e também requer que o referido servidor SMTP envie emails por ele. Para usuários móveis, pode ser preciso que eles alterem, regularmente, a configuração do cliente SMTP, já que o servidor SMTP da Falcot rejeita mensagens provenientes de endereços IP aparentemente não pertencentes à companhia. Existem duas soluções: ou o usuário instala um servidor SMTP em seu computador, ou ele usa o servidor da companhia com algum meio de autenticação como empregado. A primeira solução não é recomendada já que o computador não estará permanentemente conectado, e não será capaz de tentar enviar mensagens novamente em caso de problemas; nós iremos nos focar na última solução.
			</para>
			 <para>
				A autenticação SMTP no Postfix se apoia no SASL (<emphasis>Simple Authentication and Security Layer</emphasis>). Ela precisa dos pacotes <emphasis role="pkg">libsasl2-modules</emphasis> e <emphasis role="pkg">sasl2-bin</emphasis> instalados, e em seguida o registro de uma senha no banco de dados do SASL para cada usuário que precise autenticar no servidor SMTP. Isso é feito com o comando <command>saslpasswd2</command>, o qual recebe vários parâmetros. A opção <literal>-u</literal> define o domínio de autenticação, que deve corresponder com o parâmetro <literal>smtpd_sasl_local_domain</literal> na configuração do Postfix. A opção <literal>-c</literal> permite criar um usuário, e <literal>-f</literal> permite especificar o arquivo a ser usado se o banco de dados do SASL precisar ser armazenado em um local diferente do padrão (<filename>/etc/sasldb2</filename>).
			</para>
			 
<screen role="scale">
<computeroutput># </computeroutput><userinput>saslpasswd2 -u `postconf -h nomedomeuhost` -f /var/spool/postfix/etc/sasldb2 -c jean</userinput>
<computeroutput>[... digite a senha de jean duas vezes ...]</computeroutput></screen>
			 <para>
				Note que o banco de dados do SASL foi criado no diretório do Postfix. Para garantir consistência, nós também transformamos o <filename>/etc/sasldb2</filename> em uma ligação simbólica apontando para o banco de dados usado pelo Postfix, com o comando <command>ln -sf /var/spool/postfix/etc/sasldb2 /etc/sasldb2</command>.
			</para>
			 <para>
				Agora nós precisamos configurar o Postfix para usar o SASL. Primeiro, o usuário <literal>postfix</literal> precisa ser adicionado ao grupo <literal>sasl</literal>, para que ele possa acessar a conta no banco de dados do SASL. Alguns novos parâmetros também são necessários para habilitar o SASL, e o parâmetro <literal>smtpd_recipient_restrictions</literal> precisa ser configurado para permitir que cliente autenticado pelo SASL possam enviar emails livremente.
			</para>
			 <example>
				<title>Ativando o SASL no <filename>/etc/postfix/main.cf</filename></title>
				 
<programlisting>
# Enable SASL authentication
smtpd_sasl_auth_enable = yes
# Define the SASL authentication domain to use
smtpd_sasl_local_domain = $myhostname
[...]
# Adding permit_sasl_authenticated before reject_unauth_destination
# allows relaying mail sent by SASL-authenticated users
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
[...]</programlisting>

			</example>
			 <sidebar> <title><emphasis>EXTRA</emphasis> Cliente SMTP autenticado</title>
			 <para>
				A maioria dos clientes de e-mail são capazes de fazer autenticação em um servidor de SMTP antes de enviar mensagens de saída e usar esse recurso é uma simples questão de configurar os parâmetros apropriados. Se o cliente em uso não oferece esse recurso a solução alternativa é usar um servidor Postfix local e configurá-lo para fazer o relay do email através de um servidor SMTP remoto. Neste caso, o próprio Postfix local será o cliente que autentica com o SASL. Aqui estão os parâmetros necessários:
			</para>
			 
<programlisting>
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
relay_host = [mail.falcot.com]</programlisting>
			 <para>
				O arquivo <filename>/etc/postfix/sasl_passwd</filename> precisa conter o nome de usuário e senha para autenticar no servidor <literal>mail.falcot.com</literal>. Aqui está um exemplo:
			</para>
			 
<programlisting>
[mail.falcot.com]   joe:LyinIsji</programlisting>
			 <para>
				Como em todos os mapeamentos do Postfix, esse arquivo tem que ser transformado em <filename>/etc/postfix/sasl_passwd.db</filename> através do comando <command>postmap</command>.
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.http-web-server">
		<title>Servidor web (HTTP)</title>
		 <para>
			Os administradores da Falcot Corp decidiram usar o servidor HTTP da Apache, incluído no Debian <emphasis role="distribution">Jessie</emphasis> na versão 2.4.10.
		</para>
		 <indexterm>
			<primary><command>apache</command></primary>
		</indexterm>
		 <indexterm>
			<primary>servidor</primary>
			<secondary>web</secondary>
		</indexterm>
		 <indexterm>
			<primary>servidor web</primary>
		</indexterm>
		 <indexterm>
			<primary>servidor</primary>
			<secondary>HTTP</secondary>
		</indexterm>
		 <indexterm>
			<primary>HTTP</primary>
			<secondary>servidor</secondary>
		</indexterm>
		 <sidebar> <title><emphasis>ALTERNATIVA</emphasis> Outros servidores web</title>
		 <para>
			O Apache é apenas o mais conhecido (e amplamente utilizado) servidor web, porém existem outros; eles podem oferecer um melhor desempenho sob certas cargas de trabalho, mas ao custo de terem um número menor de funcionalidades e módulos disponíveis. Contudo, quando o servidor web em perspectiva é feito para servir arquivos estáticos ou agir como um proxy, alternativas tais como <emphasis role="pkg">nginx</emphasis> e <emphasis role="pkg">lighttpd</emphasis>, valem a pena serem investigadas.
		</para>
		 <indexterm>
			<primary><emphasis role="pkg">nginx</emphasis></primary>
		</indexterm>
		 <indexterm>
			<primary><emphasis role="pkg">lighttpd</emphasis></primary>
		</indexterm>
		 </sidebar> <section>
			<title>Instalação do Apache</title>
			 <para>
				Instalar o pacote <emphasis role="pkg">apache2</emphasis> é tudo o que é preciso. ele contém todos os môdulos, incluíndo os <emphasis>Multi-Processing Modules</emphasis> (MPMs) que afetam como o Apache lida com processamento paralelo de muitas requisições (aqueles que costumeiramente eram fornecidos em pacotes <emphasis role="pkg">apache2-mpm-*</emphasis> separados). Ele irá também puxar o <emphasis role="pkg">apache2-utils</emphasis> que contém os utilitários de linha de comando que nós iremos descobrir mais tarde.
			</para>
			 <para>
				O MPM em uso afeta significantemente a forma com que o Apache irá lidar com as requisições simultâneas. Com o MPM <emphasis role="pkg">worker</emphasis>, ele usa <emphasis>threads</emphasis> (processos leves), enquanto que com o MPM <emphasis role="pkg">prefork</emphasis> ele usa um grupo de processos criados antecipadamente. Com o MPM <emphasis role="pkg">event</emphasis> ele também usa threads, porém as conexões inativas (notavelmente aquelas mantidas abertas pelo recurso HTTP <emphasis>keep-alive</emphasis>) são devolvidas a um segmento de gerenciamento dedicado.
			</para>
			 <para>
				Os administradores da Falcot também instalaram o <emphasis role="pkg">libapache2-mod-php5</emphasis> a fim de incluir suporte a PHP no Apache. Isso faz com que o <emphasis role="pkg">evento</emphasis> padrão MPM seja desabilitado, e o <emphasis role="pkg">prefork</emphasis> seja instalado em seu lugar, já que o PHP só funciona sob esse MPM em particular.
			</para>
			 <sidebar> <title><emphasis>SEGURANÇA</emphasis> Execução sob o usuário <literal>www-data</literal></title>
			 <indexterm>
				<primary><literal>www-data</literal></primary>
			</indexterm>
			 <indexterm>
				<primary>suexec</primary>
			</indexterm>
			 <para>
				Por padrão, o Apache lida com as requisições de entrada sob a identidade de usuário <literal>www-data</literal>. Isso significa que uma vulnerabilidade em um script CGI executado pelo Apache (para uma página dinâmica) não comprometa todo o sistema, mas apenas os arquivos pertencentes a esse usuário em particular.
			</para>
			 <para>
				O uso do módulo <emphasis>suexec</emphasis> permite contornar essa regra para que alguns scripts CGI sejam executados sob a identidade de outro usuário. Isso é configurado com a diretiva <literal>SuexecUserGroup <replaceable>user</replaceable><replaceable>group</replaceable></literal> na configuração do Apache.
			</para>
			 <indexterm>
				<primary><emphasis role="pkg">libapache2-mpm-itk</emphasis></primary>
			</indexterm>
			 <para>
				Outra possibilidade é usar um MPM dedicado, como o fornecido pelo <emphasis role="pkg">libapache2-mpm-itk</emphasis>. Esse módulo em particular tem um comportamento um pouco diferente: ele permite o “isolamento” de hosts virtuais (na verdade, conjuntos de páginas) para que cada um deles seja executado como um usuário diferente. Portanto, uma vulnerabilidade em um site web não pode comprometer arquivos pertencentes ao dono de outro site web.
			</para>
			 </sidebar> <sidebar> <title><emphasis>OLHADA RÁPIDA</emphasis> Lista de módulos</title>
			 <para>
				Uma lista completa dos módulos padrão do Apache pode ser encontrada online. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/index.html" />
			</para>
			 </sidebar> <para>
				O Apache é um servidor modular, e muitos recursos são implementados através de módulos externos que o programa principal carrega durante sua inicialização. A configuração padrão apenas habilita os módulos mais comuns, porém habilitar módulos novos é uma simples questão de rodar <command>a2enmod <replaceable>módulo</replaceable></command>; para desabilitar um módulo, o comando é <command>a2dismod <replaceable>módulo</replaceable></command>. Esses programas na verdade apenas criam (ou apagam) ligações simbólicas em <filename>/etc/apache2/mods-enabled/</filename>, que apontam para para os arquivos reais (armazenados em <filename>/etc/apache2/mods-available/</filename>).
			</para>
			 <para>
				Com sua configuração padrão, o servidor web ouve na porta 80 (como configurado em <filename>/etc/apache2/ports.conf</filename>), e serve páginas a partir do diretório <filename>/var/www/html/</filename> (como configurado em <filename>/etc/apache2/sites-enabled/000-default.conf</filename>).
			</para>
			 <sidebar> <title><emphasis>INDO ALÉM</emphasis> Compatibilidade com SSL</title>
			 <indexterm>
				<primary>HTTPS</primary>
			</indexterm>
			 <indexterm>
				<primary>HTTP</primary>
				<secondary>seguro</secondary>
			</indexterm>
			 <para>
				O Apache 2.4 inclui o módulo SSL, necessário para HTTP seguro (HTTPS) "de fábrica". Ele apenas precisa ser habilitado com <command>a2enmod ssl</command>, e então as diretivas necesssárias têm que ser adicionadas aos arquivos de configuração. Um exemplo de configuração é fornecido em <filename>/etc/apache2/sites-available/default-ssl.conf</filename>. <ulink type="block" url="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html" />
			</para>
			 <para>
				Alguns cuidados extra devem ser tomados se você quer fornecer conexões SSL com <emphasis>Perfect Forward Secrecy</emphasis> (essas conexões usam chaves de sessão efêmera, que garantem que um comprometimento da chave secreta do servidor não resulte no comprometimento de tráfego criptografado antigo que poderia ter sido armazenado durante um "sniffing" na rede). Dê uma olhada nas recomendações da Mozilla, em particular: <ulink type="block" url="https://wiki.mozilla.org/Security/Server_Side_TLS#Apache" />
			</para>
			 <indexterm>
				<primary><emphasis>Perfect Forward Secrecy</emphasis></primary>
			</indexterm>
			 </sidebar>
		</section>
		 <section>
			<title>Configuração de servidores virtuais</title>
			 <para>
				Um servidor virtual é uma identidade adicional para o servidor web.
			</para>
			 <indexterm>
				<primary>host virtual</primary>
			</indexterm>
			 <para>
				Apache considera dois tipos diferentes de hosts virtuais: aqueles que se baseiam no endereço IP (ou na porta) e aqueles que se baseiam no nome de domínio do servidor web. O primeiro método requer a alocação de um endereço IP diferente (ou porta) para cada site, enquanto o segundo pode funcionar em um único endereço IP (e porta), os sites são diferenciados pelo nome de máquina enviado pelo cliente HTTP (que só funciona na versão 1.1 do protocolo HTTP — Felizmente essa versão é antiga o bastante, e assim, é utilizada por todos os clientes).
			</para>
			 <para>
				A (crescente) escassez de endereços IPv4 geralmente favorece o segundo método; contudo, fica mais complexo se os hosts virtuais precisam fornecer HTTPS também, pois o protocolo SSL nem sempre é fornecido para hospedagem virtual baseada em nome; a extensão SNI (<emphasis>Server Name Indication</emphasis>) que permite uma combinação desse tipo não é suportada por todos os navegadores. Quando vários sites HTTPS precisam ser rodados no mesmo servidor, eles geralmente irão ser diferenciados ou por rodar em uma porta diferente ou um endereço IP diferente (IPv6 pode ajudar aqui).
			</para>
			 <para>
				A configuração padrão do Apache 2 habilita hosts virtuais baseados em nomes. Além disso, um host virtual padrão é definido no arquivo <literal>/etc/apache2/sites-enabled/000-default.conf</literal>; esse host virtual será usado se não for encontrado nenhum host que corresponda à solicitação enviada pelo cliente.
			</para>
			 <sidebar> <title><emphasis>ATENÇÃO</emphasis> Primeiro servidor virtual</title>
			 <para>
				Requisições relativas a hosts virtuais desconhecidos sempre serão servidas pelo primeiro host virtual definido, é por isso que nós definimos <literal>www.falcot.com</literal> em primeiro lugar aqui.
			</para>
			 </sidebar> <sidebar> <title><emphasis>OLHADA RÁPIDA</emphasis> Suporte Apache ao SNI</title>
			 <indexterm>
				<primary>Server Name Indication</primary>
			</indexterm>
			 <para>
				O servidor Apache suporta uma extensão do protocolo SSL chamada <emphasis>Server Name Indication</emphasis> (SNI). Esta extensão permite ao navegador enviar o nome do nome do host do servidor web durante o estabelecimento da conexão SSL, muito antes do que o HTTP o solicitaria, que foi usado anteriormente para identificar o host virtual solicitado entre aqueles hospedados no mesmo servidor (com o mesmo endereço IP e porta). Isso permite ao Apache selecionar o certificado SSL mais adequado para a transação a proceder.
			</para>
			 <para>
				Antes do SNI, o Apache sempre usava o certificado definido no host virtual padrão. Clientes que tentavam acessar outro host virtual iriam então exibir avisos (warnings), pois eles recebiam o certificado que não correspondia com o site que eles estavam tentando acessar. Felizmente, a maioria dos navegadores agora trabalham com SNI; Isso inclui o Microsoft Internet Explorer a partir da versão 7.0 (começando no Vista), Mozilla Firefox começando com a versão 2.0, o Safari da Apple desde a versão 3.2.1 e todas as versões do Google Chrome.
			</para>
			 <para>
				O pacote Apache fornecido pelo Debian é construído com suporte a SNI; portanto, nenhuma configuração em particular é necessária.
			</para>
			 <para>
				Devemos também ter cuidado para garantir que a configuração do primeiro host virtual (aquele usado por padrão) habilite TLSv1, pois o Apache utiliza os parâmetros deste primeiro hospedeiro virtual para estabelecer conexões seguras e eles tem a melhor permissividade para isso!
			</para>
			 </sidebar> <para>
				Cada host virtual extra é então descrito por um arquivo armazenado em <filename>/etc/apache2/sites-available/</filename>. Configurar um site web para o domínio <literal>falcot.org</literal> é portanto uma simples questão de criar o seguinte arquivo, e então, habilita o host virtual com <command>a2ensite www.falcot.org</command>.
			</para>
			 <example>
				<title>o arquivo <filename>/etc/apache2/sites-available/www.falcot.org.conf</filename></title>
				 
<programlisting>
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;</programlisting>

			</example>
			 <para>
				O servidor Apache, como configurado até agora, usa os mesmos arquivos de log para todos os hosts virtuais (embora isso possa ser alterado adicionando as diretivas <literal>CustomLog</literal> na definição de hosts virtuais). É, entretanto, boa prática customizar o formato desse arquivo de log para ter incluído o nome do host virtual. Isso pode ser feito criando um arquivo <filename>/etc/apache2/conf-available/customlog.conf</filename>, que define um novo formato para todos os arquivos de log (com a diretiva <literal>LogFormat</literal>), e habilitando-o com <command>a2enconf customlog</command> . A linha <literal>CustomLog</literal> tem também que ser removida (ou comentada) do arquivo <filename>/etc/apache2/sites-available/000-default.conf</filename>.
			</para>
			 <example>
				<title>O arquivo <filename>/etc/apache2/conf.d/customlog.conf</filename></title>
				 
<programlisting role="scale">
# New log format including (virtual) host name
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Now let's use this "vhost" format by default
CustomLog /var/log/apache2/access.log vhost</programlisting>

			</example>

		</section>
		 <section>
			<title>Diretivas comuns</title>
			 <para>
				Essa seção revê, brevemente, algumas das diretivas comumente usadas na configuração do Apache.
			</para>
			 <indexterm>
				<primary>Diretivas do Apache</primary>
			</indexterm>
			 <indexterm>
				<primary>diretivas Apache</primary>
			</indexterm>
			 <para>
				O principal arquivo de configuração inclui vários blocos <literal>Directory</literal>; eles permitem especificar diferentes comportamentos para o servidor dependendo da localização do arquivo que está sendo servido. Um bloco desse tipo comumente inclui as diretivas <literal>Options</literal> e <literal>AllowOverride</literal>.
			</para>
			 <indexterm>
				<primary><literal>Opções</literal>, diretivas do Apache</primary>
			</indexterm>
			 <indexterm>
				<primary><literal>AllowOverride</literal>, diretiva Apache</primary>
			</indexterm>
			 <example>
				<title>Bloco Directory</title>
				 
<programlisting>
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;</programlisting>

			</example>
			 <para>
				A diretiva <literal>DirectoryIndex</literal> contém uma lista de arquivos a serem experimentados quando uma requisição do cliente coincide com um diretório. O primeiro arquivo existente da lista é usado e enviado como resposta.
			</para>
			 <indexterm>
				<primary><literal>DirectoryIndex</literal>, diretivas do Apache</primary>
			</indexterm>
			 <para>
				A diretiva <literal>Options</literal> é seguida de uma lista de opções a serem habilitadas. O valor <literal>None</literal> desabilita todas as opções; correspondentemente, <literal>All</literal> habilita todas elas exceto <literal>MultiViews</literal>. As opções disponíveis incluem:
			</para>
			 <itemizedlist>
				<listitem>
					<para>
						<literal>ExecCGI</literal> indica que scripts CGI podem ser executados. <indexterm><primary><literal>ExecCGI</literal>, diretiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>FollowSymlinks</literal> diz ao servidor que ligações simbólicas podem ser seguidas, e que a resposta deve conter o conteúdo do alvo de uma ligação como essa. <indexterm><primary><literal>FollowSymlinks</literal>, diretiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>SymlinksIfOwnerMatch</literal> também diz ao servidor para seguir ligações simbólicas, mas apenas quando a ligação e seu alvo são do mesmo dono. <indexterm><primary><literal>SymlinksIfOwnerMatch</literal>, diretiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>Includes</literal> habilita <emphasis>Server Side Includes</emphasis> (<emphasis>SSI</emphasis> para abreviar). Essas são diretivas embutidas nas páginas HTML e executadas em tempo de execução de cada requisição. <indexterm><primary><literal>Includes</literal>, diretiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>Indexes</literal> diz ao servidor para listar o conteúdo de um diretório se a requisição HTTP enviada pelo cliente aponta para um diretório sem um arquivo index (ie, quando nenhum arquivo mencionado na diretiva <literal>DirectoryIndex</literal> existe nesse diretório). <indexterm><primary><literal>Indexes</literal>, diretiva Apache</primary></indexterm>
					</para>

				</listitem>
				 <listitem>
					<para>
						<literal>MultiViews</literal> habilita a negociação de conteúdo; isso pode ser usado pelo servidor para retornar uma página web que coincida com a língua preferida configurada no navegador. <indexterm><primary><literal>MultiViews</literal>, diretiva Apache </primary></indexterm>
					</para>

				</listitem>

			</itemizedlist>
			 <para>
			</para>
			 <sidebar> <title><emphasis>DE VOLTA AO BÁSICO</emphasis> Arquivo <filename>.htaccess</filename></title>
			 <para>
				O arquivo <filename>.htaccess</filename> contém as diretivas de configuração do Apache que são aplicadas cada vez que uma requisição diz respeito a um elemento do diretório aonde ele é armazenado. O âmbito dessas diretivas também repercute para todos os subdiretórios dentro desse diretório.
			</para>
			 <indexterm>
				<primary><filename>.htaccess</filename></primary>
			</indexterm>
			 <para>
				A maioria das diretivas que podem ser definidas no bloco <literal>Directory</literal> também podem ser definidas no arquivo <filename>.htaccess</filename>.
			</para>
			 </sidebar> <para>
				A diretiva <literal>AllowOverride</literal> lista todas as opções que podem ser habilitadas ou desabilitadas pelo arquivo <filename>.htaccess</filename>. Um uso comum dessa opção é restringir <literal>ExecCGI</literal>, para que o administrador escolha quais usuários tem permissão para rodar programas sob a identidade do servidor web (o usuário <literal>www-data</literal>).
			</para>
			 <indexterm>
				<primary><literal>AllowOverride</literal>, diretiva Apache</primary>
			</indexterm>
			 <section>
				<title>Autenticação obrigatória</title>
				 <indexterm>
					<primary>autenticação web</primary>
				</indexterm>
				 <para>
					Em algumas circunstâncias, o acesso a parte do site web precisa ser restrita, para que apenas usuários legítimos que fornecerem um nome de usuário e uma senha tenham acesso ao conteúdo.
				</para>
				 <example>
					<title>Arquivo <filename>.htaccess</filename> para autenticação obrigatária</title>
					 
<programlisting>
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private</programlisting>

				</example>
				 <sidebar> <title><emphasis>SEGURANÇA</emphasis> Sem segurança</title>
				 <para>
					O sistema de autenticação usado no exemplo acima (<literal>Basic</literal>) tem uma segurança mínima já que a senha é enviada em texto puro (ela apenas é codificada com <emphasis>base64</emphasis>, que é uma codificação simples, ao invés de um método criptografado). Também deve ser notado que os documentos “protegidos” por esse mecanismo também trafegam pela rede em texto puro. Se segurança é importante, toda a conexão HTTP deve ser criptografada com SSL.
				</para>
				 </sidebar> <para>
					O arquivo <filename>/etc/apache2/authfiles/htpasswd-private</filename> contém uma lista de usuários e senhas; ele é comumente manipulado com o comando <command>htpasswd</command>. Por exemplo, o seguinte comando é usado para adicionar um usuário ou alterar a senha: <indexterm><primary><command>htpasswd</command></primary></indexterm>
				</para>
				 
<screen>
<computeroutput># </computeroutput><userinput>htpasswd /etc/apache2/authfiles/htpasswd-private <replaceable>user</replaceable>
</userinput><computeroutput>New password:
Re-type new password:
Adding password for user <replaceable>user</replaceable>
</computeroutput></screen>

			</section>
			 <section>
				<title>Restringindo Acesso</title>
				 <indexterm>
					<primary>restrição de acesso web</primary>
				</indexterm>
				 <para>
					A diretiva <literal>Require</literal> controla as restrições de acesso em um diretório (e seus sub-diretórios, recursivamente).
				</para>
				 <indexterm>
					<primary>Diretivas do Apache</primary>
				</indexterm>
				 <indexterm>
					<primary>diretivas Apache</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Require</literal>, diretiva do Apache</primary>
				</indexterm>
				 <para>
					Isso pode ser usado para restringir acesso com base em muitos critérios; nós iremos parar na descrição de restrição de acesso com base no endereço IP de um cliente, mas isso pode ser feito de maneira muito mais poderosa, especialmente quando várias diretivas <literal>Require</literal> são combinadas dentro de um bloco <literal>RequireAll</literal>.
				</para>
				 <example>
					<title>Apenas permite a partir da rede local</title>
					 
<programlisting>Require ip 192.168.0.0/16</programlisting>

				</example>
				 <sidebar> <title><emphasis>ALTERNATIVA</emphasis> Sintaxe antiga</title>
				 <para>
					A sintaxe do <literal>Require</literal> só está disponível no Apache 2.4 (a versão na <emphasis role="distribution">Jessie</emphasis>). Para usuários do <emphasis role="distribution">Wheezy</emphasis>, a sintaxe no Apache 2.2 é diferente, e nós a descrevemos aqui principalmente para referência, embora ela possa também ficar disponível no Apache 2.4 usando o môdulo<literal>mod_access_compat</literal>.
				</para>
				 <para>
					As diretivas <literal>Allow from</literal> e <literal>Deny from</literal> controlam as restrições de acesso em um diretório (e seus sub-diretórios, recursivamente).
				</para>
				 <indexterm>
					<primary><literal>Allow from</literal>, diretivas do Apache</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Deny from</literal>, diretivas do Apache</primary>
				</indexterm>
				 <indexterm>
					<primary><literal>Order</literal>, diretivas do Apache</primary>
				</indexterm>
				 <para>
					A diretiva <literal>Order</literal> informa ao servidor a ordem em que as diretivas <literal>Allow from</literal> e <literal>Deny from</literal> são aplicadas; A última que coincidir tem precedência. Em termos concretos, <literal>Order deny,allow</literal> permite acesso se nenhum <literal>Deny from</literal> se aplica, ou se uma diretiva <literal>Allow from</literal> aplica. Por outro lado, <literal>Order allow,deny</literal> rejeita acesso se nenhuma diretiva <literal>Allow from</literal> coincide (ou se uma diretiva <literal>Deny from</literal> se aplica).
				</para>
				 <para>
					As diretivas <literal>Allow from</literal> e <literal>Deny from</literal> podem ser seguidas de um endereço IP, uma rede (como <literal>192.168.0.0/255.255.255.0</literal>, <literal>192.168.0.0/24</literal> ou mesmo <literal>192.168.0</literal>), um nome de máquina ou nome de domínio, ou a palavra chave <literal>all</literal>, designando todos.
				</para>
				 <para>
					Por exemplo, para rejeitar conexões por padrão mas permití-las a partir da rede local, você poderia usar isso:
				</para>
				 
<programlisting>
Order deny,allow
Allow from 192.168.0.0/16
Deny from all</programlisting>
				 </sidebar>
			</section>

		</section>
		 <section>
			<title>Analisadores de Log</title>
			 <para>
				Um analisador de log é frequentemente instalado em um servidor web; já que o primeiro fornece aos administradores uma ideia precisa do padrão de uso do último.
			</para>
			 <para>
				Os administradores da Falcot Corp selecionaram o <emphasis>AWStats</emphasis> (<emphasis>Advanced Web Statistics</emphasis>) para analisar seus arquivos de log do Apache.
			</para>
			 <indexterm>
				<primary><emphasis>AWStats</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary>analisador de registros web</primary>
			</indexterm>
			 <indexterm>
				<primary>registros</primary>
				<secondary>analisador de registros web</secondary>
			</indexterm>
			 <indexterm>
				<primary>analisador de registros web</primary>
			</indexterm>
			 <para>
				O primeiro passo de configuração é a customização do arquivo <filename>/etc/awstats/awstats.conf</filename>. O administradores da Falcot o mantiveram inalterado, exceto os seguintes parâmetros:
			</para>
			 
<programlisting>
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
LoadPlugin="tooltips"</programlisting>
			 <para>
				Todos esses parâmetros são documentados através de comentários no arquivo de exemplo. Em particular, os parâmetros <varname>LogFile</varname> e <varname>LogFormat</varname> descrevem a localização e o formato do arquivo de log e a informação que ele contém; <varname>SiteDomain</varname> e <varname>HostAliases</varname> listam os vários nomes pelos quais o site web principal é conhecido.
			</para>
			 <para>
				Para sites com alto tráfego, <varname>DNSLookup</varname> geralmente não deveria ser configurado como <literal>1</literal>; para sites menores, como o da Falcot descrito acima, essa configuração permite ter relatórios mais legíveis, que incluem o nome completo da máquina ao invés de simplesmente endereços IP.
			</para>
			 <sidebar> <title><emphasis>SEGURANÇA</emphasis> Acesso as estatísticas</title>
			 <para>
				O AWStats deixa suas estatísticas disponíveis no site web sem restrições por padrão, mas restrições podem ser configuradas para que apenas alguns endereços IP (provavelmente internos) possam ter acesso a elas; a lista de endereços IP com permissão precisa ser definida no parâmetro <varname>AllowAccessFromWebToFollowingIPAddresses</varname>
			</para>
			 </sidebar> <para>
				O AWStats também será habilitado para outros hosts virtuais; cada host virtual precisa de um arquivo de configuração próprio como <filename>/etc/awstats/awstats.www.falcot.org.conf</filename>.
			</para>
			 <example>
				<title>Arquivo de configuração dO AWStats para um servidor virtual</title>
				 
<programlisting>
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"</programlisting>

			</example>
			 <para>
				O AWStats usa muitos ícones que estão armazenados no diretório <filename>/usr/share/awstats/icon/</filename>. Para que esses ícones fiquem disponíveis no site web, a configuração do Apache precisa ser adaptada para incluir as seguintes diretivas:
			</para>
			 
<programlisting>
Alias /awstats-icon/ /usr/share/awstats/icon/</programlisting>
			 <para>
				Após alguns minutos (e uma vez que o script tenha sido rodado algumas vezes), os resultados ficarão disponíveis online: <ulink type="block" url="http://www.falcot.com/cgi-bin/awstats.pl" /><ulink type="block" url="http://www.falcot.org/cgi-bin/awstats.pl" />
			</para>
			 <sidebar> <title><emphasis>ATENÇÃO</emphasis> Rotação dos arquivos de registro</title>
			 <para>
				Para que as estatísticas levem em consideração todos os logs, o <emphasis>AWStats</emphasis> precisa ser executado antes que os arquivos de log do Apache sejam rotacionados. Olhando a diretiva <literal>prerotate</literal> do arquivo <filename>/etc/logrotate.d/apache2</filename>, isso pode ser resolvido colocando um link simbólico em <filename>/usr/share/awstats/tools/update.sh</filename> no <filename>/etc/logrotate.d/httpd-prerotate</filename>:
			</para>
			 
<screen><computeroutput>$ </computeroutput><userinput>cat /etc/logrotate.d/apache2
</userinput><computeroutput>/var/log/apache2/*.log {
  daily
  missingok
  rotate 14
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  postrotate
    if /etc/init.d/apache2 status &gt; /dev/null ; then \
      /etc/init.d/apache2 reload &gt; /dev/null; \
    fi;
  endscript
  prerotate
    if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
      run-parts /etc/logrotate.d/httpd-prerotate; \
    fi; \
  endscript
}
$ </computeroutput><userinput>sudo mkdir -p /etc/logrotate.d/httpd-prerotate
</userinput><computeroutput>$ </computeroutput><userinput>sudo ln -sf /usr/share/awstats/tools/update.sh \
  /etc/logrotate.d/httpd-prerotate/awstats
</userinput></screen>
			 <para>
				Note também que os arquivos de log criados pelo <command>logrotate</command> precisam ter permissão de leitura para todos, especialmente o AWStats. No exemplo acima, isso é garantido pela linha <literal>create 644 root adm</literal> (ao invés da permissão padrão <literal>640</literal>).
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.ftp-file-server">
		<title>Servidor de Arquivos FTP</title>
		 <indexterm>
			<primary>FTP (<emphasis>File Transfer Protocol</emphasis>)</primary>
		</indexterm>
		 <para>
			O FTP (<emphasis>File Transfer Protocol</emphasis>) é um dos primeiros protocolos da internet (a RFC 959 foi emitida em 1985!). Ele era usado para distribuir arquivos antes mesmo que a Web tivesse nascido (o protocolo HTTP foi criado em 1990, e formalmente definido em sua versão 1.0 pela RFC 1945, emitida em 1996).
		</para>
		 <para>
			Esse protocolo permite tanto enviar arquivos quanto baixar arquivos; por essa razão, ele ainda é amplamente usado para implantar atualizações em um site web hospedado em um provedor de serviço de internet de alguém (ou qualquer outra entidade que hospede sites web). Nesses casos, o acesso seguro é reforçado com a identificação de usuário e uma senha; em caso de sucesso na autenticação, o servidor FTP dá acesso a leitura-escrita para o diretório principal (home) do usuário.
		</para>
		 <para>
			Outros servidores FTP são principalmente usados para distribuir arquivos para qualquer um baixar; os pacotes Debian são um bom exemplo. O conteúdo desses servidores é obtido de outro servidor geograficamente remoto; e então disponibilizados para usuários menos distantes. Isso significa que a autenticação do cliente não é necessária; como consequência, esse modo de operação é conhecido como “anonymous FTP”. Para ser mais correto, os cliente fazem uma autenticação com nome de usuário <literal>anonymous</literal>; a senha é, geralmente, por convenção, o endereço de email do usuário, mas o servidor ignora isso.
		</para>
		 <para>
			Estão disponíveis no Debian muitos servidores FTP (<emphasis role="pkg">ftpd</emphasis>, <emphasis role="pkg">proftpd-basic</emphasis>, <emphasis role="pkg">pyftpd</emphasis> e mais). Os administradores da Falcot Corp escolheram o <emphasis role="pkg">vsftpd</emphasis> porque eles apenas usam o servidor FTP para distribuir alguns arquivos (incluindo um repositório de pacotes Debian); como eles não precisam de recursos avançados, eles escolheram focar nos aspectos de segurança.
		</para>
		 <indexterm>
			<primary><emphasis role="pkg">vsftpd</emphasis></primary>
		</indexterm>
		 <para>
			A instalação do pacote cria um usuário <literal>ftp</literal> no sistema. Essa conta é sempre usada para conexões de FTP anônimas, e seu diretório inicial (home) (<filename>/srv/ftp/</filename>) é a raiz da árvore que está disponível ao usuários que se conectam a esse serviço. A configuração padrão (em <filename>/etc/vsftpd.conf</filename>) necessita de algumas mudanças para atender a simples necessidade de tornar grandes arquivos disponíveis para baixar pelo público: o acesso anônimo precisa ser habilitado (<literal>anonymous_enable=YES</literal>) e o acesso apenas para leitura de usuários locais precisa ser desabilitado (<literal>local_enable=NO</literal>). Esse último é particularmente importante já que o protocolo FTP não usa nenhuma forma de criptografia e a senha do usuário poderia ser interceptada pelo cabo.
		</para>

	</section>
	 <section id="sect.nfs-file-server">
		<title>Servidor de Arquivos NFS</title>
		 <para>
			O NFS (<emphasis>Network File System</emphasis>) é um protocolo que permite acesso remoto a um sistema de arquivos através da rede. Todos os sistemas Unix podem trabalhar com esse protocolo; mas quando sistemas Windows estão envolvidos, o Samba tem que ser usado.
		</para>
		 <indexterm>
			<primary>NFS</primary>
		</indexterm>
		 <indexterm>
			<primary><emphasis>Rede</emphasis></primary>
			<secondary><emphasis>Sistema de Arquivos</emphasis></secondary>
		</indexterm>
		 <indexterm>
			<primary>sistema de arquivos</primary>
			<secondary>rede</secondary>
		</indexterm>
		 <indexterm>
			<primary>arquivo</primary>
			<secondary>servidor</secondary>
		</indexterm>
		 <indexterm>
			<primary>servidor</primary>
			<secondary>arquivo</secondary>
		</indexterm>
		 <para>
			O NFS é uma ferramenta muito útil, mas historicamente, ela tem sofrido com muitas limitações, a maioria delas tendo sido atribuídas a versão 4 do protocolo. A contrapartida é que a última versão do NFS é mais difícil de configurar quando você quer usar recursos básicos de segurança tais como autenticação e criptografia já que ele faz uso do Kerberos para esses assuntos. E sem isso, o protocolo NFS tem que ficar restrito a uma rede local confiável já que os dados viajam pela rede sem criptografia (um <emphasis>sniffer</emphasis> pode interceptá-los) e os direitos de acesso são optidos com base no endereço IP do cliente (que pode ser falsificado ("spoofed")).
		</para>
		 <sidebar> <title><emphasis>DOCUMENTAÇÃO</emphasis> NFS HOWTO</title>
		 <para>
			Boa documentação para implementar o NFSv4 é bastante escassa. Aqui estão algumas indicações de conteúdo com qualidade variável, mas que devem ao menos dar algumas pistas sobre o que deve ser feito. <ulink type="block" url="https://help.ubuntu.com/community/NFSv4Howto" /> <ulink type="block" url="http://wiki.linux-nfs.org/wiki/index.php/Nfsv4_configuration" />
		</para>
		 </sidebar> <section>
			<title>Proteção do NFS</title>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>segurança</secondary>
			</indexterm>
			 <para>
				Se você não usa recursos de segurança baseados no Kerberos, é vital garantir que apenas máquinas com permissão de usar o NFS possam se conectar nos vários servidores RPC requeridos, porque o protocolo básico confia nos dados recebidos a partir da rede. O firewall tem também que bloquear <emphasis>IP spoofing</emphasis> para prevenir que uma máquina de fora atue como uma de dentro, e acesso às portas apropriadas tem que ser restrito às máquinas destinadas a acessar os compartilhamentos NFS.
			</para>
			 <sidebar> <title><emphasis>DE VOLTA AO BÁSICO</emphasis> RPC</title>
			 <para>
				RPC (<emphasis>Remote Procedure Call</emphasis>) é um padrão Unix para serviços remotos. O NFS é um desses serviços.
			</para>
			 <indexterm>
				<primary>RPC</primary>
			</indexterm>
			 <indexterm>
				<primary><emphasis>Remote Procedure Call</emphasis></primary>
			</indexterm>
			 <para>
				Os serviços RPC se registram em um diretório conhecido como <emphasis>portmapper</emphasis>. Um cliente querendo realizar uma consulta NFS primeiro consulta o <emphasis>portmapper</emphasis> (na porta 111, seja TCP ou UDP), e pergunta pelo servidor NFS; a resposta gralmente vem pela porta 2049 (a padrão para o NFS). Nem todos os serviços RPC necessariamente usam uma porta fixa.
			</para>
			 </sidebar> <para>
				Versões mais antigas do protocolo necessitavam de outros serviços RPC que usavam portas dinamicamente atribuídas. Felizmente, com a versão 4 do NFS, apenas a porta 2049 (para NFS) e 111 (para o portmapper) são necessárias, e assim, fácil de configurar no firewall.
			</para>
			 <indexterm>
				<primary><command>portmapper</command></primary>
			</indexterm>

		</section>
		 <section>
			<title>Servidor NFS</title>
			 <para>
				O servidor NFS é parte do núcleo Linux; nos núcleos fornecidos peloDebian ele é construído como um módulo do núcleo. Se o servidor NFS tem que ser rodado automaticamente na inicialização, o pacote <emphasis role="pkg">nfs-kernel-server</emphasis> deve ser instalado; ele contém os scripts de inicialização relevantes.
			</para>
			 <para>
				O arquivo de configuração do servidor NFS, <filename>/etc/exports</filename>, lista os diretórios que estão disponíveis através da rede (<emphasis>exported</emphasis>). Para cada compartilhamento NFS, apenas uma determinada lista de máquinas tem acesso permitido. Um controle mais refinado de acesso pode ser obtido com algumas opções. A sintaxe para esse arquivo é bem simples:
			</para>
			 <indexterm>
				<primary><filename>exports</filename></primary>
			</indexterm>
			 <indexterm>
				<primary><filename>/etc/exports</filename></primary>
			</indexterm>
			 
<programlisting>
/diretório/para/compartilhar máquina1(opção1,opção2,...) máquina2(...) ...</programlisting>
			 <para>
				Note que com o NFSv4, todos os diretórios exportados tem que ser parte de uma única hierarquia e que o diretório raiz dessa hierarquia tem que ser exportado e identificado com a opção <literal>fsid=0</literal> ou <literal>fsid=root</literal>.
			</para>
			 <para>
				Cada máquina pode ser identificada tanto pelo seu nome no DNS quanto seu endereço IP. Todo um conjunto de máquinas pode também ser especificado usando tanto uma sintaxe como <literal>*.falcot.com</literal> ou um intervalo de endereços IP como <literal>192.168.0.0/255.255.255.0</literal> ou <literal>192.168.0.0/24</literal>.
			</para>
			 <para>
				Os diretórios ficam disponíveis apenas para leitura por padrão (ou com a opção <literal>ro</literal>). A opção <literal>rw</literal> permite o acesso a leitura-escrita. Os clientes NFS tipicamente fazem a conexão a partir de uma porta restrita ao root (em outras palavras, abaixo da 1024); essa restrição pode ser elevada pela opção <literal>insecure</literal> (a opção <literal>secure</literal> é implícita, mas pode ser explícita para mais clareza).
			</para>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>opções</secondary>
			</indexterm>
			 <para>
				Por padrão, o servidor apenas responde a uma consulta NFS quando a operação de disco corrente é concluída (opção <literal>sync</literal>); isso pode ser desabilitado com a opção <literal>async</literal>. A escrita assíncrona aumenta um pouco a performance, mas ela diminui a confiança já que existe o risco de perda de dados no caso do servidor falhar entre comunicar a escrita e realmente escrever no disco. Como o valor padrão foi alterado recentemente (comparado ao valor histórico do NFS), uma configuração explícita é recomendada.
			</para>
			 <para>
				Para que não seja dado acesso de root no sistema de arquivos a nenhum cliente NFS, todas as consultas que parecem vir do usuário root são consideradas pelo servidor como vindo do usuário <literal>nobody</literal>. Esse comportamento corresponde à opção <literal>root_squash</literal>, e é habilitado por padrão. A opção <literal>no_root_squash</literal>, que desabilita esse comportamento, é arriscada e só deveria ser usada em ambientes controlados. As opções <literal>anonuid=<replaceable>uid</replaceable></literal> e <literal>anongid=<replaceable>gid</replaceable></literal> permitem especificar outro usuário falso a ser usado ao invés de UID/GID 65534 (que corresponde ao usuário <literal>nobody</literal> e ao grupo <literal>nogroup</literal>).
			</para>
			 <para>
				Com o NFSv4, você pode adicionar uma opção <literal>sec</literal> para indicar o nível de segurançaque você quer: <literal>sec=sys</literal> é o padrão, sem recursos especiais de segurança, <literal>sec=krb5</literal> habilita apenas a autenticação, <literal>sec=krb5i</literal> adiciona proteção de integridade, e <literal>sec=krb5p</literal> é o mais completo nível, que inclui proteção de privacidade (com criptografia de dados). Para isso funcionar você precisa do Kerberos configurado e funcionando (esse serviço não é coberto por esse livro).
			</para>
			 <para>
				Outras opções estão disponíveis; elas estão documentadas na página de manual <citerefentry><refentrytitle>exports</refentrytitle>
				 <manvolnum>5</manvolnum></citerefentry>.
			</para>
			 <sidebar> <title><emphasis>ATENÇÃO</emphasis> Primeira instalação</title>
			 <para>
				O script de inicialização <filename>/etc/init.d/nfs-kernel-server</filename> apenas inicia o servidor se o <filename>/etc/exports</filename> lista um ou mais compartilhamentos NFS válidos. Na configuração inicial, uma vez que esse arquivo tenha sido editado para conter entradas válidas, o servidor NFS já pode ser iniciado com o seguinte comando:
			</para>
			 
<screen>
<computeroutput># </computeroutput><userinput>service nfs-kernel-server start</userinput></screen>
			 </sidebar>
		</section>
		 <section>
			<title>Cliente NFS</title>
			 <indexterm>
				<primary>cliente</primary>
				<secondary>NFS</secondary>
			</indexterm>
			 <indexterm>
				<primary>NFS</primary>
				<secondary>cliente</secondary>
			</indexterm>
			 <para>
				Como acontece com outros sistemas de arquivos, a integração do compartilhamento NFS na hierarquia do sistema requer montagem. Já que esse sistema de arquivos tem suas peculiaridades, alguns ajustes foram necessários na sintaxe do comando <command>mount</command> e do arquivo <filename>/etc/fstab</filename>.
			</para>
			 <example>
				<title>Montando manualmente com o comando <command>mount</command></title>
				 
<screen>
          <computeroutput># </computeroutput><userinput>mount -t nfs4 -o rw,nosuid arrakis.internal.falcot.com:/shared /srv/shared</userinput></screen>

			</example>
			 <example>
				<title>Entrada NFS no arquivo <filename>/etc/fstab</filename></title>
				 
<programlisting>
arrakis.internal.falcot.com:/shared /srv/shared nfs4 rw,nosuid 0 0</programlisting>

			</example>
			 <para>
				A entrada descrita acima monta, ao levantar o sistema, o diretório NFS <filename>/shared/</filename> no servidor <literal>arrakis</literal> dentro do diretório local <filename>/srv/shared/</filename>. O acesso de leitura-escrita é requisitado (visto o parâmetro <literal>rw</literal>). A opção <literal>nosuid</literal> é uma medida de proteção que apaga qualquer bit <literal>setuid</literal> ou <literal>setgid</literal> de programas armazenados no compartilhamento. Se o compartilhamento NFS é apenas para armazenar documentos, outra opção recomendada é a <literal>noexec</literal>, a qual previne a execução de programas armazenados no compartilhamento. Note que no servidor, o diretório <filename>shared</filename> está abaixo da raiz NFSv4 exportada ( por exemplo, <filename>/export/shared</filename>), não é um diretório de nível mais alto.
			</para>
			 <para>
				A página de manual <citerefentry><refentrytitle>nfs</refentrytitle>
				 <manvolnum>5</manvolnum></citerefentry> descreve todas as opções com alguns detalhes.
			</para>

		</section>

	</section>
	 <section id="sect.windows-file-server-with-samba">
		<title>Configurando um Compartilhamento Windows com o Samba</title>
		 <para>
			O Samba é um conjunto de ferramentas para lidar com o protocolo SMB (também conhecido como “CIFS”) no Linux. Esse protocolo é usado pelo Windows para compartilhamento de rede e impressoras compartilhadas.
		</para>
		 <indexterm>
			<primary>Compartilhamento Windows</primary>
		</indexterm>
		 <indexterm>
			<primary>Samba</primary>
		</indexterm>
		 <indexterm>
			<primary>SMB</primary>
		</indexterm>
		 <indexterm>
			<primary>CIFS</primary>
		</indexterm>
		 <indexterm>
			<primary>servidor</primary>
			<secondary>arquivo</secondary>
		</indexterm>
		 <para>
			Samba também pode atuar como um controlador de domínio Windows. Esta é uma excelente ferramenta para garantir a perfeita integração de servidores Linux e as máquinas desktop de escritório ainda com o Windows.
		</para>
		 <section>
			<title>Servidor Samba</title>
			 <para>
				O pacote <emphasis role="pkg">samba</emphasis> contém os dois principais servidores do Samba 4, <command>smbd</command> e <command>nmbd</command>.
			</para>
			 <indexterm>
				<primary><command>smbd</command></primary>
			</indexterm>
			 <indexterm>
				<primary><command>nmbd</command></primary>
			</indexterm>
			 <sidebar> <title><emphasis>DOCUMENTAÇÃO</emphasis> Aprofundando</title>
			 <para>
				O servidor Samba é extremamente configurável e versátil, e pode se adaptar a um grande número de casos de uso diferentes se encaixando em muitos requerimentos e arquiteturas de rede diferentes. Esse livro apenas foca no caso de uso aonde o Samba é usado como servidor autônomo, mas ele também pode ser um Controlador de Domínio NT4 ou um completo Controlador de Domínio de Diretório Ativo ("Active Directory Domain Controller"), ou um simples membro de um domínio existente (o qual poderia ser gerenciado po um servidor Windows).
			</para>
			 <indexterm>
				<primary>controle de domínio</primary>
			</indexterm>
			 <indexterm>
				<primary>Domínio Windows</primary>
			</indexterm>
			 <para>
				O pacote <emphasis role="pkg">samba-doc</emphasis> contém, com riqueza de comentários, arquivos de exemplo em <filename>/usr/share/doc/samba-doc/examples/</filename>.
			</para>
			 </sidebar> <sidebar> <title><emphasis>FERRAMENTA</emphasis> Autenticando com um Servidor Windows</title>
			 <para>
				Winbind dá aos administradores de sistema a opção de usar um servidor Windows como um servidor de autenticação. Winbind também se integra de forma limpa com PAM e NSS. Isso permite configurar máquinas Linux aonde todos os usuários de um domínio Windows automaticamente tenham uma conta.
			</para>
			 <indexterm>
				<primary>Winbind</primary>
			</indexterm>
			 <para>
				Mais informações podem ser obtidas no diretório <filename>/usr/share/doc/samba-doc/examples/pam_winbind/</filename>.
			</para>
			 </sidebar> <section>
				<title>Configurando com <command>debconf</command></title>
				 <para>
					O pacote realiza uma configuração mínima durante a instalação inicial mas você realmente deve rodar <command>dpkg-reconfigure samba-common</command> para adaptá-la:
				</para>
				 <para>
					O primeiro item de informação necessária é o nome do grupo de trabalho ("workgroup") ao qual o servidor Samba pertencerá (a resposta é <literal>FALCOTNET</literal> em nosso caso).
				</para>
				 <para>
					O pacote também propõe a identificação do servidor WINS a partir da informação fornecida pelo daemon DHCP. Os administradores da Falcot Corp rejeitaram essa opção, já que eles tem a intenção de usar o próprio servidor Samba como um servidor WINS.
				</para>
				 <indexterm>
					<primary>WINS</primary>
				</indexterm>

			</section>
			 <section>
				<title>Configurando Manualmente</title>
				 <section>
					<title>Mudanças no <filename>smb.conf</filename></title>
					 <para>
						Os requerimentos na Falcot fazem necessário que outras opção sejam modificadas no arquivo de configuração <filename>/etc/samba/smb.conf</filename>. O trecho a seguir resumem as alterações que foram feitas na seção <literal>[global]</literal>.
					</para>
					 
<programlisting>
[global]

## Browsing/Identification ###

# Change this to the workgroup/NT-domain name your Samba server will part of
   workgroup = FALCOTNET

# Windows Internet Name Serving Support Section:
# WINS Support - Tells the NMBD component of Samba to enable its WINS Server
   wins support = yes <co id="smb.conf.wins"></co>

[...]

####### Authentication #######

# Server role. Defines in which mode Samba will operate. Possible
# values are "standalone server", "member server", "classic primary
# domain controller", "classic backup domain controller", "active
# directory domain controller". 
#
# Most people will want "standalone sever" or "member server".
# Running as "active directory domain controller" will require first
# running "samba-tool domain provision" to wipe databases and create a
# new domain.
   server role = standalone server

# "security = user" is always a good idea. This will require a Unix account
# in this server for every user accessing the server.
   security = user <co id="smb.conf.security"></co>

[...]</programlisting>
					 <calloutlist>
						<callout arearefs="smb.conf.wins">
							<para>
								Indica que o Samba deveria atuar como um servidor de nomes Netbios (WINS) para a rede local.
							</para>

						</callout>
						 <callout arearefs="smb.conf.security">
							<para>
								Esse é o valor padrão para esse parâmetro; contudo, como ele é central para a configuração do Samba, o recomendado é preenchê-lo explicitamente. cada usuário tem que se autenticar antes de acessar qualquer compartilhamento.
							</para>

						</callout>

					</calloutlist>

				</section>
				 <section>
					<title>Adicionando Usuários</title>
					 <para>
						Cada usuário do Samba precisa ter uma conta no servidor; as contas Unix tem que ser criadas primeiro, depois o usuário precisa ser registrado no banco de dados do Samba. O passo no Unix é feito bem facilmente (usando o <command>adduser</command> por exemplo).
					</para>
					 <para>
						Adicionar um usuário existente ao banco de dados do Samba é uma questão de rodar o comando <command>smbpasswd -a <replaceable>usuário</replaceable></command>; esse comando pergunta pela senha interativamente.
					</para>
					 <para>
						Um usuário pode ser apagado com o comando <command>smbpasswd -x <replaceable>usuário</replaceable></command>. Uma conta Samba também pode ser temporariamente desabilitada (com <command>smbpasswd -d <replaceable>usuário</replaceable></command>) e reabilitada mais tarde (com <command>smbpasswd -e <replaceable>usuário</replaceable></command>).
					</para>

				</section>

			</section>

		</section>
		 <section>
			<title>Cliente Samba</title>
			 <para>
				Os recursos do cliente no Samba permitem que uma máquina Linux acesse compartilhamentos Windows e impressoras compartilhadas. Os programas necessários estão disponíveis nos pacotes <emphasis role="pkg">cifs-utils</emphasis> e <emphasis role="pkg">smbclient</emphasis>.
			</para>
			 <indexterm>
				<primary><emphasis>smbclient</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary><emphasis>cifs-utils</emphasis></primary>
			</indexterm>
			 <section>
				<title>O Programa <command>smbclient</command></title>
				 <para>
					O programa <command>smbclient</command> consulta servidores SMB. Ele aceita a opção <literal>-U <replaceable>usuário</replaceable></literal>, para conectar em um servidor sob uma identidade específica. <command>smbclient //<replaceable>servidor</replaceable>/<replaceable>compartilhamento</replaceable></command> acessa o compartilhamento de maneira interativa, similar a linha de comando de um cliente FTP. <command>smbclient -L <replaceable>servidor</replaceable></command> lista todos os compartilhamentos disponíveis (e visíveis) em um servidor.
				</para>

			</section>
			 <section>
				<title>Montando Compartilhamentos Windows</title>
				 <para>
					O comando <command>mount</command> permite montar um compartilhamento Windows na hierarquia do sistema de arquivos do Linux (com a ajuda do <command>mount.cifs</command> fornecido pelo <emphasis role="pkg">cifs-utils</emphasis>).
				</para>
				 <indexterm>
					<primary><command>mount.cifs</command></primary>
				</indexterm>
				 <indexterm>
					<primary>Compartilhamento Windows, montagem</primary>
				</indexterm>
				 <example>
					<title>Montando um compartilhamento Windows</title>
					 
<programlisting>
mount -t cifs //arrakis/shared /shared \
      -o credentials=/etc/smb-credentials</programlisting>

				</example>
				 <para>
					O arquivo <filename>/etc/smb-credentials</filename> (o qual não deve ser legível pelos usuários) tem o seguinte formato:
				</para>
				 
<programlisting>
username = <replaceable>user</replaceable>
password = <replaceable>password</replaceable></programlisting>
				 <para>
					Outras opções podem ser especificadas pela linha de comando; sua lista completa está disponível na página de manual <citerefentry><refentrytitle>mount.cifs</refentrytitle>
					 <manvolnum>1</manvolnum></citerefentry>. Duas opções em particular podem ser interessantes: <literal>uid</literal> e <literal>gid</literal> permitem forçar o dono e grupo dos arquivos disponíveis na montagem, de modo a não restringir o acesso para o root.
				</para>
				 <para>
					A montagem de um compartilhamento Windows também pode ser configurada em <filename>/etc/fstab</filename>:
				</para>
				 
<programlisting>
//<replaceable>servidor</replaceable>/shared /shared cifs credentials=/etc/smb-credentials</programlisting>
				 <para>
					Desmontando um compartilhamento SMB/CIFS é feito com o comando padrão <command>umount</command>.
				</para>

			</section>
			 <section>
				<title>Imprimindo com uma Impressora Compartilhada</title>
				 <para>
					CUPS é uma solução elegante para impressão a partir de uma estação de trabalho Linux em uma impressora compartilhada por uma máquina Windows. Quando o <emphasis role="pkg">smbclient</emphasis> está instalado, o CUPS permite a instalação de impressoras Windows compartilhadas automaticamente.
				</para>
				 <indexterm>
					<primary>impressão</primary>
					<secondary>rede</secondary>
				</indexterm>
				 <para>
					Aqui estão os passos necessários:
				</para>
				 <itemizedlist>
					<listitem>
						<para>
							Entre na interface de configuração do CUPS: <literal>http://localhost:631/admin</literal>
						</para>

					</listitem>
					 <listitem>
						<para>
							Clique em "Adicionar Impressora".
						</para>

					</listitem>
					 <listitem>
						<para>
							Selecione o dispositivo de impressora, escolha “Impressora Windows via SAMBA”.
						</para>

					</listitem>
					 <listitem>
						<para>
							Insira a conexão URI para a impressora de rede. Deve se parecer com o seguinte:
						</para>
						 <para>
							<literal>smb://<replaceable>usuário</replaceable>:<replaceable>senha</replaceable>@<replaceable>servidor</replaceable>/<replaceable>impressora</replaceable></literal>.
						</para>

					</listitem>
					 <listitem>
						<para>
							Digite o nome que irá identificar de maneira única essa impressora. Em seguida digite a descrição e localização da impressora. Essas são as cadeias de caracteres que irão ser mostradas aos usuários finais para ajudá-los a identificar as impressoras.
						</para>

					</listitem>
					 <listitem>
						<para>
							Indicar o fabricante/modelo da impressora, ou fornecer diretamente um arquivo funcional de descrição da impressora (PPD).
						</para>

					</listitem>

				</itemizedlist>
				 <para>
					Voilà, a impressora está operacional!
				</para>

			</section>

		</section>

	</section>
	 <section id="sect.http-ftp-proxy">
		<title>Proxy HTTP/FTP</title>
		 <para>
			Um proxy HTTP/FTP atua como um intermediário para conexões HTTP e/ou FTP. Seu papel é duplo:
		</para>
		 <itemizedlist>
			<listitem>
				<para>
					Caching: documentos recentemente baixados são copiados localmente, o que evita baixá-los mais de uma vez.
				</para>

			</listitem>
			 <listitem>
				<para>
					Servidor de filtragem: se o uso do proxy é obrigatório (e conexões de saída são bloqueadas a menos que elas passem através do proxy), então o proxy pode determinar quando a requisição pode ser concedida.
				</para>

			</listitem>

		</itemizedlist>
		 <indexterm>
			<primary>proxy HTTP/FTP</primary>
		</indexterm>
		 <indexterm>
			<primary>proxy cache</primary>
		</indexterm>
		 <para>
			Falcot Corp selecionou o Squid como seu servidor de proxy.
		</para>
		 <indexterm>
			<primary>Squid</primary>
		</indexterm>
		 <section>
			<title>Instalando</title>
			 <para>
				O pacote Debian <emphasis role="pkg">squid3</emphasis> contém apenas o proxy (e cache) modular. Fazer dele um servidor de filtragem requer a instalação do pacote adicional <emphasis role="pkg">squidguard</emphasis>. Adicionalmente, o <emphasis role="pkg">squid-cgi</emphasis> provê uma interface de consulta e administração para o proxy Squid.
			</para>
			 <para>
				Antes da instalação, deve-se tomar o cuidado de checar que o sistema pode identificar seu próprio nome completo: o <command>hostname -f</command> tem que retornar um nome completo qualificado (incluindo o domínio). Se não, então o arquivo <filename>/etc/hosts</filename> deve ser editado para conter o nome completo do sistema (por exemplo, <literal>arrakis.falcot.com</literal>). O nome oficial do computador deve ser validado pelo administrador de rede para que sejam evitados potenciais conflitos de nome.
			</para>

		</section>
		 <section>
			<title>Configurando um Cache</title>
			 <para>
				Habilitar o recurso de cache no servidor é uma simples questão de editar o arquivo de configuração <filename>/etc/squid3/squid.conf</filename> e permitir que máquinas da rede local executem consultas através do proxy. Os exemplos a seguir mostram as modificações feitas pelos administradores da Falcot Corp:
			</para>
			 <example>
				<title>O arquivo <filename>/etc/squid3/squid.conf</filename> (trecho)</title>
				 
<programlisting>
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS

# Example rule allowing access from your local networks. Adapt
# to list your (internal) IP networks from where browsing should
# be allowed
acl our_networks src 192.168.1.0/24 192.168.2.0/24
http_access allow our_networks
http_access allow localhost
# And finally deny all other access to this proxy
http_access deny all</programlisting>

			</example>

		</section>
		 <section>
			<title>Configurando um Filtro</title>
			 <para>
				O <command>squid</command> sozinho não faz a filtragem; essa ação é delegada ao <command>squidGuard</command>. O primeiro tem então que ser configurado para interagir com o último. Isso envolve a adição da seguinte diretiva ao arquivo <filename>/etc/squid3/squid.conf</filename>:
			</para>
			 <indexterm>
				<primary><command>squidGuard</command></primary>
			</indexterm>
			 
<programlisting>
url_rewrite_program /usr/bin/squidGuard -c /etc/squid3/squidGuard.conf</programlisting>
			 <para>
				O programa CGI <filename>/usr/lib/cgi-bin/squidGuard.cgi</filename> também precisa estar instalado, usando <filename>/usr/share/doc/squidguard/examples/squidGuard.cgi.gz</filename> como ponto de partida. As modificações necessárias para esse script são as variáveis <varname>$proxy</varname> e <varname>$proxymaster</varname> (o nome do proxy e o email de contato do administrador, respectivamente). As variáveis <varname>$image</varname> e <varname>$redirect</varname> devem apontar para imagens existentes que representam a rejeição de uma consulta.
			</para>
			 <para>
				O filtro é habilitado com o comando <command>service squid3 reload</command>. Contudo, como o pacote <emphasis role="pkg">squidguard</emphasis> não faz filtragem por padrão, é tarefa do administrador definir a política. Isso pode ser feito criando o arquivo <filename>/etc/squid3/squidGuard.conf</filename> (usando o <filename>/etc/squidguard/squidGuard.conf.default</filename> como modelo se necessário).
			</para>
			 <para>
				O banco de dados em uso tem que ser regenerado com <command>update-squidguard</command> após cada alteração feita no arquivo de configuração <command>squidGuard</command> (ou em uma das listas de domínios ou URLs que ele menciona). A sintaxe do arquivo de configuração é documentada no seguinte site web: <ulink type="block" url="http://www.squidguard.org/Doc/configure.html" />
			</para>
			 <indexterm>
				<primary><command>update-squidguard</command></primary>
			</indexterm>
			 <sidebar> <title><emphasis>ALTERNATIVA</emphasis> DansGuardian</title>
			 <indexterm>
				<primary><emphasis role="pkg">dansguardian</emphasis></primary>
			</indexterm>
			 <indexterm>
				<primary>PICS</primary>
			</indexterm>
			 <para>
				O pacote <emphasis role="pkg">dansguardian</emphasis> é uma alternativa ao <emphasis>squidguard</emphasis>. Esse software não apenas lida com uma lista negra de URLs proibidas, mas pode ter tirar vantagem do sistema PICS (<emphasis>Platform for Internet Content Selection</emphasis>) para decidir quando uma página é aceitável através de uma análise dinâmica de seu conteudo.
			</para>
			 </sidebar>
		</section>

	</section>
	 <section id="sect.ldap-directory">
		<title>Diretório LDAP</title>
		 <indexterm>
			<primary>LDAP</primary>
		</indexterm>
		 <indexterm>
			<primary>OpenLDAP</primary>
		</indexterm>
		 <indexterm>
			<primary>diretório, LDAP</primary>
		</indexterm>
		 <para>
			OpenLDAP é uma implementação do protocolo LDAP; em outras palavras, é um banco de dados com propósito especial desenvolvido para armazenar diretórios. No caso mais comum de uso, o uso de um servidor LDAP permite o gerenciamento centralizado de contas de usuários e permissões relacionadas. Além do mais, um banco de dados LDAP é facilmente replicável, o que permite configurar múltiplos servidores LDAP sincronizados. Quando a rede e a base de usuários cresce rapidamente, a carga pode então ser balanceada por entre vários servidores.
		</para>
		 <para>
			Os dados LDAP são estruturados e hierárquicos. A estrutura é definida por “schemas” que descrevem os tipos de objetos que o banco de dados pode armazenar, com uma lista de todos os seus possíveis atributos. A sintaxe usada para se referir a um objeto em particular no banco de dados é baseada em sua estrutura, o que explica sua complexidade.
		</para>
		 <section>
			<title>Instalando</title>
			 <para>
				O pacote <emphasis role="pkg">slapd</emphasis> contém o servidor OpenLDAP. O pacote <emphasis role="pkg">ldap-utils</emphasis> inclui ferramentas de linha de comando para interação com os servidores LDAP.
			</para>
			 <indexterm>
				<primary><emphasis>slapd</emphasis></primary>
			</indexterm>
			 <para>
				A instalação do <emphasis role="pkg">slapd</emphasis> geralmente faz muito poucas perguntas e o banco de dados resultante provavelmente não atenderá suas necessidades. Felizmente, um simples <command>dpkg-reconfigure slapd</command> irá deixar você reconfigurar o banco de dados LDAP com mais detalhes:
			</para>
			 <itemizedlist>
				<listitem>
					<para>
						Omitir a configuração do servidor OpenLDAP? Não, claro que não, nós queremos configurar esse serviço.
					</para>

				</listitem>
				 <listitem>
					<para>
						DNS nome de domínio: “<literal>falcot.com</literal>”.
					</para>

				</listitem>
				 <listitem>
					<para>
						Nome da organização: “Falcot Corp”.
					</para>

				</listitem>
				 <listitem>
					<para>
						Senhas administrativas precisam ser digitadas.
					</para>

				</listitem>
				 <listitem>
					<para>
						Banco de dados para utilizar: "MDB".
					</para>

				</listitem>
				 <listitem>
					<para>
						Você quer que o banco de dados seja removido quando o <emphasis role="pkg">slapd</emphasis> é removido (purged)? Não. Não faz sentido arriscar a perda do banco de dados em caso de um engano.
					</para>

				</listitem>
				 <listitem>
					<para>
						Mover banco de dados antigo? Essa pergunta só é feita enquanto a configuração é feita e já existe um banco de dados. Só responda “sim” se você realmente querer iniciar a partir de um banco de dados limpo, por exemplo, se você rodar <command>dpkg-reconfigure slapd</command> logo após a instalação inicial.
					</para>

				</listitem>
				 <listitem>
					<para>
						Permitir protocolo LDAPv2? Não, isso não faz sentido. Todas as ferramentas que nós vamos usar entendem o protocolo LDAPv3.
					</para>

				</listitem>

			</itemizedlist>
			 <sidebar> <title><emphasis>DE VOLTA AO BÁSICO</emphasis> Formato LDIF</title>
			 <para>
				Um arquivo LDIF (<emphasis>formato de intercâmbios de dados LDAP</emphasis> - LDAP Data Interchange Format) é um arquivo de texto portável que descreve o conteúdo de uma base de dados LDAP (ou uma parte da mesma); pode ser utilizada para injetar dados em outro servidor LDAP.
			</para>
			 <indexterm>
				<primary>LDIF</primary>
			</indexterm>
			 </sidebar> <para>
				Um base de dados miníma está configurada agora, como demonstrado pela seguinte consulta:
			</para>
			 
<screen>
<computeroutput>$ </computeroutput><userinput>ldapsearch -x -b dc=falcot,dc=com</userinput>
<computeroutput># extended LDIF
#
# LDAPv3
# base &lt;dc=falcot,dc=com&gt; with scope sub
# filter: (objectclass=*)
# requesting: ALL
#

# falcot.com
dn: dc=falcot,dc=com
objectClass: top
objectClass: dcObject
objectClass: organization
o: Falcot Corp
dc: falcot

# admin, falcot.com
dn: cn=admin,dc=falcot,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator

# search result
search: 2
result: 0 Success

# numResponses: 3
# numEntries: 2
</computeroutput></screen>
			 <para>
				A consulta retornour dois objetos: a organização em si, e o usuário administrativo.
			</para>

		</section>
		 <section>
			<title>Preenchendo o Diretório</title>
			 <para>
				Como um banco de dados vazio não é particularmente útil, nós vamos injetar nele todos os diretórios existentes; isso inclui os banco de dados de usuários, grupos, serviços e máquinas.
			</para>
			 <para>
				O pacote <emphasis role="pkg">migrationtools</emphasis> provê um conjunto de scripts dedicados a extrair dados a partir dos diretórios padrões do Unix (<filename>/etc/passwd</filename>, <filename>/etc/group</filename>, <filename>/etc/services</filename>, <filename>/etc/hosts</filename> e mais), converter seus dados, e injetá-los em um banco de dados LDAP.
			</para>
			 <indexterm>
				<primary><emphasis role="pkg">migrationtools</emphasis></primary>
			</indexterm>
			 <para>
				Uma vez que o pacote esteja instalado, o <filename>/etc/migrationtools/migrate_common.ph</filename> tem que ser editado; as opções <varname>IGNORE_UID_BELOW</varname> e <varname>IGNORE_GID_BELOW</varname> precisam ser habilitadas (descomentá-las é suficiente), e <varname>DEFAULT_MAIL_DOMAIN</varname>/<varname>DEFAULT_BASE</varname> precisa ser atualizada.
			</para>
			 <para>
				A real operação de migração é feita pelo comando <command>migrate_all_online.sh</command>, como a seguir:
			</para>
			 
<screen>
<computeroutput># </computeroutput><userinput>cd /usr/share/migrationtools</userinput>
<computeroutput># </computeroutput><userinput>LDAPADD="/usr/bin/ldapadd -c" ETC_ALIASES=/dev/null ./migrate_all_online.sh</userinput></screen>
			 <para>
				<command>migrate_all_online.sh</command> faz algumas perguntas sobre o banco de dados LDAP para o qual os dados serão migrados. <xref linkend="tab-migrate-all" xrefstyle="select: label nopage" /> resume as respostas dadas no caso da Falcot.
			</para>
			 <table colsep="1" id="tab-migrate-all">
				<title>Responda as perguntas feitas pelo script <command>migrate_all_online.sh</command></title>
				 <tgroup cols="2">
					<colspec align="justify"></colspec>
					<colspec align="justify"></colspec>
					 <thead>
						<row>
							<entry>Questão</entry>
							<entry>Resposta</entry>
						</row>

					</thead>
					 <tbody>
						<row>
							<entry>Contexto de nome X.500</entry>
							 <entry><literal>dc=falcot,dc=com</literal></entry>

						</row>
						 <row>
							<entry>Nome do servidor LDAP</entry>
							 <entry><literal>localhost</literal></entry>

						</row>
						 <row>
							<entry>Gerenciando o DN</entry>
							 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

						</row>
						 <row>
							<entry>Credenciais Bind</entry>
							 <entry>a senha administrativa</entry>

						</row>
						 <row>
							<entry>Criar DUAConfigProfile</entry>
							 <entry>não</entry>

						</row>

					</tbody>

				</tgroup>

			</table>
			 <para>
				Nós ignoramos a migração do arquivo <filename>/etc/aliases</filename> deliberadamente, já que o schema padrão, como o fornecido pelo Debian não inclui as estruturas que esse script usa para descrever "email aliases". Se quisermos integrar esse dado no diretório, o arquivo <filename>/etc/ldap/schema/misc.schema</filename> deve ser adicionado ao schema padrão.
			</para>
			 <sidebar> <title><emphasis>FERRAMENTA</emphasis> Navegando em diretório LDAP</title>
			 <para>
				O comando <command>jxplorer</command> (do pacote de mesmo nome) é uma ferramenta gráfica que permite navegar e editar um banco de dados LDAP. Ele é uma ferramenta interessante que provê ao administrador uma boa visualização da estrutura hierárquica dos dados LDAP.
			</para>
			 <indexterm>
				<primary><command>jxplorer</command></primary>
			</indexterm>
			 </sidebar> <para>
				Note também o uso da opção <literal>-c</literal> do comando <command>ldapadd</command>; essa opção faz com que o processamento não pare em caso de erro. O uso dessa opção é necessário porque a conversão do <filename>/etc/services</filename> geralmente gera alguns erros que podem ser ignorados com segurança.
			</para>

		</section>
		 <section>
			<title>Gerenciando Contas com LDAP</title>
			 <para>
				Agora o banco de dados LDAP contém algumas informações úteis, chegou a hora de fazer uso desses dados. Essa sessão foca em como configurar um sistema Linux para que os vários sistemas de diretórios usem o banco de dados LDAP.
			</para>
			 <section id="sect.config-nss">
				<title>Configurando o NSS</title>
				 <para>
					O sistema NSS (Name Service Switch, see sidebar <xref linkend="sidebar.intro-nss" />) é um sistema modular desenvolvido para definir ou obter informações para o sistema de diretórios. Para usar o LDAP como fonte de dados para o NSS requer a instalação do pacote <emphasis role="pkg">libnss-ldap</emphasis>. Sua instalação faz algumas perguntas; as respostas estão resumidas em <xref linkend="tab-libnss-ldap" xrefstyle="select: label nopage" />.
				</para>
				 <indexterm>
					<primary><emphasis>libnss-ldap</emphasis></primary>
				</indexterm>
				 <table colsep="1" id="tab-libnss-ldap">
					<title>Configurando o pacote <emphasis role="pkg">libnss-ldap</emphasis></title>
					 <tgroup cols="2">
						<colspec align="justify"></colspec>
						 <colspec align="justify"></colspec>
						 <thead>
							<row>
								<entry>Questão</entry>
								 <entry>Resposta</entry>

							</row>

						</thead>
						 <tbody>
							<row>
								<entry>Servidor LDAP Uniform Resource Identifier</entry>
								 <entry><literal>ldap://ldap.falcot.com</literal></entry>

							</row>
							 <row>
								<entry>Nome distinto da base de pesquisa</entry>
								 <entry><literal>dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>Versão LDAP para usar</entry>
								 <entry><literal>3</literal></entry>

							</row>
							 <row>
								<entry>O banco de dados LDAP precisa de um login?</entry>
								 <entry>não</entry>

							</row>
							 <row>
								<entry>Privilégios especiais LDAP para o root</entry>
								 <entry>sim</entry>

							</row>
							 <row>
								<entry>Fazer o arquivo de configuração com permissão de leitura/escrita apenas para seu proprietário</entry>
								 <entry>não</entry>

							</row>
							 <row>
								<entry>Conta LDAP para root</entry>
								 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>A senha da conta de root do LDAP</entry>
								 <entry>a senha administrativa</entry>

							</row>

						</tbody>

					</tgroup>

				</table>
				 <para>
					O arquivo <filename>/etc/nsswitch.conf</filename> precisa então ser modificado, para configurar o NSS para usar o recém-instalado módulo <command>ldap</command>.
				</para>
				 <example>
					<title>O arquivo <filename>/etc/nsswitch.conf</filename></title>
					 
<programlisting>
# /etc/nsswitch.conf
#
# Example configuration of GNU Name Service Switch functionality.
# If you have the `glibc-doc' and `info' packages installed, try:
# `info libc "Name Service Switch"' for information about this file.

passwd: ldap compat
group: ldap compat
shadow: ldap compat

hosts: files dns ldap
networks: ldap files

protocols: ldap db files
services: ldap db files
ethers: ldap db files
rpc: ldap db files

netgroup: ldap files</programlisting>

				</example>
				 <para>
					O módulo <command>ldap</command> usualmente é inserido antes dos outros, e ele irá então ser consultado primeiro. A notável exceção é o serviço <literal>hosts</literal> já que contactar o servidor LDAP requer consultar o DNS primeiro (para resolver <literal>ldap.falcot.com</literal>). Sem essa exceção, uma consulta de hostname iria recair ao servidor LDAP; isso iria disparar uma resolução de nome ao servidor LDAP, e cairia em um loop infinito.
				</para>
				 <para>
					Se o servidor LDAP deve ser considerado autoritário (e os arquivos locais usados pelo módulo <command>files</command> desconsiderados), serviços podem ser configurados com a seguinte sintaxe:
				</para>
				 <para>
					<literal><replaceable>serviço</replaceable>: ldap [NOTFOUND=return] files</literal>.
				</para>
				 <para>
					Se a entrada requisitada não existir no banco de dados LDAP, a consulta irá retornar uma resposta “não existe” mesmo que o recurso exista em um dos arquivos locais; esses arquivos locais irão apenas ser usados quando o serviço LDAP estiver parado.
				</para>

			</section>
			 <section id="sect.config-pam">
				<title>Configurando o PAM</title>
				 <para>
					Essa seção descreve a configuração do PAM (see sidebar <xref linkend="sidebar.intro-pam" />) que irá permitir as aplicações realizarem as autenticações necessárias no banco de dados LDAP.
				</para>
				 <sidebar> <title><emphasis>ATENÇÃO</emphasis> Autenticação quebrada</title>
				 <para>
					Alterar a configuração padrão do PAM usada por vários programas é uma operação delicada. Um erro pode levar a erros de autenticação, o que pode impedir um início de sessão. Manter um shell root aberto é então uma boa precaução. Se acontecerem erros de configuração, eles podem então ser consertados e os serviços reiniciados com um mínimo de esforço.
				</para>
				 </sidebar> <para>
					O módulo LDAP para PAM é provido pelo pacote <emphasis role="pkg">libpam-ldap</emphasis>. A instalação deste pacote realiza umas poucas perguntas muito parecidas "aquelas no pacote <emphasis role="pkg">libnss-ldap</emphasis>; alguns parâmetros de configuração (como o URI do servidor LDAP) são inclusive compartilhados com o pacote <emphasis role="pkg">libnss-ldap</emphasis>. As respostas são resumidas em<xref linkend="tab-libpam-ldap" xrefstyle="select: label nopage" />.
				</para>
				 <indexterm>
					<primary><emphasis>libpam-ldap</emphasis></primary>
				</indexterm>
				 <table colsep="1" id="tab-libpam-ldap">
					<title>Configuração do <emphasis>libpam-ldap</emphasis></title>
					 <tgroup cols="2">
						<colspec align="justify"></colspec>
						 <colspec align="justify"></colspec>
						 <thead>
							<row>
								<entry>Questão</entry>
								 <entry>Resposta</entry>

							</row>

						</thead>
						 <tbody>
							<row>
								<entry>Permitir a conta administrativa do LDAP se comportar como o root local?</entry>
								 <entry>Sim. Isto permite usar o comando usual <command>passwd</command> para modificar as senhas armazenadas no banco de dados LDAP.</entry>

							</row>
							 <row>
								<entry>O banco de dados LDAP necessita estar logado?</entry>
								 <entry>não</entry>

							</row>
							 <row>
								<entry>Conta LDAP para root</entry>
								 <entry><literal>cn=admin,dc=falcot,dc=com</literal></entry>

							</row>
							 <row>
								<entry>A senha da conta de root do LDAP</entry>
								 <entry>A senha do banco de dados administrativo LDAP</entry>

							</row>
							 <row>
								<entry>Algorítimo de criptografia local para ser usado em senhas</entry>
								 <entry>crypt</entry>

							</row>

						</tbody>

					</tgroup>

				</table>
				 <para>
					A instalação do <emphasis role="pkg">libpam-ldap</emphasis> automaticamente adapta a configuração padrão do PAM definida nos arquivos <filename>/etc/pam.d/common-auth</filename>, <filename>/etc/pam.d/common-password</filename> e <filename>/etc/pam.d/common-account</filename>. Esse mecanismo usa a ferramenta dedicada <command>pam-auth-update</command> (fornecida pelo pacote <emphasis role="pkg">libpam-runtime</emphasis>). Essa ferramenta pode também ser rodada pelo administrador caso ele queira habilitar ou desabilitar módulos PAM.
				</para>
				 <indexterm>
					<primary><filename>common-auth</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-auth</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>common-password</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-password</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>common-account</filename></primary>
				</indexterm>
				 <indexterm>
					<primary><filename>/etc/pam.d/common-account</filename></primary>
				</indexterm>

			</section>
			 <section>
				<title>Protegendo a Troca de Dados do LDAP</title>
				 <indexterm>
					<primary>LDAP</primary>
					<secondary>segurança</secondary>
				</indexterm>
				 <para>
					Por padrão, o protocolo LDAP transita pela rede em texto puro; isso inclui as senhas (criptografadas). Como as senhas criptografadas podem ser extraídas da rede, elas pode ficar vulneráveis a ataques do tipo dicionário. Isso pode ser evitado usando um camada de criptografia extra; habilitar essa camada é o tópico desta seção.
				</para>
				 <section>
					<title>Configurando o Servidor</title>
					 <indexterm>
						<primary><foreignphrase>OpenSSL</foreignphrase></primary>
						<secondary>criando chaves</secondary>
					</indexterm>
					 <indexterm>
						<primary>par de chaves</primary>
					</indexterm>
					 <para>
						O primeiro passo é criar um par de chaves (contendo uma chave pública e uma chave privada) para o servidor LDAP. Os administradores da Falcot usaram novamente <emphasis>easy-rsa</emphasis> para gerá-las (veja <xref linkend="sect.easy-rsa" />). Ao executar <command>./build-key-server ldap.falcot.com</command> são feitas algumas perguntas mundanas (localização, nome da organização e assim por diante). A resposta para a pergunta “nome comun” <emphasis>tem</emphasis> que ser um nome de máquina completo (fully-qualified) para o servidor LDAP; em nosso caso, <literal>ldap.falcot.com</literal>.
					</para>
					 <para>
						Esse comando cria um certificado no arquivo <filename>keys/ldap.falcot.com.crt</filename>; a chave privada correspondente é armazenada em <filename>keys/ldap.falcot.com.key</filename>.
					</para>
					 <para>
						Agora essas chaves tem que ser instaladas em seu local padrão, e nós temos que garantir que o arquivo privado pode ser lido pelo servidor LDAP, o qual roda sob a identidade do usuário <literal>openldap</literal>:
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>adduser openldap ssl-cert
</userinput><computeroutput>Adding user `openldap' to group `ssl-cert' ...
Adding user openldap to group ssl-cert
Done.
# </computeroutput><userinput>mv keys/ldap.falcot.com.key /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chown root:ssl-cert /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>chmod 0640 /etc/ssl/private/ldap.falcot.com.key
</userinput><computeroutput># </computeroutput><userinput>mv newcert.pem /etc/ssl/certs/ldap.falcot.com.pem
</userinput></screen>
					 <para>
						O daemon <command>slapd</command> também precisa ser informado para usar essas chaves para criptografia. A configuração do servidor LDAP é gerenciada dinamicamente: a configuração pode ser atualizada através de operações normais do LDAP no objeto hierárquico <literal>cn=config</literal>, e o servidor atualiza o <filename>/etc/ldap/slapd.d</filename> em tempo real para fazer com que a configuração seja persistente. <command>ldapmodify</command> é, assim, a ferramenta certa para atualizar a configuração:
					</para>
					 <example>
						<title>Configurando <command>slapd</command> para criptografia</title>
						 
<screen><computeroutput># </computeroutput><userinput>cat &gt;ssl.ldif &lt;&lt;END
dn: cn=config
changetype: modify
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ssl/certs/ldap.falcot.com.pem
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ssl/private/ldap.falcot.com.key
-
END
</userinput><computeroutput># </computeroutput><userinput>ldapmodify -Y EXTERNAL -H ldapi:/// -f ssl.ldif
</userinput><computeroutput>SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
modifying entry "cn=config"
</computeroutput></screen>

					</example>
					 <sidebar> <title><emphasis>FERRAMENTA</emphasis> <command>ldapvi</command> para editar um diretório LDAP</title>
					 <indexterm>
						<primary><command>ldapvi</command></primary>
					</indexterm>
					 <para>
						Com o <command>ldapvi</command>, você pode exibir uma saída LDIF de qualquer parte do diretório LDAP, fazer algumas mudanças no editor de texto, e deixar a ferramenta fazer as correspondentes operações LDAP para você.
					</para>
					 <para>
						Esta é, portanto, uma maneira coveniente de atualizar a configuração do servidor LDAP, simplesmente editando a hierarquia <literal>cn=config</literal>.
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>ldapvi -Y EXTERNAL -h ldapi:/// -b cn=config
</userinput></screen>
					 </sidebar> <para>
						O último passo para habilitar a criptografia envolve alterar a variável <varname>SLAPD_SERVICES</varname> no arquivo <filename>/etc/default/slapd</filename>. Nós vamos torná-lo seguro e desabilitar o LDAP inseguro de uma vez só.
					</para>
					 <example>
						<title>O nome <filename>/etc/default/slapd</filename></title>
						 
<programlisting>
# Default location of the slapd.conf file or slapd.d cn=config directory. If
# empty, use the compiled-in default (/etc/ldap/slapd.d with a fallback to
# /etc/ldap/slapd.conf).
SLAPD_CONF=

# System account to run the slapd server under. If empty the server
# will run as root.
SLAPD_USER="openldap"

# System group to run the slapd server under. If empty the server will
# run in the primary group of its user.
SLAPD_GROUP="openldap"

# Path to the pid file of the slapd server. If not set the init.d script
# will try to figure it out from $SLAPD_CONF (/etc/ldap/slapd.conf by
# default)
SLAPD_PIDFILE=

# slapd normally serves ldap only on all TCP-ports 389. slapd can also
# service requests on TCP-port 636 (ldaps) and requests via unix
# sockets.
# Example usage:
# SLAPD_SERVICES="ldap://127.0.0.1:389/ ldaps:/// ldapi:///"
SLAPD_SERVICES="ldaps:/// ldapi:///"

# If SLAPD_NO_START is set, the init script will not start or restart
# slapd (but stop will still work).  Uncomment this if you are
# starting slapd via some other means or if you don't want slapd normally
# started at boot.
#SLAPD_NO_START=1

# If SLAPD_SENTINEL_FILE is set to path to a file and that file exists,
# the init script will not start or restart slapd (but stop will still
# work).  Use this for temporarily disabling startup of slapd (when doing
# maintenance, for example, or through a configuration management system)
# when you don't want to edit a configuration file.
SLAPD_SENTINEL_FILE=/etc/ldap/noslapd

# For Kerberos authentication (via SASL), slapd by default uses the system
# keytab file (/etc/krb5.keytab).  To use a different keytab file,
# uncomment this line and change the path.
#export KRB5_KTNAME=/etc/krb5.keytab

# Additional options to pass to slapd
SLAPD_OPTIONS=""</programlisting>

					</example>

				</section>
				 <section>
					<title>Configurando o Cliente</title>
					 <para>
						No lado do cliente, a configuração para os módulos <emphasis>libpam-ldap</emphasis> e <emphasis>libnss-ldap</emphasis> precisa ser modificada para usar a URI <literal>ldaps://</literal>.
					</para>
					 <para>
						Clientes LDAP também precisam ser capazes de autenticar o servidor. Em uma infraestrutura de chave pública X.509, certificados públicos são assinados pela chave da autoridade certificadora (CA, do inglês certificate authority). Com <emphasis>easy-rsa</emphasis>, os administradores da Falcot criaram seu próprio CA e agora eles precisam configurar o sistema para confiar nas assinaturas do CA da Falcot. Isso pode ser feito colocando o certificado CA em <filename>/usr/local/share/ca-certificates</filename> e executando <command>update-ca-certificates</command>.
					</para>
					 
<screen><computeroutput># </computeroutput><userinput>cp keys/ca.crt /usr/local/share/ca-certificates/falcot.crt
</userinput><computeroutput># </computeroutput><userinput>update-ca-certificates
</userinput><computeroutput>Updating certificates in /etc/ssl/certs... 1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d....
Adding debian:falcot.pem
done.
done.
</computeroutput></screen>
					 <para>
						Por último, mas não menos importante, a URI padrão do LDAP e o DN base padrão usado por várias ferramentas de linha de comando podem ser modificados em <filename>/etc/ldap/ldap.conf</filename>. Isso irá evitar, consideravelmente, digitação.
					</para>
					 <example>
						<title>O arquivo <filename>/etc/ldap/ldap.conf</filename></title>
						 
<programlisting>#
# LDAP Defaults
#

# See ldap.conf(5) for details
# This file should be world readable but not world writable.

BASE   dc=falcot,dc=com
URI    ldaps://ldap.falcot.com

#SIZELIMIT      12
#TIMELIMIT      15
#DEREF          never

# TLS certificates (needed for GnuTLS)
TLS_CACERT      /etc/ssl/certs/ca-certificates.crt</programlisting>

					</example>

				</section>

			</section>

		</section>

	</section>
	 <section id="sect.rtc-services">
		<title>Serviços de Comunicação em Tempo Real</title>
		 <para>
			Serviços de Comunicação em Tempo Real (RTC) incluem voz, vídeo/webcam, mensagem instantânea (IM) e compartilhamento de área de trabalho. esse capítulo dá uma breve introdução a três dos serviços necessários para operar um RTC, incluindo os servidores TURN, SIP e XMPP. Compreensíveis detalhes em como planejar, instalar e gerenciar esses serviços estão disponíveis no Guia de Início Rápido para Comunicações em Tempo Real, que inclui exemplos específicos para o Debian. <ulink type="block" url="http://rtcquickstart.org" />
		</para>
		 <indexterm>
			<primary>VoIP</primary>
			<secondary>servidor</secondary>
		</indexterm>
		 <indexterm>
			<primary>RTC</primary>
			<secondary>servidor</secondary>
		</indexterm>
		 <indexterm>
			<primary>Mensagem Instantânea</primary>
			<secondary>servidor</secondary>
		</indexterm>
		 <indexterm>
			<primary>Chat</primary>
			<secondary>servidor</secondary>
		</indexterm>
		 <para>
			Tanto o SIP quanto o XMPP podem fornecer a mesma funcionalidade. O SIP é sutilmente mais bem conhecido para voz e vídeoo, enquanto que o XMPP é tradicionalmente considerado como um protocolo IM. Na verdade, os dois podem ser usados para qualquer um desses propósitos. Para maximizar as opções de conectividade, é recomendado rodar os dois em paralelo.
		</para>
		 <indexterm>
			<primary>SIP</primary>
		</indexterm>
		 <indexterm>
			<primary>XMPP</primary>
		</indexterm>
		 <para>
			Esses serviços fazem uso dos certificados X.509, tanto para propósitos de autenticação quanto para confidencialidade. Veja <xref linkend="sect.easy-rsa" /> para detalhes em como criá-los. Alternativamente o <emphasis>Guia de Início Rápido para Comunicações em Tempo Real</emphasis> também tem algumas explicaçẽos úteis: <ulink type="block" url="http://rtcquickstart.org/guide/multi/tls.html" />
		</para>
		 <section id="sect.rtc-dns-settings">
			<title>Configurações de DNS para serviços RTC</title>
			 <para>
				Serviços RTC requerem registros DNS SRV e NAPTR. Uma configuração exemplo que pode ser colocada no arquivo zona para <literal>falcot.com</literal>:
			</para>
			 <indexterm>
				<primary>DNS</primary>
				<secondary>registro ("record") SRV</secondary>
			</indexterm>
			 <indexterm>
				<primary>DNS</primary>
				<secondary>registro ("record") NAPTR</secondary>
			</indexterm>
			 
<programlisting>
; the server where everything will run
server1            IN     A      198.51.100.19
server1            IN     AAAA   2001:DB8:1000:2000::19

; IPv4 only for TURN for now, some clients are buggy with IPv6
turn-server        IN     A      198.51.100.19

; IPv4 and IPv6 addresses for SIP
sip-proxy          IN     A      198.51.100.19
sip-proxy          IN     AAAA   2001:DB8:1000:2000::19

; IPv4 and IPv6 addresses for XMPP
xmpp-gw            IN     A      198.51.100.19
xmpp-gw            IN     AAAA   2001:DB8:1000:2000::19

; DNS SRV and NAPTR for STUN / TURN
_stun._udp  IN SRV    0 1 3467 turn-server.falcot.com.
_turn._udp  IN SRV    0 1 3467 turn-server.falcot.com.
@           IN NAPTR  10 0 "s" "RELAY:turn.udp" "" _turn._udp.falcot.com.

; DNS SRV and NAPTR records for SIP
_sips._tcp  IN SRV    0 1 5061 sip-proxy.falcot.com.
@           IN NAPTR  10 0 "s" "SIPS+D2T" "" _sips._tcp.falcot.com.

; DNS SRV records for XMPP Server and Client modes:
_xmpp-client._tcp  IN     SRV    5 0 5222 xmpp-gw.falcot.com.
_xmpp-server._tcp  IN     SRV    5 0 5269 xmpp-gw.falcot.com.</programlisting>

		</section>
		 <section id="sect.turn-server">
			<title>Servidor TURN</title>
			 <para>
				TURN é um serviço que ajuda clientes atrás de roteadores NAT e firewalls a descobrir a maneira mais eficiente de comunicar com outros clientes e para retransmitir o fluxo de mídia caso nenhum caminho de mídia direto possa ser encontrado. É altamente recomendado que o servidor TURN seja instalado antes de outros serviços RTC serem oferecidos para os usuários finais.
			</para>
			 <indexterm>
				<primary>TURN</primary>
				<secondary>servidor</secondary>
			</indexterm>
			 <para>
				TURN e o protocolo ICE relacionado são padrões abertos. Para se beneficiar desses protocolos, maximizar a conectividade e minimizar a frustação do usuário, é importante garantir que todos os softwares clientes tenham suporte a ICE e TURN.
			</para>
			 <indexterm>
				<primary>ICE</primary>
			</indexterm>
			 <para>
				Para que o algorítimo ICE funcione efetivamente, o servidor tem que ter dois endereços IPv4 públicos.
			</para>
			 <section id="sect.turn-server-install">
				<title>Instalar o servidor TURN</title>
				 <para>
					Instale o pacote <emphasis role="pkg">resiprocate-turn-server</emphasis>.
				</para>
				 <para>
					Edite o arquivo de configuração <filename>/etc/reTurn/reTurnServer.config</filename>. A coisa mais importante a fazer é inserir os endereços IP do servidor.
				</para>
				 
<programlisting>
# your IP addresses go here:
TurnAddress = 198.51.100.19
TurnV6Address = 2001:DB8:1000:2000::19
AltStunAddress = 198.51.100.20
# your domain goes here, it must match the value used
# to hash your passwords if they are already hashed
# using the HA1 algorithm:
AuthenticationRealm = myrealm

UserDatabaseFile = /etc/reTurn/users.txt
UserDatabaseHashedPasswords = true</programlisting>
				 <para>
					Reinicie o serviço.
				</para>

			</section>
			 <section id="sect.turn-server-management">
				<title>Gerenciando os usuário do TURN</title>
				 <para>
					Use o utilitário htdigest para gerenciar a lista de usuários do servidor TURN.
				</para>
				
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/reTurn/users.txt myrealm joe</userinput></screen>
				 <para>
					Use o sinal HUP para fazer com queo servidor recarrege o arquivo <filename>/etc/reTurn/users.txt</filename> após alterá-lo ou habilite o recurso de recarregamento automático em <filename>/etc/reTurn/reTurnServer.config</filename>.
				</para>

			</section>

		</section>
		 <section id="sect.sip-server">
			<title>Servidor Proxy SIP</title>
			 <para>
				Um servidor proxy SIP gerencia entrada e saída de conexões SIP entre outras organizações, provedores de trunking SIP, SIP PBXes tais como Asterisk, telefones SIP, softphones baseados em SIP e aplicações WebRTC.
			</para>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>servidor</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>proxy</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>PBX</secondary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>trunk</secondary>
			</indexterm>
			 <para>
				É altamente recomendado instalar e configurar o proxy SIP antes de tentar uma configuração do PBX SIP. O proxy SIP normaliza muito do tráfego que atinge o PBX e fornece uma melhor conectividade e resiliência.
			</para>
			 <section id="sect.sip-server-install">
				<title>Instalar o proxy SIP</title>
				 <para>
					Instale o pacote <emphasis role="pkg">repro</emphasis>. O uso do pacote que está na <emphasis role="distribution">jessie-backports</emphasis> é altamente recomendado, já que ele tem os últimos melhoramentos para maximizar a conectividade e resiliência.
				</para>
				 <indexterm>
					<primary>repro</primary>
				</indexterm>
				 <para>
					Edite o arquivo de configuração <filename>/etc/repro/repro.config</filename> configuration file. A coisa mais importante a fazer é inserir o endereço IP do servidor. O exemplo abaixo demonstra como configurar um SIP regular e um WebSockets/WebRTC, usando TLS, IPv4 e IPv6:
				</para>
				 
<programlisting>
# Transport1 will be for SIP over TLS connections
# We use port 5061 here but if you have clients connecting from
# locations with firewalls you could change this to listen on port 443
Transport1Interface = 198.51.100.19:5061
Transport1Type = TLS
Transport1TlsDomain = falcot.com
Transport1TlsClientVerification = Optional
Transport1RecordRouteUri = sip:falcot.com;transport=TLS
Transport1TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport1TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport2 is the IPv6 version of Transport1
Transport2Interface = 2001:DB8:1000:2000::19:5061
Transport2Type = TLS
Transport2TlsDomain = falcot.com
Transport2TlsClientVerification = Optional
Transport2RecordRouteUri = sip:falcot.com;transport=TLS
Transport2TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport2TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport3 will be for SIP over WebSocket (WebRTC) connections
# We use port 8443 here but you could use 443 instead
Transport3Interface = 198.51.100.19:8443
Transport3Type = WSS
Transport3TlsDomain = falcot.com
# This would require the browser to send a certificate, but browsers
# don't currently appear to be able to, so leave it as None:
Transport3TlsClientVerification = None
Transport3RecordRouteUri = sip:falcot.com;transport=WSS
Transport3TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport3TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport4 is the IPv6 version of Transport3
Transport4Interface = 2001:DB8:1000:2000::19:8443
Transport4Type = WSS
Transport4TlsDomain = falcot.com
Transport4TlsClientVerification = None
Transport4RecordRouteUri = sip:falcot.com;transport=WSS
Transport4TlsPrivateKey = /etc/ssl/private/falcot.com-key.pem
Transport4TlsCertificate = /etc/ssl/public/falcot.com.pem

# Transport5: this could be for TCP connections to an Asterisk server
# in your internal network.  Don't allow port 5060 through the external
# firewall.
Transport5Interface = 198.51.100.19:5060
Transport5Type = TCP
Transport5RecordRouteUri = sip:198.51.100.19:5060;transport=TCP

HttpBindAddress = 198.51.100.19, 2001:DB8:1000:2000::19
HttpAdminUserFile = /etc/repro/users.txt

RecordRouteUri = sip:falcot.com;transport=tls
ForceRecordRouting = true
EnumSuffixes = e164.arpa, sip5060.net, e164.org
DisableOutbound = false
EnableFlowTokens = true
EnableCertificateAuthenticator = True</programlisting>
				 <para>
					Use o utilitário <command>htdigest</command> para gerenciar a senha do admin para a interface web. O nome de usuário tem que ser <emphasis>admin</emphasis> e o nome "realm" tem que coincidir com o valor especificado em <filename>repro.config</filename>.
				</para>
				 
<screen><computeroutput># </computeroutput><userinput>htdigest /etc/repro/users.txt repro admin</userinput></screen>
				 <para>
					Reinicie o serviço para usar a nova configuração.
				</para>

			</section>
			 <section id="sect.sip-server-management">
				<title>Gerenciando o proxy SIP</title>
				 <para>
					Vá para a interface web em <literal>http://sip-proxy.falcot.com:5080</literal> para completar a configuraçao fazendo a adição de domínios, usuários locais e rotas estáticas.
				</para>
				 <para>
					O primeiro passo é adicionar um domínio local. O processo tem que ser reiniciado após a adição ou remoção de domínios da lista.
				</para>
				 <para>
					O proxy sabe como rotear chamadas entre usuários locais e endereços SIP completos, a configuração de roteamento só é necessária par sobrescrever o comportamento padrão, por exemplo, para reconhecer números de telefone, adicionar um prefixo e roteá-los para um provedor SIP.
				</para>

			</section>

		</section>
		 <section id="sect.xmpp-server">
			<title>Servidor XMPP</title>
			 <para>
				Um servidor XMPP gerencia a conectividade entre usuários XMPP locais e usuários XMPP em outros domínios na internet pública.
			</para>
			 <indexterm>
				<primary>XMPP</primary>
				<secondary>servidor</secondary>
			</indexterm>
			 <sidebar> <title><emphasis>VOCABULÁRIO</emphasis> XMPP ou Jabber?</title>
			 <indexterm>
				<primary>Jabber</primary>
			</indexterm>
			 <para>
				O XMPP é, algumas vezes, referenciado como Jabber. Na verdade, Jabber é uma marca registrada e XMPP é o nome oficial do padrão.
			</para>
			 <indexterm>
				<primary>Jabber</primary>
			</indexterm>
			 </sidebar> <para>
				Prosody é um popular servidor XMPP que opera de forma confiável em servidores Debian.
			</para>
			 <indexterm>
				<primary>Prosody</primary>
			</indexterm>
			 <section id="sect.xmpp-server-install">
				<title>Instalar o servidor XMPP</title>
				 <para>
					Instale o pacote <emphasis role="pkg">prosody</emphasis>. O uso do pacote existente na <emphasis role="distribution">jessie-backports</emphasis> é altamente recomendado, já que ele tem os últimos melhoramentos para maximizar a conectividade e resiliência.
				</para>
				 <indexterm>
					<primary>Prosody</primary>
				</indexterm>
				 <para>
					Reveja o arquivo de configuração <filename>/etc/prosody/prosody.cfg.lua</filename>. A coisa mais importante a fazer é inserir as JIDs dos usuários que tem permissão para gerenciar o servidor.
				</para>
				 
<programlisting>
admins = { "joe@falcot.com" }</programlisting>
				 <para>
					Um arquivo de configuração individual também é necessário para cada domínio. Copie o exemplo de <filename>/etc/prosody/conf.avail/example.com.cfg.lua</filename> e use-o como ponto de partida. Aqui está o <literal>falcot.com.cfg.lua</literal>:
				</para>
				 
<programlisting>
VirtualHost "falcot.com"
        enabled = true
        ssl = {
                key = "/etc/ssl/private/falcot.com-key.pem";
                certificate = "/etc/ssl/public/falcot.com.pem";
                }</programlisting>
				 <para>
					Para habilitar o domínio, tem que existir um symlink de <filename>/etc/prosody/conf.d/</filename>. Crie-o dessa forma:
				</para>
				 
<screen><computeroutput># </computeroutput><userinput>ln -s /etc/prosody/conf.avail/falcot.com.cfg.lua /etc/prosody/conf.d/</userinput></screen>
				 <para>
					Reinicie o serviço para usar a nova configuração.
				</para>

			</section>
			 <section id="sect.xmpp-server-management">
				<title>Gerenciando o servidor XMPP</title>
				 <para>
					Algumas operações de gerenciamento podem ser realizadas usando o utilitário de linha de comando <literal>prosodyctl</literal>. Por exemplo, para adicionar a conta de administrador especificada em <filename>/etc/prosody/prosody.cfg.lua</filename>:
				</para>
				
<programlisting>
# prosodyctl adduser joe@falcot.com</programlisting>
				 <para>
					Veja a <ulink url="http://prosody.im/doc/configure"> documentação online do Prosody</ulink> para mais detalhes sobre como customizar a configuração.
				</para>

			</section>

		</section>
		 <section id="sect.rtc-port-443">
			<title>Rodando serviços na porta 443</title>
			 <para>
				Alguns administradores preferem rodar todos os serviços RTC na porta 443. Isso ajuda os usuários a se conectar a partir de localizações remotas, tais como hotéis e aeroportos, onde outras portas podem estar bloqueadas ou o tráfego de Internet é roteado através de servidores proxy HTTP.
			</para>
			 <para>
				Para usar essa estratégia, cada serviço (SIP, XMPP e TURN) precisa de um endereço IP diferente. Todos os serviços ainda podem estar na mesma máquina, já que oLinux tem suporte a multiplos endereços IP em uma única máquina. O número de porta, 443, tem que ser especificado nos arquivos de configuração de cada processo e também nos registros DNS SRV.
			</para>

		</section>
		 <section id="sect.rtc-webrtc">
			<title>Adicionando WebRTC</title>
			 <para>
				A Falcot que deixar os clientes fazerem chamadas telefônicas a partir do site web. Os administradores da Falcot também querem usar o WebRTC como parte de seu plano de resgate em um disastre, para que a equipe possa usar navegadores web em casa para iniciar uma sessão no sistema de telefonia da companhia e trabalhar normalmente em uma emergência.
			</para>
			 <indexterm>
				<primary>WebRTC</primary>
			</indexterm>
			 <indexterm>
				<primary>SIP</primary>
				<secondary>WebSockets</secondary>
			</indexterm>
			 <sidebar> <title><emphasis>NA PRÁTICA</emphasis> Experimente o WebRTC</title>
			 <indexterm>
				<primary>WebRTC</primary>
				<secondary>desmonstração</secondary>
			</indexterm>
			 <para>
				Se você nunca experimentou o WebRTC antes, existem vários sites que oferecem uma demonstração online e instalações de teste. <ulink type="block" url="http://www.sip5060.net/test-calls" />
			</para>
			 </sidebar> <para>
				O WebRTC é uma tecnologia de envolvimento rápido e é essencial usar pacotes existentes nas distribuições <emphasis role="distribution">jessie-backports</emphasis> ou <emphasis role="distribution">Teste ("Testing")</emphasis>.
			</para>
			 <para>
				O JSCommunicator é um telefone WebRTC genérico e sem marca que não requer nenhum script rodando no lado do servidor como o PHP. Ele é construído com HTML, CSS e JavaScript. Ele é a base para muitos outros serviços WebRTC e módulos para mais avançados frameworks de plublicação na web. <ulink type="block" url="http://jscommunicator.org" />
			</para>
			 <indexterm>
				<primary>JSCommunicator</primary>
			</indexterm>
			 <para>
				O pacote <emphasis role="pkg">jscommunicator-web-phone</emphasis> é a maneira mais rápida de instalar um telefone WebRTC em um site web. Ele requer um proxy SIP com transporte de WebSocket. As instruções em <xref linkend="sect.sip-server-install" /> incluem os detalhes necessários para habilitar o transporte de WebSocket no proxy SIP <emphasis role="pkg">repro</emphasis>.
			</para>
			 <para>
				Após a instalação do <emphasis role="pkg">jscommunicator-web-phone</emphasis>, existem várias maneira de usá-lo. Uma estratégia simples é incluir ou copiar a configuração de <filename>/etc/jscommunicator-web-phone/apache.conf</filename> para uma configuração de host virtual do Apache.
			</para>
			 <para>
				Uma vez que os arquivos web-phone estejam disponíveis no servidor web, customize o <filename>/etc/jscommunicator-web-phone/config.js</filename> para apontar para o servidor TURN server e proxy SIP. Por exemplo:
			</para>
			 
<programlisting>
JSCommSettings = {

  // Web server environment
  webserver: {
    url_prefix: null            // If set, prefix used to construct sound/ URLs
  },

  // STUN/TURN media relays
  stun_servers: [],
  turn_servers: [
    { server:"turn:turn-server.falcot.com?transport=udp", username:"joe", password:"j0Ep455d" }
  ],

  // WebSocket connection
  websocket: {
      // Notice we use the falcot.com domain certificate and port 8443
      // This matches the Transport3 and Transport4 example in
      // the falcot.com repro.config file
    servers: 'wss://falcot.com:8443',
    connection_recovery_min_interval: 2,
    connection_recovery_max_interval: 30
  },

  ...</programlisting>
			 <para>
				Sites web clique-para-chamar mais avançados tipicamente usam scritps do lado do servidor para gerar o arquivo <literal>config.js</literal> dinamicamente. O código fonte <ulink url="http://drucall.org">DruCall</ulink> demonstra como fazer isso com PHP.
			</para>
			 <indexterm>
				<primary>DruCall</primary>
			</indexterm>
			 <para>
				Esse capítulo mostrou apenas uma fração dos softwares de servidor disponíveis; contudo, a maioria dos serviços de rede comuns foram descritos. Agora é hora de um capítulo ainda mais técnico: nós iremos entrar mais detalhadamente ainda em alguns conceitos, descrevendo implementações massivas e virtualização.
			</para>

		</section>

	</section>
</chapter>

