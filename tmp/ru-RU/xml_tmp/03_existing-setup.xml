<?xml version='1.0' encoding='utf-8' ?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
]>
<chapter id="existing-setup">
  <chapterinfo>
    <mediaobject condition="pdf">
      <imageobject>
        <imagedata fileref="images/chap-existing-setup.png" scalefit="1" />
      </imageobject>
    </mediaobject>
    <keywordset>
      <keyword>Существующая установка</keyword>
      <keyword>Повторное использование</keyword>
      <keyword>Миграция</keyword>
    </keywordset>
  </chapterinfo>
  <title>Анализ существующей установки и миграция</title>
  <highlights>
    <para>При модернизации любой компьютерной системы необходимо учитывать уже существующую систему. Подобный подход позволит максимально использовать имеющиеся ресурсы и гарантирует взаимодействие различных элементов, составляющих систему. Это пособие представляет общий подход к миграции компьютерной инфраструктуры на Linux.</para>
  </highlights>
  <section id="sect.heterogeneous-environments">
    <title>Сосуществование в гетерогенных средах</title>
    <indexterm><primary>среда</primary><secondary>гетерогенная среда</secondary></indexterm>

    <para>Debian легко интегрируется во все существующие типы окружений и хорошо работает совместно с любыми другими типами операционных систем. Столь гармоничное поведение обусловлено требованиями рынка, который стимулирует соблюдение стандартов разработчиками программного обеспечения. Следование стандартам позволяет администраторам заменять программы, будь то серверная или клиентская часть, свободное программное обеспечение или нет.</para>
    <section>
      <title>Интеграция с системами Windows</title>

      <para>Поддержка SMB/CIFS в Samba обеспечивает превосходное взаимодействие с окружением Windows и позволяет обмениваться файлами, направлять очередь печати на Windows-клиенты, и включает в себя программное обеспечение, необходимое Linux-машинам для использования ресурсов Windows-серверов.</para>

      <sidebar>
        <title><emphasis>ИНСТРУМЕНТ</emphasis> Samba</title>
        <indexterm><primary>Samba</primary></indexterm>

        <para>Последняя версия Samba может заменить собой большинство возможностей Windows: от таких, которые представляют собой простейший сервер Windows NT (аутентификация, файлы, очереди печати, загрузка драйверов принтеров, DFS и т. д.), до наиболее сложных (управлением доменом, совместимое с  Active Directory).</para>
      </sidebar>
    </section>
    <section>
      <title>Интеграция с системами  OS X</title>

      <indexterm><primary>Zeroconf</primary></indexterm>
      <indexterm><primary>Bonjour</primary></indexterm>
      <indexterm><primary>Avahi</primary></indexterm>
      <para>Системы OS X предоставляют, и могут использовать, такие сетевые службы как, файловые серверы и совместно используемые принтеры. Данные службы объявляются доступными в локальной сети, а другие машины могут обнаружить и использовать их без необходимости какой-либо ручной настройки посредством протокола Zeroconf, реализация которого называется Bonjour. Debian содержит другую реализацию этого протокола, Avahi, которая обеспечивает аналогичную функциональность.</para>

      <indexterm><primary>AFP</primary></indexterm>
      <indexterm><primary>AppleShare</primary></indexterm>
      <para>В обратном направлении можно использовать демон Netatalk, чтобы предоставить файловые серверы для систем с OS X в сети. Он реализует протокол AFP (AppleShare), а также необходимые уведомления, так что серверы могут быть автоматически обнаружены клиентами OS X.</para>

      <indexterm><primary>AppleTalk</primary></indexterm>
      <para>В сетях на основе предыдущих реализаций Mac OS (до OS X) использовался другой протокол — AppleTalk. Для окружений, где есть машины, использующие этот протокол, Netatalk также предоставляет протокол AppleTalk (на самом деле, всё началось с реализации именно этого протокола). Он обеспечивает функционирование как файлового сервера и очередей печати, так и сервера времени (для синхронизации часов). Функции маршрутизации этой программы обеспечивают взаимодействие с сетями Appletalk.</para>
    </section>
    <section>
      <title>Интеграция с другими системами Linux/Unix</title>

      <para>Наконец, NFS и NIS (обе включены в дистрибутив) гарантируют взаимодействие с системами Unix. NFS реализует функции файлового сервера, а NIS управляет каталогами пользователей. Система печати BSD, которая используется в большинстве Unix-систем, обеспечивает совместное использование очередей печати.</para>

      <figure>
        <title>Совместное существование систем Debian, OS X, Windows и Unix</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/existing-setup-1.png" width="25%" />
          </imageobject>
        </mediaobject>
      </figure>
    </section>
  </section>
  <section id="sect.how-to-migrate">
    <title>Как мигрировать</title>
    <indexterm><primary>миграция</primary></indexterm>

    <para>Чтобы гарантировать бесперебойную работу служб, необходимо спланировать миграцию каждого компьютера и следовать этому плану. Этот принцип применяется вне зависимости от используемой операционной системы.</para>
    <section>
      <title>Обследование и определение служб</title>

      <para>Данный этап очень важен вне зависимости от того, насколько простым он кажется. Ответственный администратор хорошо осознаёт роль каждого сервера, но эти роли могут изменяться, а опытные пользователи могут самостоятельно установить некоторые службы. Информация о таких службах позволит вам принять взвешенное решение о их необходимости, и вы не удалите такие службы случайно.</para>

      <para>Поэтому вам стоит проинформировать пользователей о предстоящем проекте до переноса сервера. Вы можете установить наиболее распространённые свободные программы на рабочие места пользователей до начала процесса миграции и тем самым привлечь самих пользователей к проекту; лучшими примерами здесь будут Libre Office и пакет программ Mozilla.</para>
      <section>
        <title>Сеть и процессы</title>
        <indexterm><primary><command>nmap</command></primary></indexterm>
       
	<para>Инструмент <command>nmap</command> (из одноимённого пакета) позволит быстро определить службы Интернет, которые размещены на подключенной к сети машине, при этом даже не потребуется входить на эту машину под своей учётной записью. Просто наберите следующую команду на любой другой машине, подключенной к той же сети:</para>

        <screen>
<computeroutput>$ </computeroutput><userinput>nmap mirwiz</userinput>
<computeroutput>Starting Nmap 6.47 ( http://nmap.org ) at 2015-03-24 11:34 CET
Nmap scan report for mirwiz (192.168.1.104)
Host is up (0.0037s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE
22/tcp open  ssh

Nmap done: 1 IP address (1 host up) scanned in 0.13 seconds</computeroutput></screen>

        <sidebar>
          <title><emphasis>АЛЬТЕРНАТИВА</emphasis> Использование <command>netstat</command> для составления списка доступных служб</title>

	  <para>Запустите <command>netstat -tupan</command> на компьютере с системой Linux, и эта команда выведет список активных или ожидающих TCP соединений, а также портов UDP, которые прослушивают запущенные программы. Данная команда упростит определение доступных в сети служб.</para>
        </sidebar>

        <sidebar>
          <title><emphasis>УГЛУБЛЯЕМСЯ</emphasis> IPv6</title>

	  <para>Некоторые сетевые команды могут работать либо с протоколом IPv4 (поведение по умолчанию), либо с IPv6. К таким командам относятся <command>nmap</command> и <command>netstat</command>, а также <command>route</command> и <command>ip</command>. В соответствии с соглашением стоит использовать опцию командной строки <parameter>-6</parameter> для работы с протоколом IPv6.</para>
        </sidebar>

	<para>Если сервер является Unix-машиной, предоставляющей пользователям учётные записи в командной оболочке, то необходимо определить процессы, выполняемые в фоновом режиме во время отсутствия своего владельца. Команда <command>ps auxw</command> отобразит список всех процессов совместно с идентификаторами пользователей. Сравнив полученный список с выводом команды <command>who</command>, которая отображает список всех зарегистрированных пользователей, вы можете установить несанкционированно установленные серверы и программы, работающие в фоновом режиме. Просмотр <filename>crontabs</filename> (список автоматически выполняемых действий, запланированных пользователем) часто помогает выявить интересные детали о выполняемых сервером функциях (полное описание <command>cron</command> находится по ссылке <xref linkend="sect.task-scheduling-cron-atd" />).</para>

	<para>Создание резервной копии вашего сервера — важная процедура в любом случае. Вы можете восстановить информацию из резервной копии после того, как пользователи сообщат об особых проблемах в процессе миграции.</para>
      </section>
    </section>
    <section>
      <title>Создание резервной копии настроек</title>

      <para>Имеет смысл сохранить конфигурацию каждой обнаруженной службы с тем, чтобы восстановить аналогичные настройки на обновлённом сервере. Как минимум стоит сделать резервную копию конфигурационных файлов.</para>

      <para>На компьютерах с системой Unix конфигурационные файлы обычно находятся в каталоге <filename>/etc/</filename>, но они также могут быть в подкаталоге <filename>/usr/local/</filename>. Такое бывает при установке программы из исходных кодов, а не из пакета. В отдельных случаях они могут быть в каталоге <filename>/opt/</filename>.</para>

      <para>В случае служб управления данными (такие как базы данных) мы настоятельно рекомендуем экспортировать данные в какой-либо стандартный формат, который можно будет легко импортировать в новом программном обеспечении. Обычно такие форматы имеют текстовый вид и хорошо документированы; например, это может быть SQL дамп для базы данных или файл LDIF в случае LDAP сервера.</para>

      <figure>
        <title>Резервные копии баз данных</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/existing-setup-2.png" width="50%" />
          </imageobject>
        </mediaobject>
      </figure>

      <para>Каждый сервер имеет свой собственный набор программного обеспечения, и детально описать все существующие варианты практически невозможно. Внимательно прочтите документацию на существующее и новое программное обеспечение с целью установления экспортируемых (а следовательно и импортируемых) форматов, а также тех форматов, которые потребуют переноса данных в ручном режиме. После прочтения этой книги у вас будет больше ясности по вопросам настройки основных программ, используемых на серверах под управлением Linux.</para>
    </section>
    <section>
      <title>Анализ существующего сервера под управлением Debian</title>
      <indexterm><primary>восстановление системы Debian</primary></indexterm>
      <indexterm><primary>исследование системы Debian</primary></indexterm>
      <indexterm><primary>начало работы с сервером Debian</primary></indexterm>

      <para>Для эффективного начала работы с принятой в обслуживание системой Debian вы можете проанализировать уже настроенную и работающую систему Debian.</para>

      <para>Первый файл, на который следует обратить внимание, — <filename>/etc/debian_version</filename>, в котором обычно содержится номер версии установленной системы Debian (файл является частью пакета <emphasis>base-files</emphasis>). Если в этом файле содержится строка <literal><replaceable>кодовое_имя</replaceable>/sid</literal>, то в системе установлены пакеты из одного из находящихся в разработке дистрибутивов (либо тестируемый, либо нестабильный).</para>

      <para>Программа <command>apt-show-versions</command> (из одноимённого пакета Debian) проверит список установленных пакетов и определит доступные версии этих пакетов. С этой же целью можно использовать <command>aptitude</command>, хоть и менее систематичным образом.</para>

      <para>Взглянув на файл <filename>/etc/apt/sources.list</filename> (и на каталог <filename>/etc/apt/sources.list.d/</filename>), вы сможете определить вероятный источник установленных пакетов Debian. Если этот файл содержит множество неизвестных источников, то администратор может предпочесть полностью переустановить систему для обеспечения оптимальной совместимости с тем программным обеспечением, которое предоставляется проектом Debian.</para>

      <para>Файл <filename>sources.list</filename> часто служит хорошим индикатором: большинство администраторов содержат полный список всех использованных ранее источников APT, хотя бы и в закомментированном виде. Не стоит забывать, что использованные ранее источники могли быть удалены, а некоторые пакеты могли быть загружены из сети Интернет и установлены вручную (командой <command>dpkg</command>). В этом случае система может быть ошибочно принята за «стандартную» систему Debian. Именно по этой причине вам следует обратить внимание на любые признаки, которые помогут вам определить присутствие внешних пакетов (наличие файлов <filename>deb</filename> в необычных для них каталогах; номера версий пакетов со специальными суффиксами, которые могут указывать на происхождения пакетов не из проекта Debian, а из таких проектов как <literal>ubuntu</literal> или <literal>lmde</literal>, и т. д.)</para>

      <para>По этой же причине полезно проанализировать содержимое каталога <filename>/usr/local/</filename>, который предназначен для собранных и установленных вручную программ. Список установленного таким образом программного обеспечения может быть поучительным в том плане, что вам предстоит установить причины, по которым не были использованы соответствующие пакеты Debian, если они существуют.</para>

      <sidebar>
        <title><emphasis>КРАТКИЙ ЭКСКУРС</emphasis> <emphasis role="pkg">cruft</emphasis></title>

	<para>Пакет <emphasis role="pkg">cruft</emphasis> поможет составить список тех файлов, что не входят в состав ни одного пакета. В нём присутствуют несколько фильтров (более или менее эффективных и обновляемых), которые помогут исключить некоторые доверенные файлы (те что созданы пакетами Debian или некоторые конфигурационные файлы, которые не находятся под контролем <command>dpkg</command> и т. д.).</para>

	<para>Будьте внимательны и не удалите всё то, что <command>cruft</command> может занести в свой список!</para>
      </sidebar>
    </section>
    <section>
      <title>Установка Debian</title>

      <para>Как только вы собрали всю необходимую информацию о текущем сервере, можно его вывести из работы и начать установку Debian.</para>
      <indexterm><primary>архитектура</primary></indexterm>

      <para>Нам потребуется установить архитектуру компьютера для выбора соответствующей версии дистрибутива. В случае достаточно нового компьютера архитектура будет amd64 (для более старых компьютеров — i386). Во всех остальных случаях выбор сведётся к той архитектуре, что использовалась на предыдущей системе.</para>

      <para><xref linkend="tab-corresp" xrefstyle="select: label nopage" /> не является исчерпывающей, но может быть полезной. В любом случае, оригинальная документация на компьютер является наиболее надёжным источником информации подобного рода.</para>

      <table colsep="1" id="tab-corresp">
        <title>Выбор операционной системы для вашей архитектуры</title>
        <tgroup cols="2">
          <thead>
            <row>
              <entry>Операционная система</entry>
              <entry>Архитектура(ы)</entry>
            </row>
          </thead>
          <tbody>
            <row>
              <entry>DEC Unix (OSF/1)</entry>
              <entry>alpha, mipsel</entry>
            </row>
            <row>
              <entry>HP Unix</entry>
              <entry>ia64, hppa</entry>
            </row>
            <row>
              <entry>IBM AIX</entry>
              <entry>powerpc</entry>
            </row>
            <row>
              <entry>Irix</entry>
              <entry>mips</entry>
            </row>
            <row>
              <entry>OS X</entry>
              <entry>amd64, powerpc, i386</entry>
            </row>
            <row>
              <entry>z/OS, MVS</entry>
              <entry>s390x, s390</entry>
            </row>
            <row>
              <entry>Solaris, SunOS</entry>
              <entry>sparc, i386, m68k</entry>
            </row>
            <row>
              <entry>Ultrix</entry>
              <entry>mips</entry>
            </row>
            <row>
              <entry>VMS</entry>
              <entry>alpha</entry>
            </row>
            <row>
              <entry>Windows 95/98/ME</entry>
              <entry>i386</entry>
            </row>
            <row>
              <entry>Windows NT/2000</entry>
              <entry>i386, alpha, ia64, mipsel</entry>
            </row>
            <row>
              <entry>Windows XP / Windows Server 2008</entry>
              <entry>i386, amd64, ia64</entry>
            </row>
            <row>
              <entry>Windows Vista / Windows 7 / Windows 8</entry>
              <entry>i386, amd64</entry>
            </row>
          </tbody>
        </tgroup>
      </table>

      <sidebar>
        <title><emphasis>АППАРАТНОЕ ОБЕСПЕЧЕНИЕ</emphasis> 64 бита или 32 бита</title>
        <indexterm><primary>amd64</primary></indexterm>
        <indexterm><primary>i386</primary></indexterm>

	<para>Современные компьютеры оснащены 64-разрядными процессорами Intel или AMD, совместимыми с предыдущим поколением 32-разрядных процессоров, поэтому на них работают программы, собранные для архитектуры «i386». С другой стороны, все возможности этих новых процессоров используются не полностью в таком режиме совместимости. По этой причине Debian предоставляет архитектуру «amd64», которая работает как с современными процессорами AMD, так и с процессорами Intel «em64t» (включая большую часть линейки Core), которые очень похожи на AMD64.</para>
      </sidebar>
    </section>
    <section>
      <title>Установка и настройка выбранных служб</title>

      <para>Как только Debian будет установлен, нам потребуется поочерёдно установить и настроить все службы, которые закреплены за данным компьютером. Новая конфигурация должна учитывать предыдущую с целью плавного перехода между ними. Для успешного завершения этой части пригодится вся информация, собранная за первые два шага.</para>

      <figure>
        <title>Установка выбранных служб</title>
        <mediaobject>
          <imageobject>
            <imagedata fileref="images/existing-setup-4.png" width="66%" />
          </imageobject>
        </mediaobject>
      </figure>

      <para>Прежде чем с головой погрузиться в это занятие, мы настоятельно рекомендуем вам прочитать оставшуюся часть книги. После прочтения вы будете точно знать, как настраиваются необходимые вам службы.</para>

      <para></para>
    </section>
  </section>
</chapter>
