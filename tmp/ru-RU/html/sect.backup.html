<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">9.10. Резервное копирование</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-9-ru-RU-1.0-1" /><meta
        name="keywords"
        content="Загрузка системы, Сценарии инициализации, SSH, Telnet, Права, Привилегии, Инспектирование, Inetd, Cron, Резервное копирование, Горячее подключение, PCMCIA, APM, ACPI" /><link
        rel="home"
        href="index.html"
        title="Настольная книга администратора Debian" /><link
        rel="up"
        href="unix-services.html"
        title="Глава 9. Сервисы Unix" /><link
        rel="prev"
        href="sect.quotas.html"
        title="9.9. Квоты" /><link
        rel="next"
        href="sect.hotplug.html"
        title="9.11. Горячее подключение: hotplug" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/ru-RU/stable/sect.backup.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>Пред.</strong></a></li><li
          class="home">Настольная книга администратора Debian</li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>След.</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.backup"></a>9.10. Резервное копирование</h2></div></div></div><div
          class="para">
			Создание резервных копий — одна из основных обязанностей любого администратора, но это сложная задача, для которой используются мощные инструменты, которыми подчас непросто овладеть.
		</div><a
          id="id-1.12.13.3"
          class="indexterm"></a><a
          id="id-1.12.13.4"
          class="indexterm"></a><div
          class="para">
			Существует множество программ, таких как <code
            class="command">amanda</code>, <code
            class="command">bacula</code>, <code
            class="command">BackupPC</code>. Это клиент-серверные системы, имеющие много опций, настройка которых довольно сложна. Некоторые из них предоставляют дружественный веб-интерфейс, чтобы компенсировать это. Но в Debian есть десятки других программ для резервного копирования на все возможные случаи, в чём можно легко убедиться с помощью <code
            class="command">apt-cache search backup</code>.
		</div><a
          id="id-1.12.13.6"
          class="indexterm"></a><a
          id="id-1.12.13.7"
          class="indexterm"></a><a
          id="id-1.12.13.8"
          class="indexterm"></a><div
          class="para">
			Вместо того, чтобы описывать некоторые из них, в этом разделе будут приведены рассуждения администраторов Falcot Corp при определении ими стратегии резервного копирования.
		</div><div
          class="para">
			В Falcot Corp резервные копии нужны для двух целей: восстановления ошибочно удалённых файлов и быстрого восстановления любого компьютера (сервера или рабочей станции) после отказа жёсткого диска.
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.11"></a>9.10.1. Резервное копирование с помощью <code
                    class="command">rsync</code></h3></div></div></div><div
            class="para">
				Поскольку резервные копии на магнитной ленте сочли слишком медленными и дорогими, данные будут сохраняться на жёстких дисках на выделенном сервере, на котором использование программного RAID (см. <a
              class="xref"
              href="advanced-administration.html#sect.raid-soft">Раздел 12.1.1, «Программный RAID»</a>) защитит данные от сбоя диска. Резервные копии отдельных настольных компьютеров не делаются, но пользователи извещены, что будет выполняться резервное копирование их учётных записей на файловом сервере их отдела. Команда <code
              class="command">rsync</code> ежедневно используется для резервного копирования этих серверов.
			</div><a
            id="id-1.12.13.11.3"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>К ОСНОВАМ</em></span> Жёсткая ссылка, второе имя файла</strong></p></div></div></div><a
              id="id-1.12.13.11.4.2"
              class="indexterm"></a><a
              id="id-1.12.13.11.4.3"
              class="indexterm"></a><div
              class="para">
				Жёсткую сылку, в противоположность символической ссылке, невозможно отличить от самого файла, на который она ссылается. По сути, создание жёсткой ссылки является как бы присвоением второго имени существующему файлу. Именно поэтому, если удалить жёсткую ссылку, то сам файл, на который ранее она ссылалась, не будет удалён (будет удалено только как бы второе имя файла). До тех пор, пока существует другое имя файла в системе, данные, включённые в него, будут оставаться записанными в файловой системе. Интересно отметить, что в отличие от копии файла, жёсткая ссылка не занимает дополнительного пространства на жёстком диске.
			</div><div
              class="para">
				Жёсткая ссылка создаётся командой <code
                class="command">ln <em
                  class="replaceable">цель</em> <em
                  class="replaceable">ссылка</em></code>. Файл <em
                class="replaceable">ссылка</em> станет новым именем для файла <em
                class="replaceable">target</em>. Жёсткие ссылки можно создавать только в пределах одной файловой системы, в то время как на символьные ссылки это ограничение не распространяется.
			</div></div><div
            class="para">
				Доступное дисковое пространство не позволяет реализовать полное ежедневное резервное копирование. Поэтому команде <code
              class="command">rsync</code> предшествует дублирование содержимого предыдущей резервной копии с помощью жёстких ссылок, что предупреждает использование слишком большого дискового пространства. Процесс <code
              class="command">rsync</code> затем заменяет только те файлы, которые были изменены с момента создания предыдущей копии. С помощью этого механизма огромное число резервных копий можно хранить на небольшом пространстве. Поскольку все резервные копии немедленно становятся доступными (например в разных каталогах на сетевом ресурсе), можно быстро выполнять сравнения между двумя заданными датами.
			</div><a
            id="id-1.12.13.11.6"
            class="indexterm"></a><a
            id="id-1.12.13.11.7"
            class="indexterm"></a><a
            id="id-1.12.13.11.8"
            class="indexterm"></a><div
            class="para">
				Этот механизм резервного копирования легко реализуется с помощью программы <code
              class="command">dirvish</code>. Она использует хранилище резервных копий («bank» — «банк» — в её терминологии), в котором размещает копии наборов файлов резервных копий с временными метками (в документации dirvish эти наборы называются «vaults» — «подвалы»).
			</div><div
            class="para">
				Основные настройки хранятся в файле <code
              class="filename">/etc/dirvish/master.conf</code>. Он определяет местоположение пространства для резервных копий, список управляемых «подвалов» и значения сроков хранения резервных копий по умолчанию. Остальные настройки находятся в файлах <code
              class="filename"><em
                class="replaceable">bank</em>/<em
                class="replaceable">vault</em>/dirvish/default.conf</code> и содержат конфигурацию соответствующего набора файлов.
			</div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-master"></a><p
              class="title"><strong>Пример 9.3. Файл <code
                  class="filename">/etc/dirvish/master.conf</code></strong></p><div
              class="example-contents"><pre
                class="programlisting">bank:
    /backup
exclude:
    lost+found/
    core
    *~
Runall:
    root    22:00
expire-default: +15 days
expire-rule:
#   MIN HR    DOM MON       DOW  STRFTIME_FMT
    *   *     *   *         1    +3 months
    *   *     1-7 *         1    +1 year
    *   *     1-7 1,4,7,10  1
</pre></div></div><div
            class="para">
				В настройке <code
              class="literal">bank</code> указывается каталог, в котором хранятся резервные копии. Настройка <code
              class="literal">exclude</code> позволяет указать файлы (или типы файлов), которые не должны включаться в резервную копию. <code
              class="literal">Runall</code> — это список наборов файлов для резервного копирования с временной меткой для каждого набора, что позволяет установить корректную дату копии, если резервное копирование ну запускается периодически в определённое время. Нужно указать время, непосредственно предшествующее времени запуска (по умолчанию в Debian это 22:04, в соответствии с файлом <code
              class="filename">/etc/cron.d/dirvish</code>). Наконец, настройки <code
              class="literal">expire-default</code> и <code
              class="literal">expire-rule</code> определяют политику хранения резервных копий. В приведённом выше примере резервные копии, созданные в первое воскресенье каждого квартала, хранятся вечно, созданные в первое воскресенье каждого месяца — удаляются через год, а созданные в другие воскресенья — через 3 месяца. Прочие ежедневные резервные копии хранятся 15 дней. Порядок правил имеет значение: Dirvish применяет последнее подходящее правило или <code
              class="literal">expire-default</code>, если ни одно из других правил <code
              class="literal">expire-rule</code> не подходит.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>НА ПРАКТИКЕ</em></span> Запланированное истечение сроков хранения</strong></p></div></div></div><div
              class="para">
				Правила хранения не используются <code
                class="command">dirvish-expire</code> для выполнения её работы. На самом деле эти правила применяются при создании новой резервной копии, чтобы определить дату истечения срока хранения, ассоциированную с этой копией. <code
                class="command">dirvish-expire</code> просто просматривает сохранённые копии и удаляет те, для которых эта дата прошла.
			</div></div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-vault"></a><p
              class="title"><strong>Пример 9.4. Файл <code
                  class="filename">/backup/root/dirvish/default.conf</code></strong></p><div
              class="example-contents"><pre
                class="programlisting">client: rivendell.falcot.com
tree: /
xdev: 1
index: gzip
image-default: %Y%m%d
exclude:
    /var/cache/apt/archives/*.deb
    /var/cache/man/**
    /tmp/**
    /var/tmp/**
    *.bak
</pre></div></div><div
            class="para">
				В вышеприведённом примере определяется набор файлов для резервного копирования: это файлы на машине <span
              class="emphasis"><em>rivendell.falcot.com</em></span> (для копирования локальных данных нужно просто указать имя локальной машины в том виде, как оно отображается командой <code
              class="command">hostname</code>), а именно файлы корневого каталога (<code
              class="literal">tree: /</code>) за исключением тех, которые перечислены в <code
              class="literal">exclude</code>. Резервная копия будет ограничена содержимым одной файловой системы (<code
              class="literal">xdev: 1</code>). В неё не войдут файлы из других точек монтирования. Будет создан индекс сохранённых файлов (<code
              class="literal">index: gzip</code>), и имя образа будет соответствовать текущей дате (<code
              class="literal">image-default: %Y%m%d</code>).
			</div><div
            class="para">
				Существует множество других опций, и все они описаны на странице руководства <span
              class="citerefentry"><span
                class="refentrytitle">dirvish.conf</span>(5)</span>. Когда конфигурационные файлы подготовлены, необходимо инициализировать каждый набор файлов с помощью команды <code
              class="command">dirvish --vault <em
                class="replaceable">vault</em> --init</code>.После этого при ежедневном вызове <code
              class="command">dirvish-runall</code> будет автоматически создаваться новая резервная копия после удаления устаревшей.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>НА ПРАКТИКЕ</em></span> Удалённое резервное копирование через SSH</strong></p></div></div></div><div
              class="para">
				Когда dirvish требуется сохранить данные на удалённой машине, он использует <code
                class="command">ssh</code> для подключения к ней, и запускает <code
                class="command">rsync</code> как сервер. Для этого необходимо, чтобы пользователь root мог автоматически подключиться к ней. Использование ключа аутентификации SSH позволяет сделать именно это (см. <a
                class="xref"
                href="sect.remote-login.html#sect.ssh-key-based-auth">Раздел 9.2.1.1, «Аутентификация по ключу»</a>).
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.12"></a>9.10.2. Восстановление машин без резервных копий</h3></div></div></div><div
            class="para">
				На настольных компьютерах, резервное копирование которых не выполняется, будет легко переустановить программное обеспечение со специальных DVD-ROM, подготовленных с помощью <span
              class="emphasis"><em>Simple-CDD</em></span> (см. <a
              class="xref"
              href="sect.automated-installation.html#sect.simple-cdd">Раздел 12.3.3, «Simple-CDD: решение «всё-в-одном»»</a>). Поскольку при этом происходит установка с нуля, все настройки, которые могли быть сделаны после предыдущей установки, теряются. Это не страшно, поскольку все системы привязаны к центральному каталогу LDAP с учётными записями, и большая часть настольных приложений предварительно настроены благодаря dconf (более подробно об этом см. в <a
              class="xref"
              href="sect.graphical-desktops.html#sect.gnome-desktop">Раздел 13.3.1, «GNOME»</a>).
			</div><div
            class="para">
				Администраторы Falcot Corp осознают ограничения своей политики резервного копирования. Поскольку они не могут защитить сервер резервных копий так же хорошо, как магнитную ленту в несгораемом шкафу, они установили его в отдельной комнате, чтобы стихийное бедствие, такое как пожар в серверной комнате, не уничтожило резервные копии вместе со всем остальным. Кроме того, они делают инкрементальные резервные копии на DVD-ROM раз в неделю — туда включаются только те файлы, которые были изменены со времени предыдущего резервного копирования.
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>УГЛУБЛЯЕМСЯ</em></span> Резервное копирование сервисов SQL и LDAP</strong></p></div></div></div><div
              class="para">
				Многие сервисы (такие как базы данных SQL или LDAP) не могут быть запущены для резервного копирования простым копированием их файлов (кроме случаев, когда их работа была корректно завершена до начала старта резервного копирования, а это является проблемой, поскольку работа данных сервисов подразумевает быть доступными в любое время). В этих случаях необходимо использовать механизм экспорта (“export”) для создания дампа данных, который поможет безопасно начать резервное копирование. Зачастую дамп достаточно большой, но он хорошо сжимается. Для уменьшения использования необходимого пространства в резервном хранилище, вам нужно будет только сохранять комплект текстовых файлов каждую неделю, и дополнительно делать команду <code
                class="command">diff</code> каждый день, которая выглядит примерно так <code
                class="command">diff <em
                  class="replaceable">файл_из_вчера</em> <em
                  class="replaceable">файл_из_сегодня</em></code>. Программа <code
                class="command">xdelta</code> выполняет бесконечно малое приращение (инкрементальных) различий бинарных дампов.
			</div><a
              id="id-1.12.13.12.4.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.4"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.5"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>КУЛЬТУРА</em></span> <span
                        class="emphasis"><em>TAR</em></span>, стандарт резервных копий на плёнке</strong></p></div></div></div><a
              id="id-1.12.13.12.5.2"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.4"
              class="indexterm"></a><div
              class="para">
				Исторически самым простым способом создания резервных копий в Unix было сохранение архива <span
                class="emphasis"><em>TAR</em></span> на плёнке. Команда <code
                class="command">tar</code> даже получила своё название от «Tape ARchive» — «плёночный архив».
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>Пред.</strong>9.9. Квоты</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>Наверх</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>Начало</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>След.</strong>9.11. Горячее подключение: hotplug</a></li></ul></body></html>
