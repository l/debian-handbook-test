<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"><head><meta
        http-equiv="Content-Type"
        content="text/html; charset=UTF-8" /><title
        xmlns:d="http://docbook.org/ns/docbook">9.10. 備份</title><link
        rel="stylesheet"
        type="text/css"
        href="Common_Content/css/default.css" /><link
        rel="stylesheet"
        media="print"
        href="Common_Content/css/print.css"
        type="text/css" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="generator"
        content="publican v4.3.2" /><meta
        xmlns:d="http://docbook.org/ns/docbook"
        name="package"
        content="Debian-debian-handbook-9-zh-TW-1.0-1" /><meta
        name="keywords"
        content="系統啟動, 初始化腳本, SSH, Telnet, 權力, 權限, 監督, Inetd, Cron, 備份, 熱插拔, PCMCIA, APM, ACPI" /><link
        rel="home"
        href="index.html"
        title="Debian管理者手冊" /><link
        rel="up"
        href="unix-services.html"
        title="章 9. Unix 服務" /><link
        rel="prev"
        href="sect.quotas.html"
        title="9.9. 配額" /><link
        rel="next"
        href="sect.hotplug.html"
        title="9.11. 熱插拔：hotplug" /><meta
        xmlns=""
        name="flattr:id"
        content="4pz9jq" /><link
        xmlns=""
        rel="canonical"
        href="https://debian-handbook.info/browse/zh-TW/stable/sect.backup.html" /></head><body><div
        id="banner"><a
          href="http://debian-handbook.info/get/"><span
            class="text">Download the ebook</span></a></div><p
        id="title"><a
          class="left"
          href="http://www.debian.org"><img
            alt="Product Site"
            src="Common_Content/images//image_left.png" /></a><a
          class="right"
          href="index.html"><img
            alt="Documentation Site"
            src="Common_Content/images//image_right.png" /></a></p><ul
        class="docnav top"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>前一頁</strong></a></li><li
          class="home">Debian管理者手冊</li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>下一頁</strong></a></li></ul><div
        class="section"><div
          class="titlepage"><div><div><h2
                class="title"><a
                  xmlns=""
                  id="sect.backup"></a>9.10. 備份</h2></div></div></div><div
          class="para">
			備份是管理員的主要責任之一，它是個複雜的主題，涉及難以掌握的強大工具。
		</div><a
          id="id-1.12.13.3"
          class="indexterm"></a><a
          id="id-1.12.13.4"
          class="indexterm"></a><div
          class="para">
			很多程式係供備份之用，如 <code
            class="command">amanda</code>、<code
            class="command">bacula</code>、<code
            class="command">BackupPC</code>。主從架構程式有很多選項，其組態相當困難。部份有親和力強的網頁介面減輕其負擔。但 Debian 還有十多種備份軟體可用，以 <code
            class="command">apt-cache search backup</code> 命令可搜尋它們。
		</div><a
          id="id-1.12.13.6"
          class="indexterm"></a><a
          id="id-1.12.13.7"
          class="indexterm"></a><a
          id="id-1.12.13.8"
          class="indexterm"></a><div
          class="para">
			與其逐一介紹它們，本章將經由 Falcot 公司管理者的角度，設定備份的策略。
		</div><div
          class="para">
			Falcot 公司的備份有兩個目標：無誤地復原被刪除的檔案，以及快速地復原硬碟毀損的電腦 (伺服器或桌面)。
		</div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.11"></a>9.10.1. 使用 <code
                    class="command">rsync</code> 備份</h3></div></div></div><div
            class="para">
				以磁帶備份太慢且太貴，現在採用備份在專屬伺服器的硬碟策略，以 RAID (見 <a
              class="xref"
              href="advanced-administration.html#sect.raid-soft">節 12.1.1, “軟 RAID”</a>) 軟體保護資料在硬碟毀損時不致遺失。桌面電腦沒有個別備份的策略，使用者應在部份的檔案伺服器備份其資料。<code
              class="command">rsync</code> 命令 (取自同名的套件) 用於逐日備份這些伺服器。
			</div><a
            id="id-1.12.13.11.3"
            class="indexterm"></a><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>回到基礎</em></span> 硬連結，檔案的第二個名稱</strong></p></div></div></div><a
              id="id-1.12.13.11.4.2"
              class="indexterm"></a><a
              id="id-1.12.13.11.4.3"
              class="indexterm"></a><div
              class="para">
				相對於符號連結，硬連結不能自外於被連結檔案。新增的硬連結等於給檔案另個名稱。刪除硬連結等於刪除該檔案的另個名稱。祗要還有另個名稱指定給檔案，則資料仍在檔案系統內。不同於複製，硬連結並未在硬碟裡複製另個空間。
			</div><div
              class="para">
				以 <code
                class="command">ln <em
                  class="replaceable">target</em> <em
                  class="replaceable">link</em></code> 命令新增硬連結。<em
                class="replaceable">link</em> 檔案是 <em
                class="replaceable">target</em> 檔案的新名稱。硬連結祗能應用於同個檔案系統，符號連結則不受此限。
			</div></div><div
            class="para">
				受限於可用的硬碟空間，無法執行完整的逐日備份。所以，<code
              class="command">rsync</code> 命令優先於以硬連結複製內容，避免使用太多的硬碟空間。<code
              class="command">rsync</code> 祗處理上次備份後，再被修改的檔案。以這個機制可使用較小的空間備份。因為所有的備份已經立即可得與可用 (例如，在同個網路的不同資料夾共享)，可快速地比對兩個指定日期。
			</div><a
            id="id-1.12.13.11.6"
            class="indexterm"></a><a
            id="id-1.12.13.11.7"
            class="indexterm"></a><a
            id="id-1.12.13.11.8"
            class="indexterm"></a><div
            class="para">
				這種備份機制可以輕易地經由 <code
              class="command">dirvish</code> 程式執行。使用備份的儲存空間 (“空” 的)，放置含時間戳記的備份檔案 (在 dirvish 文件中，這些檔案被稱為 “vaults”)。
			</div><div
            class="para">
				主要的組態在 <code
              class="filename">/etc/dirvish/master.conf</code> 檔案內。設定備份儲存空間的位置，管理 “vaults” 清單，以及備份到期的預設值。其他的組態位在 <code
              class="filename"><em
                class="replaceable">bank</em>/<em
                class="replaceable">vault</em>/dirvish/default.conf</code> 檔案內，包括對應檔案集的特殊組態。
			</div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-master"></a><p
              class="title"><strong>範例 9.3. <code
                  class="filename">/etc/dirvish/master.conf</code> 檔案</strong></p><div
              class="example-contents"><pre
                class="programlisting">bank:
    /backup
exclude:
    lost+found/
    core
    *~
Runall:
    root    22:00
expire-default: +15 days
expire-rule:
#   MIN HR    DOM MON       DOW  STRFTIME_FMT
    *   *     *   *         1    +3 months
    *   *     1-7 *         1    +1 year
    *   *     1-7 1,4,7,10  1</pre></div></div><div
            class="para">
				<code
              class="literal">bank</code> 設定儲存備份的資料夾。<code
              class="literal">exclude</code> 設定不列入備份的檔案 (或檔案類型)。<code
              class="literal">Runall</code> 是做為備份時間戳記的檔案清單，若未在指定的時間備份時，還可以其指定的時間複製檔案。可以指定在實際執行時間前 (也就是，預設在 10:04 pm，根據 <code
              class="filename">/etc/cron.d/dirvish</code>)。最後，<code
              class="literal">expire-default</code> 和 <code
              class="literal">expire-rule</code> 設定備份失效政策。以上的範例永遠在每季的第一個星期日執行備份，並在一年後的每月第一個星期日刪除它，以及在三個月後的另個星期日刪除它。其他的逐日備份則保留 15 天。執行的順序有關係，Dirvish 使用最後符合的規則，或 <code
              class="literal">expire-default</code> 若無其他的 <code
              class="literal">expire-rule</code> 符合。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>實踐</em></span> 定期失效</strong></p></div></div></div><div
              class="para">
				失效規則未被 <code
                class="command">dirvish-expire</code> 使用。實際上，在新增備份副本時，設定該複本失效的日期。<code
                class="command">dirvish-expire</code> 細讀儲存的複本並刪除也達失效日期的檔案。
			</div></div><div
            class="example"><a
              xmlns=""
              id="example.dirvish-vault"></a><p
              class="title"><strong>範例 9.4. <code
                  class="filename">/backup/root/dirvish/default.conf</code> 檔案</strong></p><div
              class="example-contents"><pre
                class="programlisting">client: rivendell.falcot.com
tree: /
xdev: 1
index: gzip
image-default: %Y%m%d
exclude:
    /var/cache/apt/archives/*.deb
    /var/cache/man/**
    /tmp/**
    /var/tmp/**
    *.bak</pre></div></div><div
            class="para">
				以上的例子指定需備份的檔案：在機器 <span
              class="emphasis"><em>rivendell.falcot.com</em></span> (在地備份時，祗由 <code
              class="command">hostname</code> 命令指定在地機器的名稱) 內的檔案，尤其是在根目錄之下的檔案 (<code
              class="literal">tree: /</code>)，除了列在 <code
              class="literal">exclude</code> 內的檔案。備份將限制在一個檔案系統的內容 (<code
              class="literal">xdev: 1</code>)。將不包括來自掛載點的檔案。將生成一個儲存檔案索引 (<code
              class="literal">index: gzip</code>)，以及根據現在日期生成的映像檔 (<code
              class="literal">image-default: %Y%m%d</code>)。
			</div><div
            class="para">
				還有很多其他的選項，所有的文件都在 <span
              class="citerefentry"><span
                class="refentrytitle">dirvish.conf</span>(5)</span> 手冊頁面。設定這些組態檔案後，可以用 <code
              class="command">dirvish --vault <em
                class="replaceable">vault</em> --init</code> 初始化每個檔案設定。每日調用的 <code
              class="command">dirvish-runall</code> 將在刪除失效檔案後，自動新增備份複本。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>實踐</em></span> 以 SSH 遠端備份</strong></p></div></div></div><div
              class="para">
				把資料儲存在遠端機器時，需用 <code
                class="command">ssh</code> 命令連結它，並啟用 <code
                class="command">rsync</code> 做為伺服器。需以超級使者的權限才能自動連結。以 SSH 認證碼精確連結 (見 <a
                class="xref"
                href="sect.remote-login.html#sect.ssh-key-based-auth">節 9.2.1.1, “金鑰認證”</a>)。
			</div></div></div><div
          class="section"><div
            class="titlepage"><div><div><h3
                  class="title"><a
                    xmlns=""
                    id="id-1.12.13.12"></a>9.10.2. 供備份恢復系統</h3></div></div></div><div
            class="para">
				桌面電腦不需要備份，以 <span
              class="emphasis"><em>Simple-CDD</em></span> (見 <a
              class="xref"
              href="sect.automated-installation.html#sect.simple-cdd">節 12.3.3, “Simple-CDD: The All-In-One Solution”</a>) 燒錄的 DVD-ROM 就能簡單地重新安裝。回到原始的狀態，舊有的設定全部消失。通常連結至中央的 LDAP 資料夾，大部份桌面的設定存在 dconf (見 <a
              class="xref"
              href="sect.graphical-desktops.html#sect.gnome-desktop">節 13.3.1, “GNOME”</a> 的詳細資料)。
			</div><div
            class="para">
				Falcot Corp 的管理者知道該公司備份政策的限制。未以防火牆保護備份伺服器，而是把它放在另個房間，以免在災難來臨時與主伺服器同歸一燼。而且，每週以 DVD-ROM 做增量備份 — 祗備份修改過的檔案。
			</div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>進階</em></span> 備份 SQL 和 LDAP 服務</strong></p></div></div></div><div
              class="para">
				很多服務 (諸如 SQL 或 LDAP 資料庫) 不能以複製檔案的方式備份其系統 (unless they are properly interrupted during creation of the backups, which is frequently problematic, since they are intended to be available at all times)。因此，必須以 “匯出” 機制生成 “倒出資料” 才能安全地備份。量很大，妥善地壓縮。為了減少儲存空間，每週祗儲存完成的文字檔，以及每天的 <code
                class="command">diff</code>，以 <code
                class="command">diff <em
                  class="replaceable">file_from_yesterday</em> <em
                  class="replaceable">file_from_today</em></code> 命令建立。<code
                class="command">xdelta</code> 程式從二進位倒出增量的不同資料。
			</div><a
              id="id-1.12.13.12.4.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.4"
              class="indexterm"></a><a
              id="id-1.12.13.12.4.5"
              class="indexterm"></a></div><div
            class="sidebar"><div
              class="titlepage"><div><div><p
                    class="title"><strong><span
                        class="emphasis"><em>文化</em></span> <span
                        class="emphasis"><em>TAR</em></span>，磁帶備份標準</strong></p></div></div></div><a
              id="id-1.12.13.12.5.2"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.3"
              class="indexterm"></a><a
              id="id-1.12.13.12.5.4"
              class="indexterm"></a><div
              class="para">
				從歷史上看，最簡單的 Unix 備份是儲存在 <span
                class="emphasis"><em>TAR</em></span> 檔案的磁帶。<code
                class="command">tar</code> 命令的意思是 “Tape ARchive”。
			</div></div></div></div><ul
        class="docnav"><li
          class="previous"><a
            accesskey="p"
            href="sect.quotas.html"><strong>前一頁</strong>9.9. 配額</a></li><li
          class="up"><a
            accesskey="u"
            href="#"><strong>上一層</strong></a></li><li
          class="home"><a
            accesskey="h"
            href="index.html"><strong>起始頁</strong></a></li><li
          class="next"><a
            accesskey="n"
            href="sect.hotplug.html"><strong>下一頁</strong>9.11. 熱插拔：hotplug</a></li></ul></body></html>
